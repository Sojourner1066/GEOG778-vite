var nA=Object.defineProperty;var sA=(i,e,t)=>e in i?nA(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var G=(i,e,t)=>sA(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&r(f)}).observe(document,{childList:!0,subtree:!0});function t(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=t(o);fetch(o.href,c)}})();function Id(i,e){if(!i)throw new Error(e||"loader assertion failed.")}const z_=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),dv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);dv&&parseFloat(dv[1]);const Hf=globalThis,ql=globalThis.process||{},oA=globalThis.navigator||{};function cw(i){var r,o;if(typeof window<"u"&&((r=window.process)==null?void 0:r.type)==="renderer"||typeof process<"u"&&((o=process.versions)!=null&&o.electron))return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function Ya(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||cw()}function aA(i){return Ya()?cw()?"Electron":(oA.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const uw="4.1.0";function lA(i){try{const e=window[i],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class cA{constructor(e,t,r="sessionStorage"){this.storage=lA(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function uA(i){let e;return i<10?e=`${i.toFixed(2)}ms`:i<100?e=`${i.toFixed(1)}ms`:i<1e3?e=`${i.toFixed(0)}ms`:e=`${(i/1e3).toFixed(2)}s`,e}function hA(i,e=8){const t=Math.max(e-i.length,0);return`${" ".repeat(t)}${i}`}var Cd;(function(i){i[i.BLACK=30]="BLACK",i[i.RED=31]="RED",i[i.GREEN=32]="GREEN",i[i.YELLOW=33]="YELLOW",i[i.BLUE=34]="BLUE",i[i.MAGENTA=35]="MAGENTA",i[i.CYAN=36]="CYAN",i[i.WHITE=37]="WHITE",i[i.BRIGHT_BLACK=90]="BRIGHT_BLACK",i[i.BRIGHT_RED=91]="BRIGHT_RED",i[i.BRIGHT_GREEN=92]="BRIGHT_GREEN",i[i.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",i[i.BRIGHT_BLUE=94]="BRIGHT_BLUE",i[i.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",i[i.BRIGHT_CYAN=96]="BRIGHT_CYAN",i[i.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Cd||(Cd={}));const fA=10;function pv(i){return typeof i!="string"?i:(i=i.toUpperCase(),Cd[i]||Cd.WHITE)}function dA(i,e,t){return!Ya&&typeof i=="string"&&(e&&(i=`\x1B[${pv(e)}m${i}\x1B[39m`),t&&(i=`\x1B[${pv(t)+fA}m${i}\x1B[49m`)),i}function pA(i,e=["constructor"]){const t=Object.getPrototypeOf(i),r=Object.getOwnPropertyNames(t),o=i;for(const c of r){const f=o[c];typeof f=="function"&&(e.find(a=>c===a)||(o[c]=f.bind(i)))}}function U_(i,e){if(!i)throw new Error("Assertion failed")}function Gl(){var e,t,r;let i;if(Ya()&&Hf.performance)i=(t=(e=Hf==null?void 0:Hf.performance)==null?void 0:e.now)==null?void 0:t.call(e);else if("hrtime"in ql){const o=(r=ql==null?void 0:ql.hrtime)==null?void 0:r.call(ql);i=o[0]*1e3+o[1]/1e6}else i=Date.now();return i}const Yl={debug:Ya()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},gA={enabled:!0,level:0};function Kl(){}const gv={},mv={once:!0};class xh{constructor({id:e}={id:""}){this.VERSION=uw,this._startTs=Gl(),this._deltaTs=Gl(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new cA(`__probe-${this.id}__`,gA),this.timeStamp(`${this.id} started`),pA(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Gl()-this._startTs).toPrecision(10))}getDelta(){return Number((Gl()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Yl.warn,arguments,mv)}error(e){return this._getLogFunction(0,e,Yl.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Yl.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Yl.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Yl.debug||Yl.info,arguments,mv)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||Kl,r&&[r],{tag:_A(t)}):Kl}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Kl)}group(e,t,r={collapsed:!1}){const o=_v({logLevel:e,message:t,opts:r}),{collapsed:c}=r;return o.method=(c?console.groupCollapsed:console.group)||console.info,this._getLogFunction(o)}groupCollapsed(e,t,r={}){return this.group(e,t,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Kl)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=hw(e)}_getLogFunction(e,t,r,o,c){if(this._shouldLog(e)){c=_v({logLevel:e,message:t,args:o,opts:c}),r=r||c.method,U_(r),c.total=this.getTotal(),c.delta=this.getDelta(),this._deltaTs=Gl();const f=c.tag||c.message;if(c.once&&f)if(!gv[f])gv[f]=Gl();else return Kl;return t=mA(this.id,c.message,c),r.bind(console,t,...c.args)}return Kl}}xh.VERSION=uw;function hw(i){if(!i)return 0;let e;switch(typeof i){case"number":e=i;break;case"object":e=i.logLevel||i.priority||0;break;default:return 0}return U_(Number.isFinite(e)&&e>=0),e}function _v(i){const{logLevel:e,message:t}=i;i.logLevel=hw(e);const r=i.args?Array.from(i.args):[];for(;r.length&&r.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&r.unshift(t),i.message=e;break;case"object":Object.assign(i,e);break}typeof i.message=="function"&&(i.message=i.message());const o=typeof i.message;return U_(o==="string"||o==="object"),Object.assign(i,{args:r},i.opts)}function mA(i,e,t){if(typeof e=="string"){const r=t.time?hA(uA(t.total)):"";e=t.time?`${i}: ${r}  ${e}`:`${i}: ${e}`,e=dA(e,t.color,t.background)}return e}function _A(i){for(const e in i)for(const t in i[e])return t||"untitled";return"empty"}const Jg="4.3.2",yA=Jg[0]>="0"&&Jg[0]<="9"?`v${Jg}`:"";function xA(){const i=new xh({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=i,globalThis.loaders.version=yA,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=i,i}const vA=xA();function bA(i,e){return fw(i||{},e)}function fw(i,e,t=0){if(t>3)return e;const r={...i};for(const[o,c]of Object.entries(e))c&&typeof c=="object"&&!Array.isArray(c)?r[o]=fw(r[o]||{},e[o],t+1):r[o]=e[o];return r}const wA="latest";function TA(){var i;return(i=globalThis._loadersgl_)!=null&&i.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version}const SA=TA();function ea(i,e){if(!i)throw new Error(e||"loaders.gl assertion failed.")}const Va=typeof process!="object"||String(process)!=="[object process]"||process.browser,AA=typeof window<"u"&&typeof window.orientation<"u",yv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);yv&&parseFloat(yv[1]);class PA{constructor(e,t){G(this,"name");G(this,"workerThread");G(this,"isRunning",!0);G(this,"result");G(this,"_resolve",()=>{});G(this,"_reject",()=>{});this.name=e,this.workerThread=t,this.result=new Promise((r,o)=>{this._resolve=r,this._reject=o})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){ea(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){ea(this.isRunning),this.isRunning=!1,this._reject(e)}}class Qg{terminate(){}}const em=new Map;function EA(i){ea(i.source&&!i.url||!i.source&&i.url);let e=em.get(i.source||i.url);return e||(i.url&&(e=IA(i.url),em.set(i.url,e)),i.source&&(e=dw(i.source),em.set(i.source,e))),ea(e),e}function IA(i){if(!i.startsWith("http"))return i;const e=CA(i);return dw(e)}function dw(i){const e=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(e)}function CA(i){return`try {
  importScripts('${i}');
} catch (error) {
  console.error(error);
  throw error;
}`}function pw(i,e=!0,t){const r=t||new Set;if(i){if(xv(i))r.add(i);else if(xv(i.buffer))r.add(i.buffer);else if(!ArrayBuffer.isView(i)){if(e&&typeof i=="object")for(const o in i)pw(i[o],e,r)}}return t===void 0?Array.from(r):[]}function xv(i){return i?i instanceof ArrayBuffer||typeof MessagePort<"u"&&i instanceof MessagePort||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas:!1}const tm=()=>{};class jm{constructor(e){G(this,"name");G(this,"source");G(this,"url");G(this,"terminated",!1);G(this,"worker");G(this,"onMessage");G(this,"onError");G(this,"_loadableURL","");const{name:t,source:r,url:o}=e;ea(r||o),this.name=t,this.source=r,this.url=o,this.onMessage=tm,this.onError=c=>console.log(c),this.worker=Va?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&Va||typeof Qg<"u"&&!Va}destroy(){this.onMessage=tm,this.onError=tm,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||pw(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=EA({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Qg(r,{eval:!1})}else if(this.source)e=new Qg(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class MA{constructor(e){G(this,"name","unnamed");G(this,"source");G(this,"url");G(this,"maxConcurrency",1);G(this,"maxMobileConcurrency",1);G(this,"onDebug",()=>{});G(this,"reuseWorkers",!0);G(this,"props",{});G(this,"jobQueue",[]);G(this,"idleQueue",[]);G(this,"count",0);G(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return jm.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(o,c,f)=>o.done(f),r=(o,c)=>o.error(c)){const o=new Promise(c=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:c}),this));return this._startQueuedJob(),await o}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new PA(t.name,e);e.onMessage=o=>t.onMessage(r,o.type,o.payload),e.onError=o=>t.onError(r,o),t.onStart(r);try{await r.result}catch(o){console.error(`Worker exception: ${o}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Va||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new jm({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return AA?this.maxMobileConcurrency:this.maxConcurrency}}const RA={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Ho=class Ho{constructor(e){G(this,"props");G(this,"workerPools",new Map);this.props={...RA},this.setProps(e),this.workerPools=new Map}static isSupported(){return jm.isSupported()}static getWorkerFarm(e={}){return Ho._workerFarm=Ho._workerFarm||new Ho({}),Ho._workerFarm.setProps(e),Ho._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:o}=e;let c=this.workerPools.get(t);return c||(c=new MA({name:t,source:r,url:o}),c.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,c)),c}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};G(Ho,"_workerFarm");let Md=Ho;function kA(i,e={}){const t=e[i.id]||{},r=Va?`${i.id}-worker.js`:`${i.id}-worker-node.js`;let o=t.workerUrl;if(!o&&i.id==="compression"&&(o=e.workerUrl),e._workerType==="test"&&(Va?o=`modules/${i.module}/dist/${r}`:o=`modules/${i.module}/src/workers/${i.id}-worker-node.ts`),!o){let c=i.version;c==="latest"&&(c=wA);const f=c?`@${c}`:"";o=`https://unpkg.com/@loaders.gl/${i.module}${f}/dist/${r}`}return ea(o),o}function DA(i,e=SA){ea(i,"no worker provided");const t=i.version;return!(!e||!t)}function OA(i,e){return!Md.isSupported()||!Va&&!(e!=null&&e._nodeWorkers)?!1:i.worker&&(e==null?void 0:e.worker)}async function FA(i,e,t,r,o){const c=i.id,f=kA(i,t),y=Md.getWorkerFarm(t).getWorkerPool({name:c,url:f});t=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(r||{}));const T=await y.startJob("process-on-worker",LA.bind(null,o));return T.postMessage("process",{input:e,options:t,context:r}),await(await T.result).result}async function LA(i,e,t,r){switch(t){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:o,input:c,options:f}=r;try{const a=await i(c,f);e.postMessage("done",{id:o,result:a})}catch(a){const y=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:o,error:y})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function BA(i,e,t){if(t=t||i.byteLength,i.byteLength<t||e.byteLength<t)return!1;const r=new Uint8Array(i),o=new Uint8Array(e);for(let c=0;c<r.length;++c)if(r[c]!==o[c])return!1;return!0}function NA(...i){return zA(i)}function zA(i){const e=i.map(c=>c instanceof ArrayBuffer?new Uint8Array(c):c),t=e.reduce((c,f)=>c+f.byteLength,0),r=new Uint8Array(t);let o=0;for(const c of e)r.set(c,o),o+=c.byteLength;return r.buffer}async function UA(i){const e=[];for await(const t of i)e.push(t);return NA(...e)}function vv(){let i;if(typeof window<"u"&&window.performance)i=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();i=e[0]*1e3+e[1]/1e6}else i=Date.now();return i}class bv{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=vv(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(vv()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class Ep{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:r}=e;let o=this.stats[t];return o||(e instanceof bv?o=e:o=new bv(t,r),this.stats[t]=o),o}}let VA="";const wv={};function jA(i){for(const e in wv)if(i.startsWith(e)){const t=wv[e];i=i.replace(e,t)}return!i.startsWith("http://")&&!i.startsWith("https://")&&(i=`${VA}${i}`),i}function $A(i){return i&&typeof i=="object"&&i.isBuffer}function gw(i){if($A(i))return i;if(i instanceof ArrayBuffer)return i;if(ArrayBuffer.isView(i))return i.byteOffset===0&&i.byteLength===i.buffer.byteLength?i.buffer:i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);if(typeof i=="string"){const e=i;return new TextEncoder().encode(e).buffer}if(i&&typeof i=="object"&&i._toArrayBuffer)return i._toArrayBuffer();throw new Error("toArrayBuffer")}function mw(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(e+1):""}function WA(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(0,e):""}const HA=i=>typeof i=="boolean",Qu=i=>typeof i=="function",vh=i=>i!==null&&typeof i=="object",Tv=i=>vh(i)&&i.constructor==={}.constructor,ZA=i=>!!i&&typeof i[Symbol.iterator]=="function",XA=i=>i&&typeof i[Symbol.asyncIterator]=="function",Ka=i=>typeof Response<"u"&&i instanceof Response||i&&i.arrayBuffer&&i.text&&i.json,Ja=i=>typeof Blob<"u"&&i instanceof Blob,qA=i=>i&&typeof i=="object"&&i.isBuffer,GA=i=>typeof ReadableStream<"u"&&i instanceof ReadableStream||vh(i)&&Qu(i.tee)&&Qu(i.cancel)&&Qu(i.getReader),YA=i=>vh(i)&&Qu(i.read)&&Qu(i.pipe)&&HA(i.readable),_w=i=>GA(i)||YA(i);class KA extends Error{constructor(t,r){super(t);G(this,"reason");G(this,"url");G(this,"response");this.reason=r.reason,this.url=r.url,this.response=r.response}}const JA=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,QA=/^([-\w.]+\/[-\w.+]+)/;function Sv(i,e){return i.toLowerCase()===e.toLowerCase()}function eP(i){const e=QA.exec(i);return e?e[1]:i}function Av(i){const e=JA.exec(i);return e?e[1]:""}const yw=/\?.*/;function tP(i){const e=i.match(yw);return e&&e[0]}function V_(i){return i.replace(yw,"")}function iP(i){if(i.length<50)return i;const e=i.slice(i.length-15);return`${i.substr(0,32)}...${e}`}function Ip(i){return Ka(i)?i.url:Ja(i)?i.name||"":typeof i=="string"?i:""}function j_(i){if(Ka(i)){const e=i,t=e.headers.get("content-type")||"",r=V_(e.url);return eP(t)||Av(r)}return Ja(i)?i.type||"":typeof i=="string"?Av(i):""}function rP(i){return Ka(i)?i.headers["content-length"]||-1:Ja(i)?i.size:typeof i=="string"?i.length:i instanceof ArrayBuffer||ArrayBuffer.isView(i)?i.byteLength:-1}async function xw(i){if(Ka(i))return i;const e={},t=rP(i);t>=0&&(e["content-length"]=String(t));const r=Ip(i),o=j_(i);o&&(e["content-type"]=o);const c=await oP(i);c&&(e["x-first-bytes"]=c),typeof i=="string"&&(i=new TextEncoder().encode(i));const f=new Response(i,{headers:e});return Object.defineProperty(f,"url",{value:r}),f}async function nP(i){if(!i.ok)throw await sP(i)}async function sP(i){const e=iP(i.url);let t=`Failed to fetch resource (${i.status}) ${i.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const r={reason:i.statusText,url:i.url,response:i};try{const o=i.headers.get("Content-Type");r.reason=!i.bodyUsed&&(o!=null&&o.includes("application/json"))?await i.json():await i.text()}catch{}return new KA(t,r)}async function oP(i){if(typeof i=="string")return`data:,${i.slice(0,5)}`;if(i instanceof Blob){const t=i.slice(0,5);return await new Promise(r=>{const o=new FileReader;o.onload=c=>{var f;return r((f=c==null?void 0:c.target)==null?void 0:f.result)},o.readAsDataURL(t)})}if(i instanceof ArrayBuffer){const t=i.slice(0,5);return`data:base64,${aP(t)}`}return null}function aP(i){let e="";const t=new Uint8Array(i);for(let r=0;r<t.byteLength;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function lP(i){return!cP(i)&&!uP(i)}function cP(i){return i.startsWith("http:")||i.startsWith("https:")}function uP(i){return i.startsWith("data:")}async function Pv(i,e){var t,r;if(typeof i=="string"){const o=jA(i);return lP(o)&&(t=globalThis.loaders)!=null&&t.fetchNode?(r=globalThis.loaders)==null?void 0:r.fetchNode(o,e):await fetch(o,e)}return await xw(i)}const Ev=new xh({id:"loaders.gl"});class hP{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class fP{constructor(){G(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const vw={fetch:null,mimeType:void 0,nothrow:!1,log:new fP,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:z_,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},dP={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function bw(){globalThis.loaders=globalThis.loaders||{};const{loaders:i}=globalThis;return i._state||(i._state={}),i._state}function ww(){const i=bw();return i.globalOptions=i.globalOptions||{...vw},i.globalOptions}function pP(i,e,t,r){return t=t||[],t=Array.isArray(t)?t:[t],gP(i,t),_P(e,i,r)}function gP(i,e){Iv(i,null,vw,dP,e);for(const t of e){const r=i&&i[t.id]||{},o=t.options&&t.options[t.id]||{},c=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Iv(r,t.id,o,c,e)}}function Iv(i,e,t,r,o){const c=e||"Top level",f=e?`${e}.`:"";for(const a in i){const y=!e&&vh(i[a]),T=a==="baseUri"&&!e,A=a==="workerUrl"&&e;if(!(a in t)&&!T&&!A){if(a in r)Ev.warn(`${c} loader option '${f}${a}' no longer supported, use '${r[a]}'`)();else if(!y){const M=mP(a,o);Ev.warn(`${c} loader option '${f}${a}' not recognized. ${M}`)()}}}}function mP(i,e){const t=i.toLowerCase();let r="";for(const o of e)for(const c in o.options){if(i===c)return`Did you mean '${o.id}.${c}'?`;const f=c.toLowerCase();(t.startsWith(f)||f.startsWith(t))&&(r=r||`Did you mean '${o.id}.${c}'?`)}return r}function _P(i,e,t){const o={...i.options||{}};return yP(o,t),o.log===null&&(o.log=new hP),Cv(o,ww()),Cv(o,e),o}function Cv(i,e){for(const t in e)if(t in e){const r=e[t];Tv(r)&&Tv(i[t])?i[t]={...i[t],...e[t]}:i[t]=e[t]}}function yP(i,e){e&&!("baseUri"in i)&&(i.baseUri=e)}function $_(i){return i?(Array.isArray(i)&&(i=i[0]),Array.isArray(i==null?void 0:i.extensions)):!1}function W_(i){Id(i,"null loader"),Id($_(i),"invalid loader");let e;return Array.isArray(i)&&(e=i[1],i=i[0],i={...i,options:{...i.options,...e}}),(i!=null&&i.parseTextSync||i!=null&&i.parseText)&&(i.text=!0),i.text||(i.binary=!0),i}const Tw=()=>{const i=bw();return i.loaderRegistry=i.loaderRegistry||[],i.loaderRegistry};function xP(i){const e=Tw();i=Array.isArray(i)?i:[i];for(const t of i){const r=W_(t);e.find(o=>r===o)||e.unshift(r)}}function vP(){return Tw()}const bP=/\.([^.]+)$/;async function wP(i,e=[],t,r){if(!Sw(i))return null;let o=Mv(i,e,{...t,nothrow:!0},r);if(o)return o;if(Ja(i)&&(i=await i.slice(0,10).arrayBuffer(),o=Mv(i,e,t,r)),!o&&!(t!=null&&t.nothrow))throw new Error(Aw(i));return o}function Mv(i,e=[],t,r){if(!Sw(i))return null;if(e&&!Array.isArray(e))return W_(e);let o=[];e&&(o=o.concat(e)),t!=null&&t.ignoreRegisteredLoaders||o.push(...vP()),SP(o);const c=TP(i,o,t,r);if(!c&&!(t!=null&&t.nothrow))throw new Error(Aw(i));return c}function TP(i,e,t,r){const o=Ip(i),c=j_(i),f=V_(o)||(r==null?void 0:r.url);let a=null,y="";return t!=null&&t.mimeType&&(a=im(e,t==null?void 0:t.mimeType),y=`match forced by supplied MIME type ${t==null?void 0:t.mimeType}`),a=a||AP(e,f),y=y||(a?`matched url ${f}`:""),a=a||im(e,c),y=y||(a?`matched MIME type ${c}`:""),a=a||EP(e,i),y=y||(a?`matched initial data ${Pw(i)}`:""),t!=null&&t.fallbackMimeType&&(a=a||im(e,t==null?void 0:t.fallbackMimeType),y=y||(a?`matched fallback MIME type ${c}`:"")),y&&vA.log(1,`selectLoader selected ${a==null?void 0:a.name}: ${y}.`),a}function Sw(i){return!(i instanceof Response&&i.status===204)}function Aw(i){const e=Ip(i),t=j_(i);let r="No valid loader found (";r+=e?`${mw(e)}, `:"no url provided, ",r+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const o=i?Pw(i):"";return r+=o?` first bytes: "${o}"`:"first bytes: not available",r+=")",r}function SP(i){for(const e of i)W_(e)}function AP(i,e){const t=e&&bP.exec(e),r=t&&t[1];return r?PP(i,r):null}function PP(i,e){e=e.toLowerCase();for(const t of i)for(const r of t.extensions)if(r.toLowerCase()===e)return t;return null}function im(i,e){var t;for(const r of i)if((t=r.mimeTypes)!=null&&t.some(o=>Sv(e,o))||Sv(e,`application/x.${r.id}`))return r;return null}function EP(i,e){if(!e)return null;for(const t of i)if(typeof e=="string"){if(IP(e,t))return t}else if(ArrayBuffer.isView(e)){if(Rv(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Rv(e,0,t))return t;return null}function IP(i,e){return e.testText?e.testText(i):(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>i.startsWith(r))}function Rv(i,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(o=>CP(i,e,t,o))}function CP(i,e,t,r){if(r instanceof ArrayBuffer)return BA(r,i,r.byteLength);switch(typeof r){case"function":return r(i);case"string":const o=$m(i,e,r.length);return r===o;default:return!1}}function Pw(i,e=5){return typeof i=="string"?i.slice(0,e):ArrayBuffer.isView(i)?$m(i.buffer,i.byteOffset,e):i instanceof ArrayBuffer?$m(i,0,e):""}function $m(i,e,t){if(i.byteLength<e+t)return"";const r=new DataView(i);let o="";for(let c=0;c<t;c++)o+=String.fromCharCode(r.getUint8(e+c));return o}const MP=256*1024;function*RP(i,e){const t=(e==null?void 0:e.chunkSize)||MP;let r=0;const o=new TextEncoder;for(;r<i.length;){const c=Math.min(i.length-r,t),f=i.slice(r,r+c);r+=c,yield o.encode(f)}}const kP=256*1024;function*DP(i,e={}){const{chunkSize:t=kP}=e;let r=0;for(;r<i.byteLength;){const o=Math.min(i.byteLength-r,t),c=new ArrayBuffer(o),f=new Uint8Array(i,r,o);new Uint8Array(c).set(f),r+=o,yield c}}const OP=1024*1024;async function*FP(i,e){const t=(e==null?void 0:e.chunkSize)||OP;let r=0;for(;r<i.size;){const o=r+t,c=await i.slice(r,o).arrayBuffer();r=o,yield c}}function kv(i,e){return z_?LP(i,e):BP(i)}async function*LP(i,e){const t=i.getReader();let r;try{for(;;){const o=r||t.read();e!=null&&e._streamReadAhead&&(r=t.read());const{done:c,value:f}=await o;if(c)return;yield gw(f)}}catch{t.releaseLock()}}async function*BP(i,e){for await(const t of i)yield gw(t)}function NP(i,e){if(typeof i=="string")return RP(i,e);if(i instanceof ArrayBuffer)return DP(i,e);if(Ja(i))return FP(i,e);if(_w(i))return kv(i,e);if(Ka(i))return kv(i.body,e);throw new Error("makeIterator")}const Ew="Cannot convert supplied data type";function zP(i,e,t){if(e.text&&typeof i=="string")return i;if(qA(i)&&(i=i.buffer),i instanceof ArrayBuffer){const r=i;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(i)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(i);let r=i.buffer;const o=i.byteLength||i.length;return(i.byteOffset!==0||o!==r.byteLength)&&(r=r.slice(i.byteOffset,i.byteOffset+o)),r}throw new Error(Ew)}async function UP(i,e,t){const r=i instanceof ArrayBuffer||ArrayBuffer.isView(i);if(typeof i=="string"||r)return zP(i,e);if(Ja(i)&&(i=await xw(i)),Ka(i)){const o=i;return await nP(o),e.binary?await o.arrayBuffer():await o.text()}if(_w(i)&&(i=NP(i,t)),ZA(i)||XA(i))return UA(i);throw new Error(Ew)}function Iw(i,e){const t=ww(),r=i||t;return typeof r.fetch=="function"?r.fetch:vh(r.fetch)?o=>Pv(o,r.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:Pv}function VP(i,e,t){if(t)return t;const r={fetch:Iw(e,i),...i};if(r.url){const o=V_(r.url);r.baseUrl=o,r.queryString=tP(r.url),r.filename=mw(o),r.baseUrl=WA(o)}return Array.isArray(r.loaders)||(r.loaders=null),r}function jP(i,e){if(i&&!Array.isArray(i))return i;let t;if(i&&(t=Array.isArray(i)?i:[i]),e&&e.loaders){const r=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...r]:r}return t&&t.length?t:void 0}async function Rd(i,e,t,r){e&&!Array.isArray(e)&&!$_(e)&&(r=void 0,t=e,e=void 0),i=await i,t=t||{};const o=Ip(i),f=jP(e,r),a=await wP(i,f,t);return a?(t=pP(t,a,f,o),r=VP({url:o,_parse:Rd,loaders:f},t,r||null),await $P(a,i,t,r)):null}async function $P(i,e,t,r){if(DA(i),t=bA(i.options,t),Ka(e)){const c=e,{ok:f,redirected:a,status:y,statusText:T,type:A,url:M}=c,F=Object.fromEntries(c.headers.entries());r.response={headers:F,ok:f,redirected:a,status:y,statusText:T,type:A,url:M}}e=await UP(e,i,t);const o=i;if(o.parseTextSync&&typeof e=="string")return o.parseTextSync(e,t,r);if(OA(i,t))return await FA(i,e,t,r,Rd);if(o.parseText&&typeof e=="string")return await o.parseText(e,t,r);if(o.parse)return await o.parse(e,t,r);throw ea(!o.parseSync),new Error(`${i.id} loader - no parser found and worker is disabled`)}async function kd(i,e,t,r){let o,c;!Array.isArray(e)&&!$_(e)?(o=[],c=e):(o=e,c=t);const f=Iw(c);let a=i;return typeof i=="string"&&(a=await f(i)),Ja(i)&&(a=await f(i)),Array.isArray(o)?await Rd(a,o,c):await Rd(a,o,c)}const WP="4.3.2";var lw;const HP=(lw=globalThis.loaders)==null?void 0:lw.parseImageNode,Wm=typeof Image<"u",Hm=typeof ImageBitmap<"u",ZP=!!HP,Zm=z_?!0:ZP;function XP(i){switch(i){case"auto":return Hm||Wm||Zm;case"imagebitmap":return Hm;case"image":return Wm;case"data":return Zm;default:throw new Error(`@loaders.gl/images: image ${i} not supported in this environment`)}}function qP(){if(Hm)return"imagebitmap";if(Wm)return"image";if(Zm)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function GP(i){const e=KP(i);if(!e)throw new Error("Not an image");return e}function YP(i){switch(GP(i)){case"data":return i;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=i.width,e.height=i.height,t.drawImage(i,0,0),t.getImageData(0,0,i.width,i.height);default:throw new Error("getImageData")}}function KP(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&i instanceof Image?"image":i&&typeof i=="object"&&i.data&&i.width&&i.height?"data":null}const JP=/^data:image\/svg\+xml/,QP=/\.svg((\?|#).*)?$/;function H_(i){return i&&(JP.test(i)||QP.test(i))}function eE(i,e){if(H_(e)){let r=new TextDecoder().decode(i);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(c){throw new Error(c.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return Cw(i,e)}function Cw(i,e){if(H_(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(i)])}async function Mw(i,e,t){const r=eE(i,t),o=self.URL||self.webkitURL,c=typeof r!="string"&&o.createObjectURL(r);try{return await tE(c||r,e)}finally{c&&o.revokeObjectURL(c)}}async function tE(i,e){const t=new Image;return t.src=i,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((r,o)=>{try{t.onload=()=>r(t),t.onerror=c=>{const f=c instanceof Error?c.message:"error";o(new Error(f))}}catch(c){o(c)}})}const iE={};let Dv=!0;async function rE(i,e,t){let r;H_(t)?r=await Mw(i,e,t):r=Cw(i,t);const o=e&&e.imagebitmap;return await nE(r,o)}async function nE(i,e=null){if((sE(e)||!Dv)&&(e=null),e)try{return await createImageBitmap(i,e)}catch(t){console.warn(t),Dv=!1}return await createImageBitmap(i)}function sE(i){for(const e in i||iE)return!1;return!0}function oE(i){return!uE(i,"ftyp",4)||(i[8]&96)===0?null:aE(i)}function aE(i){switch(lE(i,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function lE(i,e,t){return String.fromCharCode(...i.slice(e,t))}function cE(i){return[...i].map(e=>e.charCodeAt(0))}function uE(i,e,t=0){const r=cE(e);for(let o=0;o<r.length;++o)if(r[o]!==i[o+t])return!1;return!0}const xs=!1,eh=!0;function Rw(i){const e=bh(i);return fE(e)||gE(e)||dE(e)||pE(e)||hE(e)}function hE(i){const e=new Uint8Array(i instanceof DataView?i.buffer:i),t=oE(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function fE(i){const e=bh(i);return e.byteLength>=24&&e.getUint32(0,xs)===2303741511?{mimeType:"image/png",width:e.getUint32(16,xs),height:e.getUint32(20,xs)}:null}function dE(i){const e=bh(i);return e.byteLength>=10&&e.getUint32(0,xs)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,eh),height:e.getUint16(8,eh)}:null}function pE(i){const e=bh(i);return e.byteLength>=14&&e.getUint16(0,xs)===16973&&e.getUint32(2,eh)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,eh),height:e.getUint32(22,eh)}:null}function gE(i){const e=bh(i);if(!(e.byteLength>=3&&e.getUint16(0,xs)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:o}=mE();let c=2;for(;c+9<e.byteLength;){const f=e.getUint16(c,xs);if(o.has(f))return{mimeType:"image/jpeg",height:e.getUint16(c+5,xs),width:e.getUint16(c+7,xs)};if(!r.has(f))return null;c+=2,c+=e.getUint16(c,xs)}return null}function mE(){const i=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)i.add(t);return{tableMarkers:i,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function bh(i){if(i instanceof DataView)return i;if(ArrayBuffer.isView(i))return new DataView(i.buffer);if(i instanceof ArrayBuffer)return new DataView(i);throw new Error("toDataView")}async function _E(i,e){var o;const{mimeType:t}=Rw(i)||{},r=(o=globalThis.loaders)==null?void 0:o.parseImageNode;return Id(r),await r(i,t)}async function yE(i,e,t){e=e||{};const o=(e.image||{}).type||"auto",{url:c}=t||{},f=xE(o);let a;switch(f){case"imagebitmap":a=await rE(i,e,c);break;case"image":a=await Mw(i,e,c);break;case"data":a=await _E(i);break;default:Id(!1)}return o==="data"&&(a=YP(a)),a}function xE(i){switch(i){case"auto":case"data":return qP();default:return XP(i),i}}const vE=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],bE=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],wE={image:{type:"auto",decode:!0}},TE={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:WP,mimeTypes:bE,extensions:vE,parse:yE,tests:[i=>!!Rw(new DataView(i))],options:wE},ri=new xh({id:"deck"});let Xm={};function SE(i){Xm=i}function Nr(i,e,t,r){ri.level>0&&Xm[i]&&Xm[i].call(null,e,t,r)}function AE(i){const e=i[0],t=i[i.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const PE={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:AE,parseTextSync:JSON.parse};function EE(){const i="9.1.8",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==i)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${i}`);return e||(ri.log(1,`deck.gl ${i}`)(),globalThis.deck={...globalThis.deck,VERSION:i,version:i,log:ri,_registerLoggers:SE},xP([PE,[TE,{imagebitmap:{premultiplyAlpha:"none"}}]])),i}const IE=EE();function Z_(i,e){if(!i)throw new Error(e||"shadertools: assertion failed.")}const rm={number:{type:"number",validate(i,e){return Number.isFinite(i)&&typeof e=="object"&&(e.max===void 0||i<=e.max)&&(e.min===void 0||i>=e.min)}},array:{type:"array",validate(i,e){return Array.isArray(i)||ArrayBuffer.isView(i)}}};function CE(i){const e={};for(const[t,r]of Object.entries(i))e[t]=ME(r);return e}function ME(i){let e=Ov(i);if(e!=="object")return{value:i,...rm[e],type:e};if(typeof i=="object")return i?i.type!==void 0?{...i,...rm[i.type],type:i.type}:i.value===void 0?{type:"object",value:i}:(e=Ov(i.value),{...i,...rm[e],type:e}):{type:"object",value:null};throw new Error("props")}function Ov(i){return Array.isArray(i)||ArrayBuffer.isView(i)?"array":typeof i}const RE=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,kE=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,DE={vertex:RE,fragment:kE},Fv=/void\s+main\s*\([^)]*\)\s*\{\n?/,Lv=/}\n?[^{}]*$/,nm=[],dd="__LUMA_INJECT_DECLARATIONS__";function OE(i){const e={vertex:{},fragment:{}};for(const t in i){let r=i[t];const o=FE(t);typeof r=="string"&&(r={order:0,injection:r}),e[o][t]=r}return e}function FE(i){const e=i.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Dd(i,e,t,r=!1){const o=e==="vertex";for(const c in t){const f=t[c];f.sort((y,T)=>y.order-T.order),nm.length=f.length;for(let y=0,T=f.length;y<T;++y)nm[y]=f[y].injection;const a=`${nm.join(`
`)}
`;switch(c){case"vs:#decl":o&&(i=i.replace(dd,a));break;case"vs:#main-start":o&&(i=i.replace(Fv,y=>y+a));break;case"vs:#main-end":o&&(i=i.replace(Lv,y=>a+y));break;case"fs:#decl":o||(i=i.replace(dd,a));break;case"fs:#main-start":o||(i=i.replace(Fv,y=>y+a));break;case"fs:#main-end":o||(i=i.replace(Lv,y=>a+y));break;default:i=i.replace(c,y=>y+a)}}return i=i.replace(dd,""),r&&(i=i.replace(/\}\s*$/,c=>c+DE[e])),i}function Od(i){i.map(e=>LE(e))}function LE(i){if(i.instance)return;Od(i.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:r={}}=i,o={normalizedInjections:OE(r),parsedDeprecations:BE(t)};e&&(o.propValidators=CE(e)),i.instance=o;let c={};e&&(c=Object.entries(e).reduce((f,[a,y])=>{const T=y==null?void 0:y.value;return T&&(f[a]=T),f},{})),i.defaultUniforms={...i.defaultUniforms,...c}}function kw(i,e,t){var r;(r=i.deprecations)==null||r.forEach(o=>{var c;(c=o.regex)!=null&&c.test(e)&&(o.deprecated?t.deprecated(o.old,o.new)():t.removed(o.old,o.new)())})}function BE(i){return i.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),i}function X_(i){Od(i);const e={},t={};Dw({modules:i,level:0,moduleMap:e,moduleDepth:t});const r=Object.keys(t).sort((o,c)=>t[c]-t[o]).map(o=>e[o]);return Od(r),r}function Dw(i){const{modules:e,level:t,moduleMap:r,moduleDepth:o}=i;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const c of e)r[c.name]=c,(o[c.name]===void 0||o[c.name]<t)&&(o[c.name]=t);for(const c of e)c.dependencies&&Dw({modules:c.dependencies,level:t+1,moduleMap:r,moduleDepth:o})}function NE(i){switch(i==null?void 0:i.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function zE(i,e){var r;if(Number(((r=i.match(/^#version[ \t]+(\d+)/m))==null?void 0:r[1])||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return i=Bv(i,UE),i;case"fragment":return i=Bv(i,VE),i;default:throw new Error(e)}}const Ow=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],UE=[...Ow,[qm("attribute"),"in $1"],[qm("varying"),"out $1"]],VE=[...Ow,[qm("varying"),"in $1"]];function Bv(i,e){for(const[t,r]of e)i=i.replace(t,r);return i}function qm(i){return new RegExp(`\\b${i}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function Fw(i,e){let t="";for(const r in i){const o=i[r];if(t+=`void ${o.signature} {
`,o.header&&(t+=`  ${o.header}`),e[r]){const c=e[r];c.sort((f,a)=>f.order-a.order);for(const f of c)t+=`  ${f.injection}
`}o.footer&&(t+=`  ${o.footer}`),t+=`}
`}return t}function Lw(i){const e={vertex:{},fragment:{}};for(const t of i){let r,o;typeof t!="string"?(r=t,o=r.hook):(r={},o=t),o=o.trim();const[c,f]=o.split(":"),a=o.replace(/\(.+/,""),y=Object.assign(r,{signature:f});switch(c){case"vs":e.vertex[a]=y;break;case"fs":e.fragment[a]=y;break;default:throw new Error(c)}}return e}function jE(i,e){return{name:$E(i,e),language:"glsl",version:WE(i)}}function $E(i,e="unnamed"){const r=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(i);return r?r[1]:e}function WE(i){let e=100;const t=i.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const r=parseInt(t[1],10);Number.isFinite(r)&&(e=r)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const Bw=`

${dd}
`,HE=`precision highp float;
`;function ZE(i){const e=X_(i.modules||[]);return{source:qE(i.platformInfo,{...i,source:i.source,stage:"vertex",modules:e}),getUniforms:Nw(e)}}function XE(i){const{vs:e,fs:t}=i,r=X_(i.modules||[]);return{vs:Nv(i.platformInfo,{...i,source:e,stage:"vertex",modules:r}),fs:Nv(i.platformInfo,{...i,source:t,stage:"fragment",modules:r}),getUniforms:Nw(r)}}function qE(i,e){var ae;const{source:t,stage:r,modules:o,hookFunctions:c=[],inject:f={},log:a}=e;Z_(typeof t=="string","shader source must be a string");const y=t;let T="";const A=Lw(c),M={},F={},L={};for(const pe in f){const Ee=typeof f[pe]=="string"?{injection:f[pe],order:0}:f[pe],Be=/^(v|f)s:(#)?([\w-]+)$/.exec(pe);if(Be){const xe=Be[2],Ce=Be[3];xe?Ce==="decl"?F[pe]=[Ee]:L[pe]=[Ee]:M[pe]=[Ee]}else L[pe]=[Ee]}const Y=o;for(const pe of Y){a&&kw(pe,y,a);const Ee=zw(pe,"wgsl");T+=Ee;const Be=((ae=pe.injections)==null?void 0:ae[r])||{};for(const xe in Be){const Ce=/^(v|f)s:#([\w-]+)$/.exec(xe);if(Ce){const Xe=Ce[2]==="decl"?F:L;Xe[xe]=Xe[xe]||[],Xe[xe].push(Be[xe])}else M[xe]=M[xe]||[],M[xe].push(Be[xe])}}return T+=Bw,T=Dd(T,r,F),T+=Fw(A[r],M),T+=y,T=Dd(T,r,L),T}function Nv(i,e){var gt;const{id:t,source:r,stage:o,language:c="glsl",modules:f,defines:a={},hookFunctions:y=[],inject:T={},prologue:A=!0,log:M}=e;Z_(typeof r=="string","shader source must be a string");const F=c==="glsl"?jE(r).version:-1,L=i.shaderLanguageVersion,Y=F===100?"#version 100":"#version 300 es",pe=r.split(`
`).slice(1).join(`
`),Ee={};f.forEach(ft=>{Object.assign(Ee,ft.defines)}),Object.assign(Ee,a);let Be="";switch(c){case"wgsl":break;case"glsl":Be=A?`${Y}

// ----- PROLOGUE -------------------------
${GE({id:t,source:r,stage:o})}
${`#define SHADER_TYPE_${o.toUpperCase()}`}

${NE(i)}
${o==="fragment"?HE:""}

// ----- APPLICATION DEFINES -------------------------

${YE(Ee)}

`:`${Y}
`;break}const xe=Lw(y),Ce={},tt={},Xe={};for(const ft in T){const yt=typeof T[ft]=="string"?{injection:T[ft],order:0}:T[ft],Bt=/^(v|f)s:(#)?([\w-]+)$/.exec(ft);if(Bt){const Pt=Bt[2],Lt=Bt[3];Pt?Lt==="decl"?tt[ft]=[yt]:Xe[ft]=[yt]:Ce[ft]=[yt]}else Xe[ft]=[yt]}for(const ft of f){M&&kw(ft,pe,M);const yt=zw(ft,o);Be+=yt;const Bt=((gt=ft.instance)==null?void 0:gt.normalizedInjections[o])||{};for(const Pt in Bt){const Lt=/^(v|f)s:#([\w-]+)$/.exec(Pt);if(Lt){const kt=Lt[2]==="decl"?tt:Xe;kt[Pt]=kt[Pt]||[],kt[Pt].push(Bt[Pt])}else Ce[Pt]=Ce[Pt]||[],Ce[Pt].push(Bt[Pt])}}return Be+="// ----- MAIN SHADER SOURCE -------------------------",Be+=Bw,Be=Dd(Be,o,tt),Be+=Fw(xe[o],Ce),Be+=pe,Be=Dd(Be,o,Xe),c==="glsl"&&F!==L&&(Be=zE(Be,o)),Be.trim()}function Nw(i){return function(t){var o;const r={};for(const c of i){const f=(o=c.getUniforms)==null?void 0:o.call(c,t,r);Object.assign(r,f)}return r}}function GE(i){const{id:e,source:t,stage:r}=i;return e&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${r}`:""}function YE(i={}){let e="";for(const t in i){const r=i[t];(r||Number.isFinite(r))&&(e+=`#define ${t.toUpperCase()} ${i[t]}
`)}return e}function zw(i,e){let t;switch(e){case"vertex":t=i.vs||"";break;case"fragment":t=i.fs||"";break;case"wgsl":t=i.source||"";break;default:Z_(!1)}if(!i.name)throw new Error("Shader module must have a name");const r=i.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let o=`// ----- MODULE ${i.name} ---------------

`;return e!=="wgsl"&&(o+=`#define MODULE_${r}
`),o+=`${t}
`,o}const KE=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,JE=/^\s*\#\s*endif\s*$/;function QE(i,e){var f;const t=i.split(`
`),r=[];let o=!0,c=null;for(const a of t){const y=a.match(KE),T=a.match(JE);y?(c=y[1],o=!!((f=e==null?void 0:e.defines)!=null&&f[c])):T?o=!0:o&&r.push(a)}return r.join(`
`)}const Na=class Na{constructor(){G(this,"_hookFunctions",[]);G(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return Na.defaultShaderAssembler=Na.defaultShaderAssembler||new Na,Na.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(r=>r.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),r=this._hookFunctions,{source:o,getUniforms:c}=ZE({...e,source:e.source,modules:t,hookFunctions:r});return{source:e.platformInfo.shaderLanguage==="wgsl"?QE(o):o,getUniforms:c,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),r=this._hookFunctions;return{...XE({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:r}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),r={};let o=0;for(let c=0,f=this._defaultModules.length;c<f;++c){const a=this._defaultModules[c],y=a.name;t[o++]=a,r[y]=!0}for(let c=0,f=e.length;c<f;++c){const a=e[c],y=a.name;r[y]||(t[o++]=a,r[y]=!0)}return t.length=o,Od(t),t}};G(Na,"defaultShaderAssembler");let Fd=Na;const e3=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,t3=`#version 300 es
${e3}`;function i3(i){const{input:e,inputChannels:t,output:r}={};if(!e)return t3;if(!t)throw new Error("inputChannels");const o=r3(t),c=n3(e,t);return`#version 300 es
in ${o} ${e};
out vec4 ${r};
void main() {
  ${r} = ${c};
}`}function r3(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${i}`)}}function n3(i,e){switch(e){case 1:return`vec4(${i}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${i}, 0.0, 1.0)`;case 3:return`vec4(${i}, 1.0)`;case 4:return i;default:throw new Error(`invalid channels: ${e}`)}}class s3{constructor(){G(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new Ep({id:e})),this.stats.get(e)}}const Uw=new s3,ut=new xh({id:"luma.gl"}),sm={};function Cp(i="id"){sm[i]=sm[i]||1;const e=sm[i]++;return`${i}-${e}`}var Vm;let wi=(Vm=class{constructor(e,t,r){G(this,"id");G(this,"props");G(this,"userData",{});G(this,"_device");G(this,"destroyed",!1);G(this,"allocatedBytes",0);G(this,"_attachedResources",new Set);if(!e)throw new Error("no device");this._device=e,this.props=o3(t,r);const o=this.props.id!=="undefined"?this.props.id:Cp(this[Symbol.toStringTag]);this.props.id=o,this.id=o,this.userData=this.props.userData||{},this.addStats()}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const r=this._device.statsManager.getStats("Resource Counts");r.get("GPU Memory").addCount(e),r.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}},G(Vm,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),Vm);function o3(i,e){const t={...e};for(const r in i)i[r]!==void 0&&(t[r]=i[r]);return t}const Ar=class Ar extends wi{constructor(t,r){const o={...r};(r.usage||0)&Ar.INDEX&&!r.indexType&&(r.data instanceof Uint32Array?o.indexType="uint32":r.data instanceof Uint16Array&&(o.indexType="uint16")),delete o.data;super(t,o,Ar.defaultProps);G(this,"usage");G(this,"indexType");G(this,"updateTimestamp");G(this,"debugData",new ArrayBuffer(0));this.usage=o.usage||0,this.indexType=o.indexType,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}clone(t){return this.device.createBuffer({...this.props,...t})}readSyncWebGL(t,r){throw new Error("not implemented")}_setDebugData(t,r,o){const c=ArrayBuffer.isView(t)?t.buffer:t,f=Math.min(t?t.byteLength:o,Ar.DEBUG_DATA_MAX_LENGTH);c===null?this.debugData=new ArrayBuffer(f):r===0&&o===c.byteLength?this.debugData=c.slice(0,f):this.debugData=c.slice(r,r+f)}};G(Ar,"defaultProps",{...wi.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),G(Ar,"MAP_READ",1),G(Ar,"MAP_WRITE",2),G(Ar,"COPY_SRC",4),G(Ar,"COPY_DST",8),G(Ar,"INDEX",16),G(Ar,"VERTEX",32),G(Ar,"UNIFORM",64),G(Ar,"STORAGE",128),G(Ar,"INDIRECT",256),G(Ar,"QUERY_RESOLVE",512),G(Ar,"DEBUG_DATA_MAX_LENGTH",32);let Fi=Ar;function Vw(i){const e=zv[i],t=a3(e),r=i.includes("norm"),o=!r&&!i.startsWith("float"),c=i.startsWith("s");return{dataType:zv[i],byteLength:t,integer:o,signed:c,normalized:r}}function a3(i){return l3[i]}const zv={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},l3={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},Fr="texture-compression-bc",bi="texture-compression-astc",ms="texture-compression-etc2",c3="texture-compression-etc1-webgl",Zf="texture-compression-pvrtc-webgl",om="texture-compression-atc-webgl",Xf="float32-renderable-webgl",am="float16-renderable-webgl",u3="rgb9e5ufloat-renderable-webgl",lm="snorm8-renderable-webgl",Nu="norm16-renderable-webgl",cm="snorm16-renderable-webgl",qf="float32-filterable",Uv="float16-filterable-webgl";function jw(i){const e=h3[i];if(!e)throw new Error(`Unsupported texture format ${i}`);return e}const h3={r8unorm:{},r8snorm:{render:lm},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:lm},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:am,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:Nu},"r16snorm-webgl":{f:cm},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:lm},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:am,filter:Uv},"rg16unorm-webgl":{render:Nu},"rg16snorm-webgl":{render:cm},r32uint:{},r32sint:{},r32float:{render:Xf,filter:qf},rgb9e5ufloat:{channels:"rgb",packed:!0,render:u3},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Xf},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:Nu},"rgb16snorm-webgl":{f:Nu},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:qf},rgba16uint:{},rgba16sint:{},rgba16float:{render:am,filter:Uv},"rgba16unorm-webgl":{render:Nu},"rgba16snorm-webgl":{render:cm},"rgb32float-webgl":{render:Xf,filter:qf},rgba32uint:{},rgba32sint:{},rgba32float:{render:Xf,filter:qf},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:Fr},"bc1-rgb-unorm-srgb-webgl":{f:Fr},"bc1-rgba-unorm":{f:Fr},"bc1-rgba-unorm-srgb":{f:Fr},"bc2-rgba-unorm":{f:Fr},"bc2-rgba-unorm-srgb":{f:Fr},"bc3-rgba-unorm":{f:Fr},"bc3-rgba-unorm-srgb":{f:Fr},"bc4-r-unorm":{f:Fr},"bc4-r-snorm":{f:Fr},"bc5-rg-unorm":{f:Fr},"bc5-rg-snorm":{f:Fr},"bc6h-rgb-ufloat":{f:Fr},"bc6h-rgb-float":{f:Fr},"bc7-rgba-unorm":{f:Fr},"bc7-rgba-unorm-srgb":{f:Fr},"etc2-rgb8unorm":{f:ms},"etc2-rgb8unorm-srgb":{f:ms},"etc2-rgb8a1unorm":{f:ms},"etc2-rgb8a1unorm-srgb":{f:ms},"etc2-rgba8unorm":{f:ms},"etc2-rgba8unorm-srgb":{f:ms},"eac-r11unorm":{f:ms},"eac-r11snorm":{f:ms},"eac-rg11unorm":{f:ms},"eac-rg11snorm":{f:ms},"astc-4x4-unorm":{f:bi},"astc-4x4-unorm-srgb":{f:bi},"astc-5x4-unorm":{f:bi},"astc-5x4-unorm-srgb":{f:bi},"astc-5x5-unorm":{f:bi},"astc-5x5-unorm-srgb":{f:bi},"astc-6x5-unorm":{f:bi},"astc-6x5-unorm-srgb":{f:bi},"astc-6x6-unorm":{f:bi},"astc-6x6-unorm-srgb":{f:bi},"astc-8x5-unorm":{f:bi},"astc-8x5-unorm-srgb":{f:bi},"astc-8x6-unorm":{f:bi},"astc-8x6-unorm-srgb":{f:bi},"astc-8x8-unorm":{f:bi},"astc-8x8-unorm-srgb":{f:bi},"astc-10x5-unorm":{f:bi},"astc-10x5-unorm-srgb":{f:bi},"astc-10x6-unorm":{f:bi},"astc-10x6-unorm-srgb":{f:bi},"astc-10x8-unorm":{f:bi},"astc-10x8-unorm-srgb":{f:bi},"astc-10x10-unorm":{f:bi},"astc-10x10-unorm-srgb":{f:bi},"astc-12x10-unorm":{f:bi},"astc-12x10-unorm-srgb":{f:bi},"astc-12x12-unorm":{f:bi},"astc-12x12-unorm-srgb":{f:bi},"pvrtc-rgb4unorm-webgl":{f:Zf},"pvrtc-rgba4unorm-webgl":{f:Zf},"pvrtc-rbg2unorm-webgl":{f:Zf},"pvrtc-rgba2unorm-webgl":{f:Zf},"etc1-rbg-unorm-webgl":{f:c3},"atc-rgb-unorm-webgl":{f:om},"atc-rgba-unorm-webgl":{f:om},"atc-rgbai-unorm-webgl":{f:om}},f3=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],d3=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function $w(i){return f3.some(e=>i.startsWith(e))}function q_(i){let e=p3(i);if($w(i)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const r=g3(i);r&&(e.blockWidth=r.blockWidth,e.blockHeight=r.blockHeight)}const t=d3.exec(i);if(t){const[,r,o,c,f,a]=t,y=`${c}${o}`,T=Vw(y),A=T.byteLength*8,M=r.length,F=[A,M>=2?A:0,M>=3?A:0,M>=4?A:0];e={format:i,attachment:e.attachment,dataType:T.dataType,components:M,channels:r,integer:T.integer,signed:T.signed,normalized:T.normalized,bitsPerChannel:F,bytesPerPixel:T.byteLength*r.length,packed:e.packed,srgb:e.srgb},a==="-webgl"&&(e.webgl=!0),f==="-srgb"&&(e.srgb=!0)}return i.endsWith("-webgl")&&(e.webgl=!0),i.endsWith("-srgb")&&(e.srgb=!0),e}function p3(i){var c;const e=jw(i),t=e.bytesPerPixel||1,r=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:i,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||((c=e.channels)==null?void 0:c.length)||1,bytesPerPixel:t,bitsPerChannel:r,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function g3(i){const t=/.*-(\d+)x(\d+)-.*/.exec(i);if(t){const[,r,o]=t;return{blockWidth:Number(r),blockHeight:Number(o)}}return null}function m3(i){const e=jw(i),t={format:i,create:e.f??!0,render:e.render??!0,filter:e.filter??!0,blend:e.blend??!0,store:e.store??!0},r=q_(i),o=i.startsWith("depth")||i.startsWith("stencil"),c=r==null?void 0:r.signed,f=r==null?void 0:r.integer,a=r==null?void 0:r.webgl;return t.render&&(t.render=!c),t.filter&&(t.filter=!o&&!c&&!f&&!a),t}class _3{}class y3{constructor(e=[],t){G(this,"features");G(this,"disabledFeatures");this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){var t;return!((t=this.disabledFeatures)!=null&&t[e])&&this.features.has(e)}}const fp=class fp{constructor(e){G(this,"id");G(this,"props");G(this,"userData",{});G(this,"statsManager",Uw);G(this,"timestamp",0);G(this,"_reused",!1);G(this,"_lumaData",{});this.props={...fp.defaultProps,...e},this.id=this.props.id||Cp(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}getTextureFormatCapabilities(e){const t=m3(e),r=f=>(typeof f=="string"?this.features.has(f):f)??!0,o=r(t.create),c={format:e,create:o,render:o&&r(t.render),filter:o&&r(t.filter),blend:o&&r(t.blend),store:o&&r(t.store)};return this._getDeviceSpecificTextureFormatCapabilities(c)}isTextureFormatSupported(e,t){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return $w(e)}loseDevice(){return!1}reportError(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&Fi.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":ut.warn("indices buffer content must be of integer type")()),t}};G(fp,"defaultProps",{id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>ut.error(e.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:ut.get("debug")||void 0,debugShaders:ut.get("debug-shaders")||void 0,debugFramebuffers:!!ut.get("debug-framebuffers"),debugWebGL:!!ut.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0});let Ko=fp;const x3=Ya()&&typeof document<"u",v3=()=>x3&&document.readyState==="complete",b3="set luma.log.level=1 (or higher) to trace rendering",Vv="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.",Zo=class Zo{constructor(){G(this,"stats",Uw);G(this,"log",ut);G(this,"VERSION","9.1.5");G(this,"spector");G(this,"preregisteredAdapters",new Map);if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw ut.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),ut.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");ut.error("This version of luma.gl has already been initialized")()}ut.log(1,`${this.VERSION} - ${b3}`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map(([,r])=>r).filter(r=>{var o;return(o=r.isSupported)==null?void 0:o.call(r)}).map(r=>r.type)}getBestAvailableAdapter(e=[]){var r,o,c,f;const t=this.getAdapterMap(e);return(o=(r=t.get("webgpu"))==null?void 0:r.isSupported)!=null&&o.call(r)?"webgpu":(f=(c=t.get("webgl"))==null?void 0:c.isSupported)!=null&&f.call(c)?"webgl":null}setDefaultDeviceProps(e){Object.assign(Zo.defaultProps,e)}async createDevice(e={}){var a;e={...Zo.defaultProps,...e},e.waitForPageLoad&&await Zo.pageLoaded;const t=this.getAdapterMap(e.adapters);let r=e.type||"";r==="best-available"&&(r=this.getBestAvailableAdapter(e.adapters)||r);const c=(this.getAdapterMap(e.adapters)||t).get(r),f=await((a=c==null?void 0:c.create)==null?void 0:a.call(c,e));if(f)return f;throw new Error(Vv)}async attachDevice(e){var f;const t=this.getAdapterMap(e.adapters);let r="";e.handle instanceof WebGL2RenderingContext&&(r="webgl"),e.createCanvasContext&&await Zo.pageLoaded,e.handle===null&&(r="unknown");const o=t.get(r),c=await((f=o==null?void 0:o.attach)==null?void 0:f.call(o,null));if(c)return c;throw new Error(Vv)}enforceWebGL2(e=!0,t=[]){var c;const o=this.getAdapterMap(t).get("webgl");o||ut.warn("enforceWebGL2: webgl adapter not found")(),(c=o==null?void 0:o.enforceWebGL2)==null||c.call(o,e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const r of e)t.set(r.type,r);return t}registerDevices(e){ut.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const r=t.adapter;r&&this.preregisteredAdapters.set(r.type,r)}}};G(Zo,"defaultProps",{...Ko.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0}),G(Zo,"pageLoaded",w3().then(()=>{ut.probe(2,"DOM is loaded")()}));let Gm=Zo;const Ym=new Gm;function w3(){return v3()||typeof window>"u"?Promise.resolve():new Promise(i=>{window.addEventListener("load",()=>i())})}class T3{}const dp=class dp{constructor(e){G(this,"id");G(this,"props");G(this,"canvas");G(this,"htmlCanvas");G(this,"offscreenCanvas");G(this,"type");G(this,"width",1);G(this,"height",1);G(this,"resizeObserver");G(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});if(this.props={...dp.defaultProps,...e},e=this.props,!Ya()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=A3(e.canvas):this.canvas=e.canvas;else{const t=P3(e),r=S3((e==null?void 0:e.container)||null);r.insertBefore(t,r.firstChild),this.canvas=t,e!=null&&e.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(t=>{for(const r of t)r.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}toString(){return`${this[Symbol.toStringTag]}(${this.id})`}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){var e;try{const[t]=this.getDrawingBufferSize(),r=this._canvasSizeInfo.clientWidth||((e=this.htmlCanvas)==null?void 0:e.clientWidth);return r?t/r:1}catch{return 1}}cssToDevicePixels(e,t=!0){const r=this.cssToDeviceRatio(),[o,c]=this.getDrawingBufferSize();return E3(e,r,o,c,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let r="width"in t?t.width:this.htmlCanvas.clientWidth,o="height"in t?t.height:this.htmlCanvas.clientHeight;(!r||!o)&&(ut.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,r=this.htmlCanvas.width||1,o=this.htmlCanvas.height||1);const c=this._canvasSizeInfo;if(c.clientWidth!==r||c.clientHeight!==o||c.devicePixelRatio!==e){let f=e;const a=Math.floor(r*f),y=Math.floor(o*f);if(this.htmlCanvas.width=a,this.htmlCanvas.height=y,this.device.gl){const[A,M]=this.getDrawingBufferSize();(A!==a||M!==y)&&(f=Math.min(A/r,M/o),this.htmlCanvas.width=Math.floor(r*f),this.htmlCanvas.height=Math.floor(o*f),ut.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=r,this._canvasSizeInfo.clientHeight=o,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;return e?[e.drawingBufferWidth,e.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(e){var t;((t=this.htmlCanvas)==null?void 0:t.id)==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}};G(dp,"defaultProps",{canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"});let Km=dp;function S3(i){if(typeof i=="string"){const e=document.getElementById(i);if(!e)throw new Error(`${i} is not an HTML element`);return e}else if(i)return i;return document.body}function A3(i){const e=document.getElementById(i);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function P3(i){const{width:e,height:t}=i,r=document.createElement("canvas");return r.id=Cp("lumagl-auto-created-canvas"),r.width=e||1,r.height=t||1,r.style.width=Number.isFinite(e)?`${e}px`:"100%",r.style.height=Number.isFinite(t)?`${t}px`:"100%",r}function E3(i,e,t,r,o){const c=i,f=jv(c[0],e,t);let a=$v(c[1],e,r,o),y=jv(c[0]+1,e,t);const T=y===t-1?y:y-1;y=$v(c[1]+1,e,r,o);let A;return o?(y=y===0?y:y+1,A=a,a=y):A=y===r-1?y:y-1,{x:f,y:a,width:Math.max(T-f+1,1),height:Math.max(A-a+1,1)}}function jv(i,e,t){return Math.min(Math.round(i*e),t-1)}function $v(i,e,t,r){return r?Math.max(0,t-1-Math.round(i*e)):Math.min(Math.round(i*e),t-1)}const Pr=class Pr extends wi{constructor(t,r){r=Pr.normalizeProps(t,r);super(t,r,Pr.defaultProps);G(this,"dimension");G(this,"format");G(this,"width");G(this,"height");G(this,"depth");G(this,"mipLevels");G(this,"updateTimestamp");if(this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const o=Pr.getTextureDataSize(this.props.data);this.width=(o==null?void 0:o.width)||1,this.height=(o==null?void 0:o.height)||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?Pr.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}clone(t){return this.device.createTexture({...this.props,...t})}static isExternalImage(t){return typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof VideoFrame<"u"&&t instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas}static getExternalImageSize(t){if(typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)return{width:t.width,height:t.height};if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement)return{width:t.naturalWidth,height:t.naturalHeight};if(typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement)return{width:t.videoWidth,height:t.videoHeight};if(typeof VideoFrame<"u"&&t instanceof VideoFrame)return{width:t.displayWidth,height:t.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(t){const r=t==null?void 0:t.data;return ArrayBuffer.isView(r)}static getTextureDataSize(t){if(!t||ArrayBuffer.isView(t))return null;if(Array.isArray(t))return Pr.getTextureDataSize(t[0]);if(Pr.isExternalImage(t))return Pr.getExternalImageSize(t);if(t&&typeof t=="object"&&t.constructor===Object){const o=Object.values(t)[0];return{width:o.width,height:o.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(t,r){let o;return ArrayBuffer.isView(t)?o=[{data:t,width:r.width,height:r.height}]:Array.isArray(t)?o=t:o=[t],o}static getMipLevelCount(t,r){return Math.floor(Math.log2(Math.max(t,r)))+1}static getCubeFaceDepth(t){switch(t){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(t)}}static normalizeProps(t,r){var y,T;const o={...r},c=((T=(y=t==null?void 0:t.props)==null?void 0:y._resourceDefaults)==null?void 0:T.texture)||{};Object.assign(o,c);const{width:f,height:a}=o;return typeof f=="number"&&(o.width=Math.max(1,Math.ceil(f))),typeof a=="number"&&(o.height=Math.max(1,Math.ceil(a))),o}};G(Pr,"COPY_SRC",1),G(Pr,"COPY_DST",2),G(Pr,"TEXTURE",4),G(Pr,"STORAGE",8),G(Pr,"RENDER_ATTACHMENT",16),G(Pr,"CubeFaces",["+X","-X","+Y","-Y","+Z","-Z"]),G(Pr,"defaultProps",{...wi.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0}),G(Pr,"defaultCopyExternalImageOptions",{image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1});let Xi=Pr;const pp=class pp extends wi{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,pp.defaultProps)}};G(pp,"defaultProps",{...wi.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let Ld=pp;function I3(i,e,t){let r="";const o=e.split(/\r?\n/),c=i.slice().sort((f,a)=>f.lineNum-a.lineNum);switch((t==null?void 0:t.showSourceCode)||"no"){case"all":let f=0;for(let a=1;a<=o.length;a++)for(r+=Ww(o[a-1],a,t);c.length>f&&c[f].lineNum===a;){const y=c[f++];r+=Wv(y,o,y.lineNum,{...t,inlineSource:!1})}return r;case"issues":case"no":for(const a of i)r+=Wv(a,o,a.lineNum,{inlineSource:(t==null?void 0:t.showSourceCode)!=="no"});return r}}function Wv(i,e,t,r){if(r!=null&&r.inlineSource){const c=C3(e,t),f=i.linePos>0?`${" ".repeat(i.linePos+5)}^^^
`:"";return`
${c}${f}${i.type.toUpperCase()}: ${i.message}

`}const o=i.type==="error"?"red":"#8B4000";return r!=null&&r.html?`<div class='luma-compiler-log-error' style="color:${o};"><b> ${i.type.toUpperCase()}: ${i.message}</b></div>`:`${i.type.toUpperCase()}: ${i.message}`}function C3(i,e,t){let r="";for(let o=e-2;o<=e;o++){const c=i[o-1];c!==void 0&&(r+=Ww(c,e,t))}return r}function Ww(i,e,t){const r=t!=null&&t.html?R3(i):i;return`${M3(String(e),4)}: ${r}${t!=null&&t.html?"<br/>":`
`}`}function M3(i,e){let t="";for(let r=i.length;r<e;++r)t+=" ";return t+i}function R3(i){return i.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const gp=class gp extends wi{constructor(t,r){r={...r,debugShaders:r.debugShaders||t.props.debugShaders||"errors"};super(t,{id:k3(r),...r},gp.defaultProps);G(this,"stage");G(this,"source");G(this,"compilationStatus","pending");this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const t=this.props.debugShaders;switch(t){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const r=await this.getCompilationInfo();t==="warnings"&&(r==null?void 0:r.length)===0||this._displayShaderLog(r)}_displayShaderLog(t){var T;if(typeof document>"u"||!(document!=null&&document.createElement))return;const r=Hw(this.source),o=`${this.stage} ${r}`;let c=I3(t,this.source,{showSourceCode:"all",html:!0});const f=this.getTranslatedSource();f&&(c+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${f}</pre></code>`);const a=document.createElement("Button");a.innerHTML=`
<h1>Shader Compilation Error in ${o}</h1><br /><br />
<code style="user-select:text;"><pre>
${c}
</pre></code>`,a.style.top="10px",a.style.left="10px",a.style.position="absolute",a.style.zIndex="9999",a.style.width="100%",a.style.textAlign="left",document.body.appendChild(a),(T=document.getElementsByClassName("luma-compiler-log-error")[0])==null||T.scrollIntoView(),a.onclick=()=>{const A=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(A)}}};G(gp,"defaultProps",{...wi.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0});let Bd=gp;function k3(i){return Hw(i.source)||i.id||Cp(`unnamed ${i.stage}-shader`)}function Hw(i,e="unnamed"){const r=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(i);return r?r[1]:e}const ah=class ah extends wi{get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=ah.normalizeProps(e,t),super(e,t,ah.defaultProps)}static normalizeProps(e,t){var c,f;const r=((f=(c=e==null?void 0:e.props)==null?void 0:c._resourceDefaults)==null?void 0:f.sampler)||{};return{...t,...r}}};G(ah,"defaultProps",{...wi.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let Nd=ah;const mp=class mp extends wi{constructor(t,r={}){super(t,r,mp.defaultProps);G(this,"width");G(this,"height");this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}clone(t){const r=this.colorAttachments.map(c=>c.texture.clone(t)),o=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(t);return this.device.createFramebuffer({...this.props,colorAttachments:r,depthStencilAttachment:o})}resize(t){let r=!t;if(t){const[o,c]=Array.isArray(t)?t:[t.width,t.height];r=r||c!==this.height||o!==this.width,this.width=o,this.height=c}r&&(ut.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((r,o)=>{if(typeof r=="string"){const c=this.createColorTexture(r,o);return this.attachResource(c),c.view}return r instanceof Xi?r.view:r});const t=this.props.depthStencilAttachment;if(t)if(typeof t=="string"){const r=this.createDepthStencilTexture(t);this.attachResource(r),this.depthStencilAttachment=r.view}else t instanceof Xi?this.depthStencilAttachment=t.view:this.depthStencilAttachment=t}createColorTexture(t,r){return this.device.createTexture({id:`${this.id}-color-attachment-${r}`,usage:Xi.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(t){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:Xi.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(t,r){for(let o=0;o<this.colorAttachments.length;++o)if(this.colorAttachments[o]){const c=this.colorAttachments[o].texture.clone({width:t,height:r});this.destroyAttachedResource(this.colorAttachments[o]),this.colorAttachments[o]=c.view,this.attachResource(c.view)}if(this.depthStencilAttachment){const o=this.depthStencilAttachment.texture.clone({width:t,height:r});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=o.view,this.attachResource(o)}this.updateAttachments()}};G(mp,"defaultProps",{...wi.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let zd=mp;const _p=class _p extends wi{constructor(t,r){super(t,r,_p.defaultProps);G(this,"shaderLayout");G(this,"bufferLayout");G(this,"linkStatus","pending");G(this,"hash","");this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(t){throw new Error("Use uniform blocks")}};G(_p,"defaultProps",{...wi.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let fc=_p;const Zn=class Zn extends wi{get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=Zn.normalizeProps(e,t),super(e,t,Zn.defaultProps)}static normalizeProps(e,t){var c;return{...(c=e.props._resourceDefaults)==null?void 0:c.renderPass,...t}}};G(Zn,"defaultClearColor",[0,0,0,1]),G(Zn,"defaultClearDepth",1),G(Zn,"defaultClearStencil",0),G(Zn,"defaultProps",{...wi.defaultProps,framebuffer:null,parameters:void 0,clearColor:Zn.defaultClearColor,clearColors:void 0,clearDepth:Zn.defaultClearDepth,clearStencil:Zn.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let Jm=Zn;const yp=class yp extends wi{constructor(t,r){super(t,r,yp.defaultProps);G(this,"hash","");G(this,"shaderLayout");this.shaderLayout=r.shaderLayout}get[Symbol.toStringTag](){return"ComputePipeline"}};G(yp,"defaultProps",{...wi.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let Ud=yp;const xp=class xp extends wi{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,xp.defaultProps)}};G(xp,"defaultProps",{...wi.defaultProps,measureExecutionTime:void 0});let Qm=xp;const vp=class vp extends wi{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,vp.defaultProps)}};G(vp,"defaultProps",{...wi.defaultProps});let e_=vp;function D3(i){const[e,t]=F3[i],r=e==="i32"||e==="u32",o=e!=="u32",c=L3[e]*t,f=O3(e,t);return{dataType:e,components:t,defaultVertexFormat:f,byteLength:c,integer:r,signed:o}}function O3(i,e){let t;switch(i){case"f32":t="float32";break;case"i32":t="sint32";break;case"u32":t="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?t:`${t}x${e}`}const F3={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},L3={f32:4,f16:2,i32:4,u32:4};function Zw(i){let e;i.endsWith("-webgl")&&(i.replace("-webgl",""),e=!0);const[t,r]=i.split("x"),o=t,c=r?parseInt(r):1,f=Vw(o),a={type:o,components:c,byteLength:f.byteLength*c,integer:f.integer,signed:f.signed,normalized:f.normalized};return e&&(a.webglOnly=!0),a}function Xw(i,e){const t={};for(const r of i.attributes){const o=N3(i,e,r.name);o&&(t[r.name]=o)}return t}function B3(i,e,t=16){const r=Xw(i,e),o=new Array(t).fill(null);for(const c of Object.values(r))o[c.location]=c;return o}function N3(i,e,t){const r=z3(i,t),o=U3(e,t);if(!r)return null;const c=D3(r.type),f=(o==null?void 0:o.vertexFormat)||c.defaultVertexFormat,a=Zw(f);return{attributeName:(o==null?void 0:o.attributeName)||r.name,bufferName:(o==null?void 0:o.bufferName)||r.name,location:r.location,shaderType:r.type,shaderDataType:c.dataType,shaderComponents:c.components,vertexFormat:f,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:c.integer,stepMode:(o==null?void 0:o.stepMode)||r.stepMode||"vertex",byteOffset:(o==null?void 0:o.byteOffset)||0,byteStride:(o==null?void 0:o.byteStride)||0}}function z3(i,e){const t=i.attributes.find(r=>r.name===e);return t||ut.warn(`shader layout attribute "${e}" not present in shader`),t||null}function U3(i,e){V3(i);let t=j3(i,e);return t||(t=$3(i,e),t)?t:(ut.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function V3(i){for(const e of i)(e.attributes&&e.format||!e.attributes&&!e.format)&&ut.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function j3(i,e){for(const t of i)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function $3(i,e){var t;for(const r of i){let o=r.byteStride;if(typeof r.byteStride!="number")for(const f of r.attributes||[]){const a=Zw(f.format);o+=a.byteLength}const c=(t=r.attributes)==null?void 0:t.find(f=>f.attribute===e);if(c)return{attributeName:c.attribute,bufferName:r.name,stepMode:r.stepMode,vertexFormat:c.format,byteOffset:c.byteOffset,byteStride:o}}return null}const bp=class bp extends wi{constructor(t,r){super(t,r,bp.defaultProps);G(this,"maxVertexAttributes");G(this,"attributeInfos");G(this,"indexBuffer",null);G(this,"attributes");this.maxVertexAttributes=t.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:o,bufferLayout:c}=r.renderPipeline||{};if(!o||!c)throw new Error("VertexArray");this.attributeInfos=B3(o,c,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(t,r){this.device.reportError(new Error("constant attributes not supported"))}};G(bp,"defaultProps",{...wi.defaultProps,renderPipeline:null});let t_=bp;const wp=class wp extends wi{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,wp.defaultProps)}};G(wp,"defaultProps",{...wi.defaultProps,layout:void 0,buffers:{}});let i_=wp;const Tp=class Tp extends wi{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,Tp.defaultProps)}};G(Tp,"defaultProps",{...wi.defaultProps,type:void 0,count:void 0});let r_=Tp;const W3={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function H3(i){return W3[i]}function Z3(i,e){switch(e){case 1:return i;case 2:return i+i%2;default:return i+(4-i%4)%4}}let Gf;function qw(i){return(!Gf||Gf.byteLength<i)&&(Gf=new ArrayBuffer(i)),Gf}function X3(i,e){const t=qw(i.BYTES_PER_ELEMENT*e);return new i(t,0,e)}function q3(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Vd(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":q3(i)}const Hv=1024;class G3{constructor(e){G(this,"layout",{});G(this,"byteLength");let t=0;for(const[o,c]of Object.entries(e)){const f=H3(c),{type:a,components:y}=f;t=Z3(t,y);const T=t;t+=y,this.layout[o]={type:a,size:y,offset:T}}t+=(4-t%4)%4;const r=t*4;this.byteLength=Math.max(r,Hv)}getData(e){const t=Math.max(this.byteLength,Hv),r=qw(t),o={i32:new Int32Array(r),u32:new Uint32Array(r),f32:new Float32Array(r),f16:new Uint16Array(r)};for(const[c,f]of Object.entries(e)){const a=this.layout[c];if(!a){ut.warn(`Supplied uniform value ${c} not present in uniform block layout`)();continue}const{type:y,size:T,offset:A}=a,M=o[y];if(T===1){if(typeof f!="number"&&typeof f!="boolean"){ut.warn(`Supplied value for single component uniform ${c} is not a number: ${f}`)();continue}M[A]=Number(f)}else{if(!Vd(f)){ut.warn(`Supplied value for multi component / array uniform ${c} is not a numeric array: ${f}`)();continue}M.set(f,A)}}return new Uint8Array(r)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function Y3(i,e,t=16){if(i!==e)return!1;const r=i,o=e;if(!Vd(r))return!1;if(Vd(o)&&r.length===o.length){for(let c=0;c<r.length;++c)if(o[c]!==r[c])return!1}return!0}function K3(i){return Vd(i)?i.slice():i}class J3{constructor(e){G(this,"name");G(this,"uniforms",{});G(this,"modifiedUniforms",{});G(this,"modified",!0);G(this,"bindingLayout",{});G(this,"needsRedraw","initialized");var t;if(this.name=(e==null?void 0:e.name)||"unnamed",e!=null&&e.name&&(e!=null&&e.shaderLayout)){const r=(t=e==null?void 0:e.shaderLayout.bindings)==null?void 0:t.find(c=>c.type==="uniform"&&c.name===(e==null?void 0:e.name));if(!r)throw new Error(e==null?void 0:e.name);const o=r;for(const c of o.uniforms||[])this.bindingLayout[c.name]=c}}setUniforms(e){for(const[t,r]of Object.entries(e))this._setUniform(t,r),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${r}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){Y3(this.uniforms[e],t)||(this.uniforms[e]=K3(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class Q3{constructor(e){G(this,"uniformBlocks",new Map);G(this,"uniformBufferLayouts",new Map);G(this,"uniformBuffers",new Map);for(const[t,r]of Object.entries(e)){const o=t,c=new G3(r.uniformTypes||{});this.uniformBufferLayouts.set(o,c);const f=new J3({name:t});f.setUniforms(r.defaultUniforms||{}),this.uniformBlocks.set(o,f)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){var t;for(const[r,o]of Object.entries(e))(t=this.uniformBlocks.get(r))==null||t.setUniforms(o);this.updateUniformBuffers()}getUniformBufferByteLength(e){var t;return((t=this.uniformBufferLayouts.get(e))==null?void 0:t.byteLength)||0}getUniformBufferData(e){var r,o;const t=((r=this.uniformBlocks.get(e))==null?void 0:r.getAllUniforms())||{};return(o=this.uniformBufferLayouts.get(e))==null?void 0:o.getData(t)}createUniformBuffer(e,t,r){r&&this.setUniforms(r);const o=this.getUniformBufferByteLength(t),c=e.createBuffer({usage:Fi.UNIFORM|Fi.COPY_DST,byteLength:o}),f=this.getUniformBufferData(t);return c.write(f),c}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const r=this.getUniformBufferByteLength(t),o=e.createBuffer({usage:Fi.UNIFORM|Fi.COPY_DST,byteLength:r});this.uniformBuffers.set(t,o)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const r=this.updateUniformBuffer(t);e||(e=r)}return e&&ut.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){var c;const t=this.uniformBlocks.get(e);let r=this.uniformBuffers.get(e),o=!1;if(r&&(t!=null&&t.needsRedraw)){o||(o=t.needsRedraw);const f=this.getUniformBufferData(e);r=this.uniformBuffers.get(e),r==null||r.write(f);const a=(c=this.uniformBlocks.get(e))==null?void 0:c.getAllUniforms();ut.log(4,`Writing to uniform buffer ${String(e)}`,f,a)()}return o}}function Gw(i){const e=ArrayBuffer.isView(i)?i.constructor:i;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function Yw(i){switch(i){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(i)}}function eI(i,e,t){if(!e||e>4)throw new Error(`size ${e}`);const r=e;let o=Gw(i);if(o==="uint8"&&t&&r===1)return"unorm8-webgl";if(o==="uint8"&&t&&r===3)return"unorm8x3-webgl";if(o==="uint8"||o==="sint8"){if(r===1||r===3)throw new Error(`size: ${e}`);return t&&(o=o.replace("int","norm")),`${o}x${r}`}if(o==="uint16"||o==="sint16"){if(r===1||r===3)throw new Error(`size: ${e}`);return t&&(o=o.replace("int","norm")),`${o}x${r}`}return r===1?o:`${o}x${r}`}class um{constructor(e){G(this,"bufferLayouts");this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){var t;return e.attributes?(t=e.attributes)==null?void 0:t.map(r=>r.attribute):[e.name]}mergeBufferLayouts(e,t){const r=[...e];for(const o of t){const c=r.findIndex(f=>f.name===o.name);c<0?r.push(o):r[c]=o}return r}}class Tn{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}getTypeName(){return this.name}}class Zv{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Xo extends Tn{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Jo extends Tn{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class Za extends Tn{constructor(e,t,r,o){super(e,r),this.format=t,this.access=o}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var $o;(i=>{i[i.Uniform=0]="Uniform",i[i.Storage=1]="Storage",i[i.Texture=2]="Texture",i[i.Sampler=3]="Sampler",i[i.StorageTexture=4]="StorageTexture"})($o||($o={}));class Yf{constructor(e,t,r,o,c,f,a){this.name=e,this.type=t,this.group=r,this.binding=o,this.attributes=c,this.resourceType=f,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class tI{constructor(e,t){this.name=e,this.type=t}}class iI{constructor(e,t,r,o){this.name=e,this.type=t,this.locationType=r,this.location=o,this.interpolation=null}}class Xv{constructor(e,t,r,o){this.name=e,this.type=t,this.locationType=r,this.location=o}}class rI{constructor(e,t,r,o){this.name=e,this.type=t,this.attributes=r,this.id=o}}class nI{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r}}class sI{constructor(e,t=null,r){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=r}}class oI{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}const Kw=new Float32Array(1),aI=new Int32Array(Kw.buffer),Lr=new Uint16Array(1);function lI(i){Kw[0]=i;const e=aI[0],t=e>>31&1;let r=e>>23&255,o=8388607&e;if(r===255)return Lr[0]=t<<15|31744|(o!==0?512:0),Lr[0];if(r===0){if(o===0)return Lr[0]=t<<15,Lr[0];o|=8388608;let c=113;for(;!(8388608&o);)o<<=1,c--;return r=127-c,o&=8388607,r>0?(o=(o>>126-r)+(o>>127-r&1),Lr[0]=t<<15|r<<10|o>>13,Lr[0]):(Lr[0]=t<<15,Lr[0])}return r=r-127+15,r>=31?(Lr[0]=t<<15|31744,Lr[0]):r<=0?r<-10?(Lr[0]=t<<15,Lr[0]):(o=(8388608|o)>>1-r,Lr[0]=t<<15|o>>13,Lr[0]):(o>>=13,Lr[0]=t<<15|r<<10|o,Lr[0])}const G_=new Uint32Array(1),Jw=new Float32Array(G_.buffer,0,1);function qv(i){const e=112+(i>>6&31)<<23|(63&i)<<17;return G_[0]=e,Jw[0]}function cI(i,e,t,r,o,c,f,a,y){const T=r*(f>>=o)*(c>>=o)+t*f+e*a;switch(y){case"r8unorm":return[fi(i,T,"8unorm",1)[0]];case"r8snorm":return[fi(i,T,"8snorm",1)[0]];case"r8uint":return[fi(i,T,"8uint",1)[0]];case"r8sint":return[fi(i,T,"8sint",1)[0]];case"rg8unorm":{const A=fi(i,T,"8unorm",2);return[A[0],A[1]]}case"rg8snorm":{const A=fi(i,T,"8snorm",2);return[A[0],A[1]]}case"rg8uint":{const A=fi(i,T,"8uint",2);return[A[0],A[1]]}case"rg8sint":{const A=fi(i,T,"8sint",2);return[A[0],A[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const A=fi(i,T,"8unorm",4);return[A[0],A[1],A[2],A[3]]}case"rgba8snorm":{const A=fi(i,T,"8snorm",4);return[A[0],A[1],A[2],A[3]]}case"rgba8uint":{const A=fi(i,T,"8uint",4);return[A[0],A[1],A[2],A[3]]}case"rgba8sint":{const A=fi(i,T,"8sint",4);return[A[0],A[1],A[2],A[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const A=fi(i,T,"8unorm",4);return[A[2],A[1],A[0],A[3]]}case"r16uint":return[fi(i,T,"16uint",1)[0]];case"r16sint":return[fi(i,T,"16sint",1)[0]];case"r16float":return[fi(i,T,"16float",1)[0]];case"rg16uint":{const A=fi(i,T,"16uint",2);return[A[0],A[1]]}case"rg16sint":{const A=fi(i,T,"16sint",2);return[A[0],A[1]]}case"rg16float":{const A=fi(i,T,"16float",2);return[A[0],A[1]]}case"rgba16uint":{const A=fi(i,T,"16uint",4);return[A[0],A[1],A[2],A[3]]}case"rgba16sint":{const A=fi(i,T,"16sint",4);return[A[0],A[1],A[2],A[3]]}case"rgba16float":{const A=fi(i,T,"16float",4);return[A[0],A[1],A[2],A[3]]}case"r32uint":return[fi(i,T,"32uint",1)[0]];case"r32sint":return[fi(i,T,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[fi(i,T,"32float",1)[0]];case"rg32uint":{const A=fi(i,T,"32uint",2);return[A[0],A[1]]}case"rg32sint":{const A=fi(i,T,"32sint",2);return[A[0],A[1]]}case"rg32float":{const A=fi(i,T,"32float",2);return[A[0],A[1]]}case"rgba32uint":{const A=fi(i,T,"32uint",4);return[A[0],A[1],A[2],A[3]]}case"rgba32sint":{const A=fi(i,T,"32sint",4);return[A[0],A[1],A[2],A[3]]}case"rgba32float":{const A=fi(i,T,"32float",4);return[A[0],A[1],A[2],A[3]]}case"rg11b10ufloat":{const A=new Uint32Array(i.buffer,T,1)[0],M=(4192256&A)>>11,F=(4290772992&A)>>22;return[qv(2047&A),qv(M),function(L){const Y=112+(L>>5&31)<<23|(31&L)<<18;return G_[0]=Y,Jw[0]}(F),1]}}return null}function fi(i,e,t,r){const o=[0,0,0,0];for(let T=0;T<r;++T)switch(t){case"8unorm":o[T]=i[e]/255,e++;break;case"8snorm":o[T]=i[e]/255*2-1,e++;break;case"8uint":o[T]=i[e],e++;break;case"8sint":o[T]=i[e]-127,e++;break;case"16uint":o[T]=i[e]|i[e+1]<<8,e+=2;break;case"16sint":o[T]=(i[e]|i[e+1]<<8)-32768,e+=2;break;case"16float":o[T]=(c=i[e]|i[e+1]<<8,f=void 0,a=void 0,y=void 0,f=(32768&c)>>15,y=1023&c,(a=(31744&c)>>10)==0?(f?-1:1)*Math.pow(2,-14)*(y/Math.pow(2,10)):a==31?y?NaN:1/0*(f?-1:1):(f?-1:1)*Math.pow(2,a-15)*(1+y/Math.pow(2,10))),e+=2;break;case"32uint":case"32sint":o[T]=i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24,e+=4;break;case"32float":o[T]=new Float32Array(i.buffer,e,1)[0],e+=4}var c,f,a,y;return o}function pi(i,e,t,r,o){for(let c=0;c<r;++c)switch(t){case"8unorm":i[e]=255*o[c],e++;break;case"8snorm":i[e]=.5*(o[c]+1)*255,e++;break;case"8uint":i[e]=o[c],e++;break;case"8sint":i[e]=o[c]+127,e++;break;case"16uint":new Uint16Array(i.buffer,e,1)[0]=o[c],e+=2;break;case"16sint":new Int16Array(i.buffer,e,1)[0]=o[c],e+=2;break;case"16float":{const f=lI(o[c]);new Uint16Array(i.buffer,e,1)[0]=f,e+=2;break}case"32uint":new Uint32Array(i.buffer,e,1)[0]=o[c],e+=4;break;case"32sint":new Int32Array(i.buffer,e,1)[0]=o[c],e+=4;break;case"32float":new Float32Array(i.buffer,e,1)[0]=o[c],e+=4}return o}const hm={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class In{constructor(){this.id=In._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(jd.instance);for(const r of e)r instanceof Array?this.searchBlock(r,t):r.search(t);t($d.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}In._id=0;class jd extends In{}jd.instance=new jd;class $d extends In{}$d.instance=new $d;const Qw=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class zi extends In{constructor(){super()}}class ch extends zi{constructor(e,t,r,o,c,f){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=r,this.body=o,this.startLine=c,this.endLine=f}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class uI extends zi{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class e1 extends zi{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class n_ extends zi{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class t1 extends zi{constructor(e,t,r,o){super(),this.init=e,this.condition=t,this.increment=r,this.body=o}get astNodeType(){return"for"}search(e){var t,r,o;(t=this.init)===null||t===void 0||t.search(e),(r=this.condition)===null||r===void 0||r.search(e),(o=this.increment)===null||o===void 0||o.search(e),this.searchBlock(this.body,e)}}class Ks extends zi{constructor(e,t,r,o,c){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=o,this.value=c}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Y_ extends zi{constructor(e,t,r){super(),this.attributes=null,this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class th extends zi{constructor(e,t,r,o,c){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=o,this.value=c}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class pd extends zi{constructor(e,t,r,o,c){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=o,this.value=c}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var ic,Wu,Fe,Se;(i=>{i.increment="++",i.decrement="--"})(ic||(ic={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return i[t]}})(ic||(ic={}));class i1 extends zi{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(i=>{i.assign="=",i.addAssign="+=",i.subtractAssin="-=",i.multiplyAssign="*=",i.divideAssign="/=",i.moduloAssign="%=",i.andAssign="&=",i.orAssign="|=",i.xorAssign="^=",i.shiftLeftAssign="<<=",i.shiftRightAssign=">>="})(Wu||(Wu={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(Wu||(Wu={}));class r1 extends zi{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class K_ extends zi{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return Qw.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class n1 extends zi{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class s1 extends zi{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}}class o1 extends zi{constructor(e,t,r,o){super(),this.condition=e,this.body=t,this.elseif=r,this.else=o}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class a1 extends zi{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class hI extends zi{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class fI extends zi{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class l1 extends zi{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class J_ extends zi{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class dI extends zi{constructor(){super()}get astNodeType(){return"discard"}}class c1 extends zi{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class u1 extends zi{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class it extends zi{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const o=it._priority.get(t.name);it._priority.get(e[r].name)<o&&(t=e[r])}return t.name==="x32"?it.i32:t}getTypeName(){return this.name}}it.x32=new it("x32"),it.f32=new it("f32"),it.i32=new it("i32"),it.u32=new it("u32"),it.f16=new it("f16"),it.bool=new it("bool"),it.void=new it("void"),it._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class Gv extends it{constructor(e){super(e)}}class Gs extends it{constructor(e,t,r,o){super(e),this.members=t,this.startLine=r,this.endLine=o}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class Me extends it{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}Me.vec2f=new Me("vec2",it.f32,null),Me.vec3f=new Me("vec3",it.f32,null),Me.vec4f=new Me("vec4",it.f32,null),Me.vec2i=new Me("vec2",it.i32,null),Me.vec3i=new Me("vec3",it.i32,null),Me.vec4i=new Me("vec4",it.i32,null),Me.vec2u=new Me("vec2",it.u32,null),Me.vec3u=new Me("vec3",it.u32,null),Me.vec4u=new Me("vec4",it.u32,null),Me.vec2h=new Me("vec2",it.f16,null),Me.vec3h=new Me("vec3",it.f16,null),Me.vec4h=new Me("vec4",it.f16,null),Me.vec2b=new Me("vec2",it.bool,null),Me.vec3b=new Me("vec3",it.bool,null),Me.vec4b=new Me("vec4",it.bool,null),Me.mat2x2f=new Me("mat2x2",it.f32,null),Me.mat2x3f=new Me("mat2x3",it.f32,null),Me.mat2x4f=new Me("mat2x4",it.f32,null),Me.mat3x2f=new Me("mat3x2",it.f32,null),Me.mat3x3f=new Me("mat3x3",it.f32,null),Me.mat3x4f=new Me("mat3x4",it.f32,null),Me.mat4x2f=new Me("mat4x2",it.f32,null),Me.mat4x3f=new Me("mat4x3",it.f32,null),Me.mat4x4f=new Me("mat4x4",it.f32,null),Me.mat2x2h=new Me("mat2x2",it.f16,null),Me.mat2x3h=new Me("mat2x3",it.f16,null),Me.mat2x4h=new Me("mat2x4",it.f16,null),Me.mat3x2h=new Me("mat3x2",it.f16,null),Me.mat3x3h=new Me("mat3x3",it.f16,null),Me.mat3x4h=new Me("mat3x4",it.f16,null),Me.mat4x2h=new Me("mat4x2",it.f16,null),Me.mat4x3h=new Me("mat4x3",it.f16,null),Me.mat4x4h=new Me("mat4x4",it.f16,null),Me.mat2x2i=new Me("mat2x2",it.i32,null),Me.mat2x3i=new Me("mat2x3",it.i32,null),Me.mat2x4i=new Me("mat2x4",it.i32,null),Me.mat3x2i=new Me("mat3x2",it.i32,null),Me.mat3x3i=new Me("mat3x3",it.i32,null),Me.mat3x4i=new Me("mat3x4",it.i32,null),Me.mat4x2i=new Me("mat4x2",it.i32,null),Me.mat4x3i=new Me("mat4x3",it.i32,null),Me.mat4x4i=new Me("mat4x4",it.i32,null),Me.mat2x2u=new Me("mat2x2",it.u32,null),Me.mat2x3u=new Me("mat2x3",it.u32,null),Me.mat2x4u=new Me("mat2x4",it.u32,null),Me.mat3x2u=new Me("mat3x2",it.u32,null),Me.mat3x3u=new Me("mat3x3",it.u32,null),Me.mat3x4u=new Me("mat3x4",it.u32,null),Me.mat4x2u=new Me("mat4x2",it.u32,null),Me.mat4x3u=new Me("mat4x3",it.u32,null),Me.mat4x4u=new Me("mat4x4",it.u32,null);class fm extends it{constructor(e,t,r,o){super(e),this.storage=t,this.type=r,this.access=o}get astNodeType(){return"pointer"}}class ih extends it{constructor(e,t,r,o){super(e),this.attributes=t,this.format=r,this.count=o}get astNodeType(){return"array"}get isArray(){return!0}}class Hu extends it{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class As extends In{constructor(){super(),this.postfix=null}}class Xa extends As{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class ys extends As{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class Q_ extends As{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return Qw.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class fn extends As{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class h1 extends As{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const r=e.evalExpression(this.initializer,e.context);return r!==null&&this.postfix?r.getSubData(e,this.postfix,e.context):r}return null}search(e){this.initializer.search(e)}}class pr extends As{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof Te}get isVector(){return this.value instanceof ne||this.value instanceof Nt}get scalarValue(){return this.value instanceof Te?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof ne||this.value instanceof Nt?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class f1 extends As{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class dc extends As{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class d1 extends As{constructor(){super()}}class ar extends d1{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Hn extends d1{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?it.f32:e.name==="u32"||t.name==="u32"?it.u32:it.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class p1 extends In{constructor(e){super(),this.body=e}}class gd extends As{constructor(){super()}get astNodeType(){return"default"}}class g1 extends p1{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class m1 extends p1{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Yv extends In{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class pI extends In{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Kv extends In{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class _1 extends In{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class En{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=En._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,r,o){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,r){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.name}>`}}En._id=0;class s_ extends En{constructor(){super(new Tn("void",null),null)}toString(){return"void"}}s_.void=new s_;class Jl extends En{constructor(e){super(new Tn("pointer",null),null),this.reference=e}clone(){return this}setDataValue(e,t,r,o){this.reference.setDataValue(e,t,r,o)}getSubData(e,t,r){return t?this.reference.getSubData(e,t,r):this}}class Te extends En{constructor(e,t,r=null){super(t,r),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new Te(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new Te(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new Te(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,r,o){if(r)return void console.error("SetDataValue: Scalar data does not support postfix",r);if(!(t instanceof Te))return void console.error("SetDataValue: Invalid value",t);let c=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?c=Math.floor(c):this.typeInfo.name==="bool"&&(c=c?1:0),this.data[0]=c}getSubData(e,t,r){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function gI(i,e,t){const r=e.length;return r===2?t==="f32"?new ne(new Float32Array(e),i.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),i.getTypeInfo("vec2i")):t==="u32"?new ne(new Uint32Array(e),i.getTypeInfo("vec2u")):t==="f16"?new ne(new Float32Array(e),i.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):r===3?t==="f32"?new ne(new Float32Array(e),i.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),i.getTypeInfo("vec3i")):t==="u32"?new ne(new Uint32Array(e),i.getTypeInfo("vec3u")):t==="f16"?new ne(new Float32Array(e),i.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):r===4?t==="f32"?new ne(new Float32Array(e),i.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),i.getTypeInfo("vec4i")):t==="u32"?new ne(new Uint32Array(e),i.getTypeInfo("vec4u")):t==="f16"?new ne(new Float32Array(e),i.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class ne extends En{constructor(e,t,r=null){if(super(t,r),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const o=this.typeInfo.name;o==="vec2f"||o==="vec3f"||o==="vec4f"?this.data=new Float32Array(e):o==="vec2i"||o==="vec3i"||o==="vec4i"?this.data=new Int32Array(e):o==="vec2u"||o==="vec3u"||o==="vec4u"?this.data=new Uint32Array(e):o==="vec2h"||o==="vec3h"||o==="vec4h"?this.data=new Float32Array(e):o==="vec2b"||o==="vec3b"||o==="vec4b"?this.data=new Int32Array(e):o==="vec2"||o==="vec3"||o==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${o}`)}}clone(){if(this.data instanceof Float32Array)return new ne(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new ne(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new ne(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,r,o){r instanceof Xa?console.error("TODO: Set vector postfix"):t instanceof ne?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;let o=e.getTypeInfo("f32");if(this.typeInfo instanceof Za)o=this.typeInfo.format||o;else{const f=this.typeInfo.name;f==="vec2f"||f==="vec3f"||f==="vec4f"?o=e.getTypeInfo("f32"):f==="vec2i"||f==="vec3i"||f==="vec4i"?o=e.getTypeInfo("i32"):f==="vec2b"||f==="vec3b"||f==="vec4b"?o=e.getTypeInfo("bool"):f==="vec2u"||f==="vec3u"||f==="vec4u"?o=e.getTypeInfo("u32"):f==="vec2h"||f==="vec3h"||f==="vec4h"?o=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${f}`)}let c=this;for(;t!==null&&c!==null;){if(t instanceof dc){const f=t.index;let a=-1;if(f instanceof pr){if(!(f.value instanceof Te))return console.error(`GetSubData: Invalid array index ${f.value}`),null;a=f.value.value}else{const y=e.evalExpression(f,r);if(!(y instanceof Te))return console.error("GetSubData: Unknown index type",f),null;a=y.value}if(a<0||a>=c.data.length)return console.error("GetSubData: Index out of range",a),null;if(c.data instanceof Float32Array){const y=new Float32Array(c.data.buffer,c.data.byteOffset+4*a,1);return new Te(y,o)}if(c.data instanceof Int32Array){const y=new Int32Array(c.data.buffer,c.data.byteOffset+4*a,1);return new Te(y,o)}if(c.data instanceof Uint32Array){const y=new Uint32Array(c.data.buffer,c.data.byteOffset+4*a,1);return new Te(y,o)}throw"GetSubData: Invalid data type"}if(!(t instanceof Xa))return console.error("GetSubData: Unknown postfix",t),null;{const f=t.value.toLowerCase();if(f.length===1){let y=0;if(f==="x"||f==="r")y=0;else if(f==="y"||f==="g")y=1;else if(f==="z"||f==="b")y=2;else{if(f!=="w"&&f!=="a")return console.error(`GetSubData: Unknown member ${f}`),null;y=3}if(this.data instanceof Float32Array){let T=new Float32Array(this.data.buffer,this.data.byteOffset+4*y,1);return new Te(T,o,this)}if(this.data instanceof Int32Array){let T=new Int32Array(this.data.buffer,this.data.byteOffset+4*y,1);return new Te(T,o,this)}if(this.data instanceof Uint32Array){let T=new Uint32Array(this.data.buffer,this.data.byteOffset+4*y,1);return new Te(T,o,this)}}const a=[];for(const y of f)y==="x"||y==="r"?a.push(this.data[0]):y==="y"||y==="g"?a.push(this.data[1]):y==="z"||y==="b"?a.push(this.data[2]):y==="w"||y==="a"?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${y}`);c=gI(e,a,o.name)}t=t.postfix}return c}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Nt extends En{constructor(e,t,r=null){super(t,r),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new Nt(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,r,o){r instanceof Xa?console.error("TODO: Set matrix postfix"):t instanceof Nt?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;const o=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof Za)this.typeInfo.format;else if(o.endsWith("f"))e.getTypeInfo("f32");else if(o.endsWith("i"))e.getTypeInfo("i32");else if(o.endsWith("u"))e.getTypeInfo("u32");else{if(!o.endsWith("h"))return console.error(`GetDataValue: Unknown type ${o}`),null;e.getTypeInfo("f16")}if(t instanceof dc){const c=t.index;let f=-1;if(c instanceof pr){if(!(c.value instanceof Te))return console.error(`GetDataValue: Invalid array index ${c.value}`),null;f=c.value.value}else{const T=e.evalExpression(c,r);if(!(T instanceof Te))return console.error("GetDataValue: Unknown index type",c),null;f=T.value}if(f<0||f>=this.data.length)return console.error("GetDataValue: Index out of range",f),null;const a=o.endsWith("h")?"h":"f";let y;if(o==="mat2x2"||o==="mat2x2f"||o==="mat2x2h"||o==="mat3x2"||o==="mat3x2f"||o==="mat3x2h"||o==="mat4x2"||o==="mat4x2f"||o==="mat4x2h")y=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+2*f*4,2),e.getTypeInfo(`vec2${a}`));else if(o==="mat2x3"||o==="mat2x3f"||o==="mat2x3h"||o==="mat3x3"||o==="mat3x3f"||o==="mat3x3h"||o==="mat4x3"||o==="mat4x3f"||o==="mat4x3h")y=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+3*f*4,3),e.getTypeInfo(`vec3${a}`));else{if(o!=="mat2x4"&&o!=="mat2x4f"&&o!=="mat2x4h"&&o!=="mat3x4"&&o!=="mat3x4f"&&o!=="mat3x4h"&&o!=="mat4x4"&&o!=="mat4x4f"&&o!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${o}`),null;y=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+4*f*4,4),e.getTypeInfo(`vec4${a}`))}return t.postfix?y.getSubData(e,t.postfix,r):y}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class qi extends En{constructor(e,t,r=0,o=null){super(t,o),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=r}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new qi(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,r,o){if(t===null)return void console.log("setDataValue: NULL data.");let c=this.offset,f=this.typeInfo;for(;r;){if(r instanceof dc)if(f instanceof Jo){const a=r.index;if(a instanceof pr){if(!(a.value instanceof Te))return void console.error(`SetDataValue: Invalid index type ${a.value}`);c+=a.value.value*f.stride}else{const y=e.evalExpression(a,o);if(!(y instanceof Te))return void console.error("SetDataValue: Unknown index type",a);c+=y.value*f.stride}f=f.format}else console.error(`SetDataValue: Type ${f.getTypeName()} is not an array`);else{if(!(r instanceof Xa))return void console.error("SetDataValue: Unknown postfix type",r);{const a=r.value;if(f instanceof Xo){let y=!1;for(const T of f.members)if(T.name===a){c+=T.offset,f=T.type,y=!0;break}if(!y)return void console.error(`SetDataValue: Member ${a} not found`)}else if(f instanceof Tn){const y=f.getTypeName();let T=0;if(a==="x"||a==="r")T=0;else if(a==="y"||a==="g")T=1;else if(a==="z"||a==="b")T=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);T=3}if(!(t instanceof Te))return void console.error("SetDataValue: Invalid value",t);const A=t.value;return y==="vec2f"?void(new Float32Array(this.buffer,c,2)[T]=A):y==="vec3f"?void(new Float32Array(this.buffer,c,3)[T]=A):y==="vec4f"?void(new Float32Array(this.buffer,c,4)[T]=A):y==="vec2i"?void(new Int32Array(this.buffer,c,2)[T]=A):y==="vec3i"?void(new Int32Array(this.buffer,c,3)[T]=A):y==="vec4i"?void(new Int32Array(this.buffer,c,4)[T]=A):y==="vec2u"?void(new Uint32Array(this.buffer,c,2)[T]=A):y==="vec3u"?void(new Uint32Array(this.buffer,c,3)[T]=A):y==="vec4u"?void(new Uint32Array(this.buffer,c,4)[T]=A):void console.error(`SetDataValue: Type ${y} is not a struct`)}}}r=r.postfix}this.setData(e,t,f,c,o)}setData(e,t,r,o,c){const f=r.getTypeName();if(f!=="f32"&&f!=="f16")if(f!=="i32"&&f!=="atomic<i32>"&&f!=="x32")if(f!=="u32"&&f!=="atomic<u32>")if(f!=="bool")if(f!=="vec2f"&&f!=="vec2h")if(f!=="vec3f"&&f!=="vec3h")if(f!=="vec4f"&&f!=="vec4h")if(f!=="vec2i")if(f!=="vec3i")if(f!=="vec4i")if(f!=="vec2u")if(f!=="vec3u")if(f!=="vec4u")if(f!=="vec2b")if(f!=="vec3b")if(f!=="vec4b")if(f!=="mat2x2f"&&f!=="mat2x2h")if(f!=="mat2x3f"&&f!=="mat2x3h")if(f!=="mat2x4f"&&f!=="mat2x4h")if(f!=="mat3x2f"&&f!=="mat3x2h")if(f!=="mat3x3f"&&f!=="mat3x3h")if(f!=="mat3x4f"&&f!=="mat3x4h")if(f!=="mat4x2f"&&f!=="mat4x2h")if(f!=="mat4x3f"&&f!=="mat4x3h")if(f!=="mat4x4f"&&f!=="mat4x4h")if(t instanceof qi){if(r===t.typeInfo)return void new Uint8Array(this.buffer,o,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",f,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${f}`);else{const a=new Float32Array(this.buffer,o,16);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11],a[12]=t.data[12],a[13]=t.data[13],a[14]=t.data[14],a[15]=t.data[15]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15])}else{const a=new Float32Array(this.buffer,o,12);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11])}else{const a=new Float32Array(this.buffer,o,8);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7])}else{const a=new Float32Array(this.buffer,o,12);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11])}else{const a=new Float32Array(this.buffer,o,9);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8])}else{const a=new Float32Array(this.buffer,o,6);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5])}else{const a=new Float32Array(this.buffer,o,8);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7])}else{const a=new Float32Array(this.buffer,o,6);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5])}else{const a=new Float32Array(this.buffer,o,4);t instanceof Nt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Uint32Array(this.buffer,o,4);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Uint32Array(this.buffer,o,3);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Uint32Array(this.buffer,o,2);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1])}else{const a=new Uint32Array(this.buffer,o,4);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Uint32Array(this.buffer,o,3);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Uint32Array(this.buffer,o,2);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1])}else{const a=new Int32Array(this.buffer,o,4);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Int32Array(this.buffer,o,3);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Int32Array(this.buffer,o,2);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1])}else{const a=new Float32Array(this.buffer,o,4);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])}else{const a=new Float32Array(this.buffer,o,3);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2])}else{const a=new Float32Array(this.buffer,o,2);t instanceof ne?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1])}else t instanceof Te&&(new Int32Array(this.buffer,o,1)[0]=t.value);else t instanceof Te&&(new Uint32Array(this.buffer,o,1)[0]=t.value);else t instanceof Te&&(new Int32Array(this.buffer,o,1)[0]=t.value);else t instanceof Te&&(new Float32Array(this.buffer,o,1)[0]=t.value)}getSubData(e,t,r){var o,c,f;if(t===null)return this;let a=this.offset,y=this.typeInfo;for(;t;){if(t instanceof dc){const A=t.index,M=e.evalExpression(A,r);let F=0;if(M instanceof Te?F=M.value:console.error("GetDataValue: Invalid index type",A),y instanceof Jo)a+=F*y.stride,y=y.format;else{const L=y.getTypeName();L==="mat4x4"||L==="mat4x4f"||L==="mat4x4h"?(a+=16*F,y=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${y.getTypeName()} is not an array`)}}else{if(!(t instanceof Xa))return console.error("GetDataValue: Unknown postfix type",t),null;{const A=t.value;if(y instanceof Xo){let M=!1;for(const F of y.members)if(F.name===A){a+=F.offset,y=F.type,M=!0;break}if(!M)return console.error(`GetDataValue: Member ${A} not found`),null}else if(y instanceof Tn){const M=y.getTypeName();if(M==="vec2f"||M==="vec3f"||M==="vec4f"||M==="vec2i"||M==="vec3i"||M==="vec4i"||M==="vec2u"||M==="vec3u"||M==="vec4u"||M==="vec2b"||M==="vec3b"||M==="vec4b"||M==="vec2h"||M==="vec3h"||M==="vec4h"||M==="vec2"||M==="vec3"||M==="vec4"){if(A.length>0&&A.length<5){let F="f";const L=[];for(let Y=0;Y<A.length;++Y){const ae=A[Y].toLowerCase();let pe=0;if(ae==="x"||ae==="r")pe=0;else if(ae==="y"||ae==="g")pe=1;else if(ae==="z"||ae==="b")pe=2;else{if(ae!=="w"&&ae!=="a")return console.error(`Unknown member ${A}`),null;pe=3}if(A.length===1){if(M.endsWith("f"))return this.buffer.byteLength<a+4*pe+4?(console.log("Insufficient buffer data"),null):new Te(new Float32Array(this.buffer,a+4*pe,1),e.getTypeInfo("f32"),this);if(M.endsWith("h"))return new Te(new Float32Array(this.buffer,a+4*pe,1),e.getTypeInfo("f16"),this);if(M.endsWith("i"))return new Te(new Int32Array(this.buffer,a+4*pe,1),e.getTypeInfo("i32"),this);if(M.endsWith("b"))return new Te(new Int32Array(this.buffer,a+4*pe,1),e.getTypeInfo("bool"),this);if(M.endsWith("u"))return new Te(new Uint32Array(this.buffer,a+4*pe,1),e.getTypeInfo("i32"),this)}if(M==="vec2f")L.push(new Float32Array(this.buffer,a,2)[pe]);else if(M==="vec3f"){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const Ee=new Float32Array(this.buffer,a,3);L.push(Ee[pe])}else if(M==="vec4f")L.push(new Float32Array(this.buffer,a,4)[pe]);else if(M==="vec2i")F="i",L.push(new Int32Array(this.buffer,a,2)[pe]);else if(M==="vec3i")F="i",L.push(new Int32Array(this.buffer,a,3)[pe]);else if(M==="vec4i")F="i",L.push(new Int32Array(this.buffer,a,4)[pe]);else if(M==="vec2u"){F="u";const Ee=new Uint32Array(this.buffer,a,2);L.push(Ee[pe])}else M==="vec3u"?(F="u",L.push(new Uint32Array(this.buffer,a,3)[pe])):M==="vec4u"&&(F="u",L.push(new Uint32Array(this.buffer,a,4)[pe]))}return L.length===2?y=e.getTypeInfo(`vec2${F}`):L.length===3?y=e.getTypeInfo(`vec3${F}`):L.length===4?y=e.getTypeInfo(`vec4${F}`):console.error(`GetDataValue: Invalid vector length ${L.length}`),new ne(L,y,null)}return console.error(`GetDataValue: Unknown member ${A}`),null}return console.error(`GetDataValue: Type ${M} is not a struct`),null}}}t=t.postfix}const T=y.getTypeName();return T==="f32"?new Te(new Float32Array(this.buffer,a,1),y,this):T==="i32"?new Te(new Int32Array(this.buffer,a,1),y,this):T==="u32"?new Te(new Uint32Array(this.buffer,a,1),y,this):T==="vec2f"?new ne(new Float32Array(this.buffer,a,2),y,this):T==="vec3f"?new ne(new Float32Array(this.buffer,a,3),y,this):T==="vec4f"?new ne(new Float32Array(this.buffer,a,4),y,this):T==="vec2i"?new ne(new Int32Array(this.buffer,a,2),y,this):T==="vec3i"?new ne(new Int32Array(this.buffer,a,3),y,this):T==="vec4i"?new ne(new Int32Array(this.buffer,a,4),y,this):T==="vec2u"?new ne(new Uint32Array(this.buffer,a,2),y,this):T==="vec3u"?new ne(new Uint32Array(this.buffer,a,3),y,this):T==="vec4u"?new ne(new Uint32Array(this.buffer,a,4),y,this):y instanceof Za&&y.name==="atomic"?((o=y.format)===null||o===void 0?void 0:o.name)==="u32"?new Te(new Uint32Array(this.buffer,a,1)[0],y.format,this):((c=y.format)===null||c===void 0?void 0:c.name)==="i32"?new Te(new Int32Array(this.buffer,a,1)[0],y.format,this):(console.error(`GetDataValue: Invalid atomic format ${(f=y.format)===null||f===void 0?void 0:f.name}`),null):new qi(this.buffer,y,a,this)}toString(){let e="";if(this.typeInfo instanceof Jo)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let r=1;r<t.length/2;++r)e+=`, [${t[2*r]}, ${t[2*r+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}, ${t[r+3]}]`}else e="[...]";else this.typeInfo instanceof Xo?e+="{...}":e="[...]";return e}}class Ys extends En{constructor(e,t,r,o){super(t,null),this.data=e,this.descriptor=r,this.view=o}clone(){return new Ys(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>0?(e=r[0])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.width)!==null&&t!==void 0?t:0}get height(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>1?(e=r[1])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>2?(e=r[2])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let r=0;r<t.length;++r)t[r]=Math.max(1,t[r]>>e);return t}get texelByteSize(){const e=this.format,t=hm[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=hm[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=hm[e],r=this.width;if(!e||r<=0||!t)return-1;const o=this.height,c=this.depthOrArrayLayers,f=this.dimension;return r/t.blockWidth*(f==="1d"?1:o/t.blockHeight)*t.bytesPerBlock*c}getPixel(e,t,r=0,o=0){const c=this.texelByteSize,f=this.bytesPerRow,a=this.height,y=this.data[o];return cI(new Uint8Array(y),e,t,r,o,a,f,c,this.format)}setPixel(e,t,r,o,c){const f=this.texelByteSize,a=this.bytesPerRow,y=this.height,T=this.data[o];(function(A,M,F,L,Y,ae,pe,Ee,Be,xe){const Ce=L*(pe>>=Y)*(ae>>=Y)+F*pe+M*Ee;switch(Be){case"r8unorm":return void pi(A,Ce,"8unorm",1,xe);case"r8snorm":return void pi(A,Ce,"8snorm",1,xe);case"r8uint":return void pi(A,Ce,"8uint",1,xe);case"r8sint":return void pi(A,Ce,"8sint",1,xe);case"rg8unorm":return void pi(A,Ce,"8unorm",2,xe);case"rg8snorm":return void pi(A,Ce,"8snorm",2,xe);case"rg8uint":return void pi(A,Ce,"8uint",2,xe);case"rg8sint":return void pi(A,Ce,"8sint",2,xe);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void pi(A,Ce,"8unorm",4,xe);case"rgba8snorm":return void pi(A,Ce,"8snorm",4,xe);case"rgba8uint":return void pi(A,Ce,"8uint",4,xe);case"rgba8sint":return void pi(A,Ce,"8sint",4,xe);case"r16uint":return void pi(A,Ce,"16uint",1,xe);case"r16sint":return void pi(A,Ce,"16sint",1,xe);case"r16float":return void pi(A,Ce,"16float",1,xe);case"rg16uint":return void pi(A,Ce,"16uint",2,xe);case"rg16sint":return void pi(A,Ce,"16sint",2,xe);case"rg16float":return void pi(A,Ce,"16float",2,xe);case"rgba16uint":return void pi(A,Ce,"16uint",4,xe);case"rgba16sint":return void pi(A,Ce,"16sint",4,xe);case"rgba16float":return void pi(A,Ce,"16float",4,xe);case"r32uint":return void pi(A,Ce,"32uint",1,xe);case"r32sint":return void pi(A,Ce,"32sint",1,xe);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void pi(A,Ce,"32float",1,xe);case"rg32uint":return void pi(A,Ce,"32uint",2,xe);case"rg32sint":return void pi(A,Ce,"32sint",2,xe);case"rg32float":return void pi(A,Ce,"32float",2,xe);case"rgba32uint":return void pi(A,Ce,"32uint",4,xe);case"rgba32sint":return void pi(A,Ce,"32sint",4,xe);case"rgba32float":return void pi(A,Ce,"32float",4,xe);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(T),e,t,r,o,y,a,f,this.format,c)}}(i=>{i[i.token=0]="token",i[i.keyword=1]="keyword",i[i.reserved=2]="reserved"})(Se||(Se={}));class Ae{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class ee{}Fe=ee,ee.none=new Ae("",Se.reserved,""),ee.eof=new Ae("EOF",Se.token,""),ee.reserved={asm:new Ae("asm",Se.reserved,"asm"),bf16:new Ae("bf16",Se.reserved,"bf16"),do:new Ae("do",Se.reserved,"do"),enum:new Ae("enum",Se.reserved,"enum"),f16:new Ae("f16",Se.reserved,"f16"),f64:new Ae("f64",Se.reserved,"f64"),handle:new Ae("handle",Se.reserved,"handle"),i8:new Ae("i8",Se.reserved,"i8"),i16:new Ae("i16",Se.reserved,"i16"),i64:new Ae("i64",Se.reserved,"i64"),mat:new Ae("mat",Se.reserved,"mat"),premerge:new Ae("premerge",Se.reserved,"premerge"),regardless:new Ae("regardless",Se.reserved,"regardless"),typedef:new Ae("typedef",Se.reserved,"typedef"),u8:new Ae("u8",Se.reserved,"u8"),u16:new Ae("u16",Se.reserved,"u16"),u64:new Ae("u64",Se.reserved,"u64"),unless:new Ae("unless",Se.reserved,"unless"),using:new Ae("using",Se.reserved,"using"),vec:new Ae("vec",Se.reserved,"vec"),void:new Ae("void",Se.reserved,"void")},ee.keywords={array:new Ae("array",Se.keyword,"array"),atomic:new Ae("atomic",Se.keyword,"atomic"),bool:new Ae("bool",Se.keyword,"bool"),f32:new Ae("f32",Se.keyword,"f32"),i32:new Ae("i32",Se.keyword,"i32"),mat2x2:new Ae("mat2x2",Se.keyword,"mat2x2"),mat2x3:new Ae("mat2x3",Se.keyword,"mat2x3"),mat2x4:new Ae("mat2x4",Se.keyword,"mat2x4"),mat3x2:new Ae("mat3x2",Se.keyword,"mat3x2"),mat3x3:new Ae("mat3x3",Se.keyword,"mat3x3"),mat3x4:new Ae("mat3x4",Se.keyword,"mat3x4"),mat4x2:new Ae("mat4x2",Se.keyword,"mat4x2"),mat4x3:new Ae("mat4x3",Se.keyword,"mat4x3"),mat4x4:new Ae("mat4x4",Se.keyword,"mat4x4"),ptr:new Ae("ptr",Se.keyword,"ptr"),sampler:new Ae("sampler",Se.keyword,"sampler"),sampler_comparison:new Ae("sampler_comparison",Se.keyword,"sampler_comparison"),struct:new Ae("struct",Se.keyword,"struct"),texture_1d:new Ae("texture_1d",Se.keyword,"texture_1d"),texture_2d:new Ae("texture_2d",Se.keyword,"texture_2d"),texture_2d_array:new Ae("texture_2d_array",Se.keyword,"texture_2d_array"),texture_3d:new Ae("texture_3d",Se.keyword,"texture_3d"),texture_cube:new Ae("texture_cube",Se.keyword,"texture_cube"),texture_cube_array:new Ae("texture_cube_array",Se.keyword,"texture_cube_array"),texture_multisampled_2d:new Ae("texture_multisampled_2d",Se.keyword,"texture_multisampled_2d"),texture_storage_1d:new Ae("texture_storage_1d",Se.keyword,"texture_storage_1d"),texture_storage_2d:new Ae("texture_storage_2d",Se.keyword,"texture_storage_2d"),texture_storage_2d_array:new Ae("texture_storage_2d_array",Se.keyword,"texture_storage_2d_array"),texture_storage_3d:new Ae("texture_storage_3d",Se.keyword,"texture_storage_3d"),texture_depth_2d:new Ae("texture_depth_2d",Se.keyword,"texture_depth_2d"),texture_depth_2d_array:new Ae("texture_depth_2d_array",Se.keyword,"texture_depth_2d_array"),texture_depth_cube:new Ae("texture_depth_cube",Se.keyword,"texture_depth_cube"),texture_depth_cube_array:new Ae("texture_depth_cube_array",Se.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new Ae("texture_depth_multisampled_2d",Se.keyword,"texture_depth_multisampled_2d"),texture_external:new Ae("texture_external",Se.keyword,"texture_external"),u32:new Ae("u32",Se.keyword,"u32"),vec2:new Ae("vec2",Se.keyword,"vec2"),vec3:new Ae("vec3",Se.keyword,"vec3"),vec4:new Ae("vec4",Se.keyword,"vec4"),bitcast:new Ae("bitcast",Se.keyword,"bitcast"),block:new Ae("block",Se.keyword,"block"),break:new Ae("break",Se.keyword,"break"),case:new Ae("case",Se.keyword,"case"),continue:new Ae("continue",Se.keyword,"continue"),continuing:new Ae("continuing",Se.keyword,"continuing"),default:new Ae("default",Se.keyword,"default"),diagnostic:new Ae("diagnostic",Se.keyword,"diagnostic"),discard:new Ae("discard",Se.keyword,"discard"),else:new Ae("else",Se.keyword,"else"),enable:new Ae("enable",Se.keyword,"enable"),fallthrough:new Ae("fallthrough",Se.keyword,"fallthrough"),false:new Ae("false",Se.keyword,"false"),fn:new Ae("fn",Se.keyword,"fn"),for:new Ae("for",Se.keyword,"for"),function:new Ae("function",Se.keyword,"function"),if:new Ae("if",Se.keyword,"if"),let:new Ae("let",Se.keyword,"let"),const:new Ae("const",Se.keyword,"const"),loop:new Ae("loop",Se.keyword,"loop"),while:new Ae("while",Se.keyword,"while"),private:new Ae("private",Se.keyword,"private"),read:new Ae("read",Se.keyword,"read"),read_write:new Ae("read_write",Se.keyword,"read_write"),return:new Ae("return",Se.keyword,"return"),requires:new Ae("requires",Se.keyword,"requires"),storage:new Ae("storage",Se.keyword,"storage"),switch:new Ae("switch",Se.keyword,"switch"),true:new Ae("true",Se.keyword,"true"),alias:new Ae("alias",Se.keyword,"alias"),type:new Ae("type",Se.keyword,"type"),uniform:new Ae("uniform",Se.keyword,"uniform"),var:new Ae("var",Se.keyword,"var"),override:new Ae("override",Se.keyword,"override"),workgroup:new Ae("workgroup",Se.keyword,"workgroup"),write:new Ae("write",Se.keyword,"write"),r8unorm:new Ae("r8unorm",Se.keyword,"r8unorm"),r8snorm:new Ae("r8snorm",Se.keyword,"r8snorm"),r8uint:new Ae("r8uint",Se.keyword,"r8uint"),r8sint:new Ae("r8sint",Se.keyword,"r8sint"),r16uint:new Ae("r16uint",Se.keyword,"r16uint"),r16sint:new Ae("r16sint",Se.keyword,"r16sint"),r16float:new Ae("r16float",Se.keyword,"r16float"),rg8unorm:new Ae("rg8unorm",Se.keyword,"rg8unorm"),rg8snorm:new Ae("rg8snorm",Se.keyword,"rg8snorm"),rg8uint:new Ae("rg8uint",Se.keyword,"rg8uint"),rg8sint:new Ae("rg8sint",Se.keyword,"rg8sint"),r32uint:new Ae("r32uint",Se.keyword,"r32uint"),r32sint:new Ae("r32sint",Se.keyword,"r32sint"),r32float:new Ae("r32float",Se.keyword,"r32float"),rg16uint:new Ae("rg16uint",Se.keyword,"rg16uint"),rg16sint:new Ae("rg16sint",Se.keyword,"rg16sint"),rg16float:new Ae("rg16float",Se.keyword,"rg16float"),rgba8unorm:new Ae("rgba8unorm",Se.keyword,"rgba8unorm"),rgba8unorm_srgb:new Ae("rgba8unorm_srgb",Se.keyword,"rgba8unorm_srgb"),rgba8snorm:new Ae("rgba8snorm",Se.keyword,"rgba8snorm"),rgba8uint:new Ae("rgba8uint",Se.keyword,"rgba8uint"),rgba8sint:new Ae("rgba8sint",Se.keyword,"rgba8sint"),bgra8unorm:new Ae("bgra8unorm",Se.keyword,"bgra8unorm"),bgra8unorm_srgb:new Ae("bgra8unorm_srgb",Se.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new Ae("rgb10a2unorm",Se.keyword,"rgb10a2unorm"),rg11b10float:new Ae("rg11b10float",Se.keyword,"rg11b10float"),rg32uint:new Ae("rg32uint",Se.keyword,"rg32uint"),rg32sint:new Ae("rg32sint",Se.keyword,"rg32sint"),rg32float:new Ae("rg32float",Se.keyword,"rg32float"),rgba16uint:new Ae("rgba16uint",Se.keyword,"rgba16uint"),rgba16sint:new Ae("rgba16sint",Se.keyword,"rgba16sint"),rgba16float:new Ae("rgba16float",Se.keyword,"rgba16float"),rgba32uint:new Ae("rgba32uint",Se.keyword,"rgba32uint"),rgba32sint:new Ae("rgba32sint",Se.keyword,"rgba32sint"),rgba32float:new Ae("rgba32float",Se.keyword,"rgba32float"),static_assert:new Ae("static_assert",Se.keyword,"static_assert")},ee.tokens={decimal_float_literal:new Ae("decimal_float_literal",Se.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new Ae("hex_float_literal",Se.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new Ae("int_literal",Se.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new Ae("uint_literal",Se.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new Ae("name",Se.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new Ae("ident",Se.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new Ae("and",Se.token,"&"),and_and:new Ae("and_and",Se.token,"&&"),arrow:new Ae("arrow ",Se.token,"->"),attr:new Ae("attr",Se.token,"@"),forward_slash:new Ae("forward_slash",Se.token,"/"),bang:new Ae("bang",Se.token,"!"),bracket_left:new Ae("bracket_left",Se.token,"["),bracket_right:new Ae("bracket_right",Se.token,"]"),brace_left:new Ae("brace_left",Se.token,"{"),brace_right:new Ae("brace_right",Se.token,"}"),colon:new Ae("colon",Se.token,":"),comma:new Ae("comma",Se.token,","),equal:new Ae("equal",Se.token,"="),equal_equal:new Ae("equal_equal",Se.token,"=="),not_equal:new Ae("not_equal",Se.token,"!="),greater_than:new Ae("greater_than",Se.token,">"),greater_than_equal:new Ae("greater_than_equal",Se.token,">="),shift_right:new Ae("shift_right",Se.token,">>"),less_than:new Ae("less_than",Se.token,"<"),less_than_equal:new Ae("less_than_equal",Se.token,"<="),shift_left:new Ae("shift_left",Se.token,"<<"),modulo:new Ae("modulo",Se.token,"%"),minus:new Ae("minus",Se.token,"-"),minus_minus:new Ae("minus_minus",Se.token,"--"),period:new Ae("period",Se.token,"."),plus:new Ae("plus",Se.token,"+"),plus_plus:new Ae("plus_plus",Se.token,"++"),or:new Ae("or",Se.token,"|"),or_or:new Ae("or_or",Se.token,"||"),paren_left:new Ae("paren_left",Se.token,"("),paren_right:new Ae("paren_right",Se.token,")"),semicolon:new Ae("semicolon",Se.token,";"),star:new Ae("star",Se.token,"*"),tilde:new Ae("tilde",Se.token,"~"),underscore:new Ae("underscore",Se.token,"_"),xor:new Ae("xor",Se.token,"^"),plus_equal:new Ae("plus_equal",Se.token,"+="),minus_equal:new Ae("minus_equal",Se.token,"-="),times_equal:new Ae("times_equal",Se.token,"*="),division_equal:new Ae("division_equal",Se.token,"/="),modulo_equal:new Ae("modulo_equal",Se.token,"%="),and_equal:new Ae("and_equal",Se.token,"&="),or_equal:new Ae("or_equal",Se.token,"|="),xor_equal:new Ae("xor_equal",Se.token,"^="),shift_right_equal:new Ae("shift_right_equal",Se.token,">>="),shift_left_equal:new Ae("shift_left_equal",Se.token,"<<=")},ee.simpleTokens={"@":Fe.tokens.attr,"{":Fe.tokens.brace_left,"}":Fe.tokens.brace_right,":":Fe.tokens.colon,",":Fe.tokens.comma,"(":Fe.tokens.paren_left,")":Fe.tokens.paren_right,";":Fe.tokens.semicolon},ee.literalTokens={"&":Fe.tokens.and,"&&":Fe.tokens.and_and,"->":Fe.tokens.arrow,"/":Fe.tokens.forward_slash,"!":Fe.tokens.bang,"[":Fe.tokens.bracket_left,"]":Fe.tokens.bracket_right,"=":Fe.tokens.equal,"==":Fe.tokens.equal_equal,"!=":Fe.tokens.not_equal,">":Fe.tokens.greater_than,">=":Fe.tokens.greater_than_equal,">>":Fe.tokens.shift_right,"<":Fe.tokens.less_than,"<=":Fe.tokens.less_than_equal,"<<":Fe.tokens.shift_left,"%":Fe.tokens.modulo,"-":Fe.tokens.minus,"--":Fe.tokens.minus_minus,".":Fe.tokens.period,"+":Fe.tokens.plus,"++":Fe.tokens.plus_plus,"|":Fe.tokens.or,"||":Fe.tokens.or_or,"*":Fe.tokens.star,"~":Fe.tokens.tilde,_:Fe.tokens.underscore,"^":Fe.tokens.xor,"+=":Fe.tokens.plus_equal,"-=":Fe.tokens.minus_equal,"*=":Fe.tokens.times_equal,"/=":Fe.tokens.division_equal,"%=":Fe.tokens.modulo_equal,"&=":Fe.tokens.and_equal,"|=":Fe.tokens.or_equal,"^=":Fe.tokens.xor_equal,">>=":Fe.tokens.shift_right_equal,"<<=":Fe.tokens.shift_left_equal},ee.regexTokens={decimal_float_literal:Fe.tokens.decimal_float_literal,hex_float_literal:Fe.tokens.hex_float_literal,int_literal:Fe.tokens.int_literal,uint_literal:Fe.tokens.uint_literal,ident:Fe.tokens.ident},ee.storage_class=[Fe.keywords.function,Fe.keywords.private,Fe.keywords.workgroup,Fe.keywords.uniform,Fe.keywords.storage],ee.access_mode=[Fe.keywords.read,Fe.keywords.write,Fe.keywords.read_write],ee.sampler_type=[Fe.keywords.sampler,Fe.keywords.sampler_comparison],ee.sampled_texture_type=[Fe.keywords.texture_1d,Fe.keywords.texture_2d,Fe.keywords.texture_2d_array,Fe.keywords.texture_3d,Fe.keywords.texture_cube,Fe.keywords.texture_cube_array],ee.multisampled_texture_type=[Fe.keywords.texture_multisampled_2d],ee.storage_texture_type=[Fe.keywords.texture_storage_1d,Fe.keywords.texture_storage_2d,Fe.keywords.texture_storage_2d_array,Fe.keywords.texture_storage_3d],ee.depth_texture_type=[Fe.keywords.texture_depth_2d,Fe.keywords.texture_depth_2d_array,Fe.keywords.texture_depth_cube,Fe.keywords.texture_depth_cube_array,Fe.keywords.texture_depth_multisampled_2d],ee.texture_external_type=[Fe.keywords.texture_external],ee.any_texture_type=[...Fe.sampled_texture_type,...Fe.multisampled_texture_type,...Fe.storage_texture_type,...Fe.depth_texture_type,...Fe.texture_external_type],ee.texel_format=[Fe.keywords.r8unorm,Fe.keywords.r8snorm,Fe.keywords.r8uint,Fe.keywords.r8sint,Fe.keywords.r16uint,Fe.keywords.r16sint,Fe.keywords.r16float,Fe.keywords.rg8unorm,Fe.keywords.rg8snorm,Fe.keywords.rg8uint,Fe.keywords.rg8sint,Fe.keywords.r32uint,Fe.keywords.r32sint,Fe.keywords.r32float,Fe.keywords.rg16uint,Fe.keywords.rg16sint,Fe.keywords.rg16float,Fe.keywords.rgba8unorm,Fe.keywords.rgba8unorm_srgb,Fe.keywords.rgba8snorm,Fe.keywords.rgba8uint,Fe.keywords.rgba8sint,Fe.keywords.bgra8unorm,Fe.keywords.bgra8unorm_srgb,Fe.keywords.rgb10a2unorm,Fe.keywords.rg11b10float,Fe.keywords.rg32uint,Fe.keywords.rg32sint,Fe.keywords.rg32float,Fe.keywords.rgba16uint,Fe.keywords.rgba16sint,Fe.keywords.rgba16float,Fe.keywords.rgba32uint,Fe.keywords.rgba32sint,Fe.keywords.rgba32float],ee.const_literal=[Fe.tokens.int_literal,Fe.tokens.uint_literal,Fe.tokens.decimal_float_literal,Fe.tokens.hex_float_literal,Fe.keywords.true,Fe.keywords.false],ee.literal_or_ident=[Fe.tokens.ident,Fe.tokens.int_literal,Fe.tokens.uint_literal,Fe.tokens.decimal_float_literal,Fe.tokens.hex_float_literal,Fe.tokens.name],ee.element_count_expression=[Fe.tokens.int_literal,Fe.tokens.uint_literal,Fe.tokens.ident],ee.template_types=[Fe.keywords.vec2,Fe.keywords.vec3,Fe.keywords.vec4,Fe.keywords.mat2x2,Fe.keywords.mat2x3,Fe.keywords.mat2x4,Fe.keywords.mat3x2,Fe.keywords.mat3x3,Fe.keywords.mat3x4,Fe.keywords.mat4x2,Fe.keywords.mat4x3,Fe.keywords.mat4x4,Fe.keywords.atomic,Fe.keywords.bitcast,...Fe.any_texture_type],ee.attribute_name=[Fe.tokens.ident,Fe.keywords.block,Fe.keywords.diagnostic],ee.assignment_operators=[Fe.tokens.equal,Fe.tokens.plus_equal,Fe.tokens.minus_equal,Fe.tokens.times_equal,Fe.tokens.division_equal,Fe.tokens.modulo_equal,Fe.tokens.and_equal,Fe.tokens.or_equal,Fe.tokens.xor_equal,Fe.tokens.shift_right_equal,Fe.tokens.shift_left_equal],ee.increment_operators=[Fe.tokens.plus_plus,Fe.tokens.minus_minus];class Jv{constructor(e,t,r,o,c){this.type=e,this.lexeme=t,this.line=r,this.start=o,this.end=c}toString(){return this.lexeme}isTemplateType(){return ee.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==ee.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class mI{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Jv(ee.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let f=1;for(;f>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),f--,f==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),f++)}return!0}}const t=ee.simpleTokens[e];if(t)return this._addToken(t),!0;let r=ee.none;const o=this._isAlpha(e),c=e==="_";if(this._isAlphaNumeric(e)){let f=this._peekAhead();for(;this._isAlphaNumeric(f);)e+=this._advance(),f=this._peekAhead()}if(o){const f=ee.keywords[e];if(f)return this._addToken(f),!0}if(o||c)return this._addToken(ee.tokens.ident),!0;for(;;){let f=this._findType(e);const a=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(a=="=")return this._current++,e+=a,this._addToken(ee.tokens.minus_equal),!0;if(a=="-")return this._current++,e+=a,this._addToken(ee.tokens.minus_minus),!0;const y=this._tokens.length-1;if((ee.literal_or_ident.indexOf(this._tokens[y].type)!=-1||this._tokens[y].type==ee.tokens.paren_right)&&a!=">")return this._addToken(f),!0}if(e==">"&&(a==">"||a=="=")){let y=!1,T=this._tokens.length-1;for(let A=0;A<5&&T>=0&&ee.assignment_operators.indexOf(this._tokens[T].type)===-1;++A,--T)if(this._tokens[T].type===ee.tokens.less_than){T>0&&this._tokens[T-1].isArrayOrTemplateType()&&(y=!0);break}if(y)return this._addToken(f),!0}if(f===ee.none){let y=e,T=0;const A=2;for(let M=0;M<A;++M)if(y+=this._peekAhead(M),f=this._findType(y),f!==ee.none){T=M;break}if(f===ee.none)return r!==ee.none&&(this._current--,this._addToken(r),!0);e=y,this._current+=T+1}if(r=f,this._isAtEnd())break;e+=this._advance()}return r!==ee.none&&(this._addToken(r),!0)}_findType(e){for(const r in ee.regexTokens){const o=ee.regexTokens[r];if(this._match(e,o.rule))return o}return ee.literalTokens[e]||ee.none}_match(e,t){const r=t.exec(e);return r&&r.index==0&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Jv(e,t,this._line,this._start,this._current))}}function _t(i){return Array.isArray(i)||(i==null?void 0:i.buffer)instanceof ArrayBuffer}const Wd=new Float32Array(1),_I=new Uint32Array(Wd.buffer),yI=new Uint32Array(Wd.buffer),Hd=new Int32Array(1),xI=new Float32Array(Hd.buffer),vI=new Uint32Array(Hd.buffer),Zd=new Uint32Array(1),bI=new Float32Array(Zd.buffer),wI=new Int32Array(Zd.buffer);function Qv(i,e,t){if(e===t)return i;if(e==="f32"){if(t==="i32"||t==="x32")return Wd[0]=i,_I[0];if(t==="u32")return Wd[0]=i,yI[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return Hd[0]=i,xI[0];if(t==="u32")return Hd[0]=i,vI[0]}else if(e==="u32"){if(t==="f32")return Zd[0]=i,bI[0];if(t==="i32"||t==="x32")return Zd[0]=i,wI[0]}return console.error(`Unsupported cast from ${e} to ${t}`),i}class TI{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Kf{constructor(e,t){this.align=e,this.size=t}}class vs{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new oI,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof ch&&this._functions.set(t.name,new TI(t));for(const t of e)if(t instanceof Gs){const r=this.getTypeInfo(t,null);r instanceof Xo&&this.structs.push(r)}for(const t of e)if(t instanceof J_)this.aliases.push(this._getAliasInfo(t));else if(t instanceof Y_){const r=t,o=this._getAttributeNum(r.attributes,"id",0),c=r.type!=null?this.getTypeInfo(r.type,r.attributes):null;this.overrides.push(new rI(r.name,c,r.attributes,o))}else if(this._isUniformVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),f=this.getTypeInfo(r.type,r.attributes),a=new Yf(r.name,f,o,c,r.attributes,$o.Uniform,r.access);a.access||(a.access="read"),this.uniforms.push(a)}else if(this._isStorageVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),f=this.getTypeInfo(r.type,r.attributes),a=this._isStorageTexture(f),y=new Yf(r.name,f,o,c,r.attributes,a?$o.StorageTexture:$o.Storage,r.access);y.access||(y.access="read"),this.storage.push(y)}else if(this._isTextureVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),f=this.getTypeInfo(r.type,r.attributes),a=this._isStorageTexture(f),y=new Yf(r.name,f,o,c,r.attributes,a?$o.StorageTexture:$o.Texture,r.access);y.access||(y.access="read"),a?this.storage.push(y):this.textures.push(y)}else if(this._isSamplerVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),f=this.getTypeInfo(r.type,r.attributes),a=new Yf(r.name,f,o,c,r.attributes,$o.Sampler,r.access);this.samplers.push(a)}else if(t instanceof ch){const r=this._getAttribute(t,"vertex"),o=this._getAttribute(t,"fragment"),c=this._getAttribute(t,"compute"),f=r||o||c,a=new sI(t.name,f==null?void 0:f.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,f&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!f),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[f.name].push(a)),a.arguments=t.args.map(y=>new nI(y.name,this.getTypeInfo(y.type,y.attributes),y.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(r=>{var o,c,f;if(r instanceof _1){if(r.value)if(_t(r.value))for(const a of r.value)for(const y of this.overrides)a===y.name&&((o=t.info)===null||o===void 0||o.overrides.push(y));else for(const a of this.overrides)r.value===a.name&&((c=t.info)===null||c===void 0||c.overrides.push(a))}else if(r instanceof fn)for(const a of this.overrides)r.name===a.name&&((f=t.info)===null||f===void 0||f.overrides.push(a))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const o of e.calls){const c=(r=this._functions.get(o.name))===null||r===void 0?void 0:r.info;c&&t.add(c)}}findResource(e,t,r){if(r){for(const o of this.entry.compute)if(o.name===r){for(const c of o.resources)if(c.group==e&&c.binding==t)return c}for(const o of this.entry.vertex)if(o.name===r){for(const c of o.resources)if(c.group==e&&c.binding==t)return c}for(const o of this.entry.fragment)if(o.name===r){for(const c of o.resources)if(c.group==e&&c.binding==t)return c}}for(const o of this.uniforms)if(o.group==e&&o.binding==t)return o;for(const o of this.storage)if(o.group==e&&o.binding==t)return o;for(const o of this.textures)if(o.group==e&&o.binding==t)return o;for(const o of this.samplers)if(o.group==e&&o.binding==t)return o;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],o=this,c=[];return e.search(f=>{if(f instanceof jd)c.push({});else if(f instanceof $d)c.pop();else if(f instanceof Ks){const a=f;t&&a.type!==null&&this._markStructsFromAST(a.type),c.length>0&&(c[c.length-1][a.name]=a)}else if(f instanceof ys){const a=f;t&&a.type!==null&&this._markStructsFromAST(a.type)}else if(f instanceof th){const a=f;t&&a.type!==null&&this._markStructsFromAST(a.type),c.length>0&&(c[c.length-1][a.name]=a)}else if(f instanceof fn){const a=f;if(c.length>0&&c[c.length-1][a.name])return;const y=o._findResource(a.name);y&&r.push(y)}else if(f instanceof Q_){const a=f,y=o._functions.get(a.name);y&&(t&&(y.inUse=!0),e.calls.add(y.node),y.resources===null&&(y.resources=o._findResources(y.node,t)),r.push(...y.resources))}else if(f instanceof K_){const a=f,y=o._functions.get(a.name);y&&(t&&(y.inUse=!0),e.calls.add(y.node),y.resources===null&&(y.resources=o._findResources(y.node,t)),r.push(...y.resources))}}),[...new Map(r.map(f=>[f.name,f])).values()]}getBindGroups(){const e=[];function t(r,o){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),o>=e[r].length&&(e[r].length=o+1)}for(const r of this.uniforms)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.storage)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.textures)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.samplers)t(r.group,r.binding),e[r.group][r.binding]=r;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Gs)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);r!==null&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Gs)this._getStructOutputs(r.type,t);else{const o=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(o!==null){const c=this.getTypeInfo(r.type,r.type.attributes),f=this._parseInt(o.value),a=new Xv(r.name,c,o.name,f);t.push(a)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this.getTypeInfo(e,e.attributes),o=this._parseInt(t.value);return new Xv("",r,t.name,o)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const r of e)if(r.type instanceof Gs)this._getStructInputs(r.type,t);else{const o=this._getInputInfo(r);o!==null&&t.push(o)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Gs)this._getStructInputs(r.type,t);else{const o=this._getInputInfo(r);o!==null&&t.push(o)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getAttribute(e,"interpolation"),o=this.getTypeInfo(e.type,e.attributes),c=this._parseInt(t.value),f=new iI(e.name,o,t.name,c);return r!==null&&(f.interpolation=this._parseString(r.value)),f}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new tI(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof ih){const o=e,c=o.format?this.getTypeInfo(o.format,o.attributes):null,f=new Jo(o.name,t);return f.format=c,f.count=o.count,this._types.set(e,f),this._updateTypeInfo(f),f}if(e instanceof Gs){const o=e,c=new Xo(o.name,t);c.startLine=o.startLine,c.endLine=o.endLine;for(const f of o.members){const a=this.getTypeInfo(f.type,f.attributes);c.members.push(new Zv(f.name,a,f.attributes))}return this._types.set(e,c),this._updateTypeInfo(c),c}if(e instanceof Hu){const o=e,c=o.format instanceof it,f=o.format?c?this.getTypeInfo(o.format,null):new Tn(o.format,null):null,a=new Za(o.name,f,t,o.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof Me){const o=e,c=o.format?this.getTypeInfo(o.format,null):null,f=new Za(o.name,c,t,o.access);return this._types.set(e,f),this._updateTypeInfo(f),f}const r=new Tn(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r,o;const c=this._getTypeSize(e);if(e.size=(t=c==null?void 0:c.size)!==null&&t!==void 0?t:0,e instanceof Jo&&e.format){const f=this._getTypeSize(e.format);e.stride=Math.max((r=f==null?void 0:f.size)!==null&&r!==void 0?r:0,(o=f==null?void 0:f.align)!==null&&o!==void 0?o:0),this._updateTypeInfo(e.format)}e instanceof Xo&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,o=0,c=0,f=0;for(let a=0,y=e.members.length;a<y;++a){const T=e.members[a],A=this._getTypeSize(T);if(!A)continue;(t=this._getAlias(T.type.name))!==null&&t!==void 0||T.type;const M=A.align,F=A.size;r=this._roundUp(M,r+o),o=F,c=r,f=Math.max(f,M),T.offset=r,T.size=F,this._updateTypeInfo(T.type)}e.size=this._roundUp(f,c+o),e.align=f}_getTypeSize(e){var t,r;if(e==null)return null;const o=this._getAttributeNum(e.attributes,"size",0),c=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Zv&&(e=e.type),e instanceof Tn){const f=this._getAlias(e.name);f!==null&&(e=f)}{const f=vs._typeInfo[e.name];if(f!==void 0){const a=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new Kf(Math.max(c,f.align/a),Math.max(o,f.size/a))}}{const f=vs._typeInfo[e.name.substring(0,e.name.length-1)];if(f){const a=e.name[e.name.length-1]==="h"?2:1;return new Kf(Math.max(c,f.align/a),Math.max(o,f.size/a))}}if(e instanceof Jo){let f=e,a=8,y=8;const T=this._getTypeSize(f.format);return T!==null&&(y=T.size,a=T.align),y=f.count*this._getAttributeNum((r=e==null?void 0:e.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(a,y)),o&&(y=o),new Kf(Math.max(c,a),Math.max(o,y))}if(e instanceof Xo){let f=0,a=0,y=0,T=0,A=0;for(const M of e.members){const F=this._getTypeSize(M.type);F!==null&&(f=Math.max(F.align,f),y=this._roundUp(F.align,y+T),T=F.size,A=y)}return a=this._roundUp(f,A+T),new Kf(Math.max(c,f),Math.max(o,a))}return null}_isUniformVar(e){return e instanceof Ks&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Ks&&e.storage=="storage"}_isTextureVar(e){return e instanceof Ks&&e.type!==null&&vs._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Ks&&e.type!==null&&vs._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const o=r.attributes;for(let c of o)if(c.name==t)return c;return null}_getAttributeNum(e,t,r){if(e===null)return r;for(let o of e)if(o.name==t){let c=o!==null&&o.value!==null?o.value:r;return c instanceof Array&&(c=c[0]),typeof c=="number"?c:typeof c=="string"?parseInt(c):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}vs._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},vs._textureTypes=ee.any_texture_type.map(i=>i.name),vs._samplerTypes=ee.sampler_type.map(i=>i.name);class ey{constructor(e,t,r){this.name=e,this.value=t,this.node=r}clone(){return new ey(this.name,this.value,this.node)}}class ty{constructor(e){this.name=e.name,this.node=e}clone(){return new ty(this.node)}}class iy{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,r){this.variables.set(e,new ey(e,t,r??null))}setVariable(e,t,r){const o=this.getVariable(e);o!==null?o.value=t:this.createVariable(e,t,r)}getVariableValue(e){var t;const r=this.getVariable(e);return(t=r==null?void 0:r.value)!==null&&t!==void 0?t:null}clone(){return new iy(this)}}class SI{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class AI{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const r=this.exec.evalExpression(e.args[0],t);let o=!0;if(r instanceof ne)return r.data.forEach(c=>{c||(o=!1)}),new Te(o?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne){const o=r.data.some(c=>c);return new Te(o?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const r=this.exec.evalExpression(e.args[2],t);if(!(r instanceof Te))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return r.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.evalExpression(r,t);if(o instanceof qi&&o.typeInfo.size===0){const c=o.typeInfo,f=o.buffer.byteLength/c.stride;return new Te(f,this.getTypeInfo("u32"))}return new Te(o.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.abs(c)),r.typeInfo);const o=r;return new Te(Math.abs(o.value),o.typeInfo)}Acos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.acos(c)),r.typeInfo);const o=r;return new Te(Math.acos(o.value),r.typeInfo)}Acosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.acosh(c)),r.typeInfo);const o=r;return new Te(Math.acosh(o.value),r.typeInfo)}Asin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.asin(c)),r.typeInfo);const o=r;return new Te(Math.asin(o.value),r.typeInfo)}Asinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.asinh(c)),r.typeInfo);const o=r;return new Te(Math.asinh(o.value),r.typeInfo)}Atan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.atan(c)),r.typeInfo);const o=r;return new Te(Math.atan(o.value),r.typeInfo)}Atanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.atanh(c)),r.typeInfo);const o=r;return new Te(Math.atanh(o.value),r.typeInfo)}Atan2(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne)return new ne(r.data.map((a,y)=>Math.atan2(a,o.data[y])),r.typeInfo);const c=r,f=o;return new Te(Math.atan2(c.value,f.value),r.typeInfo)}Ceil(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.ceil(c)),r.typeInfo);const o=r;return new Te(Math.ceil(o.value),r.typeInfo)}_clamp(e,t,r){return Math.min(Math.max(e,t),r)}Clamp(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&o instanceof ne&&c instanceof ne)return new ne(r.data.map((T,A)=>this._clamp(T,o.data[A],c.data[A])),r.typeInfo);const f=r,a=o,y=c;return new Te(this._clamp(f.value,a.value,y.value),r.typeInfo)}Cos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.cos(c)),r.typeInfo);const o=r;return new Te(Math.cos(o.value),r.typeInfo)}Cosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.cosh(c)),r.typeInfo);const o=r;return new Te(Math.cos(o.value),r.typeInfo)}CountLeadingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.clz32(c)),r.typeInfo);const o=r;return new Te(Math.clz32(o.value),r.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>this._countOneBits(c)),r.typeInfo);const o=r;return new Te(this._countOneBits(o.value),r.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>this._countTrailingZeros(c)),r.typeInfo);const o=r;return new Te(this._countTrailingZeros(o.value),r.typeInfo)}Cross(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne){if(r.data.length!==3||o.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const c=r.data,f=o.data;return new ne([c[1]*f[2]-f[1]*c[2],c[2]*f[0]-f[2]*c[0],c[0]*f[1]-f[0]*c[1]],r.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const r=this.exec.evalExpression(e.args[0],t),o=180/Math.PI;return r instanceof ne?new ne(r.data.map(c=>c*o),r.typeInfo):new Te(r.value*o,this.getTypeInfo("f32"))}Determinant(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof Nt){const o=r.data,c=r.typeInfo.getTypeName(),f=c.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(c==="mat2x2"||c==="mat2x2f"||c==="mat2x2h")return new Te(o[0]*o[3]-o[1]*o[2],f);if(c==="mat2x3"||c==="mat2x3f"||c==="mat2x3h")return new Te(o[0]*(o[4]*o[8]-o[5]*o[7])-o[1]*(o[3]*o[8]-o[5]*o[6])+o[2]*(o[3]*o[7]-o[4]*o[6]),f);if(c==="mat2x4"||c==="mat2x4f"||c==="mat2x4h")console.error(`TODO: Determinant for ${c}`);else if(c==="mat3x2"||c==="mat3x2f"||c==="mat3x2h")console.error(`TODO: Determinant for ${c}`);else{if(c==="mat3x3"||c==="mat3x3f"||c==="mat3x3h")return new Te(o[0]*(o[4]*o[8]-o[5]*o[7])-o[1]*(o[3]*o[8]-o[5]*o[6])+o[2]*(o[3]*o[7]-o[4]*o[6]),f);c==="mat3x4"||c==="mat3x4f"||c==="mat3x4h"||c==="mat4x2"||c==="mat4x2f"||c==="mat4x2h"||c==="mat4x3"||c==="mat4x3f"||c==="mat4x3h"?console.error(`TODO: Determinant for ${c}`):c!=="mat4x4"&&c!=="mat4x4f"&&c!=="mat4x4h"||console.error(`TODO: Determinant for ${c}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne){let a=0;for(let y=0;y<r.data.length;++y)a+=(r.data[y]-o.data[y])*(r.data[y]-o.data[y]);return new Te(Math.sqrt(a),this.getTypeInfo("f32"))}const c=r,f=o;return new Te(Math.abs(c.value-f.value),r.typeInfo)}_dot(e,t){let r=0;for(let o=0;o<e.length;++o)r+=t[o]*e[o];return r}Dot(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);return r instanceof ne&&o instanceof ne?new Te(this._dot(r.data,o.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.exp(c)),r.typeInfo);const o=r;return new Te(Math.exp(o.value),r.typeInfo)}Exp2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.pow(2,c)),r.typeInfo);const o=r;return new Te(Math.pow(2,o.value),r.typeInfo)}ExtractBits(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(o.typeInfo.name!=="u32"&&o.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(c.typeInfo.name!=="u32"&&c.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const f=o.value,a=c.value;if(r instanceof ne)return new ne(r.data.map(T=>T>>f&(1<<a)-1),r.typeInfo);if(r.typeInfo.name!=="i32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const y=r.value;return new Te(y>>f&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&o instanceof ne&&c instanceof ne){const f=this._dot(o.data,c.data);return new ne(f<0?Array.from(r.data):r.data.map(a=>-a),r.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>this._firstLeadingBit(c)),r.typeInfo);const o=r;return new Te(this._firstLeadingBit(o.value),r.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>this._firstTrailingBit(c)),r.typeInfo);const o=r;return new Te(this._firstTrailingBit(o.value),r.typeInfo)}Floor(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.floor(c)),r.typeInfo);const o=r;return new Te(Math.floor(o.value),r.typeInfo)}Fma(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&o instanceof ne&&c instanceof ne)return r.data.length!==o.data.length||r.data.length!==c.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new ne(r.data.map((T,A)=>T*o.data[A]+c.data[A]),r.typeInfo);const f=r,a=o,y=c;return new Te(f.value*a.value+y.value,f.typeInfo)}Fract(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>c-Math.floor(c)),r.typeInfo);const o=r;return new Te(o.value-Math.floor(o.value),r.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t),f=this.exec.evalExpression(e.args[3],t);if(c.typeInfo.name!=="u32"&&c.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const a=c.value,y=(1<<f.value)-1<<a,T=~y;if(r instanceof ne&&o instanceof ne)return new ne(r.data.map((F,L)=>F&T|o.data[L]<<a&y),r.typeInfo);const A=r.value,M=o.value;return new Te(A&T|M<<a&y,r.typeInfo)}InverseSqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>1/Math.sqrt(c)),r.typeInfo);const o=r;return new Te(1/Math.sqrt(o.value),r.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne){let c=0;return r.data.forEach(f=>{c+=f*f}),new Te(Math.sqrt(c),this.getTypeInfo("f32"))}const o=r;return new Te(Math.abs(o.value),r.typeInfo)}Log(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.log(c)),r.typeInfo);const o=r;return new Te(Math.log(o.value),r.typeInfo)}Log2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.log2(c)),r.typeInfo);const o=r;return new Te(Math.log2(o.value),r.typeInfo)}Max(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne)return new ne(r.data.map((a,y)=>Math.max(a,o.data[y])),r.typeInfo);const c=r,f=o;return new Te(Math.max(c.value,f.value),r.typeInfo)}Min(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne)return new ne(r.data.map((a,y)=>Math.min(a,o.data[y])),r.typeInfo);const c=r,f=o;return new Te(Math.min(c.value,f.value),r.typeInfo)}Mix(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&o instanceof ne&&c instanceof ne)return new ne(r.data.map((y,T)=>r.data[T]*(1-c.data[T])+o.data[T]*c.data[T]),r.typeInfo);const f=o,a=c;return new Te(r.value*(1-a.value)+f.value*a.value,r.typeInfo)}Modf(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne)return new ne(r.data.map((f,a)=>f%o.data[a]),r.typeInfo);const c=o;return new Te(r.value%c.value,r.typeInfo)}Normalize(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne){const o=this.Length(e,t).value;return new ne(r.data.map(c=>c/o),r.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne)return new ne(r.data.map((a,y)=>Math.pow(a,o.data[y])),r.typeInfo);const c=r,f=o;return new Te(Math.pow(c.value,f.value),r.typeInfo)}QuantizeToF16(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof ne?new ne(r.data.map(o=>o),r.typeInfo):new Te(r.value,r.typeInfo)}Radians(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof ne?new ne(r.data.map(o=>o*Math.PI/180),r.typeInfo):new Te(r.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&o instanceof ne){const c=this._dot(r.data,o.data);return new ne(r.data.map((f,a)=>f-2*c*o.data[a]),r.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&o instanceof ne&&c instanceof Te){const f=this._dot(o.data,r.data);return new ne(r.data.map((a,y)=>{const T=1-c.value*c.value*(1-f*f);if(T<0)return 0;const A=Math.sqrt(T);return c.value*a-(c.value*f+A)*o.data[y]}),r.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.round(c)),r.typeInfo);const o=r;return new Te(Math.round(o.value),r.typeInfo)}Saturate(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.min(Math.max(c,0),1)),r.typeInfo);const o=r;return new Te(Math.min(Math.max(o.value,0),1),r.typeInfo)}Sign(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.sign(c)),r.typeInfo);const o=r;return new Te(Math.sign(o.value),r.typeInfo)}Sin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.sin(c)),r.typeInfo);const o=r;return new Te(Math.sin(o.value),r.typeInfo)}Sinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.sinh(c)),r.typeInfo);const o=r;return new Te(Math.sinh(o.value),r.typeInfo)}_smoothstep(e,t,r){const o=Math.min(Math.max((r-e)/(t-e),0),1);return o*o*(3-2*o)}SmoothStep(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(c instanceof ne&&r instanceof ne&&o instanceof ne)return new ne(c.data.map((T,A)=>this._smoothstep(r.data[A],o.data[A],T)),c.typeInfo);const f=r,a=o,y=c;return new Te(this._smoothstep(f.value,a.value,y.value),c.typeInfo)}Sqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.sqrt(c)),r.typeInfo);const o=r;return new Te(Math.sqrt(o.value),r.typeInfo)}Step(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(o instanceof ne&&r instanceof ne)return new ne(o.data.map((f,a)=>f<r.data[a]?0:1),o.typeInfo);const c=r;return new Te(o.value<c.value?0:1,c.typeInfo)}Tan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.tan(c)),r.typeInfo);const o=r;return new Te(Math.tan(o.value),r.typeInfo)}Tanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.tanh(c)),r.typeInfo);const o=r;return new Te(Math.tanh(o.value),r.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const r=this.exec.evalExpression(e.args[0],t);if(!(r instanceof Nt))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const o=this._getTransposeType(r.typeInfo);if(r.typeInfo.name==="mat2x2"||r.typeInfo.name==="mat2x2f"||r.typeInfo.name==="mat2x2h"){const c=r.data;return new Nt([c[0],c[2],c[1],c[3]],o)}if(r.typeInfo.name==="mat2x3"||r.typeInfo.name==="mat2x3f"||r.typeInfo.name==="mat2x3h"){const c=r.data;return new Nt([c[0],c[3],c[6],c[1],c[4],c[7]],o)}if(r.typeInfo.name==="mat2x4"||r.typeInfo.name==="mat2x4f"||r.typeInfo.name==="mat2x4h"){const c=r.data;return new Nt([c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13]],o)}if(r.typeInfo.name==="mat3x2"||r.typeInfo.name==="mat3x2f"||r.typeInfo.name==="mat3x2h"){const c=r.data;return new Nt([c[0],c[3],c[1],c[4],c[2],c[5]],o)}if(r.typeInfo.name==="mat3x3"||r.typeInfo.name==="mat3x3f"||r.typeInfo.name==="mat3x3h"){const c=r.data;return new Nt([c[0],c[3],c[6],c[1],c[4],c[7],c[2],c[5],c[8]],o)}if(r.typeInfo.name==="mat3x4"||r.typeInfo.name==="mat3x4f"||r.typeInfo.name==="mat3x4h"){const c=r.data;return new Nt([c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14]],o)}if(r.typeInfo.name==="mat4x2"||r.typeInfo.name==="mat4x2f"||r.typeInfo.name==="mat4x2h"){const c=r.data;return new Nt([c[0],c[4],c[1],c[5],c[2],c[6]],o)}if(r.typeInfo.name==="mat4x3"||r.typeInfo.name==="mat4x3f"||r.typeInfo.name==="mat4x3h"){const c=r.data;return new Nt([c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10]],o)}if(r.typeInfo.name==="mat4x4"||r.typeInfo.name==="mat4x4f"||r.typeInfo.name==="mat4x4h"){const c=r.data;return new Nt([c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14],c[3],c[7],c[11],c[15]],o)}return console.error(`Invalid matrix type ${r.typeInfo.name}`),null}Trunc(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(c=>Math.trunc(c)),r.typeInfo);const o=r;return new Te(Math.trunc(o.value),r.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const r=e.args[0],o=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(r instanceof fn){const c=r.name,f=t.getVariableValue(c);if(f instanceof Ys){if(o<0||o>=f.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const a=f.getMipLevelSize(o),y=f.dimension;return y==="1d"?new Te(a[0],this.getTypeInfo("u32")):y==="3d"?new ne(a,this.getTypeInfo("vec3u")):y==="2d"?new ne(a.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${y} not found. Line ${e.line}`),null)}return console.error(`Texture ${c} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const r=e.args[0],o=this.exec.evalExpression(e.args[1],t),c=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(o instanceof ne)||o.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(r instanceof fn){const f=r.name,a=t.getVariableValue(f);if(a instanceof Ys){const y=Math.floor(o.data[0]),T=Math.floor(o.data[1]);if(y<0||y>=a.width||T<0||T>=a.height)return console.error(`Texture ${f} out of bounds. Line ${e.line}`),null;const A=a.getPixel(y,T,0,c);return A===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new ne(A,this.getTypeInfo("vec4f"))}return console.error(`Texture ${f} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const r=e.args[0];if(r instanceof fn){const o=r.name,c=t.getVariableValue(o);return c instanceof Ys?new Te(c.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${o} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const r=e.args[0];if(r instanceof fn){const o=r.name,c=t.getVariableValue(o);return c instanceof Ys?new Te(c.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${o} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const r=e.args[0];if(r instanceof fn){const o=r.name,c=t.getVariableValue(o);return c instanceof Ys?new Te(c.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${o} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const r=e.args[0],o=this.exec.evalExpression(e.args[1],t),c=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,f=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(f.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(o instanceof ne)||o.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(r instanceof fn){const a=r.name,y=t.getVariableValue(a);if(y instanceof Ys){const T=y.getMipLevelSize(0),A=Math.floor(o.data[0]),M=Math.floor(o.data[1]);return A<0||A>=T[0]||M<0||M>=T[1]?(console.error(`Texture ${a} out of bounds. Line ${e.line}`),null):(y.setPixel(A,M,0,c,Array.from(f)),null)}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t);return t.getVariable(o).value.getSubData(this.exec,r.postfix,t)}AtomicStore(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t);return y instanceof Te&&a instanceof Te&&(y.value=a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),null}AtomicAdd(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value+=a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicSub(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value-=a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicMax(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value=Math.max(y.value,a.value)),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicMin(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value=Math.min(y.value,a.value)),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicAnd(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value=y.value&a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicOr(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value=y.value|a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicXor(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value=y.value^a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicExchange(e,t){let r=e.args[0];r instanceof ar&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let f=e.args[1];const a=this.exec.evalExpression(f,t),y=c.value.getSubData(this.exec,r.postfix,t),T=new Te(y.value,y.typeInfo);return y instanceof Te&&a instanceof Te&&(y.value=a.value),c.value instanceof qi&&c.value.setDataValue(this.exec,y,r.postfix,t),T}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const dm={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Wr={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class Br extends SI{constructor(e,t){var r;super(),this.ast=e??[],this.reflection=new vs,this.reflection.updateAST(this.ast),this.context=(r=t==null?void 0:t.clone())!==null&&r!==void 0?r:new iy,this.builtins=new AI(this),this.typeInfo={bool:this.getTypeInfo(it.bool),i32:this.getTypeInfo(it.i32),u32:this.getTypeInfo(it.u32),f32:this.getTypeInfo(it.f32),f16:this.getTypeInfo(it.f16),vec2f:this.getTypeInfo(Me.vec2f),vec2u:this.getTypeInfo(Me.vec2u),vec2i:this.getTypeInfo(Me.vec2i),vec2h:this.getTypeInfo(Me.vec2h),vec3f:this.getTypeInfo(Me.vec3f),vec3u:this.getTypeInfo(Me.vec3u),vec3i:this.getTypeInfo(Me.vec3i),vec3h:this.getTypeInfo(Me.vec3h),vec4f:this.getTypeInfo(Me.vec4f),vec4u:this.getTypeInfo(Me.vec4u),vec4i:this.getTypeInfo(Me.vec4i),vec4h:this.getTypeInfo(Me.vec4h),mat2x2f:this.getTypeInfo(Me.mat2x2f),mat2x3f:this.getTypeInfo(Me.mat2x3f),mat2x4f:this.getTypeInfo(Me.mat2x4f),mat3x2f:this.getTypeInfo(Me.mat3x2f),mat3x3f:this.getTypeInfo(Me.mat3x3f),mat3x4f:this.getTypeInfo(Me.mat3x4f),mat4x2f:this.getTypeInfo(Me.mat4x2f),mat4x3f:this.getTypeInfo(Me.mat4x3f),mat4x4f:this.getTypeInfo(Me.mat4x4f)}}getVariableValue(e){var t,r;const o=(r=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&r!==void 0?r:null;if(o===null)return null;if(o instanceof Te)return o.value;if(o instanceof ne||o instanceof Nt)return Array.from(o.data);if(o instanceof qi&&o.typeInfo instanceof Jo){if(o.typeInfo.format.name==="u32")return Array.from(new Uint32Array(o.buffer,o.offset,o.typeInfo.count));if(o.typeInfo.format.name==="i32")return Array.from(new Int32Array(o.buffer,o.offset,o.typeInfo.count));if(o.typeInfo.format.name==="f32")return Array.from(new Float32Array(o.buffer,o.offset,o.typeInfo.count))}return console.error(`Unsupported return variable type ${o.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,r,o){const c=this.context.clone();(o=o??{}).constants&&this._setOverrides(o.constants,c),this._execStatements(this.ast,c);const f=c.getFunction(e);if(!f)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const a=t[0],y=t[1],T=t[2],A=this.getTypeInfo("vec3u");c.setVariable("@num_workgroups",new ne(t,A));for(const M in r)for(const F in r[M]){const L=r[M][F];c.variables.forEach(Y=>{var ae;const pe=Y.node;if(pe!=null&&pe.attributes){let Ee=null,Be=null;for(const xe of pe.attributes)xe.name==="binding"?Ee=xe.value:xe.name==="group"&&(Be=xe.value);if(F==Ee&&M==Be)if(L.texture!==void 0&&L.descriptor!==void 0){const xe=new Ys(L.texture,this.getTypeInfo(pe.type),L.descriptor,(ae=L.texture.view)!==null&&ae!==void 0?ae:null);Y.value=xe}else L.uniform!==void 0?Y.value=new qi(L.uniform,this.getTypeInfo(pe.type)):Y.value=new qi(L,this.getTypeInfo(pe.type))}})}for(let M=0;M<T;++M)for(let F=0;F<y;++F)for(let L=0;L<a;++L)c.setVariable("@workgroup_id",new ne([L,F,M],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(f,[L,F,M],c)}execStatement(e,t){if(e instanceof a1)return this.evalExpression(e.value,t);if(e instanceof c1){if(e.condition){const r=this.evalExpression(e.condition,t);if(!(r instanceof Te))throw new Error("Invalid break-if condition");if(!r.value)return null}return Br._breakObj}if(e instanceof u1)return Br._continueObj;if(e instanceof th)this._let(e,t);else if(e instanceof Ks)this._var(e,t);else if(e instanceof pd)this._const(e,t);else if(e instanceof ch)this._function(e,t);else{if(e instanceof o1)return this._if(e,t);if(e instanceof s1)return this._switch(e,t);if(e instanceof t1)return this._for(e,t);if(e instanceof e1)return this._while(e,t);if(e instanceof n1)return this._loop(e,t);if(e instanceof n_){const r=t.clone();return r.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,r)}if(e instanceof r1)this._assign(e,t);else if(e instanceof i1)this._increment(e,t);else{if(e instanceof Gs)return null;if(e instanceof Y_){const r=e.name;t.getVariable(r)===null&&t.setVariable(r,new Te(0,this.getTypeInfo("u32")))}else if(e instanceof K_)this._call(e,t);else{if(e instanceof l1||e instanceof J_)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof Hn?this._evalBinaryOp(e,t):e instanceof pr?this._evalLiteral(e,t):e instanceof fn?this._evalVariable(e,t):e instanceof Q_?this._evalCall(e,t):e instanceof ys?this._evalCreate(e,t):e instanceof h1?this._evalConst(e,t):e instanceof f1?this._evalBitcast(e,t):e instanceof ar?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof it){const o=this.reflection.getTypeInfo(e);if(o!==null)return o}let r=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return r!==null||(r=this.reflection.getTypeInfoByName(e)),r}_setOverrides(e,t){for(const r in e){const o=e[r],c=this.reflection.getOverrideInfo(r);c!==null?(c.type===null&&(c.type=this.getTypeInfo("u32")),c.type.name==="u32"||c.type.name==="i32"||c.type.name==="f32"||c.type.name==="f16"?t.setVariable(r,new Te(o,c.type)):c.type.name==="bool"?t.setVariable(r,new Te(o?1:0,c.type)):c.type.name==="vec2"||c.type.name==="vec3"||c.type.name==="vec4"||c.type.name==="vec2f"||c.type.name==="vec3f"||c.type.name==="vec4f"||c.type.name==="vec2i"||c.type.name==="vec3i"||c.type.name==="vec4i"||c.type.name==="vec2u"||c.type.name==="vec3u"||c.type.name==="vec4u"||c.type.name==="vec2h"||c.type.name==="vec3h"||c.type.name==="vec4h"?t.setVariable(r,new ne(o,c.type)):console.error(`Invalid constant type for ${r}`)):console.error(`Override ${r} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,r){const o=[1,1,1];for(const A of e.node.attributes)if(A.name==="workgroup_size"){if(A.value.length>0){const M=r.getVariableValue(A.value[0]);o[0]=M instanceof Te?M.value:parseInt(A.value[0])}if(A.value.length>1){const M=r.getVariableValue(A.value[1]);o[1]=M instanceof Te?M.value:parseInt(A.value[1])}if(A.value.length>2){const M=r.getVariableValue(A.value[2]);o[2]=M instanceof Te?M.value:parseInt(A.value[2])}}const c=this.getTypeInfo("vec3u"),f=this.getTypeInfo("u32");r.setVariable("@workgroup_size",new ne(o,c));const a=o[0],y=o[1],T=o[2];for(let A=0,M=0;A<T;++A)for(let F=0;F<y;++F)for(let L=0;L<a;++L,++M){const Y=[L,F,A],ae=[L+t[0]*o[0],F+t[1]*o[1],A+t[2]*o[2]];r.setVariable("@local_invocation_id",new ne(Y,c)),r.setVariable("@global_invocation_id",new ne(ae,c)),r.setVariable("@local_invocation_index",new Te(M,f)),this._dispatchExec(e,r)}}_dispatchExec(e,t){for(const r of e.node.args)for(const o of r.attributes)if(o.name==="builtin"){const c=`@${o.value}`,f=t.getVariable(c);f!==void 0&&t.variables.set(r.name,f)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof ar;)e=e.right;return e instanceof fn?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const r of e){if(r instanceof Array){const c=t.clone(),f=this._execStatements(r,c);if(f)return f;continue}const o=this.execStatement(r,t);if(o)return o}return null}_call(e,t){const r=t.clone();r.currentFunctionName=e.name;const o=t.getFunction(e.name);if(o){for(let c=0;c<o.node.args.length;++c){const f=o.node.args[c],a=this.evalExpression(e.args[c],r);r.setVariable(f.name,a,f)}this._execStatements(o.node.body,r)}else e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const r=this.getVariableName(e.variable,t),o=t.getVariable(r);o?e.operator==="++"?o.value instanceof Te?o.value.value++:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):e.operator==="--"?o.value instanceof Te?o.value.value--:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${r} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof fn){const r=this.getVariableName(e,t),o=t.getVariable(r);return o===null?(console.error(`Variable ${r} not found. Line ${e.line}`),null):o.value.getSubData(this,e.postfix,t)}if(e instanceof ar){if(e.operator==="*"){const r=this._getVariableData(e.right,t);return r instanceof Jl?r.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const r=this._getVariableData(e.right,t);return new Jl(r)}}return null}_assign(e,t){let r=null,o="<var>",c=null;if(e.variable instanceof ar){const y=this._getVariableData(e.variable,t),T=this.evalExpression(e.value,t),A=e.operator;if(A==="="){if(y instanceof Te||y instanceof ne||y instanceof Nt){if(T instanceof Te||T instanceof ne||T instanceof Nt&&y.data.length===T.data.length)return void y.data.set(T.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(y instanceof qi&&T instanceof qi&&y.buffer.byteLength-y.offset>=T.buffer.byteLength-T.offset)return void(y.buffer.byteLength%4==0?new Uint32Array(y.buffer,y.offset,y.typeInfo.size/4).set(new Uint32Array(T.buffer,T.offset,T.typeInfo.size/4)):new Uint8Array(y.buffer,y.offset,y.typeInfo.size).set(new Uint8Array(T.buffer,T.offset,T.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(A==="+=")return y instanceof Te||y instanceof ne||y instanceof Nt?T instanceof Te||T instanceof ne||T instanceof Nt?void y.data.set(T.data.map((M,F)=>y.data[F]+M)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(A==="-=")return(y instanceof Te||y instanceof ne||y instanceof Nt)&&(T instanceof Te||T instanceof ne||T instanceof Nt)?void y.data.set(T.data.map((M,F)=>y.data[F]-M)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof ar){if(e.variable.operator==="*"){o=this.getVariableName(e.variable.right,t);const y=t.getVariable(o);if(!(y&&y.value instanceof Jl))return void console.error(`Variable ${o} is not a pointer. Line ${e.line}`);r=y.value.reference;let T=e.variable.postfix;if(!T){let A=e.variable.right;for(;A instanceof ar;){if(A.postfix){T=A.postfix;break}A=A.right}}T&&(r=r.getSubData(this,T,t))}}else{c=e.variable.postfix,o=this.getVariableName(e.variable,t);const y=t.getVariable(o);if(y===null)return void console.error(`Variable ${o} not found. Line ${e.line}`);r=y.value}if(r instanceof Jl&&(r=r.reference),r===null)return void console.error(`Variable ${o} not found. Line ${e.line}`);const f=this.evalExpression(e.value,t),a=e.operator;if(a==="=")if(r instanceof qi)r.setDataValue(this,f,c,t);else if(c){if(!(r instanceof ne||r instanceof Nt))return void console.error(`Variable ${o} is not a vector or matrix. Line ${e.line}`);if(c instanceof dc){const y=this.evalExpression(c.index,t).value;if(r instanceof ne){if(!(f instanceof Te))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[y]=f.value}else{if(!(r instanceof Nt))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);{const T=this.evalExpression(c.index,t).value;if(T<0)return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);if(!(f instanceof ne))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);{const A=r.typeInfo.getTypeName();if(A==="mat2x2"||A==="mat2x2f"||A==="mat2x2h"){if(!(T<2&&f.data.length===2))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[2*T]=f.data[0],r.data[2*T+1]=f.data[1]}else if(A==="mat2x3"||A==="mat2x3f"||A==="mat2x3h"){if(!(T<2&&f.data.length===3))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[3*T]=f.data[0],r.data[3*T+1]=f.data[1],r.data[3*T+2]=f.data[2]}else if(A==="mat2x4"||A==="mat2x4f"||A==="mat2x4h"){if(!(T<2&&f.data.length===4))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[4*T]=f.data[0],r.data[4*T+1]=f.data[1],r.data[4*T+2]=f.data[2],r.data[4*T+3]=f.data[3]}else if(A==="mat3x2"||A==="mat3x2f"||A==="mat3x2h"){if(!(T<3&&f.data.length===2))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[2*T]=f.data[0],r.data[2*T+1]=f.data[1]}else if(A==="mat3x3"||A==="mat3x3f"||A==="mat3x3h"){if(!(T<3&&f.data.length===3))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[3*T]=f.data[0],r.data[3*T+1]=f.data[1],r.data[3*T+2]=f.data[2]}else if(A==="mat3x4"||A==="mat3x4f"||A==="mat3x4h"){if(!(T<3&&f.data.length===4))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[4*T]=f.data[0],r.data[4*T+1]=f.data[1],r.data[4*T+2]=f.data[2],r.data[4*T+3]=f.data[3]}else if(A==="mat4x2"||A==="mat4x2f"||A==="mat4x2h"){if(!(T<4&&f.data.length===2))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[2*T]=f.data[0],r.data[2*T+1]=f.data[1]}else if(A==="mat4x3"||A==="mat4x3f"||A==="mat4x3h"){if(!(T<4&&f.data.length===3))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[3*T]=f.data[0],r.data[3*T+1]=f.data[1],r.data[3*T+2]=f.data[2]}else{if(A!=="mat4x4"&&A!=="mat4x4f"&&A!=="mat4x4h")return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);if(!(T<4&&f.data.length===4))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[4*T]=f.data[0],r.data[4*T+1]=f.data[1],r.data[4*T+2]=f.data[2],r.data[4*T+3]=f.data[3]}}}}}else if(c instanceof Xa){const y=c.value;if(!(r instanceof ne))return void console.error(`Invalid assignment to ${y}. Variable ${o} is not a vector. Line ${e.line}`);if(f instanceof Te){if(y.length>1)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);if(y==="x")r.data[0]=f.value;else if(y==="y"){if(r.data.length<2)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);r.data[1]=f.value}else if(y==="z"){if(r.data.length<3)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);r.data[2]=f.value}else if(y==="w"){if(r.data.length<4)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);r.data[3]=f.value}}else{if(!(f instanceof ne))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);if(y.length!==f.data.length)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);for(let T=0;T<y.length;++T){const A=y[T];if(A==="x"||A==="r")r.data[0]=f.data[T];else if(A==="y"||A==="g"){if(f.data.length<2)return void console.error(`Invalid assignment to ${A} for variable ${o}. Line ${e.line}`);r.data[1]=f.data[T]}else if(A==="z"||A==="b"){if(f.data.length<3)return void console.error(`Invalid assignment to ${A} for variable ${o}. Line ${e.line}`);r.data[2]=f.data[T]}else{if(A!=="w"&&A!=="a")return void console.error(`Invalid assignment to ${A} for variable ${o}. Line ${e.line}`);if(f.data.length<4)return void console.error(`Invalid assignment to ${A} for variable ${o}. Line ${e.line}`);r.data[3]=f.data[T]}}}}}else r instanceof Te&&f instanceof Te?r.value=f.value:r instanceof ne&&f instanceof ne||r instanceof Nt&&f instanceof Nt?r.data.set(f.data):console.error(`Invalid assignment to ${o}. Line ${e.line}`);else{const y=r.getSubData(this,c,t);if(y instanceof ne&&f instanceof Te){const T=y.data,A=f.value;if(a==="+=")for(let M=0;M<T.length;++M)T[M]+=A;else if(a==="-=")for(let M=0;M<T.length;++M)T[M]-=A;else if(a==="*=")for(let M=0;M<T.length;++M)T[M]*=A;else if(a==="/=")for(let M=0;M<T.length;++M)T[M]/=A;else if(a==="%=")for(let M=0;M<T.length;++M)T[M]%=A;else if(a==="&=")for(let M=0;M<T.length;++M)T[M]&=A;else if(a==="|=")for(let M=0;M<T.length;++M)T[M]|=A;else if(a==="^=")for(let M=0;M<T.length;++M)T[M]^=A;else if(a==="<<=")for(let M=0;M<T.length;++M)T[M]<<=A;else if(a===">>=")for(let M=0;M<T.length;++M)T[M]>>=A;else console.error(`Invalid operator ${a}. Line ${e.line}`)}else if(y instanceof ne&&f instanceof ne){const T=y.data,A=f.data;if(T.length!==A.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(a==="+=")for(let M=0;M<T.length;++M)T[M]+=A[M];else if(a==="-=")for(let M=0;M<T.length;++M)T[M]-=A[M];else if(a==="*=")for(let M=0;M<T.length;++M)T[M]*=A[M];else if(a==="/=")for(let M=0;M<T.length;++M)T[M]/=A[M];else if(a==="%=")for(let M=0;M<T.length;++M)T[M]%=A[M];else if(a==="&=")for(let M=0;M<T.length;++M)T[M]&=A[M];else if(a==="|=")for(let M=0;M<T.length;++M)T[M]|=A[M];else if(a==="^=")for(let M=0;M<T.length;++M)T[M]^=A[M];else if(a==="<<=")for(let M=0;M<T.length;++M)T[M]<<=A[M];else if(a===">>=")for(let M=0;M<T.length;++M)T[M]>>=A[M];else console.error(`Invalid operator ${a}. Line ${e.line}`)}else{if(!(y instanceof Te&&f instanceof Te))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);a==="+="?y.value+=f.value:a==="-="?y.value-=f.value:a==="*="?y.value*=f.value:a==="/="?y.value/=f.value:a==="%="?y.value%=f.value:a==="&="?y.value&=f.value:a==="|="?y.value|=f.value:a==="^="?y.value^=f.value:a==="<<="?y.value<<=f.value:a===">>="?y.value>>=f.value:console.error(`Invalid operator ${a}. Line ${e.line}`)}r instanceof qi&&r.setDataValue(this,y,c,t)}}_function(e,t){const r=new ty(e);t.functions.set(e.name,r)}_const(e,t){let r=null;e.value!==null&&(r=this.evalExpression(e.value,t)),t.createVariable(e.name,r,e)}_let(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof ar||(r=r.clone())}else{const o=e.type.name;if(o==="f32"||o==="i32"||o==="u32"||o==="bool"||o==="f16"||o==="vec2"||o==="vec3"||o==="vec4"||o==="vec2f"||o==="vec3f"||o==="vec4f"||o==="vec2i"||o==="vec3i"||o==="vec4i"||o==="vec2u"||o==="vec3u"||o==="vec4u"||o==="vec2h"||o==="vec3h"||o==="vec4h"||o==="vec2b"||o==="vec3b"||o==="vec4b"||o==="mat2x2"||o==="mat2x3"||o==="mat2x4"||o==="mat3x2"||o==="mat3x3"||o==="mat3x4"||o==="mat4x2"||o==="mat4x3"||o==="mat4x4"||o==="mat2x2f"||o==="mat2x3f"||o==="mat2x4f"||o==="mat3x2f"||o==="mat3x3f"||o==="mat3x4f"||o==="mat4x2f"||o==="mat4x3f"||o==="mat4x4f"||o==="mat2x2h"||o==="mat2x3h"||o==="mat2x4h"||o==="mat3x2h"||o==="mat3x3h"||o==="mat3x4h"||o==="mat4x2h"||o==="mat4x3h"||o==="mat4x4h"||o==="array"){const c=new ys(e.type,[]);r=this._evalCreate(c,t)}}t.createVariable(e.name,r,e)}_var(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof ar||(r=r.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const o=e.type.name;if(o==="f32"||o==="i32"||o==="u32"||o==="bool"||o==="f16"||o==="vec2"||o==="vec3"||o==="vec4"||o==="vec2f"||o==="vec3f"||o==="vec4f"||o==="vec2i"||o==="vec3i"||o==="vec4i"||o==="vec2u"||o==="vec3u"||o==="vec4u"||o==="vec2h"||o==="vec3h"||o==="vec4h"||o==="vec2b"||o==="vec3b"||o==="vec4b"||o==="mat2x2"||o==="mat2x3"||o==="mat2x4"||o==="mat3x2"||o==="mat3x3"||o==="mat3x4"||o==="mat4x2"||o==="mat4x3"||o==="mat4x4"||o==="mat2x2f"||o==="mat2x3f"||o==="mat2x4f"||o==="mat3x2f"||o==="mat3x3f"||o==="mat3x4f"||o==="mat4x2f"||o==="mat4x3f"||o==="mat4x4f"||o==="mat2x2h"||o==="mat2x3h"||o==="mat2x4h"||o==="mat3x2h"||o==="mat3x3h"||o==="mat3x4h"||o==="mat4x2h"||o==="mat4x3h"||o==="mat4x4h"||e.type instanceof ih||e.type instanceof Gs||e.type instanceof Me){const c=new ys(e.type,[]);r=this._evalCreate(c,t)}}t.createVariable(e.name,r,e)}_switch(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof Te))return console.error(`Invalid if condition. Line ${e.line}`),null;let o=null;for(const c of e.cases)if(c instanceof g1)for(const f of c.selectors){if(f instanceof gd){o=c;continue}const a=this.evalExpression(f,t);if(!(a instanceof Te))return console.error(`Invalid case selector. Line ${e.line}`),null;if(a.value===r.value)return this._execStatements(c.body,t)}else c instanceof m1&&(o=c);return o?this._execStatements(o.body,t):null}_if(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof Te))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(e.body,t);for(const o of e.elseif){const c=this.evalExpression(o.condition,t);if(!(c instanceof Te))return console.error(`Invalid if condition. Line ${e.line}`),null;if(c.value)return this._execStatements(o.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof Te?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===Br._breakObj)break;if(r!==null&&r!==Br._continueObj)return r;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const r=this._execStatements(e.body,t);if(r===Br._breakObj)break;if(r===Br._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===Br._breakObj)break}else if(r!==null)return r}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===Br._breakObj)break;if(r!==Br._continueObj&&r!==null)return r}return null}_evalBitcast(e,t){const r=this.evalExpression(e.value,t),o=e.type;if(r instanceof Te){const c=Qv(r.value,r.typeInfo.name,o.name);return new Te(c,this.getTypeInfo(o))}if(r instanceof ne){const c=r.typeInfo.getTypeName();let f="";if(c.endsWith("f"))f="f32";else if(c.endsWith("i"))f="i32";else if(c.endsWith("u"))f="u32";else if(c.endsWith("b"))f="bool";else{if(!c.endsWith("h"))return console.error(`Unknown vector type ${c}. Line ${e.line}`),null;f="f16"}const a=o.getTypeName();let y="";if(a.endsWith("f"))y="f32";else if(a.endsWith("i"))y="i32";else if(a.endsWith("u"))y="u32";else if(a.endsWith("b"))y="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${y}. Line ${e.line}`),null;y="f16"}const T=function(A,M,F){if(M===F)return A;const L=new Array(A.length);for(let Y=0;Y<A.length;Y++)L[Y]=Qv(A[Y],M,F);return L}(Array.from(r.data),f,y);return new ne(T,this.getTypeInfo(o))}return console.error(`TODO: bitcast for ${r.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var r;if(e instanceof ys){if(e.type===null)return s_.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const o=e instanceof ys?e.type.name:e.name,c=e instanceof ys?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(c===null)return console.error(`Unknown type ${o}. Line ${e.line}`),null;if(c.size===0)return null;const f=new qi(new ArrayBuffer(c.size),c,0);if(c instanceof Xo){if(e.args)for(let a=0;a<e.args.length;++a){const y=c.members[a],T=e.args[a],A=this.evalExpression(T,t);f.setData(this,A,y.type,y.offset,t)}}else if(c instanceof Jo){let a=0;if(e.args)for(let y=0;y<e.args.length;++y){const T=e.args[y],A=this.evalExpression(T,t);c.format===null&&(((r=A.typeInfo)===null||r===void 0?void 0:r.name)==="x32"?c.format=this.getTypeInfo("i32"):c.format=A.typeInfo),f.setData(this,A,c.format,a,t),a+=c.stride}}else console.error(`Unknown type "${o}". Line ${e.line}`);return e instanceof ys?f.getSubData(this,e.postfix,t):f}_evalLiteral(e,t){const r=this.getTypeInfo(e.type),o=r.name;return o==="x32"||o==="u32"||o==="f32"||o==="f16"||o==="i32"||o==="bool"?new Te(e.scalarValue,r):o==="vec2"||o==="vec3"||o==="vec4"||o==="vec2f"||o==="vec3f"||o==="vec4f"||o==="vec2h"||o==="vec3h"||o==="vec4h"||o==="vec2i"||o==="vec3i"||o==="vec4i"||o==="vec2u"||o==="vec3u"||o==="vec4u"?this._callConstructorVec(e,t):o==="mat2x2"||o==="mat2x3"||o==="mat2x4"||o==="mat3x2"||o==="mat3x3"||o==="mat3x4"||o==="mat4x2"||o==="mat4x3"||o==="mat4x4"||o==="mat2x2f"||o==="mat2x3f"||o==="mat2x4f"||o==="mat3x2f"||o==="mat3x3f"||o==="mat3x4f"||o==="mat4x2f"||o==="mat4x3f"||o==="mat4x4f"||o==="mat2x2h"||o==="mat2x3h"||o==="mat2x4h"||o==="mat3x2h"||o==="mat3x3h"||o==="mat3x4h"||o==="mat4x2h"||o==="mat4x3h"||o==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const r=t.getVariableValue(e.name);return r===null?r:r.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const o=Br._priority.get(t.name);Br._priority.get(e[r].name)<o&&(t=e[r])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const r=this.evalExpression(e.right,t);if(e.operator==="&")return new Jl(r);if(e.operator==="*")return r instanceof Jl?r.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const o=r instanceof Te?r.value:r instanceof ne?Array.from(r.data):null;switch(e.operator){case"+":{if(_t(o)){const a=o.map((y,T)=>+y);return new ne(a,r.typeInfo)}const c=o,f=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Te(+c,f)}case"-":{if(_t(o)){const a=o.map((y,T)=>-y);return new ne(a,r.typeInfo)}const c=o,f=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Te(-c,f)}case"!":{if(_t(o)){const a=o.map((y,T)=>y?0:1);return new ne(a,r.typeInfo)}const c=o,f=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Te(c?0:1,f)}case"~":{if(_t(o)){const a=o.map((y,T)=>~y);return new ne(a,r.typeInfo)}const c=o,f=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Te(~c,f)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const r=this.evalExpression(e.left,t),o=this.evalExpression(e.right,t),c=r instanceof Te?r.value:r instanceof ne||r instanceof Nt?Array.from(r.data):null,f=o instanceof Te?o.value:o instanceof ne||o instanceof Nt?Array.from(o.data):null;switch(e.operator){case"+":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L+M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F+A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A+F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a+y,T)}case"-":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L-M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F-A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A-F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a-y,T)}case"*":{if(_t(c)&&_t(f)){const A=c,M=f;if(r instanceof Nt&&o instanceof Nt){const F=function(pe,Ee,Be,xe){if(Wr[Ee.name]===void 0||Wr[xe.name]===void 0)return null;const Ce=Wr[Ee.name][0],tt=Wr[Ee.name][1],Xe=Wr[xe.name][0];if(Ce!==Wr[xe.name][1])return null;const gt=new Array(Xe*tt);for(let ft=0;ft<tt;ft++)for(let yt=0;yt<Xe;yt++){let Bt=0;for(let Pt=0;Pt<Ce;Pt++)Bt+=pe[Pt*tt+ft]*Be[yt*Ce+Pt];gt[ft*Xe+yt]=Bt}return gt}(A,r.typeInfo,M,o.typeInfo);if(F===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const L=Wr[o.typeInfo.name][0],Y=Wr[r.typeInfo.name][1],ae=this.getTypeInfo(`mat${L}x${Y}f`);return new Nt(F,ae)}if(r instanceof Nt&&o instanceof ne){const F=function(L,Y,ae,pe){if(Wr[Y.name]===void 0||dm[pe.name]===void 0)return null;const Ee=Wr[Y.name][0],Be=Wr[Y.name][1];if(Ee!==ae.length)return null;const xe=new Array(Be);for(let Ce=0;Ce<Be;Ce++){let tt=0;for(let Xe=0;Xe<Ee;Xe++)tt+=L[Xe*Be+Ce]*ae[Xe];xe[Ce]=tt}return xe}(A,r.typeInfo,M,o.typeInfo);return F===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ne(F,o.typeInfo)}if(r instanceof ne&&o instanceof Nt){const F=function(L,Y,ae,pe){if(dm[Y.name]===void 0||Wr[pe.name]===void 0)return null;const Ee=Wr[pe.name][0],Be=Wr[pe.name][1];if(Be!==L.length)return null;const xe=[];for(let Ce=0;Ce<Ee;Ce++){let tt=0;for(let Xe=0;Xe<Be;Xe++)tt+=L[Xe]*ae[Xe*Ee+Ce];xe[Ce]=tt}return xe}(A,r.typeInfo,M,o.typeInfo);return F===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ne(F,r.typeInfo)}{if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L*M[Y]);return new ne(F,r.typeInfo)}}if(_t(c)){const A=f,M=c.map((F,L)=>F*A);return r instanceof Nt?new Nt(M,r.typeInfo):new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A*F);return o instanceof Nt?new Nt(M,o.typeInfo):new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a*y,T)}case"%":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L%M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F%A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A%F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a%y,T)}case"/":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L/M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F/A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A/F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a/y,T)}case"&":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L&M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F&A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A&F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a&y,T)}case"|":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L|M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F|A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A|F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a|y,T)}case"^":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L^M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F^A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A^F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a^y,T)}case"<<":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L<<M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F<<A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A<<F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a<<y,T)}case">>":{if(_t(c)&&_t(f)){const A=c,M=f;if(A.length!==M.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const F=A.map((L,Y)=>L>>M[Y]);return new ne(F,r.typeInfo)}if(_t(c)){const A=f,M=c.map((F,L)=>F>>A);return new ne(M,r.typeInfo)}if(_t(f)){const A=c,M=f.map((F,L)=>A>>F);return new ne(M,o.typeInfo)}const a=c,y=f,T=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Te(a>>y,T)}case">":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A>y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T>a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a>T?1:0);return new ne(y,o.typeInfo)}return new Te(c>f?1:0,this.getTypeInfo("bool"));case"<":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A<y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T<a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a<T?1:0);return new ne(y,o.typeInfo)}return new Te(c<f?1:0,this.getTypeInfo("bool"));case"==":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A===y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T==a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a==T?1:0);return new ne(y,o.typeInfo)}return new Te(c===f?1:0,this.getTypeInfo("bool"));case"!=":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A!==y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T!==a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a!==T?1:0);return new ne(y,o.typeInfo)}return new Te(c!==f?1:0,this.getTypeInfo("bool"));case">=":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A>=y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T>=a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a>=T?1:0);return new ne(y,o.typeInfo)}return new Te(c>=f?1:0,this.getTypeInfo("bool"));case"<=":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A<=y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T<=a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a<=T?1:0);return new ne(y,o.typeInfo)}return new Te(c<=f?1:0,this.getTypeInfo("bool"));case"&&":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A&&y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T&&a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a&&T?1:0);return new ne(y,o.typeInfo)}return new Te(c&&f?1:0,this.getTypeInfo("bool"));case"||":if(_t(c)&&_t(f)){const a=c,y=f;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const T=a.map((A,M)=>A||y[M]?1:0);return new ne(T,r.typeInfo)}if(_t(c)){const a=f,y=c.map((T,A)=>T||a?1:0);return new ne(y,r.typeInfo)}if(_t(f)){const a=c,y=f.map((T,A)=>a||T?1:0);return new ne(y,o.typeInfo)}return new Te(c||f?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const r=t.clone();r.currentFunctionName=e.name;const o=t.getFunction(e.name);if(!o)return e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let c=0;c<o.node.args.length;++c){const f=o.node.args[c],a=this.evalExpression(e.args[c],r);r.createVariable(f.name,a,f)}return this._execStatements(o.node.body,r)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothStep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const r=t.getFunction(e.name);if(r){const o=t.clone();for(let c=0;c<r.node.args.length;++c){const f=r.node.args[c],a=this.evalExpression(e.args[c],o);o.setVariable(f.name,a,f)}return this._execStatements(r.node.body,o)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new Te(0,this.getTypeInfo(e.type));const r=this.evalExpression(e.args[0],t);return r.typeInfo=this.getTypeInfo(e.type),r.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const r=this.getTypeInfo(e.type),o=e.type.getTypeName(),c=dm[o];if(c===void 0)return console.error(`Invalid vec constructor ${o}. Line ${e.line}`),null;const f=[];if(e instanceof pr)if(e.isVector){const a=e.vectorValue;for(const y of a)f.push(y)}else f.push(e.scalarValue);else if(e.args)for(const a of e.args){const y=this.evalExpression(a,t);if(y instanceof ne){const T=y.data;for(let A=0;A<T.length;++A){let M=T[A];f.push(M)}}else if(y instanceof Te){let T=y.value;f.push(T)}}if(e.type instanceof Me&&e.type.format===null&&(e.type.format=Me.f32),f.length===0){const a=new Array(c).fill(0);return new ne(a,r).getSubData(this,e.postfix,t)}if(f.length===1)for(;f.length<c;)f.push(f[0]);return f.length<c?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new ne(f.length>c?f.slice(0,c):f,r).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const r=this.getTypeInfo(e.type),o=e.type.getTypeName(),c=Wr[o];if(c===void 0)return console.error(`Invalid matrix constructor ${o}. Line ${e.line}`),null;const f=[];if(e instanceof pr)if(e.isVector){const a=e.vectorValue;for(const y of a)f.push(y)}else f.push(e.scalarValue);else if(e.args)for(const a of e.args){const y=this.evalExpression(a,t);y instanceof ne?f.push(...y.data):y instanceof Te?f.push(y.value):y instanceof Nt&&f.push(...y.data)}if(r instanceof Za&&r.format===null&&(r.format=this.getTypeInfo("f32")),f.length===0){const a=new Array(c[2]).fill(0);return new Nt(a,r).getSubData(this,e.postfix,t)}return f.length!==c[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new Nt(f,r).getSubData(this,e.postfix,t)}}Br._breakObj=new En(new Tn("BREAK",null),null),Br._continueObj=new En(new Tn("CONTINUE",null),null),Br._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class PI{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class EI{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new PI,this._exec=new Br,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;t.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const o=r.arrayType,c=r.countNode;if(c instanceof fn){const f=c.name,a=this._context.constants.get(f);if(a)try{const y=a.constEvaluate(this._exec);o.count=y}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const r of t)r.search(o=>{o instanceof Kv||o instanceof fm?o.type=this._forwardType(o.type):o instanceof ih?o.format=this._forwardType(o.format):o instanceof Ks||o instanceof th||o instanceof pd?o.type=this._forwardType(o.type):o instanceof ch?o.returnType=this._forwardType(o.returnType):o instanceof Yv&&(o.type=this._forwardType(o.type))});return t}_forwardType(e){if(e instanceof Gv){const t=this._getType(e.name);if(t)return t}else e instanceof fm?e.type=this._forwardType(e.type):e instanceof ih&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new mI(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==ee.eof}_match(e){if(e instanceof Ae)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const o=e[t];if(this._check(o))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;let o=!1;for(const c of e){if(r===c)return!0;c===ee.tokens.name&&(o=!0)}if(o){const c=ee.tokens.name.rule.exec(t.lexeme);if(c&&c.index==0&&c[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===ee.tokens.name){const r=ee.tokens.name.rule.exec(t.lexeme);return r&&r.index==0&&r[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(ee.tokens.semicolon)&&!this._isAtEnd(););if(this._match(ee.keywords.alias)){const t=this._type_alias();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(ee.keywords.diagnostic)){const t=this._diagnostic();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(ee.keywords.requires)){const t=this._requires_directive();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(ee.keywords.enable)){const t=this._enable_directive();return this._consume(ee.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(ee.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(ee.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(ee.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(ee.keywords.fn))return null;const e=this._currentLine,t=this._consume(ee.tokens.ident,"Expected function name.").toString();this._consume(ee.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(ee.tokens.paren_right))do{if(this._check(ee.tokens.paren_right))break;const a=this._attribute(),y=this._consume(ee.tokens.name,"Expected argument name.").toString();this._consume(ee.tokens.colon,"Expected ':' for argument type.");const T=this._attribute(),A=this._type_decl();A!=null&&(A.attributes=T,r.push(this._updateNode(new Yv(y,A,a))))}while(this._match(ee.tokens.comma));this._consume(ee.tokens.paren_right,"Expected ')' after function arguments.");let o=null;if(this._match(ee.tokens.arrow)){const a=this._attribute();o=this._type_decl(),o!=null&&(o.attributes=a)}const c=this._compound_statement(),f=this._currentLine;return this._updateNode(new ch(t,r,o,c,e,f),e)}_compound_statement(){const e=[];for(this._consume(ee.tokens.brace_left,"Expected '{' for block.");!this._check(ee.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(ee.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(ee.tokens.semicolon)&&!this._isAtEnd(););if(this._check(ee.tokens.attr)&&this._attribute(),this._check(ee.keywords.if))return this._if_statement();if(this._check(ee.keywords.switch))return this._switch_statement();if(this._check(ee.keywords.loop))return this._loop_statement();if(this._check(ee.keywords.for))return this._for_statement();if(this._check(ee.keywords.while))return this._while_statement();if(this._check(ee.keywords.continuing))return this._continuing_statement();if(this._check(ee.keywords.static_assert))return this._static_assert_statement();if(this._check(ee.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(ee.keywords.return))e=this._return_statement();else if(this._check([ee.keywords.var,ee.keywords.let,ee.keywords.const]))e=this._variable_statement();else if(this._match(ee.keywords.discard))e=this._updateNode(new dI);else if(this._match(ee.keywords.break)){const t=this._updateNode(new c1);if(this._currentLoop.length>0){const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t,this._check(ee.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(ee.keywords.continue)){const t=this._updateNode(new u1);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(ee.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(ee.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new uI(t),e)}_while_statement(){if(!this._match(ee.keywords.while))return null;const e=this._updateNode(new e1(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(ee.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(ee.keywords.continuing))return null;const t=this._currentLine,r=this._compound_statement();return this._updateNode(new n_(r,e),t)}_for_statement(){if(!this._match(ee.keywords.for))return null;this._consume(ee.tokens.paren_left,"Expected '('.");const e=this._updateNode(new t1(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(ee.tokens.semicolon)?null:this._for_init(),this._consume(ee.tokens.semicolon,"Expected ';'."),e.condition=this._check(ee.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(ee.tokens.semicolon,"Expected ';'."),e.increment=this._check(ee.tokens.paren_right)?null:this._for_increment(),this._consume(ee.tokens.paren_right,"Expected ')'."),this._check(ee.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(ee.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(ee.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Ks(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(ee.keywords.let)){const e=this._currentLine,t=this._consume(ee.tokens.name,"Expected name for let.").toString();let r=null;if(this._match(ee.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}this._consume(ee.tokens.equal,"Expected '=' for let.");const o=this._short_circuit_or_expression();return this._updateNode(new th(t,r,null,null,o),e)}if(this._match(ee.keywords.const)){const e=this._currentLine,t=this._consume(ee.tokens.name,"Expected name for const.").toString();let r=null;if(this._match(ee.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}this._consume(ee.tokens.equal,"Expected '=' for const.");const o=this._short_circuit_or_expression();return r===null&&o instanceof pr&&(r=o.type),this._updateNode(new pd(t,r,null,null,o),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(ee.increment_operators))return this._current=e,null;const r=this._consume(ee.increment_operators,"Expected increment operator");return this._updateNode(new i1(r.type===ee.tokens.plus_plus?ic.increment:ic.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(ee.tokens.brace_right))return null;let r=this._match(ee.tokens.underscore);if(r||(e=this._unary_expression()),!r&&e==null)return null;const o=this._consume(ee.assignment_operators,"Expected assignment operator."),c=this._short_circuit_or_expression();return this._updateNode(new r1(Wu.parse(o.lexeme),e,c),t)}_func_call_statement(){if(!this._check(ee.tokens.ident))return null;const e=this._currentLine,t=this._current,r=this._consume(ee.tokens.ident,"Expected function name."),o=this._argument_expression_list();return o===null?(this._current=t,null):this._updateNode(new K_(r.lexeme,o),e)}_loop_statement(){if(!this._match(ee.keywords.loop))return null;this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new n1([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let r of t)e.body.push(r);else e.body.push(t);if(t instanceof n_){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(ee.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(ee.keywords.switch))return null;const e=this._updateNode(new s1(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(ee.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([ee.keywords.default,ee.keywords.case]);){if(this._match(ee.keywords.case)){const r=this._case_selectors();for(const c of r)if(c instanceof gd){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(ee.tokens.colon),this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Exected '{' for switch case.");const o=this._case_body();this._consume(ee.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new g1(r,o)))}if(this._match(ee.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(ee.tokens.colon),this._check(ee.tokens.attr)&&this._attribute(),this._consume(ee.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(ee.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new m1(r)))}}return e}_case_selectors(){const e=[];for(this._match(ee.keywords.default)?e.push(this._updateNode(new gd)):e.push(this._shift_expression());this._match(ee.tokens.comma);)this._match(ee.keywords.default)?e.push(this._updateNode(new gd)):e.push(this._shift_expression());return e}_case_body(){if(this._match(ee.keywords.fallthrough))return this._consume(ee.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(ee.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(ee.tokens.attr)&&this._attribute();const r=this._compound_statement();let o=[];this._match_elseif()&&(this._check(ee.tokens.attr)&&this._attribute(),o=this._elseif_statement(o));let c=null;return this._match(ee.keywords.else)&&(this._check(ee.tokens.attr)&&this._attribute(),c=this._compound_statement()),this._updateNode(new o1(t,r,o,c),e)}_match_elseif(){return this._tokens[this._current].type===ee.keywords.else&&this._tokens[this._current+1].type===ee.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(this._updateNode(new pI(t,r))),this._match_elseif()&&(this._check(ee.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(ee.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new a1(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(ee.tokens.or_or);)e=this._updateNode(new Hn(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(ee.tokens.and_and);)e=this._updateNode(new Hn(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(ee.tokens.or);)e=this._updateNode(new Hn(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(ee.tokens.xor);)e=this._updateNode(new Hn(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(ee.tokens.and);)e=this._updateNode(new Hn(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([ee.tokens.equal_equal,ee.tokens.not_equal])?this._updateNode(new Hn(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([ee.tokens.less_than,ee.tokens.greater_than,ee.tokens.less_than_equal,ee.tokens.greater_than_equal]);)e=this._updateNode(new Hn(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([ee.tokens.shift_left,ee.tokens.shift_right]);)e=this._updateNode(new Hn(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([ee.tokens.plus,ee.tokens.minus]);)e=this._updateNode(new Hn(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([ee.tokens.star,ee.tokens.forward_slash,ee.tokens.modulo]);)e=this._updateNode(new Hn(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([ee.tokens.minus,ee.tokens.bang,ee.tokens.tilde,ee.tokens.star,ee.tokens.and])?this._updateNode(new ar(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(ee.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(ee.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new dc(e)),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(ee.tokens.period)){const e=this._consume(ee.tokens.name,"Expected member name."),t=this._postfix_expression(),r=this._updateNode(new Xa(e.lexeme));return t&&(r.postfix=t),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return it.void;case"bool":return it.bool;case"i32":return it.i32;case"u32":return it.u32;case"f32":return it.f32;case"f16":return it.f16;case"vec2f":return Me.vec2f;case"vec3f":return Me.vec3f;case"vec4f":return Me.vec4f;case"vec2i":return Me.vec2i;case"vec3i":return Me.vec3i;case"vec4i":return Me.vec4i;case"vec2u":return Me.vec2u;case"vec3u":return Me.vec3u;case"vec4u":return Me.vec4u;case"vec2h":return Me.vec2h;case"vec3h":return Me.vec3h;case"vec4h":return Me.vec4h;case"mat2x2f":return Me.mat2x2f;case"mat2x3f":return Me.mat2x3f;case"mat2x4f":return Me.mat2x4f;case"mat3x2f":return Me.mat3x2f;case"mat3x3f":return Me.mat3x3f;case"mat3x4f":return Me.mat3x4f;case"mat4x2f":return Me.mat4x2f;case"mat4x3f":return Me.mat4x3f;case"mat4x4f":return Me.mat4x4f;case"mat2x2h":return Me.mat2x2h;case"mat2x3h":return Me.mat2x3h;case"mat2x4h":return Me.mat2x4h;case"mat3x2h":return Me.mat3x2h;case"mat3x3h":return Me.mat3x3h;case"mat3x4h":return Me.mat3x4h;case"mat4x2h":return Me.mat4x2h;case"mat4x3h":return Me.mat4x3h;case"mat4x4h":return Me.mat4x4h;case"mat2x2i":return Me.mat2x2i;case"mat2x3i":return Me.mat2x3i;case"mat2x4i":return Me.mat2x4i;case"mat3x2i":return Me.mat3x2i;case"mat3x3i":return Me.mat3x3i;case"mat3x4i":return Me.mat3x4i;case"mat4x2i":return Me.mat4x2i;case"mat4x3i":return Me.mat4x3i;case"mat4x4i":return Me.mat4x4i;case"mat2x2u":return Me.mat2x2u;case"mat2x3u":return Me.mat2x3u;case"mat2x4u":return Me.mat2x4u;case"mat3x2u":return Me.mat3x2u;case"mat3x3u":return Me.mat3x3u;case"mat3x4u":return Me.mat3x4u;case"mat4x2u":return Me.mat4x2u;case"mat4x3u":return Me.mat4x3u;case"mat4x4u":return Me.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(ee.tokens.ident)){const r=this._previous().toString();if(this._check(ee.tokens.paren_left)){const o=this._argument_expression_list(),c=this._getType(r);return c!==null?this._updateNode(new ys(c,o)):this._updateNode(new Q_(r,o))}if(this._context.constants.has(r)){const o=this._context.constants.get(r);return this._updateNode(new h1(r,o.value))}return this._updateNode(new fn(r))}if(this._match(ee.tokens.int_literal)){const r=this._previous().toString();let o=r.endsWith("i")||r.endsWith("i")?it.i32:r.endsWith("u")||r.endsWith("U")?it.u32:it.x32;const c=parseInt(r);return this._validateTypeRange(c,o),this._updateNode(new pr(new Te(c,this._exec.getTypeInfo(o)),o))}if(this._match(ee.tokens.uint_literal)){const r=parseInt(this._previous().toString());return this._validateTypeRange(r,it.u32),this._updateNode(new pr(new Te(r,this._exec.getTypeInfo(it.u32)),it.u32))}if(this._match([ee.tokens.decimal_float_literal,ee.tokens.hex_float_literal])){let r=this._previous().toString(),o=r.endsWith("h");o&&(r=r.substring(0,r.length-1));const c=parseFloat(r);this._validateTypeRange(c,o?it.f16:it.f32);const f=o?it.f16:it.f32;return this._updateNode(new pr(new Te(c,this._exec.getTypeInfo(f)),f))}if(this._match([ee.keywords.true,ee.keywords.false])){let r=this._previous().toString()===ee.keywords.true.rule;return this._updateNode(new pr(new Te(r?1:0,this._exec.getTypeInfo(it.bool)),it.bool))}if(this._check(ee.tokens.paren_left))return this._paren_expression();if(this._match(ee.keywords.bitcast)){this._consume(ee.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(ee.tokens.greater_than,"Expected '>'.");const o=this._paren_expression();return this._updateNode(new f1(r,o))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new ys(e,t))}_argument_expression_list(){if(!this._match(ee.tokens.paren_left))return null;const e=[];do{if(this._check(ee.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(ee.tokens.comma));return this._consume(ee.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(ee.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(ee.tokens.paren_right),e}_paren_expression(){this._consume(ee.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(ee.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(ee.keywords.struct))return null;const e=this._currentLine,t=this._consume(ee.tokens.ident,"Expected name for struct.").toString();this._consume(ee.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(ee.tokens.brace_right);){const f=this._attribute(),a=this._consume(ee.tokens.name,"Expected variable name.").toString();this._consume(ee.tokens.colon,"Expected ':' for struct member type.");const y=this._attribute(),T=this._type_decl();T!=null&&(T.attributes=y),this._check(ee.tokens.brace_right)?this._match(ee.tokens.comma):this._consume(ee.tokens.comma,"Expected ',' for struct member."),r.push(this._updateNode(new Kv(a,T,f)))}this._consume(ee.tokens.brace_right,"Expected '}' after struct body.");const o=this._currentLine,c=this._updateNode(new Gs(t,r,e,o),e);return this._context.structs.set(t,c),c}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(ee.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof pr){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof pr&&(e.type=e.value.type.name==="x32"?it.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(ee.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(ee.keywords.const))return null;const t=this._consume(ee.tokens.name,"Expected variable name"),r=this._currentLine;let o=null;if(this._match(ee.tokens.colon)){const y=this._attribute();o=this._type_decl(),o!=null&&(o.attributes=y)}let c=null;this._consume(ee.tokens.equal,"const declarations require an assignment");const f=this._short_circuit_or_expression();try{let y=[it.f32],T=f.constEvaluate(this._exec,y);T instanceof Te&&this._validateTypeRange(T.value,y[0]),y[0]instanceof Me&&y[0].format===null&&T.typeInfo instanceof Za&&T.typeInfo.format!==null&&(T.typeInfo.format.name==="f16"?y[0].format=it.f16:T.typeInfo.format.name==="f32"?y[0].format=it.f32:T.typeInfo.format.name==="i32"?y[0].format=it.i32:T.typeInfo.format.name==="u32"?y[0].format=it.u32:T.typeInfo.format.name==="bool"?y[0].format=it.bool:console.error(`TODO: impelement template format type ${T.typeInfo.format.name}`)),c=this._updateNode(new pr(T,y[0])),this._exec.context.setVariable(t.toString(),T)}catch{c=f}if(o!==null&&c instanceof pr){if(c.type.name!=="x32"&&o.getTypeName()!==c.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${c.type.name} to ${o.name}. Line:${this._currentLine}`);c.type=o,c.isScalar&&this._validateTypeRange(c.scalarValue,c.type)}else o===null&&c instanceof pr&&(o=(e=c==null?void 0:c.type)!==null&&e!==void 0?e:it.f32,o===it.x32&&(o=it.i32));const a=this._updateNode(new pd(t.toString(),o,"","",c),r);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(ee.keywords.let))return null;const e=this._currentLine,t=this._consume(ee.tokens.name,"Expected variable name");let r=null;if(this._match(ee.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}let o=null;if(this._match(ee.tokens.equal)&&(o=this._const_expression()),r!==null&&o instanceof pr){if(o.type.name!=="x32"&&r.getTypeName()!==o.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${o.type.name} to ${r.name}. Line:${this._currentLine}`);o.type=r}else r===null&&o instanceof pr&&(r=o.type.name==="x32"?it.i32:o.type);return o instanceof pr&&o.isScalar&&this._validateTypeRange(o.scalarValue,r),this._updateNode(new th(t.toString(),r,"","",o),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(ee.keywords.var))return null;const e=this._currentLine;let t="",r="";this._match(ee.tokens.less_than)&&(t=this._consume(ee.storage_class,"Expected storage_class.").toString(),this._match(ee.tokens.comma)&&(r=this._consume(ee.access_mode,"Expected access_mode.").toString()),this._consume(ee.tokens.greater_than,"Expected '>'."));const o=this._consume(ee.tokens.name,"Expected variable name");let c=null;if(this._match(ee.tokens.colon)){const f=this._attribute();c=this._type_decl(),c!=null&&(c.attributes=f)}return this._updateNode(new Ks(o.toString(),c,t,r,null),e)}_override_decl(){if(!this._match(ee.keywords.override))return null;const e=this._consume(ee.tokens.name,"Expected variable name");let t=null;if(this._match(ee.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}return this._updateNode(new Y_(e.toString(),t,null))}_diagnostic(){this._consume(ee.tokens.paren_left,"Expected '('");const e=this._consume(ee.tokens.ident,"Expected severity control name.");this._consume(ee.tokens.comma,"Expected ','");let t=this._consume(ee.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(ee.tokens.period)&&(t+=`.${this._consume(ee.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(ee.tokens.paren_right,"Expected ')'"),this._updateNode(new l1(e.toString(),t))}_enable_directive(){const e=this._consume(ee.tokens.ident,"identity expected.");return this._updateNode(new hI(e.toString()))}_requires_directive(){const e=[this._consume(ee.tokens.ident,"identity expected.").toString()];for(;this._match(ee.tokens.comma);){const t=this._consume(ee.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new fI(e))}_type_alias(){const e=this._consume(ee.tokens.ident,"identity expected.");this._consume(ee.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=this._updateNode(new J_(e.toString(),t));return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([ee.tokens.ident,...ee.texel_format,ee.keywords.bool,ee.keywords.f32,ee.keywords.i32,ee.keywords.u32])){const r=this._advance().toString();if(this._context.structs.has(r))return this._context.structs.get(r);if(this._context.aliases.has(r))return this._context.aliases.get(r).type;if(!this._getType(r)){const o=this._updateNode(new Gv(r));return this._forwardTypeCount++,o}return this._updateNode(new it(r))}let e=this._texture_sampler_types();if(e)return e;if(this._check(ee.template_types)){let r=this._advance().toString(),o=null,c=null;return this._match(ee.tokens.less_than)&&(o=this._type_decl(),c=null,this._match(ee.tokens.comma)&&(c=this._consume(ee.access_mode,"Expected access_mode for pointer").toString()),this._consume(ee.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new Me(r,o,c))}if(this._match(ee.keywords.ptr)){let r=this._previous().toString();this._consume(ee.tokens.less_than,"Expected '<' for pointer.");const o=this._consume(ee.storage_class,"Expected storage_class for pointer");this._consume(ee.tokens.comma,"Expected ',' for pointer.");const c=this._type_decl();let f=null;return this._match(ee.tokens.comma)&&(f=this._consume(ee.access_mode,"Expected access_mode for pointer").toString()),this._consume(ee.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new fm(r,o.toString(),c,f))}const t=this._attribute();if(this._match(ee.keywords.array)){let r=null,o=-1;const c=this._previous();let f=null;if(this._match(ee.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let y="";if(this._match(ee.tokens.comma)){f=this._shift_expression();try{y=f.constEvaluate(this._exec).toString(),f=null}catch{y="1"}}this._consume(ee.tokens.greater_than,"Expected '>' for array."),o=y?parseInt(y):0}const a=this._updateNode(new ih(c.toString(),t,r,o));return f&&this._deferArrayCountEval.push({arrayType:a,countNode:f}),a}return null}_texture_sampler_types(){if(this._match(ee.sampler_type))return this._updateNode(new Hu(this._previous().toString(),null,null));if(this._match(ee.depth_texture_type))return this._updateNode(new Hu(this._previous().toString(),null,null));if(this._match(ee.sampled_texture_type)||this._match(ee.multisampled_texture_type)){const e=this._previous();this._consume(ee.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(ee.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Hu(e.toString(),t,null))}if(this._match(ee.storage_texture_type)){const e=this._previous();this._consume(ee.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(ee.texel_format,"Invalid texel format.").toString();this._consume(ee.tokens.comma,"Expected ',' after texel format.");const r=this._consume(ee.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(ee.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Hu(e.toString(),t,r))}return null}_attribute(){let e=[];for(;this._match(ee.tokens.attr);){const t=this._consume(ee.attribute_name,"Expected attribute name"),r=this._updateNode(new _1(t.toString(),null));if(this._match(ee.tokens.paren_left)){if(r.value=this._consume(ee.literal_or_ident,"Expected attribute value").toString(),this._check(ee.tokens.comma)){this._advance();do{const o=this._consume(ee.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(o)}while(this._match(ee.tokens.comma))}this._consume(ee.tokens.paren_right,"Expected ')'")}e.push(r)}return e.length==0?null:e}}class II extends vs{constructor(e){super(),e&&this.update(e)}update(e){const t=new EI().parse(e);this.updateAST(t)}}function CI(i){var c;const e={attributes:[],bindings:[]};let t;try{t=MI(i)}catch(f){return ut.error(f.message)(),e}for(const f of t.uniforms){const a=[];for(const y of((c=f.type)==null?void 0:c.members)||[])a.push({name:y.name,type:eb(y.type)});e.bindings.push({type:"uniform",name:f.name,group:f.group,location:f.binding,members:a})}for(const f of t.textures)e.bindings.push({type:"texture",name:f.name,group:f.group,location:f.binding});for(const f of t.samplers)e.bindings.push({type:"sampler",name:f.name,group:f.group,location:f.binding});const r=t.entry.vertex[0],o=(r==null?void 0:r.inputs.length)||0;for(let f=0;f<o;f++){const a=r.inputs[f];if(a.locationType==="location"){const y=eb(a.type);e.attributes.push({name:a.name,location:Number(a.location),type:y})}}return e}function eb(i){return i.format?`${i.name}<${i.format.name}>`:i.name}function MI(i){try{return new II(i)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&(e!=null&&e.message)&&(t+=`: ${e.message} `),typeof e=="object"&&(e!=null&&e.token)&&(t+=e.token.line||""),new Error(t,{cause:e})}}const RI={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...RI}};const Sn=globalThis.mathgl.config;function kI(i,{precision:e=Sn.precision}={}){return i=DI(i),`${parseFloat(i.toPrecision(e))}`}function pc(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}function qo(i,e,t){return FI(i,r=>Math.max(e,Math.min(t,r)))}function Xd(i,e,t){return pc(i)?i.map((r,o)=>Xd(r,e[o],t)):t*e+(1-t)*i}function uh(i,e,t){const r=Sn.EPSILON;try{if(i===e)return!0;if(pc(i)&&pc(e)){if(i.length!==e.length)return!1;for(let o=0;o<i.length;++o)if(!uh(i[o],e[o]))return!1;return!0}return i&&i.equals?i.equals(e):e&&e.equals?e.equals(i):typeof i=="number"&&typeof e=="number"?Math.abs(i-e)<=Sn.EPSILON*Math.max(1,Math.abs(i),Math.abs(e)):!1}finally{Sn.EPSILON=r}}function DI(i){return Math.round(i/Sn.EPSILON)*Sn.EPSILON}function OI(i){return i.clone?i.clone():new Array(i.length)}function FI(i,e,t){if(pc(i)){const r=i;t=t||OI(r);for(let o=0;o<t.length&&o<r.length;++o){const c=typeof i=="number"?i:i[o];t[o]=e(c,o,t)}return t}return e(i)}class y1 extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}toArray(e=[],t=0){for(let r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:pc(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Sn)}formatString(e){let t="";for(let r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+kI(this[r],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!uh(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,r){if(r===void 0)return this.lerp(this,e,t);for(let o=0;o<this.ELEMENTS;++o){const c=e[o],f=typeof t=="number"?t:t[o];this[o]=c+r*(f-c)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}add(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=t[r];return this.check()}subtract(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=t[r];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Sn.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}get elements(){return this}}function LI(i,e){if(i.length!==e)return!1;for(let t=0;t<i.length;++t)if(!Number.isFinite(i[t]))return!1;return!0}function hn(i){if(!Number.isFinite(i))throw new Error(`Invalid number ${JSON.stringify(i)}`);return i}function pm(i,e,t=""){if(Sn.debug&&!LI(i,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return i}function tb(i,e){if(!i)throw new Error(`math.gl assertion ${e}`)}class BI extends y1{get x(){return this[0]}set x(e){this[0]=hn(e)}get y(){return this[1]}set y(e){this[1]=hn(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let r=0;r<this.ELEMENTS;++r){const o=this[r]-e[r];t+=o*o}return hn(t)}dot(e){let t=0;for(let r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return hn(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=t[r];return this.check()}divide(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=t[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return tb(e>=0&&e<this.ELEMENTS,"index is out of range"),hn(this[e])}setComponent(e,t){return tb(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const md=1e-6;let gc=typeof Float32Array<"u"?Float32Array:Array;function NI(){const i=new gc(2);return gc!=Float32Array&&(i[0]=0,i[1]=0),i}function ib(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}function zI(i,e){return i[0]=-e[0],i[1]=-e[1],i}function x1(i,e,t,r){const o=e[0],c=e[1];return i[0]=o+r*(t[0]-o),i[1]=c+r*(t[1]-c),i}function UI(i,e,t){const r=e[0],o=e[1];return i[0]=t[0]*r+t[4]*o+t[12],i[1]=t[1]*r+t[5]*o+t[13],i}(function(){const i=NI();return function(e,t,r,o,c,f){let a,y;for(t||(t=2),r||(r=0),o?y=Math.min(o*t+r,e.length):y=e.length,a=r;a<y;a+=t)i[0]=e[a],i[1]=e[a+1],c(i,i,f),e[a]=i[0],e[a+1]=i[1];return e}})();function VI(i,e,t){const r=e[0],o=e[1],c=t[3]*r+t[7]*o||1;return i[0]=(t[0]*r+t[4]*o)/c,i[1]=(t[1]*r+t[5]*o)/c,i}function v1(i,e,t){const r=e[0],o=e[1],c=e[2],f=t[3]*r+t[7]*o+t[11]*c||1;return i[0]=(t[0]*r+t[4]*o+t[8]*c)/f,i[1]=(t[1]*r+t[5]*o+t[9]*c)/f,i[2]=(t[2]*r+t[6]*o+t[10]*c)/f,i}function jI(i,e,t){const r=e[0],o=e[1];return i[0]=t[0]*r+t[2]*o,i[1]=t[1]*r+t[3]*o,i[2]=e[2],i}function $I(){const i=new gc(3);return gc!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function WI(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function HI(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i}function ZI(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function XI(i,e,t){const r=e[0],o=e[1],c=e[2],f=t[0],a=t[1],y=t[2];return i[0]=o*y-c*a,i[1]=c*f-r*y,i[2]=r*a-o*f,i}function b1(i,e,t){const r=e[0],o=e[1],c=e[2];let f=t[3]*r+t[7]*o+t[11]*c+t[15];return f=f||1,i[0]=(t[0]*r+t[4]*o+t[8]*c+t[12])/f,i[1]=(t[1]*r+t[5]*o+t[9]*c+t[13])/f,i[2]=(t[2]*r+t[6]*o+t[10]*c+t[14])/f,i}function qI(i,e,t){const r=e[0],o=e[1],c=e[2];return i[0]=r*t[0]+o*t[3]+c*t[6],i[1]=r*t[1]+o*t[4]+c*t[7],i[2]=r*t[2]+o*t[5]+c*t[8],i}function GI(i,e,t){const r=t[0],o=t[1],c=t[2],f=t[3],a=e[0],y=e[1],T=e[2];let A=o*T-c*y,M=c*a-r*T,F=r*y-o*a,L=o*F-c*M,Y=c*A-r*F,ae=r*M-o*A;const pe=f*2;return A*=pe,M*=pe,F*=pe,L*=2,Y*=2,ae*=2,i[0]=a+A+L,i[1]=y+M+Y,i[2]=T+F+ae,i}function YI(i,e,t,r){const o=[],c=[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],c[0]=o[0],c[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),c[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),i[0]=c[0]+t[0],i[1]=c[1]+t[1],i[2]=c[2]+t[2],i}function KI(i,e,t,r){const o=[],c=[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],c[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),c[1]=o[1],c[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),i[0]=c[0]+t[0],i[1]=c[1]+t[1],i[2]=c[2]+t[2],i}function JI(i,e,t,r){const o=[],c=[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],c[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),c[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),c[2]=o[2],i[0]=c[0]+t[0],i[1]=c[1]+t[1],i[2]=c[2]+t[2],i}function QI(i,e){const t=i[0],r=i[1],o=i[2],c=e[0],f=e[1],a=e[2],y=Math.sqrt((t*t+r*r+o*o)*(c*c+f*f+a*a)),T=y&&ZI(i,e)/y;return Math.acos(Math.min(Math.max(T,-1),1))}const eC=WI;(function(){const i=$I();return function(e,t,r,o,c,f){let a,y;for(t||(t=3),r||(r=0),o?y=Math.min(o*t+r,e.length):y=e.length,a=r;a<y;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],c(i,i,f),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2];return e}})();const gm=[0,0,0];let Jf;class ws extends BI{static get ZERO(){return Jf||(Jf=new ws(0,0,0),Object.freeze(Jf)),Jf}constructor(e=0,t=0,r=0){super(-0,-0,-0),arguments.length===1&&pc(e)?this.copy(e):(Sn.debug&&(hn(e),hn(t),hn(r)),this[0]=e,this[1]=t,this[2]=r)}set(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Sn.debug&&(hn(e.x),hn(e.y),hn(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=hn(e)}angle(e){return QI(this,e)}cross(e){return XI(this,this,e),this.check()}rotateX({radians:e,origin:t=gm}){return YI(this,this,t,e),this.check()}rotateY({radians:e,origin:t=gm}){return KI(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=gm}){return JI(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return b1(this,this,e),this.check()}transformAsVector(e){return v1(this,this,e),this.check()}transformByMatrix3(e){return qI(this,this,e),this.check()}transformByMatrix2(e){return jI(this,this,e),this.check()}transformByQuaternion(e){return GI(this,this,e),this.check()}}class tC extends y1{toString(){let e="[";if(Sn.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,r){return this[t*this.RANK+e]=hn(r),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let o=0;o<this.RANK;++o)t[o]=this[r+o];return t}setColumn(e,t){const r=e*this.RANK;for(let o=0;o<this.RANK;++o)this[r+o]=t[o];return this}}function iC(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function rC(i,e){if(i===e){const t=e[1],r=e[2],o=e[3],c=e[6],f=e[7],a=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=r,i[9]=c,i[11]=e[14],i[12]=o,i[13]=f,i[14]=a}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function o_(i,e){const t=e[0],r=e[1],o=e[2],c=e[3],f=e[4],a=e[5],y=e[6],T=e[7],A=e[8],M=e[9],F=e[10],L=e[11],Y=e[12],ae=e[13],pe=e[14],Ee=e[15],Be=t*a-r*f,xe=t*y-o*f,Ce=t*T-c*f,tt=r*y-o*a,Xe=r*T-c*a,gt=o*T-c*y,ft=A*ae-M*Y,yt=A*pe-F*Y,Bt=A*Ee-L*Y,Pt=M*pe-F*ae,Lt=M*Ee-L*ae,Dt=F*Ee-L*pe;let kt=Be*Dt-xe*Lt+Ce*Pt+tt*Bt-Xe*yt+gt*ft;return kt?(kt=1/kt,i[0]=(a*Dt-y*Lt+T*Pt)*kt,i[1]=(o*Lt-r*Dt-c*Pt)*kt,i[2]=(ae*gt-pe*Xe+Ee*tt)*kt,i[3]=(F*Xe-M*gt-L*tt)*kt,i[4]=(y*Bt-f*Dt-T*yt)*kt,i[5]=(t*Dt-o*Bt+c*yt)*kt,i[6]=(pe*Ce-Y*gt-Ee*xe)*kt,i[7]=(A*gt-F*Ce+L*xe)*kt,i[8]=(f*Lt-a*Bt+T*ft)*kt,i[9]=(r*Bt-t*Lt-c*ft)*kt,i[10]=(Y*Xe-ae*Ce+Ee*Be)*kt,i[11]=(M*Ce-A*Xe-L*Be)*kt,i[12]=(a*yt-f*Pt-y*ft)*kt,i[13]=(t*Pt-r*yt+o*ft)*kt,i[14]=(ae*xe-Y*tt-pe*Be)*kt,i[15]=(A*tt-M*xe+F*Be)*kt,i):null}function nC(i){const e=i[0],t=i[1],r=i[2],o=i[3],c=i[4],f=i[5],a=i[6],y=i[7],T=i[8],A=i[9],M=i[10],F=i[11],L=i[12],Y=i[13],ae=i[14],pe=i[15],Ee=e*f-t*c,Be=e*a-r*c,xe=t*a-r*f,Ce=T*Y-A*L,tt=T*ae-M*L,Xe=A*ae-M*Y,gt=e*Xe-t*tt+r*Ce,ft=c*Xe-f*tt+a*Ce,yt=T*xe-A*Be+M*Ee,Bt=L*xe-Y*Be+ae*Ee;return y*gt-o*ft+pe*yt-F*Bt}function ja(i,e,t){const r=e[0],o=e[1],c=e[2],f=e[3],a=e[4],y=e[5],T=e[6],A=e[7],M=e[8],F=e[9],L=e[10],Y=e[11],ae=e[12],pe=e[13],Ee=e[14],Be=e[15];let xe=t[0],Ce=t[1],tt=t[2],Xe=t[3];return i[0]=xe*r+Ce*a+tt*M+Xe*ae,i[1]=xe*o+Ce*y+tt*F+Xe*pe,i[2]=xe*c+Ce*T+tt*L+Xe*Ee,i[3]=xe*f+Ce*A+tt*Y+Xe*Be,xe=t[4],Ce=t[5],tt=t[6],Xe=t[7],i[4]=xe*r+Ce*a+tt*M+Xe*ae,i[5]=xe*o+Ce*y+tt*F+Xe*pe,i[6]=xe*c+Ce*T+tt*L+Xe*Ee,i[7]=xe*f+Ce*A+tt*Y+Xe*Be,xe=t[8],Ce=t[9],tt=t[10],Xe=t[11],i[8]=xe*r+Ce*a+tt*M+Xe*ae,i[9]=xe*o+Ce*y+tt*F+Xe*pe,i[10]=xe*c+Ce*T+tt*L+Xe*Ee,i[11]=xe*f+Ce*A+tt*Y+Xe*Be,xe=t[12],Ce=t[13],tt=t[14],Xe=t[15],i[12]=xe*r+Ce*a+tt*M+Xe*ae,i[13]=xe*o+Ce*y+tt*F+Xe*pe,i[14]=xe*c+Ce*T+tt*L+Xe*Ee,i[15]=xe*f+Ce*A+tt*Y+Xe*Be,i}function qd(i,e,t){const r=t[0],o=t[1],c=t[2];let f,a,y,T,A,M,F,L,Y,ae,pe,Ee;return e===i?(i[12]=e[0]*r+e[4]*o+e[8]*c+e[12],i[13]=e[1]*r+e[5]*o+e[9]*c+e[13],i[14]=e[2]*r+e[6]*o+e[10]*c+e[14],i[15]=e[3]*r+e[7]*o+e[11]*c+e[15]):(f=e[0],a=e[1],y=e[2],T=e[3],A=e[4],M=e[5],F=e[6],L=e[7],Y=e[8],ae=e[9],pe=e[10],Ee=e[11],i[0]=f,i[1]=a,i[2]=y,i[3]=T,i[4]=A,i[5]=M,i[6]=F,i[7]=L,i[8]=Y,i[9]=ae,i[10]=pe,i[11]=Ee,i[12]=f*r+A*o+Y*c+e[12],i[13]=a*r+M*o+ae*c+e[13],i[14]=y*r+F*o+pe*c+e[14],i[15]=T*r+L*o+Ee*c+e[15]),i}function ry(i,e,t){const r=t[0],o=t[1],c=t[2];return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i[4]=e[4]*o,i[5]=e[5]*o,i[6]=e[6]*o,i[7]=e[7]*o,i[8]=e[8]*c,i[9]=e[9]*c,i[10]=e[10]*c,i[11]=e[11]*c,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function sC(i,e,t,r){let o=r[0],c=r[1],f=r[2],a=Math.sqrt(o*o+c*c+f*f),y,T,A,M,F,L,Y,ae,pe,Ee,Be,xe,Ce,tt,Xe,gt,ft,yt,Bt,Pt,Lt,Dt,kt,ji;return a<md?null:(a=1/a,o*=a,c*=a,f*=a,T=Math.sin(t),y=Math.cos(t),A=1-y,M=e[0],F=e[1],L=e[2],Y=e[3],ae=e[4],pe=e[5],Ee=e[6],Be=e[7],xe=e[8],Ce=e[9],tt=e[10],Xe=e[11],gt=o*o*A+y,ft=c*o*A+f*T,yt=f*o*A-c*T,Bt=o*c*A-f*T,Pt=c*c*A+y,Lt=f*c*A+o*T,Dt=o*f*A+c*T,kt=c*f*A-o*T,ji=f*f*A+y,i[0]=M*gt+ae*ft+xe*yt,i[1]=F*gt+pe*ft+Ce*yt,i[2]=L*gt+Ee*ft+tt*yt,i[3]=Y*gt+Be*ft+Xe*yt,i[4]=M*Bt+ae*Pt+xe*Lt,i[5]=F*Bt+pe*Pt+Ce*Lt,i[6]=L*Bt+Ee*Pt+tt*Lt,i[7]=Y*Bt+Be*Pt+Xe*Lt,i[8]=M*Dt+ae*kt+xe*ji,i[9]=F*Dt+pe*kt+Ce*ji,i[10]=L*Dt+Ee*kt+tt*ji,i[11]=Y*Dt+Be*kt+Xe*ji,e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i)}function w1(i,e,t){const r=Math.sin(t),o=Math.cos(t),c=e[4],f=e[5],a=e[6],y=e[7],T=e[8],A=e[9],M=e[10],F=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=c*o+T*r,i[5]=f*o+A*r,i[6]=a*o+M*r,i[7]=y*o+F*r,i[8]=T*o-c*r,i[9]=A*o-f*r,i[10]=M*o-a*r,i[11]=F*o-y*r,i}function oC(i,e,t){const r=Math.sin(t),o=Math.cos(t),c=e[0],f=e[1],a=e[2],y=e[3],T=e[8],A=e[9],M=e[10],F=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=c*o-T*r,i[1]=f*o-A*r,i[2]=a*o-M*r,i[3]=y*o-F*r,i[8]=c*r+T*o,i[9]=f*r+A*o,i[10]=a*r+M*o,i[11]=y*r+F*o,i}function T1(i,e,t){const r=Math.sin(t),o=Math.cos(t),c=e[0],f=e[1],a=e[2],y=e[3],T=e[4],A=e[5],M=e[6],F=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=c*o+T*r,i[1]=f*o+A*r,i[2]=a*o+M*r,i[3]=y*o+F*r,i[4]=T*o-c*r,i[5]=A*o-f*r,i[6]=M*o-a*r,i[7]=F*o-y*r,i}function aC(i,e){const t=e[0],r=e[1],o=e[2],c=e[3],f=t+t,a=r+r,y=o+o,T=t*f,A=r*f,M=r*a,F=o*f,L=o*a,Y=o*y,ae=c*f,pe=c*a,Ee=c*y;return i[0]=1-M-Y,i[1]=A+Ee,i[2]=F-pe,i[3]=0,i[4]=A-Ee,i[5]=1-T-Y,i[6]=L+ae,i[7]=0,i[8]=F+pe,i[9]=L-ae,i[10]=1-T-M,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function lC(i,e,t,r,o,c,f){const a=1/(t-e),y=1/(o-r),T=1/(c-f);return i[0]=c*2*a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=c*2*y,i[6]=0,i[7]=0,i[8]=(t+e)*a,i[9]=(o+r)*y,i[10]=(f+c)*T,i[11]=-1,i[12]=0,i[13]=0,i[14]=f*c*2*T,i[15]=0,i}function cC(i,e,t,r,o){const c=1/Math.tan(e/2);if(i[0]=c/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=c,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,o!=null&&o!==1/0){const f=1/(r-o);i[10]=(o+r)*f,i[14]=2*o*r*f}else i[10]=-1,i[14]=-2*r;return i}const uC=cC;function hC(i,e,t,r,o,c,f){const a=1/(e-t),y=1/(r-o),T=1/(c-f);return i[0]=-2*a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*y,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*T,i[11]=0,i[12]=(e+t)*a,i[13]=(o+r)*y,i[14]=(f+c)*T,i[15]=1,i}const fC=hC;function dC(i,e,t,r){let o,c,f,a,y,T,A,M,F,L;const Y=e[0],ae=e[1],pe=e[2],Ee=r[0],Be=r[1],xe=r[2],Ce=t[0],tt=t[1],Xe=t[2];return Math.abs(Y-Ce)<md&&Math.abs(ae-tt)<md&&Math.abs(pe-Xe)<md?iC(i):(M=Y-Ce,F=ae-tt,L=pe-Xe,o=1/Math.sqrt(M*M+F*F+L*L),M*=o,F*=o,L*=o,c=Be*L-xe*F,f=xe*M-Ee*L,a=Ee*F-Be*M,o=Math.sqrt(c*c+f*f+a*a),o?(o=1/o,c*=o,f*=o,a*=o):(c=0,f=0,a=0),y=F*a-L*f,T=L*c-M*a,A=M*f-F*c,o=Math.sqrt(y*y+T*T+A*A),o?(o=1/o,y*=o,T*=o,A*=o):(y=0,T=0,A=0),i[0]=c,i[1]=y,i[2]=M,i[3]=0,i[4]=f,i[5]=T,i[6]=F,i[7]=0,i[8]=a,i[9]=A,i[10]=L,i[11]=0,i[12]=-(c*Y+f*ae+a*pe),i[13]=-(y*Y+T*ae+A*pe),i[14]=-(M*Y+F*ae+L*pe),i[15]=1,i)}function pC(){const i=new gc(4);return gc!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function gC(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i}function wh(i,e,t){const r=e[0],o=e[1],c=e[2],f=e[3];return i[0]=t[0]*r+t[4]*o+t[8]*c+t[12]*f,i[1]=t[1]*r+t[5]*o+t[9]*c+t[13]*f,i[2]=t[2]*r+t[6]*o+t[10]*c+t[14]*f,i[3]=t[3]*r+t[7]*o+t[11]*c+t[15]*f,i}(function(){const i=pC();return function(e,t,r,o,c,f){let a,y;for(t||(t=4),r||(r=0),o?y=Math.min(o*t+r,e.length):y=e.length,a=r;a<y;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],i[3]=e[a+3],c(i,i,f),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2],e[a+3]=i[3];return e}})();var a_;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL0ROW3=3]="COL0ROW3",i[i.COL1ROW0=4]="COL1ROW0",i[i.COL1ROW1=5]="COL1ROW1",i[i.COL1ROW2=6]="COL1ROW2",i[i.COL1ROW3=7]="COL1ROW3",i[i.COL2ROW0=8]="COL2ROW0",i[i.COL2ROW1=9]="COL2ROW1",i[i.COL2ROW2=10]="COL2ROW2",i[i.COL2ROW3=11]="COL2ROW3",i[i.COL3ROW0=12]="COL3ROW0",i[i.COL3ROW1=13]="COL3ROW1",i[i.COL3ROW2=14]="COL3ROW2",i[i.COL3ROW3=15]="COL3ROW3"})(a_||(a_={}));const mC=45*Math.PI/180,_C=1,mm=.1,_m=500,yC=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Ts extends tC{static get IDENTITY(){return vC()}static get ZERO(){return xC()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return a_}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,r,o,c,f,a,y,T,A,M,F,L,Y,ae,pe){return this[0]=e,this[1]=t,this[2]=r,this[3]=o,this[4]=c,this[5]=f,this[6]=a,this[7]=y,this[8]=T,this[9]=A,this[10]=M,this[11]=F,this[12]=L,this[13]=Y,this[14]=ae,this[15]=pe,this.check()}setRowMajor(e,t,r,o,c,f,a,y,T,A,M,F,L,Y,ae,pe){return this[0]=e,this[1]=c,this[2]=T,this[3]=L,this[4]=t,this[5]=f,this[6]=A,this[7]=Y,this[8]=r,this[9]=a,this[10]=M,this[11]=ae,this[12]=o,this[13]=y,this[14]=F,this[15]=pe,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(yC)}fromObject(e){return this.check()}fromQuaternion(e){return aC(this,e),this.check()}frustum(e){const{left:t,right:r,bottom:o,top:c,near:f=mm,far:a=_m}=e;return a===1/0?bC(this,t,r,o,c,f):lC(this,t,r,o,c,f,a),this.check()}lookAt(e){const{eye:t,center:r=[0,0,0],up:o=[0,1,0]}=e;return dC(this,t,r,o),this.check()}ortho(e){const{left:t,right:r,bottom:o,top:c,near:f=mm,far:a=_m}=e;return fC(this,t,r,o,c,f,a),this.check()}orthographic(e){const{fovy:t=mC,aspect:r=_C,focalDistance:o=1,near:c=mm,far:f=_m}=e;rb(t);const a=t/2,y=o*Math.tan(a),T=y*r;return this.ortho({left:-T,right:T,bottom:-y,top:y,near:c,far:f})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:r=1,near:o=.1,far:c=500}=e;return rb(t),uC(this,t,r,o,c),this.check()}determinant(){return nC(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),o=1/r[0],c=1/r[1],f=1/r[2];return e[0]=this[0]*o,e[1]=this[1]*c,e[2]=this[2]*f,e[3]=0,e[4]=this[4]*o,e[5]=this[5]*c,e[6]=this[6]*f,e[7]=0,e[8]=this[8]*o,e[9]=this[9]*c,e[10]=this[10]*f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),o=1/r[0],c=1/r[1],f=1/r[2];return e[0]=this[0]*o,e[1]=this[1]*c,e[2]=this[2]*f,e[3]=this[4]*o,e[4]=this[5]*c,e[5]=this[6]*f,e[6]=this[8]*o,e[7]=this[9]*c,e[8]=this[10]*f,e}transpose(){return rC(this,this),this.check()}invert(){return o_(this,this),this.check()}multiplyLeft(e){return ja(this,e,this),this.check()}multiplyRight(e){return ja(this,this,e),this.check()}rotateX(e){return w1(this,this,e),this.check()}rotateY(e){return oC(this,this,e),this.check()}rotateZ(e){return T1(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return sC(this,this,e,t),this.check()}scale(e){return ry(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return qd(this,this,e),this.check()}transform(e,t){return e.length===4?(t=wh(t||[-0,-0,-0,-0],e,this),pm(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:r}=e;let o;switch(r){case 2:o=UI(t||[-0,-0],e,this);break;case 3:o=b1(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return pm(o,e.length),o}transformAsVector(e,t){let r;switch(e.length){case 2:r=VI(t||[-0,-0],e,this);break;case 3:r=v1(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return pm(r,e.length),r}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,r){return this.identity().translate([e,t,r])}}let Qf,ed;function xC(){return Qf||(Qf=new Ts([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(Qf)),Qf}function vC(){return ed||(ed=new Ts,Object.freeze(ed)),ed}function rb(i){if(i>Math.PI*2)throw Error("expected radians")}function bC(i,e,t,r,o,c){const f=2*c/(t-e),a=2*c/(o-r),y=(t+e)/(t-e),T=(o+r)/(o-r),A=-1,M=-1,F=-2*c;return i[0]=f,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a,i[6]=0,i[7]=0,i[8]=y,i[9]=T,i[10]=A,i[11]=M,i[12]=0,i[13]=0,i[14]=F,i[15]=0,i}function S1(i,e=[],t=0){const r=Math.fround(i),o=i-r;return e[t]=r,e[t+1]=o,e}function wC(i){return i-Math.fround(i)}function TC(i){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let r=0;r<4;++r){const o=t*4+r;S1(i[r*4+t],e,o*2)}return e}const SC=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,AC={name:"fp32",vs:SC},PC=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,EC={ONE:1},IC={name:"fp64arithmetic",vs:PC,defaultUniforms:EC,uniformTypes:{ONE:"f32"},fp64ify:S1,fp64LowPart:wC,fp64ifyMatrix4:TC},CC=[0,1,1,1],MC=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,RC=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,nb={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:CC},vs:MC,fs:RC,getUniforms:kC};function kC(i={},e){const t={};if(i.highlightedObjectColor!==void 0)if(i.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const r=i.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=r}if(i.highlightColor){const r=Array.from(i.highlightColor,o=>o/255);Number.isFinite(r[3])||(r[3]=1),t.highlightColor=r}return i.isActive!==void 0&&(t.isActive=!!i.isActive,t.isAttribute=!!i.isAttribute),i.useFloatColors!==void 0&&(t.useFloatColors=!!i.useFloatColors),t}const sb=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,DC=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  poightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,A1=3,OC=255;var hh;(function(i){i[i.POINT=0]="POINT",i[i.DIRECTIONAL=1]="DIRECTIONAL"})(hh||(hh={}));const _d={props:{},uniforms:{},name:"lighting",defines:{MAX_LIGHTS:A1},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientLightColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:hh.POINT,directionalLightCount:0,pointLightCount:0,ambientLightColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:DC,vs:sb,fs:sb,getUniforms:FC};function FC(i,e={}){if(i=i&&{...i},!i)return{..._d.defaultUniforms};i.lights&&(i={...i,...BC(i.lights),lights:void 0});const{ambientLight:t,pointLights:r,directionalLights:o}=i||{};if(!(t||r&&r.length>0||o&&o.length>0))return{..._d.defaultUniforms,enabled:0};const f={..._d.defaultUniforms,...e,...LC({ambientLight:t,pointLights:r,directionalLights:o})};return i.enabled!==void 0&&(f.enabled=i.enabled?1:0),f}function LC({ambientLight:i,pointLights:e=[],directionalLights:t=[]}){const r={};r.ambientLightColor=ym(i);let o=0;for(const c of e){r.lightType=hh.POINT;const f=o;r[`lightColor${f}`]=ym(c),r[`lightPosition${f}`]=c.position,r[`lightAttenuation${f}`]=c.attenuation||[1,0,0],o++}for(const c of t){r.lightType=hh.DIRECTIONAL;const f=o;r[`lightColor${f}`]=ym(c),r[`lightDirection${f}`]=c.direction,o++}return o>A1&&ut.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=t.length,r.pointLightCount=e.length,r}function BC(i){var t,r;const e={pointLights:[],directionalLights:[]};for(const o of i||[])switch(o.type){case"ambient":e.ambientLight=o;break;case"directional":(t=e.directionalLights)==null||t.push(o);break;case"point":(r=e.pointLights)==null||r.push(o);break}return e}function ym(i={}){const{color:e=[0,0,0],intensity:t=1}=i;return e.map(r=>r*t/OC)}const NC=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,zC=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,P1={props:{},name:"gouraudMaterial",vs:zC.replace("phongMaterial","gouraudMaterial"),fs:NC.replace("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:1},dependencies:[_d],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(i){const e={...i};return e.specularColor&&(e.specularColor=e.specularColor.map(t=>t/255)),{...P1.defaultUniforms,...e}}},ob=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,UC={name:"layer",vs:ob,fs:ob,getUniforms:i=>({opacity:Math.pow(i.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},VC=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,E1="#define SMOOTH_EDGE_RADIUS 0.5",jC=`${E1}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,$C=`${E1}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,I1={name:"geometry",source:VC,vs:jC,fs:$C},WC=25;var lr;(function(i){i[i.Start=1]="Start",i[i.Move=2]="Move",i[i.End=4]="End",i[i.Cancel=8]="Cancel"})(lr||(lr={}));var gr;(function(i){i[i.None=0]="None",i[i.Left=1]="Left",i[i.Right=2]="Right",i[i.Up=4]="Up",i[i.Down=8]="Down",i[i.Horizontal=3]="Horizontal",i[i.Vertical=12]="Vertical",i[i.All=15]="All"})(gr||(gr={}));var $t;(function(i){i[i.Possible=1]="Possible",i[i.Began=2]="Began",i[i.Changed=4]="Changed",i[i.Ended=8]="Ended",i[i.Recognized=8]="Recognized",i[i.Cancelled=16]="Cancelled",i[i.Failed=32]="Failed"})($t||($t={}));const HC="compute",ZC="auto",l_="manipulation",yd="none",c_="pan-x",u_="pan-y";function XC(i){if(i.includes(yd))return yd;const e=i.includes(c_),t=i.includes(u_);return e&&t?yd:e||t?e?c_:u_:i.includes(l_)?l_:ZC}class qC{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===HC&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return XC(e.join(" "))}}function Gd(i){return i.trim().split(/\s+/g)}function xm(i,e,t){if(i)for(const r of Gd(e))i.addEventListener(r,t,!1)}function vm(i,e,t){if(i)for(const r of Gd(e))i.removeEventListener(r,t,!1)}function ab(i){return(i.ownerDocument||i).defaultView}function GC(i,e){let t=i;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function C1(i){const e=i.length;if(e===1)return{x:Math.round(i[0].clientX),y:Math.round(i[0].clientY)};let t=0,r=0,o=0;for(;o<e;)t+=i[o].clientX,r+=i[o].clientY,o++;return{x:Math.round(t/e),y:Math.round(r/e)}}function lb(i){const e=[];let t=0;for(;t<i.pointers.length;)e[t]={clientX:Math.round(i.pointers[t].clientX),clientY:Math.round(i.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:C1(e),deltaX:i.deltaX,deltaY:i.deltaY}}function M1(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.sqrt(t*t+r*r)}function cb(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.sqrt(t*t+r*r)}function YC(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.atan2(r,t)*180/Math.PI}function ub(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.atan2(r,t)*180/Math.PI}function R1(i,e){return i===e?gr.None:Math.abs(i)>=Math.abs(e)?i<0?gr.Left:gr.Right:e<0?gr.Up:gr.Down}function KC(i,e){const t=e.center;let r=i.offsetDelta,o=i.prevDelta;const c=i.prevInput;return(e.eventType===lr.Start||(c==null?void 0:c.eventType)===lr.End)&&(o=i.prevDelta={x:(c==null?void 0:c.deltaX)||0,y:(c==null?void 0:c.deltaY)||0},r=i.offsetDelta={x:t.x,y:t.y}),{deltaX:o.x+(t.x-r.x),deltaY:o.y+(t.y-r.y)}}function k1(i,e,t){return{x:e/i||0,y:t/i||0}}function JC(i,e){return cb(e[0],e[1])/cb(i[0],i[1])}function QC(i,e){return ub(e[1],e[0])-ub(i[1],i[0])}function eM(i,e){const t=i.lastInterval||e,r=e.timeStamp-t.timeStamp;let o,c,f,a;if(e.eventType!==lr.Cancel&&(r>WC||t.velocity===void 0)){const y=e.deltaX-t.deltaX,T=e.deltaY-t.deltaY,A=k1(r,y,T);c=A.x,f=A.y,o=Math.abs(A.x)>Math.abs(A.y)?A.x:A.y,a=R1(y,T),i.lastInterval=e}else o=t.velocity,c=t.velocityX,f=t.velocityY,a=t.direction;e.velocity=o,e.velocityX=c,e.velocityY=f,e.direction=a}function tM(i,e){const{session:t}=i,{pointers:r}=e,{length:o}=r;t.firstInput||(t.firstInput=lb(e)),o>1&&!t.firstMultiple?t.firstMultiple=lb(e):o===1&&(t.firstMultiple=!1);const{firstInput:c,firstMultiple:f}=t,a=f?f.center:c.center,y=e.center=C1(r);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-c.timeStamp,e.angle=YC(a,y),e.distance=M1(a,y);const{deltaX:T,deltaY:A}=KC(t,e);e.deltaX=T,e.deltaY=A,e.offsetDirection=R1(e.deltaX,e.deltaY);const M=k1(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=M.x,e.overallVelocityY=M.y,e.overallVelocity=Math.abs(M.x)>Math.abs(M.y)?M.x:M.y,e.scale=f?JC(f.pointers,r):1,e.rotation=f?QC(f.pointers,r):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let F=i.element;return GC(e.srcEvent.target,F)&&(F=e.srcEvent.target),e.target=F,eM(t,e),e}function iM(i,e,t){const r=t.pointers.length,o=t.changedPointers.length,c=e&lr.Start&&r-o===0,f=e&(lr.End|lr.Cancel)&&r-o===0;t.isFirst=!!c,t.isFinal=!!f,c&&(i.session={}),t.eventType=e;const a=tM(i,t);i.emit("hammer.input",a),i.recognize(a),i.session.prevInput=a}let rM=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){iM(this.manager,e,t)}init(){xm(this.element,this.evEl,this.domHandler),xm(this.target,this.evTarget,this.domHandler),xm(ab(this.element),this.evWin,this.domHandler)}destroy(){vm(this.element,this.evEl,this.domHandler),vm(this.target,this.evTarget,this.domHandler),vm(ab(this.element),this.evWin,this.domHandler)}};const nM={pointerdown:lr.Start,pointermove:lr.Move,pointerup:lr.End,pointercancel:lr.Cancel,pointerout:lr.Cancel},sM="pointerdown",oM="pointermove pointerup pointercancel";class aM extends rM{constructor(e){super(e),this.evEl=sM,this.evWin=oM,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let r=!1;const o=nM[e.type],c=e.pointerType,f=c==="touch";let a=t.findIndex(y=>y.pointerId===e.pointerId);o&lr.Start&&(e.buttons||f)?a<0&&(t.push(e),a=t.length-1):o&(lr.End|lr.Cancel)&&(r=!0),!(a<0)&&(t[a]=e,this.callback(o,{pointers:t,changedPointers:[e],eventType:o,pointerType:c,srcEvent:e}),r&&t.splice(a,1))}}const lM=["","webkit","Moz","MS","ms","o"];function cM(i,e){const t=e[0].toUpperCase()+e.slice(1);for(const r of lM){const o=r?r+t:e;if(o in i)return o}}const uM=1,hb=2,fb={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class hM{constructor(e,t){this.options={...fb,...t,cssProps:{...fb.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new aM(this),this.touchAction=new qC(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?hb:uM}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let r;const{recognizers:o}=this;let{curRecognizer:c}=t;(!c||c&&c.state&$t.Recognized)&&(c=t.curRecognizer=null);let f=0;for(;f<o.length;)r=o[f],t.stopped!==hb&&(!c||r===c||r.canRecognizeWith(c))?r.recognize(e):r.reset(),!c&&r.state&($t.Began|$t.Changed|$t.Ended)&&(c=t.curRecognizer=r),f++}get(e){const{recognizers:t}=this;for(let r=0;r<t.length;r++)if(t[r].options.event===e)return t[r];return null}add(e){if(Array.isArray(e)){for(const r of e)this.add(r);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const r of e)this.remove(r);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:r}=this,o=r.indexOf(t);o!==-1&&(r.splice(o,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:r}=this;for(const o of Gd(e))r[o]=r[o]||[],r[o].push(t)}off(e,t){if(!e)return;const{handlers:r}=this;for(const o of Gd(e))t?r[o]&&r[o].splice(r[o].indexOf(t),1):delete r[o]}emit(e,t){const r=this.handlers[e]&&this.handlers[e].slice();if(!r||!r.length)return;const o=t;o.type=e,o.preventDefault=function(){t.srcEvent.preventDefault()};let c=0;for(;c<r.length;)r[c](o),c++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[r,o]of Object.entries(this.options.cssProps)){const c=cM(t.style,r);e?(this.oldCssProps[c]=t.style[c],t.style[c]=o):t.style[c]=this.oldCssProps[c]||""}e||(this.oldCssProps={})}}}let fM=1;function dM(){return fM++}function db(i){return i&$t.Cancelled?"cancel":i&$t.Ended?"end":i&$t.Changed?"move":i&$t.Began?"start":""}class D1{constructor(e){this.options=e,this.id=dM(),this.state=$t.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const o of e)this.recognizeWith(o);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:r}=this;return r[t.id]||(r[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const r of e)this.dropRecognizeWith(r);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const o of e)this.requireFailure(o);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:r}=this;return r.indexOf(t)===-1&&(r.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const r of e)this.dropRequireFailure(r);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const r=this.requireFail.indexOf(t);r>-1&&this.requireFail.splice(r,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<$t.Ended&&this.manager.emit(this.options.event+db(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=$t.Ended&&this.manager.emit(this.options.event+db(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=$t.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&($t.Failed|$t.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=$t.Failed;return}this.state&($t.Recognized|$t.Cancelled|$t.Failed)&&(this.state=$t.Possible),this.state=this.process(t),this.state&($t.Began|$t.Changed|$t.Ended|$t.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class O1 extends D1{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:r}=e,o=t&($t.Began|$t.Changed),c=this.attrTest(e);return o&&(r&lr.Cancel||!c)?t|$t.Cancelled:o||c?r&lr.End?t|$t.Ended:t&$t.Began?t|$t.Changed:$t.Began:$t.Failed}}class pb extends D1{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[l_]}process(e){const{options:t}=this,r=e.pointers.length===t.pointers,o=e.distance<t.threshold,c=e.deltaTime<t.time;if(this.reset(),e.eventType&lr.Start&&this.count===0)return this.failTimeout();if(o&&c&&r){if(e.eventType!==lr.End)return this.failTimeout();const f=this.pTime?e.timeStamp-this.pTime<t.interval:!0,a=!this.pCenter||M1(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!a||!f?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=$t.Recognized,this.tryEmit(this._input)},t.interval),$t.Began):$t.Recognized}return $t.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=$t.Failed},this.options.interval),$t.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===$t.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const pM=["","start","move","end","cancel","up","down","left","right"];class gb extends O1{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:gr.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&gr.Horizontal&&t.push(u_),e&gr.Vertical&&t.push(c_),t}getEventNames(){return pM.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let r=!0,{distance:o}=e,{direction:c}=e;const f=e.deltaX,a=e.deltaY;return c&t.direction||(t.direction&gr.Horizontal?(c=f===0?gr.None:f<0?gr.Left:gr.Right,r=f!==this.pX,o=Math.abs(e.deltaX)):(c=a===0?gr.None:a<0?gr.Up:gr.Down,r=a!==this.pY,o=Math.abs(e.deltaY))),e.direction=c,r&&o>t.threshold&&!!(c&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&$t.Began)||!(this.state&$t.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=gr[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const gM=["","start","move","end","cancel","in","out"];class mM extends O1{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[yd]}getEventNames(){return gM.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&$t.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class Mp{constructor(e,t,r){this.element=e,this.callback=t,this.options=r}}const _M=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",yM=_M.indexOf("firefox")!==-1,mb=4.000244140625,xM=40,vM=.25;class bM extends Mp{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=o=>{if(!this.options.enable)return;let c=o.deltaY;globalThis.WheelEvent&&(yM&&o.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(c/=globalThis.devicePixelRatio),o.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(c*=xM)),c!==0&&c%mb===0&&(c=Math.floor(c/mb)),o.shiftKey&&c&&(c=c*vM),this.callback({type:"wheel",center:{x:o.clientX,y:o.clientY},delta:-c,srcEvent:o,pointerType:"mouse",target:o.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const _b=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class wM extends Mp{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=c=>{this.handleOverEvent(c),this.handleOutEvent(c),this.handleEnterEvent(c),this.handleLeaveEvent(c),this.handleMoveEvent(c)},this.pressed=!1;const{enable:o}=this.options;this.enableMoveEvent=o,this.enableLeaveEvent=o,this.enableEnterEvent=o,this.enableOutEvent=o,this.enableOverEvent=o,_b.forEach(c=>e.addEventListener(c,this.handleEvent))}destroy(){_b.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const yb=["keydown","keyup"];class TM extends Mp{constructor(e,t,r){super(e,t,{enable:!0,tabIndex:0,...r}),this.handleEvent=o=>{const c=o.target||o.srcElement;c.tagName==="INPUT"&&c.type==="text"||c.tagName==="TEXTAREA"||(this.enableDownEvent&&o.type==="keydown"&&this.callback({type:"keydown",srcEvent:o,key:o.key,target:o.target}),this.enableUpEvent&&o.type==="keyup"&&this.callback({type:"keyup",srcEvent:o,key:o.key,target:o.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",yb.forEach(o=>e.addEventListener(o,this.handleEvent))}destroy(){yb.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class SM extends Mp{constructor(e,t,r){super(e,t,r),this.handleEvent=o=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:o.clientX,y:o.clientY},srcEvent:o,pointerType:"mouse",target:o.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const xb=1,h_=2,vb=4,AM={pointerdown:xb,pointermove:h_,pointerup:vb,mousedown:xb,mousemove:h_,mouseup:vb},PM=0,EM=1,IM=2,CM=1,MM=2,RM=4;function kM(i){const e=AM[i.srcEvent.type];if(!e)return null;const{buttons:t,button:r}=i.srcEvent;let o=!1,c=!1,f=!1;return e===h_?(o=!!(t&CM),c=!!(t&RM),f=!!(t&MM)):(o=r===PM,c=r===EM,f=r===IM),{leftButton:o,middleButton:c,rightButton:f}}function DM(i,e){const t=i.center;if(!t)return null;const r=e.getBoundingClientRect(),o=r.width/e.offsetWidth||1,c=r.height/e.offsetHeight||1,f={x:(t.x-r.left-e.clientLeft)/o,y:(t.y-r.top-e.clientTop)/c};return{center:t,offsetCenter:f}}const OM={srcElement:"root",priority:0};class FM{constructor(e,t){this.handleEvent=r=>{if(this.isEmpty())return;const o=this._normalizeEvent(r);let c=r.srcEvent.target;for(;c&&c!==o.rootElement;){if(this._emit(o,c),o.handled)return;c=c.parentNode}this._emit(o,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,r,o=!1,c=!1){const{handlers:f,handlersByElement:a}=this,y={...OM,...r};let T=a.get(y.srcElement);T||(T=[],a.set(y.srcElement,T));const A={type:e,handler:t,srcElement:y.srcElement,priority:y.priority};o&&(A.once=!0),c&&(A.passive=!0),f.push(A),this._active=this._active||!A.passive;let M=T.length-1;for(;M>=0&&!(T[M].priority>=A.priority);)M--;T.splice(M+1,0,A)}remove(e,t){const{handlers:r,handlersByElement:o}=this;for(let c=r.length-1;c>=0;c--){const f=r[c];if(f.type===e&&f.handler===t){r.splice(c,1);const a=o.get(f.srcElement);a.splice(a.indexOf(f),1),a.length===0&&o.delete(f.srcElement)}}this._active=r.some(c=>!c.passive)}_emit(e,t){const r=this.handlersByElement.get(t);if(r){let o=!1;const c=()=>{e.handled=!0},f=()=>{e.handled=!0,o=!0},a=[];for(let y=0;y<r.length;y++){const{type:T,handler:A,once:M}=r[y];if(A({...e,type:T,stopPropagation:c,stopImmediatePropagation:f}),M&&a.push(r[y]),o)break}for(let y=0;y<a.length;y++){const{type:T,handler:A}=a[y];this.remove(T,A)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...kM(e),...DM(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function LM(i){if("recognizer"in i)return i;let e;const t=Array.isArray(i)?[...i]:[i];if(typeof t[0]=="function"){const r=t.shift(),o=t.shift()||{};e=new r(o)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class BM{constructor(e=null,t={}){if(this._onBasicInput=r=>{this.manager.emit(r.srcEvent.type,r)},this._onOtherEvent=r=>{this.manager.emit(r.type,r)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new hM(e,this.options);for(const r of this.options.recognizers){const{recognizer:o,recognizeWith:c,requireFailure:f}=LM(r);this.manager.add(o),c&&o.recognizeWith(c),f&&o.requireFailure(f)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new bM(e,this._onOtherEvent,{enable:!1}),this.moveInput=new wM(e,this._onOtherEvent,{enable:!1}),this.keyInput=new TM(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new SM(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,r){this._addEventHandler(e,t,r,!1)}once(e,t,r){this._addEventHandler(e,t,r,!0)}watch(e,t,r){this._addEventHandler(e,t,r,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){var c,f,a,y;const{manager:r}=this;if(!r)return;const o=r.get(e);o&&(o.set({enable:t}),r.touchAction.update()),(c=this.wheelInput)==null||c.enableEventType(e,t),(f=this.moveInput)==null||f.enableEventType(e,t),(a=this.keyInput)==null||a.enableEventType(e,t),(y=this.contextmenuInput)==null||y.enableEventType(e,t)}_addEventHandler(e,t,r,o,c){if(typeof e!="string"){r=t;for(const[T,A]of Object.entries(e))this._addEventHandler(T,A,r,o,c);return}const{manager:f,events:a}=this;if(!f)return;let y=a.get(e);if(!y){const T=this._getRecognizerName(e)||e;y=new FM(this,T),a.set(e,y),f&&f.on(e,y.handleEvent)}y.add(e,t,r,o,c),y.isEmpty()||this._toggleRecognizer(y.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[c,f]of Object.entries(e))this._removeEventHandler(c,f);return}const{events:r}=this,o=r.get(e);if(o&&(o.remove(e,t),o.isEmpty())){const{recognizerName:c}=o;let f=!1;for(const a of r.values())if(a.recognizerName===c&&!a.isEmpty()){f=!0;break}f||this._toggleRecognizer(c,!1)}}_getRecognizerName(e){var t;return(t=this.manager.recognizers.find(r=>r.getEventNames().includes(e)))==null?void 0:t.options.event}}const oi={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(oi,"IDENTITY",{get:()=>(ri.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const wn={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Ss={common:0,meters:1,pixels:2},f_={click:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},bb={multipan:[gb,{threshold:10,direction:gr.Vertical,pointers:2}],pinch:[mM,{},null,["multipan"]],pan:[gb,{threshold:1},["pinch"],["multipan"]],dblclick:[pb,{event:"dblclick",taps:2}],click:[pb,{event:"click"},null,["dblclick"]]};function NM(i,e){if(i===e)return!0;if(Array.isArray(i)){const t=i.length;if(!e||e.length!==t)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}return!1}function Th(i){let e={},t;return r=>{for(const o in r)if(!NM(r[o],e[o])){t=i(r),e=r;break}return t}}const wb=[0,0,0,0],zM=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],F1=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],UM=[0,0,0],L1=[0,0,0],VM=Th(WM);function B1(i,e,t=L1){t.length<3&&(t=[t[0],t[1],0]);let r=t,o,c=!0;switch(e===oi.LNGLAT_OFFSETS||e===oi.METER_OFFSETS?o=t:o=i.isGeospatial?[Math.fround(i.longitude),Math.fround(i.latitude),0]:null,i.projectionMode){case wn.WEB_MERCATOR:(e===oi.LNGLAT||e===oi.CARTESIAN)&&(o=[0,0,0],c=!1);break;case wn.WEB_MERCATOR_AUTO_OFFSET:e===oi.LNGLAT?r=o:e===oi.CARTESIAN&&(r=[Math.fround(i.center[0]),Math.fround(i.center[1]),0],o=i.unprojectPosition(r),r[0]-=t[0],r[1]-=t[1],r[2]-=t[2]);break;case wn.IDENTITY:r=i.position.map(Math.fround),r[2]=r[2]||0;break;case wn.GLOBE:c=!1,o=null;break;default:c=!1}return{geospatialOrigin:o,shaderCoordinateOrigin:r,offsetMode:c}}function jM(i,e,t){const{viewMatrixUncentered:r,projectionMatrix:o}=i;let{viewMatrix:c,viewProjectionMatrix:f}=i,a=wb,y=wb,T=i.cameraPosition;const{geospatialOrigin:A,shaderCoordinateOrigin:M,offsetMode:F}=B1(i,e,t);return F&&(y=i.projectPosition(A||M),T=[T[0]-y[0],T[1]-y[1],T[2]-y[2]],y[3]=1,a=wh([],y,f),c=r||c,f=ja([],o,c),f=ja([],f,zM)),{viewMatrix:c,viewProjectionMatrix:f,projectionCenter:a,originCommon:y,cameraPosCommon:T,shaderCoordinateOrigin:M,geospatialOrigin:A}}function $M({viewport:i,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:r=oi.DEFAULT,coordinateOrigin:o=L1,autoWrapLongitude:c=!1}){r===oi.DEFAULT&&(r=i.isGeospatial?oi.LNGLAT:oi.CARTESIAN);const f=VM({viewport:i,devicePixelRatio:e,coordinateSystem:r,coordinateOrigin:o});return f.wrapLongitude=c,f.modelMatrix=t||F1,f}function WM({viewport:i,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:r}){const{projectionCenter:o,viewProjectionMatrix:c,originCommon:f,cameraPosCommon:a,shaderCoordinateOrigin:y,geospatialOrigin:T}=jM(i,t,r),A=i.getDistanceScales(),M=[i.width*e,i.height*e],F=wh([],[0,0,-i.focalDistance,1],i.projectionMatrix)[3]||1,L={coordinateSystem:t,projectionMode:i.projectionMode,coordinateOrigin:y,commonOrigin:f.slice(0,3),center:o,pseudoMeters:!!i._pseudoMeters,viewportSize:M,devicePixelRatio:e,focalDistance:F,commonUnitsPerMeter:A.unitsPerMeter,commonUnitsPerWorldUnit:A.unitsPerMeter,commonUnitsPerWorldUnit2:UM,scale:i.scale,wrapLongitude:!1,viewProjectionMatrix:c,modelMatrix:F1,cameraPosition:a};if(T){const Y=i.getDistanceScales(T);switch(t){case oi.METER_OFFSETS:L.commonUnitsPerWorldUnit=Y.unitsPerMeter,L.commonUnitsPerWorldUnit2=Y.unitsPerMeter2;break;case oi.LNGLAT:case oi.LNGLAT_OFFSETS:i._pseudoMeters||(L.commonUnitsPerMeter=Y.unitsPerMeter),L.commonUnitsPerWorldUnit=Y.unitsPerDegree,L.commonUnitsPerWorldUnit2=Y.unitsPerDegree2;break;case oi.CARTESIAN:L.commonUnitsPerWorldUnit=[1,1,Y.unitsPerMeter[2]],L.commonUnitsPerWorldUnit2=[0,0,Y.unitsPerMeter2[2]];break}}return L}const HM=Object.keys(oi).map(i=>`const COORDINATE_SYSTEM_${i}: i32 = ${oi[i]};`).join(""),ZM=Object.keys(wn).map(i=>`const PROJECTION_MODE_${i}: i32 = ${wn[i]};`).join(""),XM=Object.keys(Ss).map(i=>`const UNIT_${i.toUpperCase()}: i32 = ${Ss[i]};`).join(""),qM=`${HM}
${ZM}
${XM}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,GM=`${qM}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the z‑axis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,YM=Object.keys(oi).map(i=>`const int COORDINATE_SYSTEM_${i} = ${oi[i]};`).join(""),KM=Object.keys(wn).map(i=>`const int PROJECTION_MODE_${i} = ${wn[i]};`).join(""),JM=Object.keys(Ss).map(i=>`const int UNIT_${i.toUpperCase()} = ${Ss[i]};`).join(""),QM=`${YM}
${KM}
${JM}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,eR={};function tR(i=eR){return"viewport"in i?$M(i):{}}const ny={name:"project",dependencies:[AC,I1],source:GM,vs:QM,getUniforms:tR,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},iR=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,rR=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,Sc={name:"project32",dependencies:[ny],source:iR,vs:rR};function nR(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function lc(i,e){const t=wh([],e,i);return gC(t,t,1/t[3]),t}function Tb(i,e){const t=i%e;return t<0?e+t:t}function d_(i,e,t){return i<e?e:i>t?t:i}function sR(i){return Math.log(i)*Math.LOG2E}const sy=Math.log2||sR;function Js(i,e){if(!i)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const qn=Math.PI,N1=qn/4,An=qn/180,p_=180/qn,mc=512,Yd=4003e4,Sb=85.051129,oR=1.5;function aR(i){return sy(i)}function Kd(i){const[e,t]=i;Js(Number.isFinite(e)),Js(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const r=e*An,o=t*An,c=mc*(r+qn)/(2*qn),f=mc*(qn+Math.log(Math.tan(N1+o*.5)))/(2*qn);return[c,f]}function _c(i){const[e,t]=i,r=e/mc*(2*qn)-qn,o=2*(Math.atan(Math.exp(t/mc*(2*qn)-qn))-N1);return[r*p_,o*p_]}function lR(i){const{latitude:e}=i;Js(Number.isFinite(e));const t=Math.cos(e*An);return aR(Yd*t)-9}function bm(i){const e=Math.cos(i*An);return mc/Yd/e}function g_(i){const{latitude:e,longitude:t,highPrecision:r=!1}=i;Js(Number.isFinite(e)&&Number.isFinite(t));const o=mc,c=Math.cos(e*An),f=o/360,a=f/c,y=o/Yd/c,T={unitsPerMeter:[y,y,y],metersPerUnit:[1/y,1/y,1/y],unitsPerDegree:[f,a,y],degreesPerUnit:[1/f,1/a,1/y]};if(r){const A=An*Math.tan(e*An)/c,M=f*A/2,F=o/Yd*A,L=F/a*y;T.unitsPerDegree2=[0,M,F],T.unitsPerMeter2=[L,0,L]}return T}function z1(i,e){const[t,r,o]=i,[c,f,a]=e,{unitsPerMeter:y,unitsPerMeter2:T}=g_({longitude:t,latitude:r,highPrecision:!0}),A=Kd(i);A[0]+=c*(y[0]+T[0]*f),A[1]+=f*(y[1]+T[1]*f);const M=_c(A),F=(o||0)+(a||0);return Number.isFinite(o)||Number.isFinite(a)?[M[0],M[1],F]:M}function cR(i){const{height:e,pitch:t,bearing:r,altitude:o,scale:c,center:f}=i,a=nR();qd(a,a,[0,0,-o]),w1(a,a,-t*An),T1(a,a,r*An);const y=c/e;return ry(a,a,[y,y,y]),f&&qd(a,a,HI([],f)),a}function uR(i){const{width:e,height:t,altitude:r,pitch:o=0,offset:c,center:f,scale:a,nearZMultiplier:y=1,farZMultiplier:T=1}=i;let{fovy:A=Jd(oR)}=i;r!==void 0&&(A=Jd(r));const M=A*An,F=o*An,L=U1(A);let Y=L;f&&(Y+=f[2]*a/Math.cos(F)/t);const ae=M*(.5+(c?c[1]:0)/t),pe=Math.sin(ae)*Y/Math.sin(d_(Math.PI/2-F-ae,.01,Math.PI-.01)),Ee=Math.sin(F)*pe+Y,Be=Y*10,xe=Math.min(Ee*T,Be);return{fov:M,aspect:e/t,focalDistance:L,near:y,far:xe}}function Jd(i){return 2*Math.atan(.5/i)*p_}function U1(i){return .5/Math.tan(.5*i*An)}function V1(i,e){const[t,r,o=0]=i;return Js(Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(o)),lc(e,[t,r,o,1])}function oy(i,e,t=0){const[r,o,c]=i;if(Js(Number.isFinite(r)&&Number.isFinite(o),"invalid pixel coordinate"),Number.isFinite(c))return lc(e,[r,o,c,1]);const f=lc(e,[r,o,0,1]),a=lc(e,[r,o,1,1]),y=f[2],T=a[2],A=y===T?0:((t||0)-y)/(T-y);return x1([],f,a,A)}function hR(i){const{width:e,height:t,bounds:r,minExtent:o=0,maxZoom:c=24,offset:f=[0,0]}=i,[[a,y],[T,A]]=r,M=fR(i.padding),F=Kd([a,d_(A,-85.051129,Sb)]),L=Kd([T,d_(y,-85.051129,Sb)]),Y=[Math.max(Math.abs(L[0]-F[0]),o),Math.max(Math.abs(L[1]-F[1]),o)],ae=[e-M.left-M.right-Math.abs(f[0])*2,t-M.top-M.bottom-Math.abs(f[1])*2];Js(ae[0]>0&&ae[1]>0);const pe=ae[0]/Y[0],Ee=ae[1]/Y[1],Be=(M.right-M.left)/2/pe,xe=(M.top-M.bottom)/2/Ee,Ce=[(L[0]+F[0])/2+Be,(L[1]+F[1])/2+xe],tt=_c(Ce),Xe=Math.min(c,sy(Math.abs(Math.min(pe,Ee))));return Js(Number.isFinite(Xe)),{longitude:tt[0],latitude:tt[1],zoom:Xe}}function fR(i=0){return typeof i=="number"?{top:i,bottom:i,left:i,right:i}:(Js(Number.isFinite(i.top)&&Number.isFinite(i.bottom)&&Number.isFinite(i.left)&&Number.isFinite(i.right)),i)}const Ab=Math.PI/180;function dR(i,e=0){const{width:t,height:r,unproject:o}=i,c={targetZ:e},f=o([0,r],c),a=o([t,r],c);let y,T;const A=i.fovy?.5*i.fovy*Ab:Math.atan(.5/i.altitude),M=(90-i.pitch)*Ab;return A>M-.01?(y=Pb(i,0,e),T=Pb(i,t,e)):(y=o([0,0],c),T=o([t,0],c)),[f,a,T,y]}function Pb(i,e,t){const{pixelUnprojectionMatrix:r}=i,o=lc(r,[e,0,1,1]),c=lc(r,[e,i.height,1,1]),a=(t*i.distanceScales.unitsPerMeter[2]-o[2])/(c[2]-o[2]),y=x1([],o,c,a),T=_c(y);return T.push(t),T}const Eb=512;function pR(i){const{width:e,height:t,pitch:r=0}=i;let{longitude:o,latitude:c,zoom:f,bearing:a=0}=i;(o<-180||o>180)&&(o=Tb(o+180,360)-180),(a<-180||a>180)&&(a=Tb(a+180,360)-180);const y=sy(t/Eb);if(f<=y)f=y,c=0;else{const T=t/2/Math.pow(2,f),A=_c([0,T])[1];if(c<A)c=A;else{const M=_c([0,Eb-T])[1];c>M&&(c=M)}}return{width:e,height:t,longitude:o,latitude:c,zoom:f,pitch:r,bearing:a}}const j1=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,gR=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,mR=`
${j1}
${gR}
`,_R=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,yR=`
${j1}
${_R}
`,xR=Th(SR),vR=Th(AR),bR=[0,0,0,1],wR=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function TR(i,e){const[t,r,o]=i,c=oy([t,r,o],e);return Number.isFinite(o)?c:[c[0],c[1],0]}function SR({viewport:i,center:e}){return new Ts(i.viewProjectionMatrix).invert().transform(e)}function AR({viewport:i,shadowMatrices:e}){const t=[],r=i.pixelUnprojectionMatrix,o=i.isGeospatial?void 0:1,c=[[0,0,o],[i.width,0,o],[0,i.height,o],[i.width,i.height,o],[0,0,-1],[i.width,0,-1],[0,i.height,-1],[i.width,i.height,-1]].map(f=>TR(f,r));for(const f of e){const a=f.clone().translate(new ws(i.center).negate()),y=c.map(A=>a.transform(A)),T=new Ts().ortho({left:Math.min(...y.map(A=>A[0])),right:Math.max(...y.map(A=>A[0])),bottom:Math.min(...y.map(A=>A[1])),top:Math.max(...y.map(A=>A[1])),near:Math.min(...y.map(A=>-A[2])),far:Math.max(...y.map(A=>-A[2]))});t.push(T.multiplyRight(f))}return t}function PR(i){const{shadowEnabled:e=!0,project:t}=i;if(!e||!t||!i.shadowMatrices||!i.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};const r=ny.getUniforms(t),o=xR({viewport:t.viewport,center:r.center}),c=[],f=vR({shadowMatrices:i.shadowMatrices,viewport:t.viewport}).slice();for(let y=0;y<i.shadowMatrices.length;y++){const T=f[y],A=T.clone().translate(new ws(t.viewport.center).negate());r.coordinateSystem===oi.LNGLAT&&r.projectionMode===wn.WEB_MERCATOR?(f[y]=A,c[y]=o):(f[y]=T.clone().multiplyRight(wR),c[y]=A.transform(o))}const a={drawShadowMap:!!i.drawToShadowMap,useShadowMap:i.shadowMaps?i.shadowMaps.length>0:!1,color:i.shadowColor||bR,lightId:i.shadowLightId||0,lightCount:i.shadowMatrices.length,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};for(let y=0;y<f.length;y++)a[`viewProjectionMatrix${y}`]=f[y],a[`projectCenter${y}`]=c[y];for(let y=0;y<2;y++)a[`shadow_uShadowMap${y}`]=i.shadowMaps&&i.shadowMaps[y]||i.dummyShadowMap;return a}const Ib={name:"shadow",dependencies:[ny],vs:mR,fs:yR,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:PR,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},Ac={...nb,defaultUniforms:{...nb.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},ER=[I1],IR=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],CR=[];function MR(i){const e=Fd.getDefaultShaderAssembler();for(const r of ER)e.addDefaultModule(r);const t=i==="glsl"?IR:CR;for(const r of t)e.addShaderHook(r);return e}const RR=[255,255,255],kR=1;let DR=0;class OR{constructor(e={}){this.type="ambient";const{color:t=RR}=e,{intensity:r=kR}=e;this.id=e.id||`ambient-${DR++}`,this.color=t,this.intensity=r}}const FR=[255,255,255],LR=1,BR=[0,0,-1];let NR=0;class Cb{constructor(e={}){this.type="directional";const{color:t=FR}=e,{intensity:r=LR}=e,{direction:o=BR}=e,{_shadow:c=!1}=e;this.id=e.id||`directional-${NR++}`,this.color=t,this.intensity=r,this.type="directional",this.direction=new ws(o).normalize().toArray(),this.shadow=c}getProjectedLight(e){return this}}class zR{constructor(e,t={id:"pass"}){const{id:r}=t;this.id=r,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class ay extends zR{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,r]=this.device.canvasContext.getDrawingBufferSize(),o=e.clearCanvas??!0,c=e.clearColor??(o?[0,0,0,0]:!1),f=o?1:!1,a=o?0:!1,y=e.colorMask??15,T={viewport:[0,0,t,r]};e.colorMask&&(T.colorMask=y),e.scissorRect&&(T.scissorRect=e.scissorRect);const A=this.device.beginRenderPass({framebuffer:e.target,parameters:T,clearColor:c,clearDepth:f,clearStencil:a});try{return this._drawLayers(A,e)}finally{A.end(),this.device.submit()}}_drawLayers(e,t){const{target:r,shaderModuleProps:o,viewports:c,views:f,onViewportActive:a,clearStack:y=!0}=t;t.pass=t.pass||"unknown",y&&(this._lastRenderIndex=-1);const T=[];for(const A of c){const M=f&&f[A.id];a==null||a(A);const F=this._getDrawLayerParams(A,t),L=A.subViewports||[A];for(const Y of L){const ae=this._drawLayersInViewport(e,{target:r,shaderModuleProps:o,viewport:Y,view:M,pass:t.pass,layers:t.layers},F);T.push(ae)}}return T}_getDrawLayerParams(e,{layers:t,pass:r,isPicking:o=!1,layerFilter:c,cullRect:f,effects:a,shaderModuleProps:y},T=!1){var Y;const A=[],M=$1(this._lastRenderIndex+1),F={layer:t[0],viewport:e,isPicking:o,renderPass:r,cullRect:f},L={};for(let ae=0;ae<t.length;ae++){const pe=t[ae],Ee=this._shouldDrawLayer(pe,F,c,L),Be={shouldDrawLayer:Ee};Ee&&!T&&(Be.shouldDrawLayer=!0,Be.layerRenderIndex=M(pe,Ee),Be.shaderModuleProps=this._getShaderModuleProps(pe,a,r,y),Be.layerParameters={...(Y=pe.context.deck)==null?void 0:Y.props.parameters,...this.getLayerParameters(pe,ae,e)}),A[ae]=Be}return A}_drawLayersInViewport(e,{layers:t,shaderModuleProps:r,pass:o,target:c,viewport:f,view:a},y){const T=UR(this.device,{shaderModuleProps:r,target:c,viewport:f});if(a&&a.props.clear){const M=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.beginRenderPass({framebuffer:c,parameters:{viewport:T,scissorRect:T},clearColor:M.color?[0,0,0,0]:!1,clearDepth:M.depth?1:!1}).end()}const A={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:T});for(let M=0;M<t.length;M++){const F=t[M],L=y[M],{shouldDrawLayer:Y}=L;if(Y&&F.props.pickable&&A.pickableCount++,F.isComposite&&A.compositeCount++,F.isDrawable&&L.shouldDrawLayer){const{layerRenderIndex:ae,shaderModuleProps:pe,layerParameters:Ee}=L;A.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,ae),pe.project&&(pe.project.viewport=f),F.context.renderPass=e;try{F._drawLayer({renderPass:e,shaderModuleProps:pe,uniforms:{layerIndex:ae},parameters:Ee})}catch(Be){F.raiseError(Be,`drawing ${F} to ${o}`)}}}return A}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,r){return null}getLayerParameters(e,t,r){return e.props.parameters}_shouldDrawLayer(e,t,r,o){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let f=e.parent;for(;f;){if(!f.props.visible||!f.filterSubLayer(t))return!1;t.layer=f,f=f.parent}if(r){const a=t.layer.id;if(a in o||(o[a]=r(t)),!o[a])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,r,o){var y,T;const c=this.device.canvasContext.cssToDeviceRatio(),f=((y=e.internalState)==null?void 0:y.propsInTransition)||e.props,a={layer:f,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:c,modelMatrix:f.modelMatrix,coordinateSystem:f.coordinateSystem,coordinateOrigin:f.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const A of t)Mb(a,(T=A.getShaderModuleProps)==null?void 0:T.call(A,e,a));return Mb(a,this.getShaderModuleProps(e,t,a),o)}}function $1(i=0,e={}){const t={},r=(o,c)=>{const f=o.props._offset,a=o.id,y=o.parent&&o.parent.id;let T;if(y&&!(y in e)&&r(o.parent,!1),y in t){const A=t[y]=t[y]||$1(e[y],e);T=A(o,c),t[a]=A}else Number.isFinite(f)?(T=f+(e[y]||0),t[a]=null):T=i;return c&&T>=i&&(i=T+1),e[a]=T,T};return r}function UR(i,{shaderModuleProps:e,target:t,viewport:r}){var y;const o=((y=e==null?void 0:e.project)==null?void 0:y.devicePixelRatio)??i.canvasContext.cssToDeviceRatio(),[,c]=i.canvasContext.getDrawingBufferSize(),f=t?t.height:c,a=r;return[a.x*o,f-(a.y+a.height)*o,a.width*o,a.height*o]}function Mb(i,...e){for(const t of e)if(t)for(const r in t)i[r]?Object.assign(i[r],t[r]):i[r]=t[r];return i}class VR extends ay{constructor(e,t){super(e,t);const r=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),o=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[r],depthStencilAttachment:o})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,r=this.device.canvasContext.cssToDeviceRatio(),o=e.viewports[0],c=o.width*r,f=o.height*r,a=[1,1,1,1];(c!==t.width||f!==t.height)&&t.resize({width:c,height:f}),super.render({...e,clearColor:a,target:t,pass:"shadow"})}getLayerParameters(e,t,r){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,r){return{shadow:{project:r.project,drawToShadowMap:!0}}}}const jR={color:[255,255,255],intensity:1},Rb=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],$R=[0,0,0,200/255];class W1{constructor(e={}){this.id="lighting-effect",this.shadowColor=$R,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:r}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),r._addDefaultShaderModule(Ib),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const r=e[t];switch(r.type){case"ambient":this.ambientLight=r;break;case"directional":this.directionalLights.push(r);break;case"point":this.pointLights.push(r);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:r,onViewportActive:o,views:c}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let f=0;f<this.shadowPasses.length;f++)this.shadowPasses[f].render({layers:e,layerFilter:t,viewports:r,onViewportActive:o,views:c,shaderModuleProps:{shadow:{shadowLightId:f,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const r=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(f=>f.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},o={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(f=>f.getProjectedLight({layer:e})),pointLights:this.pointLights.map(f=>f.getProjectedLight({layer:e}))},c=e.props.material;return{shadow:r,lighting:o,phongMaterial:c,gouraudMaterial:c}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(Ib))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const r=new Ts().lookAt({eye:new ws(t.direction).negate()});e.push(r)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const r=new VR(e);this.shadowPasses[t]=r}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:r}=this;!e&&t.length===0&&r.length===0&&(this.ambientLight=new OR(jR),this.directionalLights.push(new Cb(Rb[0]),new Cb(Rb[1])))}}class WR{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:r=1,type:o,padding:c=0,copy:f=!1,initialize:a=!1,maxCount:y}){const T=o||e&&e.constructor||Float32Array,A=t*r+c;if(ArrayBuffer.isView(e)){if(A<=e.length)return e;if(A*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new T(e.buffer,0,A)}let M=1/0;y&&(M=y*r+c);const F=this._allocate(T,A,a,M);return e&&f?F.set(e):a||F.fill(0,0,4),this._release(e),F}release(e){this._release(e)}_allocate(e,t,r,o){let c=Math.max(Math.ceil(t*this.opts.overAlloc),1);c>o&&(c=o);const f=this._pool,a=e.BYTES_PER_ELEMENT*c,y=f.findIndex(T=>T.byteLength>=a);if(y>=0){const T=new e(f.splice(y,1)[0],0,c);return r&&T.fill(0),T}return new e(c)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:r}=e,{byteLength:o}=r,c=t.findIndex(f=>f.byteLength>=o);c<0?t.push(r):(c>0||t.length<this.opts.poolSize)&&t.splice(c,0,r),t.length>this.opts.poolSize&&t.shift()}}const yc=new WR;function Zu(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function HR(i){return[i[12],i[13],i[14]]}function ZR(i){return{left:Ql(i[3]+i[0],i[7]+i[4],i[11]+i[8],i[15]+i[12]),right:Ql(i[3]-i[0],i[7]-i[4],i[11]-i[8],i[15]-i[12]),bottom:Ql(i[3]+i[1],i[7]+i[5],i[11]+i[9],i[15]+i[13]),top:Ql(i[3]-i[1],i[7]-i[5],i[11]-i[9],i[15]-i[13]),near:Ql(i[3]+i[2],i[7]+i[6],i[11]+i[10],i[15]+i[14]),far:Ql(i[3]-i[2],i[7]-i[6],i[11]-i[10],i[15]-i[14])}}const kb=new ws;function Ql(i,e,t,r){kb.set(i,e,t);const o=kb.len();return{distance:r/o,normal:new ws(-i/o,-e/o,-t/o)}}function XR(i){return i-Math.fround(i)}let zu;function wm(i,e){const{size:t=1,startIndex:r=0}=e,o=e.endIndex!==void 0?e.endIndex:i.length,c=(o-r)/t;zu=yc.allocate(zu,c,{type:Float32Array,size:t*2});let f=r,a=0;for(;f<o;){for(let y=0;y<t;y++){const T=i[f++];zu[a+y]=T,zu[a+y+t]=XR(T)}a+=t*2}return zu.subarray(0,c*t*2)}function qR(i){let e=null,t=!1;for(const r of i)r&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],r[0][0]),e[0][1]=Math.min(e[0][1],r[0][1]),e[1][0]=Math.max(e[1][0],r[1][0]),e[1][1]=Math.max(e[1][1],r[1][1])):e=r);return e}const GR=Math.PI/180,YR=Zu(),Db=[0,0,0],KR={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function JR({width:i,height:e,orthographic:t,fovyRadians:r,focalDistance:o,padding:c,near:f,far:a}){const y=i/e,T=t?new Ts().orthographic({fovy:r,aspect:y,focalDistance:o,near:f,far:a}):new Ts().perspective({fovy:r,aspect:y,near:f,far:a});if(c){const{left:A=0,right:M=0,top:F=0,bottom:L=0}=c,Y=qo((A+i-M)/2,0,i)-i/2,ae=qo((F+e-L)/2,0,e)-e/2;T[8]-=Y*2/i,T[9]+=ae*2/e}return T}class Sh{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||KR,this.focalDistance=e.focalDistance||1,this.position=e.position||Db,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:r}=e;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?wn.WEB_MERCATOR:wn.WEB_MERCATOR_AUTO_OFFSET:wn.IDENTITY}equals(e){return e instanceof Sh?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&uh(e.projectionMatrix,this.projectionMatrix)&&uh(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const r=this.projectPosition(e),o=V1(r,this.pixelProjectionMatrix),[c,f]=o,a=t?f:this.height-f;return e.length===2?[c,a]:[c,a,o[2]]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[o,c,f]=e,a=t?c:this.height-c,y=r&&r*this.distanceScales.unitsPerMeter[2],T=oy([o,a,f],this.pixelUnprojectionMatrix,y),[A,M,F]=this.unprojectPosition(T);return Number.isFinite(f)?[A,M,F]:Number.isFinite(r)?[A,M,r]:[A,M]}projectPosition(e){const[t,r]=this.projectFlat(e),o=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,r,o]}unprojectPosition(e){const[t,r]=this.unprojectFlat(e),o=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,r,o]}projectFlat(e){if(this.isGeospatial){const t=Kd(e);return t[1]=qo(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?_c(e):e}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,0],t),o=this.unproject([this.width,0],t),c=this.unproject([0,this.height],t),f=this.unproject([this.width,this.height],t);return[Math.min(r[0],o[0],c[0],f[0]),Math.min(r[1],o[1],c[1],f[1]),Math.max(r[0],o[0],c[0],f[0]),Math.max(r[1],o[1],c[1],f[1])]}getDistanceScales(e){return e&&this.isGeospatial?g_({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:r=1,height:o=1}){return e<this.x+this.width&&this.x<e+r&&t<this.y+this.height&&this.y<t+o}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,ZR(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,r=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=lR({latitude:r})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||g_({latitude:r,longitude:t}));const o=Math.pow(2,this.zoom);this.scale=o;const{position:c,modelMatrix:f}=e;let a=Db;if(c&&(a=f?new Ts(f).transformAsVector(c,[]):c),this.isGeospatial){const y=this.projectPosition([t,r,0]);this.center=new ws(a).scale(this.distanceScales.unitsPerMeter).add(y)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:t=YR,projectionMatrix:r=null,orthographic:o=!1,fovyRadians:c,fovy:f=75,near:a=.1,far:y=1e3,padding:T=null,focalDistance:A=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new Ts().multiplyRight(t).translate(new ws(this.center).negate()),this.projectionMatrix=r||JR({width:this.width,height:this.height,orthographic:o,fovyRadians:c||f*GR,focalDistance:A,padding:T,near:a,far:y});const M=Zu();ja(M,M,this.projectionMatrix),ja(M,M,this.viewMatrix),this.viewProjectionMatrix=M,this.viewMatrixInverse=o_([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=HR(this.viewMatrixInverse);const F=Zu(),L=Zu();ry(F,F,[this.width/2,-this.height/2,1]),qd(F,F,[1,-1,0]),ja(L,F,this.viewProjectionMatrix),this.pixelProjectionMatrix=L,this.pixelUnprojectionMatrix=o_(Zu(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||ri.warn("Pixel project matrix not invertible")()}}Sh.displayName="Viewport";class xc extends Sh{constructor(e={}){const{latitude:t=0,longitude:r=0,zoom:o=0,pitch:c=0,bearing:f=0,nearZMultiplier:a=.1,farZMultiplier:y=1.01,nearZ:T,farZ:A,orthographic:M=!1,projectionMatrix:F,repeat:L=!1,worldOffset:Y=0,position:ae,padding:pe,legacyMeterSizes:Ee=!1}=e;let{width:Be,height:xe,altitude:Ce=1.5}=e;const tt=Math.pow(2,o);Be=Be||1,xe=xe||1;let Xe,gt=null;if(F)Ce=F[5]/2,Xe=Jd(Ce);else{e.fovy?(Xe=e.fovy,Ce=U1(Xe)):Xe=Jd(Ce);let yt;if(pe){const{top:Bt=0,bottom:Pt=0}=pe;yt=[0,qo((Bt+xe-Pt)/2,0,xe)-xe/2]}gt=uR({width:Be,height:xe,scale:tt,center:ae&&[0,0,ae[2]*bm(t)],offset:yt,pitch:c,fovy:Xe,nearZMultiplier:a,farZMultiplier:y}),Number.isFinite(T)&&(gt.near=T),Number.isFinite(A)&&(gt.far=A)}let ft=cR({height:xe,pitch:c,bearing:f,scale:tt,altitude:Ce});Y&&(ft=new Ts().translate([512*Y,0,0]).multiplyLeft(ft)),super({...e,width:Be,height:xe,viewMatrix:ft,longitude:r,latitude:t,zoom:o,...gt,fovy:Xe,focalDistance:Ce}),this.latitude=t,this.longitude=r,this.zoom=o,this.pitch=c,this.bearing=f,this.altitude=Ce,this.fovy=Xe,this.orthographic=M,this._subViewports=L?[]:null,this._pseudoMeters=Ee,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),r=Math.ceil((e[2]-180)/360);for(let o=t;o<=r;o++){const c=o?new xc({...this,worldOffset:o}):this;this._subViewports.push(c)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,r]=this.projectFlat(e),o=(e[2]||0)*bm(e[1]);return[t,r,o]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,r]=this.unprojectFlat(e),o=(e[2]||0)/bm(r);return[t,r,o]}addMetersToLngLat(e,t){return z1(e,t)}panByPosition(e,t){const r=oy(t,this.pixelUnprojectionMatrix),o=this.projectFlat(e),c=ib([],o,zI([],r)),f=ib([],this.center,c),[a,y]=this.unprojectFlat(f);return{longitude:a,latitude:y}}getBounds(e={}){const t=dR(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:r,height:o}=this,{longitude:c,latitude:f,zoom:a}=hR({width:r,height:o,bounds:e,...t});return new xc({width:r,height:o,longitude:c,latitude:f,zoom:a})}}xc.displayName="WebMercatorViewport";const Ob=[0,0,0];function Tm(i,e,t=!1){const r=e.projectPosition(i);if(t&&e instanceof xc){const[o,c,f=0]=i,a=e.getDistanceScales([o,c]);r[2]=f*a.unitsPerMeter[2]}return r}function QR(i){const{viewport:e,modelMatrix:t,coordinateOrigin:r}=i;let{coordinateSystem:o,fromCoordinateSystem:c,fromCoordinateOrigin:f}=i;return o===oi.DEFAULT&&(o=e.isGeospatial?oi.LNGLAT:oi.CARTESIAN),c===void 0&&(c=o),f===void 0&&(f=r),{viewport:e,coordinateSystem:o,coordinateOrigin:r,modelMatrix:t,fromCoordinateSystem:c,fromCoordinateOrigin:f}}function H1(i,{viewport:e,modelMatrix:t,coordinateSystem:r,coordinateOrigin:o,offsetMode:c}){let[f,a,y=0]=i;switch(t&&([f,a,y]=wh([],[f,a,y,1],t)),r){case oi.LNGLAT:return Tm([f,a,y],e,c);case oi.LNGLAT_OFFSETS:return Tm([f+o[0],a+o[1],y+(o[2]||0)],e,c);case oi.METER_OFFSETS:return Tm(z1(o,[f,a,y]),e,c);case oi.CARTESIAN:default:return e.isGeospatial?[f+o[0],a+o[1],y+o[2]]:e.projectPosition([f,a,y])}}function ek(i,e){const{viewport:t,coordinateSystem:r,coordinateOrigin:o,modelMatrix:c,fromCoordinateSystem:f,fromCoordinateOrigin:a}=QR(e),{autoOffset:y=!0}=e,{geospatialOrigin:T=Ob,shaderCoordinateOrigin:A=Ob,offsetMode:M=!1}=y?B1(t,r,o):{},F=H1(i,{viewport:t,modelMatrix:c,coordinateSystem:f,coordinateOrigin:a,offsetMode:M});if(M){const L=t.projectPosition(T||A);eC(F,F,L)}return F}let tk=1,ik=1;class Z1{constructor(){G(this,"time",0);G(this,"channels",new Map);G(this,"animations",new Map);G(this,"playing",!1);G(this,"lastEngineTime",-1)}addChannel(e){const{delay:t=0,duration:r=Number.POSITIVE_INFINITY,rate:o=1,repeat:c=1}=e,f=tk++,a={time:0,delay:t,duration:r,rate:o,repeat:c};return this._setChannelTime(a,this.time),this.channels.set(f,a),f}removeChannel(e){this.channels.delete(e);for(const[t,r]of this.animations)r.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const o of t)this._setChannelTime(o,this.time);const r=this.animations.values();for(const o of r){const{animation:c,channel:f}=o;c.setTime(this.getTime(f))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const r=ik++;return this.animations.set(r,{animation:e,channel:t}),e.setTime(this.getTime(t)),r}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const r=t-e.delay,o=e.duration*e.repeat;r>=o?e.time=e.duration*e.rate:(e.time=Math.max(0,r)%e.duration,e.time*=e.rate)}}function rk(i){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(i):setTimeout(i,1e3/60)}function nk(i){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(i):clearTimeout(i)}let sk=0;const ok={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:i=>console.error(i),stats:Ym.stats.get(`animation-loop-${sk++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class ak{constructor(e){G(this,"device",null);G(this,"canvas",null);G(this,"props");G(this,"animationProps",null);G(this,"timeline",null);G(this,"stats");G(this,"cpuTime");G(this,"gpuTime");G(this,"frameRate");G(this,"display");G(this,"needsRedraw","initialized");G(this,"_initialized",!1);G(this,"_running",!1);G(this,"_animationFrameId",null);G(this,"_nextFramePromise",null);G(this,"_resolveNextFrame",null);G(this,"_cpuStartTime",0);G(this,"_error",null);if(this.props={...ok,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new Ep({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){var r,o;if(this.props.onError(e),this._error=Error(),((o=(r=this.device)==null?void 0:r.canvasContext)==null?void 0:o.canvas)instanceof HTMLCanvasElement){const c=document.createElement("h1");c.innerHTML=e.message,c.style.position="absolute",c.style.top="20%",c.style.left="10px",c.style.color="black",c.style.backgroundColor="red",document.body.appendChild(c)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=rk(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(nk(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){var t;if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),(t=this.device)==null||t.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var t,r;const e=(r=(t=this.device)==null?void 0:t.canvasContext)==null?void 0:r.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:r}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),r!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=r,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const r=this.props.onAddHTML(t);r&&(t.innerHTML=r)}}_getSizeAndAspect(){var c,f,a,y;if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=((f=(c=this.device)==null?void 0:c.canvasContext)==null?void 0:f.getPixelSize())||[1,1];let r=1;const o=(y=(a=this.device)==null?void 0:a.canvasContext)==null?void 0:y.canvas;return o&&o.clientHeight?r=o.clientWidth/o.clientHeight:e>0&&t>0&&(r=e/t),{width:e,height:t,aspect:r}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,t;this.props.autoResizeDrawingBuffer&&((t=(e=this.device)==null?void 0:e.canvasContext)==null||t.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const Sm={};function Rp(i="id"){Sm[i]=Sm[i]||1;const e=Sm[i]++;return`${i}-${e}`}class Fb{constructor(e){G(this,"id");G(this,"userData",{});G(this,"topology");G(this,"bufferLayout",[]);G(this,"vertexCount");G(this,"indices");G(this,"attributes");if(this.id=e.id||Rp("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&Fi.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){var e;(e=this.indices)==null||e.destroy();for(const t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function lk(i,e){if(e instanceof Fb)return e;const t=ck(i,e),{attributes:r,bufferLayout:o}=uk(i,e);return new Fb({topology:e.topology||"triangle-list",bufferLayout:o,vertexCount:e.vertexCount,indices:t,attributes:r})}function ck(i,e){if(!e.indices)return;const t=e.indices.value;return i.createBuffer({usage:Fi.INDEX,data:t})}function uk(i,e){const t=[],r={};for(const[c,f]of Object.entries(e.attributes)){let a=c;switch(c){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(f){r[a]=i.createBuffer({data:f.value,id:`${c}-buffer`});const{value:y,size:T,normalized:A}=f;t.push({name:a,format:eI(y,T,A)})}}const o=e._calculateVertexCount(e.attributes,e.indices);return{attributes:r,bufferLayout:t,vertexCount:o}}const Sp=class Sp{constructor(e){G(this,"device");G(this,"destroyPolicy");G(this,"_hashCounter",0);G(this,"_hashes",{});G(this,"_renderPipelineCache",{});G(this,"_computePipelineCache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new Sp(e),e._lumaData.defaultPipelineFactory}createRenderPipeline(e){const t={...fc.defaultProps,...e},r=this._hashRenderPipeline(t);if(!this._renderPipelineCache[r]){const o=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});o.hash=r,this._renderPipelineCache[r]={pipeline:o,useCount:0}}return this._renderPipelineCache[r].useCount++,this._renderPipelineCache[r].pipeline}createComputePipeline(e){const t={...Ud.defaultProps,...e},r=this._hashComputePipeline(t);if(!this._computePipelineCache[r]){const o=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});o.hash=r,this._computePipelineCache[r]={pipeline:o,useCount:0}}return this._computePipelineCache[r].useCount++,this._computePipelineCache[r].pipeline}release(e){const t=e.hash,r=e instanceof Ud?this._computePipelineCache:this._renderPipelineCache;r[t].useCount--,r[t].useCount===0&&this.destroyPolicy==="unused"&&(r[t].pipeline.destroy(),delete r[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,r=e.fs?this._getHash(e.fs.source):0,o="-",c=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${t}/${r}V${o}BL${c}`;default:const f=this._getHash(JSON.stringify(e.parameters));return`${t}/${r}V${o}T${e.topology}P${f}BL${c}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};G(Sp,"defaultProps",{...fc.defaultProps});let m_=Sp;const Ap=class Ap{constructor(e){G(this,"device");G(this,"destroyPolicy");G(this,"_cache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultShaderFactory(e){var t;return(t=e._lumaData).defaultShaderFactory||(t.defaultShaderFactory=new Ap(e)),e._lumaData.defaultShaderFactory}createShader(e){const t=this._hashShader(e);let r=this._cache[t];if(!r){const o=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=r={shader:o,useCount:0}}return r.useCount++,r.shader}release(e){const t=this._hashShader(e),r=this._cache[t];r&&(r.useCount--,r.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[t],r.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};G(Ap,"defaultProps",{...Bd.defaultProps});let __=Ap;function hk(i,e){var o;const t={},r="Values";if(i.attributes.length===0&&!((o=i.varyings)!=null&&o.length))return{"No attributes or varyings":{[r]:"N/A"}};for(const c of i.attributes)if(c){const f=`${c.location} ${c.name}: ${c.type}`;t[`in ${f}`]={[r]:c.stepMode||"vertex"}}for(const c of i.varyings||[]){const f=`${c.location} ${c.name}`;t[`out ${f}`]={[r]:JSON.stringify(c)}}return t}let vr=null,Fa=null;function fk(i,{id:e,minimap:t,opaque:r,top:o="0",left:c="0",rgbaScale:f=1}){vr||(vr=document.createElement("canvas"),vr.id=e,vr.title=e,vr.style.zIndex="100",vr.style.position="absolute",vr.style.top=o,vr.style.left=c,vr.style.border="blue 5px solid",vr.style.transform="scaleY(-1)",document.body.appendChild(vr),Fa=vr.getContext("2d")),(vr.width!==i.width||vr.height!==i.height)&&(vr.width=i.width/2,vr.height=i.height/2,vr.style.width="400px",vr.style.height="400px");const a=i.device.readPixelsToArrayWebGL(i),y=Fa==null?void 0:Fa.createImageData(i.width,i.height);if(y){for(let A=0;A<a.length;A+=4)y.data[0+A+0]=a[A+0]*f,y.data[0+A+1]=a[A+1]*f,y.data[0+A+2]=a[A+2]*f,y.data[0+A+3]=r?255:a[A+3]*f;Fa==null||Fa.putImageData(y,0,0)}}function y_(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!y_(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),o=Object.keys(e);if(r.length!==o.length)return!1;for(const c of r)if(!e.hasOwnProperty(c)||!y_(i[c],e[c],t-1))return!1;return!0}return!1}function dk(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function pk(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":!1}function X1(i){return dk(i)||pk(i)}function gk(i){return X1(i)||typeof i=="number"||typeof i=="boolean"}function q1(i){const e={bindings:{},uniforms:{}};return Object.keys(i).forEach(t=>{const r=i[t];gk(r)?e.uniforms[t]=r:e.bindings[t]=r}),e}class mk{constructor(e,t){G(this,"options",{disableWarnings:!1});G(this,"modules");G(this,"moduleUniforms");G(this,"moduleBindings");Object.assign(this.options,t);const r=X_(Object.values(e).filter(o=>o.dependencies));for(const o of r)e[o.name]=o;ut.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[o,c]of Object.entries(e))this._addModule(c),c.name&&o!==c.name&&!this.options.disableWarnings&&ut.warn(`Module name: ${o} vs ${c.name}`)()}destroy(){}setProps(e){var t;for(const r of Object.keys(e)){const o=r,c=e[o]||{},f=this.modules[o];if(!f){this.options.disableWarnings||ut.warn(`Module ${r} not found`)();continue}const a=this.moduleUniforms[o],y=this.moduleBindings[o],T=((t=f.getUniforms)==null?void 0:t.call(f,c,a))||c,{uniforms:A,bindings:M}=q1(T);this.moduleUniforms[o]={...a,...A},this.moduleBindings[o]={...y,...M}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){var t;const e={};for(const[r,o]of Object.entries(this.moduleUniforms))for(const[c,f]of Object.entries(o))e[`${r}.${c}`]={type:(t=this.modules[r].uniformTypes)==null?void 0:t[c],value:String(f)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let _k="";async function yk(i,e){const t=new Image;return t.crossOrigin="anonymous",t.src=i.startsWith("http")?i:_k+i,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}class Am{constructor(e,t){G(this,"device");G(this,"id");G(this,"texture");G(this,"sampler");G(this,"view");G(this,"ready");G(this,"isReady",!1);G(this,"destroyed",!1);G(this,"resolveReady",()=>{});G(this,"rejectReady",()=>{});this.device=e,this.id=t.id||Rp("async-texture"),typeof(t==null?void 0:t.data)=="string"&&t.dimension==="2d"&&(t={...t,data:yk(t.data)}),this.ready=new Promise((r,o)=>{this.resolveReady=()=>{this.isReady=!0,r()},this.rejectReady=o}),this.initAsync(t)}get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}async initAsync(e){let t,r;const o=e.data,c=await G1(o).then(t,r);if(this.destroyed)return;const f={...e,data:c};this.texture=this.device.createTexture(f),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function G1(i){if(i=await i,Array.isArray(i))return await Promise.all(i.map(G1));if(i&&typeof i=="object"&&i.constructor===Object){const e=i,t=await Promise.all(Object.values(e)),r=Object.keys(e),o={};for(let c=0;c<r.length;c++)o[r[c]]=t[c];return o}return i}const La=2,xk=1e4,Pp=class Pp{constructor(e,t){G(this,"device");G(this,"id");G(this,"source");G(this,"vs");G(this,"fs");G(this,"pipelineFactory");G(this,"shaderFactory");G(this,"userData",{});G(this,"parameters");G(this,"topology");G(this,"bufferLayout");G(this,"isInstanced");G(this,"instanceCount",0);G(this,"vertexCount");G(this,"indexBuffer",null);G(this,"bufferAttributes",{});G(this,"constantAttributes",{});G(this,"bindings",{});G(this,"uniforms",{});G(this,"vertexArray");G(this,"transformFeedback",null);G(this,"pipeline");G(this,"shaderInputs");G(this,"_uniformStore");G(this,"_attributeInfos",{});G(this,"_gpuGeometry",null);G(this,"_getModuleUniforms");G(this,"props");G(this,"_pipelineNeedsUpdate","newly created");G(this,"_needsRedraw","initializing");G(this,"_destroyed",!1);G(this,"_lastDrawTimestamp",-1);G(this,"_lastLogTime",0);G(this,"_logOpen",!1);G(this,"_drawCount",0);var y,T,A,M;this.props={...Pp.defaultProps,...t},t=this.props,this.id=t.id||Rp("model"),this.device=e,Object.assign(this.userData,t.userData);const r=Object.fromEntries(((y=this.props.modules)==null?void 0:y.map(F=>[F.name,F]))||[]),o=t.shaderInputs||new mk(r,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(o);const c=bk(e),f=(((T=this.props.modules)==null?void 0:T.length)>0?this.props.modules:(A=this.shaderInputs)==null?void 0:A.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:F,getUniforms:L}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:c,...this.props,modules:f});this.source=F,this._getModuleUniforms=L,(M=this.props).shaderLayout||(M.shaderLayout=CI(this.source))}else{const{vs:F,fs:L,getUniforms:Y}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:c,...this.props,modules:f});this.vs=F,this.fs=L,this._getModuleUniforms=Y}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||m_.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||__.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniformsWebGL(t.uniforms),t.moduleSettings&&this.updateModuleSettingsWebGL(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),(e=this._gpuGeometry)==null||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return ut.info(La,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let r;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const o=this._getBindings();this.pipeline.setBindings(o,{disableWarnings:this.props.disableWarnings}),x_(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:c}=this.vertexArray,f=c?c.byteLength/(c.indexType==="uint32"?4:2):void 0;r=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:f,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),r?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",r}setGeometry(e){var r;(r=this._gpuGeometry)==null||r.destroy();const t=e&&lk(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const o=new um(this.bufferLayout);this.bufferLayout=o.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new um(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){y_(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new Q3(this.shaderInputs.modules);for(const[t,r]of Object.entries(this.shaderInputs.modules))if(vk(r)){const o=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=o}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const r=(t==null?void 0:t.disableWarnings)??this.props.disableWarnings;e.indices&&ut.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)();const o=new um(this.bufferLayout);for(const[c,f]of Object.entries(e)){const a=o.getBufferLayout(c);if(!a){r||ut.warn(`Model(${this.id}): Missing layout for buffer "${c}".`)();continue}const y=o.getAttributeNamesForBuffer(a);let T=!1;for(const A of y){const M=this._attributeInfos[A];M&&(this.vertexArray.setBuffer(M.location,f),T=!0)}!T&&!r&&ut.warn(`Model(${this.id}): Ignoring buffer "${f.id}" for unknown attribute "${c}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[r,o]of Object.entries(e)){const c=this._attributeInfos[r];c?this.vertexArray.setConstantWebGL(c.location,o):((t==null?void 0:t.disableWarnings)??this.props.disableWarnings)||ut.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${r}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){x_(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:r}=q1(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,r),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof Am&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,r]of Object.entries(this.bindings))r instanceof Am?r.isReady&&(e[t]=r.texture):e[t]=r;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof Ld?e=Math.max(e,t.texture.updateTimestamp):t instanceof Fi||t instanceof Xi?e=Math.max(e,t.updateTimestamp):t instanceof Am?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof Nd||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[r]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(o=>o.name===r)&&r!=="positions"&&delete t[r];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(ut.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const r=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let o=null;this.source?o=r:this.fs&&(o=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:r,fs:o}),this._attributeInfos=Xw(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_logDrawCallStart(){const e=ut.level>3?0:xk;ut.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,ut.group(La,`>>> DRAWING MODEL ${this.id}`,{collapsed:ut.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=hk(this.pipeline.shaderLayout,this.id);ut.table(La,e)();const t=this.shaderInputs.getDebugTable();for(const[o,c]of Object.entries(this.uniforms))t[o]={value:c};ut.table(La,t)();const r=this._getAttributeDebugTable();ut.table(La,this._attributeInfos)(),ut.table(La,r)(),ut.groupEnd(La)(),this._logOpen=!1}}_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const r=e.props.framebuffer;r&&fk(r,{id:r.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,r]of Object.entries(this._attributeInfos)){const o=this.vertexArray.attributes[r.location];e[r.location]={name:t,type:r.shaderType,values:o?this._getBufferOrConstantValues(o,r.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,r=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:r.toString()}}return e}_getBufferOrConstantValues(e,t){const r=Yw(t);return(e instanceof Fi?new r(e.debugData):e).toString()}};G(Pp,"defaultProps",{...fc.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Fd.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let Pn=Pp;function vk(i){return!!(i.uniformTypes&&!x_(i.uniformTypes))}function bk(i){return{type:i.type,shaderLanguage:i.info.shadingLanguage,shaderLanguageVersion:i.info.shadingLanguageVersion,gpu:i.info.gpu,features:i.features}}function x_(i){for(const e in i)return!1;return!0}const lh=class lh{constructor(e,t=lh.defaultProps){G(this,"device");G(this,"model");G(this,"transformFeedback");if(!lh.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new Pn(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||i3(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var t;return((t=e==null?void 0:e.info)==null?void 0:t.type)==="webgl"}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e!=null&&e.inputBuffers&&this.model.setAttributes(e.inputBuffers),e!=null&&e.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof Fi)return t.readAsync();const{buffer:r,byteOffset:o=0,byteLength:c=r.byteLength}=t;return r.readAsync(o,c)}};G(lh,"defaultProps",{...Pn.defaultProps,outputs:void 0,feedbackBuffers:void 0});let fh=lh;class vc{constructor(e){G(this,"id");G(this,"topology");G(this,"vertexCount");G(this,"indices");G(this,"attributes");G(this,"userData",{});const{attributes:t={},indices:r=null,vertexCount:o=null}=e;this.id=e.id||Rp("geometry"),this.topology=e.topology,r&&(this.indices=ArrayBuffer.isView(r)?{value:r,size:1}:r),this.attributes={};for(const[c,f]of Object.entries(t)){const a=ArrayBuffer.isView(f)?{value:f}:f;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(c)}: must be typed array or object with value as typed array`);if((c==="POSITION"||c==="positions")&&!a.size&&(a.size=3),c==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[c]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=o||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let r=1/0;for(const o of Object.values(e)){const{value:c,size:f,constant:a}=o;!a&&c&&f!==void 0&&f>=1&&(r=Math.min(r,c.length/f))}return r}}const wk={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class Y1 extends ay{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:r,viewports:o,onViewportActive:c,pickingFBO:f,deviceRect:{x:a,y,width:T,height:A},cullRect:M,effects:F,pass:L="picking",pickZ:Y,shaderModuleProps:ae}){this.pickZ=Y;const pe=this._resetColorEncoder(Y),Ee=[a,y,T,A],Be=super.render({target:f,layers:e,layerFilter:t,views:r,viewports:o,onViewportActive:c,cullRect:M,effects:F==null?void 0:F.filter(Ce=>Ce.useInPicking),pass:L,isPicking:!0,shaderModuleProps:ae,clearColor:[0,0,0,0],colorMask:15,scissorRect:Ee});return this._colorEncoderState=null,{decodePickingColor:pe&&Sk.bind(null,pe),stats:Be}}shouldDrawLayer(e){const{pickable:t,operation:r}=e.props;return t&&r.includes("draw")||r.includes("terrain")||r.includes("mask")}getShaderModuleProps(e,t,r){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,r){const o={...e.props.parameters},{pickable:c,operation:f}=e.props;return!this._colorEncoderState||f.includes("terrain")?o.blend=!1:c&&f.includes("draw")&&(Object.assign(o,wk),o.blend=!0,o.blendColor=Tk(this._colorEncoderState,e,r)),o}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function Tk(i,e,t){const{byLayer:r,byAlpha:o}=i;let c,f=r.get(e);return f?(f.viewports.push(t),c=f.a):(c=r.size+1,c<=255?(f={a:c,layer:e,viewports:[t]},r.set(e,f),o[c]=f):(ri.warn("Too many pickable layers, only picking the first 255")(),c=0)),[0,0,0,c/255]}function Sk(i,e){const t=i.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const tc={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Qd=Symbol.for("component"),Qo=Symbol.for("propTypes"),Pm=Symbol.for("deprecatedProps"),cc=Symbol.for("asyncPropDefaults"),qa=Symbol.for("asyncPropOriginal"),Go=Symbol.for("asyncPropResolved");function ly(i,e=()=>!0){return Array.isArray(i)?K1(i,e,[]):e(i)?[i]:[]}function K1(i,e,t){let r=-1;for(;++r<i.length;){const o=i[r];Array.isArray(o)?K1(o,e,t):e(o)&&t.push(o)}return t}function Ak({target:i,source:e,start:t=0,count:r=1}){const o=e.length,c=r*o;let f=0;for(let a=t;f<o;f++)i[a++]=e[f];for(;f<c;)f<c-f?(i.copyWithin(t+f,t,t+f),f*=2):(i.copyWithin(t+f,t,t+c-f),f=c);return i}class Pk{constructor(e,t,r){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=r,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const r=++this._loadCount;let o=e;typeof e=="string"&&(o=kd(e)),o instanceof Promise?(this.isLoaded=!1,this._loader=o.then(c=>{this._loadCount===r&&(this.isLoaded=!0,this._error=void 0,this._content=c)}).catch(c=>{this._loadCount===r&&(this.isLoaded=!0,this._error=c||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const c of this._subscribers)c.onChange(this.getData())}}class Ek{constructor(e){var t;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(t=e.device)==null?void 0:t.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:r=!1,persistent:o=!0}){let c=this._resources[e];c?c.setData(t,r):(c=new Pk(e,t,this._context),this._resources[e]=c),c.persistent=o}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const r in t){const o=t[r],c=this._resources[o.resourceId];c&&c.unsubscribe(o)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:r,requestId:o="default"}){const{_resources:c,protocol:f}=this;e.startsWith(f)&&(e=e.replace(f,""),c[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=c[e];if(this._track(r,o,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,r,o){const c=this._consumers,f=c[e]=c[e]||{};let a=f[t];const y=a&&a.resourceId&&this._resources[a.resourceId];y&&(y.unsubscribe(a),this.prune()),r&&(a?(a.onChange=o,a.resourceId=r.id):a={onChange:o,resourceId:r.id},f[t]=a,r.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const Ik="layerManager.setLayers",Ck="layerManager.activateViewport";class Mk{constructor(e,t){var a;this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=y=>{Nr(Ck,this,y),y&&(this.context.viewport=y)};const{deck:r,stats:o,viewport:c,timeline:f}=t||{};this.layers=[],this.resourceManager=new Ek({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:r,shaderAssembler:MR(((a=e==null?void 0:e.info)==null?void 0:a.shadingLanguage)||"glsl"),defaultShaderModules:[UC],renderPass:void 0,stats:o||new Ep({id:"deck.gl"}),viewport:c||new Sh({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:f||new Z1,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const r of this.layers){const o=r.getNeedsRedraw(e);t=t||o}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(r=>t.id.indexOf(r)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){Nr(Ik,this,t,e),this._lastRenderedLayers=e;const r=ly(e,Boolean);for(const o of r)o.context=this.context;this._updateLayers(this.layers,r)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(r=>r.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,r=t.findIndex(o=>o.name===e.name);r>=0&&(t.splice(r,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,r){r.raiseError(t,`${e} of ${r}`)}_updateLayers(e,t){const r={};for(const f of e)r[f.id]?ri.warn(`Multiple old layers with same id ${f.id}`)():r[f.id]=f;if(this._defaultShaderModulesChanged){for(const f of e)f.setNeedsUpdate(),f.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const o=[];this._updateSublayersRecursively(t,r,o),this._finalizeOldLayers(r);let c=!1;for(const f of o)if(f.hasUniformTransition()){c=`Uniform transition in ${f}`;break}this._needsUpdate=c,this.layers=o}_updateSublayersRecursively(e,t,r){for(const o of e){o.context=this.context;const c=t[o.id];c===null&&ri.warn(`Multiple new layers with same id ${o.id}`)(),t[o.id]=null;let f=null;try{this._debug&&c!==o&&o.validateProps(),c?(this._transferLayerState(c,o),this._updateLayer(o)):this._initializeLayer(o),r.push(o),f=o.isComposite?o.getSubLayers():null}catch(a){this._handleError("matching",a,o)}f&&this._updateSublayersRecursively(f,t,r)}}_finalizeOldLayers(e){for(const t in e){const r=e[t];r&&this._finalizeLayer(r)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=tc.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=tc.MATCHED,t!==e&&(e.lifecycle=tc.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=tc.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=tc.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function Gn(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Gn(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),o=Object.keys(e);if(r.length!==o.length)return!1;for(const c of r)if(!e.hasOwnProperty(c)||!Gn(i[c],e[c],t-1))return!1;return!0}return!1}class Rk{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,r=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(r):r}getViewport(e){return this._viewportMap[e]}unproject(e,t){const r=this.getViewports(),o={x:e[0],y:e[1]};for(let c=r.length-1;c>=0;--c){const f=r[c];if(f.containsPixel(o)){const a=e.slice();return a[0]-=f.x,a[1]-=f.y,f.unproject(a,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=ly(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Gn(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):ri.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const r=t.type;return new r({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:c=>{var f;return(f=this.getView(e.id))==null?void 0:f.makeViewport({viewState:c,width:this.width,height:this.height})}})}_updateController(e,t,r,o){const c=e.controller;if(c&&r){const f={...t,...c,id:e.id,x:r.x,y:r.y,width:r.width,height:r.height};return(!o||o.constructor!==c.type)&&(o=this._createController(e,f)),o&&o.setProps(f),o}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let r=!1;for(let o=e.length;o--;){const c=e[o],f=this.getViewState(c),a=c.makeViewport({viewState:f,width:this.width,height:this.height});let y=t[c.id];const T=!!c.controller;T&&!y&&(r=!0),(r||!T)&&y&&(y.finalize(),y=null),this.controllers[c.id]=this._updateController(c,f,a,y),a&&this._viewports.unshift(a)}for(const o in t){const c=t[o];c&&!this.controllers[o]&&c.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((r,o)=>!e[o].equals(t[o]))}}const kk=/([0-9]+\.?[0-9]*)(%|px)/;function zo(i){switch(typeof i){case"number":return{position:i,relative:!1};case"string":const e=kk.exec(i);if(e&&e.length>=3){const t=e[2]==="%",r=parseFloat(e[1]);return{position:t?r/100:r,relative:t}}default:throw new Error(`Could not parse position string ${i}`)}}function Uo(i,e){return i.relative?Math.round(i.position*e):i.position}class Dk{constructor(e){const{id:t,x:r=0,y:o=0,width:c="100%",height:f="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=zo(r),this._y=zo(o),this._width=zo(c),this._height=zo(f),this._padding=a&&{left:zo(a.left||0),right:zo(a.right||0),top:zo(a.top||0),bottom:zo(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&Gn(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:r}){r=this.filterViewState(r);const o=this.getDimensions({width:e,height:t});if(!o.height||!o.width)return null;const c=this.getViewportType(r);return new c({...r,...this.props,...o})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const r in this.props.viewState)r!=="id"&&(t[r]=this.props.viewState[r]);return t}return e}getDimensions({width:e,height:t}){const r={x:Uo(this._x,e),y:Uo(this._y,t),width:Uo(this._width,e),height:Uo(this._height,t)};return this._padding&&(r.padding={left:Uo(this._padding.left,e),top:Uo(this._padding.top,t),right:Uo(this._padding.right,e),bottom:Uo(this._padding.bottom,t)}),r}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}let kp=class{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var t,r;this.cancel(),this.settings=e,this._inProgress=!0,(r=(t=this.settings).onStart)==null||r.call(t,this)}end(){var e,t;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(t=(e=this.settings).onEnd)==null||t.call(e,this))}cancel(){var e,t;this._inProgress&&((t=(e=this.settings).onInterrupt)==null||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:r,settings:o}=this;this._handle=r.addChannel({delay:r.getTime(),duration:o.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(t=(e=this.settings).onUpdate)==null||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};const Lb=()=>{},v_={BREAK:1,SNAP_TO_END:2,IGNORE:3},Ok=i=>i,Fk=v_.BREAK;class Lk{constructor(e){this._onTransitionUpdate=t=>{const{time:r,settings:{interpolator:o,startProps:c,endProps:f,duration:a,easing:y}}=t,T=y(r/a),A=o.interpolateProps(c,f,T);this.propsInTransition=this.getControllerState({...this.props,...A}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new kp(e.timeline),this.onViewStateChange=e.onViewStateChange||Lb,this.onStateChange=e.onStateChange||Lb}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const r=this.props;if(this.props=e,!r||this._shouldIgnoreViewportChange(r,e))return!1;if(this._isTransitionEnabled(e)){let o=r;if(this.transition.inProgress){const{interruption:c,endProps:f}=this.transition.settings;o={...r,...c===v_.SNAP_TO_END?f:this.propsInTransition||r}}this._triggerTransition(o,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:r}=e;return(t>0||t==="auto")&&!!r}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===v_.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const r=this.getControllerState(e),o=this.getControllerState(t).shortestPathFrom(r),c=t.transitionInterpolator,f=c.getDuration?c.getDuration(e,t):t.transitionDuration;if(f===0)return;const a=c.initializeProps(e,o);this.propsInTransition={};const y={duration:f,easing:t.transitionEasing||Ok,interpolator:c,interruption:t.transitionInterruption||Fk,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(y),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(t)}}}function Er(i,e){if(!i)throw new Error(e||"deck.gl: assertion failed.")}class Bk{constructor(e){const{compare:t,extract:r,required:o}=e;this._propsToCompare=t,this._propsToExtract=r||t,this._requiredProps=o}arePropsEqual(e,t){for(const r of this._propsToCompare)if(!(r in e)||!(r in t)||!uh(e[r],t[r]))return!1;return!0}initializeProps(e,t){const r={},o={};for(const c of this._propsToExtract)(c in e||c in t)&&(r[c]=e[c],o[c]=t[c]);return this._checkRequiredProps(r),this._checkRequiredProps(o),{start:r,end:o}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const r=e[t];Er(Number.isFinite(r)||Array.isArray(r),`${t} is required for transition`)})}}const Nk=["longitude","latitude","zoom","bearing","pitch"],zk=["longitude","latitude","zoom"];class J1 extends Bk{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,r=Array.isArray(e)?{}:e;r.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:Nk,required:zk},super(r.transitionProps),this.opts=r}initializeProps(e,t){const r=super.initializeProps(e,t),{makeViewport:o,around:c}=this.opts;if(o&&c){const f=o(e),a=o(t),y=f.unproject(c);r.start.around=c,Object.assign(r.end,{around:a.project(y),aroundPosition:y,width:t.width,height:t.height})}return r}interpolateProps(e,t,r){const o={};for(const c of this._propsToExtract)o[c]=Xd(e[c]||0,t[c]||0,r);if(t.aroundPosition&&this.opts.makeViewport){const c=this.opts.makeViewport({...t,...o});Object.assign(o,c.panByPosition(t.aroundPosition,Xd(e.around,t.around,r)))}return o}}const Vo={transitionDuration:0},Uk=300,td=i=>1-(1-i)*(1-i),ec={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},Ba={};class Vk{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new Lk({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const t in this._events)this._events[t]&&((e=this.eventManager)==null||e.off(t,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:r}=this.props,{offsetCenter:o}=e;return[o.x-t,o.y-r]}isPointInBounds(e,t){const{width:r,height:o}=this.props;if(t&&t.handled)return!1;const c=e[0]>=0&&e[0]<=r&&e[1]>=0&&e[1]<=o;return c&&t&&t.stopPropagation(),c}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?Uk:0;const{scrollZoom:r=!0,dragPan:o=!0,dragRotate:c=!0,doubleClickZoom:f=!0,touchZoom:a=!0,touchRotate:y=!1,keyboard:T=!0}=e,A=!!this.onViewStateChange;this.toggleEvents(ec.WHEEL,A&&r),this.toggleEvents(ec.PAN,A),this.toggleEvents(ec.PINCH,A&&(a||y)),this.toggleEvents(ec.MULTI_PAN,A&&y),this.toggleEvents(ec.DOUBLE_CLICK,A&&f),this.toggleEvents(ec.KEYBOARD,A&&T),this.scrollZoom=r,this.dragPan=o,this.dragRotate=c,this.doubleClickZoom=f,this.touchZoom=a,this.touchRotate=y,this.keyboard=T}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(r=>{this._events[r]!==t&&(this._events[r]=t,t?this.eventManager.on(r,this.handleEvent):this.eventManager.off(r,this.handleEvent))})}updateViewport(e,t=null,r={}){const o={...e.getViewportProps(),...t},c=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(r),c){const f=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:o,interactionState:this._interactionState,oldViewState:f,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let r=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(r=!r);const o=this.controllerState[r?"panStart":"rotateStart"]({pos:t});return this._panMove=r,this.updateViewport(o,Vo,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),r=this.controllerState.pan({pos:t});return this.updateViewport(r,Vo,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const r=this.getCenter(e),o=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],c=this.controllerState.pan({pos:o}).panEnd();this.updateViewport(c,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:td},{isDragging:!1,isPanning:!0})}else{const r=this.controllerState.panEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Vo,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const r=this.getCenter(e),o=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],c=this.controllerState.rotate({pos:o}).rotateEnd();this.updateViewport(c,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:td},{isDragging:!1,isRotating:!0})}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:r=.01,smooth:o=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:c}=e;let f=2/(1+Math.exp(-Math.abs(c*r)));c<0&&f!==0&&(f=1/f);const a=this.controllerState.zoom({pos:t,scale:f});return this.updateViewport(a,{...this._getTransitionProps({around:t}),transitionDuration:o?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.rotateStart({pos:t});return this.updateViewport(r,Vo,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Vo,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const r=this.getCenter(e),o=[r[0],r[1]+=e.velocityY*t/2],c=this.controllerState.rotate({pos:o});this.updateViewport(c,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:td},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Ba._startPinchRotation=e.rotation,Ba._lastPinchEvent=e,this.updateViewport(r,Vo,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:r}=e,o=this.getCenter(e);t=t.zoom({pos:o,scale:r})}if(this.touchRotate){const{rotation:r}=e;t=t.rotate({deltaAngleX:Ba._startPinchRotation-r})}return this.updateViewport(t,Vo,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Ba._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:r}=Ba;if(this.touchZoom&&t&&r&&e.scale!==r.scale){const o=this.getCenter(e);let c=this.controllerState.rotateEnd();const f=Math.log2(e.scale),a=(f-Math.log2(r.scale))/(e.deltaTime-r.deltaTime),y=Math.pow(2,f+a*t/2);c=c.zoom({pos:o,scale:y}).zoomEnd(),this.updateViewport(c,{...this._getTransitionProps({around:o}),transitionDuration:t,transitionEasing:td},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const o=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(o,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Ba._startPinchRotation=null,Ba._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.isFunctionKeyPressed(e),o=this.controllerState.zoom({pos:t,scale:r?.5:2});return this.updateViewport(o,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:r,moveSpeed:o,rotateSpeedX:c,rotateSpeedY:f}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let y;const T={};switch(e.srcEvent.code){case"Minus":y=t?a.zoomOut(r).zoomOut(r):a.zoomOut(r),T.isZooming=!0;break;case"Equal":y=t?a.zoomIn(r).zoomIn(r):a.zoomIn(r),T.isZooming=!0;break;case"ArrowLeft":t?(y=a.rotateLeft(c),T.isRotating=!0):(y=a.moveLeft(o),T.isPanning=!0);break;case"ArrowRight":t?(y=a.rotateRight(c),T.isRotating=!0):(y=a.moveRight(o),T.isPanning=!0);break;case"ArrowUp":t?(y=a.rotateUp(f),T.isRotating=!0):(y=a.moveUp(o),T.isPanning=!0);break;case"ArrowDown":t?(y=a.rotateDown(f),T.isRotating=!0):(y=a.moveDown(o),T.isPanning=!0);break;default:return!1}return this.updateViewport(y,this._getTransitionProps(),T),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?Vo:e?{...t,transitionInterpolator:new J1({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class jk{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Bb=5,$k=1.2;class Wk extends jk{constructor(e){const{width:t,height:r,latitude:o,longitude:c,zoom:f,bearing:a=0,pitch:y=0,altitude:T=1.5,position:A=[0,0,0],maxZoom:M=20,minZoom:F=0,maxPitch:L=60,minPitch:Y=0,startPanLngLat:ae,startZoomLngLat:pe,startRotatePos:Ee,startBearing:Be,startPitch:xe,startZoom:Ce,normalize:tt=!0}=e;Er(Number.isFinite(c)),Er(Number.isFinite(o)),Er(Number.isFinite(f)),super({width:t,height:r,latitude:o,longitude:c,zoom:f,bearing:a,pitch:y,altitude:T,maxZoom:M,minZoom:F,maxPitch:L,minPitch:Y,normalize:tt,position:A},{startPanLngLat:ae,startZoomLngLat:pe,startRotatePos:Ee,startBearing:Be,startPitch:xe,startZoom:Ce}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const r=this.getState().startPanLngLat||this._unproject(t);if(!r)return this;const c=this.makeViewport(this.getViewportProps()).panByPosition(r,e);return this._getUpdatedState(c)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:r=0}){const{startRotatePos:o,startBearing:c,startPitch:f}=this.getState();if(!o||c===void 0||f===void 0)return this;let a;return e?a=this._getNewRotation(e,o,f,c):a={bearing:c+t,pitch:f+r},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:r}){let{startZoom:o,startZoomLngLat:c}=this.getState();if(c||(o=this.getViewportProps().zoom,c=this._unproject(t)||this._unproject(e)),!c)return this;const{maxZoom:f,minZoom:a}=this.getViewportProps();let y=o+Math.log2(r);y=qo(y,a,f);const T=this.makeViewport({...this.getViewportProps(),zoom:y});return this._getUpdatedState({zoom:y,...T.panByPosition(c,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),r={...this.getViewportProps()},{bearing:o,longitude:c}=r;return Math.abs(o-t.bearing)>180&&(r.bearing=o<0?o+360:o-360),Math.abs(c-t.longitude)>180&&(r.longitude=c<0?c+360:c-360),r}applyConstraints(e){const{maxZoom:t,minZoom:r,zoom:o}=e;e.zoom=qo(o,r,t);const{maxPitch:c,minPitch:f,pitch:a}=e;e.pitch=qo(a,f,c);const{normalize:y=!0}=e;return y&&Object.assign(e,pR(e)),e}_zoomFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.zoom({pos:[t/2,r/2],scale:e})}_panFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.pan({startPos:[t/2,r/2],pos:[t/2+e[0],r/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,r,o){const c=e[0]-t[0],f=e[1]-t[1],a=e[1],y=t[1],{width:T,height:A}=this.getViewportProps(),M=c/T;let F=0;f>0?Math.abs(A-y)>Bb&&(F=f/(y-A)*$k):f<0&&y>Bb&&(F=1-a/y),F=qo(F,-1,1);const{minPitch:L,maxPitch:Y}=this.getViewportProps(),ae=o+180*M;let pe=r;return F>0?pe=r+F*(Y-r):F<0&&(pe=r-F*(L-r)),{pitch:pe,bearing:ae}}}class Hk extends Vk{constructor(){super(...arguments),this.ControllerState=Wk,this.transition={transitionDuration:300,transitionInterpolator:new J1({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class Q1 extends Dk{constructor(e={}){super(e)}getViewportType(){return xc}get ControllerType(){return Hk}}Q1.displayName="MapView";const Zk=new W1;function Xk(i,e){const t=i.order??1/0,r=e.order??1/0;return t-r}class qk{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(r=>r.id===e.id)){const r=t.findIndex(o=>Xk(o,e)>0);r<0?t.push(e):t.splice(r,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(Gn(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const o of this.effects)t[o.id]=o;const r=[];for(const o of e){const c=t[o.id];let f=o;c&&c!==o?c.setProps?(c.setProps(o.props),f=c):c.cleanup(this._context):c||o.setup(this._context),r.push(f),delete t[o.id]}for(const o in t)t[o].cleanup(this._context);this.effects=r,this._resolvedEffects=r.concat(this._defaultEffects),e.some(o=>o instanceof W1)||this._resolvedEffects.push(Zk),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class Gk extends ay{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const Yk="deckRenderer.renderLayers";class Kk{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new Gk(e),this.pickLayersPass=new Y1(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,r={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};r.effects&&this._preRender(r.effects,r);const o=this.lastPostProcessEffect?this.renderBuffers[0]:r.target;this.lastPostProcessEffect&&(r.clearColor=[0,0,0,0],r.clearCanvas=!0);const c=t.render({...r,target:o});r.effects&&this._postRender(r.effects,r),this.renderCount++,Nr(Yk,this,c,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const r of e)t.preRenderStats[r.id]=r.preRender(t),r.postRender&&(this.lastPostProcessEffect=r.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(r=>{const o=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${r}`,colorAttachments:[o]}))});for(const r of e)r.resize(t)}_postRender(e,t){const{renderBuffers:r}=this,o={...t,inputBuffer:r[0],swapBuffer:r[1]};for(const c of e)if(c.postRender){o.target=c.id===this.lastPostProcessEffect?t.target:void 0;const f=c.postRender(o);o.inputBuffer=f,o.swapBuffer=f===r[0]?r[1]:r[0]}}}const Jk={pickedColor:null,pickedObjectIndex:-1};function Qk({pickedColors:i,decodePickingColor:e,deviceX:t,deviceY:r,deviceRadius:o,deviceRect:c}){const{x:f,y:a,width:y,height:T}=c;let A=o*o,M=-1,F=0;for(let L=0;L<T;L++){const Y=L+a-r,ae=Y*Y;if(ae>A)F+=4*y;else for(let pe=0;pe<y;pe++){if(i[F+3]-1>=0){const Be=pe+f-t,xe=Be*Be+ae;xe<=A&&(A=xe,M=F)}F+=4}}if(M>=0){const L=i.slice(M,M+4),Y=e(L);if(Y){const ae=Math.floor(M/4/y),pe=M/4-ae*y;return{...Y,pickedColor:L,pickedX:f+pe,pickedY:a+ae}}ri.error("Picked non-existent layer. Is picking buffer corrupt?")()}return Jk}function eD({pickedColors:i,decodePickingColor:e}){const t=new Map;if(i){for(let r=0;r<i.length;r+=4)if(i[r+3]-1>=0){const c=i.slice(r,r+4),f=c.join(",");if(!t.has(f)){const a=e(c);a?t.set(f,{...a,color:c}):ri.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function e2({pickInfo:i,viewports:e,pixelRatio:t,x:r,y:o,z:c}){let f=e[0];e.length>1&&(f=iD((i==null?void 0:i.pickedViewports)||e,{x:r,y:o}));let a;if(f){const y=[r-f.x,o-f.y];c!==void 0&&(y[2]=c),a=f.unproject(y)}return{color:null,layer:null,viewport:f,index:-1,picked:!1,x:r,y:o,pixel:[r,o],coordinate:a,devicePixel:i&&"pickedX"in i?[i.pickedX,i.pickedY]:void 0,pixelRatio:t}}function tD(i){const{pickInfo:e,lastPickedInfo:t,mode:r,layers:o}=i,{pickedColor:c,pickedLayer:f,pickedObjectIndex:a}=e,y=f?[f]:[];if(r==="hover"){const M=t.index,F=t.layerId,L=f?f.props.id:null;if(L!==F||a!==M){if(L!==F){const Y=o.find(ae=>ae.props.id===F);Y&&y.unshift(Y)}t.layerId=L,t.index=a,t.info=null}}const T=e2(i),A=new Map;return A.set(null,T),y.forEach(M=>{let F={...T};M===f&&(F.color=c,F.index=a,F.picked=!0),F=t2({layer:M,info:F,mode:r});const L=F.layer;M===f&&r==="hover"&&(t.info=F),A.set(L.id,F),r==="hover"&&L.updateAutoHighlight(F)}),A}function t2({layer:i,info:e,mode:t}){for(;i&&e;){const r=e.layer||null;e.sourceLayer=r,e.layer=i,e=i.getPickingInfo({info:e,mode:t,sourceLayer:r}),i=i.parent}return e}function iD(i,e){for(let t=i.length-1;t>=0;t--){const r=i[t];if(r.containsPixel(e))return r}return i[0]}class rD{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new Y1(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:r,viewports:o},c=this.lastPickedInfo.info){const f=c&&c.layer&&c.layer.id,a=c&&c.viewport&&c.viewport.id,y=f?r.find(F=>F.id===f):null,T=a&&o.find(F=>F.id===a)||o[0],A=T&&T.unproject([e-T.x,t-T.y]);return{...c,...{x:e,y:t,viewport:T,coordinate:A,layer:y}}}_resizeBuffer(){var t,r;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const o=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=o}const{canvas:e}=this.device.getDefaultCanvasContext();(t=this.pickingFBO)==null||t.resize({width:e.width,height:e.height}),(r=this.depthFBO)==null||r.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(r=>this.pickLayersPass.shouldDrawLayer(r)&&!r.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:r,x:o,y:c,radius:f=0,depth:a=1,mode:y="query",unproject3D:T,onViewportActive:A,effects:M}){const F=this.device.canvasContext.cssToDeviceRatio(),L=this._getPickable(e);if(!L||r.length===0)return{result:[],emptyInfo:e2({viewports:r,x:o,y:c,pixelRatio:F})};this._resizeBuffer();const Y=this.device.canvasContext.cssToDevicePixels([o,c],!0),ae=[Y.x+Math.floor(Y.width/2),Y.y+Math.floor(Y.height/2)],pe=Math.round(f*F),{width:Ee,height:Be}=this.pickingFBO,xe=this._getPickingRect({deviceX:ae[0],deviceY:ae[1],deviceRadius:pe,deviceWidth:Ee,deviceHeight:Be}),Ce={x:o-f,y:c-f,width:f*2+1,height:f*2+1};let tt;const Xe=[],gt=new Set;for(let ft=0;ft<a;ft++){let yt;if(xe){const Pt=this._drawAndSample({layers:L,views:t,viewports:r,onViewportActive:A,deviceRect:xe,cullRect:Ce,effects:M,pass:`picking:${y}`});yt=Qk({...Pt,deviceX:ae[0],deviceY:ae[1],deviceRadius:pe,deviceRect:xe})}else yt={pickedColor:null,pickedObjectIndex:-1};let Bt;if(yt.pickedLayer&&T&&this.depthFBO){const{pickedColors:Pt}=this._drawAndSample({layers:[yt.pickedLayer],views:t,viewports:r,onViewportActive:A,deviceRect:{x:yt.pickedX,y:yt.pickedY,width:1,height:1},cullRect:Ce,effects:M,pass:`picking:${y}:z`},!0);Pt[3]&&(Bt=Pt[0])}yt.pickedLayer&&ft+1<a&&(gt.add(yt.pickedLayer),yt.pickedLayer.disablePickingIndex(yt.pickedObjectIndex)),tt=tD({pickInfo:yt,lastPickedInfo:this.lastPickedInfo,mode:y,layers:L,viewports:r,x:o,y:c,z:Bt,pixelRatio:F});for(const Pt of tt.values())Pt.layer&&Xe.push(Pt);if(!yt.pickedColor)break}for(const ft of gt)ft.restorePickingColors();return{result:Xe,emptyInfo:tt.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:r,x:o,y:c,width:f=1,height:a=1,mode:y="query",maxObjects:T=null,onViewportActive:A,effects:M}){const F=this._getPickable(e);if(!F||r.length===0)return[];this._resizeBuffer();const L=this.device.canvasContext.cssToDeviceRatio(),Y=this.device.canvasContext.cssToDevicePixels([o,c],!0),ae=Y.x,pe=Y.y+Y.height,Ee=this.device.canvasContext.cssToDevicePixels([o+f,c+a],!0),Be=Ee.x+Ee.width,xe=Ee.y,Ce={x:ae,y:xe,width:Be-ae,height:pe-xe},tt=this._drawAndSample({layers:F,views:t,viewports:r,onViewportActive:A,deviceRect:Ce,cullRect:{x:o,y:c,width:f,height:a},effects:M,pass:`picking:${y}`}),Xe=eD(tt),gt=new Map,ft=[],yt=Number.isFinite(T);for(let Bt=0;Bt<Xe.length&&!(yt&&ft.length>=T);Bt++){const Pt=Xe[Bt];let Lt={color:Pt.pickedColor,layer:null,index:Pt.pickedObjectIndex,picked:!0,x:o,y:c,pixelRatio:L};Lt=t2({layer:Pt.pickedLayer,info:Lt,mode:y});const Dt=Lt.layer.id;gt.has(Dt)||gt.set(Dt,new Set);const kt=gt.get(Dt),ji=Lt.object??Lt.index;kt.has(ji)||(kt.add(ji),ft.push(Lt))}return ft}_drawAndSample({layers:e,views:t,viewports:r,onViewportActive:o,deviceRect:c,cullRect:f,effects:a,pass:y},T=!1){const A=T?this.depthFBO:this.pickingFBO,M={layers:e,layerFilter:this.layerFilter,views:t,viewports:r,onViewportActive:o,pickingFBO:A,deviceRect:c,cullRect:f,effects:a,pass:y,pickZ:T,preRenderStats:{},isPicking:!0};for(const Be of a)Be.useInPicking&&(M.preRenderStats[Be.id]=Be.preRender(M));const{decodePickingColor:F}=this.pickLayersPass.render(M),{x:L,y:Y,width:ae,height:pe}=c,Ee=new(T?Float32Array:Uint8Array)(ae*pe*4);return this.device.readPixelsToArrayWebGL(A,{sourceX:L,sourceY:Y,sourceWidth:ae,sourceHeight:pe,target:Ee}),{pickedColors:Ee,decodePickingColor:F}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:r,deviceWidth:o,deviceHeight:c}){const f=Math.max(0,e-r),a=Math.max(0,t-r),y=Math.min(o,e+r+1)-f,T=Math.min(c,t+r+1)-a;return y<=0||T<=0?null:{x:f,y:a,width:y,height:T}}}const nD={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},sD="top-left",Nb="__root";class oD{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!Gn(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const r of this.resolvedWidgets)t[r.id]=r;this.resolvedWidgets.length=0;for(const r of this.defaultWidgets)t[r.id]=null,this.resolvedWidgets.push(r);for(let r of e){const o=t[r.id];o?o.viewId!==r.viewId||o.placement!==r.placement?(this._remove(o),this._add(r)):r!==o&&(o.setProps(r.props),r=o):this._add(r),t[r.id]=null,this.resolvedWidgets.push(r)}for(const r in t){const o=t[r];o&&this._remove(o)}this.widgets=e}_add(e){const{viewId:t=null,placement:r=sD}=e,o=e.onAdd({deck:this.deck,viewId:t});o&&this._getContainer(t,r).append(o),e._element=o}_remove(e){var t;(t=e.onRemove)==null||t.call(e),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){var f;const r=e||Nb;let o=this.containers[r];o||(o=document.createElement("div"),o.style.pointerEvents="none",o.style.position="absolute",o.style.overflow="hidden",(f=this.parentElement)==null||f.append(o),this.containers[r]=o);let c=o.querySelector(`.${t}`);return c||(c=document.createElement("div"),c.className=t,c.style.position="absolute",c.style.zIndex="2",Object.assign(c.style,nD[t]),o.append(c)),c}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const r in this.containers){const o=this.lastViewports[r]||null,c=r===Nb||o,f=this.containers[r];c?(f.style.display="block",f.style.left=`${o?o.x:0}px`,f.style.top=`${o?o.y:0}px`,f.style.width=`${o?o.width:e}px`,f.style.height=`${o?o.height:t}px`):f.style.display="none"}}onRedraw({viewports:e,layers:t}){var o,c;const r=e.reduce((f,a)=>(f[a.id]=a,f),{});for(const f of this.getWidgets()){const{viewId:a}=f;if(a){const y=r[a];y&&(f.onViewportChange&&f.onViewportChange(y),(o=f.onRedraw)==null||o.call(f,{viewports:[y],layers:t}))}else{if(f.onViewportChange)for(const y of e)f.onViewportChange(y);(c=f.onRedraw)==null||c.call(f,{viewports:e,layers:t})}}this.lastViewports=r,this._updateContainers()}onHover(e,t){var r,o;for(const c of this.getWidgets()){const{viewId:f}=c;(!f||f===((r=e.viewport)==null?void 0:r.id))&&((o=c.onHover)==null||o.call(c,e,t))}}onEvent(e,t){var o,c;const r=f_[t.type];if(r)for(const f of this.getWidgets()){const{viewId:a}=f;(!a||a===((o=e.viewport)==null?void 0:o.id))&&((c=f[r])==null||c.call(f,e,t))}}}const aD={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class lD{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,aD),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var t;this.isVisible&&e.id===((t=this.lastViewport)==null?void 0:t.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,r=t&&t.props.getTooltip;if(!r)return;const o=r(e);this.lastViewport=e.viewport,this.setTooltip(o,e.x,e.y)}setTooltip(e,t,r){const o=this.element;if(o){if(typeof e=="string")o.innerText=e;else if(e)e.text&&(o.innerText=e.text),e.html&&(o.innerHTML=e.html),e.className&&(o.className=e.className);else{this.isVisible=!1,o.style.display="none";return}this.isVisible=!0,o.style.display="block",o.style.transform=`translate(${t}px, ${r}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(o.style,e.style)}}}var rc;(function(i){i[i.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",i[i.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",i[i.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",i[i.POINTS=0]="POINTS",i[i.LINES=1]="LINES",i[i.LINE_LOOP=2]="LINE_LOOP",i[i.LINE_STRIP=3]="LINE_STRIP",i[i.TRIANGLES=4]="TRIANGLES",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLE_FAN=6]="TRIANGLE_FAN",i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.FUNC_ADD=32774]="FUNC_ADD",i[i.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",i[i.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",i[i.BLEND_EQUATION=32777]="BLEND_EQUATION",i[i.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",i[i.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",i[i.BLEND_DST_RGB=32968]="BLEND_DST_RGB",i[i.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",i[i.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",i[i.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",i[i.BLEND_COLOR=32773]="BLEND_COLOR",i[i.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",i[i.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",i[i.LINE_WIDTH=2849]="LINE_WIDTH",i[i.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",i[i.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",i[i.CULL_FACE_MODE=2885]="CULL_FACE_MODE",i[i.FRONT_FACE=2886]="FRONT_FACE",i[i.DEPTH_RANGE=2928]="DEPTH_RANGE",i[i.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",i[i.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",i[i.DEPTH_FUNC=2932]="DEPTH_FUNC",i[i.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",i[i.STENCIL_FUNC=2962]="STENCIL_FUNC",i[i.STENCIL_FAIL=2964]="STENCIL_FAIL",i[i.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",i[i.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",i[i.STENCIL_REF=2967]="STENCIL_REF",i[i.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",i[i.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",i[i.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",i[i.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",i[i.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",i[i.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",i[i.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",i[i.VIEWPORT=2978]="VIEWPORT",i[i.SCISSOR_BOX=3088]="SCISSOR_BOX",i[i.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",i[i.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",i[i.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",i[i.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",i[i.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",i[i.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",i[i.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",i[i.RED_BITS=3410]="RED_BITS",i[i.GREEN_BITS=3411]="GREEN_BITS",i[i.BLUE_BITS=3412]="BLUE_BITS",i[i.ALPHA_BITS=3413]="ALPHA_BITS",i[i.DEPTH_BITS=3414]="DEPTH_BITS",i[i.STENCIL_BITS=3415]="STENCIL_BITS",i[i.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",i[i.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",i[i.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",i[i.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",i[i.SAMPLES=32937]="SAMPLES",i[i.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",i[i.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",i[i.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",i[i.VENDOR=7936]="VENDOR",i[i.RENDERER=7937]="RENDERER",i[i.VERSION=7938]="VERSION",i[i.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",i[i.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",i[i.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",i[i.STATIC_DRAW=35044]="STATIC_DRAW",i[i.STREAM_DRAW=35040]="STREAM_DRAW",i[i.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",i[i.BUFFER_SIZE=34660]="BUFFER_SIZE",i[i.BUFFER_USAGE=34661]="BUFFER_USAGE",i[i.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",i[i.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",i[i.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",i[i.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",i[i.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",i[i.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",i[i.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",i[i.CULL_FACE=2884]="CULL_FACE",i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK",i[i.BLEND=3042]="BLEND",i[i.DEPTH_TEST=2929]="DEPTH_TEST",i[i.DITHER=3024]="DITHER",i[i.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",i[i.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",i[i.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",i[i.SCISSOR_TEST=3089]="SCISSOR_TEST",i[i.STENCIL_TEST=2960]="STENCIL_TEST",i[i.NO_ERROR=0]="NO_ERROR",i[i.INVALID_ENUM=1280]="INVALID_ENUM",i[i.INVALID_VALUE=1281]="INVALID_VALUE",i[i.INVALID_OPERATION=1282]="INVALID_OPERATION",i[i.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",i[i.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",i[i.CW=2304]="CW",i[i.CCW=2305]="CCW",i[i.DONT_CARE=4352]="DONT_CARE",i[i.FASTEST=4353]="FASTEST",i[i.NICEST=4354]="NICEST",i[i.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.DOUBLE=5130]="DOUBLE",i[i.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",i[i.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",i[i.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",i[i.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",i[i.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",i[i.VERTEX_SHADER=35633]="VERTEX_SHADER",i[i.COMPILE_STATUS=35713]="COMPILE_STATUS",i[i.DELETE_STATUS=35712]="DELETE_STATUS",i[i.LINK_STATUS=35714]="LINK_STATUS",i[i.VALIDATE_STATUS=35715]="VALIDATE_STATUS",i[i.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",i[i.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",i[i.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",i[i.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",i[i.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",i[i.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",i[i.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",i[i.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",i[i.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",i[i.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",i[i.SHADER_TYPE=35663]="SHADER_TYPE",i[i.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",i[i.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",i[i.NEVER=512]="NEVER",i[i.LESS=513]="LESS",i[i.EQUAL=514]="EQUAL",i[i.LEQUAL=515]="LEQUAL",i[i.GREATER=516]="GREATER",i[i.NOTEQUAL=517]="NOTEQUAL",i[i.GEQUAL=518]="GEQUAL",i[i.ALWAYS=519]="ALWAYS",i[i.KEEP=7680]="KEEP",i[i.REPLACE=7681]="REPLACE",i[i.INCR=7682]="INCR",i[i.DECR=7683]="DECR",i[i.INVERT=5386]="INVERT",i[i.INCR_WRAP=34055]="INCR_WRAP",i[i.DECR_WRAP=34056]="DECR_WRAP",i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",i[i.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",i[i.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",i[i.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",i[i.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",i[i.TEXTURE_2D=3553]="TEXTURE_2D",i[i.TEXTURE=5890]="TEXTURE",i[i.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",i[i.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",i[i.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",i[i.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",i[i.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",i[i.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",i[i.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",i[i.TEXTURE0=33984]="TEXTURE0",i[i.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",i[i.REPEAT=10497]="REPEAT",i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",i[i.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_CUBE=35680]="SAMPLER_CUBE",i[i.LOW_FLOAT=36336]="LOW_FLOAT",i[i.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",i[i.HIGH_FLOAT=36338]="HIGH_FLOAT",i[i.LOW_INT=36339]="LOW_INT",i[i.MEDIUM_INT=36340]="MEDIUM_INT",i[i.HIGH_INT=36341]="HIGH_INT",i[i.FRAMEBUFFER=36160]="FRAMEBUFFER",i[i.RENDERBUFFER=36161]="RENDERBUFFER",i[i.RGBA4=32854]="RGBA4",i[i.RGB5_A1=32855]="RGB5_A1",i[i.RGB565=36194]="RGB565",i[i.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",i[i.STENCIL_INDEX=6401]="STENCIL_INDEX",i[i.STENCIL_INDEX8=36168]="STENCIL_INDEX8",i[i.DEPTH_STENCIL=34041]="DEPTH_STENCIL",i[i.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",i[i.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",i[i.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",i[i.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",i[i.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",i[i.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",i[i.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",i[i.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",i[i.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",i[i.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",i[i.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",i[i.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",i[i.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",i[i.NONE=0]="NONE",i[i.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",i[i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",i[i.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",i[i.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",i[i.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",i[i.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",i[i.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",i[i.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",i[i.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",i[i.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",i[i.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",i[i.READ_BUFFER=3074]="READ_BUFFER",i[i.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",i[i.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",i[i.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",i[i.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",i[i.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",i[i.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",i[i.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",i[i.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",i[i.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",i[i.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",i[i.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",i[i.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",i[i.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",i[i.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",i[i.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",i[i.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",i[i.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",i[i.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",i[i.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",i[i.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",i[i.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",i[i.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",i[i.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",i[i.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",i[i.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",i[i.RED=6403]="RED",i[i.RGB8=32849]="RGB8",i[i.RGBA8=32856]="RGBA8",i[i.RGB10_A2=32857]="RGB10_A2",i[i.TEXTURE_3D=32879]="TEXTURE_3D",i[i.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",i[i.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",i[i.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",i[i.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",i[i.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",i[i.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",i[i.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",i[i.SRGB=35904]="SRGB",i[i.SRGB8=35905]="SRGB8",i[i.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",i[i.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",i[i.RGBA32F=34836]="RGBA32F",i[i.RGB32F=34837]="RGB32F",i[i.RGBA16F=34842]="RGBA16F",i[i.RGB16F=34843]="RGB16F",i[i.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",i[i.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",i[i.R11F_G11F_B10F=35898]="R11F_G11F_B10F",i[i.RGB9_E5=35901]="RGB9_E5",i[i.RGBA32UI=36208]="RGBA32UI",i[i.RGB32UI=36209]="RGB32UI",i[i.RGBA16UI=36214]="RGBA16UI",i[i.RGB16UI=36215]="RGB16UI",i[i.RGBA8UI=36220]="RGBA8UI",i[i.RGB8UI=36221]="RGB8UI",i[i.RGBA32I=36226]="RGBA32I",i[i.RGB32I=36227]="RGB32I",i[i.RGBA16I=36232]="RGBA16I",i[i.RGB16I=36233]="RGB16I",i[i.RGBA8I=36238]="RGBA8I",i[i.RGB8I=36239]="RGB8I",i[i.RED_INTEGER=36244]="RED_INTEGER",i[i.RGB_INTEGER=36248]="RGB_INTEGER",i[i.RGBA_INTEGER=36249]="RGBA_INTEGER",i[i.R8=33321]="R8",i[i.RG8=33323]="RG8",i[i.R16F=33325]="R16F",i[i.R32F=33326]="R32F",i[i.RG16F=33327]="RG16F",i[i.RG32F=33328]="RG32F",i[i.R8I=33329]="R8I",i[i.R8UI=33330]="R8UI",i[i.R16I=33331]="R16I",i[i.R16UI=33332]="R16UI",i[i.R32I=33333]="R32I",i[i.R32UI=33334]="R32UI",i[i.RG8I=33335]="RG8I",i[i.RG8UI=33336]="RG8UI",i[i.RG16I=33337]="RG16I",i[i.RG16UI=33338]="RG16UI",i[i.RG32I=33339]="RG32I",i[i.RG32UI=33340]="RG32UI",i[i.R8_SNORM=36756]="R8_SNORM",i[i.RG8_SNORM=36757]="RG8_SNORM",i[i.RGB8_SNORM=36758]="RGB8_SNORM",i[i.RGBA8_SNORM=36759]="RGBA8_SNORM",i[i.RGB10_A2UI=36975]="RGB10_A2UI",i[i.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",i[i.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",i[i.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",i[i.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",i[i.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",i[i.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",i[i.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",i[i.HALF_FLOAT=5131]="HALF_FLOAT",i[i.RG=33319]="RG",i[i.RG_INTEGER=33320]="RG_INTEGER",i[i.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",i[i.CURRENT_QUERY=34917]="CURRENT_QUERY",i[i.QUERY_RESULT=34918]="QUERY_RESULT",i[i.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",i[i.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",i[i.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",i[i.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",i[i.DRAW_BUFFER0=34853]="DRAW_BUFFER0",i[i.DRAW_BUFFER1=34854]="DRAW_BUFFER1",i[i.DRAW_BUFFER2=34855]="DRAW_BUFFER2",i[i.DRAW_BUFFER3=34856]="DRAW_BUFFER3",i[i.DRAW_BUFFER4=34857]="DRAW_BUFFER4",i[i.DRAW_BUFFER5=34858]="DRAW_BUFFER5",i[i.DRAW_BUFFER6=34859]="DRAW_BUFFER6",i[i.DRAW_BUFFER7=34860]="DRAW_BUFFER7",i[i.DRAW_BUFFER8=34861]="DRAW_BUFFER8",i[i.DRAW_BUFFER9=34862]="DRAW_BUFFER9",i[i.DRAW_BUFFER10=34863]="DRAW_BUFFER10",i[i.DRAW_BUFFER11=34864]="DRAW_BUFFER11",i[i.DRAW_BUFFER12=34865]="DRAW_BUFFER12",i[i.DRAW_BUFFER13=34866]="DRAW_BUFFER13",i[i.DRAW_BUFFER14=34867]="DRAW_BUFFER14",i[i.DRAW_BUFFER15=34868]="DRAW_BUFFER15",i[i.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",i[i.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",i[i.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",i[i.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",i[i.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",i[i.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",i[i.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",i[i.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",i[i.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",i[i.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",i[i.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",i[i.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",i[i.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",i[i.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",i[i.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",i[i.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",i[i.SAMPLER_3D=35679]="SAMPLER_3D",i[i.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",i[i.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",i[i.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",i[i.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",i[i.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",i[i.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",i[i.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",i[i.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",i[i.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",i[i.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",i[i.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",i[i.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",i[i.MAX_SAMPLES=36183]="MAX_SAMPLES",i[i.SAMPLER_BINDING=35097]="SAMPLER_BINDING",i[i.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",i[i.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",i[i.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",i[i.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",i[i.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",i[i.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",i[i.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",i[i.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",i[i.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",i[i.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",i[i.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",i[i.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",i[i.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",i[i.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",i[i.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",i[i.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",i[i.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",i[i.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",i[i.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",i[i.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",i[i.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",i[i.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",i[i.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",i[i.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",i[i.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",i[i.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",i[i.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",i[i.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",i[i.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",i[i.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",i[i.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",i[i.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",i[i.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",i[i.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",i[i.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",i[i.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",i[i.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",i[i.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",i[i.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",i[i.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",i[i.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",i[i.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",i[i.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",i[i.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",i[i.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",i[i.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",i[i.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",i[i.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",i[i.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",i[i.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",i[i.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",i[i.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",i[i.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",i[i.UNIFORM_TYPE=35383]="UNIFORM_TYPE",i[i.UNIFORM_SIZE=35384]="UNIFORM_SIZE",i[i.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",i[i.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",i[i.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",i[i.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",i[i.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",i[i.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",i[i.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",i[i.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",i[i.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",i[i.OBJECT_TYPE=37138]="OBJECT_TYPE",i[i.SYNC_CONDITION=37139]="SYNC_CONDITION",i[i.SYNC_STATUS=37140]="SYNC_STATUS",i[i.SYNC_FLAGS=37141]="SYNC_FLAGS",i[i.SYNC_FENCE=37142]="SYNC_FENCE",i[i.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",i[i.UNSIGNALED=37144]="UNSIGNALED",i[i.SIGNALED=37145]="SIGNALED",i[i.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",i[i.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",i[i.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",i[i.WAIT_FAILED=37149]="WAIT_FAILED",i[i.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",i[i.COLOR=6144]="COLOR",i[i.DEPTH=6145]="DEPTH",i[i.STENCIL=6146]="STENCIL",i[i.MIN=32775]="MIN",i[i.MAX=32776]="MAX",i[i.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",i[i.STREAM_READ=35041]="STREAM_READ",i[i.STREAM_COPY=35042]="STREAM_COPY",i[i.STATIC_READ=35045]="STATIC_READ",i[i.STATIC_COPY=35046]="STATIC_COPY",i[i.DYNAMIC_READ=35049]="DYNAMIC_READ",i[i.DYNAMIC_COPY=35050]="DYNAMIC_COPY",i[i.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",i[i.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",i[i.INVALID_INDEX=4294967295]="INVALID_INDEX",i[i.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",i[i.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",i[i.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",i[i.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",i[i.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",i[i.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",i[i.R16_EXT=33322]="R16_EXT",i[i.RG16_EXT=33324]="RG16_EXT",i[i.RGB16_EXT=32852]="RGB16_EXT",i[i.RGBA16_EXT=32859]="RGBA16_EXT",i[i.R16_SNORM_EXT=36760]="R16_SNORM_EXT",i[i.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",i[i.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",i[i.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",i[i.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",i[i.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",i[i.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",i[i.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",i[i.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",i[i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",i[i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",i[i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",i[i.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",i[i.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",i[i.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",i[i.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",i[i.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",i[i.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",i[i.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",i[i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",i[i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",i[i.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",i[i.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",i[i.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",i[i.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",i[i.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",i[i.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",i[i.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",i[i.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",i[i.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",i[i.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",i[i.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",i[i.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",i[i.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",i[i.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",i[i.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",i[i.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",i[i.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",i[i.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",i[i.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",i[i.LINE_WEBGL=6913]="LINE_WEBGL",i[i.FILL_WEBGL=6914]="FILL_WEBGL",i[i.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",i[i.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",i[i.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",i[i.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",i[i.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",i[i.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",i[i.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",i[i.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",i[i.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",i[i.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",i[i.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",i[i.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",i[i.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",i[i.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",i[i.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",i[i.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",i[i.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",i[i.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",i[i.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",i[i.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",i[i.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",i[i.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",i[i.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",i[i.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(rc||(rc={}));const cy={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},or=(i,e,t)=>e?i.enable(t):i.disable(t),zb=(i,e,t)=>i.hint(t,e),un=(i,e,t)=>i.pixelStorei(t,e),Ub=(i,e,t)=>{const r=t===36006?36009:36008;return i.bindFramebuffer(r,e)},Uu=(i,e,t)=>{const o={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];i.bindBuffer(o,e)};function Em(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}const cD={3042:or,32773:(i,e)=>i.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(i,e)=>i.clearColor(...e),3107:(i,e)=>i.colorMask(...e),2884:or,2885:(i,e)=>i.cullFace(e),2929:or,2931:(i,e)=>i.clearDepth(e),2932:(i,e)=>i.depthFunc(e),2928:(i,e)=>i.depthRange(...e),2930:(i,e)=>i.depthMask(e),3024:or,35723:zb,35725:(i,e)=>i.useProgram(e),36007:(i,e)=>i.bindRenderbuffer(36161,e),36389:(i,e)=>{var t;return(t=i.bindTransformFeedback)==null?void 0:t.call(i,36386,e)},34229:(i,e)=>i.bindVertexArray(e),36006:Ub,36010:Ub,34964:Uu,36662:Uu,36663:Uu,35053:Uu,35055:Uu,2886:(i,e)=>i.frontFace(e),33170:zb,2849:(i,e)=>i.lineWidth(e),32823:or,32824:"polygonOffset",10752:"polygonOffset",35977:or,32926:or,32928:or,32938:"sampleCoverage",32939:"sampleCoverage",3089:or,3088:(i,e)=>i.scissor(...e),2960:or,2961:(i,e)=>i.clearStencil(e),2968:(i,e)=>i.stencilMaskSeparate(1028,e),36005:(i,e)=>i.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(i,e)=>i.viewport(...e),34383:or,10754:or,12288:or,12289:or,12290:or,12291:or,12292:or,12293:or,12294:or,12295:or,3333:un,3317:un,37440:un,37441:un,37443:un,3330:un,3332:un,3331:un,3314:un,32878:un,3316:un,3315:un,32877:un,framebuffer:(i,e)=>{const t=e&&"handle"in e?e.handle:e;return i.bindFramebuffer(36160,t)},blend:(i,e)=>e?i.enable(3042):i.disable(3042),blendColor:(i,e)=>i.blendColor(...e),blendEquation:(i,e)=>{const t=typeof e=="number"?[e,e]:e;i.blendEquationSeparate(...t)},blendFunc:(i,e)=>{const t=(e==null?void 0:e.length)===2?[...e,...e]:e;i.blendFuncSeparate(...t)},clearColor:(i,e)=>i.clearColor(...e),clearDepth:(i,e)=>i.clearDepth(e),clearStencil:(i,e)=>i.clearStencil(e),colorMask:(i,e)=>i.colorMask(...e),cull:(i,e)=>e?i.enable(2884):i.disable(2884),cullFace:(i,e)=>i.cullFace(e),depthTest:(i,e)=>e?i.enable(2929):i.disable(2929),depthFunc:(i,e)=>i.depthFunc(e),depthMask:(i,e)=>i.depthMask(e),depthRange:(i,e)=>i.depthRange(...e),dither:(i,e)=>e?i.enable(3024):i.disable(3024),derivativeHint:(i,e)=>{i.hint(35723,e)},frontFace:(i,e)=>i.frontFace(e),mipmapHint:(i,e)=>i.hint(33170,e),lineWidth:(i,e)=>i.lineWidth(e),polygonOffsetFill:(i,e)=>e?i.enable(32823):i.disable(32823),polygonOffset:(i,e)=>i.polygonOffset(...e),sampleCoverage:(i,e)=>i.sampleCoverage(e[0],e[1]||!1),scissorTest:(i,e)=>e?i.enable(3089):i.disable(3089),scissor:(i,e)=>i.scissor(...e),stencilTest:(i,e)=>e?i.enable(2960):i.disable(2960),stencilMask:(i,e)=>{e=Em(e)?e:[e,e];const[t,r]=e;i.stencilMaskSeparate(1028,t),i.stencilMaskSeparate(1029,r)},stencilFunc:(i,e)=>{e=Em(e)&&e.length===3?[...e,...e]:e;const[t,r,o,c,f,a]=e;i.stencilFuncSeparate(1028,t,r,o),i.stencilFuncSeparate(1029,c,f,a)},stencilOp:(i,e)=>{e=Em(e)&&e.length===3?[...e,...e]:e;const[t,r,o,c,f,a]=e;i.stencilOpSeparate(1028,t,r,o),i.stencilOpSeparate(1029,c,f,a)},viewport:(i,e)=>i.viewport(...e)};function Zi(i,e,t){return e[i]!==void 0?e[i]:t[i]}const uD={blendEquation:(i,e,t)=>i.blendEquationSeparate(Zi(32777,e,t),Zi(34877,e,t)),blendFunc:(i,e,t)=>i.blendFuncSeparate(Zi(32969,e,t),Zi(32968,e,t),Zi(32971,e,t),Zi(32970,e,t)),polygonOffset:(i,e,t)=>i.polygonOffset(Zi(32824,e,t),Zi(10752,e,t)),sampleCoverage:(i,e,t)=>i.sampleCoverage(Zi(32938,e,t),Zi(32939,e,t)),stencilFuncFront:(i,e,t)=>i.stencilFuncSeparate(1028,Zi(2962,e,t),Zi(2967,e,t),Zi(2963,e,t)),stencilFuncBack:(i,e,t)=>i.stencilFuncSeparate(1029,Zi(34816,e,t),Zi(36003,e,t),Zi(36004,e,t)),stencilOpFront:(i,e,t)=>i.stencilOpSeparate(1028,Zi(2964,e,t),Zi(2965,e,t),Zi(2966,e,t)),stencilOpBack:(i,e,t)=>i.stencilOpSeparate(1029,Zi(34817,e,t),Zi(34818,e,t),Zi(34819,e,t))},Vb={enable:(i,e)=>i({[e]:!0}),disable:(i,e)=>i({[e]:!1}),pixelStorei:(i,e,t)=>i({[e]:t}),hint:(i,e,t)=>i({[e]:t}),useProgram:(i,e)=>i({35725:e}),bindRenderbuffer:(i,e,t)=>i({36007:t}),bindTransformFeedback:(i,e,t)=>i({36389:t}),bindVertexArray:(i,e)=>i({34229:e}),bindFramebuffer:(i,e,t)=>{switch(e){case 36160:return i({36006:t,36010:t});case 36009:return i({36006:t});case 36008:return i({36010:t});default:return null}},bindBuffer:(i,e,t)=>{const r={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return r?i({[r]:t}):{valueChanged:!0}},blendColor:(i,e,t,r,o)=>i({32773:new Float32Array([e,t,r,o])}),blendEquation:(i,e)=>i({32777:e,34877:e}),blendEquationSeparate:(i,e,t)=>i({32777:e,34877:t}),blendFunc:(i,e,t)=>i({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(i,e,t,r,o)=>i({32969:e,32968:t,32971:r,32970:o}),clearColor:(i,e,t,r,o)=>i({3106:new Float32Array([e,t,r,o])}),clearDepth:(i,e)=>i({2931:e}),clearStencil:(i,e)=>i({2961:e}),colorMask:(i,e,t,r,o)=>i({3107:[e,t,r,o]}),cullFace:(i,e)=>i({2885:e}),depthFunc:(i,e)=>i({2932:e}),depthRange:(i,e,t)=>i({2928:new Float32Array([e,t])}),depthMask:(i,e)=>i({2930:e}),frontFace:(i,e)=>i({2886:e}),lineWidth:(i,e)=>i({2849:e}),polygonOffset:(i,e,t)=>i({32824:e,10752:t}),sampleCoverage:(i,e,t)=>i({32938:e,32939:t}),scissor:(i,e,t,r,o)=>i({3088:new Int32Array([e,t,r,o])}),stencilMask:(i,e)=>i({2968:e,36005:e}),stencilMaskSeparate:(i,e,t)=>i({[e===1028?2968:36005]:t}),stencilFunc:(i,e,t,r)=>i({2962:e,2967:t,2963:r,34816:e,36003:t,36004:r}),stencilFuncSeparate:(i,e,t,r,o)=>i({[e===1028?2962:34816]:t,[e===1028?2967:36003]:r,[e===1028?2963:36004]:o}),stencilOp:(i,e,t,r)=>i({2964:e,2965:t,2966:r,34817:e,34818:t,34819:r}),stencilOpSeparate:(i,e,t,r,o)=>i({[e===1028?2964:34817]:t,[e===1028?2965:34818]:r,[e===1028?2966:34819]:o}),viewport:(i,e,t,r,o)=>i({2978:[e,t,r,o]})},_s=(i,e)=>i.isEnabled(e),jb={3042:_s,2884:_s,2929:_s,3024:_s,32823:_s,32926:_s,32928:_s,3089:_s,2960:_s,35977:_s},hD=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Pc(i,e){if(dD(e))return;const t={};for(const o in e){const c=Number(o),f=cD[o];f&&(typeof f=="string"?t[f]=!0:f(i,e[o],c))}const r=i.state&&i.state.cache;if(r)for(const o in t){const c=uD[o];c(i,e,r)}}function i2(i,e=cy){if(typeof e=="number"){const o=e,c=jb[o];return c?c(i,o):i.getParameter(o)}const t=Array.isArray(e)?e:Object.keys(e),r={};for(const o of t){const c=jb[o];r[o]=c?c(i,Number(o)):i.getParameter(Number(o))}return r}function fD(i){Pc(i,cy)}function dD(i){for(const e in i)return!1;return!0}function pD(i,e){if(i===e)return!0;const t=Array.isArray(i)||ArrayBuffer.isView(i),r=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&r&&i.length===e.length){for(let o=0;o<i.length;++o)if(i[o]!==e[o])return!1;return!0}return!1}class $a{constructor(e,t){G(this,"gl");G(this,"program",null);G(this,"stateStack",[]);G(this,"enable",!0);G(this,"cache",null);G(this,"log");G(this,"initialized",!1);this.gl=e,this.log=(t==null?void 0:t.log)||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}static get(e){return e.state}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];Pc(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t.copyState?i2(e):Object.assign({},cy),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,mD(e);for(const r in Vb){const o=Vb[r];gD(e,r,o)}$b(e,"getParameter"),$b(e,"isEnabled")}_updateCache(e){let t=!1,r;const o=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const c in e){const f=e[c],a=this.cache[c];pD(f,a)||(t=!0,r=a,o&&!(c in o)&&(o[c]=a),this.cache[c]=f)}return{valueChanged:t,oldValue:r}}}function $b(i,e){const t=i[e].bind(i);i[e]=function(o){if(o===void 0||hD.has(o))return t(o);const c=$a.get(i);return o in c.cache||(c.cache[o]=t(o)),c.enable?c.cache[o]:t(o)},Object.defineProperty(i[e],"name",{value:`${e}-from-cache`,configurable:!1})}function gD(i,e,t){if(!i[e])return;const r=i[e].bind(i);i[e]=function(...c){const f=$a.get(i),{valueChanged:a,oldValue:y}=t(f._updateCache,...c);return a&&r(...c),y},Object.defineProperty(i[e],"name",{value:`${e}-to-cache`,configurable:!1})}function mD(i){const e=i.useProgram.bind(i);i.useProgram=function(r){const o=$a.get(i);o.program!==r&&(e(r),o.program=r)}}function _D(i,e,t){let r="";const o={preserveDrawingBuffer:!0,...t};let c=null;if(c||(c=i.getContext("webgl2",o)),o.failIfMajorPerformanceCaveat&&(r||(r="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow.")),!c&&!t.failIfMajorPerformanceCaveat&&(o.failIfMajorPerformanceCaveat=!1,c=i.getContext("webgl2",o),c.luma||(c.luma={}),c.luma.softwareRenderer=!0),c||(c=i.getContext("webgl",{}),c&&(c=null,r||(r="Your browser only supports WebGL1"))),!c)throw r||(r="Your browser does not support WebGL"),new Error(`Failed to create WebGL context: ${r}`);const{onContextLost:f,onContextRestored:a}=e;return i.addEventListener("webglcontextlost",y=>f(y),!1),i.addEventListener("webglcontextrestored",y=>a(y),!1),c.luma||(c.luma={}),c}function bc(i,e,t){return t[e]===void 0&&(t[e]=i.getExtension(e)||null),t[e]}function yD(i,e){const t=i.getParameter(7936),r=i.getParameter(7937);bc(i,"WEBGL_debug_renderer_info",e);const o=e.WEBGL_debug_renderer_info,c=i.getParameter(o?o.UNMASKED_VENDOR_WEBGL:7936),f=i.getParameter(o?o.UNMASKED_RENDERER_WEBGL:7937),a=c||t,y=f||r,T=i.getParameter(7938),A=r2(a,y),M=xD(a,y),F=vD(a,y);return{type:"webgl",gpu:A,gpuType:F,gpuBackend:M,vendor:a,renderer:y,version:T,shadingLanguage:"glsl",shadingLanguageVersion:300}}function r2(i,e){return/NVIDIA/i.exec(i)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(i)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(i)||/Apple/i.exec(e)?"apple":/AMD/i.exec(i)||/AMD/i.exec(e)||/ATI/i.exec(i)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e)?"software":"unknown"}function xD(i,e){return/Metal/i.exec(i)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(i)||/ANGLE/i.exec(e)?"opengl":"unknown"}function vD(i,e){if(/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e))return"cpu";switch(r2(i,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function n2(i){switch(i){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(i))}const Xu="WEBGL_compressed_texture_s3tc",qu="WEBGL_compressed_texture_s3tc_srgb",nc="EXT_texture_compression_rgtc",sc="EXT_texture_compression_bptc",bD="WEBGL_compressed_texture_etc",wD="WEBGL_compressed_texture_astc",TD="WEBGL_compressed_texture_etc1",SD="WEBGL_compressed_texture_pvrtc",AD="WEBGL_compressed_texture_atc",Wb="EXT_texture_norm16",Hb="EXT_render_snorm",PD="EXT_color_buffer_float",uy={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[Hb],"norm16-renderable-webgl":[Wb],"snorm16-renderable-webgl":[Wb,Hb],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Xu,qu,nc,sc],"texture-compression-bc5-webgl":[nc],"texture-compression-bc7-webgl":[sc],"texture-compression-etc2":[bD],"texture-compression-astc":[wD],"texture-compression-etc1-webgl":[TD],"texture-compression-pvrtc-webgl":[SD],"texture-compression-atc-webgl":[AD]};function ED(i){return i in uy}function ID(i,e,t){return(uy[e]||[]).every(o=>bc(i,o,t))}const hy={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:PD,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Xu},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:qu},"bc1-rgba-unorm":{gl:33777,x:Xu},"bc1-rgba-unorm-srgb":{gl:35916,x:qu},"bc2-rgba-unorm":{gl:33778,x:Xu},"bc2-rgba-unorm-srgb":{gl:35918,x:qu},"bc3-rgba-unorm":{gl:33779,x:Xu},"bc3-rgba-unorm-srgb":{gl:35919,x:qu},"bc4-r-unorm":{gl:36283,x:nc},"bc4-r-snorm":{gl:36284,x:nc},"bc5-rg-unorm":{gl:36285,x:nc},"bc5-rg-snorm":{gl:36286,x:nc},"bc6h-rgb-ufloat":{gl:36495,x:sc},"bc6h-rgb-float":{gl:36494,x:sc},"bc7-rgba-unorm":{gl:36492,x:sc},"bc7-rgba-unorm-srgb":{gl:36493,x:sc},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function CD(i,e,t){let r=e.create;const o=hy[e.format];return(o==null?void 0:o.gl)===void 0&&(r=!1),o!=null&&o.x&&(r=r&&!!bc(i,o.x,t)),{format:e.format,create:r&&e.create,render:r&&e.render,filter:r&&e.filter,blend:r&&e.blend,store:r&&e.store}}function s2(i){var o;const e=hy[i],t=kD(i),r=q_(i);return{internalFormat:t,format:(e==null?void 0:e.dataFormat)||RD(r.channels,r.integer,r.normalized,t),type:r.dataType?n2(r.dataType):((o=e==null?void 0:e.types)==null?void 0:o[0])||5121,compressed:r.compressed||!1}}function MD(i){switch(q_(i).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${i}`)}}function RD(i,e,t,r){if(r===6408||r===6407)return r;switch(i){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function kD(i){const e=hy[i],t=e==null?void 0:e.gl;if(t===void 0)throw new Error(`Unsupported texture format ${i}`);return t}const Zb={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class DD extends y3{constructor(t,r,o){super([],o);G(this,"gl");G(this,"extensions");G(this,"testedFeatures",new Set);this.gl=t,this.extensions=r,bc(t,"EXT_color_buffer_float",r)}*[Symbol.iterator](){const t=this.getFeatures();for(const r of t)this.has(r)&&(yield r);return[]}has(t){var r;return(r=this.disabledFeatures)!=null&&r[t]?!1:(this.testedFeatures.has(t)||(this.testedFeatures.add(t),ED(t)&&ID(this.gl,t,this.extensions)&&this.features.add(t),this.getWebGLFeature(t)&&this.features.add(t)),this.features.has(t))}initializeFeatures(){const t=this.getFeatures().filter(r=>r!=="polygon-mode-webgl");for(const r of t)this.has(r)}getFeatures(){return[...Object.keys(Zb),...Object.keys(uy)]}getWebGLFeature(t){const r=Zb[t];return typeof r=="string"?!!bc(this.gl,r,this.extensions):!!r}}class OD extends _3{constructor(t){super();G(this,"gl");G(this,"limits",{});this.gl=t}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(t){return this.limits[t]===void 0&&(this.limits[t]=this.gl.getParameter(t)),this.limits[t]||0}}class rh extends zd{constructor(t,r){super(t,r);G(this,"device");G(this,"gl");G(this,"handle");G(this,"colorAttachments",[]);G(this,"depthStencilAttachment",null);const o=r.handle===null;this.device=t,this.gl=t.gl,this.handle=this.props.handle||o?this.props.handle:this.gl.createFramebuffer(),o||(t.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const t=this.gl.bindFramebuffer(36160,this.handle);for(let r=0;r<this.colorAttachments.length;++r){const o=this.colorAttachments[r];if(o){const c=36064+r;this._attachTextureView(c,o)}}if(this.depthStencilAttachment){const r=MD(this.depthStencilAttachment.props.format);this._attachTextureView(r,this.depthStencilAttachment)}if(this.device.props.debug){const r=this.gl.checkFramebufferStatus(36160);if(r!==36053)throw new Error(`Framebuffer ${LD(r)}`)}this.gl.bindFramebuffer(36160,t)}_attachTextureView(t,r){const{gl:o}=this.device,{texture:c}=r,f=r.props.baseMipLevel,a=r.props.baseArrayLayer;switch(o.bindTexture(c.glTarget,c.handle),c.glTarget){case 35866:case 32879:o.framebufferTextureLayer(36160,t,c.handle,f,a);break;case 34067:const y=FD(a);o.framebufferTexture2D(36160,t,y,c.handle,f);break;case 3553:o.framebufferTexture2D(36160,t,3553,c.handle,f);break;default:throw new Error("Illegal texture type")}o.bindTexture(c.glTarget,null)}}function FD(i){return i<34069?i+34069:i}function LD(i){switch(i){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${i}`}}class BD extends Km{constructor(t,r){super(r);G(this,"device");G(this,"format","rgba8unorm");G(this,"depthStencilFormat","depth24plus");G(this,"presentationSize");G(this,"_framebuffer",null);this.device=t,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}get[Symbol.toStringTag](){return"WebGLCanvasContext"}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new rh(this.device,{handle:null}),this._framebuffer}update(){const t=this.getPixelSize();(t[0]!==this.presentationSize[0]||t[1]!==this.presentationSize[1])&&(this.presentationSize=t,this.resize())}resize(t){if(this.device.gl&&this.canvas){const r=this.getDevicePixelRatio(t==null?void 0:t.useDevicePixels);this.setDevicePixelRatio(r,t);return}}commit(){}}async function o2(i,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const r=document.createElement("script");return r.setAttribute("type","text/javascript"),r.setAttribute("src",i),new Promise((o,c)=>{r.onload=o,r.onerror=f=>c(new Error(`Unable to load script '${i}': ${f}`)),t.appendChild(r)})}const ND=1;let Ei=null,Xb=!1;const fy={debugSpectorJS:ut.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function zD(i){if(!globalThis.SPECTOR)try{await o2(i.debugSpectorJSUrl||fy.debugSpectorJSUrl)}catch(e){ut.warn(String(e))}}function UD(i){var e;if(i={...fy,...i},!i.debugSpectorJS)return null;if(!Ei&&globalThis.SPECTOR&&!((e=globalThis.luma)!=null&&e.spector)){ut.probe(ND,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:t}=globalThis.SPECTOR;Ei=new t,globalThis.luma&&(globalThis.luma.spector=Ei)}if(!Ei)return null;if(Xb||(Xb=!0,Ei.spyCanvases(),Ei==null||Ei.onCaptureStarted.add(t=>ut.info("Spector capture started:",t)()),Ei==null||Ei.onCapture.add(t=>{ut.info("Spector capture complete:",t)(),Ei==null||Ei.getResultUI(),Ei==null||Ei.resultView.display(),Ei==null||Ei.resultView.addCapture(t)})),i.gl){const t=i.gl,r=t.device;Ei==null||Ei.startCapture(i.gl,500),t.device=r,new Promise(o=>setTimeout(o,2e3)).then(o=>{ut.info("Spector capture stopped after 2 seconds")(),Ei==null||Ei.stopCapture()})}return Ei}const VD="https://unpkg.com/webgl-debug@2.0.1/index.js";function a2(i){return i.luma=i.luma||{},i.luma}async function jD(){Ya()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await o2(VD))}function $D(i,e={}){return e.debugWebGL||e.traceWebGL?HD(i,e):WD(i)}function WD(i){const e=a2(i);return e.realContext?e.realContext:i}function HD(i,e){if(!globalThis.WebGLDebugUtils)return ut.warn("webgl-debug not loaded")(),i;const t=a2(i);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...rc,...i});const r=globalThis.WebGLDebugUtils.makeDebugContext(i,ZD.bind(null,e),XD.bind(null,e));for(const f in rc)!(f in r)&&typeof rc[f]=="number"&&(r[f]=rc[f]);class o{}Object.setPrototypeOf(r,Object.getPrototypeOf(i)),Object.setPrototypeOf(o,r);const c=Object.create(o);return t.realContext=i,t.debugContext=c,c.debug=!0,c}function qb(i,e){e=Array.from(e).map(r=>r===void 0?"undefined":r);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(i,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${i}(${t})`}function ZD(i,e,t,r){r=Array.from(r).map(a=>a===void 0?"undefined":a);const o=globalThis.WebGLDebugUtils.glEnumToString(e),c=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,r),f=`${o} in gl.${t}(${c})`;ut.error(f)();debugger}function XD(i,e,t){let r="";ut.level>=1&&(r=qb(e,t),i.traceWebGL&&ut.log(1,r)());for(const o of t)if(o===void 0){r=r||qb(e,t);debugger}}const Im={};function qD(i="id"){Im[i]=Im[i]||1;const e=Im[i]++;return`${i}-${e}`}class nh extends Fi{constructor(t,r={}){super(t,r);G(this,"device");G(this,"gl");G(this,"handle");G(this,"glTarget");G(this,"glUsage");G(this,"glIndexType",5123);G(this,"byteLength");G(this,"bytesUsed");this.device=t,this.gl=this.device.gl;const o=typeof r=="object"?r.handle:void 0;this.handle=o||this.gl.createBuffer(),t.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=GD(this.props.usage),this.glUsage=YD(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,r.data?this._initWithData(r.data,r.byteOffset,r.byteLength):this._initWithByteLength(r.byteLength||0)}_initWithData(t,r=0,o=t.byteLength+r){const c=this.glTarget;this.gl.bindBuffer(c,this.handle),this.gl.bufferData(c,o,this.glUsage),this.gl.bufferSubData(c,r,t),this.gl.bindBuffer(c,null),this.bytesUsed=o,this.byteLength=o,this._setDebugData(t,r,o),this.trackAllocatedMemory(o)}_initWithByteLength(t){let r=t;t===0&&(r=new Float32Array(0));const o=this.glTarget;return this.gl.bindBuffer(o,this.handle),this.gl.bufferData(o,r,this.glUsage),this.gl.bindBuffer(o,null),this.bytesUsed=t,this.byteLength=t,this._setDebugData(null,0,t),this.trackAllocatedMemory(t),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(t,r=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,r,t),this.gl.bindBuffer(36663,null),this._setDebugData(t,r,t.byteLength)}async readAsync(t=0,r){return this.readSyncWebGL(t,r)}readSyncWebGL(t=0,r){r=r??this.byteLength-t;const o=new Uint8Array(r),c=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,o,c,r),this.gl.bindBuffer(36662,null),this._setDebugData(o,t,r),o}}function GD(i){return i&Fi.INDEX?34963:i&Fi.VERTEX?34962:i&Fi.UNIFORM?35345:34962}function YD(i){return i&Fi.INDEX||i&Fi.VERTEX?35044:i&Fi.UNIFORM?35048:35044}function KD(i){const e=i.split(/\r?\n/),t=[];for(const r of e){if(r.length<=1)continue;const o=r.split(":");if(o.length===2){const[M,F]=o;t.push({message:F.trim(),type:Gb(M),lineNum:0,linePos:0});continue}const[c,f,a,...y]=o;let T=parseInt(a,10);isNaN(T)&&(T=0);let A=parseInt(f,10);isNaN(A)&&(A=0),t.push({message:y.join(":").trim(),type:Gb(c),lineNum:T,linePos:A})}return t}function Gb(i){const e=["warning","error","info"],t=i.toLowerCase();return e.includes(t)?t:"info"}class JD extends Bd{constructor(t,r){super(t,r);G(this,"device");G(this,"handle");switch(this.device=t,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const t=this.device.gl.getShaderInfoLog(this.handle);return t?KD(t):[]}getTranslatedSource(){const r=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return(r==null?void 0:r.getTranslatedShaderSource(this.handle))||null}async _compile(t){t=t.startsWith("#version ")?t:`#version 300 es
${t}`;const{gl:r}=this.device;if(r.shaderSource(this.handle,t),r.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}ut.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),ut.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const t=async c=>await new Promise(f=>setTimeout(f,c));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:o}=this.device;for(;;){if(o.getShaderParameter(this.handle,37297))return;await t(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function QD(i,e,t,r){if(rO(e))return r(i);const o=i;o.pushState();try{return eO(i,e),Pc(o.gl,t),r(i)}finally{o.popState()}}function eO(i,e){const t=i,{gl:r}=t;if(e.cullMode)switch(e.cullMode){case"none":r.disable(2884);break;case"front":r.enable(2884),r.cullFace(1028);break;case"back":r.enable(2884),r.cullFace(1029);break}if(e.frontFace&&r.frontFace(Wa("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&i.features.has("depth-clip-control")&&r.enable(34383),e.depthBias!==void 0&&(r.enable(32823),r.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&i.features.has("provoking-vertex-webgl")){const c=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,f=Wa("provokingVertex",e.provokingVertex,{first:36429,last:36430});c==null||c.provokingVertexWEBGL(f)}if((e.polygonMode||e.polygonOffsetLine)&&i.features.has("polygon-mode-webgl")){if(e.polygonMode){const c=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,f=Wa("polygonMode",e.polygonMode,{fill:6914,line:6913});c==null||c.polygonModeWEBGL(1028,f),c==null||c.polygonModeWEBGL(1029,f)}e.polygonOffsetLine&&r.enable(10754)}if(i.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&r.enable(12288),e.clipDistance1&&r.enable(12289),e.clipDistance2&&r.enable(12290),e.clipDistance3&&r.enable(12291),e.clipDistance4&&r.enable(12292),e.clipDistance5&&r.enable(12293),e.clipDistance6&&r.enable(12294),e.clipDistance7&&r.enable(12295)),e.depthWriteEnabled!==void 0&&r.depthMask(iO("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?r.enable(2929):r.disable(2929),r.depthFunc(b_("depthCompare",e.depthCompare))),e.stencilWriteMask){const o=e.stencilWriteMask;r.stencilMaskSeparate(1028,o),r.stencilMaskSeparate(1029,o)}if(e.stencilReadMask&&ut.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const o=e.stencilReadMask||4294967295,c=b_("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?r.enable(2960):r.disable(2960),r.stencilFuncSeparate(1028,c,0,o),r.stencilFuncSeparate(1029,c,0,o)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const o=Cm("stencilPassOperation",e.stencilPassOperation),c=Cm("stencilFailOperation",e.stencilFailOperation),f=Cm("stencilDepthFailOperation",e.stencilDepthFailOperation);r.stencilOpSeparate(1028,c,f,o),r.stencilOpSeparate(1029,c,f,o)}switch(e.blend){case!0:r.enable(3042);break;case!1:r.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const o=Yb("blendColorOperation",e.blendColorOperation||"add"),c=Yb("blendAlphaOperation",e.blendAlphaOperation||"add");r.blendEquationSeparate(o,c);const f=id("blendColorSrcFactor",e.blendColorSrcFactor||"one"),a=id("blendColorDstFactor",e.blendColorDstFactor||"zero"),y=id("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),T=id("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");r.blendFuncSeparate(f,a,y,T)}}function b_(i,e){return Wa(i,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Cm(i,e){return Wa(i,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function Yb(i,e){return Wa(i,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function id(i,e){return Wa(i,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function tO(i,e){return`Illegal parameter ${e} for ${i}`}function Wa(i,e,t){if(!(e in t))throw new Error(tO(i,e));return t[e]}function iO(i,e){return e}function rO(i){let e=!0;for(const t in i){e=!1;break}return e}function l2(i){const e={};return i.addressModeU&&(e[10242]=Mm(i.addressModeU)),i.addressModeV&&(e[10243]=Mm(i.addressModeV)),i.addressModeW&&(e[32882]=Mm(i.addressModeW)),i.magFilter&&(e[10240]=w_(i.magFilter)),(i.minFilter||i.mipmapFilter)&&(e[10241]=nO(i.minFilter||"linear",i.mipmapFilter)),i.lodMinClamp!==void 0&&(e[33082]=i.lodMinClamp),i.lodMaxClamp!==void 0&&(e[33083]=i.lodMaxClamp),i.type==="comparison-sampler"&&(e[34892]=34894),i.compare&&(e[34893]=b_("compare",i.compare)),i.maxAnisotropy&&(e[34046]=i.maxAnisotropy),e}function Mm(i){switch(i){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function w_(i){switch(i){case"nearest":return 9728;case"linear":return 9729}}function nO(i,e="none"){if(!e)return w_(i);switch(e){case"none":return w_(i);case"nearest":return i==="nearest"?9984:9986;case"linear":return i==="nearest"?9985:9987}}class T_ extends Nd{constructor(t,r){super(t,r);G(this,"device");G(this,"handle");G(this,"parameters");this.device=t,this.parameters=l2(r),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(t){for(const[r,o]of Object.entries(t)){const c=Number(r);switch(c){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,c,o);break;default:this.device.gl.samplerParameteri(this.handle,c,o);break}}}}class oc extends Ld{constructor(t,r){super(t,{...Xi.defaultProps,...r});G(this,"device");G(this,"gl");G(this,"handle");G(this,"texture");this.device=t,this.gl=this.device.gl,this.handle=null,this.texture=r.texture}}const sO="Failed to deduce GL constant from typed array";function oO(i){switch(ArrayBuffer.isView(i)?i.constructor:i){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(sO)}}function aO(i,e){const{clamped:t=!0}=e||{};switch(i){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function c2(i){switch(i){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function lO(i){switch(i){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function ep(i,e,t){if(cO(e))return t(i);const{nocatch:r=!0}=e,o=$a.get(i);o.push(),Pc(i,e);let c;if(r)c=t(i),o.pop();else try{c=t(i)}finally{o.pop()}return c}function cO(i){for(const e in i)return!1;return!0}function uO(i,e,t){const{dimension:r,width:o,height:c,depth:f=0}=t,{glInternalFormat:a}=t,y=t.glTarget;switch(r){case"2d-array":case"3d":i.texStorage3D(y,e,a,o,c,f);break;default:i.texStorage2D(y,e,a,o,c)}}function Kb(i,e,t,r){const{width:o,height:c}=r,{dimension:f,depth:a=0,mipLevel:y=0}=r,{x:T=0,y:A=0,z:M=0}=r,{glFormat:F,glType:L}=r,Y=u2(r.glTarget,f,a),ae=r.flipY?{37440:!0}:{};ep(i,ae,()=>{switch(f){case"2d-array":case"3d":i.bindTexture(Y,e),i.texSubImage3D(Y,y,T,A,M,o,c,a,F,L,t),i.bindTexture(Y,null);break;case"2d":case"cube":i.bindTexture(Y,e),i.texSubImage2D(Y,y,T,A,o,c,F,L,t),i.bindTexture(Y,null);break;default:throw new Error(f)}})}function Jb(i,e,t){const{dimension:r,width:o,height:c,depth:f=0,mipLevel:a=0,byteOffset:y=0}=t,{x:T=0,y:A=0,z:M=0}=t,{glFormat:F,glType:L,compressed:Y}=t,ae=u2(t.glTarget,r,f);switch(r){case"2d-array":case"3d":Y?i.compressedTexSubImage3D(ae,a,T,A,M,o,c,f,F,e,y):i.texSubImage3D(ae,a,T,A,M,o,c,f,F,L,e,y);break;case"2d":case"cube":Y?i.compressedTexSubImage2D(ae,a,T,A,o,c,F,e,y):i.texSubImage2D(ae,a,T,A,o,c,F,L,e,y);break;default:throw new Error(r)}}function hO(i){switch(i){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(i)}function u2(i,e,t){return e==="cube"?34069+t:i}function fO(i,e){var Ee;const{sourceX:t=0,sourceY:r=0,sourceAttachment:o=0}=e||{};let{target:c=null,sourceWidth:f,sourceHeight:a,sourceDepth:y,sourceFormat:T,sourceType:A}=e||{};const{framebuffer:M,deleteFramebuffer:F}=h2(i),{gl:L,handle:Y}=M;f||(f=M.width),a||(a=M.height);const ae=(Ee=M.colorAttachments[o])==null?void 0:Ee.texture;if(!ae)throw new Error(`Invalid framebuffer attachment ${o}`);y=(ae==null?void 0:ae.depth)||1,T||(T=(ae==null?void 0:ae.glFormat)||6408),A||(A=(ae==null?void 0:ae.glType)||5121),c=gO(c,A,T,f,a),A=A||oO(c);const pe=L.bindFramebuffer(36160,Y);return L.readBuffer(36064+o),L.readPixels(t,r,f,a,T,A,c),L.readBuffer(36064),L.bindFramebuffer(36160,pe||null),F&&M.destroy(),c}function dO(i,e){const{target:t,sourceX:r=0,sourceY:o=0,sourceFormat:c=6408,targetByteOffset:f=0}=e||{};let{sourceWidth:a,sourceHeight:y,sourceType:T}=e||{};const{framebuffer:A,deleteFramebuffer:M}=h2(i);a=a||A.width,y=y||A.height;const F=A;T=T||5121;let L=t;if(!L){const ae=c2(c),pe=lO(T),Ee=f+a*y*ae*pe;L=F.device.createBuffer({byteLength:Ee})}const Y=i.device.createCommandEncoder();return Y.copyTextureToBuffer({sourceTexture:i,width:a,height:y,origin:[r,o],destinationBuffer:L,byteOffset:f}),Y.destroy(),M&&A.destroy(),L}function h2(i){return i instanceof zd?{framebuffer:i,deleteFramebuffer:!1}:{framebuffer:pO(i),deleteFramebuffer:!0}}function pO(i,e){const{device:t,width:r,height:o,id:c}=i;return t.createFramebuffer({...e,id:`framebuffer-for-${c}`,width:r,height:o,colorAttachments:[i]})}function gO(i,e,t,r,o,c){if(i)return i;e||(e=5121);const f=aO(e,{clamped:!1}),a=c2(t);return new f(r*o*a)}class sh extends Xi{constructor(t,r){super(t,r);G(this,"device");G(this,"gl");G(this,"handle");G(this,"sampler");G(this,"view");G(this,"mipmaps");G(this,"compressed");G(this,"glTarget");G(this,"glFormat");G(this,"glType");G(this,"glInternalFormat");G(this,"textureUnit",0);const o={...this.props};o.data=r.data,this.device=t,this.gl=this.device.gl,this.glTarget=hO(this.props.dimension);const c=s2(this.props.format);this.glInternalFormat=c.internalFormat,this.glFormat=c.format,this.glType=c.type,this.compressed=c.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(o),Object.seal(this)}_initialize(t){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:t.data});let{width:r,height:o}=t;if(!r||!o){const c=Xi.getTextureDataSize(t.data);r=(c==null?void 0:c.width)||1,o=(c==null?void 0:c.height)||1}if(this.width=r,this.height=o,this.depth=t.depth,this.setSampler(t.sampler),this.view=new oc(this.device,{...this.props,texture:this}),this.bind(),uO(this.gl,this.mipLevels,this),t.data)switch(t.dimension){case"1d":this.setTexture1DData(t.data);break;case"2d":this.setTexture2DData(t.data);break;case"3d":this.setTexture3DData(t.data);break;case"cube":this.setTextureCubeData(t.data);break;case"2d-array":this.setTextureArrayData(t.data);break;case"cube-array":this.setTextureCubeArrayData(t.data);break;default:throw new Error(t.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(t){return new oc(this.device,{...t,texture:this})}setSampler(t={}){let r;t instanceof T_?(this.sampler=t,r=t.props):(this.sampler=new T_(this.device,t),r=t);const o=l2(r);this._setSamplerParameters(o)}generateMipmap(t){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(ut.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!(t!=null&&t.force))))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(o){ut.warn(`Error generating mipmap for ${this}: ${o.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(t){const r=Xi.getExternalImageSize(t.image),o={...Xi.defaultCopyExternalImageOptions,...r,...t},{image:c,depth:f,mipLevel:a,x:y,y:T,z:A,flipY:M}=o;let{width:F,height:L}=o;const{dimension:Y,glTarget:ae,glFormat:pe,glInternalFormat:Ee,glType:Be}=this;if(F=Math.min(F,this.width-y),L=Math.min(L,this.height-T),t.sourceX||t.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return Kb(this.device.gl,this.handle,c,{dimension:Y,mipLevel:a,x:y,y:T,z:A,width:F,height:L,depth:f,glFormat:pe,glType:Be,glTarget:ae,flipY:M}),{width:o.width,height:o.height}}setTexture1DData(t){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(t,r=0){this.bind();const o=Xi.normalizeTextureData(t,this);o.length>1&&this.props.mipmaps!==!1&&ut.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let c=0;c<o.length;c++){const f=o[c];this._setMipLevel(r,c,f)}this.unbind()}setTexture3DData(t){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(t)&&(this.bind(),Jb(this.device.gl,t,this),this.unbind())}setTextureCubeData(t,r=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const o of Xi.CubeFaces)this.setTextureCubeFaceData(t[o],o)}setTextureArrayData(t){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(t){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(t,r,o=0){Array.isArray(t)&&t.length>1&&this.props.mipmaps!==!1&&ut.warn(`${this.id} has mipmap and multiple LODs.`)();const c=Xi.CubeFaces.indexOf(r);this.setTexture2DData(t,c)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(t){const{face:r,width:o,height:c,pixels:f,data:a,format:y=6408,type:T=5121}=t,{gl:A}=this,M=f||a;this.bind(),M instanceof Promise?M.then(F=>this.setImageDataForFace(Object.assign({},t,{face:r,data:F,pixels:F}))):this.width||this.height?A.texImage2D(r,0,y,o,c,0,y,T,M):A.texImage2D(r,0,y,y,T,M)}_getImageDataMap(t){for(let r=0;r<Xi.CubeFaces.length;++r){const o=Xi.CubeFaces[r];t[o]&&(t[34069+r]=t[o],delete t[o])}return t}_setSamplerParameters(t){ut.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(t))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[r,o]of Object.entries(t)){const c=Number(r),f=o;switch(c){case 33082:case 33083:this.gl.texParameterf(this.glTarget,c,f);break;case 10241:this.gl.texParameteri(this.glTarget,c,f);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,c,f);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,c,f);break;default:this.gl.texParameteri(this.glTarget,c,f);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(t,r,o,c=this.glTarget){if(Xi.isExternalImage(o)){Kb(this.device.gl,this.handle,o,{...this,depth:t,mipLevel:r,glTarget:c,flipY:this.props.flipY});return}if(Xi.isTextureLevelData(o)){Jb(this.device.gl,o.data,{...this,depth:t,mipLevel:r,glTarget:c});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(t){const{gl:r}=this;return t!==void 0&&(this.textureUnit=t,r.activeTexture(33984+t)),r.bindTexture(this.glTarget,this.handle),t}unbind(t){const{gl:r}=this;return t!==void 0&&(this.textureUnit=t,r.activeTexture(33984+t)),r.bindTexture(this.glTarget,null),t}}const mO=[1,2,4,8];class _O extends Jm{constructor(t,r){var f;super(t,r);G(this,"device");G(this,"glParameters");this.device=t;let o;if(!((f=r==null?void 0:r.parameters)!=null&&f.viewport))if(r!=null&&r.framebuffer){const{width:a,height:y}=r.framebuffer;o=[0,0,a,y]}else{const[a,y]=t.getCanvasContext().getDrawingBufferSize();o=[0,0,a,y]}this.device.pushState(),this.setParameters({viewport:o,...this.props.parameters});const c=this.props.framebuffer;if(c!=null&&c.handle)if(this.props.framebuffer){const a=this.props.framebuffer.colorAttachments.map((y,T)=>36064+T);this.device.gl.drawBuffers(a)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}setParameters(t={}){const r={...this.glParameters};r.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(r.depthMask=!this.props.depthReadOnly),r.stencilMask=this.props.stencilReadOnly?0:1,r[35977]=this.props.discard,t.viewport&&(t.viewport.length>=6?(r.viewport=t.viewport.slice(0,4),r.depthRange=[t.viewport[4],t.viewport[5]]):r.viewport=t.viewport),t.scissorRect&&(r.scissorTest=!0,r.scissor=t.scissorRect),t.blendConstant&&(r.blendColor=t.blendConstant),t.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=t.stencilReference),t.colorMask&&(r.colorMask=mO.map(o=>!!(o&t.colorMask))),this.glParameters=r,Pc(this.device.gl,r)}beginOcclusionQuery(t){const r=this.props.occlusionQuerySet;r==null||r.beginOcclusionQuery()}endOcclusionQuery(){const t=this.props.occlusionQuerySet;t==null||t.endOcclusionQuery()}clear(){const t={...this.glParameters};let r=0;this.props.clearColors&&this.props.clearColors.forEach((o,c)=>{o&&this.clearColorBuffer(c,o)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(r|=16384,t.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(r|=256,t.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(r|=1024,t.clearStencil=this.props.clearStencil),r!==0&&ep(this.device.gl,t,()=>{this.device.gl.clear(r)})}clearColorBuffer(t=0,r=[0,0,0,0]){ep(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(r.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,t,r);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,t,r);break;case Float32Array:this.device.gl.clearBufferfv(6144,t,r);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function yO(i){return xO.includes(i)}const xO=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],f2={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function d2(i){const e=f2[i];if(!e)throw new Error("uniform");const[t,r,,o]=e;return{format:o,components:r,glType:t}}function vO(i){const e=f2[i];if(!e)throw new Error("attribute");const[,t,,r,o]=e;return{attributeType:r,vertexFormat:o,components:t}}function bO(i,e){const t={attributes:[],bindings:[]};t.attributes=wO(i,e);const r=AO(i,e);for(const a of r){const y=a.uniforms.map(T=>({name:T.name,format:T.format,byteOffset:T.byteOffset,byteStride:T.byteStride,arrayLength:T.arrayLength}));t.bindings.push({type:"uniform",name:a.name,group:0,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:y})}const o=SO(i,e);let c=0;for(const a of o)if(yO(a.type)){const{viewDimension:y,sampleType:T}=EO(a.type);t.bindings.push({type:"texture",name:a.name,group:0,location:c,viewDimension:y,sampleType:T}),a.textureUnit=c,c+=1}o.length&&(t.uniforms=o);const f=TO(i,e);return f!=null&&f.length&&(t.varyings=f),t}function wO(i,e){const t=[],r=i.getProgramParameter(e,35721);for(let o=0;o<r;o++){const c=i.getActiveAttrib(e,o);if(!c)throw new Error("activeInfo");const{name:f,type:a}=c,y=i.getAttribLocation(e,f);if(y>=0){const{attributeType:T}=vO(a),A=/instance/i.test(f)?"instance":"vertex";t.push({name:f,location:y,stepMode:A,type:T})}}return t.sort((o,c)=>o.location-c.location),t}function TO(i,e){const t=[],r=i.getProgramParameter(e,35971);for(let o=0;o<r;o++){const c=i.getTransformFeedbackVarying(e,o);if(!c)throw new Error("activeInfo");const{name:f,type:a,size:y}=c,{glType:T,components:A}=d2(a),M={location:o,name:f,type:T,size:y*A};t.push(M)}return t.sort((o,c)=>o.location-c.location),t}function SO(i,e){const t=[],r=i.getProgramParameter(e,35718);for(let o=0;o<r;o++){const c=i.getActiveUniform(e,o);if(!c)throw new Error("activeInfo");const{name:f,size:a,type:y}=c,{name:T,isArray:A}=IO(f);let M=i.getUniformLocation(e,T);const F={location:M,name:T,size:a,type:y,isArray:A};if(t.push(F),F.size>1)for(let L=0;L<F.size;L++){const Y=`${T}[${L}]`;M=i.getUniformLocation(e,Y);const ae={...F,name:Y,location:M};t.push(ae)}}return t}function AO(i,e){const t=(c,f)=>i.getActiveUniformBlockParameter(e,c,f),r=[],o=i.getProgramParameter(e,35382);for(let c=0;c<o;c++){const f={name:i.getActiveUniformBlockName(e,c)||"",location:t(c,35391),byteLength:t(c,35392),vertex:t(c,35396),fragment:t(c,35398),uniformCount:t(c,35394),uniforms:[]},a=t(c,35395)||[],y=i.getActiveUniforms(e,a,35383),T=i.getActiveUniforms(e,a,35384),A=i.getActiveUniforms(e,a,35387),M=i.getActiveUniforms(e,a,35388);for(let F=0;F<f.uniformCount;++F){const L=i.getActiveUniform(e,a[F]);if(!L)throw new Error("activeInfo");f.uniforms.push({name:L.name,format:d2(y[F]).format,type:y[F],arrayLength:T[F],byteOffset:A[F],byteStride:M[F]})}r.push(f)}return r.sort((c,f)=>c.location-f.location),r}const PO={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function EO(i){const e=PO[i];if(!e)throw new Error("sampler");const[t,r]=e;return{viewDimension:t,sampleType:r}}function IO(i){if(i[i.length-1]!=="]")return{name:i,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(i);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${i}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function CO(i,e,t,r){const o=i;let c=r;c===!0&&(c=1),c===!1&&(c=0);const f=typeof c=="number"?[c]:c;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof r!="number")throw new Error("samplers must be set to integers");return i.uniform1i(e,r);case 5126:return i.uniform1fv(e,f);case 35664:return i.uniform2fv(e,f);case 35665:return i.uniform3fv(e,f);case 35666:return i.uniform4fv(e,f);case 5124:return i.uniform1iv(e,f);case 35667:return i.uniform2iv(e,f);case 35668:return i.uniform3iv(e,f);case 35669:return i.uniform4iv(e,f);case 35670:return i.uniform1iv(e,f);case 35671:return i.uniform2iv(e,f);case 35672:return i.uniform3iv(e,f);case 35673:return i.uniform4iv(e,f);case 5125:return o.uniform1uiv(e,f,1);case 36294:return o.uniform2uiv(e,f,2);case 36295:return o.uniform3uiv(e,f,3);case 36296:return o.uniform4uiv(e,f,4);case 35674:return i.uniformMatrix2fv(e,!1,f);case 35675:return i.uniformMatrix3fv(e,!1,f);case 35676:return i.uniformMatrix4fv(e,!1,f);case 35685:return o.uniformMatrix2x3fv(e,!1,f);case 35686:return o.uniformMatrix2x4fv(e,!1,f);case 35687:return o.uniformMatrix3x2fv(e,!1,f);case 35688:return o.uniformMatrix3x4fv(e,!1,f);case 35689:return o.uniformMatrix4x2fv(e,!1,f);case 35690:return o.uniformMatrix4x3fv(e,!1,f)}throw new Error("Illegal uniform")}function MO(i){return X1(i)!==null||typeof i=="number"||typeof i=="boolean"}function RO(i){const e={bindings:{},uniforms:{}};return Object.keys(i).forEach(t=>{const r=i[t];MO(r)?e.uniforms[t]=r:e.bindings[t]=r}),e}function kO(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(i)}}function DO(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(i)}}const Qb=4;class OO extends fc{constructor(t,r){super(t,r);G(this,"device");G(this,"handle");G(this,"vs");G(this,"fs");G(this,"introspectedLayout");G(this,"uniforms",{});G(this,"bindings",{});G(this,"varyings",null);G(this,"_uniformCount",0);G(this,"_uniformSetters",{});this.device=t,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=r.vs,this.fs=r.fs;const{varyings:o,bufferMode:c=35981}=r;o&&o.length>0&&(this.varyings=o,this.device.gl.transformFeedbackVaryings(this.handle,o,c)),this._linkShaders(),ut.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=bO(this.device.gl,this.handle),ut.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=FO(this.introspectedLayout,r.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(t,r){for(const[o,c]of Object.entries(t)){const f=this.shaderLayout.bindings.find(a=>a.name===o)||this.shaderLayout.bindings.find(a=>a.name===`${o}Uniforms`);if(!f){const a=this.shaderLayout.bindings.map(y=>`"${y.name}"`).join(", ");r!=null&&r.disableWarnings||ut.warn(`No binding "${o}" in render pipeline "${this.id}", expected one of ${a}`,c)();continue}switch(c||ut.warn(`Unsetting binding "${o}" in render pipeline "${this.id}"`)(),f.type){case"uniform":if(!(c instanceof nh)&&!(c.buffer instanceof nh))throw new Error("buffer value");break;case"texture":if(!(c instanceof oc||c instanceof sh||c instanceof rh))throw new Error("texture value");break;case"sampler":ut.warn(`Ignoring sampler ${o}`)();break;default:throw new Error(f.type)}this.bindings[o]=c}}draw(t){var pe;const{renderPass:r,parameters:o=this.props.parameters,topology:c=this.props.topology,vertexArray:f,vertexCount:a,instanceCount:y,isInstanced:T=!1,firstVertex:A=0,transformFeedback:M}=t,F=kO(c),L=!!f.indexBuffer,Y=(pe=f.indexBuffer)==null?void 0:pe.glIndexType;if(this.linkStatus!=="success")return ut.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return ut.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),f.bindBeforeRender(r),M&&M.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const ae=r;return QD(this.device,o,ae.glParameters,()=>{L&&T?this.device.gl.drawElementsInstanced(F,a||0,Y,A,y||0):L?this.device.gl.drawElements(F,a||0,Y,A):T?this.device.gl.drawArraysInstanced(F,A,a||0,y||0):this.device.gl.drawArrays(F,A,a||0),M&&M.end()}),f.unbindAfterRender(r),!0}setUniformsWebGL(t){const{bindings:r}=RO(t);Object.keys(r).forEach(o=>{ut.warn(`Unsupported value "${JSON.stringify(r[o])}" used in setUniforms() for key ${o}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,t)}async _linkShaders(){const{gl:t}=this.device;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),ut.time(Qb,`linkProgram for ${this.id}`)(),t.linkProgram(this.handle),ut.timeEnd(Qb,`linkProgram for ${this.id}`)(),ut.level,!this.device.features.has("compilation-status-async-webgl")){const o=this._getLinkStatus();this._reportLinkStatus(o);return}ut.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),ut.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const r=this._getLinkStatus();this._reportLinkStatus(r)}async _reportLinkStatus(t){var r;switch(t){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch((r=this.fs)==null?void 0:r.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const o=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${t}: ${o}`)}}_getLinkStatus(){const{gl:t}=this.device;return t.getProgramParameter(this.handle,35714)?(t.validateProgram(this.handle),t.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const t=async c=>await new Promise(f=>setTimeout(f,c));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:o}=this.device;for(;;){if(o.getProgramParameter(this.handle,37297))return;await t(10)}}_areTexturesRenderable(){let t=!0;for(const r of this.shaderLayout.bindings)!this.bindings[r.name]&&!this.bindings[r.name.replace(/Uniforms$/,"")]&&(ut.warn(`Binding ${r.name} not found in ${this.id}`)(),t=!1);return t}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:t}=this.device;t.useProgram(this.handle);let r=0,o=0;for(const c of this.shaderLayout.bindings){const f=this.bindings[c.name]||this.bindings[c.name.replace(/Uniforms$/,"")];if(!f)throw new Error(`No value for binding ${c.name} in ${this.id}`);switch(c.type){case"uniform":const{name:a}=c,y=t.getUniformBlockIndex(this.handle,a);if(y===4294967295)throw new Error(`Invalid uniform block name ${a}`);t.uniformBlockBinding(this.handle,o,y),f instanceof nh?t.bindBufferBase(35345,o,f.handle):t.bindBufferRange(35345,o,f.buffer.handle,f.offset||0,f.size||f.buffer.byteLength-f.offset),o+=1;break;case"texture":if(!(f instanceof oc||f instanceof sh||f instanceof rh))throw new Error("texture");let T;if(f instanceof oc)T=f.texture;else if(f instanceof sh)T=f;else if(f instanceof rh&&f.colorAttachments[0]instanceof oc)ut.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),T=f.colorAttachments[0].texture;else throw new Error("No texture");t.activeTexture(33984+r),t.bindTexture(T.glTarget,T.handle),r+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${c.type}' not supported in WebGL`)}}}_applyUniforms(){for(const t of this.shaderLayout.uniforms||[]){const{name:r,location:o,type:c,textureUnit:f}=t,a=this.uniforms[r]??f;a!==void 0&&CO(this.device.gl,o,c,a)}}}function FO(i,e){const t={...i,attributes:i.attributes.map(r=>({...r}))};for(const r of(e==null?void 0:e.attributes)||[]){const o=t.attributes.find(c=>c.name===r.name);o?(o.type=r.type||o.type,o.stepMode=r.stepMode||o.stepMode):ut.warn(`shader layout attribute ${r.name} not present in shader`)}return t}class LO extends e_{constructor(t){super(t,{});G(this,"device");G(this,"commands",[]);this.device=t}submitCommands(t=this.commands){for(const r of t)switch(r.name){case"copy-buffer-to-buffer":BO(this.device,r.options);break;case"copy-buffer-to-texture":NO(this.device,r.options);break;case"copy-texture-to-buffer":zO(this.device,r.options);break;case"copy-texture-to-texture":UO(this.device,r.options);break;default:throw new Error(r.name)}}}function BO(i,e){const t=e.sourceBuffer,r=e.destinationBuffer;i.gl.bindBuffer(36662,t.handle),i.gl.bindBuffer(36663,r.handle),i.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),i.gl.bindBuffer(36662,null),i.gl.bindBuffer(36663,null)}function NO(i,e){throw new Error("Not implemented")}function zO(i,e){const{sourceTexture:t,mipLevel:r=0,aspect:o="all",width:c=e.sourceTexture.width,height:f=e.sourceTexture.height,depthOrArrayLayers:a=0,origin:y=[0,0],destinationBuffer:T,byteOffset:A=0,bytesPerRow:M,rowsPerImage:F}=e;if(o!=="all")throw new Error("aspect not supported in WebGL");if(r!==0||a!==0||M||F)throw new Error("not implemented");const{framebuffer:L,destroyFramebuffer:Y}=p2(t);let ae;try{const pe=T,Ee=c||L.width,Be=f||L.height,xe=s2(L.colorAttachments[0].texture.props.format),Ce=xe.format,tt=xe.type;i.gl.bindBuffer(35051,pe.handle),ae=i.gl.bindFramebuffer(36160,L.handle),i.gl.readPixels(y[0],y[1],Ee,Be,Ce,tt,A)}finally{i.gl.bindBuffer(35051,null),ae!==void 0&&i.gl.bindFramebuffer(36160,ae),Y&&L.destroy()}}function UO(i,e){const{sourceTexture:t,destinationMipLevel:r=0,origin:o=[0,0],destinationOrigin:c=[0,0],destinationTexture:f}=e;let{width:a=e.destinationTexture.width,height:y=e.destinationTexture.height}=e;const{framebuffer:T,destroyFramebuffer:A}=p2(t),[M,F]=o,[L,Y,ae]=c,pe=i.gl.bindFramebuffer(36160,T.handle);let Ee=null,Be;if(f instanceof sh)Ee=f,a=Number.isFinite(a)?a:Ee.width,y=Number.isFinite(y)?y:Ee.height,Ee.bind(0),Be=Ee.glTarget;else throw new Error("invalid destination");switch(Be){case 3553:case 34067:i.gl.copyTexSubImage2D(Be,r,L,Y,M,F,a,y);break;case 35866:case 32879:i.gl.copyTexSubImage3D(Be,r,L,Y,ae,M,F,a,y);break}Ee&&Ee.unbind(),i.gl.bindFramebuffer(36160,pe),A&&T.destroy()}function p2(i){if(i instanceof Xi){const{width:e,height:t,id:r}=i;return{framebuffer:i.device.createFramebuffer({id:`framebuffer-for-${r}`,width:e,height:t,colorAttachments:[i]}),destroyFramebuffer:!0}}return{framebuffer:i,destroyFramebuffer:!1}}class VO extends Qm{constructor(t,r){super(t,r);G(this,"device");G(this,"commandBuffer");this.device=t,this.commandBuffer=new LO(t)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(t){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:t})}copyBufferToTexture(t){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:t})}copyTextureToBuffer(t){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:t})}copyTextureToTexture(t){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:t})}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}resolveQuerySet(t,r,o){}}function jO(i){const{target:e,source:t,start:r=0,count:o=1}=i,c=t.length,f=o*c;let a=0;for(let y=r;a<c;a++)e[y++]=t[a];for(;a<f;)a<f-a?(e.copyWithin(r+a,r,r+a),a*=2):(e.copyWithin(r+a,r,r+f-a),a=f);return i.target}class dy extends t_{constructor(t,r){super(t,r);G(this,"device");G(this,"handle");G(this,"buffer",null);G(this,"bufferValue",null);this.device=t,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(t){return aA()==="Chrome"}destroy(){var t;super.destroy(),this.buffer&&((t=this.buffer)==null||t.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(t){const r=t;if(r&&r.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,r?r.handle:null),this.indexBuffer=r,this.device.gl.bindVertexArray(null)}setBuffer(t,r){const o=r;if(o.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:c,type:f,stride:a,offset:y,normalized:T,integer:A,divisor:M}=this._getAccessor(t);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,o.handle),A?this.device.gl.vertexAttribIPointer(t,c,f,a,y):this.device.gl.vertexAttribPointer(t,c,f,T,a,y),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(t),this.device.gl.vertexAttribDivisor(t,M||0),this.attributes[t]=o,this.device.gl.bindVertexArray(null)}setConstantWebGL(t,r){this._enable(t,!1),this.attributes[t]=r}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let t=0;t<this.maxVertexAttributes;++t){const r=this.attributes[t];ArrayBuffer.isView(r)&&this.device.setConstantAttributeWebGL(t,r)}}_getAccessor(t){const r=this.attributeInfos[t];if(!r)throw new Error(`Unknown attribute location ${t}`);const o=n2(r.bufferDataType);return{size:r.bufferComponents,type:o,stride:r.byteStride,offset:r.byteOffset,normalized:r.normalized,integer:r.integer,divisor:r.stepMode==="instance"?1:0}}_enable(t,r=!0){const c=dy.isConstantAttributeZeroSupported(this.device)||t!==0;(r||c)&&(t=Number(t),this.device.gl.bindVertexArray(this.handle),r?this.device.gl.enableVertexAttribArray(t):this.device.gl.disableVertexAttribArray(t),this.device.gl.bindVertexArray(null))}getConstantBuffer(t,r){const o=$O(r),c=o.byteLength*t,f=o.length*t;if(this.buffer&&c!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${c} !== ${this.buffer.byteLength}.`);let a=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:c}),a=a||!WO(o,this.bufferValue),a){const y=X3(r.constructor,f);jO({target:y,source:o,start:0,count:f}),this.buffer.write(y),this.bufferValue=r}return this.buffer}}function $O(i){return Array.isArray(i)?new Float32Array(i):i}function WO(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}class HO extends i_{constructor(t,r){super(t,r);G(this,"device");G(this,"gl");G(this,"handle");G(this,"layout");G(this,"buffers",{});G(this,"unusedBuffers",{});G(this,"bindOnUse",!0);G(this,"_bound",!1);this.device=t,this.gl=t.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,r.buffers&&this.setBuffers(r.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(t="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(DO(t))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(t){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const r in t)this.setBuffer(r,t[r])})}setBuffer(t,r){const o=this._getVaryingIndex(t),{buffer:c,byteLength:f,byteOffset:a}=this._getBufferRange(r);if(o<0){this.unusedBuffers[t]=c,ut.warn(`${this.id} unusedBuffers varying buffer ${t}`)();return}this.buffers[o]={buffer:c,byteLength:f,byteOffset:a},this.bindOnUse||this._bindBuffer(o,c,a,f)}getBuffer(t){if(e0(t))return this.buffers[t]||null;const r=this._getVaryingIndex(t);return r>=0?this.buffers[r]:null}bind(t=this.handle){if(typeof t!="function")return this.gl.bindTransformFeedback(36386,t),this;let r;return this._bound?r=t():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,r=t(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),r}unbind(){this.bind(null)}_getBufferRange(t){if(t instanceof nh)return{buffer:t,byteOffset:0,byteLength:t.byteLength};const{buffer:r,byteOffset:o=0,byteLength:c=t.buffer.byteLength}=t;return{buffer:r,byteOffset:o,byteLength:c}}_getVaryingIndex(t){if(e0(t))return Number(t);for(const r of this.layout.varyings)if(t===r.name)return r.location;return-1}_bindBuffers(){for(const t in this.buffers){const{buffer:r,byteLength:o,byteOffset:c}=this._getBufferRange(this.buffers[t]);this._bindBuffer(Number(t),r,c,o)}}_unbindBuffers(){for(const t in this.buffers)this.gl.bindBufferBase(35982,Number(t),null)}_bindBuffer(t,r,o=0,c){const f=r&&r.handle;!f||c===void 0?this.gl.bindBufferBase(35982,t,f):this.gl.bindBufferRange(35982,t,f,o,c)}}function e0(i){return typeof i=="number"?Number.isInteger(i):/^\d+$/.test(i)}class ZO extends r_{constructor(t,r){super(t,r);G(this,"device");G(this,"handle");G(this,"target",null);G(this,"_queryPending",!1);G(this,"_pollingPromise",null);if(this.device=t,r.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(t){return this._begin(t!=null&&t.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(t){this._queryPending||(this.target=t,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.device.gl.getQueryParameter(this.handle,34919);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(t=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let r=0;return this._pollingPromise=new Promise((o,c)=>{const f=()=>{this.isResultAvailable()?(o(this.getResult()),this._pollingPromise=null):r++>t?(c("Timed out"),this._pollingPromise=null):requestAnimationFrame(f)};requestAnimationFrame(f)}),this._pollingPromise}}class ac extends Ko{constructor(t){var M,F;super({...t,id:t.id||qD("webgl-device")});G(this,"type","webgl");G(this,"handle");G(this,"features");G(this,"limits");G(this,"info");G(this,"canvasContext");G(this,"lost");G(this,"_resolveContextLost");G(this,"gl");G(this,"debug",!1);G(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});G(this,"_extensions",{});G(this,"_polyfilled",!1);G(this,"spectorJS");G(this,"renderPass",null);G(this,"_constants");const r=Ko._getCanvasContextProps(t);if(!r)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let o=(F=(M=r.canvas)==null?void 0:M.gl)==null?void 0:F.device;if(o)throw new Error(`WebGL context already attached to device ${o.id}`);this.canvasContext=new BD(this,r),this.lost=new Promise(L=>{this._resolveContextLost=L});const c={...t.webgl};r.alphaMode==="premultiplied"&&(c.premultipliedAlpha=!0),t.powerPreference!==void 0&&(c.powerPreference=t.powerPreference);const a=this.props._handle||_D(this.canvasContext.canvas,{onContextLost:L=>{var Y;return(Y=this._resolveContextLost)==null?void 0:Y.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})},onContextRestored:L=>console.log("WebGL context restored")},c);if(!a)throw new Error("WebGL context creation failed");if(o=a.device,o){if(t._reuseDevices)return ut.log(1,`Not creating a new Device, instead returning a reference to Device ${o.id} already attached to WebGL context`,o)(),o._reused=!0,o;throw new Error(`WebGL context already attached to device ${o.id}`)}this.handle=a,this.gl=a,this.spectorJS=UD({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=yD(this.gl,this._extensions),this.limits=new OD(this.gl),this.features=new DD(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),r.autoResize!==!1&&this.canvasContext.resize(),new $a(this.gl,{log:(...L)=>ut.log(1,...L)()}).trackState(this.gl,{copyState:!1});const T=t.debugWebGL||t.debug,A=t.debugWebGL;T&&(this.gl=$D(this.gl,{debugWebGL:T,traceWebGL:A}),ut.warn("WebGL debug mode activated. Performance reduced.")(),t.debugWebGL&&(ut.level=Math.max(ut.level,1)))}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(t){throw new Error("WebGL only supports a single canvas")}createBuffer(t){const r=this._normalizeBufferProps(t);return new nh(this,r)}createTexture(t){return new sh(this,t)}createExternalTexture(t){throw new Error("createExternalTexture() not implemented")}createSampler(t){return new T_(this,t)}createShader(t){return new JD(this,t)}createFramebuffer(t){return new rh(this,t)}createVertexArray(t){return new dy(this,t)}createTransformFeedback(t){return new HO(this,t)}createQuerySet(t){return new ZO(this,t)}createRenderPipeline(t){return new OO(this,t)}beginRenderPass(t){return new _O(this,t)}createComputePipeline(t){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(t){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(t={}){return new VO(this,t)}submit(){var t;(t=this.renderPass)==null||t.end(),this.renderPass=null}readPixelsToArrayWebGL(t,r){return fO(t,r)}readPixelsToBufferWebGL(t,r){return dO(t,r)}setParametersWebGL(t){Pc(this.gl,t)}getParametersWebGL(t){return i2(this.gl,t)}withParametersWebGL(t,r){return ep(this.gl,t,r)}resetWebGL(){ut.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),fD(this.gl)}_getDeviceSpecificTextureFormatCapabilities(t){return CD(this.gl,t,this._extensions)}loseDevice(){var c;let t=!1;const o=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return o&&(t=!0,o.loseContext()),(c=this._resolveContextLost)==null||c.call(this,{reason:"destroyed",message:"Application triggered context loss"}),t}pushState(){$a.get(this.gl).push()}popState(){$a.get(this.gl).pop()}setSpectorMetadata(t,r){t.__SPECTOR_Metadata=r}getGLKey(t,r){const o=Number(t);for(const c in this.gl)if(this.gl[c]===o)return`GL.${c}`;return r!=null&&r.emptyIfUnknown?"":String(t)}getGLKeys(t){const r={emptyIfUnknown:!0};return Object.entries(t).reduce((o,[c,f])=>(o[`${c}:${this.getGLKey(c,r)}`]=`${f}:${this.getGLKey(f,r)}`,o),{})}setConstantAttributeWebGL(t,r){const o=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(o).fill(null);const c=this._constants[t];switch(c&&YO(c,r)&&ut.info(1,`setConstantAttributeWebGL(${t}) could have been skipped, value unchanged`)(),this._constants[t]=r,r.constructor){case Float32Array:XO(this,t,r);break;case Int32Array:qO(this,t,r);break;case Uint32Array:GO(this,t,r);break;default:throw new Error("constant")}}getExtension(t){return bc(this.gl,t,this._extensions),this._extensions}}function XO(i,e,t){switch(t.length){case 1:i.gl.vertexAttrib1fv(e,t);break;case 2:i.gl.vertexAttrib2fv(e,t);break;case 3:i.gl.vertexAttrib3fv(e,t);break;case 4:i.gl.vertexAttrib4fv(e,t);break}}function qO(i,e,t){i.gl.vertexAttribI4iv(e,t)}function GO(i,e,t){i.gl.vertexAttribI4uiv(e,t)}function YO(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}const KO={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},JO=i=>({drawBuffersWEBGL(e){return i.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),QO=i=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return i.createVertexArray()},deleteVertexArrayOES(e){return i.deleteVertexArray(e)},isVertexArrayOES(e){return i.isVertexArray(e)},bindVertexArrayOES(e){return i.bindVertexArray(e)}}),e4=i=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return i.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return i.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return i.vertexAttribDivisor(...e)}});function t4(i=!0){const e=HTMLCanvasElement.prototype;if(!i&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,r){if(t==="webgl"||t==="experimental-webgl"){const o=this.originalGetContext("webgl2",r);return o instanceof HTMLElement&&i4(o),o}return this.originalGetContext(t,r)}}function i4(i){i.getExtension("EXT_color_buffer_float");const e={...KO,WEBGL_disjoint_timer_query:i.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:JO(i),OES_vertex_array_object:QO(i),ANGLE_instanced_arrays:e4(i)},t=i.getExtension;i.getExtension=function(o){const c=t.call(i,o);return c||(o in e?e[o]:null)};const r=i.getSupportedExtensions;i.getSupportedExtensions=function(){const o=r.apply(i)||[];return o==null?void 0:o.concat(Object.keys(e))}}const rd=1;class r4 extends T3{constructor(){super();G(this,"type","webgl");Ko.defaultProps={...Ko.defaultProps,...fy},ac.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(t){t4(t)}async attach(t){if(t instanceof ac)return t;if((t==null?void 0:t.device)instanceof Ko)return t.device;if(!n4(t))throw new Error("Invalid WebGL2RenderingContext");return new ac({_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1}})}async create(t={}){ut.groupCollapsed(rd,"WebGLDevice created")();const r=[];(t.debugWebGL||t.debug)&&r.push(jD()),t.debugSpectorJS&&r.push(zD(t));const o=await Promise.allSettled(r);for(const a of o)a.status==="rejected"&&ut.error(`Failed to initialize debug libraries ${a.reason}`)();const c=new ac(t),f=`${c._reused?"Reusing":"Created"} device with WebGL2 ${c.debug?"debug ":""}context: ${c.info.vendor}, ${c.info.renderer} for canvas: ${c.canvasContext.id}`;return ut.probe(rd,f)(),ut.table(rd,c.info)(),ut.groupEnd(rd)(),c}}function n4(i){return typeof WebGL2RenderingContext<"u"&&i instanceof WebGL2RenderingContext?!0:!!(i&&Number.isFinite(i._version))}const t0=new r4;function jo(){}const s4=({isDragging:i})=>i?"grabbing":"grab",g2={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:jo,onWebGLInitialized:jo,onResize:jo,onViewStateChange:jo,onInteractionStateChange:jo,onBeforeRender:jo,onAfterRender:jo,onLoad:jo,onError:i=>ri.error(i.message,i.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:s4,getTooltip:null,debug:!1,drawPickingColors:!1};class py{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new Ep({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=r=>{const{_pickRequest:o}=this;if(r.type==="pointerleave")o.x=-1,o.y=-1,o.radius=0;else{if(r.leftButton||r.rightButton)return;{const c=r.offsetCenter;if(!c)return;o.x=c.x,o.y=c.y,o.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:o.x,y:o.y}),o.event=r},this._onEvent=r=>{const o=f_[r.type],c=r.offsetCenter;if(!o||!c||!this.layerManager)return;const f=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:c.x,y:c.y,layers:f,viewports:this.getViewports(c)},this._lastPointerDownInfo),{layer:y}=a,T=y&&(y[o]||y.props[o]),A=this.props[o];let M=!1;T&&(M=T.call(y,a,r)),M||(A==null||A(a,r),this.widgetManager.onEvent(a,r))},this._onPointerDown=r=>{var f;if(((f=this.device)==null?void 0:f.type)==="webgpu")return;const o=r.offsetCenter,c=this._pick("pickObject","pickObject Time",{x:o.x,y:o.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=c.result[0]||c.emptyInfo},this.props={...g2,...e},e=this.props,e.viewState&&e.initialViewState&&ri.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&ri.error("WebGL1 context not supported.")(),t=t0.attach(e.gl)),t||(t=Ym.createDevice({type:"best-available",_reuseDevices:!0,adapters:[t0],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&yc.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,r,o,c,f,a,y,T,A;(e=this.animationLoop)==null||e.stop(),(t=this.animationLoop)==null||t.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(r=this.layerManager)==null||r.finalize(),this.layerManager=null,(o=this.viewManager)==null||o.finalize(),this.viewManager=null,(c=this.effectManager)==null||c.finalize(),this.effectManager=null,(f=this.deckRenderer)==null||f.finalize(),this.deckRenderer=null,(a=this.deckPicker)==null||a.finalize(),this.deckPicker=null,(y=this.eventManager)==null||y.destroy(),this.eventManager=null,(T=this.widgetManager)==null||T.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((A=this.canvas.parentElement)==null||A.removeChild(this.canvas),this.canvas=null)}setProps(e){var r;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&ri.removed("onLayerHover","onHover")(),"onLayerClick"in e&&ri.removed("onLayerClick","onClick")(),e.initialViewState&&!Gn(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(r=this.animationLoop)==null||r.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const r=this.viewManager.needsRedraw(e),o=this.layerManager.needsRedraw(e),c=this.effectManager.needsRedraw(e),f=this.deckRenderer.needsRedraw(e);return t=t||r||o||c||f,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return Er(this.viewManager),this.viewManager.views}getViewports(e){return Er(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const r in e)this.layerManager.resourceManager.add({resourceId:r,data:e[r],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var t;(t=this.layerManager)==null||t.removeDefaultShaderModule(e)}_pick(e,t,r){Er(this.deckPicker);const{stats:o}=this;o.get("Pick Count").incrementCount(),o.get(t).timeStart();const c=this.deckPicker[e]({layers:this.layerManager.getLayers(r),views:this.viewManager.getViews(),viewports:this.getViewports(r),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...r});return o.get(t).timeEnd(),c}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),Er(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){var o;if(!this.canvas)return;const{width:t,height:r}=e;if(t||t===0){const c=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=c}if(r||r===0){const c=Number.isFinite(r)?`${r}px`:r;this.canvas.style.position=((o=e.style)==null?void 0:o.position)||"absolute",this.canvas.style.height=c}}_updateCanvasSize(){var o,c;const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,r=e.clientHeight??e.height;(t!==this.width||r!==this.height)&&(this.width=t,this.height=r,(o=this.viewManager)==null||o.setProps({width:t,height:r}),(c=this.layerManager)==null||c.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:r}))}_createAnimationLoop(e,t){const{gl:r,onError:o,useDevicePixels:c}=t;return new ak({device:e,useDevicePixels:c,autoResizeDrawingBuffer:!r,autoResizeViewport:!1,onInitialize:f=>this._setDevice(f.device),onRender:this._onRenderFrame.bind(this),onError:o})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new Q1({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var t,r,o,c;if(((t=this.device)==null?void 0:t.type)==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:f,emptyInfo:a}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=f.length>0;let y=a,T=!1;for(const A of f)y=A,T=((r=A.layer)==null?void 0:r.onHover(A,e.event))||T;T||((c=(o=this.props).onHover)==null||c.call(o,y,e.event),this.widgetManager.onHover(y,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var o,c;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(o=this.device.canvasContext)==null?void 0:o.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new Z1;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new BM(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(bb).map(f=>{var L;const[a,y,T,A]=bb[f],M=(L=this.props.eventRecognizerOptions)==null?void 0:L[f],F={...y,...M,event:f};return{recognizer:new a(F),recognizeWith:T,requestFailure:A}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const f in f_)this.eventManager.on(f,this._onEvent);this.viewManager=new Rk({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const r=this.viewManager.getViewports()[0];this.layerManager=new Mk(this.device,{deck:this,stats:this.stats,viewport:r,timeline:t}),this.effectManager=new qk({deck:this,device:this.device}),this.deckRenderer=new Kk(this.device),this.deckPicker=new rD(this.device),this.widgetManager=new oD({deck:this,parentElement:(c=this.canvas)==null?void 0:c.parentElement}),this.widgetManager.addDefault(new lD),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){var f;const{device:r,gl:o}=this.layerManager.context;this.props.onBeforeRender({device:r,gl:o});const c={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};(f=this.deckRenderer)==null||f.renderLayers(c),c.pass==="screen"&&this.widgetManager.onRedraw({viewports:c.viewports,layers:c.layers}),this.props.onAfterRender({device:r,gl:o})}_onRenderFrame(){var e;this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),ri.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),((e=this.device)==null?void 0:e.type)!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const r=Ym.stats.get("Memory Usage");e.bufferMemory=r.get("Buffer Memory").count,e.textureMemory=r.get("Texture Memory").count,e.renderbufferMemory=r.get("Renderbuffer Memory").count,e.gpuMemory=r.get("GPU Memory").count}}py.defaultProps=g2;py.VERSION=IE;function o4(i){switch(i){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return Yw(i)}}const a4=Gw;function nd(i,e,t){const r=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:i,format:e.size>1?`${r}x${e.size}`:e.type,byteOffset:e.offset||0}}function za(i){return i.stride||i.size*i.bytesPerElement}function l4(i,e){return i.type===e.type&&i.size===e.size&&za(i)===za(e)&&(i.offset||0)===(e.offset||0)}function S_(i,e){e.offset&&ri.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=za(i),r=e.vertexOffset!==void 0?e.vertexOffset:i.vertexOffset||0,o=e.elementOffset||0,c=r*t+o*i.bytesPerElement+(i.offset||0);return{...e,offset:c,stride:t}}function c4(i,e){const t=S_(i,e);return{high:t,low:{...t,offset:t.offset+i.size*4}}}class u4{constructor(e,t,r){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const o=t.logicalType||t.type,c=o==="float64";let{defaultValue:f}=t;f=Number.isFinite(f)?[f]:f||new Array(this.size).fill(0);let a;c?a="float32":!o&&t.isIndexed?a="uint32":a=o||"float32";let y=o4(o||a);this.doublePrecision=c,c&&t.fp64===!1&&(y=Float32Array),this.value=null,this.settings={...t,defaultType:y,defaultValue:f,logicalType:o,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:y.BYTES_PER_ELEMENT},this.state={...r,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*za(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),yc.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const r={};if(this.state.constant){const o=this.value;if(t){const c=S_(this.getAccessor(),t),f=c.offset/o.BYTES_PER_ELEMENT,a=c.size||this.size;r[e]=o.subarray(f,f+a)}else r[e]=o}else r[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?r[`${e}64Low`]=r[e]:r[`${e}64Low`]=new Float32Array(this.size)),r}_getBufferLayout(e=this.id,t=null){const r=this.getAccessor(),o=[],c={name:this.id,byteStride:za(r),attributes:o};if(this.doublePrecision){const f=c4(r,t||{});o.push(nd(e,{...r,...f.high},this.device.type),nd(`${e}64Low`,{...r,...f.low},this.device.type))}else if(t){const f=S_(r,t);o.push(nd(e,{...r,...f},this.device.type))}else o.push(nd(e,r,this.device.type));return c}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:r,size:o}=this,c=r*o;if(t&&c&&t.length>=c){const f=new Array(o).fill(1/0),a=new Array(o).fill(-1/0);for(let y=0;y<c;)for(let T=0;T<o;T++){const A=t[y++];A<f[T]&&(f[T]=A),A>a[T]&&(a[T]=A)}e=[f,a]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let r;ArrayBuffer.isView(e)?r={value:e}:e instanceof Fi?r={buffer:e}:r=e;const o={...this.settings,...r};if(ArrayBuffer.isView(r.value)){if(!r.type)if(this.doublePrecision&&r.value instanceof Float64Array)o.type="float32";else{const f=a4(r.value);o.type=o.normalized?f.replace("int","norm"):f}o.bytesPerElement=r.value.BYTES_PER_ELEMENT,o.stride=za(o)}if(t.bounds=null,r.constant){let c=r.value;if(c=this._normalizeValue(c,[],0),this.settings.normalized&&(c=this.normalizeConstant(c)),!(!t.constant||!this._areValuesEqual(c,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(c)?c:new Float32Array(c)}else if(r.buffer){const c=r.buffer;t.externalBuffer=c,t.constant=!1,this.value=r.value||null}else if(r.value){this._checkExternalBuffer(r);let c=r.value;t.externalBuffer=null,t.constant=!1,this.value=c;let{buffer:f}=this;const a=za(o),y=(o.vertexOffset||0)*a;if(this.doublePrecision&&c instanceof Float64Array&&(c=wm(c,o)),this.settings.isIndexed){const A=this.settings.defaultType;c.constructor!==A&&(c=new A(c))}const T=c.byteLength+y+a*2;(!f||f.byteLength<T)&&(f=this._createBuffer(T)),f.write(c,y)}return this.setAccessor(o),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:r=0,endOffset:o}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?wm(t,{size:this.size,startIndex:r,endIndex:o}):t.subarray(r,o),r*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:r}=this,o=r.allocatedValue,c=yc.allocate(o,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=c;const{byteOffset:f}=this;let{buffer:a}=this;return(!a||a.byteLength<c.byteLength+f)&&(a=this._createBuffer(c.byteLength+f),t&&o&&a.write(o instanceof Float64Array?wm(o,this):o,f)),r.allocatedValue=c,r.constant=!1,r.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const r=this.settings.defaultType;let o=!1;if(this.doublePrecision&&(o=t.BYTES_PER_ELEMENT<4),o)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof r)&&this.settings.normalized&&!("normalized"in e)&&ri.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,r){const{defaultValue:o,size:c}=this.settings;if(Number.isFinite(e))return t[r]=e,t;if(!e){let f=c;for(;--f>=0;)t[r+f]=o[f];return t}switch(c){case 4:t[r+3]=Number.isFinite(e[3])?e[3]:o[3];case 3:t[r+2]=Number.isFinite(e[2])?e[2]:o[2];case 2:t[r+1]=Number.isFinite(e[1])?e[1]:o[1];case 1:t[r+0]=Number.isFinite(e[0])?e[0]:o[0];break;default:let f=c;for(;--f>=0;)t[r+f]=Number.isFinite(e[f])?e[f]:o[f]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:r}=this;for(let o=0;o<r;o++)if(e[o]!==t[o])return!1;return!0}_createBuffer(e){var o;this._buffer&&this._buffer.destroy();const{isIndexed:t,type:r}=this.settings;return this._buffer=this.device.createBuffer({...(o=this._buffer)==null?void 0:o.props,id:this.id,usage:(t?Fi.INDEX:Fi.VERTEX)|Fi.COPY_DST,indexType:t?r:void 0,byteLength:e}),this._buffer}}const i0=[],r0=[];function Dp(i,e=0,t=1/0){let r=i0;const o={index:-1,data:i,target:[]};return i?typeof i[Symbol.iterator]=="function"?r=i:i.length>0&&(r0.length=i.length,r=r0):r=i0,(e>0||Number.isFinite(t))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(e,t),o.index=e-1),{iterable:r,objectInfo:o}}function m2(i){return i&&i[Symbol.asyncIterator]}function _2(i,e){const{size:t,stride:r,offset:o,startIndices:c,nested:f}=e,a=i.BYTES_PER_ELEMENT,y=r?r/a:t,T=o?o/a:0,A=Math.floor((i.length-T)/y);return(M,{index:F,target:L})=>{if(!c){const Ee=F*y+T;for(let Be=0;Be<t;Be++)L[Be]=i[Ee+Be];return L}const Y=c[F],ae=c[F+1]||A;let pe;if(f){pe=new Array(ae-Y);for(let Ee=Y;Ee<ae;Ee++){const Be=Ee*y+T;L=new Array(t);for(let xe=0;xe<t;xe++)L[xe]=i[Be+xe];pe[Ee-Y]=L}}else if(y===t)pe=i.subarray(Y*t+T,ae*t+T);else{pe=new i.constructor((ae-Y)*t);let Ee=0;for(let Be=Y;Be<ae;Be++){const xe=Be*y+T;for(let Ce=0;Ce<t;Ce++)pe[Ee++]=i[xe+Ce]}}return pe}}const h4=[],xd=[[0,1/0]];function f4(i,e){if(i===xd||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return i;const t=[],r=i.length;let o=0;for(let c=0;c<r;c++){const f=i[c];f[1]<e[0]?(t.push(f),o=c+1):f[0]>e[1]?t.push(f):e=[Math.min(f[0],e[0]),Math.max(f[1],e[1])]}return t.splice(o,0,e),t}const d4={interpolation:{duration:0,easing:i=>i},spring:{stiffness:.05,damping:.5}};function y2(i,e){if(!i)return null;Number.isFinite(i)&&(i={type:"interpolation",duration:i});const t=i.type||"interpolation";return{...d4[t],...e,...i,type:t}}class x2 extends u4{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:xd}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!l4(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,r=this.settings.transition,o=Array.isArray(t)?e[t.find(c=>e[c])]:e[t];return y2(o,r)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:r=0,endRow:o=1/0}=t;this.state.updateRanges=f4(this.state.updateRanges,[r,o])}else this.state.updateRanges=xd}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=h4}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:r}=this;return r.noAlloc?!1:r.update?(super.allocate(e,t.updateRanges!==xd),!0):!1}updateBuffer({numInstances:e,data:t,props:r,context:o}){if(!this.needsUpdate())return!1;const{state:{updateRanges:c},settings:{update:f,noAlloc:a}}=this;let y=!0;if(f){for(const[T,A]of c)f.call(o,this,{data:t,startRow:T,endRow:A,props:r,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[T,A]of c){const M=Number.isFinite(T)?this.getVertexOffset(T):0,F=Number.isFinite(A)?this.getVertexOffset(A):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:M,endOffset:F})}this._checkAttributeArray()}else y=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),y}setConstantValue(e){return this.device.type==="webgpu"||e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:r,settings:o}=this;if(!e)return r.binaryValue=null,r.binaryAccessor=null,!1;if(o.noAlloc)return!1;if(r.binaryValue===e)return this.clearNeedsUpdate(),!0;if(r.binaryValue=e,this.setNeedsRedraw(),o.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const f=e;Er(ArrayBuffer.isView(f.value),`invalid ${o.accessor}`);const a=!!f.size&&f.size!==this.size;return r.binaryAccessor=_2(f.value,{size:f.size||this.size,stride:f.stride,offset:f.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const r in e)Object.assign(t,super.getValue(r,e[r]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,r=super._getBufferLayout(),{stepMode:o}=this.settings;if(o==="dynamic"?r.stepMode=e?e.isInstanced?"instance":"vertex":"instance":r.stepMode=o??"vertex",!t)return r;for(const c in t){const f=super._getBufferLayout(c,t[c]);r.attributes.push(...f.attributes)}return r}_autoUpdater(e,{data:t,startRow:r,endRow:o,props:c,numInstances:f}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:a,state:y,value:T,size:A,startIndices:M}=e,{accessor:F,transform:L}=a;let Y=y.binaryAccessor||(typeof F=="function"?F:c[F]);typeof Y!="function"&&(Y=()=>Y),Er(typeof Y=="function",`accessor "${F}" is not a function`);let ae=e.getVertexOffset(r);const{iterable:pe,objectInfo:Ee}=Dp(t,r,o);for(const Be of pe){Ee.index++;let xe=Y(Be,Ee);if(L&&(xe=L.call(this,xe)),M){const Ce=(Ee.index<M.length-1?M[Ee.index+1]:f)-M[Ee.index];if(xe&&Array.isArray(xe[0])){let tt=ae;for(const Xe of xe)e._normalizeValue(Xe,T,tt),tt+=A}else xe&&xe.length>A?T.set(xe,ae):(e._normalizeValue(xe,Ee.target,0),Ak({target:T,source:Ee.target,start:ae,count:Ce}));ae+=Ce*A}else e._normalizeValue(xe,T,ae),ae+=A}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let r=!0;switch(t){case 4:r=r&&Number.isFinite(e[3]);case 3:r=r&&Number.isFinite(e[2]);case 2:r=r&&Number.isFinite(e[1]);case 1:r=r&&Number.isFinite(e[0]);break;default:r=!1}if(!r)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function Rm(i){const{source:e,target:t,start:r=0,size:o,getData:c}=i,f=i.end||t.length,a=e.length,y=f-r;if(a>y){t.set(e.subarray(0,y),r);return}if(t.set(e,r),!c)return;let T=a;for(;T<y;){const A=c(T,e);for(let M=0;M<o;M++)t[r+T]=A[M]||0,T++}}function p4({source:i,target:e,size:t,getData:r,sourceStartIndices:o,targetStartIndices:c}){if(!o||!c)return Rm({source:i,target:e,size:t,getData:r}),e;let f=0,a=0;const y=r&&((A,M)=>r(A+a,M)),T=Math.min(o.length,c.length);for(let A=1;A<T;A++){const M=o[A]*t,F=c[A]*t;Rm({source:i.subarray(f,M),target:e,start:a,end:F,size:t,getData:y}),f=M,a=F}return a<e.length&&Rm({source:[],target:e,start:a,size:t,getData:y}),e}function g4(i){const{device:e,settings:t,value:r}=i,o=new x2(e,t);return o.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),o}function v2(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${i}"`)}}function b2(i){switch(i){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function w2(i){i.push(i.shift())}function m4(i,e){const{doublePrecision:t,settings:r,value:o,size:c}=i,f=t&&o instanceof Float64Array?2:1;let a=0;const{shaderAttributes:y}=i.settings;if(y)for(const T of Object.values(y))a=Math.max(a,T.vertexOffset??0);return(r.noAlloc?o.length:(e+a)*c)*f}function T2({device:i,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t==null||t.destroy(),t=i.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function S2({device:i,buffer:e,attribute:t,fromLength:r,toLength:o,fromStartIndices:c,getData:f=a=>a}){const a=t.doublePrecision&&t.value instanceof Float64Array?2:1,y=t.size*a,T=t.byteOffset,A=t.settings.bytesPerElement<4?T/t.settings.bytesPerElement*4:T,M=t.startIndices,F=c&&M,L=t.isConstant;if(!F&&e&&r>=o)return e;const Y=t.value instanceof Float64Array?Float32Array:t.value.constructor,ae=L?t.value:new Y(t.getBuffer().readSyncWebGL(T,o*Y.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!L){const xe=f;f=(Ce,tt)=>t.normalizeConstant(xe(Ce,tt))}const pe=L?(xe,Ce)=>f(ae,Ce):(xe,Ce)=>f(ae.subarray(xe+T,xe+T+y),Ce),Ee=e?new Float32Array(e.readSyncWebGL(A,r*4).buffer):new Float32Array(0),Be=new Float32Array(o);return p4({source:Ee,target:Be,sourceStartIndices:c,targetStartIndices:M,size:y,getData:pe}),(!e||e.byteLength<Be.byteLength+A)&&(e==null||e.destroy(),e=i.createBuffer({byteLength:Be.byteLength+A,usage:35050})),e.write(Be,A),e}class A2{constructor({device:e,attribute:t,timeline:r}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new kp(r),this.attribute=t,this.attributeInTransition=g4(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,r=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=m4(this.attribute,t),this.transition.start({...e,duration:r})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class _4 extends A2{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="interpolation",this.transform=b4(e,t)}start(e,t){const r=this.currentLength,o=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:c,attribute:f}=this;w2(c),c[0]=S2({device:this.device,buffer:c[0],attribute:f,fromLength:r,toLength:this.currentLength,fromStartIndices:o,getData:e.enter}),c[1]=T2({device:this.device,source:c[0],target:c[1]}),this.setBuffer(c[1]);const{transform:a}=this,y=a.model;let T=Math.floor(this.currentLength/f.size);P2(f)&&(T/=2),y.setVertexCount(T),f.isConstant?(y.setAttributes({aFrom:c[0]}),y.setConstantAttributes({aTo:f.value})):y.setAttributes({aFrom:c[0],aTo:f.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:c[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:r}=this.transition;let o=r/e;t&&(o=t(o));const{model:c}=this.transform,f={time:o};c.shaderInputs.setProps({interpolation:f}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const y4=`uniform interpolationUniforms {
  float time;
} interpolation;
`,n0={name:"interpolation",vs:y4,uniformTypes:{time:"f32"}},x4=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,v4=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function P2(i){return i.doublePrecision&&i.value instanceof Float64Array}function b4(i,e){const t=e.size,r=v2(t),o=b2(t),c=e.getBufferLayout();return P2(e)?new fh(i,{vs:v4,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:o,byteOffset:0},{attribute:"aFrom64Low",format:o,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:o,byteOffset:0},{attribute:"aTo64Low",format:o,byteOffset:4*t}]}],modules:[IC,n0],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new fh(i,{vs:x4,bufferLayout:[{name:"aFrom",format:o},{name:"aTo",format:c.attributes[0].format}],modules:[n0],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}class w4 extends A2{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="spring",this.texture=I4(e),this.framebuffer=C4(e,this.texture),this.transform=E4(e,t)}start(e,t){const r=this.currentLength,o=this.currentStartIndices;super.start(e,t);const{buffers:c,attribute:f}=this;for(let y=0;y<2;y++)c[y]=S2({device:this.device,buffer:c[y],attribute:f,fromLength:r,toLength:this.currentLength,fromStartIndices:o,getData:e.enter});c[2]=T2({device:this.device,source:c[0],target:c[2]}),this.setBuffer(c[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/f.size)),f.isConstant?a.setConstantAttributes({aTo:f.value}):a.setAttributes({aTo:f.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:r,transition:o}=this,c=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const f={stiffness:c.stiffness,damping:c.damping};t.model.shaderInputs.setProps({spring:f}),t.run({framebuffer:r,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),w2(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(r)[0]>0||o.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const T4=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,S4={name:"spring",vs:T4,uniformTypes:{damping:"f32",stiffness:"f32"}},A4=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,P4=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function E4(i,e){const t=v2(e.size),r=b2(e.size);return new fh(i,{vs:A4,fs:P4,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[S4],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function I4(i){return i.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function C4(i,e){return i.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const M4={interpolation:_4,spring:w4};class R4{constructor(e,{id:t,timeline:r}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=r,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:r}){this.numInstances=r||1;for(const o in e){const c=e[o],f=c.getTransitionSetting(t);f&&this._updateAttribute(o,c,f)}for(const o in this.transitions){const c=e[o];(!c||!c.getTransitionSetting(t))&&this._removeTransition(o)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const r=this.transitions[t];r.inProgress&&(e[t]=r.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,r){const o=this.transitions[e];let c=!o||o.type!==r.type;if(c){o&&this._removeTransition(e);const f=M4[r.type];f?this.transitions[e]=new f({attribute:t,timeline:this.timeline,device:this.device}):(ri.error(`unsupported transition type '${r.type}'`)(),c=!1)}(c||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(r,this.numInstances))}}const s0="attributeManager.invalidate",k4="attributeManager.updateStart",D4="attributeManager.updateEnd",O4="attribute.updateStart",F4="attribute.allocate",L4="attribute.updateEnd";class B4{constructor(e,{id:t="attribute-manager",stats:r,timeline:o}={}){this.mergeBoundsMemoized=Th(qR),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=r,this.attributeTransitionManager=new R4(e,{id:`${t}-transitions`,timeline:o}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const r=this._invalidateTrigger(e,t);Nr(s0,this,e,r)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);Nr(s0,this,"all")}update({data:e,numInstances:t,startIndices:r=null,transitions:o,props:c={},buffers:f={},context:a={}}){let y=!1;Nr(k4,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const T in this.attributes){const A=this.attributes[T],M=A.settings.accessor;A.startIndices=r,A.numInstances=t,c[T]&&ri.removed(`props.${T}`,`data.attributes.${T}`)(),A.setExternalBuffer(f[T])||A.setBinaryValue(typeof M=="string"?f[M]:void 0,e.startIndices)||typeof M=="string"&&!f[M]&&A.setConstantValue(c[M])||A.needsUpdate()&&(y=!0,this._updateAttribute({attribute:A,numInstances:t,data:e,props:c,context:a})),this.needsRedraw=this.needsRedraw||A.needsRedraw()}y&&Nr(D4,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:o})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(r=>{var o;return(o=this.attributes[r])==null?void 0:o.getBounds()});return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:r}=this,o={...r.getAttributes()};for(const c in t){const f=t[c];f.needsRedraw(e)&&!r.hasAttribute(c)&&(o[c]=f)}return o}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const r in e){const o=e[r],c={...o,id:r,size:o.isIndexed&&1||o.size||1,...t};this.attributes[r]=new x2(this.device,c)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(o=>{e[o]||(e[o]=[]),e[o].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:r,updateTriggers:o}=this,c=o[e];return c&&c.forEach(f=>{const a=r[f];a&&a.setNeedsUpdate(a.id,t)}),c}_updateAttribute(e){const{attribute:t,numInstances:r}=e;if(Nr(O4,t),t.constant){t.setConstantValue(t.value);return}t.allocate(r)&&Nr(F4,t,r),t.updateBuffer(e)&&(this.needsRedraw=!0,Nr(L4,t,r))}}class N4 extends kp{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:r,duration:o,easing:c}}=this,f=c(e/o);this._value=Xd(t,r,f)}}const o0=1e-5;function a0(i,e,t,r,o){const c=e-i,a=(t-e)*o,y=-c*r;return a+y+c+e}function z4(i,e,t,r,o){if(Array.isArray(t)){const c=[];for(let f=0;f<t.length;f++)c[f]=a0(i[f],e[f],t[f],r,o);return c}return a0(i,e,t,r,o)}function l0(i,e){if(Array.isArray(i)){let t=0;for(let r=0;r<i.length;r++){const o=i[r]-e[r];t+=o*o}return Math.sqrt(t)}return Math.abs(i-e)}class U4 extends kp{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:r,stiffness:o}=this.settings,{_prevValue:c=e,_currValue:f=e}=this;let a=z4(c,f,t,r,o);const y=l0(a,t),T=l0(a,f);y<o0&&T<o0&&(a=t,this.end()),this._prevValue=f,this._currValue=a}}const V4={interpolation:N4,spring:U4};class j4{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,r,o){const{transitions:c}=this;if(c.has(e)){const y=c.get(e),{value:T=y.settings.fromValue}=y;t=T,this.remove(e)}if(o=y2(o),!o)return;const f=V4[o.type];if(!f){ri.error(`unsupported transition type '${o.type}'`)();return}const a=new f(this.timeline);a.start({...o,fromValue:t,toValue:r}),c.set(e,a)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,r]of this.transitions)r.update(),e[t]=r.value,r.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function $4(i){const e=i[Qo];for(const t in e){const r=e[t],{validate:o}=r;if(o&&!o(i[t],r))throw new Error(`Invalid prop ${t}: ${i[t]}`)}}function W4(i,e){const t=E2({newProps:i,oldProps:e,propTypes:i[Qo],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=Z4(i,e);let o=!1;return r||(o=X4(i,e)),{dataChanged:r,propsChanged:t,updateTriggersChanged:o,extensionsChanged:q4(i,e),transitionsChanged:H4(i,e)}}function H4(i,e){if(!i.transitions)return!1;const t={},r=i[Qo];let o=!1;for(const c in i.transitions){const f=r[c],a=f&&f.type;(a==="number"||a==="color"||a==="array")&&A_(i[c],e[c],f)&&(t[c]=!0,o=!0)}return o?t:!1}function E2({newProps:i,oldProps:e,ignoreProps:t={},propTypes:r={},triggerName:o="props"}){if(e===i)return!1;if(typeof i!="object"||i===null)return`${o} changed shallowly`;if(typeof e!="object"||e===null)return`${o} changed shallowly`;for(const c of Object.keys(i))if(!(c in t)){if(!(c in e))return`${o}.${c} added`;const f=A_(i[c],e[c],r[c]);if(f)return`${o}.${c} ${f}`}for(const c of Object.keys(e))if(!(c in t)){if(!(c in i))return`${o}.${c} dropped`;if(!Object.hasOwnProperty.call(i,c)){const f=A_(i[c],e[c],r[c]);if(f)return`${o}.${c} ${f}`}}return!1}function A_(i,e,t){let r=t&&t.equal;return r&&!r(i,e,t)||!r&&(r=i&&e&&i.equals,r&&!r.call(i,e))?"changed deeply":!r&&e!==i?"changed shallowly":null}function Z4(i,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:r,_dataDiff:o}=i;return r?r(i.data,e.data)||(t="Data comparator detected a change"):i.data!==e.data&&(t="A new data container was supplied"),t&&o&&(t=o(i.data,e.data)||t),t}function X4(i,e){if(e===null)return{all:!0};if("all"in i.updateTriggers&&c0(i,e,"all"))return{all:!0};const t={};let r=!1;for(const o in i.updateTriggers)o!=="all"&&c0(i,e,o)&&(t[o]=!0,r=!0);return r?t:!1}function q4(i,e){if(e===null)return!0;const t=e.extensions,{extensions:r}=i;if(r===t)return!1;if(!t||!r||r.length!==t.length)return!0;for(let o=0;o<r.length;o++)if(!r[o].equals(t[o]))return!0;return!1}function c0(i,e,t){let r=i.updateTriggers[t];r=r??{};let o=e.updateTriggers[t];return o=o??{},E2({oldProps:o,newProps:r,triggerName:t})}const G4="count(): argument not an object",Y4="count(): argument not a container";function K4(i){if(!Q4(i))throw new Error(G4);if(typeof i.count=="function")return i.count();if(Number.isFinite(i.size))return i.size;if(Number.isFinite(i.length))return i.length;if(J4(i))return Object.keys(i).length;throw new Error(Y4)}function J4(i){return i!==null&&typeof i=="object"&&i.constructor===Object}function Q4(i){return i!==null&&typeof i=="object"}function u0(i,e){if(!e)return i;const t={...i,...e};if("defines"in e&&(t.defines={...i.defines,...e.defines}),"modules"in e&&(t.modules=(i.modules||[]).concat(e.modules),e.modules.some(r=>r.name==="project64"))){const r=t.modules.findIndex(o=>o.name==="project32");r>=0&&t.modules.splice(r,1)}if("inject"in e)if(!i.inject)t.inject=e.inject;else{const r={...i.inject};for(const o in e.inject)r[o]=(r[o]||"")+e.inject[o];t.inject=r}return t}const eF={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},P_={};function tF(i,e,t,r){if(t instanceof Xi)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let o=null;t.compressed&&(o={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const c=e.createTexture({...t,sampler:{...eF,...o,...r},mipmaps:!0});return P_[c.id]=i,c}function iF(i,e){!e||!(e instanceof Xi)||P_[e.id]===i&&(e.delete(),delete P_[e.id])}const rF={boolean:{validate(i,e){return!0},equal(i,e,t){return!!i==!!e}},number:{validate(i,e){return Number.isFinite(i)&&(!("max"in e)||i<=e.max)&&(!("min"in e)||i>=e.min)}},color:{validate(i,e){return e.optional&&!i||E_(i)&&(i.length===3||i.length===4)},equal(i,e,t){return Gn(i,e,1)}},accessor:{validate(i,e){const t=tp(i);return t==="function"||t===tp(e.value)},equal(i,e,t){return typeof e=="function"?!0:Gn(i,e,1)}},array:{validate(i,e){return e.optional&&!i||E_(i)},equal(i,e,t){const{compare:r}=t,o=Number.isInteger(r)?r:r?1:0;return r?Gn(i,e,o):i===e}},object:{equal(i,e,t){if(t.ignore)return!0;const{compare:r}=t,o=Number.isInteger(r)?r:r?1:0;return r?Gn(i,e,o):i===e}},function:{validate(i,e){return e.optional&&!i||typeof i=="function"},equal(i,e,t){return!t.compare&&t.ignore!==!1||i===e}},data:{transform:(i,e,t)=>{if(!i)return i;const{dataTransform:r}=t.props;return r?r(i):typeof i.shape=="string"&&i.shape.endsWith("-table")&&Array.isArray(i.data)?i.data:i}},image:{transform:(i,e,t)=>{const r=t.context;return!r||!r.device?null:tF(t.id,r.device,i,{...e.parameters,...t.props.textureParameters})},release:(i,e,t)=>{iF(t.id,i)}}};function nF(i){const e={},t={},r={};for(const[o,c]of Object.entries(i)){const f=c==null?void 0:c.deprecatedFor;if(f)r[o]=Array.isArray(f)?f:[f];else{const a=sF(o,c);e[o]=a,t[o]=a.value}}return{propTypes:e,defaultProps:t,deprecatedProps:r}}function sF(i,e){switch(tp(e)){case"object":return Vu(i,e);case"array":return Vu(i,{type:"array",value:e,compare:!1});case"boolean":return Vu(i,{type:"boolean",value:e});case"number":return Vu(i,{type:"number",value:e});case"function":return Vu(i,{type:"function",value:e,compare:!0});default:return{name:i,type:"unknown",value:e}}}function Vu(i,e){return"type"in e?{name:i,...rF[e.type],...e}:"value"in e?{name:i,type:tp(e.value),...e}:{name:i,type:"object",value:e}}function E_(i){return Array.isArray(i)||ArrayBuffer.isView(i)}function tp(i){return E_(i)?"array":i===null?"null":typeof i}function oF(i,e){let t;for(let c=e.length-1;c>=0;c--){const f=e[c];"extensions"in f&&(t=f.extensions)}const r=I_(i.constructor,t),o=Object.create(r);o[Qd]=i,o[qa]={},o[Go]={};for(let c=0;c<e.length;++c){const f=e[c];for(const a in f)o[a]=f[a]}return Object.freeze(o),o}const aF="_mergedDefaultProps";function I_(i,e){if(!(i instanceof Op.constructor))return{};let t=aF;if(e)for(const o of e){const c=o.constructor;c&&(t+=`:${c.extensionName||c.name}`)}const r=I2(i,t);return r||(i[t]=lF(i,e||[]))}function lF(i,e){if(!i.prototype)return null;const r=Object.getPrototypeOf(i),o=I_(r),c=I2(i,"defaultProps")||{},f=nF(c),a=Object.assign(Object.create(null),o,f.defaultProps),y=Object.assign(Object.create(null),o==null?void 0:o[Qo],f.propTypes),T=Object.assign(Object.create(null),o==null?void 0:o[Pm],f.deprecatedProps);for(const A of e){const M=I_(A.constructor);M&&(Object.assign(a,M),Object.assign(y,M[Qo]),Object.assign(T,M[Pm]))}return cF(a,i),hF(a,y),uF(a,T),a[Qo]=y,a[Pm]=T,e.length===0&&!gy(i,"_propTypes")&&(i._propTypes=y),a}function cF(i,e){const t=dF(e);Object.defineProperties(i,{id:{writable:!0,value:t}})}function uF(i,e){for(const t in e)Object.defineProperty(i,t,{enumerable:!1,set(r){const o=`${this.id}: ${t}`;for(const c of e[t])gy(this,c)||(this[c]=r);ri.deprecated(o,e[t].join("/"))()}})}function hF(i,e){const t={},r={};for(const o in e){const c=e[o],{name:f,value:a}=c;c.async&&(t[f]=a,r[f]=fF(f))}i[cc]=t,i[qa]={},Object.defineProperties(i,r)}function fF(i){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||m2(e)?this[qa][i]=e:this[Go][i]=e},get(){if(this[Go]){if(i in this[Go])return this[Go][i]||this[cc][i];if(i in this[qa]){const e=this[Qd]&&this[Qd].internalState;if(e&&e.hasAsyncProp(i))return e.getAsyncProp(i)||this[cc][i]}}return this[cc][i]}}}function gy(i,e){return Object.prototype.hasOwnProperty.call(i,e)}function I2(i,e){return gy(i,e)&&i[e]}function dF(i){const e=i.componentName;return e||ri.warn(`${i.name}.componentName not specified`)(),e||i.name}let pF=0;class Op{constructor(...e){this.props=oF(this,e),this.id=this.props.id,this.count=pF++}clone(e){const{props:t}=this,r={};for(const o in t[cc])o in t[Go]?r[o]=t[Go][o]:o in t[qa]&&(r[o]=t[qa][o]);return new this.constructor({...t,...r,...e})}}Op.componentName="Component";Op.defaultProps={};const gF=Object.freeze({});class mF{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||gF}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[Qd]||this.component;const t=e[Go]||{},r=e[qa]||e,o=e[cc]||{};for(const c in t){const f=t[c];this._createAsyncPropData(c,o[c]),this._updateAsyncProp(c,f),t[c]=this.getAsyncProp(c)}for(const c in r){const f=r[c];this._createAsyncPropData(c,o[c]),this._updateAsyncProp(c,f)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(m2(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const r=this.asyncProps[e];return t===r.resolvedValue||t===r.lastValue?!1:(r.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const r=this.asyncProps[e];r&&(t=this._postProcessValue(r,t),r.resolvedValue=t,r.pendingLoadCount++,r.resolvedLoadCount=r.pendingLoadCount)}_setAsyncPropValue(e,t,r){const o=this.asyncProps[e];o&&r>=o.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),o.resolvedValue=t,o.resolvedLoadCount=r,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const r=this.asyncProps[e];if(r){r.pendingLoadCount++;const o=r.pendingLoadCount;t.then(c=>{this.component&&(c=this._postProcessValue(r,c),this._setAsyncPropValue(e,c,o),this._onResolve(e,c))}).catch(c=>{this._onError(e,c)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const r=this.asyncProps[e];if(!r)return;r.pendingLoadCount++;const o=r.pendingLoadCount;let c=[],f=0;for await(const a of t){if(!this.component)return;const{dataTransform:y}=this.component.props;y?c=y(a,c):c=c.concat(a),Object.defineProperty(c,"__diff",{enumerable:!1,value:[{startRow:f,endRow:c.length}]}),f=c.length,this._setAsyncPropValue(e,c,o)}this._onResolve(e,c)}_postProcessValue(e,t){const r=e.type;return r&&this.component&&(r.release&&r.release(e.resolvedValue,r,this.component),r.transform)?r.transform(t,r,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const o=this.component&&this.component.props[Qo];this.asyncProps[e]={type:o&&o[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class _F extends mF{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const r=this.layer,o=r==null?void 0:r.props.fetch;return o?o(t,{propName:e,layer:r}):super._fetch(e,t)}_onResolve(e,t){const r=this.layer;if(r){const o=r.props.onDataLoad;e==="data"&&o&&o(t,{propName:e,layer:r})}}_onError(e,t){const r=this.layer;r&&r.raiseError(t,`loading ${e} of ${this.layer}`)}}const yF="layer.changeFlag",xF="layer.initialize",vF="layer.update",bF="layer.finalize",wF="layer.matched",h0=2**24-1,TF=Object.freeze([]),SF=Th(({oldViewport:i,viewport:e})=>i.equals(e));let Wn=new Uint8ClampedArray(0);const AF={data:{type:"data",value:TF,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:i=>i&&i.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(i,{propName:e,layer:t,loaders:r,loadOptions:o,signal:c})=>{const{resourceManager:f}=t.context;o=o||t.getLoadOptions(),r=r||t.props.loaders,c&&(o={...o,fetch:{...o==null?void 0:o.fetch,signal:c}});let a=f.contains(i);return!a&&!o&&(f.add({resourceId:i,data:kd(i,r),persistent:!1}),a=!0),a?f.subscribe({resourceId:i,onChange:y=>{var T;return(T=t.internalState)==null?void 0:T.reloadAsyncProp(e,y)},consumerId:t.id,requestId:e}):kd(i,r,o)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:oi.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:i})=>[0,-i*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class eo extends Op{constructor(){super(...arguments),this.internalState=null,this.lifecycle=tc.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){Er(this.internalState);const t=this.internalState.viewport||this.context.viewport,r=H1(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[o,c,f]=V1(r,t.pixelProjectionMatrix);return e.length===2?[o,c]:[o,c,f]}unproject(e){return Er(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){Er(this.internalState);const r=this.internalState.viewport||this.context.viewport;return ek(e,{viewport:r,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===oi.DEFAULT||e===oi.LNGLAT||e===oi.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){Er(e instanceof Uint8Array);const[t,r,o]=e;return t+r*256+o*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:K4(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=u0(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=u0(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:r}=e.changeFlags;if(r&&t)if(Array.isArray(r))for(const o of r)t.invalidateAll(o);else t.invalidateAll();if(t){const{props:o}=e,c=this.internalState.hasPickingBuffer,f=Number.isInteger(o.highlightedObjectIndex)||o.pickable||o.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(c!==f){this.internalState.hasPickingBuffer=f;const{pickingColors:a,instancePickingColors:y}=t.attributes,T=a||y;T&&(f&&T.constant&&(T.constant=!1,t.invalidate(T.id)),!T.value&&!f&&(T.constant=!0,T.value=[0,0,0]))}}}finalizeState(e){for(const r of this.getModels())r.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:r}){const{index:o}=e;return o>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[o]),e}raiseError(e,t){var r,o,c,f;t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),(o=(r=this.props).onError)!=null&&o.call(r,e)||(f=(c=this.context)==null?void 0:c.onError)==null||f.call(c,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)==null?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!SF({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const r in e)e[r].layoutChanged()&&(t=!0);for(const r of this.getModels())this._setModelAttributes(r,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,r=this.getNumInstances(),o=this.getStartIndices();e.update({data:t.data,numInstances:r,startIndices:o,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const c=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(c)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),r=Object.create(this.props);for(const o in t)Object.defineProperty(r,o,{value:t[o]});return r}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const r=Math.floor(Wn.length/4);if(this.internalState.usesPickingColorCache=!0,r<t){t>h0&&ri.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Wn=yc.allocate(Wn,t,{size:4,copy:!0,maxCount:Math.max(t,h0)});const o=Math.floor(Wn.length/4),c=[0,0,0];for(let f=r;f<o;f++)this.encodePickingColor(f,c),Wn[f*4+0]=c[0],Wn[f*4+1]=c[1],Wn[f*4+2]=c[2],Wn[f*4+3]=0}e.value=Wn.subarray(0,t*4)}_setModelAttributes(e,t,r=!1){var a;if(!Object.keys(t).length)return;if(r){const y=this.getAttributeManager();e.setBufferLayout(y.getBufferLayouts(e)),t=y.getAttributes()}const o=((a=e.userData)==null?void 0:a.excludeAttributes)||{},c={},f={};for(const y in t){if(o[y])continue;const T=t[y].getValue();for(const A in T){const M=T[A];M instanceof Fi?t[y].settings.isIndexed?e.setIndexBuffer(M):c[A]=M:M&&(f[A]=M)}}e.setAttributes(c),e.setConstantAttributes(f)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:r,instancePickingColors:o}=this.getAttributeManager().attributes,c=r||o,f=c&&t.attributes&&t.attributes[c.id];if(f&&f.value){const a=f.value,y=this.encodePickingColor(e);for(let T=0;T<t.length;T++){const A=c.getVertexOffset(T);a[A]===y[0]&&a[A+1]===y[1]&&a[A+2]===y[2]&&this._disablePickingIndex(T)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:r}=this.getAttributeManager().attributes,o=t||r;if(!o)return;const c=o.getVertexOffset(e),f=o.getVertexOffset(e+1);o.buffer.write(new Uint8Array(f-c),c)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,r=e||t;r&&(this.internalState.usesPickingColorCache&&r.value.buffer!==Wn.buffer&&(r.value=Wn.subarray(0,r.value.length)),r.updateSubBuffer({startOffset:0}))}_initialize(){Er(!this.internalState),Er(Number.isFinite(this.props.coordinateSystem)),Nr(xF,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new _F({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(ri.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new j4(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){Nr(wF,this,this===e);const{state:t,internalState:r}=e;this!==e&&(this.internalState=r,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(Nr(vF,this,e),!e)return;const t=this.props,r=this.context,o=this.internalState,c=r.viewport,f=this._updateUniformTransition();o.propsInTransition=f,r.viewport=o.viewport||c,this.props=f;try{const a=this._getUpdateParams(),y=this.getModels();if(r.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const A of this.props.extensions)A.updateState.call(this,a,A);this.setNeedsRedraw(),this._updateAttributes();const T=this.getModels()[0]!==y[0];this._postUpdate(a,T)}finally{r.viewport=c,this.props=t,this._clearChangeFlags(),o.needsUpdate=!1,o.resetOldProps()}}_finalize(){Nr(bF,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:r={},parameters:o={}}){this._updateAttributeTransition();const c=this.props,f=this.context;this.props=this.internalState.propsInTransition||c;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:a}=this.props,y=a&&a(r)||[0,0];f.device instanceof ac&&f.device.setParametersWebGL({polygonOffset:y});for(const T of this.getModels())T.device.type==="webgpu"?T.setParameters({...T.parameters,...o}):T.setParameters(o);if(f.device instanceof ac)f.device.withParametersWebGL(o,()=>{const T={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:o,context:f};for(const A of this.props.extensions)A.draw.call(this,T,A);this.draw(T)});else{const T={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:o,context:f};for(const A of this.props.extensions)A.draw.call(this,T,A);this.draw(T)}}finally{this.props=c}}getChangeFlags(){var e;return(e=this.internalState)==null?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const o in e)if(e[o]){let c=!1;switch(o){case"dataChanged":const f=e[o],a=t[o];f&&Array.isArray(a)&&(t.dataChanged=Array.isArray(f)?a.concat(f):f,c=!0);default:t[o]||(t[o]=e[o],c=!0)}c&&Nr(yF,this,o,e)}const r=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=r,t.somethingChanged=r||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){var o;const r=W4(e,t);if(r.updateTriggersChanged)for(const c in r.updateTriggersChanged)r.updateTriggersChanged[c]&&this.invalidateAttribute(c);if(r.transitionsChanged)for(const c in r.transitionsChanged)this.internalState.uniformTransitions.add(c,t[c],e[c],(o=e.transitions)==null?void 0:o[c]);return this.setChangeFlags(r)}validateProps(){$4(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:r}=this.props;e.picked&&typeof r=="function"&&(t.highlightColor=r(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new B4(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:r,oldProps:o}=e,c=this.state.model;c!=null&&c.isInstanced&&c.setInstanceCount(this.getNumInstances());const{autoHighlight:f,highlightedObjectIndex:a,highlightColor:y}=r;if(t||o.autoHighlight!==f||o.highlightedObjectIndex!==a||o.highlightColor!==y){const T={};Array.isArray(y)&&(T.highlightColor=y),(t||o.autoHighlight!==f||a!==o.highlightedObjectIndex)&&(T.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:T})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const r=this.getAttributeManager(),o=r?r.getNeedsRedraw(e):!1;if(t=t||o,t)for(const c of this.props.extensions)c.onNeedsRedraw.call(this,c);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}eo.defaultProps=AF;eo.layerName="Layer";const PF="compositeLayer.renderLayers";class my extends eo{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:r}=this.props;return r&&r[e]&&r[e].type||t}getSubLayerRow(e,t,r){return e.__source={parent:this,object:t,index:r},e}getSubLayerAccessor(e){if(typeof e=="function"){const t={index:-1,data:this.props.data,target:[]};return(r,o)=>r&&r.__source?(t.index=r.__source.index,e(r.__source.object,t)):e(r,o)}return e}getSubLayerProps(e={}){var gt;const{opacity:t,pickable:r,visible:o,parameters:c,getPolygonOffset:f,highlightedObjectIndex:a,autoHighlight:y,highlightColor:T,coordinateSystem:A,coordinateOrigin:M,wrapLongitude:F,positionFormat:L,modelMatrix:Y,extensions:ae,fetch:pe,operation:Ee,_subLayerProps:Be}=this.props,xe={id:"",updateTriggers:{},opacity:t,pickable:r,visible:o,parameters:c,getPolygonOffset:f,highlightedObjectIndex:a,autoHighlight:y,highlightColor:T,coordinateSystem:A,coordinateOrigin:M,wrapLongitude:F,positionFormat:L,modelMatrix:Y,extensions:ae,fetch:pe,operation:Ee},Ce=Be&&e.id&&Be[e.id],tt=Ce&&Ce.updateTriggers,Xe=e.id||"sublayer";if(Ce){const ft=this.props[Qo],yt=e.type?e.type._propTypes:{};for(const Bt in Ce){const Pt=yt[Bt]||ft[Bt];Pt&&Pt.type==="accessor"&&(Ce[Bt]=this.getSubLayerAccessor(Ce[Bt]))}}Object.assign(xe,e,Ce),xe.id=`${this.props.id}-${Xe}`,xe.updateTriggers={all:(gt=this.props.updateTriggers)==null?void 0:gt.all,...e.updateTriggers,...tt};for(const ft of ae){const yt=ft.getSubLayerProps.call(this,ft);yt&&Object.assign(xe,yt,{updateTriggers:Object.assign(xe.updateTriggers,yt.updateTriggers)})}return xe}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let r=this.internalState.subLayers;const o=!r||this.needsUpdate();if(o){const c=this.renderLayers();r=ly(c,Boolean),this.internalState.subLayers=r}Nr(PF,this,o,r);for(const c of r)c.parent=this}}my.layerName="CompositeLayer";class C2{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=yc,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:r={},getGeometry:o,geometryBuffer:c,positionFormat:f,dataChanged:a,normalize:y=!0}=this.opts;if(this.data=t,this.getGeometry=o,this.positionSize=c&&c.size||(f==="XY"?2:3),this.buffers=r,this.normalize=y,c&&(Er(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(c),y||(r.vertexPositions=c)),this.geometryBuffer=r.vertexPositions,Array.isArray(a))for(const T of a)this._rebuildGeometry(T);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?_2(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:r,buffers:o,_attributeDefs:c,typedArrayManager:f}=this;for(const a in c)if(a in o)f.release(r[a]),r[a]=null;else{const y=c[a];y.copy=t,r[a]=f.allocate(r[a],e,y)}}_forEachGeometry(e,t,r){const{data:o,getGeometry:c}=this,{iterable:f,objectInfo:a}=Dp(o,t,r);for(const y of f){a.index++;const T=c?c(y,a):null;e(T,a.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:r,instanceCount:o}=this;const{data:c,geometryBuffer:f}=this,{startRow:a=0,endRow:y=1/0}=e||{},T={};if(e||(t=[0],r=[0]),this.normalize||!f)this._forEachGeometry((M,F)=>{const L=M&&this.normalizeGeometry(M);T[F]=L,r[F+1]=r[F]+(L?this.getGeometrySize(L):0)},a,y),o=r[r.length-1];else if(r=c.startIndices,o=r[c.length]||0,ArrayBuffer.isView(f))o=o||f.length/this.positionSize;else if(f instanceof Fi){const M=this.positionSize*4;o=o||f.byteLength/M}else if(f.buffer){const M=f.stride||this.positionSize*4;o=o||f.buffer.byteLength/M}else if(f.value){const M=f.value,F=f.stride/M.BYTES_PER_ELEMENT||this.positionSize;o=o||M.length/F}this._allocate(o,!!e),this.indexStarts=t,this.vertexStarts=r,this.instanceCount=o;const A={};this._forEachGeometry((M,F)=>{const L=T[F]||M;A.vertexStart=r[F],A.indexStart=t[F];const Y=F<r.length-1?r[F+1]:o;A.geometrySize=Y-r[F],A.geometryIndex=F,this.updateGeometryAttributes(L,A)},a,y),this.vertexCount=t[t.length-1]}}const f0=`uniform arcUniforms {
  bool greatCircle;
  bool useShortestPath;
  float numSegments;
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  highp int widthUnits;
} arc;
`,EF={name:"arc",vs:f0,fs:f0,uniformTypes:{greatCircle:"f32",useShortestPath:"f32",numSegments:"f32",widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",widthUnits:"i32"}},IF=`#version 300 es
#define SHADER_NAME arc-layer-vertex-shader
in vec4 instanceSourceColors;
in vec4 instanceTargetColors;
in vec3 instanceSourcePositions;
in vec3 instanceSourcePositions64Low;
in vec3 instanceTargetPositions;
in vec3 instanceTargetPositions64Low;
in vec3 instancePickingColors;
in float instanceWidths;
in float instanceHeights;
in float instanceTilts;
out vec4 vColor;
out vec2 uv;
out float isValid;
float paraboloid(float distance, float sourceZ, float targetZ, float ratio) {
float deltaZ = targetZ - sourceZ;
float dh = distance * instanceHeights;
if (dh == 0.0) {
return sourceZ + deltaZ * ratio;
}
float unitZ = deltaZ / dh;
float p2 = unitZ * unitZ + 1.0;
float dir = step(deltaZ, 0.0);
float z0 = mix(sourceZ, targetZ, dir);
float r = mix(ratio, 1.0 - ratio, dir);
return sqrt(r * (p2 - r)) * dh + z0;
}
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
vec2 dir_screenspace = normalize(line_clipspace * project.viewportSize);
dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);
return dir_screenspace * offset_direction * width / 2.0;
}
float getSegmentRatio(float index) {
return smoothstep(0.0, 1.0, index / (arc.numSegments - 1.0));
}
vec3 interpolateFlat(vec3 source, vec3 target, float segmentRatio) {
float distance = length(source.xy - target.xy);
float z = paraboloid(distance, source.z, target.z, segmentRatio);
float tiltAngle = radians(instanceTilts);
vec2 tiltDirection = normalize(target.xy - source.xy);
vec2 tilt = vec2(-tiltDirection.y, tiltDirection.x) * z * sin(tiltAngle);
return vec3(
mix(source.xy, target.xy, segmentRatio) + tilt,
z * cos(tiltAngle)
);
}
float getAngularDist (vec2 source, vec2 target) {
vec2 sourceRadians = radians(source);
vec2 targetRadians = radians(target);
vec2 sin_half_delta = sin((sourceRadians - targetRadians) / 2.0);
vec2 shd_sq = sin_half_delta * sin_half_delta;
float a = shd_sq.y + cos(sourceRadians.y) * cos(targetRadians.y) * shd_sq.x;
return 2.0 * asin(sqrt(a));
}
vec3 interpolateGreatCircle(vec3 source, vec3 target, vec3 source3D, vec3 target3D, float angularDist, float t) {
vec2 lngLat;
if(abs(angularDist - PI) < 0.001) {
lngLat = (1.0 - t) * source.xy + t * target.xy;
} else {
float a = sin((1.0 - t) * angularDist);
float b = sin(t * angularDist);
vec3 p = source3D.yxz * a + target3D.yxz * b;
lngLat = degrees(vec2(atan(p.y, -p.x), atan(p.z, length(p.xy))));
}
float z = paraboloid(angularDist * EARTH_RADIUS, source.z, target.z, t);
return vec3(lngLat, z);
}
void main(void) {
geometry.worldPosition = instanceSourcePositions;
geometry.worldPositionAlt = instanceTargetPositions;
float segmentIndex = float(gl_VertexID / 2);
float segmentSide = mod(float(gl_VertexID), 2.) == 0. ? -1. : 1.;
float segmentRatio = getSegmentRatio(segmentIndex);
float prevSegmentRatio = getSegmentRatio(max(0.0, segmentIndex - 1.0));
float nextSegmentRatio = getSegmentRatio(min(arc.numSegments - 1.0, segmentIndex + 1.0));
float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));
isValid = 1.0;
uv = vec2(segmentRatio, segmentSide);
geometry.uv = uv;
geometry.pickingColor = instancePickingColors;
vec4 curr;
vec4 next;
vec3 source;
vec3 target;
if ((arc.greatCircle || project.projectionMode == PROJECTION_MODE_GLOBE) && project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
source = project_globe_(vec3(instanceSourcePositions.xy, 0.0));
target = project_globe_(vec3(instanceTargetPositions.xy, 0.0));
float angularDist = getAngularDist(instanceSourcePositions.xy, instanceTargetPositions.xy);
vec3 prevPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, prevSegmentRatio);
vec3 currPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, segmentRatio);
vec3 nextPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, nextSegmentRatio);
if (abs(currPos.x - prevPos.x) > 180.0) {
indexDir = -1.0;
isValid = 0.0;
} else if (abs(currPos.x - nextPos.x) > 180.0) {
indexDir = 1.0;
isValid = 0.0;
}
nextPos = indexDir < 0.0 ? prevPos : nextPos;
nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
if (isValid == 0.0) {
nextPos.x += nextPos.x > 0.0 ? -360.0 : 360.0;
float t = ((currPos.x > 0.0 ? 180.0 : -180.0) - currPos.x) / (nextPos.x - currPos.x);
currPos = mix(currPos, nextPos, t);
segmentRatio = mix(segmentRatio, nextSegmentRatio, t);
}
vec3 currPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, segmentRatio);
vec3 nextPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, nextSegmentRatio);
curr = project_position_to_clipspace(currPos, currPos64Low, vec3(0.0), geometry.position);
next = project_position_to_clipspace(nextPos, nextPos64Low, vec3(0.0));
} else {
vec3 source_world = instanceSourcePositions;
vec3 target_world = instanceTargetPositions;
if (arc.useShortestPath) {
source_world.x = mod(source_world.x + 180., 360.0) - 180.;
target_world.x = mod(target_world.x + 180., 360.0) - 180.;
float deltaLng = target_world.x - source_world.x;
if (deltaLng > 180.) target_world.x -= 360.;
if (deltaLng < -180.) source_world.x -= 360.;
}
source = project_position(source_world, instanceSourcePositions64Low);
target = project_position(target_world, instanceTargetPositions64Low);
float antiMeridianX = 0.0;
if (arc.useShortestPath) {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
antiMeridianX = -(project.coordinateOrigin.x + 180.) / 360. * TILE_SIZE;
}
float thresholdRatio = (antiMeridianX - source.x) / (target.x - source.x);
if (prevSegmentRatio <= thresholdRatio && nextSegmentRatio > thresholdRatio) {
isValid = 0.0;
indexDir = sign(segmentRatio - thresholdRatio);
segmentRatio = thresholdRatio;
}
}
nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
vec3 currPos = interpolateFlat(source, target, segmentRatio);
vec3 nextPos = interpolateFlat(source, target, nextSegmentRatio);
if (arc.useShortestPath) {
if (nextPos.x < antiMeridianX) {
currPos.x += TILE_SIZE;
nextPos.x += TILE_SIZE;
}
}
curr = project_common_position_to_clipspace(vec4(currPos, 1.0));
next = project_common_position_to_clipspace(vec4(nextPos, 1.0));
geometry.position = vec4(currPos, 1.0);
}
float widthPixels = clamp(
project_size_to_pixel(instanceWidths * arc.widthScale, arc.widthUnits),
arc.widthMinPixels, arc.widthMaxPixels
);
vec3 offset = vec3(
getExtrusionOffset((next.xy - curr.xy) * indexDir, segmentSide, widthPixels),
0.0);
DECKGL_FILTER_SIZE(offset, geometry);
DECKGL_FILTER_GL_POSITION(curr, geometry);
gl_Position = curr + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);
vec4 color = mix(instanceSourceColors, instanceTargetColors, segmentRatio);
vColor = vec4(color.rgb, color.a * layer.opacity);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,CF=`#version 300 es
#define SHADER_NAME arc-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 uv;
in float isValid;
out vec4 fragColor;
void main(void) {
if (isValid == 0.0) {
discard;
}
fragColor = vColor;
geometry.uv = uv;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,ip=[0,0,0,255],MF={getSourcePosition:{type:"accessor",value:i=>i.sourcePosition},getTargetPosition:{type:"accessor",value:i=>i.targetPosition},getSourceColor:{type:"accessor",value:ip},getTargetColor:{type:"accessor",value:ip},getWidth:{type:"accessor",value:1},getHeight:{type:"accessor",value:1},getTilt:{type:"accessor",value:0},greatCircle:!1,numSegments:{type:"number",value:50,min:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class _y extends eo{getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:IF,fs:CF,modules:[Sc,Ac,EF]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceSourceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getSourceColor",defaultValue:ip},instanceTargetColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getTargetColor",defaultValue:ip},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceHeights:{size:1,transition:!0,accessor:"getHeight",defaultValue:1},instanceTilts:{size:1,transition:!0,accessor:"getTilt",defaultValue:0}})}updateState(e){var t;super.updateState(e),e.changeFlags.extensionsChanged&&((t=this.state.model)==null||t.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{widthUnits:t,widthScale:r,widthMinPixels:o,widthMaxPixels:c,greatCircle:f,wrapLongitude:a,numSegments:y}=this.props,T={numSegments:y,widthUnits:Ss[t],widthScale:r,widthMinPixels:o,widthMaxPixels:c,greatCircle:f,useShortestPath:a},A=this.state.model;A.shaderInputs.setProps({arc:T}),A.setVertexCount(y*2),A.draw(this.context.renderPass)}_getModel(){return new Pn(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),topology:"triangle-strip",isInstanced:!0})}}_y.layerName="ArcLayer";_y.defaultProps=MF;const d0=`uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,RF={name:"icon",vs:d0,fs:d0,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},kF=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,DF=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,OF=1024,FF=4,p0=()=>{},g0={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},LF={x:0,y:0,width:0,height:0};function BF(i){return Math.pow(2,Math.ceil(Math.log2(i)))}function NF(i,e,t,r){const o=Math.min(t/e.width,r/e.height),c=Math.floor(e.width*o),f=Math.floor(e.height*o);return o===1?{image:e,width:c,height:f}:(i.canvas.height=f,i.canvas.width=c,i.clearRect(0,0,c,f),i.drawImage(e,0,0,e.width,e.height,0,0,c,f),{image:i.canvas,width:c,height:f})}function dh(i){return i&&(i.id||i.url)}function zF(i,e,t,r){const{width:o,height:c,device:f}=i,a=f.createTexture({format:"rgba8unorm",width:e,height:t,sampler:r,mipmaps:!0}),y=f.createCommandEncoder();return y.copyTextureToTexture({sourceTexture:i,destinationTexture:a,width:o,height:c}),y.finish(),i.destroy(),a}function m0(i,e,t){for(let r=0;r<e.length;r++){const{icon:o,xOffset:c}=e[r],f=dh(o);i[f]={...o,x:c,y:t}}}function UF({icons:i,buffer:e,mapping:t={},xOffset:r=0,yOffset:o=0,rowHeight:c=0,canvasWidth:f}){let a=[];for(let y=0;y<i.length;y++){const T=i[y],A=dh(T);if(!t[A]){const{height:M,width:F}=T;r+F+e>f&&(m0(t,a,o),r=0,o=c+o+e,c=0,a=[]),a.push({icon:T,xOffset:r}),r=r+F+e,c=Math.max(c,M)}}return a.length>0&&m0(t,a,o),{mapping:t,rowHeight:c,xOffset:r,yOffset:o,canvasWidth:f,canvasHeight:BF(c+o+e)}}function VF(i,e,t){if(!i||!e)return null;t=t||{};const r={},{iterable:o,objectInfo:c}=Dp(i);for(const f of o){c.index++;const a=e(f,c),y=dh(a);if(!a)throw new Error("Icon is missing.");if(!a.url)throw new Error("Icon url is missing.");!r[y]&&(!t[y]||a.url!==t[y].url)&&(r[y]={...a,source:f,sourceIndex:c.index})}return r}class jF{constructor(e,{onUpdate:t=p0,onError:r=p0}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=FF,this._canvasWidth=OF,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=r}finalize(){var e;(e=this._texture)==null||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const t=this._autoPacking?dh(e):e;return this._mapping[t]||LF}setProps({loadOptions:e,autoPacking:t,iconAtlas:r,iconMapping:o,textureParameters:c}){var f;e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),o&&(this._mapping=o),r&&((f=this._texture)==null||f.delete(),this._texture=null,this._externalTexture=r),c&&(this._samplerParameters=c)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;const r=Object.values(VF(e,t,this._mapping)||{});if(r.length>0){const{mapping:o,xOffset:c,yOffset:f,rowHeight:a,canvasHeight:y}=UF({icons:r,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=o,this._xOffset=c,this._yOffset=f,this._canvasHeight=y,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||g0,mipmaps:!0})),this._texture.height!==this._canvasHeight&&(this._texture=zF(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||g0)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(r)}}_loadIcons(e){const t=this._canvas.getContext("2d",{willReadFrequently:!0});for(const r of e)this._pendingCount++,kd(r.url,this._loadOptions).then(o=>{var Y;const c=dh(r),f=this._mapping[c],{x:a,y,width:T,height:A}=f,{image:M,width:F,height:L}=NF(t,o,T,A);(Y=this._texture)==null||Y.copyExternalImage({image:M,x:a+(T-F)/2,y:y+(A-L)/2,width:F,height:L}),f.width=F,f.height=L,this._texture.generateMipmap(),this.onUpdate()}).catch(o=>{this.onError({url:r.url,source:r.source,sourceIndex:r.sourceIndex,loadOptions:this._loadOptions,error:o})}).finally(()=>{this._pendingCount--})}}const M2=[0,0,0,255],$F={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:i=>i.position},getIcon:{type:"accessor",value:i=>i.icon},getColor:{type:"accessor",value:M2},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class Fp extends eo{getShaders(){return super.getShaders({vs:kF,fs:DF,modules:[Sc,Ac,RF]})}initializeState(){this.state={iconManager:new jF(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:M2},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){var L;super.updateState(e);const{props:t,oldProps:r,changeFlags:o}=e,c=this.getAttributeManager(),{iconAtlas:f,iconMapping:a,data:y,getIcon:T,textureParameters:A}=t,{iconManager:M}=this.state;if(typeof f=="string")return;const F=f||this.internalState.isAsyncPropLoading("iconAtlas");M.setProps({loadOptions:t.loadOptions,autoPacking:!F,iconAtlas:f,iconMapping:F?a:null,textureParameters:A}),F?r.iconMapping!==t.iconMapping&&c.invalidate("getIcon"):(o.dataChanged||o.updateTriggersChanged&&(o.updateTriggersChanged.all||o.updateTriggersChanged.getIcon))&&M.packIcons(y,T),o.extensionsChanged&&((L=this.state.model)==null||L.destroy(),this.state.model=this._getModel(),c.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:r,sizeMaxPixels:o,sizeUnits:c,billboard:f,alphaCutoff:a}=this.props,{iconManager:y}=this.state,T=y.getTexture();if(T){const A=this.state.model,M={iconsTexture:T,iconsTextureDim:[T.width,T.height],sizeUnits:Ss[c],sizeScale:t,sizeMinPixels:r,sizeMaxPixels:o,billboard:f,alphaCutoff:a};A.shaderInputs.setProps({icon:M}),A.draw(this.context.renderPass)}}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new Pn(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new vc({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var r;const t=(r=this.getCurrentLayer())==null?void 0:r.props.onIconError;t?t(e):ri.error(e.error.message)()}getInstanceOffset(e){const{width:t,height:r,anchorX:o=t/2,anchorY:c=r/2}=this.state.iconManager.getIconMapping(e);return[t/2-o,r/2-c]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:t,y:r,width:o,height:c}=this.state.iconManager.getIconMapping(e);return[t,r,o,c]}}Fp.defaultProps=$F;Fp.layerName="IconLayer";const _0=`uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,WF={name:"scatterplot",vs:_0,fs:_0,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},HF=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,ZF=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,XF=`// TODO(ibgreen): Hack for Layer uniforms (move to new "color" module?)

struct LayerUniforms {
  opacity: f32,
};

var<private> layer: LayerUniforms = LayerUniforms(1.0);
// @group(0) @binding(1) var<uniform> layer: LayerUniforms;

// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * layer.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * layer.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    // discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        // discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    // discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,y0=[0,0,0,255],qF={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:i=>i.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:y0},getLineColor:{type:"accessor",value:y0},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class yy extends eo{getShaders(){return super.getShaders({vs:HF,fs:ZF,source:XF,modules:[Sc,Ac,WF]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var t;super.updateState(e),e.changeFlags.extensionsChanged&&((t=this.state.model)==null||t.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:t,radiusScale:r,radiusMinPixels:o,radiusMaxPixels:c,stroked:f,filled:a,billboard:y,antialiasing:T,lineWidthUnits:A,lineWidthScale:M,lineWidthMinPixels:F,lineWidthMaxPixels:L}=this.props,Y={stroked:f,filled:a,billboard:y,antialiasing:T,radiusUnits:Ss[t],radiusScale:r,radiusMinPixels:o,radiusMaxPixels:c,lineWidthUnits:Ss[A],lineWidthScale:M,lineWidthMinPixels:F,lineWidthMaxPixels:L},ae=this.state.model;ae.shaderInputs.setProps({scatterplot:Y}),ae.draw(this.context.renderPass)}_getModel(){const e=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new Pn(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new vc({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(e)}}}),isInstanced:!0})}}yy.defaultProps=qF;yy.layerName="ScatterplotLayer";const R2={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function k2(i,e,t={}){return GF(i,t)!==e?(KF(i,t),!0):!1}function GF(i,e={}){return Math.sign(YF(i,e))}const x0={x:0,y:1,z:2};function YF(i,e={}){const{start:t=0,end:r=i.length,plane:o="xy"}=e,c=e.size||2;let f=0;const a=x0[o[0]],y=x0[o[1]];for(let T=t,A=r-c;T<r;T+=c)f+=(i[T+a]-i[A+a])*(i[T+y]+i[A+y]),A=T;return f/2}function KF(i,e){const{start:t=0,end:r=i.length,size:o=2}=e,c=(r-t)/o,f=Math.floor(c/2);for(let a=0;a<f;++a){const y=t+a*o,T=t+(c-1-a)*o;for(let A=0;A<o;++A){const M=i[y+A];i[y+A]=i[T+A],i[T+A]=M}}}function Yn(i,e){const t=e.length,r=i.length;if(r>0){let o=!0;for(let c=0;c<t;c++)if(i[r-t+c]!==e[c]){o=!1;break}if(o)return!1}for(let o=0;o<t;o++)i[r+o]=e[o];return!0}function C_(i,e){const t=e.length;for(let r=0;r<t;r++)i[r]=e[r]}function ph(i,e,t,r,o=[]){const c=r+e*t;for(let f=0;f<t;f++)o[f]=i[c+f];return o}function M_(i,e,t,r,o=[]){let c,f;if(t&8)c=(r[3]-i[1])/(e[1]-i[1]),f=3;else if(t&4)c=(r[1]-i[1])/(e[1]-i[1]),f=1;else if(t&2)c=(r[2]-i[0])/(e[0]-i[0]),f=2;else if(t&1)c=(r[0]-i[0])/(e[0]-i[0]),f=0;else return null;for(let a=0;a<i.length;a++)o[a]=(f&1)===a?r[f]:c*(e[a]-i[a])+i[a];return o}function vd(i,e){let t=0;return i[0]<e[0]?t|=1:i[0]>e[2]&&(t|=2),i[1]<e[1]?t|=4:i[1]>e[3]&&(t|=8),t}function D2(i,e){const{size:t=2,broken:r=!1,gridResolution:o=10,gridOffset:c=[0,0],startIndex:f=0,endIndex:a=i.length}=e||{},y=(a-f)/t;let T=[];const A=[T],M=ph(i,0,t,f);let F,L;const Y=F2(M,o,c,[]),ae=[];Yn(T,M);for(let pe=1;pe<y;pe++){for(F=ph(i,pe,t,f,F),L=vd(F,Y);L;){M_(M,F,L,Y,ae);const Ee=vd(ae,Y);Ee&&(M_(M,ae,Ee,Y,ae),L=Ee),Yn(T,ae),C_(M,ae),QF(Y,o,L),r&&T.length>t&&(T=[],A.push(T),Yn(T,M)),L=vd(F,Y)}Yn(T,F),C_(M,F)}return r?A:A[0]}const v0=0,JF=1;function O2(i,e=null,t){if(!i.length)return[];const{size:r=2,gridResolution:o=10,gridOffset:c=[0,0],edgeTypes:f=!1}=t||{},a=[],y=[{pos:i,types:f?new Array(i.length/r).fill(JF):null,holes:e||[]}],T=[[],[]];let A=[];for(;y.length;){const{pos:M,types:F,holes:L}=y.shift();eL(M,r,L[0]||M.length,T),A=F2(T[0],o,c,A);const Y=vd(T[1],A);if(Y){let ae=b0(M,F,r,0,L[0]||M.length,A,Y);const pe={pos:ae[0].pos,types:ae[0].types,holes:[]},Ee={pos:ae[1].pos,types:ae[1].types,holes:[]};y.push(pe,Ee);for(let Be=0;Be<L.length;Be++)ae=b0(M,F,r,L[Be],L[Be+1]||M.length,A,Y),ae[0]&&(pe.holes.push(pe.pos.length),pe.pos=sd(pe.pos,ae[0].pos),f&&(pe.types=sd(pe.types,ae[0].types))),ae[1]&&(Ee.holes.push(Ee.pos.length),Ee.pos=sd(Ee.pos,ae[1].pos),f&&(Ee.types=sd(Ee.types,ae[1].types)))}else{const ae={positions:M};f&&(ae.edgeTypes=F),L.length&&(ae.holeIndices=L),a.push(ae)}}return a}function b0(i,e,t,r,o,c,f){const a=(o-r)/t,y=[],T=[],A=[],M=[],F=[];let L,Y,ae;const pe=ph(i,a-1,t,r);let Ee=Math.sign(f&8?pe[1]-c[3]:pe[0]-c[2]),Be=e&&e[a-1],xe=0,Ce=0;for(let tt=0;tt<a;tt++)L=ph(i,tt,t,r,L),Y=Math.sign(f&8?L[1]-c[3]:L[0]-c[2]),ae=e&&e[r/t+tt],Y&&Ee&&Ee!==Y&&(M_(pe,L,f,c,F),Yn(y,F)&&A.push(Be),Yn(T,F)&&M.push(Be)),Y<=0?(Yn(y,L)&&A.push(ae),xe-=Y):A.length&&(A[A.length-1]=v0),Y>=0?(Yn(T,L)&&M.push(ae),Ce+=Y):M.length&&(M[M.length-1]=v0),C_(pe,L),Ee=Y,Be=ae;return[xe?{pos:y,types:e&&A}:null,Ce?{pos:T,types:e&&M}:null]}function F2(i,e,t,r){const o=Math.floor((i[0]-t[0])/e)*e+t[0],c=Math.floor((i[1]-t[1])/e)*e+t[1];return r[0]=o,r[1]=c,r[2]=o+e,r[3]=c+e,r}function QF(i,e,t){t&8?(i[1]+=e,i[3]+=e):t&4?(i[1]-=e,i[3]-=e):t&2?(i[0]+=e,i[2]+=e):t&1&&(i[0]-=e,i[2]-=e)}function eL(i,e,t,r){let o=1/0,c=-1/0,f=1/0,a=-1/0;for(let y=0;y<t;y+=e){const T=i[y],A=i[y+1];o=T<o?T:o,c=T>c?T:c,f=A<f?A:f,a=A>a?A:a}return r[0][0]=o,r[0][1]=f,r[1][0]=c,r[1][1]=a,r}function sd(i,e){for(let t=0;t<e.length;t++)i.push(e[t]);return i}const tL=85.051129;function iL(i,e){const{size:t=2,startIndex:r=0,endIndex:o=i.length,normalize:c=!0}=e||{},f=i.slice(r,o);L2(f,t,0,o-r);const a=D2(f,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(c)for(const y of a)B2(y,t);return a}function rL(i,e=null,t){const{size:r=2,normalize:o=!0,edgeTypes:c=!1}=t||{};e=e||[];const f=[],a=[];let y=0,T=0;for(let M=0;M<=e.length;M++){const F=e[M]||i.length,L=T,Y=nL(i,r,y,F);for(let ae=Y;ae<F;ae++)f[T++]=i[ae];for(let ae=y;ae<Y;ae++)f[T++]=i[ae];L2(f,r,L,T),sL(f,r,L,T,t==null?void 0:t.maxLatitude),y=F,a[M]=T}a.pop();const A=O2(f,a,{size:r,gridResolution:360,gridOffset:[-180,-180],edgeTypes:c});if(o)for(const M of A)B2(M.positions,r);return A}function nL(i,e,t,r){let o=-1,c=-1;for(let f=t+1;f<r;f+=e){const a=Math.abs(i[f]);a>o&&(o=a,c=f-1)}return c}function sL(i,e,t,r,o=tL){const c=i[t],f=i[r-e];if(Math.abs(c-f)>180){const a=ph(i,0,e,t);a[0]+=Math.round((f-c)/360)*360,Yn(i,a),a[1]=Math.sign(a[1])*o,Yn(i,a),a[0]=c,Yn(i,a)}}function L2(i,e,t,r){let o=i[0],c;for(let f=t;f<r;f+=e){c=i[f];const a=c-o;(a>180||a<-180)&&(c-=Math.round(a/360)*360),i[f]=o=c}}function B2(i,e){let t;const r=i.length/e;for(let c=0;c<r&&(t=i[c*e],(t+180)%360===0);c++);const o=-Math.round(t/360)*360;if(o!==0)for(let c=0;c<r;c++)i[c*e]+=o}function oL(i,e,t,r){let o;if(Array.isArray(i[0])){const c=i.length*e;o=new Array(c);for(let f=0;f<i.length;f++)for(let a=0;a<e;a++)o[f*e+a]=i[f][a]||0}else o=i;return t?D2(o,{size:e,gridResolution:t}):r?iL(o,{size:e}):o}const aL=1,lL=2,km=4;class cL extends C2{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?oL(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(w0(e)){let r=0;for(const o of e)r+=this.getGeometrySize(o);return r}const t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&w0(e))for(const r of e){const o=this.getGeometrySize(r);t.geometrySize=o,this.updateGeometryAttributes(r,t),t.vertexStart+=o}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){const r=this.attributes.segmentTypes,o=e?this.isClosed(e):!1,{vertexStart:c,geometrySize:f}=t;r.fill(0,c,c+f),o?(r[c]=km,r[c+f-2]=km):(r[c]+=aL,r[c+f-2]+=lL),r[c+f-1]=km}_updatePositions(e,t){const{positions:r}=this.attributes;if(!r||!e)return;const{vertexStart:o,geometrySize:c}=t,f=new Array(3);for(let a=o,y=0;y<c;a++,y++)this.getPointOnPath(e,y,f),r[a*3]=f[0],r[a*3+1]=f[1],r[a*3+2]=f[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,r=[]){const{positionSize:o}=this;t*o>=e.length&&(t+=1-e.length/o);const c=t*o;return r[0]=e[c],r[1]=e[c+1],r[2]=o===3&&e[c+2]||0,r}isClosed(e){if(!this.normalize)return!!this.opts.loop;const{positionSize:t}=this,r=e.length-t;return e[0]===e[r]&&e[1]===e[r+1]&&(t===2||e[2]===e[r+2])}}function w0(i){return Array.isArray(i[0])}const T0=`uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,uL={name:"path",vs:T0,fs:T0,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},hL=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = path.capType;
} else {
vJointType = path.jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
path.widthMinPixels, path.widthMaxPixels) / 2.0);
vec3 width;
if (path.billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,fL=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,N2=[0,0,0,255],dL={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:i=>i.path},getColor:{type:"accessor",value:N2},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Dm={enter:(i,e)=>e.length?e.subarray(e.length-i.length):i};class xy extends eo{getShaders(){return super.getShaders({vs:hL,fs:fL,modules:[Sc,Ac,uL]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:Dm,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Dm,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:Dm,defaultValue:N2},instancePickingColors:{size:4,type:"uint8",accessor:(r,{index:o,target:c})=>this.encodePickingColor(r&&r.__source?r.__source.index:o,c)}}),this.setState({pathTesselator:new cL({fp64:this.use64bitPositions()})})}updateState(e){var f;super.updateState(e);const{props:t,changeFlags:r}=e,o=this.getAttributeManager();if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPath)){const{pathTesselator:a}=this.state,y=t.data.attributes||{};a.updateGeometry({data:t.data,geometryBuffer:y.getPath,buffers:y,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:r.dataChanged}),this.setState({numInstances:a.instanceCount,startIndices:a.vertexStarts}),r.dataChanged||o.invalidateAll()}r.extensionsChanged&&((f=this.state.model)==null||f.destroy(),this.state.model=this._getModel(),o.invalidateAll())}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r}=t,o=this.props.data;return o[0]&&o[0].__source&&(t.object=o.find(c=>c.__source.index===r)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let r=0;r<t.length;r++)t[r].__source.index===e&&this._disablePickingIndex(r);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:t,capRounded:r,billboard:o,miterLimit:c,widthUnits:f,widthScale:a,widthMinPixels:y,widthMaxPixels:T}=this.props,A=this.state.model,M={jointType:Number(t),capType:Number(r),billboard:o,widthUnits:Ss[f],widthScale:a,miterLimit:c,widthMinPixels:y,widthMaxPixels:T};A.shaderInputs.setProps({path:M}),A.draw(this.context.renderPass)}_getModel(){const e=[0,1,2,1,4,2,1,3,4,3,5,4],t=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Pn(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new vc({topology:"triangle-list",attributes:{indices:new Uint16Array(e),positions:{value:new Float32Array(t),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}xy.defaultProps=dL;xy.layerName="PathLayer";function pL(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var od={exports:{}},S0;function gL(){if(S0)return od.exports;S0=1,od.exports=i,od.exports.default=i;function i(he,Le,we){we=we||2;var Ke=Le&&Le.length,Qe=Ke?Le[0]*we:he.length,st=e(he,0,Qe,we,!0),rt=[];if(!st||st.next===st.prev)return rt;var pt,Ct,Tt,ai,ei,Xt,li;if(Ke&&(st=y(he,Le,st,we)),he.length>80*we){pt=Tt=he[0],Ct=ai=he[1];for(var si=we;si<Qe;si+=we)ei=he[si],Xt=he[si+1],ei<pt&&(pt=ei),Xt<Ct&&(Ct=Xt),ei>Tt&&(Tt=ei),Xt>ai&&(ai=Xt);li=Math.max(Tt-pt,ai-Ct),li=li!==0?32767/li:0}return r(st,rt,we,pt,Ct,li,0),rt}function e(he,Le,we,Ke,Qe){var st,rt;if(Qe===ji(he,Le,we,Ke)>0)for(st=Le;st<we;st+=Ke)rt=Lt(st,he[st],he[st+1],rt);else for(st=we-Ke;st>=Le;st-=Ke)rt=Lt(st,he[st],he[st+1],rt);return rt&&Ce(rt,rt.next)&&(Dt(rt),rt=rt.next),rt}function t(he,Le){if(!he)return he;Le||(Le=he);var we=he,Ke;do if(Ke=!1,!we.steiner&&(Ce(we,we.next)||xe(we.prev,we,we.next)===0)){if(Dt(we),we=Le=we.prev,we===we.next)break;Ke=!0}else we=we.next;while(Ke||we!==Le);return Le}function r(he,Le,we,Ke,Qe,st,rt){if(he){!rt&&st&&L(he,Ke,Qe,st);for(var pt=he,Ct,Tt;he.prev!==he.next;){if(Ct=he.prev,Tt=he.next,st?c(he,Ke,Qe,st):o(he)){Le.push(Ct.i/we|0),Le.push(he.i/we|0),Le.push(Tt.i/we|0),Dt(he),he=Tt.next,pt=Tt.next;continue}if(he=Tt,he===pt){rt?rt===1?(he=f(t(he),Le,we),r(he,Le,we,Ke,Qe,st,2)):rt===2&&a(he,Le,we,Ke,Qe,st):r(t(he),Le,we,Ke,Qe,st,1);break}}}}function o(he){var Le=he.prev,we=he,Ke=he.next;if(xe(Le,we,Ke)>=0)return!1;for(var Qe=Le.x,st=we.x,rt=Ke.x,pt=Le.y,Ct=we.y,Tt=Ke.y,ai=Qe<st?Qe<rt?Qe:rt:st<rt?st:rt,ei=pt<Ct?pt<Tt?pt:Tt:Ct<Tt?Ct:Tt,Xt=Qe>st?Qe>rt?Qe:rt:st>rt?st:rt,li=pt>Ct?pt>Tt?pt:Tt:Ct>Tt?Ct:Tt,si=Ke.next;si!==Le;){if(si.x>=ai&&si.x<=Xt&&si.y>=ei&&si.y<=li&&Ee(Qe,pt,st,Ct,rt,Tt,si.x,si.y)&&xe(si.prev,si,si.next)>=0)return!1;si=si.next}return!0}function c(he,Le,we,Ke){var Qe=he.prev,st=he,rt=he.next;if(xe(Qe,st,rt)>=0)return!1;for(var pt=Qe.x,Ct=st.x,Tt=rt.x,ai=Qe.y,ei=st.y,Xt=rt.y,li=pt<Ct?pt<Tt?pt:Tt:Ct<Tt?Ct:Tt,si=ai<ei?ai<Xt?ai:Xt:ei<Xt?ei:Xt,Li=pt>Ct?pt>Tt?pt:Tt:Ct>Tt?Ct:Tt,Ti=ai>ei?ai>Xt?ai:Xt:ei>Xt?ei:Xt,Hr=ae(li,si,Le,we,Ke),Si=ae(Li,Ti,Le,we,Ke),qt=he.prevZ,Gt=he.nextZ;qt&&qt.z>=Hr&&Gt&&Gt.z<=Si;){if(qt.x>=li&&qt.x<=Li&&qt.y>=si&&qt.y<=Ti&&qt!==Qe&&qt!==rt&&Ee(pt,ai,Ct,ei,Tt,Xt,qt.x,qt.y)&&xe(qt.prev,qt,qt.next)>=0||(qt=qt.prevZ,Gt.x>=li&&Gt.x<=Li&&Gt.y>=si&&Gt.y<=Ti&&Gt!==Qe&&Gt!==rt&&Ee(pt,ai,Ct,ei,Tt,Xt,Gt.x,Gt.y)&&xe(Gt.prev,Gt,Gt.next)>=0))return!1;Gt=Gt.nextZ}for(;qt&&qt.z>=Hr;){if(qt.x>=li&&qt.x<=Li&&qt.y>=si&&qt.y<=Ti&&qt!==Qe&&qt!==rt&&Ee(pt,ai,Ct,ei,Tt,Xt,qt.x,qt.y)&&xe(qt.prev,qt,qt.next)>=0)return!1;qt=qt.prevZ}for(;Gt&&Gt.z<=Si;){if(Gt.x>=li&&Gt.x<=Li&&Gt.y>=si&&Gt.y<=Ti&&Gt!==Qe&&Gt!==rt&&Ee(pt,ai,Ct,ei,Tt,Xt,Gt.x,Gt.y)&&xe(Gt.prev,Gt,Gt.next)>=0)return!1;Gt=Gt.nextZ}return!0}function f(he,Le,we){var Ke=he;do{var Qe=Ke.prev,st=Ke.next.next;!Ce(Qe,st)&&tt(Qe,Ke,Ke.next,st)&&yt(Qe,st)&&yt(st,Qe)&&(Le.push(Qe.i/we|0),Le.push(Ke.i/we|0),Le.push(st.i/we|0),Dt(Ke),Dt(Ke.next),Ke=he=st),Ke=Ke.next}while(Ke!==he);return t(Ke)}function a(he,Le,we,Ke,Qe,st){var rt=he;do{for(var pt=rt.next.next;pt!==rt.prev;){if(rt.i!==pt.i&&Be(rt,pt)){var Ct=Pt(rt,pt);rt=t(rt,rt.next),Ct=t(Ct,Ct.next),r(rt,Le,we,Ke,Qe,st,0),r(Ct,Le,we,Ke,Qe,st,0);return}pt=pt.next}rt=rt.next}while(rt!==he)}function y(he,Le,we,Ke){var Qe=[],st,rt,pt,Ct,Tt;for(st=0,rt=Le.length;st<rt;st++)pt=Le[st]*Ke,Ct=st<rt-1?Le[st+1]*Ke:he.length,Tt=e(he,pt,Ct,Ke,!1),Tt===Tt.next&&(Tt.steiner=!0),Qe.push(pe(Tt));for(Qe.sort(T),st=0;st<Qe.length;st++)we=A(Qe[st],we);return we}function T(he,Le){return he.x-Le.x}function A(he,Le){var we=M(he,Le);if(!we)return Le;var Ke=Pt(we,he);return t(Ke,Ke.next),t(we,we.next)}function M(he,Le){var we=Le,Ke=he.x,Qe=he.y,st=-1/0,rt;do{if(Qe<=we.y&&Qe>=we.next.y&&we.next.y!==we.y){var pt=we.x+(Qe-we.y)*(we.next.x-we.x)/(we.next.y-we.y);if(pt<=Ke&&pt>st&&(st=pt,rt=we.x<we.next.x?we:we.next,pt===Ke))return rt}we=we.next}while(we!==Le);if(!rt)return null;var Ct=rt,Tt=rt.x,ai=rt.y,ei=1/0,Xt;we=rt;do Ke>=we.x&&we.x>=Tt&&Ke!==we.x&&Ee(Qe<ai?Ke:st,Qe,Tt,ai,Qe<ai?st:Ke,Qe,we.x,we.y)&&(Xt=Math.abs(Qe-we.y)/(Ke-we.x),yt(we,he)&&(Xt<ei||Xt===ei&&(we.x>rt.x||we.x===rt.x&&F(rt,we)))&&(rt=we,ei=Xt)),we=we.next;while(we!==Ct);return rt}function F(he,Le){return xe(he.prev,he,Le.prev)<0&&xe(Le.next,he,he.next)<0}function L(he,Le,we,Ke){var Qe=he;do Qe.z===0&&(Qe.z=ae(Qe.x,Qe.y,Le,we,Ke)),Qe.prevZ=Qe.prev,Qe.nextZ=Qe.next,Qe=Qe.next;while(Qe!==he);Qe.prevZ.nextZ=null,Qe.prevZ=null,Y(Qe)}function Y(he){var Le,we,Ke,Qe,st,rt,pt,Ct,Tt=1;do{for(we=he,he=null,st=null,rt=0;we;){for(rt++,Ke=we,pt=0,Le=0;Le<Tt&&(pt++,Ke=Ke.nextZ,!!Ke);Le++);for(Ct=Tt;pt>0||Ct>0&&Ke;)pt!==0&&(Ct===0||!Ke||we.z<=Ke.z)?(Qe=we,we=we.nextZ,pt--):(Qe=Ke,Ke=Ke.nextZ,Ct--),st?st.nextZ=Qe:he=Qe,Qe.prevZ=st,st=Qe;we=Ke}st.nextZ=null,Tt*=2}while(rt>1);return he}function ae(he,Le,we,Ke,Qe){return he=(he-we)*Qe|0,Le=(Le-Ke)*Qe|0,he=(he|he<<8)&16711935,he=(he|he<<4)&252645135,he=(he|he<<2)&858993459,he=(he|he<<1)&1431655765,Le=(Le|Le<<8)&16711935,Le=(Le|Le<<4)&252645135,Le=(Le|Le<<2)&858993459,Le=(Le|Le<<1)&1431655765,he|Le<<1}function pe(he){var Le=he,we=he;do(Le.x<we.x||Le.x===we.x&&Le.y<we.y)&&(we=Le),Le=Le.next;while(Le!==he);return we}function Ee(he,Le,we,Ke,Qe,st,rt,pt){return(Qe-rt)*(Le-pt)>=(he-rt)*(st-pt)&&(he-rt)*(Ke-pt)>=(we-rt)*(Le-pt)&&(we-rt)*(st-pt)>=(Qe-rt)*(Ke-pt)}function Be(he,Le){return he.next.i!==Le.i&&he.prev.i!==Le.i&&!ft(he,Le)&&(yt(he,Le)&&yt(Le,he)&&Bt(he,Le)&&(xe(he.prev,he,Le.prev)||xe(he,Le.prev,Le))||Ce(he,Le)&&xe(he.prev,he,he.next)>0&&xe(Le.prev,Le,Le.next)>0)}function xe(he,Le,we){return(Le.y-he.y)*(we.x-Le.x)-(Le.x-he.x)*(we.y-Le.y)}function Ce(he,Le){return he.x===Le.x&&he.y===Le.y}function tt(he,Le,we,Ke){var Qe=gt(xe(he,Le,we)),st=gt(xe(he,Le,Ke)),rt=gt(xe(we,Ke,he)),pt=gt(xe(we,Ke,Le));return!!(Qe!==st&&rt!==pt||Qe===0&&Xe(he,we,Le)||st===0&&Xe(he,Ke,Le)||rt===0&&Xe(we,he,Ke)||pt===0&&Xe(we,Le,Ke))}function Xe(he,Le,we){return Le.x<=Math.max(he.x,we.x)&&Le.x>=Math.min(he.x,we.x)&&Le.y<=Math.max(he.y,we.y)&&Le.y>=Math.min(he.y,we.y)}function gt(he){return he>0?1:he<0?-1:0}function ft(he,Le){var we=he;do{if(we.i!==he.i&&we.next.i!==he.i&&we.i!==Le.i&&we.next.i!==Le.i&&tt(we,we.next,he,Le))return!0;we=we.next}while(we!==he);return!1}function yt(he,Le){return xe(he.prev,he,he.next)<0?xe(he,Le,he.next)>=0&&xe(he,he.prev,Le)>=0:xe(he,Le,he.prev)<0||xe(he,he.next,Le)<0}function Bt(he,Le){var we=he,Ke=!1,Qe=(he.x+Le.x)/2,st=(he.y+Le.y)/2;do we.y>st!=we.next.y>st&&we.next.y!==we.y&&Qe<(we.next.x-we.x)*(st-we.y)/(we.next.y-we.y)+we.x&&(Ke=!Ke),we=we.next;while(we!==he);return Ke}function Pt(he,Le){var we=new kt(he.i,he.x,he.y),Ke=new kt(Le.i,Le.x,Le.y),Qe=he.next,st=Le.prev;return he.next=Le,Le.prev=he,we.next=Qe,Qe.prev=we,Ke.next=we,we.prev=Ke,st.next=Ke,Ke.prev=st,Ke}function Lt(he,Le,we,Ke){var Qe=new kt(he,Le,we);return Ke?(Qe.next=Ke.next,Qe.prev=Ke,Ke.next.prev=Qe,Ke.next=Qe):(Qe.prev=Qe,Qe.next=Qe),Qe}function Dt(he){he.next.prev=he.prev,he.prev.next=he.next,he.prevZ&&(he.prevZ.nextZ=he.nextZ),he.nextZ&&(he.nextZ.prevZ=he.prevZ)}function kt(he,Le,we){this.i=he,this.x=Le,this.y=we,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}i.deviation=function(he,Le,we,Ke){var Qe=Le&&Le.length,st=Qe?Le[0]*we:he.length,rt=Math.abs(ji(he,0,st,we));if(Qe)for(var pt=0,Ct=Le.length;pt<Ct;pt++){var Tt=Le[pt]*we,ai=pt<Ct-1?Le[pt+1]*we:he.length;rt-=Math.abs(ji(he,Tt,ai,we))}var ei=0;for(pt=0;pt<Ke.length;pt+=3){var Xt=Ke[pt]*we,li=Ke[pt+1]*we,si=Ke[pt+2]*we;ei+=Math.abs((he[Xt]-he[si])*(he[li+1]-he[Xt+1])-(he[Xt]-he[li])*(he[si+1]-he[Xt+1]))}return rt===0&&ei===0?0:Math.abs((ei-rt)/rt)};function ji(he,Le,we,Ke){for(var Qe=0,st=Le,rt=we-Ke;st<we;st+=Ke)Qe+=(he[rt]-he[st])*(he[st+1]+he[rt+1]),rt=st;return Qe}return i.flatten=function(he){for(var Le=he[0][0].length,we={vertices:[],holes:[],dimensions:Le},Ke=0,Qe=0;Qe<he.length;Qe++){for(var st=0;st<he[Qe].length;st++)for(var rt=0;rt<Le;rt++)we.vertices.push(he[Qe][st][rt]);Qe>0&&(Ke+=he[Qe-1].length,we.holes.push(Ke))}return we},od.exports}var mL=gL();const _L=pL(mL),ad=R2.CLOCKWISE,A0=R2.COUNTER_CLOCKWISE,Yo={};function yL(i){if(i=i&&i.positions||i,!Array.isArray(i)&&!ArrayBuffer.isView(i))throw new Error("invalid polygon")}function Gu(i){return"positions"in i?i.positions:i}function bd(i){return"holeIndices"in i?i.holeIndices:null}function xL(i){return Array.isArray(i[0])}function vL(i){return i.length>=1&&i[0].length>=2&&Number.isFinite(i[0][0])}function bL(i){const e=i[0],t=i[i.length-1];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function wL(i,e,t,r){for(let o=0;o<e;o++)if(i[t+o]!==i[r-e+o])return!1;return!0}function P0(i,e,t,r,o){let c=e;const f=t.length;for(let a=0;a<f;a++)for(let y=0;y<r;y++)i[c++]=t[a][y]||0;if(!bL(t))for(let a=0;a<r;a++)i[c++]=t[0][a]||0;return Yo.start=e,Yo.end=c,Yo.size=r,k2(i,o,Yo),c}function E0(i,e,t,r,o=0,c,f){c=c||t.length;const a=c-o;if(a<=0)return e;let y=e;for(let T=0;T<a;T++)i[y++]=t[o+T];if(!wL(t,r,o,c))for(let T=0;T<r;T++)i[y++]=t[o+T];return Yo.start=e,Yo.end=y,Yo.size=r,k2(i,f,Yo),y}function TL(i,e){yL(i);const t=[],r=[];if("positions"in i){const{positions:o,holeIndices:c}=i;if(c){let f=0;for(let a=0;a<=c.length;a++)f=E0(t,f,o,e,c[a-1],c[a],a===0?ad:A0),r.push(f);return r.pop(),{positions:t,holeIndices:r}}i=o}if(!xL(i))return E0(t,0,i,e,0,t.length,ad),t;if(!vL(i)){let o=0;for(const[c,f]of i.entries())o=P0(t,o,f,e,c===0?ad:A0),r.push(o);return r.pop(),{positions:t,holeIndices:r}}return P0(t,0,i,e,ad),t}function Om(i,e,t){const r=i.length/3;let o=0;for(let c=0;c<r;c++){const f=(c+1)%r;o+=i[c*3+e]*i[f*3+t],o-=i[f*3+e]*i[c*3+t]}return Math.abs(o/2)}function I0(i,e,t,r){const o=i.length/3;for(let c=0;c<o;c++){const f=c*3,a=i[f+0],y=i[f+1],T=i[f+2];i[f+e]=a,i[f+t]=y,i[f+r]=T}}function SL(i,e,t,r){let o=bd(i);o&&(o=o.map(a=>a/e));let c=Gu(i);const f=r&&e===3;if(t){const a=c.length;c=c.slice();const y=[];for(let T=0;T<a;T+=e){y[0]=c[T],y[1]=c[T+1],f&&(y[2]=c[T+2]);const A=t(y);c[T]=A[0],c[T+1]=A[1],f&&(c[T+2]=A[2])}}if(f){const a=Om(c,0,1),y=Om(c,0,2),T=Om(c,1,2);if(!a&&!y&&!T)return[];a>y&&a>T||(y>T?(t||(c=c.slice()),I0(c,0,2,1)):(t||(c=c.slice()),I0(c,2,0,1)))}return _L(c,o,e)}class AL extends C2{constructor(e){const{fp64:t,IndexType:r=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:r,size:1}}})}get(e){const{attributes:t}=this;return e==="indices"?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);const t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const t=TL(e,this.positionSize);return this.opts.resolution?O2(Gu(t),bd(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?rL(Gu(t),bd(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(C0(e)){let t=0;for(const r of e)t+=this.getGeometrySize(r);return t}return Gu(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&C0(e))for(const r of e){const o=this.getGeometrySize(r);t.geometrySize=o,this.updateGeometryAttributes(r,t),t.vertexStart+=o,t.indexStart=this.indexStarts[t.geometryIndex+1]}else{const r=e;this._updateIndices(r,t),this._updatePositions(r,t),this._updateVertexValid(r,t)}}_updateIndices(e,{geometryIndex:t,vertexStart:r,indexStart:o}){const{attributes:c,indexStarts:f,typedArrayManager:a}=this;let y=c.indices;if(!y||!e)return;let T=o;const A=SL(e,this.positionSize,this.opts.preproject,this.opts.full3d);y=a.allocate(y,o+A.length,{copy:!0});for(let M=0;M<A.length;M++)y[T++]=A[M]+r;f[t+1]=o+A.length,c.indices=y}_updatePositions(e,{vertexStart:t,geometrySize:r}){const{attributes:{positions:o},positionSize:c}=this;if(!o||!e)return;const f=Gu(e);for(let a=t,y=0;y<r;a++,y++){const T=f[y*c],A=f[y*c+1],M=c>2?f[y*c+2]:0;o[a*3]=T,o[a*3+1]=A,o[a*3+2]=M}}_updateVertexValid(e,{vertexStart:t,geometrySize:r}){const{positionSize:o}=this,c=this.attributes.vertexValid,f=e&&bd(e);if(e&&e.edgeTypes?c.set(e.edgeTypes,t):c.fill(1,t,t+r),f)for(let a=0;a<f.length;a++)c[t+f[a]/o-1]=0;c[t+r-1]=0}}function C0(i){return Array.isArray(i)&&i.length>0&&!Number.isFinite(i[0])}const M0=`uniform solidPolygonUniforms {
  bool extruded;
  bool isWireframe;
  float elevationScale;
} solidPolygon;
`,PL={name:"solidPolygon",vs:M0,fs:M0,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},z2=`in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;
out vec4 vColor;
struct PolygonProps {
vec3 positions;
vec3 positions64Low;
vec3 normal;
float elevations;
};
vec3 project_offset_normal(vec3 vector) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
return normalize(vector * project.commonUnitsPerWorldUnit);
}
return project_normal(vector);
}
void calculatePosition(PolygonProps props) {
vec3 pos = props.positions;
vec3 pos64Low = props.positions64Low;
vec3 normal = props.normal;
vec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;
geometry.worldPosition = props.positions;
geometry.pickingColor = pickingColors;
if (solidPolygon.extruded) {
pos.z += props.elevations * solidPolygon.elevationScale;
}
gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
if (solidPolygon.extruded) {
#ifdef IS_SIDE_VERTEX
normal = project_offset_normal(normal);
#else
normal = project_normal(normal);
#endif
geometry.normal = normal;
vec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, colors.a * layer.opacity);
} else {
vColor = vec4(colors.rgb, colors.a * layer.opacity);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,EL=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader
in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;
${z2}
void main(void) {
PolygonProps props;
props.positions = vertexPositions;
props.positions64Low = vertexPositions64Low;
props.elevations = elevations;
props.normal = vec3(0.0, 0.0, 1.0);
calculatePosition(props);
}
`,IL=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX
in vec2 positions;
in vec3 vertexPositions;
in vec3 nextVertexPositions;
in vec3 vertexPositions64Low;
in vec3 nextVertexPositions64Low;
in float elevations;
in float instanceVertexValid;
${z2}
void main(void) {
if(instanceVertexValid < 0.5){
gl_Position = vec4(0.);
return;
}
PolygonProps props;
vec3 pos;
vec3 pos64Low;
vec3 nextPos;
vec3 nextPos64Low;
#if RING_WINDING_ORDER_CW == 1
pos = vertexPositions;
pos64Low = vertexPositions64Low;
nextPos = nextVertexPositions;
nextPos64Low = nextVertexPositions64Low;
#else
pos = nextVertexPositions;
pos64Low = nextVertexPositions64Low;
nextPos = vertexPositions;
nextPos64Low = vertexPositions64Low;
#endif
props.positions = mix(pos, nextPos, positions.x);
props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);
props.normal = vec3(
pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
0.0);
props.elevations = elevations * positions.y;
calculatePosition(props);
}
`,CL=`#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader
precision highp float;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
fragColor = vColor;
geometry.uv = vec2(0.);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,rp=[0,0,0,255],ML={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:i=>i.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:rp},getLineColor:{type:"accessor",value:rp},material:!0},ld={enter:(i,e)=>e.length?e.subarray(e.length-i.length):i};class vy extends eo{getShaders(e){return super.getShaders({vs:e==="top"?EL:IL,fs:CL,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[Sc,P1,Ac,PL]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){const{viewport:e}=this.context;let{coordinateSystem:t}=this.props;const{_full3d:r}=this.props;e.isGeospatial&&t===oi.DEFAULT&&(t=oi.LNGLAT);let o;t===oi.LNGLAT&&(r?o=e.projectPosition.bind(e):o=e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new AL({preproject:o,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const c=this.getAttributeManager(),f=!0;c.remove(["instancePickingColors"]),c.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:f},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:ld,accessor:"getPolygon",update:this.calculatePositions,noAlloc:f,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:f},elevations:{size:1,stepMode:"dynamic",transition:ld,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:ld,accessor:"getFillColor",defaultValue:rp},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:ld,accessor:"getLineColor",defaultValue:rp},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(a,{index:y,target:T})=>this.encodePickingColor(a&&a.__source?a.__source.index:y,T)}})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r}=t,o=this.props.data;return o[0]&&o[0].__source&&(t.object=o.find(c=>c.__source.index===r)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let r=0;r<t.length;r++)t[r].__source.index===e&&this._disablePickingIndex(r);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:t,filled:r,wireframe:o,elevationScale:c}=this.props,{topModel:f,sideModel:a,wireframeModel:y,polygonTesselator:T}=this.state,A={extruded:!!t,elevationScale:c,isWireframe:!1};y&&o&&(y.setInstanceCount(T.instanceCount-1),y.shaderInputs.setProps({solidPolygon:{...A,isWireframe:!0}}),y.draw(this.context.renderPass)),a&&r&&(a.setInstanceCount(T.instanceCount-1),a.shaderInputs.setProps({solidPolygon:A}),a.draw(this.context.renderPass)),f&&r&&(f.setVertexCount(T.vertexCount),f.shaderInputs.setProps({solidPolygon:A}),f.draw(this.context.renderPass))}updateState(e){var a;super.updateState(e),this.updateGeometry(e);const{props:t,oldProps:r,changeFlags:o}=e,c=this.getAttributeManager();(o.extensionsChanged||t.filled!==r.filled||t.extruded!==r.extruded)&&((a=this.state.models)==null||a.forEach(y=>y.destroy()),this.setState(this._getModels()),c.invalidateAll())}updateGeometry({props:e,oldProps:t,changeFlags:r}){if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPolygon)){const{polygonTesselator:c}=this.state,f=e.data.attributes||{};c.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:f.getPolygon,buffers:f,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:r.dataChanged,full3d:e._full3d}),this.setState({numInstances:c.instanceCount,startIndices:c.vertexStarts}),r.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:e,filled:t,extruded:r}=this.props;let o,c,f;if(t){const a=this.getShaders("top");a.defines.NON_INSTANCED_MODEL=1;const y=this.getAttributeManager().getBufferLayouts({isInstanced:!1});o=new Pn(this.context.device,{...a,id:`${e}-top`,topology:"triangle-list",bufferLayout:y,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(r){const a=this.getAttributeManager().getBufferLayouts({isInstanced:!0});c=new Pn(this.context.device,{...this.getShaders("side"),id:`${e}-side`,bufferLayout:a,geometry:new vc({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),f=new Pn(this.context.device,{...this.getShaders("side"),id:`${e}-wireframe`,bufferLayout:a,geometry:new vc({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[c,f,o].filter(Boolean),topModel:o,sideModel:c,wireframeModel:f}}calculateIndices(e){const{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){const{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}vy.defaultProps=ML;vy.layerName="SolidPolygonLayer";function RL({data:i,getIndex:e,dataRange:t,replace:r}){const{startRow:o=0,endRow:c=1/0}=t,f=i.length;let a=f,y=f;for(let F=0;F<f;F++){const L=e(i[F]);if(a>F&&L>=o&&(a=F),L>=c){y=F;break}}let T=a;const M=y-a!==r.length?i.slice(y):void 0;for(let F=0;F<r.length;F++)i[T++]=r[F];if(M){for(let F=0;F<M.length;F++)i[T++]=M[F];i.length=T}return{startRow:a,endRow:a+r.length}}function kL(i,e){if(!i)return null;const t="startIndices"in i?i.startIndices[e]:e,r=i.featureIds.value[t];return t!==-1?DL(i,r,t):null}function DL(i,e,t){const r={properties:{...i.properties[e]}};for(const o in i.numericProps)r.properties[o]=i.numericProps[o].value[t];return r}function OL(i,e){const t={points:null,lines:null,polygons:null};for(const r in t){const o=i[r].globalFeatureIds.value;t[r]=new Uint8ClampedArray(o.length*4);const c=[];for(let f=0;f<o.length;f++)e(o[f],c),t[r][f*4+0]=c[0],t[r][f*4+1]=c[1],t[r][f*4+2]=c[2],t[r][f*4+3]=255}return t}const R0=`uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,FL={name:"sdf",vs:R0,fs:R0,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},LL=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Fm=192/256,k0=[],BL={getIconOffsets:{type:"accessor",value:i=>i.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class by extends Fp{getShaders(){const e=super.getShaders();return{...e,modules:[...e.modules,FL],fs:LL}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(t,{index:r,target:o})=>this.encodePickingColor(r,o)}})}updateState(e){super.updateState(e);const{props:t,oldProps:r}=e;let{outlineColor:o}=t;o!==r.outlineColor&&(o=o.map(c=>c/255),o[3]=Number.isFinite(o[3])?o[3]:1,this.setState({outlineColor:o})),!t.sdf&&t.outlineWidth&&ri.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:t,smoothing:r,outlineWidth:o}=this.props,{outlineColor:c}=this.state,f=o?Math.max(r,Fm*(1-o)):-1,a=this.state.model,y={buffer:Fm,outlineBuffer:f,gamma:r,enabled:!!t,outlineColor:c};if(a.shaderInputs.setProps({sdf:y}),super.draw(e),t&&o){const{iconManager:T}=this.state;T.getTexture()&&(a.shaderInputs.setProps({sdf:{...y,outlineBuffer:Fm}}),a.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):k0}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):k0}}by.defaultProps=BL;by.layerName="MultiIconLayer";const np=1e20;class NL{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:o=.25,fontFamily:c="sans-serif",fontWeight:f="normal",fontStyle:a="normal"}={}){this.buffer=t,this.cutoff=o,this.radius=r;const y=this.size=e+t*4,T=this._createCanvas(y),A=this.ctx=T.getContext("2d",{willReadFrequently:!0});A.font=`${a} ${f} ${e}px ${c}`,A.textBaseline="alphabetic",A.textAlign="left",A.fillStyle="black",this.gridOuter=new Float64Array(y*y),this.gridInner=new Float64Array(y*y),this.f=new Float64Array(y),this.z=new Float64Array(y+1),this.v=new Uint16Array(y)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:o,actualBoundingBoxLeft:c,actualBoundingBoxRight:f}=this.ctx.measureText(e),a=Math.ceil(r),y=0,T=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-c))),A=Math.min(this.size-this.buffer,a+Math.ceil(o)),M=T+2*this.buffer,F=A+2*this.buffer,L=Math.max(M*F,0),Y=new Uint8ClampedArray(L),ae={data:Y,width:M,height:F,glyphWidth:T,glyphHeight:A,glyphTop:a,glyphLeft:y,glyphAdvance:t};if(T===0||A===0)return ae;const{ctx:pe,buffer:Ee,gridInner:Be,gridOuter:xe}=this;pe.clearRect(Ee,Ee,T,A),pe.fillText(e,Ee,Ee+a);const Ce=pe.getImageData(Ee,Ee,T,A);xe.fill(np,0,L),Be.fill(0,0,L);for(let tt=0;tt<A;tt++)for(let Xe=0;Xe<T;Xe++){const gt=Ce.data[4*(tt*T+Xe)+3]/255;if(gt===0)continue;const ft=(tt+Ee)*M+Xe+Ee;if(gt===1)xe[ft]=0,Be[ft]=np;else{const yt=.5-gt;xe[ft]=yt>0?yt*yt:0,Be[ft]=yt<0?yt*yt:0}}D0(xe,0,0,M,F,M,this.f,this.v,this.z),D0(Be,Ee,Ee,T,A,M,this.f,this.v,this.z);for(let tt=0;tt<L;tt++){const Xe=Math.sqrt(xe[tt])-Math.sqrt(Be[tt]);Y[tt]=Math.round(255-255*(Xe/this.radius+this.cutoff))}return ae}}function D0(i,e,t,r,o,c,f,a,y){for(let T=e;T<e+r;T++)O0(i,t*c+T,c,o,f,a,y);for(let T=t;T<t+o;T++)O0(i,T*c+e,1,r,f,a,y)}function O0(i,e,t,r,o,c,f){c[0]=0,f[0]=-1e20,f[1]=np,o[0]=i[e];for(let a=1,y=0,T=0;a<r;a++){o[a]=i[e+a*t];const A=a*a;do{const M=c[y];T=(o[a]-o[M]+A-M*M)/(a-M)/2}while(T<=f[y]&&--y>-1);y++,c[y]=a,f[y]=T,f[y+1]=np}for(let a=0,y=0;a<r;a++){for(;f[y+1]<a;)y++;const T=c[y],A=a-T;i[e+a*t]=o[T]+A*A}}const zL=32,UL=[];function VL(i){return Math.pow(2,Math.ceil(Math.log2(i)))}function jL({characterSet:i,getFontWidth:e,fontHeight:t,buffer:r,maxCanvasWidth:o,mapping:c={},xOffset:f=0,yOffset:a=0}){let y=0,T=f;const A=t+r*2;for(const M of i)if(!c[M]){const F=e(M);T+F+r*2>o&&(T=0,y++),c[M]={x:T+r,y:a+y*A+r,width:F,height:A,layoutWidth:F,layoutHeight:t},T+=F+r*2}return{mapping:c,xOffset:T,yOffset:a+y*A,canvasHeight:VL(a+(y+1)*A)}}function U2(i,e,t,r){var c;let o=0;for(let f=e;f<t;f++){const a=i[f];o+=((c=r[a])==null?void 0:c.layoutWidth)||0}return o}function V2(i,e,t,r,o,c){let f=e,a=0;for(let y=e;y<t;y++){const T=U2(i,y,y+1,o);a+T>r&&(f<y&&c.push(y),f=y,a=0),a+=T}return a}function $L(i,e,t,r,o,c){let f=e,a=e,y=e,T=0;for(let A=e;A<t;A++)if((i[A]===" "||i[A+1]===" "||A+1===t)&&(y=A+1),y>a){let M=U2(i,a,y,o);T+M>r&&(f<a&&(c.push(a),f=a,T=0),M>r&&(M=V2(i,a,y,r,o,c),f=c[c.length-1])),a=y,T+=M}return T}function WL(i,e,t,r,o=0,c){c===void 0&&(c=i.length);const f=[];return e==="break-all"?V2(i,o,c,t,r,f):$L(i,o,c,t,r,f),f}function HL(i,e,t,r,o,c){let f=0,a=0;for(let y=e;y<t;y++){const T=i[y],A=r[T];A?(a||(a=A.layoutHeight),o[y]=f+A.layoutWidth/2,f+=A.layoutWidth):(ri.warn(`Missing character: ${T} (${T.codePointAt(0)})`)(),o[y]=f,f+=zL)}c[0]=f,c[1]=a}function ZL(i,e,t,r,o){var pe;const c=Array.from(i),f=c.length,a=new Array(f),y=new Array(f),T=new Array(f),A=(t==="break-word"||t==="break-all")&&isFinite(r)&&r>0,M=[0,0],F=[0,0];let L=0,Y=0,ae=0;for(let Ee=0;Ee<=f;Ee++){const Be=c[Ee];if((Be===`
`||Ee===f)&&(ae=Ee),ae>Y){const xe=A?WL(c,t,r,o,Y,ae):UL;for(let Ce=0;Ce<=xe.length;Ce++){const tt=Ce===0?Y:xe[Ce-1],Xe=Ce<xe.length?xe[Ce]:ae;HL(c,tt,Xe,o,a,F);for(let gt=tt;gt<Xe;gt++){const ft=c[gt],yt=((pe=o[ft])==null?void 0:pe.layoutOffsetY)||0;y[gt]=L+F[1]/2+yt,T[gt]=F[0]}L=L+F[1]*e,M[0]=Math.max(M[0],F[0])}Y=ae}Be===`
`&&(a[Y]=0,y[Y]=0,T[Y]=0,Y++)}return M[1]=L,{x:a,y,rowWidth:T,size:M}}function XL({value:i,length:e,stride:t,offset:r,startIndices:o,characterSet:c}){const f=i.BYTES_PER_ELEMENT,a=t?t/f:1,y=r?r/f:0,T=o[e]||Math.ceil((i.length-y)/a),A=c&&new Set,M=new Array(e);let F=i;if(a>1||y>0){const L=i.constructor;F=new L(T);for(let Y=0;Y<T;Y++)F[Y]=i[Y*a+y]}for(let L=0;L<e;L++){const Y=o[L],ae=o[L+1]||T,pe=F.subarray(Y,ae);M[L]=String.fromCodePoint.apply(null,pe),A&&pe.forEach(A.add,A)}if(A)for(const L of A)c.add(String.fromCodePoint(L));return{texts:M,characterCount:T}}class j2{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}function qL(){const i=[];for(let e=32;e<128;e++)i.push(String.fromCharCode(e));return i}const uc={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:qL(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},F0=1024,L0=.9,B0=1.2,$2=3;let sp=new j2($2);function GL(i,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);const r=sp.get(i);if(!r)return t;for(const o in r.mapping)t.has(o)&&t.delete(o);return t}function YL(i,e){for(let t=0;t<i.length;t++)e.data[4*t+3]=i[t]}function N0(i,e,t,r){i.font=`${r} ${t}px ${e}`,i.fillStyle="#000",i.textBaseline="alphabetic",i.textAlign="left"}function KL(i){ri.assert(Number.isFinite(i)&&i>=$2,"Invalid cache limit"),sp=new j2(i)}class JL{constructor(){this.props={...uc}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:t}=this.props;return(e*B0+t*2)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const t=GL(this._key,this.props.characterSet),r=sp.get(this._key);if(r&&t.size===0){this._atlas!==r&&(this._atlas=r);return}const o=this._generateFontAtlas(t,r);this._atlas=o,sp.set(this._key,o)}_generateFontAtlas(e,t){const{fontFamily:r,fontWeight:o,fontSize:c,buffer:f,sdf:a,radius:y,cutoff:T}=this.props;let A=t&&t.data;A||(A=document.createElement("canvas"),A.width=F0);const M=A.getContext("2d",{willReadFrequently:!0});N0(M,r,c,o);const{mapping:F,canvasHeight:L,xOffset:Y,yOffset:ae}=jL({getFontWidth:pe=>M.measureText(pe).width,fontHeight:c*B0,buffer:f,characterSet:e,maxCanvasWidth:F0,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(A.height!==L){const pe=M.getImageData(0,0,A.width,A.height);A.height=L,M.putImageData(pe,0,0)}if(N0(M,r,c,o),a){const pe=new NL({fontSize:c,buffer:f,radius:y,cutoff:T,fontFamily:r,fontWeight:`${o}`});for(const Ee of e){const{data:Be,width:xe,height:Ce,glyphTop:tt}=pe.draw(Ee);F[Ee].width=xe,F[Ee].layoutOffsetY=c*L0-tt;const Xe=M.createImageData(xe,Ce);YL(Be,Xe),M.putImageData(Xe,F[Ee].x,F[Ee].y)}}else for(const pe of e)M.fillText(pe,F[pe].x,F[pe].y+f+c*L0);return{xOffset:Y,yOffset:ae,mapping:F,data:A,width:A.width,height:A.height}}_getKey(){const{fontFamily:e,fontWeight:t,fontSize:r,buffer:o,sdf:c,radius:f,cutoff:a}=this.props;return c?`${e} ${t} ${r} ${o} ${f} ${a}`:`${e} ${t} ${r} ${o}`}}const z0=`uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,QL={name:"textBackground",vs:z0,fs:z0,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},eB=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,tB=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec2 pixelPosition = uv * dimensions;
if (textBackground.stroked) {
float distToEdge = min(
min(pixelPosition.x, dimensions.x - pixelPosition.x),
min(pixelPosition.y, dimensions.y - pixelPosition.y)
);
float isBorder = smoothedge(distToEdge, vLineWidth);
fragColor = mix(vFillColor, vLineColor, isBorder);
} else {
fragColor = vFillColor;
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,iB={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:i=>i.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class wy extends eo{getShaders(){return super.getShaders({vs:eB,fs:tB,modules:[Sc,Ac,QL]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var r;super.updateState(e);const{changeFlags:t}=e;t.extensionsChanged&&((r=this.state.model)==null||r.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:t,sizeScale:r,sizeUnits:o,sizeMinPixels:c,sizeMaxPixels:f,getLineWidth:a}=this.props;let{padding:y}=this.props;y.length<4&&(y=[y[0],y[1],y[0],y[1]]);const T=this.state.model,A={billboard:t,stroked:!!a,padding:y,sizeUnits:Ss[o],sizeScale:r,sizeMinPixels:c,sizeMaxPixels:f};T.shaderInputs.setProps({textBackground:A}),T.draw(this.context.renderPass)}_getModel(){const e=[0,0,1,0,0,1,1,1];return new Pn(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new vc({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}}wy.defaultProps=iB;wy.layerName="TextBackgroundLayer";const U0={start:1,middle:0,end:-1},V0={top:1,center:0,bottom:-1},Lm=[0,0,0,255],rB=1,nB={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Lm},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:uc.characterSet},fontFamily:uc.fontFamily,fontWeight:uc.fontWeight,lineHeight:rB,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Lm},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:i=>i.text},getPosition:{type:"accessor",value:i=>i.position},getColor:{type:"accessor",value:Lm},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class Ty extends my{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[r,o]}=this.transformParagraph(e,t);const{fontSize:c}=this.state.fontAtlasManager.props;r/=c,o/=c;const{getTextAnchor:f,getAlignmentBaseline:a}=this.props,y=U0[typeof f=="function"?f(e,t):f],T=V0[typeof a=="function"?a(e,t):a];return[(y-1)*r/2,(T-1)*o/2,r,o]},this.getIconOffsets=(e,t)=>{const{getTextAnchor:r,getAlignmentBaseline:o}=this.props,{x:c,y:f,rowWidth:a,size:[y,T]}=this.transformParagraph(e,t),A=U0[typeof r=="function"?r(e,t):r],M=V0[typeof o=="function"?o(e,t):o],F=c.length,L=new Array(F*2);let Y=0;for(let ae=0;ae<F;ae++){const pe=(1-A)*(y-a[ae])/2;L[Y++]=(A-1)*y/2+pe+c[ae],L[Y++]=(M-1)*T/2+f[ae]}return L}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new JL},this.props.maxWidth>0&&ri.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:t,oldProps:r,changeFlags:o}=e;(o.dataChanged||o.updateTriggersChanged&&(o.updateTriggersChanged.all||o.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==r.lineHeight||t.wordBreak!==r.wordBreak||t.maxWidth!==r.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:t,fontWeight:r}=this.props,{fontAtlasManager:o,characterSet:c}=this.state,f={...e,characterSet:c,fontFamily:t,fontWeight:r};if(!o.mapping)return o.setProps(f),!0;for(const a in f)if(f[a]!==o.props[a])return o.setProps(f),!0;return!1}_updateText(){var y;const{data:e,characterSet:t}=this.props,r=(y=e.attributes)==null?void 0:y.getText;let{getText:o}=this.props,c=e.startIndices,f;const a=t==="auto"&&new Set;if(r&&c){const{texts:T,characterCount:A}=XL({...ArrayBuffer.isView(r)?{value:r}:r,length:e.length,startIndices:c,characterSet:a});f=A,o=(M,{index:F})=>T[F]}else{const{iterable:T,objectInfo:A}=Dp(e);c=[0],f=0;for(const M of T){A.index++;const F=Array.from(o(M,A)||"");a&&F.forEach(a.add,a),f+=F.length,c.push(f)}}this.setState({getText:o,startIndices:c,numInstances:f,characterSet:a||t})}transformParagraph(e,t){const{fontAtlasManager:r}=this.state,o=r.mapping,c=this.state.getText,{wordBreak:f,lineHeight:a,maxWidth:y}=this.props,T=c(e,t)||"";return ZL(T,a,f,y*r.props.fontSize,o)}renderLayers(){const{startIndices:e,numInstances:t,getText:r,fontAtlasManager:{scale:o,atlas:c,mapping:f},styleVersion:a}=this.state,{data:y,_dataDiff:T,getPosition:A,getColor:M,getSize:F,getAngle:L,getPixelOffset:Y,getBackgroundColor:ae,getBorderColor:pe,getBorderWidth:Ee,backgroundPadding:Be,background:xe,billboard:Ce,fontSettings:tt,outlineWidth:Xe,outlineColor:gt,sizeScale:ft,sizeUnits:yt,sizeMinPixels:Bt,sizeMaxPixels:Pt,transitions:Lt,updateTriggers:Dt}=this.props,kt=this.getSubLayerClass("characters",by),ji=this.getSubLayerClass("background",wy);return[xe&&new ji({getFillColor:ae,getLineColor:pe,getLineWidth:Ee,padding:Be,getPosition:A,getSize:F,getAngle:L,getPixelOffset:Y,billboard:Ce,sizeScale:ft,sizeUnits:yt,sizeMinPixels:Bt,sizeMaxPixels:Pt,transitions:Lt&&{getPosition:Lt.getPosition,getAngle:Lt.getAngle,getSize:Lt.getSize,getFillColor:Lt.getBackgroundColor,getLineColor:Lt.getBorderColor,getLineWidth:Lt.getBorderWidth,getPixelOffset:Lt.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:Dt.getPosition,getAngle:Dt.getAngle,getSize:Dt.getSize,getFillColor:Dt.getBackgroundColor,getLineColor:Dt.getBorderColor,getLineWidth:Dt.getBorderWidth,getPixelOffset:Dt.getPixelOffset,getBoundingRect:{getText:Dt.getText,getTextAnchor:Dt.getTextAnchor,getAlignmentBaseline:Dt.getAlignmentBaseline,styleVersion:a}}}),{data:y.attributes&&y.attributes.background?{length:y.length,attributes:y.attributes.background}:y,_dataDiff:T,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new kt({sdf:tt.sdf,smoothing:Number.isFinite(tt.smoothing)?tt.smoothing:uc.smoothing,outlineWidth:Xe/(tt.radius||uc.radius),outlineColor:gt,iconAtlas:c,iconMapping:f,getPosition:A,getColor:M,getSize:F,getAngle:L,getPixelOffset:Y,billboard:Ce,sizeScale:ft*o,sizeUnits:yt,sizeMinPixels:Bt*o,sizeMaxPixels:Pt*o,transitions:Lt&&{getPosition:Lt.getPosition,getAngle:Lt.getAngle,getColor:Lt.getColor,getSize:Lt.getSize,getPixelOffset:Lt.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:Dt.getText,getPosition:Dt.getPosition,getAngle:Dt.getAngle,getColor:Dt.getColor,getSize:Dt.getSize,getPixelOffset:Dt.getPixelOffset,getIconOffsets:{getTextAnchor:Dt.getTextAnchor,getAlignmentBaseline:Dt.getAlignmentBaseline,styleVersion:a}}}),{data:y,_dataDiff:T,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:r})]}static set fontAtlasCacheLimit(e){KL(e)}}Ty.defaultProps=nB;Ty.layerName="TextLayer";const wd={circle:{type:yy,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:Fp,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:Ty,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},Td={type:xy,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},R_={type:vy,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function ju({type:i,props:e}){const t={};for(const r in e)t[r]=i.defaultProps[e[r]];return t}function Bm(i,e){const{transitions:t,updateTriggers:r}=i.props,o={updateTriggers:{},transitions:t&&{getPosition:t.geometry}};for(const c in e){const f=e[c];let a=i.props[c];c.startsWith("get")&&(a=i.getSubLayerAccessor(a),o.updateTriggers[f]=r[c],t&&(o.transitions[f]=t[c])),o[f]=a}return o}function sB(i){if(Array.isArray(i))return i;switch(ri.assert(i.type,"GeoJSON does not have type"),i.type){case"Feature":return[i];case"FeatureCollection":return ri.assert(Array.isArray(i.features),"GeoJSON does not have features array"),i.features;default:return[{geometry:i}]}}function j0(i,e,t={}){const r={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:o=0,endRow:c=i.length}=t;for(let f=o;f<c;f++){const a=i[f],{geometry:y}=a;if(y)if(y.type==="GeometryCollection"){ri.assert(Array.isArray(y.geometries),"GeoJSON does not have geometries array");const{geometries:T}=y;for(let A=0;A<T.length;A++){const M=T[A];$0(M,r,e,a,f)}}else $0(y,r,e,a,f)}return r}function $0(i,e,t,r,o){const{type:c,coordinates:f}=i,{pointFeatures:a,lineFeatures:y,polygonFeatures:T,polygonOutlineFeatures:A}=e;if(!aB(c,f)){ri.warn(`${c} coordinates are malformed`)();return}switch(c){case"Point":a.push(t({geometry:i},r,o));break;case"MultiPoint":f.forEach(M=>{a.push(t({geometry:{type:"Point",coordinates:M}},r,o))});break;case"LineString":y.push(t({geometry:i},r,o));break;case"MultiLineString":f.forEach(M=>{y.push(t({geometry:{type:"LineString",coordinates:M}},r,o))});break;case"Polygon":T.push(t({geometry:i},r,o)),f.forEach(M=>{A.push(t({geometry:{type:"LineString",coordinates:M}},r,o))});break;case"MultiPolygon":f.forEach(M=>{T.push(t({geometry:{type:"Polygon",coordinates:M}},r,o)),M.forEach(F=>{A.push(t({geometry:{type:"LineString",coordinates:F}},r,o))})});break}}const oB={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function aB(i,e){let t=oB[i];for(ri.assert(t,`Unknown GeoJSON type ${i}`);e&&--t>0;)e=e[0];return e&&Number.isFinite(e[0])}function W2(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function cd(i){return i.geometry.coordinates}function lB(i,e){const t=W2(),{pointFeatures:r,lineFeatures:o,polygonFeatures:c,polygonOutlineFeatures:f}=i;return t.points.data=r,t.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),t.points.getPosition=cd,t.lines.data=o,t.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),t.lines.getPath=cd,t.polygons.data=c,t.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),t.polygons.getPolygon=cd,t.polygonsOutline.data=f,t.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),t.polygonsOutline.getPath=cd,t}function cB(i,e){const t=W2(),{points:r,lines:o,polygons:c}=i,f=OL(i,e);return t.points.data={length:r.positions.value.length/r.positions.size,attributes:{...r.attributes,getPosition:r.positions,instancePickingColors:{size:4,value:f.points}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},t.lines.data={length:o.pathIndices.value.length-1,startIndices:o.pathIndices.value,attributes:{...o.attributes,getPath:o.positions,instancePickingColors:{size:4,value:f.lines}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.lines._pathType="open",t.polygons.data={length:c.polygonIndices.value.length-1,startIndices:c.polygonIndices.value,attributes:{...c.attributes,getPolygon:c.positions,pickingColors:{size:4,value:f.polygons}},properties:c.properties,numericProps:c.numericProps,featureIds:c.featureIds},t.polygons._normalize=!1,c.triangles&&(t.polygons.data.attributes.indices=c.triangles.value),t.polygonsOutline.data={length:c.primitivePolygonIndices.value.length-1,startIndices:c.primitivePolygonIndices.value,attributes:{...c.attributes,getPath:c.positions,instancePickingColors:{size:4,value:f.polygons}},properties:c.properties,numericProps:c.numericProps,featureIds:c.featureIds},t.polygonsOutline._pathType="open",t}const uB=["points","linestrings","polygons"],hB={...ju(wd.circle),...ju(wd.icon),...ju(wd.text),...ju(Td),...ju(R_),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:i=>i.properties.icon},getText:{type:"accessor",value:i=>i.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class Sy extends my{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;const{data:r}=this.props,o=r&&"points"in r&&"polygons"in r&&"lines"in r;this.setState({binary:o}),o?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){const r=cB(e.data,this.encodePickingColor);this.setState({layerProps:r})}_updateStateJSON({props:e,changeFlags:t}){const r=sB(e.data),o=this.getSubLayerRow.bind(this);let c={};const f={};if(Array.isArray(t.dataChanged)){const y=this.state.features;for(const T in y)c[T]=y[T].slice(),f[T]=[];for(const T of t.dataChanged){const A=j0(r,o,T);for(const M in y)f[M].push(RL({data:c[M],getIndex:F=>F.__source.index,dataRange:T,replace:A[M]}))}}else c=j0(r,o);const a=lB(c,f);this.setState({features:c,featuresDiff:f,layerProps:a})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r,sourceLayer:o}=t;return t.featureType=uB.find(c=>o.id.startsWith(`${this.id}-${c}-`)),r>=0&&o.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[r]),t}_updateAutoHighlight(e){const t=`${this.id}-points-`,r=e.featureType==="points";for(const o of this.getSubLayers())o.id.startsWith(t)===r&&o.updateAutoHighlight(e)}_renderPolygonLayer(){var f;const{extruded:e,wireframe:t}=this.props,{layerProps:r}=this.state,o="polygons-fill",c=this.shouldRenderSubLayer(o,(f=r.polygons)==null?void 0:f.data)&&this.getSubLayerClass(o,R_.type);if(c){const a=Bm(this,R_.props),y=e&&t;return y||delete a.getLineColor,a.updateTriggers.lineColors=y,new c(a,this.getSubLayerProps({id:o,updateTriggers:a.updateTriggers}),r.polygons)}return null}_renderLineLayers(){var y,T;const{extruded:e,stroked:t}=this.props,{layerProps:r}=this.state,o="polygons-stroke",c="linestrings",f=!e&&t&&this.shouldRenderSubLayer(o,(y=r.polygonsOutline)==null?void 0:y.data)&&this.getSubLayerClass(o,Td.type),a=this.shouldRenderSubLayer(c,(T=r.lines)==null?void 0:T.data)&&this.getSubLayerClass(c,Td.type);if(f||a){const A=Bm(this,Td.props);return[f&&new f(A,this.getSubLayerProps({id:o,updateTriggers:A.updateTriggers}),r.polygonsOutline),a&&new a(A,this.getSubLayerProps({id:c,updateTriggers:A.updateTriggers}),r.lines)]}return null}_renderPointLayers(){var a;const{pointType:e}=this.props,{layerProps:t,binary:r}=this.state;let{highlightedObjectIndex:o}=this.props;!r&&Number.isFinite(o)&&(o=t.points.data.findIndex(y=>y.__source.index===o));const c=new Set(e.split("+")),f=[];for(const y of c){const T=`points-${y}`,A=wd[y],M=A&&this.shouldRenderSubLayer(T,(a=t.points)==null?void 0:a.data)&&this.getSubLayerClass(T,A.type);if(M){const F=Bm(this,A.props);let L=t.points;if(y==="text"&&r){const{instancePickingColors:Y,...ae}=L.data.attributes;L={...L,data:{...L.data,attributes:ae}}}f.push(new M(F,this.getSubLayerProps({id:T,updateTriggers:F.updateTriggers,highlightedObjectIndex:o}),L))}}return f}renderLayers(){const{extruded:e}=this.props,t=this._renderPolygonLayer(),r=this._renderLineLayers(),o=this._renderPointLayers();return[!e&&t,r,o,e&&t]}getSubLayerAccessor(e){const{binary:t}=this.state;return!t||typeof e!="function"?super.getSubLayerAccessor(e):(r,o)=>{const{data:c,index:f}=o,a=kL(c,f);return e(a,o)}}}Sy.layerName="GeoJsonLayer";Sy.defaultProps=hB;function oh(i,e){return i==null||e==null?NaN:i<e?-1:i>e?1:i>=e?0:NaN}function fB(i,e){return i==null||e==null?NaN:e<i?-1:e>i?1:e>=i?0:NaN}function H2(i){let e,t,r;i.length!==2?(e=oh,t=(a,y)=>oh(i(a),y),r=(a,y)=>i(a)-y):(e=i===oh||i===fB?i:dB,t=i,r=i);function o(a,y,T=0,A=a.length){if(T<A){if(e(y,y)!==0)return A;do{const M=T+A>>>1;t(a[M],y)<0?T=M+1:A=M}while(T<A)}return T}function c(a,y,T=0,A=a.length){if(T<A){if(e(y,y)!==0)return A;do{const M=T+A>>>1;t(a[M],y)<=0?T=M+1:A=M}while(T<A)}return T}function f(a,y,T=0,A=a.length){const M=o(a,y,T,A-1);return M>T&&r(a[M-1],y)>-r(a[M],y)?M-1:M}return{left:o,center:f,right:c}}function dB(){return 0}function Z2(i){return i===null?NaN:+i}const pB=H2(oh),gB=pB.right;H2(Z2).center;function mB(i,e,t=Z2){if(!(!(r=i.length)||isNaN(e=+e))){if(e<=0||r<2)return+t(i[0],0,i);if(e>=1)return+t(i[r-1],r-1,i);var r,o=(r-1)*e,c=Math.floor(o),f=+t(i[c],c,i),a=+t(i[c+1],c+1,i);return f+(a-f)*(o-c)}}var _B={value:()=>{}};function X2(){for(var i=0,e=arguments.length,t={},r;i<e;++i){if(!(r=arguments[i]+"")||r in t||/[\s.]/.test(r))throw new Error("illegal type: "+r);t[r]=[]}return new Sd(t)}function Sd(i){this._=i}function yB(i,e){return i.trim().split(/^|\s+/).map(function(t){var r="",o=t.indexOf(".");if(o>=0&&(r=t.slice(o+1),t=t.slice(0,o)),t&&!e.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:r}})}Sd.prototype=X2.prototype={constructor:Sd,on:function(i,e){var t=this._,r=yB(i+"",t),o,c=-1,f=r.length;if(arguments.length<2){for(;++c<f;)if((o=(i=r[c]).type)&&(o=xB(t[o],i.name)))return o;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++c<f;)if(o=(i=r[c]).type)t[o]=W0(t[o],i.name,e);else if(e==null)for(o in t)t[o]=W0(t[o],i.name,null);return this},copy:function(){var i={},e=this._;for(var t in e)i[t]=e[t].slice();return new Sd(i)},call:function(i,e){if((o=arguments.length-2)>0)for(var t=new Array(o),r=0,o,c;r<o;++r)t[r]=arguments[r+2];if(!this._.hasOwnProperty(i))throw new Error("unknown type: "+i);for(c=this._[i],r=0,o=c.length;r<o;++r)c[r].value.apply(e,t)},apply:function(i,e,t){if(!this._.hasOwnProperty(i))throw new Error("unknown type: "+i);for(var r=this._[i],o=0,c=r.length;o<c;++o)r[o].value.apply(e,t)}};function xB(i,e){for(var t=0,r=i.length,o;t<r;++t)if((o=i[t]).name===e)return o.value}function W0(i,e,t){for(var r=0,o=i.length;r<o;++r)if(i[r].name===e){i[r]=_B,i=i.slice(0,r).concat(i.slice(r+1));break}return t!=null&&i.push({name:e,value:t}),i}var k_="http://www.w3.org/1999/xhtml";const H0={svg:"http://www.w3.org/2000/svg",xhtml:k_,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function Lp(i){var e=i+="",t=e.indexOf(":");return t>=0&&(e=i.slice(0,t))!=="xmlns"&&(i=i.slice(t+1)),H0.hasOwnProperty(e)?{space:H0[e],local:i}:i}function vB(i){return function(){var e=this.ownerDocument,t=this.namespaceURI;return t===k_&&e.documentElement.namespaceURI===k_?e.createElement(i):e.createElementNS(t,i)}}function bB(i){return function(){return this.ownerDocument.createElementNS(i.space,i.local)}}function q2(i){var e=Lp(i);return(e.local?bB:vB)(e)}function wB(){}function Ay(i){return i==null?wB:function(){return this.querySelector(i)}}function TB(i){typeof i!="function"&&(i=Ay(i));for(var e=this._groups,t=e.length,r=new Array(t),o=0;o<t;++o)for(var c=e[o],f=c.length,a=r[o]=new Array(f),y,T,A=0;A<f;++A)(y=c[A])&&(T=i.call(y,y.__data__,A,c))&&("__data__"in y&&(T.__data__=y.__data__),a[A]=T);return new Kn(r,this._parents)}function SB(i){return i==null?[]:Array.isArray(i)?i:Array.from(i)}function AB(){return[]}function G2(i){return i==null?AB:function(){return this.querySelectorAll(i)}}function PB(i){return function(){return SB(i.apply(this,arguments))}}function EB(i){typeof i=="function"?i=PB(i):i=G2(i);for(var e=this._groups,t=e.length,r=[],o=[],c=0;c<t;++c)for(var f=e[c],a=f.length,y,T=0;T<a;++T)(y=f[T])&&(r.push(i.call(y,y.__data__,T,f)),o.push(y));return new Kn(r,o)}function Y2(i){return function(){return this.matches(i)}}function K2(i){return function(e){return e.matches(i)}}var IB=Array.prototype.find;function CB(i){return function(){return IB.call(this.children,i)}}function MB(){return this.firstElementChild}function RB(i){return this.select(i==null?MB:CB(typeof i=="function"?i:K2(i)))}var kB=Array.prototype.filter;function DB(){return Array.from(this.children)}function OB(i){return function(){return kB.call(this.children,i)}}function FB(i){return this.selectAll(i==null?DB:OB(typeof i=="function"?i:K2(i)))}function LB(i){typeof i!="function"&&(i=Y2(i));for(var e=this._groups,t=e.length,r=new Array(t),o=0;o<t;++o)for(var c=e[o],f=c.length,a=r[o]=[],y,T=0;T<f;++T)(y=c[T])&&i.call(y,y.__data__,T,c)&&a.push(y);return new Kn(r,this._parents)}function J2(i){return new Array(i.length)}function BB(){return new Kn(this._enter||this._groups.map(J2),this._parents)}function op(i,e){this.ownerDocument=i.ownerDocument,this.namespaceURI=i.namespaceURI,this._next=null,this._parent=i,this.__data__=e}op.prototype={constructor:op,appendChild:function(i){return this._parent.insertBefore(i,this._next)},insertBefore:function(i,e){return this._parent.insertBefore(i,e)},querySelector:function(i){return this._parent.querySelector(i)},querySelectorAll:function(i){return this._parent.querySelectorAll(i)}};function NB(i){return function(){return i}}function zB(i,e,t,r,o,c){for(var f=0,a,y=e.length,T=c.length;f<T;++f)(a=e[f])?(a.__data__=c[f],r[f]=a):t[f]=new op(i,c[f]);for(;f<y;++f)(a=e[f])&&(o[f]=a)}function UB(i,e,t,r,o,c,f){var a,y,T=new Map,A=e.length,M=c.length,F=new Array(A),L;for(a=0;a<A;++a)(y=e[a])&&(F[a]=L=f.call(y,y.__data__,a,e)+"",T.has(L)?o[a]=y:T.set(L,y));for(a=0;a<M;++a)L=f.call(i,c[a],a,c)+"",(y=T.get(L))?(r[a]=y,y.__data__=c[a],T.delete(L)):t[a]=new op(i,c[a]);for(a=0;a<A;++a)(y=e[a])&&T.get(F[a])===y&&(o[a]=y)}function VB(i){return i.__data__}function jB(i,e){if(!arguments.length)return Array.from(this,VB);var t=e?UB:zB,r=this._parents,o=this._groups;typeof i!="function"&&(i=NB(i));for(var c=o.length,f=new Array(c),a=new Array(c),y=new Array(c),T=0;T<c;++T){var A=r[T],M=o[T],F=M.length,L=$B(i.call(A,A&&A.__data__,T,r)),Y=L.length,ae=a[T]=new Array(Y),pe=f[T]=new Array(Y),Ee=y[T]=new Array(F);t(A,M,ae,pe,Ee,L,e);for(var Be=0,xe=0,Ce,tt;Be<Y;++Be)if(Ce=ae[Be]){for(Be>=xe&&(xe=Be+1);!(tt=pe[xe])&&++xe<Y;);Ce._next=tt||null}}return f=new Kn(f,r),f._enter=a,f._exit=y,f}function $B(i){return typeof i=="object"&&"length"in i?i:Array.from(i)}function WB(){return new Kn(this._exit||this._groups.map(J2),this._parents)}function HB(i,e,t){var r=this.enter(),o=this,c=this.exit();return typeof i=="function"?(r=i(r),r&&(r=r.selection())):r=r.append(i+""),e!=null&&(o=e(o),o&&(o=o.selection())),t==null?c.remove():t(c),r&&o?r.merge(o).order():o}function ZB(i){for(var e=i.selection?i.selection():i,t=this._groups,r=e._groups,o=t.length,c=r.length,f=Math.min(o,c),a=new Array(o),y=0;y<f;++y)for(var T=t[y],A=r[y],M=T.length,F=a[y]=new Array(M),L,Y=0;Y<M;++Y)(L=T[Y]||A[Y])&&(F[Y]=L);for(;y<o;++y)a[y]=t[y];return new Kn(a,this._parents)}function XB(){for(var i=this._groups,e=-1,t=i.length;++e<t;)for(var r=i[e],o=r.length-1,c=r[o],f;--o>=0;)(f=r[o])&&(c&&f.compareDocumentPosition(c)^4&&c.parentNode.insertBefore(f,c),c=f);return this}function qB(i){i||(i=GB);function e(M,F){return M&&F?i(M.__data__,F.__data__):!M-!F}for(var t=this._groups,r=t.length,o=new Array(r),c=0;c<r;++c){for(var f=t[c],a=f.length,y=o[c]=new Array(a),T,A=0;A<a;++A)(T=f[A])&&(y[A]=T);y.sort(e)}return new Kn(o,this._parents).order()}function GB(i,e){return i<e?-1:i>e?1:i>=e?0:NaN}function YB(){var i=arguments[0];return arguments[0]=this,i.apply(null,arguments),this}function KB(){return Array.from(this)}function JB(){for(var i=this._groups,e=0,t=i.length;e<t;++e)for(var r=i[e],o=0,c=r.length;o<c;++o){var f=r[o];if(f)return f}return null}function QB(){let i=0;for(const e of this)++i;return i}function eN(){return!this.node()}function tN(i){for(var e=this._groups,t=0,r=e.length;t<r;++t)for(var o=e[t],c=0,f=o.length,a;c<f;++c)(a=o[c])&&i.call(a,a.__data__,c,o);return this}function iN(i){return function(){this.removeAttribute(i)}}function rN(i){return function(){this.removeAttributeNS(i.space,i.local)}}function nN(i,e){return function(){this.setAttribute(i,e)}}function sN(i,e){return function(){this.setAttributeNS(i.space,i.local,e)}}function oN(i,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttribute(i):this.setAttribute(i,t)}}function aN(i,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttributeNS(i.space,i.local):this.setAttributeNS(i.space,i.local,t)}}function lN(i,e){var t=Lp(i);if(arguments.length<2){var r=this.node();return t.local?r.getAttributeNS(t.space,t.local):r.getAttribute(t)}return this.each((e==null?t.local?rN:iN:typeof e=="function"?t.local?aN:oN:t.local?sN:nN)(t,e))}function Q2(i){return i.ownerDocument&&i.ownerDocument.defaultView||i.document&&i||i.defaultView}function cN(i){return function(){this.style.removeProperty(i)}}function uN(i,e,t){return function(){this.style.setProperty(i,e,t)}}function hN(i,e,t){return function(){var r=e.apply(this,arguments);r==null?this.style.removeProperty(i):this.style.setProperty(i,r,t)}}function fN(i,e,t){return arguments.length>1?this.each((e==null?cN:typeof e=="function"?hN:uN)(i,e,t??"")):wc(this.node(),i)}function wc(i,e){return i.style.getPropertyValue(e)||Q2(i).getComputedStyle(i,null).getPropertyValue(e)}function dN(i){return function(){delete this[i]}}function pN(i,e){return function(){this[i]=e}}function gN(i,e){return function(){var t=e.apply(this,arguments);t==null?delete this[i]:this[i]=t}}function mN(i,e){return arguments.length>1?this.each((e==null?dN:typeof e=="function"?gN:pN)(i,e)):this.node()[i]}function eT(i){return i.trim().split(/^|\s+/)}function Py(i){return i.classList||new tT(i)}function tT(i){this._node=i,this._names=eT(i.getAttribute("class")||"")}tT.prototype={add:function(i){var e=this._names.indexOf(i);e<0&&(this._names.push(i),this._node.setAttribute("class",this._names.join(" ")))},remove:function(i){var e=this._names.indexOf(i);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(i){return this._names.indexOf(i)>=0}};function iT(i,e){for(var t=Py(i),r=-1,o=e.length;++r<o;)t.add(e[r])}function rT(i,e){for(var t=Py(i),r=-1,o=e.length;++r<o;)t.remove(e[r])}function _N(i){return function(){iT(this,i)}}function yN(i){return function(){rT(this,i)}}function xN(i,e){return function(){(e.apply(this,arguments)?iT:rT)(this,i)}}function vN(i,e){var t=eT(i+"");if(arguments.length<2){for(var r=Py(this.node()),o=-1,c=t.length;++o<c;)if(!r.contains(t[o]))return!1;return!0}return this.each((typeof e=="function"?xN:e?_N:yN)(t,e))}function bN(){this.textContent=""}function wN(i){return function(){this.textContent=i}}function TN(i){return function(){var e=i.apply(this,arguments);this.textContent=e??""}}function SN(i){return arguments.length?this.each(i==null?bN:(typeof i=="function"?TN:wN)(i)):this.node().textContent}function AN(){this.innerHTML=""}function PN(i){return function(){this.innerHTML=i}}function EN(i){return function(){var e=i.apply(this,arguments);this.innerHTML=e??""}}function IN(i){return arguments.length?this.each(i==null?AN:(typeof i=="function"?EN:PN)(i)):this.node().innerHTML}function CN(){this.nextSibling&&this.parentNode.appendChild(this)}function MN(){return this.each(CN)}function RN(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function kN(){return this.each(RN)}function DN(i){var e=typeof i=="function"?i:q2(i);return this.select(function(){return this.appendChild(e.apply(this,arguments))})}function ON(){return null}function FN(i,e){var t=typeof i=="function"?i:q2(i),r=e==null?ON:typeof e=="function"?e:Ay(e);return this.select(function(){return this.insertBefore(t.apply(this,arguments),r.apply(this,arguments)||null)})}function LN(){var i=this.parentNode;i&&i.removeChild(this)}function BN(){return this.each(LN)}function NN(){var i=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(i,this.nextSibling):i}function zN(){var i=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(i,this.nextSibling):i}function UN(i){return this.select(i?zN:NN)}function VN(i){return arguments.length?this.property("__data__",i):this.node().__data__}function jN(i){return function(e){i.call(this,e,this.__data__)}}function $N(i){return i.trim().split(/^|\s+/).map(function(e){var t="",r=e.indexOf(".");return r>=0&&(t=e.slice(r+1),e=e.slice(0,r)),{type:e,name:t}})}function WN(i){return function(){var e=this.__on;if(e){for(var t=0,r=-1,o=e.length,c;t<o;++t)c=e[t],(!i.type||c.type===i.type)&&c.name===i.name?this.removeEventListener(c.type,c.listener,c.options):e[++r]=c;++r?e.length=r:delete this.__on}}}function HN(i,e,t){return function(){var r=this.__on,o,c=jN(e);if(r){for(var f=0,a=r.length;f<a;++f)if((o=r[f]).type===i.type&&o.name===i.name){this.removeEventListener(o.type,o.listener,o.options),this.addEventListener(o.type,o.listener=c,o.options=t),o.value=e;return}}this.addEventListener(i.type,c,t),o={type:i.type,name:i.name,value:e,listener:c,options:t},r?r.push(o):this.__on=[o]}}function ZN(i,e,t){var r=$N(i+""),o,c=r.length,f;if(arguments.length<2){var a=this.node().__on;if(a){for(var y=0,T=a.length,A;y<T;++y)for(o=0,A=a[y];o<c;++o)if((f=r[o]).type===A.type&&f.name===A.name)return A.value}return}for(a=e?HN:WN,o=0;o<c;++o)this.each(a(r[o],e,t));return this}function nT(i,e,t){var r=Q2(i),o=r.CustomEvent;typeof o=="function"?o=new o(e,t):(o=r.document.createEvent("Event"),t?(o.initEvent(e,t.bubbles,t.cancelable),o.detail=t.detail):o.initEvent(e,!1,!1)),i.dispatchEvent(o)}function XN(i,e){return function(){return nT(this,i,e)}}function qN(i,e){return function(){return nT(this,i,e.apply(this,arguments))}}function GN(i,e){return this.each((typeof e=="function"?qN:XN)(i,e))}function*YN(){for(var i=this._groups,e=0,t=i.length;e<t;++e)for(var r=i[e],o=0,c=r.length,f;o<c;++o)(f=r[o])&&(yield f)}var KN=[null];function Kn(i,e){this._groups=i,this._parents=e}function Ah(){return new Kn([[document.documentElement]],KN)}function JN(){return this}Kn.prototype=Ah.prototype={constructor:Kn,select:TB,selectAll:EB,selectChild:RB,selectChildren:FB,filter:LB,data:jB,enter:BB,exit:WB,join:HB,merge:ZB,selection:JN,order:XB,sort:qB,call:YB,nodes:KB,node:JB,size:QB,empty:eN,each:tN,attr:lN,style:fN,property:mN,classed:vN,text:SN,html:IN,raise:MN,lower:kN,append:DN,insert:FN,remove:BN,clone:UN,datum:VN,on:ZN,dispatch:GN,[Symbol.iterator]:YN};function Ey(i,e,t){i.prototype=e.prototype=t,t.constructor=i}function sT(i,e){var t=Object.create(i.prototype);for(var r in e)t[r]=e[r];return t}function Ph(){}var gh=.7,ap=1/gh,hc="\\s*([+-]?\\d+)\\s*",mh="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",bs="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",QN=/^#([0-9a-f]{3,8})$/,ez=new RegExp(`^rgb\\(${hc},${hc},${hc}\\)$`),tz=new RegExp(`^rgb\\(${bs},${bs},${bs}\\)$`),iz=new RegExp(`^rgba\\(${hc},${hc},${hc},${mh}\\)$`),rz=new RegExp(`^rgba\\(${bs},${bs},${bs},${mh}\\)$`),nz=new RegExp(`^hsl\\(${mh},${bs},${bs}\\)$`),sz=new RegExp(`^hsla\\(${mh},${bs},${bs},${mh}\\)$`),Z0={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Ey(Ph,_h,{copy(i){return Object.assign(new this.constructor,this,i)},displayable(){return this.rgb().displayable()},hex:X0,formatHex:X0,formatHex8:oz,formatHsl:az,formatRgb:q0,toString:q0});function X0(){return this.rgb().formatHex()}function oz(){return this.rgb().formatHex8()}function az(){return oT(this).formatHsl()}function q0(){return this.rgb().formatRgb()}function _h(i){var e,t;return i=(i+"").trim().toLowerCase(),(e=QN.exec(i))?(t=e[1].length,e=parseInt(e[1],16),t===6?G0(e):t===3?new Yr(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):t===8?ud(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):t===4?ud(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=ez.exec(i))?new Yr(e[1],e[2],e[3],1):(e=tz.exec(i))?new Yr(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=iz.exec(i))?ud(e[1],e[2],e[3],e[4]):(e=rz.exec(i))?ud(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=nz.exec(i))?J0(e[1],e[2]/100,e[3]/100,1):(e=sz.exec(i))?J0(e[1],e[2]/100,e[3]/100,e[4]):Z0.hasOwnProperty(i)?G0(Z0[i]):i==="transparent"?new Yr(NaN,NaN,NaN,0):null}function G0(i){return new Yr(i>>16&255,i>>8&255,i&255,1)}function ud(i,e,t,r){return r<=0&&(i=e=t=NaN),new Yr(i,e,t,r)}function lz(i){return i instanceof Ph||(i=_h(i)),i?(i=i.rgb(),new Yr(i.r,i.g,i.b,i.opacity)):new Yr}function D_(i,e,t,r){return arguments.length===1?lz(i):new Yr(i,e,t,r??1)}function Yr(i,e,t,r){this.r=+i,this.g=+e,this.b=+t,this.opacity=+r}Ey(Yr,D_,sT(Ph,{brighter(i){return i=i==null?ap:Math.pow(ap,i),new Yr(this.r*i,this.g*i,this.b*i,this.opacity)},darker(i){return i=i==null?gh:Math.pow(gh,i),new Yr(this.r*i,this.g*i,this.b*i,this.opacity)},rgb(){return this},clamp(){return new Yr(Ha(this.r),Ha(this.g),Ha(this.b),lp(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Y0,formatHex:Y0,formatHex8:cz,formatRgb:K0,toString:K0}));function Y0(){return`#${Ua(this.r)}${Ua(this.g)}${Ua(this.b)}`}function cz(){return`#${Ua(this.r)}${Ua(this.g)}${Ua(this.b)}${Ua((isNaN(this.opacity)?1:this.opacity)*255)}`}function K0(){const i=lp(this.opacity);return`${i===1?"rgb(":"rgba("}${Ha(this.r)}, ${Ha(this.g)}, ${Ha(this.b)}${i===1?")":`, ${i})`}`}function lp(i){return isNaN(i)?1:Math.max(0,Math.min(1,i))}function Ha(i){return Math.max(0,Math.min(255,Math.round(i)||0))}function Ua(i){return i=Ha(i),(i<16?"0":"")+i.toString(16)}function J0(i,e,t,r){return r<=0?i=e=t=NaN:t<=0||t>=1?i=e=NaN:e<=0&&(i=NaN),new Xn(i,e,t,r)}function oT(i){if(i instanceof Xn)return new Xn(i.h,i.s,i.l,i.opacity);if(i instanceof Ph||(i=_h(i)),!i)return new Xn;if(i instanceof Xn)return i;i=i.rgb();var e=i.r/255,t=i.g/255,r=i.b/255,o=Math.min(e,t,r),c=Math.max(e,t,r),f=NaN,a=c-o,y=(c+o)/2;return a?(e===c?f=(t-r)/a+(t<r)*6:t===c?f=(r-e)/a+2:f=(e-t)/a+4,a/=y<.5?c+o:2-c-o,f*=60):a=y>0&&y<1?0:f,new Xn(f,a,y,i.opacity)}function uz(i,e,t,r){return arguments.length===1?oT(i):new Xn(i,e,t,r??1)}function Xn(i,e,t,r){this.h=+i,this.s=+e,this.l=+t,this.opacity=+r}Ey(Xn,uz,sT(Ph,{brighter(i){return i=i==null?ap:Math.pow(ap,i),new Xn(this.h,this.s,this.l*i,this.opacity)},darker(i){return i=i==null?gh:Math.pow(gh,i),new Xn(this.h,this.s,this.l*i,this.opacity)},rgb(){var i=this.h%360+(this.h<0)*360,e=isNaN(i)||isNaN(this.s)?0:this.s,t=this.l,r=t+(t<.5?t:1-t)*e,o=2*t-r;return new Yr(Nm(i>=240?i-240:i+120,o,r),Nm(i,o,r),Nm(i<120?i+240:i-120,o,r),this.opacity)},clamp(){return new Xn(Q0(this.h),hd(this.s),hd(this.l),lp(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const i=lp(this.opacity);return`${i===1?"hsl(":"hsla("}${Q0(this.h)}, ${hd(this.s)*100}%, ${hd(this.l)*100}%${i===1?")":`, ${i})`}`}}));function Q0(i){return i=(i||0)%360,i<0?i+360:i}function hd(i){return Math.max(0,Math.min(1,i||0))}function Nm(i,e,t){return(i<60?e+(t-e)*i/60:i<180?t:i<240?e+(t-e)*(240-i)/60:e)*255}const aT=i=>()=>i;function hz(i,e){return function(t){return i+t*e}}function fz(i,e,t){return i=Math.pow(i,t),e=Math.pow(e,t)-i,t=1/t,function(r){return Math.pow(i+r*e,t)}}function dz(i){return(i=+i)==1?lT:function(e,t){return t-e?fz(e,t,i):aT(isNaN(e)?t:e)}}function lT(i,e){var t=e-i;return t?hz(i,t):aT(isNaN(i)?e:i)}const ew=function i(e){var t=dz(e);function r(o,c){var f=t((o=D_(o)).r,(c=D_(c)).r),a=t(o.g,c.g),y=t(o.b,c.b),T=lT(o.opacity,c.opacity);return function(A){return o.r=f(A),o.g=a(A),o.b=y(A),o.opacity=T(A),o+""}}return r.gamma=i,r}(1);function Wo(i,e){return i=+i,e=+e,function(t){return i*(1-t)+e*t}}var O_=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,zm=new RegExp(O_.source,"g");function pz(i){return function(){return i}}function gz(i){return function(e){return i(e)+""}}function mz(i,e){var t=O_.lastIndex=zm.lastIndex=0,r,o,c,f=-1,a=[],y=[];for(i=i+"",e=e+"";(r=O_.exec(i))&&(o=zm.exec(e));)(c=o.index)>t&&(c=e.slice(t,c),a[f]?a[f]+=c:a[++f]=c),(r=r[0])===(o=o[0])?a[f]?a[f]+=o:a[++f]=o:(a[++f]=null,y.push({i:f,x:Wo(r,o)})),t=zm.lastIndex;return t<e.length&&(c=e.slice(t),a[f]?a[f]+=c:a[++f]=c),a.length<2?y[0]?gz(y[0].x):pz(e):(e=y.length,function(T){for(var A=0,M;A<e;++A)a[(M=y[A]).i]=M.x(T);return a.join("")})}var tw=180/Math.PI,F_={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function cT(i,e,t,r,o,c){var f,a,y;return(f=Math.sqrt(i*i+e*e))&&(i/=f,e/=f),(y=i*t+e*r)&&(t-=i*y,r-=e*y),(a=Math.sqrt(t*t+r*r))&&(t/=a,r/=a,y/=a),i*r<e*t&&(i=-i,e=-e,y=-y,f=-f),{translateX:o,translateY:c,rotate:Math.atan2(e,i)*tw,skewX:Math.atan(y)*tw,scaleX:f,scaleY:a}}var fd;function _z(i){const e=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(i+"");return e.isIdentity?F_:cT(e.a,e.b,e.c,e.d,e.e,e.f)}function yz(i){return i==null||(fd||(fd=document.createElementNS("http://www.w3.org/2000/svg","g")),fd.setAttribute("transform",i),!(i=fd.transform.baseVal.consolidate()))?F_:(i=i.matrix,cT(i.a,i.b,i.c,i.d,i.e,i.f))}function uT(i,e,t,r){function o(T){return T.length?T.pop()+" ":""}function c(T,A,M,F,L,Y){if(T!==M||A!==F){var ae=L.push("translate(",null,e,null,t);Y.push({i:ae-4,x:Wo(T,M)},{i:ae-2,x:Wo(A,F)})}else(M||F)&&L.push("translate("+M+e+F+t)}function f(T,A,M,F){T!==A?(T-A>180?A+=360:A-T>180&&(T+=360),F.push({i:M.push(o(M)+"rotate(",null,r)-2,x:Wo(T,A)})):A&&M.push(o(M)+"rotate("+A+r)}function a(T,A,M,F){T!==A?F.push({i:M.push(o(M)+"skewX(",null,r)-2,x:Wo(T,A)}):A&&M.push(o(M)+"skewX("+A+r)}function y(T,A,M,F,L,Y){if(T!==M||A!==F){var ae=L.push(o(L)+"scale(",null,",",null,")");Y.push({i:ae-4,x:Wo(T,M)},{i:ae-2,x:Wo(A,F)})}else(M!==1||F!==1)&&L.push(o(L)+"scale("+M+","+F+")")}return function(T,A){var M=[],F=[];return T=i(T),A=i(A),c(T.translateX,T.translateY,A.translateX,A.translateY,M,F),f(T.rotate,A.rotate,M,F),a(T.skewX,A.skewX,M,F),y(T.scaleX,T.scaleY,A.scaleX,A.scaleY,M,F),T=A=null,function(L){for(var Y=-1,ae=F.length,pe;++Y<ae;)M[(pe=F[Y]).i]=pe.x(L);return M.join("")}}}var xz=uT(_z,"px, ","px)","deg)"),vz=uT(yz,", ",")",")"),Tc=0,Yu=0,$u=0,hT=1e3,cp,Ku,up=0,Ga=0,Bp=0,yh=typeof performance=="object"&&performance.now?performance:Date,fT=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(i){setTimeout(i,17)};function Iy(){return Ga||(fT(bz),Ga=yh.now()+Bp)}function bz(){Ga=0}function hp(){this._call=this._time=this._next=null}hp.prototype=dT.prototype={constructor:hp,restart:function(i,e,t){if(typeof i!="function")throw new TypeError("callback is not a function");t=(t==null?Iy():+t)+(e==null?0:+e),!this._next&&Ku!==this&&(Ku?Ku._next=this:cp=this,Ku=this),this._call=i,this._time=t,L_()},stop:function(){this._call&&(this._call=null,this._time=1/0,L_())}};function dT(i,e,t){var r=new hp;return r.restart(i,e,t),r}function wz(){Iy(),++Tc;for(var i=cp,e;i;)(e=Ga-i._time)>=0&&i._call.call(void 0,e),i=i._next;--Tc}function iw(){Ga=(up=yh.now())+Bp,Tc=Yu=0;try{wz()}finally{Tc=0,Sz(),Ga=0}}function Tz(){var i=yh.now(),e=i-up;e>hT&&(Bp-=e,up=i)}function Sz(){for(var i,e=cp,t,r=1/0;e;)e._call?(r>e._time&&(r=e._time),i=e,e=e._next):(t=e._next,e._next=null,e=i?i._next=t:cp=t);Ku=i,L_(r)}function L_(i){if(!Tc){Yu&&(Yu=clearTimeout(Yu));var e=i-Ga;e>24?(i<1/0&&(Yu=setTimeout(iw,i-yh.now()-Bp)),$u&&($u=clearInterval($u))):($u||(up=yh.now(),$u=setInterval(Tz,hT)),Tc=1,fT(iw))}}function rw(i,e,t){var r=new hp;return e=e==null?0:+e,r.restart(o=>{r.stop(),i(o+e)},e,t),r}var Az=X2("start","end","cancel","interrupt"),Pz=[],pT=0,nw=1,B_=2,Ad=3,sw=4,N_=5,Pd=6;function Np(i,e,t,r,o,c){var f=i.__transition;if(!f)i.__transition={};else if(t in f)return;Ez(i,t,{name:e,index:r,group:o,on:Az,tween:Pz,time:c.time,delay:c.delay,duration:c.duration,ease:c.ease,timer:null,state:pT})}function Cy(i,e){var t=Jn(i,e);if(t.state>pT)throw new Error("too late; already scheduled");return t}function Ps(i,e){var t=Jn(i,e);if(t.state>Ad)throw new Error("too late; already running");return t}function Jn(i,e){var t=i.__transition;if(!t||!(t=t[e]))throw new Error("transition not found");return t}function Ez(i,e,t){var r=i.__transition,o;r[e]=t,t.timer=dT(c,0,t.time);function c(T){t.state=nw,t.timer.restart(f,t.delay,t.time),t.delay<=T&&f(T-t.delay)}function f(T){var A,M,F,L;if(t.state!==nw)return y();for(A in r)if(L=r[A],L.name===t.name){if(L.state===Ad)return rw(f);L.state===sw?(L.state=Pd,L.timer.stop(),L.on.call("interrupt",i,i.__data__,L.index,L.group),delete r[A]):+A<e&&(L.state=Pd,L.timer.stop(),L.on.call("cancel",i,i.__data__,L.index,L.group),delete r[A])}if(rw(function(){t.state===Ad&&(t.state=sw,t.timer.restart(a,t.delay,t.time),a(T))}),t.state=B_,t.on.call("start",i,i.__data__,t.index,t.group),t.state===B_){for(t.state=Ad,o=new Array(F=t.tween.length),A=0,M=-1;A<F;++A)(L=t.tween[A].value.call(i,i.__data__,t.index,t.group))&&(o[++M]=L);o.length=M+1}}function a(T){for(var A=T<t.duration?t.ease.call(null,T/t.duration):(t.timer.restart(y),t.state=N_,1),M=-1,F=o.length;++M<F;)o[M].call(i,A);t.state===N_&&(t.on.call("end",i,i.__data__,t.index,t.group),y())}function y(){t.state=Pd,t.timer.stop(),delete r[e];for(var T in r)return;delete i.__transition}}function Iz(i,e){var t=i.__transition,r,o,c=!0,f;if(t){e=e==null?null:e+"";for(f in t){if((r=t[f]).name!==e){c=!1;continue}o=r.state>B_&&r.state<N_,r.state=Pd,r.timer.stop(),r.on.call(o?"interrupt":"cancel",i,i.__data__,r.index,r.group),delete t[f]}c&&delete i.__transition}}function Cz(i){return this.each(function(){Iz(this,i)})}function Mz(i,e){var t,r;return function(){var o=Ps(this,i),c=o.tween;if(c!==t){r=t=c;for(var f=0,a=r.length;f<a;++f)if(r[f].name===e){r=r.slice(),r.splice(f,1);break}}o.tween=r}}function Rz(i,e,t){var r,o;if(typeof t!="function")throw new Error;return function(){var c=Ps(this,i),f=c.tween;if(f!==r){o=(r=f).slice();for(var a={name:e,value:t},y=0,T=o.length;y<T;++y)if(o[y].name===e){o[y]=a;break}y===T&&o.push(a)}c.tween=o}}function kz(i,e){var t=this._id;if(i+="",arguments.length<2){for(var r=Jn(this.node(),t).tween,o=0,c=r.length,f;o<c;++o)if((f=r[o]).name===i)return f.value;return null}return this.each((e==null?Mz:Rz)(t,i,e))}function My(i,e,t){var r=i._id;return i.each(function(){var o=Ps(this,r);(o.value||(o.value={}))[e]=t.apply(this,arguments)}),function(o){return Jn(o,r).value[e]}}function gT(i,e){var t;return(typeof e=="number"?Wo:e instanceof _h?ew:(t=_h(e))?(e=t,ew):mz)(i,e)}function Dz(i){return function(){this.removeAttribute(i)}}function Oz(i){return function(){this.removeAttributeNS(i.space,i.local)}}function Fz(i,e,t){var r,o=t+"",c;return function(){var f=this.getAttribute(i);return f===o?null:f===r?c:c=e(r=f,t)}}function Lz(i,e,t){var r,o=t+"",c;return function(){var f=this.getAttributeNS(i.space,i.local);return f===o?null:f===r?c:c=e(r=f,t)}}function Bz(i,e,t){var r,o,c;return function(){var f,a=t(this),y;return a==null?void this.removeAttribute(i):(f=this.getAttribute(i),y=a+"",f===y?null:f===r&&y===o?c:(o=y,c=e(r=f,a)))}}function Nz(i,e,t){var r,o,c;return function(){var f,a=t(this),y;return a==null?void this.removeAttributeNS(i.space,i.local):(f=this.getAttributeNS(i.space,i.local),y=a+"",f===y?null:f===r&&y===o?c:(o=y,c=e(r=f,a)))}}function zz(i,e){var t=Lp(i),r=t==="transform"?vz:gT;return this.attrTween(i,typeof e=="function"?(t.local?Nz:Bz)(t,r,My(this,"attr."+i,e)):e==null?(t.local?Oz:Dz)(t):(t.local?Lz:Fz)(t,r,e))}function Uz(i,e){return function(t){this.setAttribute(i,e.call(this,t))}}function Vz(i,e){return function(t){this.setAttributeNS(i.space,i.local,e.call(this,t))}}function jz(i,e){var t,r;function o(){var c=e.apply(this,arguments);return c!==r&&(t=(r=c)&&Vz(i,c)),t}return o._value=e,o}function $z(i,e){var t,r;function o(){var c=e.apply(this,arguments);return c!==r&&(t=(r=c)&&Uz(i,c)),t}return o._value=e,o}function Wz(i,e){var t="attr."+i;if(arguments.length<2)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;var r=Lp(i);return this.tween(t,(r.local?jz:$z)(r,e))}function Hz(i,e){return function(){Cy(this,i).delay=+e.apply(this,arguments)}}function Zz(i,e){return e=+e,function(){Cy(this,i).delay=e}}function Xz(i){var e=this._id;return arguments.length?this.each((typeof i=="function"?Hz:Zz)(e,i)):Jn(this.node(),e).delay}function qz(i,e){return function(){Ps(this,i).duration=+e.apply(this,arguments)}}function Gz(i,e){return e=+e,function(){Ps(this,i).duration=e}}function Yz(i){var e=this._id;return arguments.length?this.each((typeof i=="function"?qz:Gz)(e,i)):Jn(this.node(),e).duration}function Kz(i,e){if(typeof e!="function")throw new Error;return function(){Ps(this,i).ease=e}}function Jz(i){var e=this._id;return arguments.length?this.each(Kz(e,i)):Jn(this.node(),e).ease}function Qz(i,e){return function(){var t=e.apply(this,arguments);if(typeof t!="function")throw new Error;Ps(this,i).ease=t}}function e6(i){if(typeof i!="function")throw new Error;return this.each(Qz(this._id,i))}function t6(i){typeof i!="function"&&(i=Y2(i));for(var e=this._groups,t=e.length,r=new Array(t),o=0;o<t;++o)for(var c=e[o],f=c.length,a=r[o]=[],y,T=0;T<f;++T)(y=c[T])&&i.call(y,y.__data__,T,c)&&a.push(y);return new Qs(r,this._parents,this._name,this._id)}function i6(i){if(i._id!==this._id)throw new Error;for(var e=this._groups,t=i._groups,r=e.length,o=t.length,c=Math.min(r,o),f=new Array(r),a=0;a<c;++a)for(var y=e[a],T=t[a],A=y.length,M=f[a]=new Array(A),F,L=0;L<A;++L)(F=y[L]||T[L])&&(M[L]=F);for(;a<r;++a)f[a]=e[a];return new Qs(f,this._parents,this._name,this._id)}function r6(i){return(i+"").trim().split(/^|\s+/).every(function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||e==="start"})}function n6(i,e,t){var r,o,c=r6(e)?Cy:Ps;return function(){var f=c(this,i),a=f.on;a!==r&&(o=(r=a).copy()).on(e,t),f.on=o}}function s6(i,e){var t=this._id;return arguments.length<2?Jn(this.node(),t).on.on(i):this.each(n6(t,i,e))}function o6(i){return function(){var e=this.parentNode;for(var t in this.__transition)if(+t!==i)return;e&&e.removeChild(this)}}function a6(){return this.on("end.remove",o6(this._id))}function l6(i){var e=this._name,t=this._id;typeof i!="function"&&(i=Ay(i));for(var r=this._groups,o=r.length,c=new Array(o),f=0;f<o;++f)for(var a=r[f],y=a.length,T=c[f]=new Array(y),A,M,F=0;F<y;++F)(A=a[F])&&(M=i.call(A,A.__data__,F,a))&&("__data__"in A&&(M.__data__=A.__data__),T[F]=M,Np(T[F],e,t,F,T,Jn(A,t)));return new Qs(c,this._parents,e,t)}function c6(i){var e=this._name,t=this._id;typeof i!="function"&&(i=G2(i));for(var r=this._groups,o=r.length,c=[],f=[],a=0;a<o;++a)for(var y=r[a],T=y.length,A,M=0;M<T;++M)if(A=y[M]){for(var F=i.call(A,A.__data__,M,y),L,Y=Jn(A,t),ae=0,pe=F.length;ae<pe;++ae)(L=F[ae])&&Np(L,e,t,ae,F,Y);c.push(F),f.push(A)}return new Qs(c,f,e,t)}var u6=Ah.prototype.constructor;function h6(){return new u6(this._groups,this._parents)}function f6(i,e){var t,r,o;return function(){var c=wc(this,i),f=(this.style.removeProperty(i),wc(this,i));return c===f?null:c===t&&f===r?o:o=e(t=c,r=f)}}function mT(i){return function(){this.style.removeProperty(i)}}function d6(i,e,t){var r,o=t+"",c;return function(){var f=wc(this,i);return f===o?null:f===r?c:c=e(r=f,t)}}function p6(i,e,t){var r,o,c;return function(){var f=wc(this,i),a=t(this),y=a+"";return a==null&&(y=a=(this.style.removeProperty(i),wc(this,i))),f===y?null:f===r&&y===o?c:(o=y,c=e(r=f,a))}}function g6(i,e){var t,r,o,c="style."+e,f="end."+c,a;return function(){var y=Ps(this,i),T=y.on,A=y.value[c]==null?a||(a=mT(e)):void 0;(T!==t||o!==A)&&(r=(t=T).copy()).on(f,o=A),y.on=r}}function m6(i,e,t){var r=(i+="")=="transform"?xz:gT;return e==null?this.styleTween(i,f6(i,r)).on("end.style."+i,mT(i)):typeof e=="function"?this.styleTween(i,p6(i,r,My(this,"style."+i,e))).each(g6(this._id,i)):this.styleTween(i,d6(i,r,e),t).on("end.style."+i,null)}function _6(i,e,t){return function(r){this.style.setProperty(i,e.call(this,r),t)}}function y6(i,e,t){var r,o;function c(){var f=e.apply(this,arguments);return f!==o&&(r=(o=f)&&_6(i,f,t)),r}return c._value=e,c}function x6(i,e,t){var r="style."+(i+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(e==null)return this.tween(r,null);if(typeof e!="function")throw new Error;return this.tween(r,y6(i,e,t??""))}function v6(i){return function(){this.textContent=i}}function b6(i){return function(){var e=i(this);this.textContent=e??""}}function w6(i){return this.tween("text",typeof i=="function"?b6(My(this,"text",i)):v6(i==null?"":i+""))}function T6(i){return function(e){this.textContent=i.call(this,e)}}function S6(i){var e,t;function r(){var o=i.apply(this,arguments);return o!==t&&(e=(t=o)&&T6(o)),e}return r._value=i,r}function A6(i){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(i==null)return this.tween(e,null);if(typeof i!="function")throw new Error;return this.tween(e,S6(i))}function P6(){for(var i=this._name,e=this._id,t=_T(),r=this._groups,o=r.length,c=0;c<o;++c)for(var f=r[c],a=f.length,y,T=0;T<a;++T)if(y=f[T]){var A=Jn(y,e);Np(y,i,t,T,f,{time:A.time+A.delay+A.duration,delay:0,duration:A.duration,ease:A.ease})}return new Qs(r,this._parents,i,t)}function E6(){var i,e,t=this,r=t._id,o=t.size();return new Promise(function(c,f){var a={value:f},y={value:function(){--o===0&&c()}};t.each(function(){var T=Ps(this,r),A=T.on;A!==i&&(e=(i=A).copy(),e._.cancel.push(a),e._.interrupt.push(a),e._.end.push(y)),T.on=e}),o===0&&c()})}var I6=0;function Qs(i,e,t,r){this._groups=i,this._parents=e,this._name=t,this._id=r}function _T(){return++I6}var qs=Ah.prototype;Qs.prototype={constructor:Qs,select:l6,selectAll:c6,selectChild:qs.selectChild,selectChildren:qs.selectChildren,filter:t6,merge:i6,selection:h6,transition:P6,call:qs.call,nodes:qs.nodes,node:qs.node,size:qs.size,empty:qs.empty,each:qs.each,on:s6,attr:zz,attrTween:Wz,style:m6,styleTween:x6,text:w6,textTween:A6,remove:a6,tween:kz,delay:Xz,duration:Yz,ease:Jz,easeVarying:e6,end:E6,[Symbol.iterator]:qs[Symbol.iterator]};function C6(i){return((i*=2)<=1?i*i*i:(i-=2)*i*i+2)/2}var M6={time:null,delay:0,duration:250,ease:C6};function R6(i,e){for(var t;!(t=i.__transition)||!(t=t[e]);)if(!(i=i.parentNode))throw new Error(`transition ${e} not found`);return t}function k6(i){var e,t;i instanceof Qs?(e=i._id,i=i._name):(e=_T(),(t=M6).time=Iy(),i=i==null?null:i+"");for(var r=this._groups,o=r.length,c=0;c<o;++c)for(var f=r[c],a=f.length,y,T=0;T<a;++T)(y=f[T])&&Np(y,i,e,T,f,t||R6(y,e));return new Qs(r,this._parents,i,e)}Ah.prototype.interrupt=Cz;Ah.prototype.transition=k6;function D6(i,e){switch(arguments.length){case 0:break;case 1:this.range(i);break;default:this.range(e).domain(i);break}return this}function yT(){var i=[],e=[],t=[],r;function o(){var f=0,a=Math.max(1,e.length);for(t=new Array(a-1);++f<a;)t[f-1]=mB(i,f/a);return c}function c(f){return f==null||isNaN(f=+f)?r:e[gB(t,f)]}return c.invertExtent=function(f){var a=e.indexOf(f);return a<0?[NaN,NaN]:[a>0?t[a-1]:i[0],a<t.length?t[a]:i[i.length-1]]},c.domain=function(f){if(!arguments.length)return i.slice();i=[];for(let a of f)a!=null&&!isNaN(a=+a)&&i.push(a);return i.sort(oh),o()},c.range=function(f){return arguments.length?(e=Array.from(f),o()):e.slice()},c.unknown=function(f){return arguments.length?(r=f,c):r},c.quantiles=function(){return t.slice()},c.copy=function(){return yT().domain(i).range(e).unknown(r)},D6.apply(c,arguments)}function Ju(i,e,t){this.k=i,this.x=e,this.y=t}Ju.prototype={constructor:Ju,scale:function(i){return i===1?this:new Ju(this.k*i,this.x,this.y)},translate:function(i,e){return i===0&e===0?this:new Ju(this.k,this.x+this.k*i,this.y+this.k*e)},apply:function(i){return[i[0]*this.k+this.x,i[1]*this.k+this.y]},applyX:function(i){return i*this.k+this.x},applyY:function(i){return i*this.k+this.y},invert:function(i){return[(i[0]-this.x)/this.k,(i[1]-this.y)/this.k]},invertX:function(i){return(i-this.x)/this.k},invertY:function(i){return(i-this.y)/this.k},rescaleX:function(i){return i.copy().domain(i.range().map(this.invertX,this).map(i.invert,i))},rescaleY:function(i){return i.copy().domain(i.range().map(this.invertY,this).map(i.invert,i))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};Ju.prototype;var Ed={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.3.0/LICENSE.txt
 */var O6=Ed.exports,ow;function F6(){return ow||(ow=1,function(i,e){(function(t,r){i.exports=r()})(O6,function(){var t={},r={};function o(f,a,y){if(r[f]=y,f==="index"){var T="var sharedModule = {}; ("+r.shared+")(sharedModule); ("+r.worker+")(sharedModule);",A={};return r.shared(A),r.index(t,A),typeof window<"u"&&t.setWorkerUrl(window.URL.createObjectURL(new Blob([T],{type:"text/javascript"}))),t}}o("shared",["exports"],function(f){function a(u,s,h,d){return new(h||(h=Promise))(function(m,v){function b(C){try{E(d.next(C))}catch(k){v(k)}}function S(C){try{E(d.throw(C))}catch(k){v(k)}}function E(C){var k;C.done?m(C.value):(k=C.value,k instanceof h?k:new h(function(D){D(k)})).then(b,S)}E((d=d.apply(u,s||[])).next())})}function y(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var T,A;function M(){if(A)return T;function u(s,h){this.x=s,this.y=h}return A=1,T=u,u.prototype={clone:function(){return new u(this.x,this.y)},add:function(s){return this.clone()._add(s)},sub:function(s){return this.clone()._sub(s)},multByPoint:function(s){return this.clone()._multByPoint(s)},divByPoint:function(s){return this.clone()._divByPoint(s)},mult:function(s){return this.clone()._mult(s)},div:function(s){return this.clone()._div(s)},rotate:function(s){return this.clone()._rotate(s)},rotateAround:function(s,h){return this.clone()._rotateAround(s,h)},matMult:function(s){return this.clone()._matMult(s)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(s){return this.x===s.x&&this.y===s.y},dist:function(s){return Math.sqrt(this.distSqr(s))},distSqr:function(s){var h=s.x-this.x,d=s.y-this.y;return h*h+d*d},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith:function(s){return this.angleWithSep(s.x,s.y)},angleWithSep:function(s,h){return Math.atan2(this.x*h-this.y*s,this.x*s+this.y*h)},_matMult:function(s){var h=s[2]*this.x+s[3]*this.y;return this.x=s[0]*this.x+s[1]*this.y,this.y=h,this},_add:function(s){return this.x+=s.x,this.y+=s.y,this},_sub:function(s){return this.x-=s.x,this.y-=s.y,this},_mult:function(s){return this.x*=s,this.y*=s,this},_div:function(s){return this.x/=s,this.y/=s,this},_multByPoint:function(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint:function(s){return this.x/=s.x,this.y/=s.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var s=this.y;return this.y=this.x,this.x=-s,this},_rotate:function(s){var h=Math.cos(s),d=Math.sin(s),m=d*this.x+h*this.y;return this.x=h*this.x-d*this.y,this.y=m,this},_rotateAround:function(s,h){var d=Math.cos(s),m=Math.sin(s),v=h.y+m*(this.x-h.x)+d*(this.y-h.y);return this.x=h.x+d*(this.x-h.x)-m*(this.y-h.y),this.y=v,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},u.convert=function(s){return s instanceof u?s:Array.isArray(s)?new u(s[0],s[1]):s},T}typeof SuppressedError=="function"&&SuppressedError;var F,L,Y=y(M()),ae=function(){if(L)return F;function u(s,h,d,m){this.cx=3*s,this.bx=3*(d-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*h,this.by=3*(m-h)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=h,this.p2x=d,this.p2y=m}return L=1,F=u,u.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,h){if(h===void 0&&(h=1e-6),s<0)return 0;if(s>1)return 1;for(var d=s,m=0;m<8;m++){var v=this.sampleCurveX(d)-s;if(Math.abs(v)<h)return d;var b=this.sampleCurveDerivativeX(d);if(Math.abs(b)<1e-6)break;d-=v/b}var S=0,E=1;for(d=s,m=0;m<20&&(v=this.sampleCurveX(d),!(Math.abs(v-s)<h));m++)s>v?S=d:E=d,d=.5*(E-S)+S;return d},solve:function(s,h){return this.sampleCurveY(this.solveCurveX(s,h))}},F}(),pe=y(ae);let Ee,Be;function xe(){return Ee==null&&(Ee=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),Ee}function Ce(){if(Be==null&&(Be=!1,xe())){const s=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(s){for(let d=0;d<5*5;d++){const m=4*d;s.fillStyle=`rgb(${m},${m+1},${m+2})`,s.fillRect(d%5,Math.floor(d/5),1,1)}const h=s.getImageData(0,0,5,5).data;for(let d=0;d<5*5*4;d++)if(d%4!=3&&h[d]!==d){Be=!0;break}}}return Be||!1}var tt,Xe=1e-6,gt=typeof Float32Array<"u"?Float32Array:Array;function ft(){var u=new gt(9);return gt!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[5]=0,u[6]=0,u[7]=0),u[0]=1,u[4]=1,u[8]=1,u}function yt(u){return u[0]=1,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=1,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u}function Bt(){var u=new gt(3);return gt!=Float32Array&&(u[0]=0,u[1]=0,u[2]=0),u}function Pt(u,s,h){var d=new gt(3);return d[0]=u,d[1]=s,d[2]=h,d}function Lt(u,s,h){var d=s[0],m=s[1],v=s[2],b=s[3];return u[0]=h[0]*d+h[4]*m+h[8]*v+h[12]*b,u[1]=h[1]*d+h[5]*m+h[9]*v+h[13]*b,u[2]=h[2]*d+h[6]*m+h[10]*v+h[14]*b,u[3]=h[3]*d+h[7]*m+h[11]*v+h[15]*b,u}function Dt(){var u=new gt(4);return gt!=Float32Array&&(u[0]=0,u[1]=0,u[2]=0),u[3]=1,u}function kt(){var u=new gt(2);return gt!=Float32Array&&(u[0]=0,u[1]=0),u}function ji(u,s){var h=new gt(2);return h[0]=u,h[1]=s,h}Math.hypot||(Math.hypot=function(){for(var u=0,s=arguments.length;s--;)u+=arguments[s]*arguments[s];return Math.sqrt(u)}),Bt(),tt=new gt(4),gt!=Float32Array&&(tt[0]=0,tt[1]=0,tt[2]=0,tt[3]=0),Bt(),Pt(1,0,0),Pt(0,1,0),Dt(),Dt(),ft(),kt();const he=8192;function Le(u,s,h){return s*(he/(u.tileSize*Math.pow(2,h-u.tileID.overscaledZ)))}function we(u,s){return(u%s+s)%s}function Ke(u,s,h){return u*(1-h)+s*h}function Qe(u){if(u<=0)return 0;if(u>=1)return 1;const s=u*u,h=s*u;return 4*(u<.5?h:3*(u-s)+h-.75)}function st(u,s,h,d){const m=new pe(u,s,h,d);return v=>m.solve(v)}const rt=st(.25,.1,.25,1);function pt(u,s,h){return Math.min(h,Math.max(s,u))}function Ct(u,s,h){const d=h-s,m=((u-s)%d+d)%d+s;return m===s?h:m}function Tt(u,...s){for(const h of s)for(const d in h)u[d]=h[d];return u}let ai=1;function ei(u,s,h){const d={};for(const m in u)d[m]=s.call(this,u[m],m,u);return d}function Xt(u,s,h){const d={};for(const m in u)s.call(this,u[m],m,u)&&(d[m]=u[m]);return d}function li(u){return Array.isArray(u)?u.map(li):typeof u=="object"&&u?ei(u,li):u}const si={};function Li(u){si[u]||(typeof console<"u"&&console.warn(u),si[u]=!0)}function Ti(u,s,h){return(h.y-u.y)*(s.x-u.x)>(s.y-u.y)*(h.x-u.x)}function Hr(u){return typeof WorkerGlobalScope<"u"&&u!==void 0&&u instanceof WorkerGlobalScope}let Si=null;function qt(u){return typeof ImageBitmap<"u"&&u instanceof ImageBitmap}const Gt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function Kr(u,s,h,d,m){return a(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const v=new VideoFrame(u,{timestamp:0});try{const b=v==null?void 0:v.format;if(!b||!b.startsWith("BGR")&&!b.startsWith("RGB"))throw new Error(`Unrecognized format ${b}`);const S=b.startsWith("BGR"),E=new Uint8ClampedArray(d*m*4);if(yield v.copyTo(E,function(C,k,D,z,V){const $=4*Math.max(1,0),H=(Math.max(0,D)-D)*z*4+$,J=4*z,re=Math.max(0,k),me=Math.max(0,D);return{rect:{x:re,y:me,width:Math.min(C.width,k+z)-re,height:Math.min(C.height,D+V)-me},layout:[{offset:H,stride:J}]}}(u,s,h,d,m)),S)for(let C=0;C<E.length;C+=4){const k=E[C];E[C]=E[C+2],E[C+2]=k}return E}finally{v.close()}})}let Qn,es;function Jr(u,s,h,d){return u.addEventListener(s,h,d),{unsubscribe:()=>{u.removeEventListener(s,h,d)}}}function Qr(u){return u/Math.PI*180}const to={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},io={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},ta="AbortError";function Es(){return new Error(ta)}const ts={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function ro(u){return ts.REGISTERED_PROTOCOLS[u.substring(0,u.indexOf("://"))]}const Cn="global-dispatcher";class dn extends Error{constructor(s,h,d,m){super(`AJAXError: ${h} (${s}): ${d}`),this.status=s,this.statusText=h,this.url=d,this.body=m}}const Mn=()=>Hr(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,no=function(u,s){if(/:\/\//.test(u.url)&&!/^https?:|^file:/.test(u.url)){const d=ro(u.url);if(d)return d(u,s);if(Hr(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:u,targetMapId:Cn},s)}if(!(/^file:/.test(h=u.url)||/^file:/.test(Mn())&&!/^\w+:/.test(h))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(d,m){return a(this,void 0,void 0,function*(){const v=new Request(d.url,{method:d.method||"GET",body:d.body,credentials:d.credentials,headers:d.headers,cache:d.cache,referrer:Mn(),signal:m.signal});let b,S;d.type!=="json"||v.headers.has("Accept")||v.headers.set("Accept","application/json");try{b=yield fetch(v)}catch(C){throw new dn(0,C.message,d.url,new Blob)}if(!b.ok){const C=yield b.blob();throw new dn(b.status,b.statusText,d.url,C)}S=d.type==="arrayBuffer"||d.type==="image"?b.arrayBuffer():d.type==="json"?b.json():b.text();const E=yield S;if(m.signal.aborted)throw Es();return{data:E,cacheControl:b.headers.get("Cache-Control"),expires:b.headers.get("Expires")}})}(u,s);if(Hr(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:u,mustQueue:!0,targetMapId:Cn},s)}var h;return function(d,m){return new Promise((v,b)=>{var S;const E=new XMLHttpRequest;E.open(d.method||"GET",d.url,!0),d.type!=="arrayBuffer"&&d.type!=="image"||(E.responseType="arraybuffer");for(const C in d.headers)E.setRequestHeader(C,d.headers[C]);d.type==="json"&&(E.responseType="text",!((S=d.headers)===null||S===void 0)&&S.Accept||E.setRequestHeader("Accept","application/json")),E.withCredentials=d.credentials==="include",E.onerror=()=>{b(new Error(E.statusText))},E.onload=()=>{if(!m.signal.aborted)if((E.status>=200&&E.status<300||E.status===0)&&E.response!==null){let C=E.response;if(d.type==="json")try{C=JSON.parse(E.response)}catch(k){return void b(k)}v({data:C,cacheControl:E.getResponseHeader("Cache-Control"),expires:E.getResponseHeader("Expires")})}else{const C=new Blob([E.response],{type:E.getResponseHeader("Content-Type")});b(new dn(E.status,E.statusText,d.url,C))}},m.signal.addEventListener("abort",()=>{E.abort(),b(Es())}),E.send(d.body)})}(u,s)};function ia(u){if(!u||u.indexOf("://")<=0||u.indexOf("data:image/")===0||u.indexOf("blob:")===0)return!0;const s=new URL(u),h=window.location;return s.protocol===h.protocol&&s.host===h.host}function Qa(u,s,h){h[u]&&h[u].indexOf(s)!==-1||(h[u]=h[u]||[],h[u].push(s))}function Rn(u,s,h){if(h&&h[u]){const d=h[u].indexOf(s);d!==-1&&h[u].splice(d,1)}}class Pe{constructor(s,h={}){Tt(this,h),this.type=s}}class Z extends Pe{constructor(s,h={}){super("error",Tt({error:s},h))}}class q{on(s,h){return this._listeners=this._listeners||{},Qa(s,h,this._listeners),{unsubscribe:()=>{this.off(s,h)}}}off(s,h){return Rn(s,h,this._listeners),Rn(s,h,this._oneTimeListeners),this}once(s,h){return h?(this._oneTimeListeners=this._oneTimeListeners||{},Qa(s,h,this._oneTimeListeners),this):new Promise(d=>this.once(s,d))}fire(s,h){typeof s=="string"&&(s=new Pe(s,h||{}));const d=s.type;if(this.listens(d)){s.target=this;const m=this._listeners&&this._listeners[d]?this._listeners[d].slice():[];for(const S of m)S.call(this,s);const v=this._oneTimeListeners&&this._oneTimeListeners[d]?this._oneTimeListeners[d].slice():[];for(const S of v)Rn(d,S,this._oneTimeListeners),S.call(this,s);const b=this._eventedParent;b&&(Tt(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),b.fire(s))}else s instanceof Z&&console.error(s.error);return this}listens(s){return this._listeners&&this._listeners[s]&&this._listeners[s].length>0||this._oneTimeListeners&&this._oneTimeListeners[s]&&this._oneTimeListeners[s].length>0||this._eventedParent&&this._eventedParent.listens(s)}setEventedParent(s,h){return this._eventedParent=s,this._eventedParentData=h,this}}var j={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const le=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function ye(u,s){const h={};for(const d in u)d!=="ref"&&(h[d]=u[d]);return le.forEach(d=>{d in s&&(h[d]=s[d])}),h}function _e(u,s){if(Array.isArray(u)){if(!Array.isArray(s)||u.length!==s.length)return!1;for(let h=0;h<u.length;h++)if(!_e(u[h],s[h]))return!1;return!0}if(typeof u=="object"&&u!==null&&s!==null){if(typeof s!="object"||Object.keys(u).length!==Object.keys(s).length)return!1;for(const h in u)if(!_e(u[h],s[h]))return!1;return!0}return u===s}function Re(u,s){u.push(s)}function be(u,s,h){Re(h,{command:"addSource",args:[u,s[u]]})}function $e(u,s,h){Re(s,{command:"removeSource",args:[u]}),h[u]=!0}function ze(u,s,h,d){$e(u,h,d),be(u,s,h)}function Ie(u,s,h){let d;for(d in u[h])if(Object.prototype.hasOwnProperty.call(u[h],d)&&d!=="data"&&!_e(u[h][d],s[h][d]))return!1;for(d in s[h])if(Object.prototype.hasOwnProperty.call(s[h],d)&&d!=="data"&&!_e(u[h][d],s[h][d]))return!1;return!0}function Ge(u,s,h,d,m,v){u=u||{},s=s||{};for(const b in u)Object.prototype.hasOwnProperty.call(u,b)&&(_e(u[b],s[b])||h.push({command:v,args:[d,b,s[b],m]}));for(const b in s)Object.prototype.hasOwnProperty.call(s,b)&&!Object.prototype.hasOwnProperty.call(u,b)&&(_e(u[b],s[b])||h.push({command:v,args:[d,b,s[b],m]}))}function ht(u){return u.id}function dt(u,s){return u[s.id]=s,u}class Ue{constructor(s,h,d,m){this.message=(s?`${s}: `:"")+d,m&&(this.identifier=m),h!=null&&h.__line__&&(this.line=h.__line__)}}function Ft(u,...s){for(const h of s)for(const d in h)u[d]=h[d];return u}class Et extends Error{constructor(s,h){super(h),this.message=h,this.key=s}}class Ot{constructor(s,h=[]){this.parent=s,this.bindings={};for(const[d,m]of h)this.bindings[d]=m}concat(s){return new Ot(this,s)}get(s){if(this.bindings[s])return this.bindings[s];if(this.parent)return this.parent.get(s);throw new Error(`${s} not found in scope.`)}has(s){return!!this.bindings[s]||!!this.parent&&this.parent.has(s)}}const Kt={kind:"null"},et={kind:"number"},vt={kind:"string"},ct={kind:"boolean"},zt={kind:"color"},Mi={kind:"projectionDefinition"},kn={kind:"object"},Rt={kind:"value"},Gi={kind:"collator"},mi={kind:"formatted"},el={kind:"padding"},so={kind:"resolvedImage"},is={kind:"variableAnchorOffsetCollection"};function Ir(u,s){return{kind:"array",itemType:u,N:s}}function Ii(u){if(u.kind==="array"){const s=Ii(u.itemType);return typeof u.N=="number"?`array<${s}, ${u.N}>`:u.itemType.kind==="value"?"array":`array<${s}>`}return u.kind}const zp=[Kt,et,vt,ct,zt,Mi,mi,kn,Ir(Rt),el,so,is];function oo(u,s){if(s.kind==="error")return null;if(u.kind==="array"){if(s.kind==="array"&&(s.N===0&&s.itemType.kind==="value"||!oo(u.itemType,s.itemType))&&(typeof u.N!="number"||u.N===s.N))return null}else{if(u.kind===s.kind)return null;if(u.kind==="value"){for(const h of zp)if(!oo(h,s))return null}}return`Expected ${Ii(u)} but found ${Ii(s)} instead.`}function Ec(u,s){return s.some(h=>h.kind===u.kind)}function rs(u,s){return s.some(h=>h==="null"?u===null:h==="array"?Array.isArray(u):h==="object"?u&&!Array.isArray(u)&&typeof u=="object":h===typeof u)}function ao(u,s){return u.kind==="array"&&s.kind==="array"?u.itemType.kind===s.itemType.kind&&typeof u.N=="number":u.kind===s.kind}const Eh=.96422,Ih=.82521,Ch=4/29,lo=6/29,Mh=3*lo*lo,Up=lo*lo*lo,Rh=Math.PI/180,ra=180/Math.PI;function kh(u){return(u%=360)<0&&(u+=360),u}function Dh([u,s,h,d]){let m,v;const b=Ic((.2225045*(u=Is(u))+.7168786*(s=Is(s))+.0606169*(h=Is(h)))/1);u===s&&s===h?m=v=b:(m=Ic((.4360747*u+.3850649*s+.1430804*h)/Eh),v=Ic((.0139322*u+.0971045*s+.7141733*h)/Ih));const S=116*b-16;return[S<0?0:S,500*(m-b),200*(b-v),d]}function Is(u){return u<=.04045?u/12.92:Math.pow((u+.055)/1.055,2.4)}function Ic(u){return u>Up?Math.pow(u,1/3):u/Mh+Ch}function Oh([u,s,h,d]){let m=(u+16)/116,v=isNaN(s)?m:m+s/500,b=isNaN(h)?m:m-h/200;return m=1*tl(m),v=Eh*tl(v),b=Ih*tl(b),[Cc(3.1338561*v-1.6168667*m-.4906146*b),Cc(-.9787684*v+1.9161415*m+.033454*b),Cc(.0719453*v-.2289914*m+1.4052427*b),d]}function Cc(u){return(u=u<=.00304?12.92*u:1.055*Math.pow(u,1/2.4)-.055)<0?0:u>1?1:u}function tl(u){return u>lo?u*u*u:Mh*(u-Ch)}function na(u){return parseInt(u.padEnd(2,u),16)/255}function en(u,s){return Wt(s?u/100:u,0,1)}function Wt(u,s,h){return Math.min(Math.max(s,u),h)}function Cs(u){return!u.some(Number.isNaN)}const ns={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function Dn(u,s,h){return u+h*(s-u)}function co(u,s,h){return u.map((d,m)=>Dn(d,s[m],h))}class Jt{constructor(s,h,d,m=1,v=!0){this.r=s,this.g=h,this.b=d,this.a=m,v||(this.r*=m,this.g*=m,this.b*=m,m||this.overwriteGetter("rgb",[s,h,d,m]))}static parse(s){if(s instanceof Jt)return s;if(typeof s!="string")return;const h=function(d){if((d=d.toLowerCase().trim())==="transparent")return[0,0,0,0];const m=ns[d];if(m){const[b,S,E]=m;return[b/255,S/255,E/255,1]}if(d.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(d)){const b=d.length<6?1:2;let S=1;return[na(d.slice(S,S+=b)),na(d.slice(S,S+=b)),na(d.slice(S,S+=b)),na(d.slice(S,S+b)||"ff")]}if(d.startsWith("rgb")){const b=d.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(b){const[S,E,C,k,D,z,V,$,H,J,re,me]=b,oe=[k||" ",V||" ",J].join("");if(oe==="  "||oe==="  /"||oe===",,"||oe===",,,"){const U=[C,z,H].join(""),K=U==="%%%"?100:U===""?255:0;if(K){const ce=[Wt(+E/K,0,1),Wt(+D/K,0,1),Wt(+$/K,0,1),re?en(+re,me):1];if(Cs(ce))return ce}}return}}const v=d.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(v){const[b,S,E,C,k,D,z,V,$]=v,H=[E||" ",k||" ",z].join("");if(H==="  "||H==="  /"||H===",,"||H===",,,"){const J=[+S,Wt(+C,0,100),Wt(+D,0,100),V?en(+V,$):1];if(Cs(J))return function([re,me,oe,U]){function K(ce){const Oe=(ce+re/30)%12,Ye=me*Math.min(oe,1-oe);return oe-Ye*Math.max(-1,Math.min(Oe-3,9-Oe,1))}return re=kh(re),me/=100,oe/=100,[K(0),K(8),K(4),U]}(J)}}}(s);return h?new Jt(...h,!1):void 0}get rgb(){const{r:s,g:h,b:d,a:m}=this,v=m||1/0;return this.overwriteGetter("rgb",[s/v,h/v,d/v,m])}get hcl(){return this.overwriteGetter("hcl",function(s){const[h,d,m,v]=Dh(s),b=Math.sqrt(d*d+m*m);return[Math.round(1e4*b)?kh(Math.atan2(m,d)*ra):NaN,b,h,v]}(this.rgb))}get lab(){return this.overwriteGetter("lab",Dh(this.rgb))}overwriteGetter(s,h){return Object.defineProperty(this,s,{value:h}),h}toString(){const[s,h,d,m]=this.rgb;return`rgba(${[s,h,d].map(v=>Math.round(255*v)).join(",")},${m})`}static interpolate(s,h,d,m="rgb"){switch(m){case"rgb":{const[v,b,S,E]=co(s.rgb,h.rgb,d);return new Jt(v,b,S,E,!1)}case"hcl":{const[v,b,S,E]=s.hcl,[C,k,D,z]=h.hcl;let V,$;if(isNaN(v)||isNaN(C))isNaN(v)?isNaN(C)?V=NaN:(V=C,S!==1&&S!==0||($=k)):(V=v,D!==1&&D!==0||($=b));else{let oe=C-v;C>v&&oe>180?oe-=360:C<v&&v-C>180&&(oe+=360),V=v+d*oe}const[H,J,re,me]=function([oe,U,K,ce]){return oe=isNaN(oe)?0:oe*Rh,Oh([K,Math.cos(oe)*U,Math.sin(oe)*U,ce])}([V,$??Dn(b,k,d),Dn(S,D,d),Dn(E,z,d)]);return new Jt(H,J,re,me,!1)}case"lab":{const[v,b,S,E]=Oh(co(s.lab,h.lab,d));return new Jt(v,b,S,E,!1)}}}}Jt.black=new Jt(0,0,0,1),Jt.white=new Jt(1,1,1,1),Jt.transparent=new Jt(0,0,0,0),Jt.red=new Jt(1,0,0,1);class Zr{constructor(s,h,d){this.sensitivity=s?h?"variant":"case":h?"accent":"base",this.locale=d,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(s,h){return this.collator.compare(s,h)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const sa=["bottom","center","top"];class uo{constructor(s,h,d,m,v,b){this.text=s,this.image=h,this.scale=d,this.fontStack=m,this.textColor=v,this.verticalAlign=b}}class br{constructor(s){this.sections=s}static fromString(s){return new br([new uo(s,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(s=>s.text.length!==0||s.image&&s.image.name.length!==0)}static factory(s){return s instanceof br?s:br.fromString(s)}toString(){return this.sections.length===0?"":this.sections.map(s=>s.text).join("")}}class cr{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof cr)return s;if(typeof s=="number")return new cr([s,s,s,s]);if(Array.isArray(s)&&!(s.length<1||s.length>4)){for(const h of s)if(typeof h!="number")return;switch(s.length){case 1:s=[s[0],s[0],s[0],s[0]];break;case 2:s=[s[0],s[1],s[0],s[1]];break;case 3:s=[s[0],s[1],s[2],s[1]]}return new cr(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,h,d){return new cr(co(s.values,h.values,d))}}class Ai{constructor(s){this.name="ExpressionEvaluationError",this.message=s}toJSON(){return this.message}}const il=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class wr{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof wr)return s;if(Array.isArray(s)&&!(s.length<1)&&s.length%2==0){for(let h=0;h<s.length;h+=2){const d=s[h],m=s[h+1];if(typeof d!="string"||!il.has(d)||!Array.isArray(m)||m.length!==2||typeof m[0]!="number"||typeof m[1]!="number")return}return new wr(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,h,d){const m=s.values,v=h.values;if(m.length!==v.length)throw new Ai(`Cannot interpolate values of different length. from: ${s.toString()}, to: ${h.toString()}`);const b=[];for(let S=0;S<m.length;S+=2){if(m[S]!==v[S])throw new Ai(`Cannot interpolate values containing mismatched anchors. from[${S}]: ${m[S]}, to[${S}]: ${v[S]}`);b.push(m[S]);const[E,C]=m[S+1],[k,D]=v[S+1];b.push([Dn(E,k,d),Dn(C,D,d)])}return new wr(b)}}class Cr{constructor(s){this.name=s.name,this.available=s.available}toString(){return this.name}static fromString(s){return s?new Cr({name:s,available:!1}):null}}class Yi{constructor(s,h,d){this.from=s,this.to=h,this.transition=d}static interpolate(s,h,d){return new Yi(s,h,d)}static parse(s){return s instanceof Yi?s:Array.isArray(s)&&s.length===3&&typeof s[0]=="string"&&typeof s[1]=="string"&&typeof s[2]=="number"?new Yi(s[0],s[1],s[2]):typeof s=="object"&&typeof s.from=="string"&&typeof s.to=="string"&&typeof s.transition=="number"?new Yi(s.from,s.to,s.transition):typeof s=="string"?new Yi(s,s,1):void 0}}function Fh(u,s,h,d){return typeof u=="number"&&u>=0&&u<=255&&typeof s=="number"&&s>=0&&s<=255&&typeof h=="number"&&h>=0&&h<=255?d===void 0||typeof d=="number"&&d>=0&&d<=1?null:`Invalid rgba value [${[u,s,h,d].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof d=="number"?[u,s,h,d]:[u,s,h]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ss(u){if(u===null||typeof u=="string"||typeof u=="boolean"||typeof u=="number"||u instanceof Yi||u instanceof Jt||u instanceof Zr||u instanceof br||u instanceof cr||u instanceof wr||u instanceof Cr)return!0;if(Array.isArray(u)){for(const s of u)if(!ss(s))return!1;return!0}if(typeof u=="object"){for(const s in u)if(!ss(u[s]))return!1;return!0}return!1}function Pi(u){if(u===null)return Kt;if(typeof u=="string")return vt;if(typeof u=="boolean")return ct;if(typeof u=="number")return et;if(u instanceof Jt)return zt;if(u instanceof Yi)return Mi;if(u instanceof Zr)return Gi;if(u instanceof br)return mi;if(u instanceof cr)return el;if(u instanceof wr)return is;if(u instanceof Cr)return so;if(Array.isArray(u)){const s=u.length;let h;for(const d of u){const m=Pi(d);if(h){if(h===m)continue;h=Rt;break}h=m}return Ir(h||Rt,s)}return kn}function ho(u){const s=typeof u;return u===null?"":s==="string"||s==="number"||s==="boolean"?String(u):u instanceof Jt||u instanceof Yi||u instanceof br||u instanceof cr||u instanceof wr||u instanceof Cr?u.toString():JSON.stringify(u)}class os{constructor(s,h){this.type=s,this.value=h}static parse(s,h){if(s.length!==2)return h.error(`'literal' expression requires exactly one argument, but found ${s.length-1} instead.`);if(!ss(s[1]))return h.error("invalid value");const d=s[1];let m=Pi(d);const v=h.expectedType;return m.kind!=="array"||m.N!==0||!v||v.kind!=="array"||typeof v.N=="number"&&v.N!==0||(m=v),new os(m,d)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const oa={string:vt,number:et,boolean:ct,object:kn};class Mr{constructor(s,h){this.type=s,this.args=h}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");let d,m=1;const v=s[0];if(v==="array"){let S,E;if(s.length>2){const C=s[1];if(typeof C!="string"||!(C in oa)||C==="object")return h.error('The item type argument of "array" must be one of string, number, boolean',1);S=oa[C],m++}else S=Rt;if(s.length>3){if(s[2]!==null&&(typeof s[2]!="number"||s[2]<0||s[2]!==Math.floor(s[2])))return h.error('The length argument to "array" must be a positive integer literal',2);E=s[2],m++}d=Ir(S,E)}else{if(!oa[v])throw new Error(`Types doesn't contain name = ${v}`);d=oa[v]}const b=[];for(;m<s.length;m++){const S=h.parse(s[m],m,Rt);if(!S)return null;b.push(S)}return new Mr(d,b)}evaluate(s){for(let h=0;h<this.args.length;h++){const d=this.args[h].evaluate(s);if(!oo(this.type,Pi(d)))return d;if(h===this.args.length-1)throw new Ai(`Expected value to be of type ${Ii(this.type)}, but found ${Ii(Pi(d))} instead.`)}throw new Error}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every(s=>s.outputDefined())}}const _i={"to-boolean":ct,"to-color":zt,"to-number":et,"to-string":vt};class pn{constructor(s,h){this.type=s,this.args=h}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");const d=s[0];if(!_i[d])throw new Error(`Can't parse ${d} as it is not part of the known types`);if((d==="to-boolean"||d==="to-string")&&s.length!==2)return h.error("Expected one argument.");const m=_i[d],v=[];for(let b=1;b<s.length;b++){const S=h.parse(s[b],b,Rt);if(!S)return null;v.push(S)}return new pn(m,v)}evaluate(s){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(s);case"color":{let h,d;for(const m of this.args){if(h=m.evaluate(s),d=null,h instanceof Jt)return h;if(typeof h=="string"){const v=s.parseColor(h);if(v)return v}else if(Array.isArray(h)&&(d=h.length<3||h.length>4?`Invalid rgba value ${JSON.stringify(h)}: expected an array containing either three or four numeric values.`:Fh(h[0],h[1],h[2],h[3]),!d))return new Jt(h[0]/255,h[1]/255,h[2]/255,h[3])}throw new Ai(d||`Could not parse color from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"padding":{let h;for(const d of this.args){h=d.evaluate(s);const m=cr.parse(h);if(m)return m}throw new Ai(`Could not parse padding from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"variableAnchorOffsetCollection":{let h;for(const d of this.args){h=d.evaluate(s);const m=wr.parse(h);if(m)return m}throw new Ai(`Could not parse variableAnchorOffsetCollection from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"number":{let h=null;for(const d of this.args){if(h=d.evaluate(s),h===null)return 0;const m=Number(h);if(!isNaN(m))return m}throw new Ai(`Could not convert ${JSON.stringify(h)} to number.`)}case"formatted":return br.fromString(ho(this.args[0].evaluate(s)));case"resolvedImage":return Cr.fromString(ho(this.args[0].evaluate(s)));case"projectionDefinition":return this.args[0].evaluate(s);default:return ho(this.args[0].evaluate(s))}}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every(s=>s.outputDefined())}}const ti=["Unknown","Point","LineString","Polygon"];class Vt{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?ti[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(s){let h=this._parseColorCache[s];return h||(h=this._parseColorCache[s]=Jt.parse(s)),h}}class fo{constructor(s,h,d=[],m,v=new Ot,b=[]){this.registry=s,this.path=d,this.key=d.map(S=>`[${S}]`).join(""),this.scope=v,this.errors=b,this.expectedType=m,this._isConstant=h}parse(s,h,d,m,v={}){return h?this.concat(h,d,m)._parse(s,v):this._parse(s,v)}_parse(s,h){function d(m,v,b){return b==="assert"?new Mr(v,[m]):b==="coerce"?new pn(v,[m]):m}if(s!==null&&typeof s!="string"&&typeof s!="boolean"&&typeof s!="number"||(s=["literal",s]),Array.isArray(s)){if(s.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const m=s[0];if(typeof m!="string")return this.error(`Expression name must be a string, but found ${typeof m} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const v=this.registry[m];if(v){let b=v.parse(s,this);if(!b)return null;if(this.expectedType){const S=this.expectedType,E=b.type;if(S.kind!=="string"&&S.kind!=="number"&&S.kind!=="boolean"&&S.kind!=="object"&&S.kind!=="array"||E.kind!=="value")if(S.kind!=="projectionDefinition"||E.kind!=="string"&&E.kind!=="array")if(S.kind!=="color"&&S.kind!=="formatted"&&S.kind!=="resolvedImage"||E.kind!=="value"&&E.kind!=="string")if(S.kind!=="padding"||E.kind!=="value"&&E.kind!=="number"&&E.kind!=="array")if(S.kind!=="variableAnchorOffsetCollection"||E.kind!=="value"&&E.kind!=="array"){if(this.checkSubtype(S,E))return null}else b=d(b,S,h.typeAnnotation||"coerce");else b=d(b,S,h.typeAnnotation||"coerce");else b=d(b,S,h.typeAnnotation||"coerce");else b=d(b,S,h.typeAnnotation||"coerce");else b=d(b,S,h.typeAnnotation||"assert")}if(!(b instanceof os)&&b.type.kind!=="resolvedImage"&&this._isConstant(b)){const S=new Vt;try{b=new os(b.type,b.evaluate(S))}catch(E){return this.error(E.message),null}}return b}return this.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(s===void 0?"'undefined' value invalid. Use null instead.":typeof s=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof s} instead.`)}concat(s,h,d){const m=typeof s=="number"?this.path.concat(s):this.path,v=d?this.scope.concat(d):this.scope;return new fo(this.registry,this._isConstant,m,h||null,v,this.errors)}error(s,...h){const d=`${this.key}${h.map(m=>`[${m}]`).join("")}`;this.errors.push(new Et(d,s))}checkSubtype(s,h){const d=oo(s,h);return d&&this.error(d),d}}class Yt{constructor(s,h){this.type=h.type,this.bindings=[].concat(s),this.result=h}evaluate(s){return this.result.evaluate(s)}eachChild(s){for(const h of this.bindings)s(h[1]);s(this.result)}static parse(s,h){if(s.length<4)return h.error(`Expected at least 3 arguments, but found ${s.length-1} instead.`);const d=[];for(let v=1;v<s.length-1;v+=2){const b=s[v];if(typeof b!="string")return h.error(`Expected string, but found ${typeof b} instead.`,v);if(/[^a-zA-Z0-9_]/.test(b))return h.error("Variable names must contain only alphanumeric characters or '_'.",v);const S=h.parse(s[v+1],v+1);if(!S)return null;d.push([b,S])}const m=h.parse(s[s.length-1],s.length-1,h.expectedType,d);return m?new Yt(d,m):null}outputDefined(){return this.result.outputDefined()}}class po{constructor(s,h){this.type=h.type,this.name=s,this.boundExpression=h}static parse(s,h){if(s.length!==2||typeof s[1]!="string")return h.error("'var' expression requires exactly one string literal argument.");const d=s[1];return h.scope.has(d)?new po(d,h.scope.get(d)):h.error(`Unknown variable "${d}". Make sure "${d}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(s){return this.boundExpression.evaluate(s)}eachChild(){}outputDefined(){return!1}}class tn{constructor(s,h,d){this.type=s,this.index=h,this.input=d}static parse(s,h){if(s.length!==3)return h.error(`Expected 2 arguments, but found ${s.length-1} instead.`);const d=h.parse(s[1],1,et),m=h.parse(s[2],2,Ir(h.expectedType||Rt));return d&&m?new tn(m.type.itemType,d,m):null}evaluate(s){const h=this.index.evaluate(s),d=this.input.evaluate(s);if(h<0)throw new Ai(`Array index out of bounds: ${h} < 0.`);if(h>=d.length)throw new Ai(`Array index out of bounds: ${h} > ${d.length-1}.`);if(h!==Math.floor(h))throw new Ai(`Array index must be an integer, but found ${h} instead.`);return d[h]}eachChild(s){s(this.index),s(this.input)}outputDefined(){return!1}}class aa{constructor(s,h){this.type=ct,this.needle=s,this.haystack=h}static parse(s,h){if(s.length!==3)return h.error(`Expected 2 arguments, but found ${s.length-1} instead.`);const d=h.parse(s[1],1,Rt),m=h.parse(s[2],2,Rt);return d&&m?Ec(d.type,[ct,vt,et,Kt,Rt])?new aa(d,m):h.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(d.type)} instead`):null}evaluate(s){const h=this.needle.evaluate(s),d=this.haystack.evaluate(s);if(!d)return!1;if(!rs(h,["boolean","string","number","null"]))throw new Ai(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(Pi(h))} instead.`);if(!rs(d,["string","array"]))throw new Ai(`Expected second argument to be of type array or string, but found ${Ii(Pi(d))} instead.`);return d.indexOf(h)>=0}eachChild(s){s(this.needle),s(this.haystack)}outputDefined(){return!0}}class la{constructor(s,h,d){this.type=et,this.needle=s,this.haystack=h,this.fromIndex=d}static parse(s,h){if(s.length<=2||s.length>=5)return h.error(`Expected 3 or 4 arguments, but found ${s.length-1} instead.`);const d=h.parse(s[1],1,Rt),m=h.parse(s[2],2,Rt);if(!d||!m)return null;if(!Ec(d.type,[ct,vt,et,Kt,Rt]))return h.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(d.type)} instead`);if(s.length===4){const v=h.parse(s[3],3,et);return v?new la(d,m,v):null}return new la(d,m)}evaluate(s){const h=this.needle.evaluate(s),d=this.haystack.evaluate(s);if(!rs(h,["boolean","string","number","null"]))throw new Ai(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(Pi(h))} instead.`);let m;if(this.fromIndex&&(m=this.fromIndex.evaluate(s)),rs(d,["string"])){const v=d.indexOf(h,m);return v===-1?-1:[...d.slice(0,v)].length}if(rs(d,["array"]))return d.indexOf(h,m);throw new Ai(`Expected second argument to be of type array or string, but found ${Ii(Pi(d))} instead.`)}eachChild(s){s(this.needle),s(this.haystack),this.fromIndex&&s(this.fromIndex)}outputDefined(){return!1}}class rl{constructor(s,h,d,m,v,b){this.inputType=s,this.type=h,this.input=d,this.cases=m,this.outputs=v,this.otherwise=b}static parse(s,h){if(s.length<5)return h.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if(s.length%2!=1)return h.error("Expected an even number of arguments.");let d,m;h.expectedType&&h.expectedType.kind!=="value"&&(m=h.expectedType);const v={},b=[];for(let C=2;C<s.length-1;C+=2){let k=s[C];const D=s[C+1];Array.isArray(k)||(k=[k]);const z=h.concat(C);if(k.length===0)return z.error("Expected at least one branch label.");for(const $ of k){if(typeof $!="number"&&typeof $!="string")return z.error("Branch labels must be numbers or strings.");if(typeof $=="number"&&Math.abs($)>Number.MAX_SAFE_INTEGER)return z.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof $=="number"&&Math.floor($)!==$)return z.error("Numeric branch labels must be integer values.");if(d){if(z.checkSubtype(d,Pi($)))return null}else d=Pi($);if(v[String($)]!==void 0)return z.error("Branch labels must be unique.");v[String($)]=b.length}const V=h.parse(D,C,m);if(!V)return null;m=m||V.type,b.push(V)}const S=h.parse(s[1],1,Rt);if(!S)return null;const E=h.parse(s[s.length-1],s.length-1,m);return E?S.type.kind!=="value"&&h.concat(1).checkSubtype(d,S.type)?null:new rl(d,m,S,v,b,E):null}evaluate(s){const h=this.input.evaluate(s);return(Pi(h)===this.inputType&&this.outputs[this.cases[h]]||this.otherwise).evaluate(s)}eachChild(s){s(this.input),this.outputs.forEach(s),s(this.otherwise)}outputDefined(){return this.outputs.every(s=>s.outputDefined())&&this.otherwise.outputDefined()}}class ca{constructor(s,h,d){this.type=s,this.branches=h,this.otherwise=d}static parse(s,h){if(s.length<4)return h.error(`Expected at least 3 arguments, but found only ${s.length-1}.`);if(s.length%2!=0)return h.error("Expected an odd number of arguments.");let d;h.expectedType&&h.expectedType.kind!=="value"&&(d=h.expectedType);const m=[];for(let b=1;b<s.length-1;b+=2){const S=h.parse(s[b],b,ct);if(!S)return null;const E=h.parse(s[b+1],b+1,d);if(!E)return null;m.push([S,E]),d=d||E.type}const v=h.parse(s[s.length-1],s.length-1,d);if(!v)return null;if(!d)throw new Error("Can't infer output type");return new ca(d,m,v)}evaluate(s){for(const[h,d]of this.branches)if(h.evaluate(s))return d.evaluate(s);return this.otherwise.evaluate(s)}eachChild(s){for(const[h,d]of this.branches)s(h),s(d);s(this.otherwise)}outputDefined(){return this.branches.every(([s,h])=>h.outputDefined())&&this.otherwise.outputDefined()}}class ua{constructor(s,h,d,m){this.type=s,this.input=h,this.beginIndex=d,this.endIndex=m}static parse(s,h){if(s.length<=2||s.length>=5)return h.error(`Expected 3 or 4 arguments, but found ${s.length-1} instead.`);const d=h.parse(s[1],1,Rt),m=h.parse(s[2],2,et);if(!d||!m)return null;if(!Ec(d.type,[Ir(Rt),vt,Rt]))return h.error(`Expected first argument to be of type array or string, but found ${Ii(d.type)} instead`);if(s.length===4){const v=h.parse(s[3],3,et);return v?new ua(d.type,d,m,v):null}return new ua(d.type,d,m)}evaluate(s){const h=this.input.evaluate(s),d=this.beginIndex.evaluate(s);let m;if(this.endIndex&&(m=this.endIndex.evaluate(s)),rs(h,["string"]))return[...h].slice(d,m).join("");if(rs(h,["array"]))return h.slice(d,m);throw new Ai(`Expected first argument to be of type array or string, but found ${Ii(Pi(h))} instead.`)}eachChild(s){s(this.input),s(this.beginIndex),this.endIndex&&s(this.endIndex)}outputDefined(){return!1}}function nl(u,s){const h=u.length-1;let d,m,v=0,b=h,S=0;for(;v<=b;)if(S=Math.floor((v+b)/2),d=u[S],m=u[S+1],d<=s){if(S===h||s<m)return S;v=S+1}else{if(!(d>s))throw new Ai("Input is not a number.");b=S-1}return 0}class go{constructor(s,h,d){this.type=s,this.input=h,this.labels=[],this.outputs=[];for(const[m,v]of d)this.labels.push(m),this.outputs.push(v)}static parse(s,h){if(s.length-1<4)return h.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if((s.length-1)%2!=0)return h.error("Expected an even number of arguments.");const d=h.parse(s[1],1,et);if(!d)return null;const m=[];let v=null;h.expectedType&&h.expectedType.kind!=="value"&&(v=h.expectedType);for(let b=1;b<s.length;b+=2){const S=b===1?-1/0:s[b],E=s[b+1],C=b,k=b+1;if(typeof S!="number")return h.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',C);if(m.length&&m[m.length-1][0]>=S)return h.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',C);const D=h.parse(E,k,v);if(!D)return null;v=v||D.type,m.push([S,D])}return new go(v,d,m)}evaluate(s){const h=this.labels,d=this.outputs;if(h.length===1)return d[0].evaluate(s);const m=this.input.evaluate(s);if(m<=h[0])return d[0].evaluate(s);const v=h.length;return m>=h[v-1]?d[v-1].evaluate(s):d[nl(h,m)].evaluate(s)}eachChild(s){s(this.input);for(const h of this.outputs)s(h)}outputDefined(){return this.outputs.every(s=>s.outputDefined())}}function Lh(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var Ms,ur,sl=function(){if(ur)return Ms;function u(s,h,d,m){this.cx=3*s,this.bx=3*(d-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*h,this.by=3*(m-h)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=h,this.p2x=d,this.p2y=m}return ur=1,Ms=u,u.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,h){if(h===void 0&&(h=1e-6),s<0)return 0;if(s>1)return 1;for(var d=s,m=0;m<8;m++){var v=this.sampleCurveX(d)-s;if(Math.abs(v)<h)return d;var b=this.sampleCurveDerivativeX(d);if(Math.abs(b)<1e-6)break;d-=v/b}var S=0,E=1;for(d=s,m=0;m<20&&(v=this.sampleCurveX(d),!(Math.abs(v-s)<h));m++)s>v?S=d:E=d,d=.5*(E-S)+S;return d},solve:function(s,h){return this.sampleCurveY(this.solveCurveX(s,h))}},Ms}(),Bh=Lh(sl);class mr{constructor(s,h,d,m,v){this.type=s,this.operator=h,this.interpolation=d,this.input=m,this.labels=[],this.outputs=[];for(const[b,S]of v)this.labels.push(b),this.outputs.push(S)}static interpolationFactor(s,h,d,m){let v=0;if(s.name==="exponential")v=$i(h,s.base,d,m);else if(s.name==="linear")v=$i(h,1,d,m);else if(s.name==="cubic-bezier"){const b=s.controlPoints;v=new Bh(b[0],b[1],b[2],b[3]).solve($i(h,1,d,m))}return v}static parse(s,h){let[d,m,v,...b]=s;if(!Array.isArray(m)||m.length===0)return h.error("Expected an interpolation type expression.",1);if(m[0]==="linear")m={name:"linear"};else if(m[0]==="exponential"){const C=m[1];if(typeof C!="number")return h.error("Exponential interpolation requires a numeric base.",1,1);m={name:"exponential",base:C}}else{if(m[0]!=="cubic-bezier")return h.error(`Unknown interpolation type ${String(m[0])}`,1,0);{const C=m.slice(1);if(C.length!==4||C.some(k=>typeof k!="number"||k<0||k>1))return h.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);m={name:"cubic-bezier",controlPoints:C}}}if(s.length-1<4)return h.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if((s.length-1)%2!=0)return h.error("Expected an even number of arguments.");if(v=h.parse(v,2,et),!v)return null;const S=[];let E=null;d==="interpolate-hcl"||d==="interpolate-lab"?E=zt:h.expectedType&&h.expectedType.kind!=="value"&&(E=h.expectedType);for(let C=0;C<b.length;C+=2){const k=b[C],D=b[C+1],z=C+3,V=C+4;if(typeof k!="number")return h.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',z);if(S.length&&S[S.length-1][0]>=k)return h.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',z);const $=h.parse(D,V,E);if(!$)return null;E=E||$.type,S.push([k,$])}return ao(E,et)||ao(E,Mi)||ao(E,zt)||ao(E,el)||ao(E,is)||ao(E,Ir(et))?new mr(E,d,m,v,S):h.error(`Type ${Ii(E)} is not interpolatable.`)}evaluate(s){const h=this.labels,d=this.outputs;if(h.length===1)return d[0].evaluate(s);const m=this.input.evaluate(s);if(m<=h[0])return d[0].evaluate(s);const v=h.length;if(m>=h[v-1])return d[v-1].evaluate(s);const b=nl(h,m),S=mr.interpolationFactor(this.interpolation,m,h[b],h[b+1]),E=d[b].evaluate(s),C=d[b+1].evaluate(s);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return Dn(E,C,S);case"color":return Jt.interpolate(E,C,S);case"padding":return cr.interpolate(E,C,S);case"variableAnchorOffsetCollection":return wr.interpolate(E,C,S);case"array":return co(E,C,S);case"projectionDefinition":return Yi.interpolate(E,C,S)}case"interpolate-hcl":return Jt.interpolate(E,C,S,"hcl");case"interpolate-lab":return Jt.interpolate(E,C,S,"lab")}}eachChild(s){s(this.input);for(const h of this.outputs)s(h)}outputDefined(){return this.outputs.every(s=>s.outputDefined())}}function $i(u,s,h,d){const m=d-h,v=u-h;return m===0?0:s===1?v/m:(Math.pow(s,v)-1)/(Math.pow(s,m)-1)}const rn={color:Jt.interpolate,number:Dn,padding:cr.interpolate,variableAnchorOffsetCollection:wr.interpolate,array:co};class mo{constructor(s,h){this.type=s,this.args=h}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");let d=null;const m=h.expectedType;m&&m.kind!=="value"&&(d=m);const v=[];for(const S of s.slice(1)){const E=h.parse(S,1+v.length,d,void 0,{typeAnnotation:"omit"});if(!E)return null;d=d||E.type,v.push(E)}if(!d)throw new Error("No output type");const b=m&&v.some(S=>oo(m,S.type));return new mo(b?Rt:d,v)}evaluate(s){let h,d=null,m=0;for(const v of this.args)if(m++,d=v.evaluate(s),d&&d instanceof Cr&&!d.available&&(h||(h=d.name),d=null,m===this.args.length&&(d=h)),d!==null)break;return d}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every(s=>s.outputDefined())}}function Mc(u,s){return u==="=="||u==="!="?s.kind==="boolean"||s.kind==="string"||s.kind==="number"||s.kind==="null"||s.kind==="value":s.kind==="string"||s.kind==="number"||s.kind==="value"}function Nh(u,s,h,d){return d.compare(s,h)===0}function On(u,s,h){const d=u!=="=="&&u!=="!=";return class xT{constructor(v,b,S){this.type=ct,this.lhs=v,this.rhs=b,this.collator=S,this.hasUntypedArgument=v.type.kind==="value"||b.type.kind==="value"}static parse(v,b){if(v.length!==3&&v.length!==4)return b.error("Expected two or three arguments.");const S=v[0];let E=b.parse(v[1],1,Rt);if(!E)return null;if(!Mc(S,E.type))return b.concat(1).error(`"${S}" comparisons are not supported for type '${Ii(E.type)}'.`);let C=b.parse(v[2],2,Rt);if(!C)return null;if(!Mc(S,C.type))return b.concat(2).error(`"${S}" comparisons are not supported for type '${Ii(C.type)}'.`);if(E.type.kind!==C.type.kind&&E.type.kind!=="value"&&C.type.kind!=="value")return b.error(`Cannot compare types '${Ii(E.type)}' and '${Ii(C.type)}'.`);d&&(E.type.kind==="value"&&C.type.kind!=="value"?E=new Mr(C.type,[E]):E.type.kind!=="value"&&C.type.kind==="value"&&(C=new Mr(E.type,[C])));let k=null;if(v.length===4){if(E.type.kind!=="string"&&C.type.kind!=="string"&&E.type.kind!=="value"&&C.type.kind!=="value")return b.error("Cannot use collator to compare non-string types.");if(k=b.parse(v[3],3,Gi),!k)return null}return new xT(E,C,k)}evaluate(v){const b=this.lhs.evaluate(v),S=this.rhs.evaluate(v);if(d&&this.hasUntypedArgument){const E=Pi(b),C=Pi(S);if(E.kind!==C.kind||E.kind!=="string"&&E.kind!=="number")throw new Ai(`Expected arguments for "${u}" to be (string, string) or (number, number), but found (${E.kind}, ${C.kind}) instead.`)}if(this.collator&&!d&&this.hasUntypedArgument){const E=Pi(b),C=Pi(S);if(E.kind!=="string"||C.kind!=="string")return s(v,b,S)}return this.collator?h(v,b,S,this.collator.evaluate(v)):s(v,b,S)}eachChild(v){v(this.lhs),v(this.rhs),this.collator&&v(this.collator)}outputDefined(){return!0}}}const Rc=On("==",function(u,s,h){return s===h},Nh),Vp=On("!=",function(u,s,h){return s!==h},function(u,s,h,d){return!Nh(0,s,h,d)}),ol=On("<",function(u,s,h){return s<h},function(u,s,h,d){return d.compare(s,h)<0}),al=On(">",function(u,s,h){return s>h},function(u,s,h,d){return d.compare(s,h)>0}),nn=On("<=",function(u,s,h){return s<=h},function(u,s,h,d){return d.compare(s,h)<=0}),zh=On(">=",function(u,s,h){return s>=h},function(u,s,h,d){return d.compare(s,h)>=0});class Rs{constructor(s,h,d){this.type=Gi,this.locale=d,this.caseSensitive=s,this.diacriticSensitive=h}static parse(s,h){if(s.length!==2)return h.error("Expected one argument.");const d=s[1];if(typeof d!="object"||Array.isArray(d))return h.error("Collator options argument must be an object.");const m=h.parse(d["case-sensitive"]!==void 0&&d["case-sensitive"],1,ct);if(!m)return null;const v=h.parse(d["diacritic-sensitive"]!==void 0&&d["diacritic-sensitive"],1,ct);if(!v)return null;let b=null;return d.locale&&(b=h.parse(d.locale,1,vt),!b)?null:new Rs(m,v,b)}evaluate(s){return new Zr(this.caseSensitive.evaluate(s),this.diacriticSensitive.evaluate(s),this.locale?this.locale.evaluate(s):null)}eachChild(s){s(this.caseSensitive),s(this.diacriticSensitive),this.locale&&s(this.locale)}outputDefined(){return!1}}class kc{constructor(s,h,d,m,v){this.type=vt,this.number=s,this.locale=h,this.currency=d,this.minFractionDigits=m,this.maxFractionDigits=v}static parse(s,h){if(s.length!==3)return h.error("Expected two arguments.");const d=h.parse(s[1],1,et);if(!d)return null;const m=s[2];if(typeof m!="object"||Array.isArray(m))return h.error("NumberFormat options argument must be an object.");let v=null;if(m.locale&&(v=h.parse(m.locale,1,vt),!v))return null;let b=null;if(m.currency&&(b=h.parse(m.currency,1,vt),!b))return null;let S=null;if(m["min-fraction-digits"]&&(S=h.parse(m["min-fraction-digits"],1,et),!S))return null;let E=null;return m["max-fraction-digits"]&&(E=h.parse(m["max-fraction-digits"],1,et),!E)?null:new kc(d,v,b,S,E)}evaluate(s){return new Intl.NumberFormat(this.locale?this.locale.evaluate(s):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(s):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(s):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(s):void 0}).format(this.number.evaluate(s))}eachChild(s){s(this.number),this.locale&&s(this.locale),this.currency&&s(this.currency),this.minFractionDigits&&s(this.minFractionDigits),this.maxFractionDigits&&s(this.maxFractionDigits)}outputDefined(){return!1}}class _o{constructor(s){this.type=mi,this.sections=s}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");const d=s[1];if(!Array.isArray(d)&&typeof d=="object")return h.error("First argument must be an image or text section.");const m=[];let v=!1;for(let b=1;b<=s.length-1;++b){const S=s[b];if(v&&typeof S=="object"&&!Array.isArray(S)){v=!1;let E=null;if(S["font-scale"]&&(E=h.parse(S["font-scale"],1,et),!E))return null;let C=null;if(S["text-font"]&&(C=h.parse(S["text-font"],1,Ir(vt)),!C))return null;let k=null;if(S["text-color"]&&(k=h.parse(S["text-color"],1,zt),!k))return null;let D=null;if(S["vertical-align"]){if(typeof S["vertical-align"]=="string"&&!sa.includes(S["vertical-align"]))return h.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${S["vertical-align"]}' instead.`);if(D=h.parse(S["vertical-align"],1,vt),!D)return null}const z=m[m.length-1];z.scale=E,z.font=C,z.textColor=k,z.verticalAlign=D}else{const E=h.parse(s[b],1,Rt);if(!E)return null;const C=E.type.kind;if(C!=="string"&&C!=="value"&&C!=="null"&&C!=="resolvedImage")return h.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");v=!0,m.push({content:E,scale:null,font:null,textColor:null,verticalAlign:null})}}return new _o(m)}evaluate(s){return new br(this.sections.map(h=>{const d=h.content.evaluate(s);return Pi(d)===so?new uo("",d,null,null,null,h.verticalAlign?h.verticalAlign.evaluate(s):null):new uo(ho(d),null,h.scale?h.scale.evaluate(s):null,h.font?h.font.evaluate(s).join(","):null,h.textColor?h.textColor.evaluate(s):null,h.verticalAlign?h.verticalAlign.evaluate(s):null)}))}eachChild(s){for(const h of this.sections)s(h.content),h.scale&&s(h.scale),h.font&&s(h.font),h.textColor&&s(h.textColor),h.verticalAlign&&s(h.verticalAlign)}outputDefined(){return!1}}class Dc{constructor(s){this.type=so,this.input=s}static parse(s,h){if(s.length!==2)return h.error("Expected two arguments.");const d=h.parse(s[1],1,vt);return d?new Dc(d):h.error("No image name provided.")}evaluate(s){const h=this.input.evaluate(s),d=Cr.fromString(h);return d&&s.availableImages&&(d.available=s.availableImages.indexOf(h)>-1),d}eachChild(s){s(this.input)}outputDefined(){return!1}}class Oc{constructor(s){this.type=et,this.input=s}static parse(s,h){if(s.length!==2)return h.error(`Expected 1 argument, but found ${s.length-1} instead.`);const d=h.parse(s[1],1);return d?d.type.kind!=="array"&&d.type.kind!=="string"&&d.type.kind!=="value"?h.error(`Expected argument of type string or array, but found ${Ii(d.type)} instead.`):new Oc(d):null}evaluate(s){const h=this.input.evaluate(s);if(typeof h=="string")return[...h].length;if(Array.isArray(h))return h.length;throw new Ai(`Expected value to be of type string or array, but found ${Ii(Pi(h))} instead.`)}eachChild(s){s(this.input)}outputDefined(){return!1}}const gn=8192;function jp(u,s){const h=(180+u[0])/360,d=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u[1]*Math.PI/360)))/360,m=Math.pow(2,s.z);return[Math.round(h*m*gn),Math.round(d*m*gn)]}function yo(u,s){const h=Math.pow(2,s.z);return[(m=(u[0]/gn+s.x)/h,360*m-180),(d=(u[1]/gn+s.y)/h,360/Math.PI*Math.atan(Math.exp((180-360*d)*Math.PI/180))-90)];var d,m}function ha(u,s){u[0]=Math.min(u[0],s[0]),u[1]=Math.min(u[1],s[1]),u[2]=Math.max(u[2],s[0]),u[3]=Math.max(u[3],s[1])}function xo(u,s){return!(u[0]<=s[0]||u[2]>=s[2]||u[1]<=s[1]||u[3]>=s[3])}function Uh(u,s,h){const d=u[0]-s[0],m=u[1]-s[1],v=u[0]-h[0],b=u[1]-h[1];return d*b-v*m==0&&d*v<=0&&m*b<=0}function ll(u,s,h,d){return(m=[d[0]-h[0],d[1]-h[1]])[0]*(v=[s[0]-u[0],s[1]-u[1]])[1]-m[1]*v[0]!=0&&!(!$h(u,s,h,d)||!$h(h,d,u,s));var m,v}function Vh(u,s,h){for(const d of h)for(let m=0;m<d.length-1;++m)if(ll(u,s,d[m],d[m+1]))return!0;return!1}function vo(u,s,h=!1){let d=!1;for(const S of s)for(let E=0;E<S.length-1;E++){if(Uh(u,S[E],S[E+1]))return h;(v=S[E])[1]>(m=u)[1]!=(b=S[E+1])[1]>m[1]&&m[0]<(b[0]-v[0])*(m[1]-v[1])/(b[1]-v[1])+v[0]&&(d=!d)}var m,v,b;return d}function $p(u,s){for(const h of s)if(vo(u,h))return!0;return!1}function jh(u,s){for(const h of u)if(!vo(h,s))return!1;for(let h=0;h<u.length-1;++h)if(Vh(u[h],u[h+1],s))return!1;return!0}function Wp(u,s){for(const h of s)if(jh(u,h))return!0;return!1}function $h(u,s,h,d){const m=d[0]-h[0],v=d[1]-h[1],b=(u[0]-h[0])*v-m*(u[1]-h[1]),S=(s[0]-h[0])*v-m*(s[1]-h[1]);return b>0&&S<0||b<0&&S>0}function cl(u,s,h){const d=[];for(let m=0;m<u.length;m++){const v=[];for(let b=0;b<u[m].length;b++){const S=jp(u[m][b],h);ha(s,S),v.push(S)}d.push(v)}return d}function Fc(u,s,h){const d=[];for(let m=0;m<u.length;m++){const v=cl(u[m],s,h);d.push(v)}return d}function Lc(u,s,h,d){if(u[0]<h[0]||u[0]>h[2]){const m=.5*d;let v=u[0]-h[0]>m?-d:h[0]-u[0]>m?d:0;v===0&&(v=u[0]-h[2]>m?-d:h[2]-u[0]>m?d:0),u[0]+=v}ha(s,u)}function Wh(u,s,h,d){const m=Math.pow(2,d.z)*gn,v=[d.x*gn,d.y*gn],b=[];for(const S of u)for(const E of S){const C=[E.x+v[0],E.y+v[1]];Lc(C,s,h,m),b.push(C)}return b}function Hh(u,s,h,d){const m=Math.pow(2,d.z)*gn,v=[d.x*gn,d.y*gn],b=[];for(const E of u){const C=[];for(const k of E){const D=[k.x+v[0],k.y+v[1]];ha(s,D),C.push(D)}b.push(C)}if(s[2]-s[0]<=m/2){(S=s)[0]=S[1]=1/0,S[2]=S[3]=-1/0;for(const E of b)for(const C of E)Lc(C,s,h,m)}var S;return b}class ks{constructor(s,h){this.type=ct,this.geojson=s,this.geometries=h}static parse(s,h){if(s.length!==2)return h.error(`'within' expression requires exactly one argument, but found ${s.length-1} instead.`);if(ss(s[1])){const d=s[1];if(d.type==="FeatureCollection"){const m=[];for(const v of d.features){const{type:b,coordinates:S}=v.geometry;b==="Polygon"&&m.push(S),b==="MultiPolygon"&&m.push(...S)}if(m.length)return new ks(d,{type:"MultiPolygon",coordinates:m})}else if(d.type==="Feature"){const m=d.geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new ks(d,d.geometry)}else if(d.type==="Polygon"||d.type==="MultiPolygon")return new ks(d,d)}return h.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(s){if(s.geometry()!=null&&s.canonicalID()!=null){if(s.geometryType()==="Point")return function(h,d){const m=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],b=h.canonicalID();if(d.type==="Polygon"){const S=cl(d.coordinates,v,b),E=Wh(h.geometry(),m,v,b);if(!xo(m,v))return!1;for(const C of E)if(!vo(C,S))return!1}if(d.type==="MultiPolygon"){const S=Fc(d.coordinates,v,b),E=Wh(h.geometry(),m,v,b);if(!xo(m,v))return!1;for(const C of E)if(!$p(C,S))return!1}return!0}(s,this.geometries);if(s.geometryType()==="LineString")return function(h,d){const m=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],b=h.canonicalID();if(d.type==="Polygon"){const S=cl(d.coordinates,v,b),E=Hh(h.geometry(),m,v,b);if(!xo(m,v))return!1;for(const C of E)if(!jh(C,S))return!1}if(d.type==="MultiPolygon"){const S=Fc(d.coordinates,v,b),E=Hh(h.geometry(),m,v,b);if(!xo(m,v))return!1;for(const C of E)if(!Wp(C,S))return!1}return!0}(s,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let ul=class{constructor(u=[],s=(h,d)=>h<d?-1:h>d?1:0){if(this.data=u,this.length=this.data.length,this.compare=s,this.length>0)for(let h=(this.length>>1)-1;h>=0;h--)this._down(h)}push(u){this.data.push(u),this._up(this.length++)}pop(){if(this.length===0)return;const u=this.data[0],s=this.data.pop();return--this.length>0&&(this.data[0]=s,this._down(0)),u}peek(){return this.data[0]}_up(u){const{data:s,compare:h}=this,d=s[u];for(;u>0;){const m=u-1>>1,v=s[m];if(h(d,v)>=0)break;s[u]=v,u=m}s[u]=d}_down(u){const{data:s,compare:h}=this,d=this.length>>1,m=s[u];for(;u<d;){let v=1+(u<<1);const b=v+1;if(b<this.length&&h(s[b],s[v])<0&&(v=b),h(s[v],m)>=0)break;s[u]=s[v],u=v}s[u]=m}};function Zh(u,s,h=0,d=u.length-1,m=Hp){for(;d>h;){if(d-h>600){const E=d-h+1,C=s-h+1,k=Math.log(E),D=.5*Math.exp(2*k/3),z=.5*Math.sqrt(k*D*(E-D)/E)*(C-E/2<0?-1:1);Zh(u,s,Math.max(h,Math.floor(s-C*D/E+z)),Math.min(d,Math.floor(s+(E-C)*D/E+z)),m)}const v=u[s];let b=h,S=d;for(fa(u,h,s),m(u[d],v)>0&&fa(u,h,d);b<S;){for(fa(u,b,S),b++,S--;m(u[b],v)<0;)b++;for(;m(u[S],v)>0;)S--}m(u[h],v)===0?fa(u,h,S):(S++,fa(u,S,d)),S<=s&&(h=S+1),s<=S&&(d=S-1)}}function fa(u,s,h){const d=u[s];u[s]=u[h],u[h]=d}function Hp(u,s){return u<s?-1:u>s?1:0}function da(u,s){if(u.length<=1)return[u];const h=[];let d,m;for(const v of u){const b=Zp(v);b!==0&&(v.area=Math.abs(b),m===void 0&&(m=b<0),m===b<0?(d&&h.push(d),d=[v]):d.push(v))}if(d&&h.push(d),s>1)for(let v=0;v<h.length;v++)h[v].length<=s||(Zh(h[v],s,1,h[v].length-1,Xh),h[v]=h[v].slice(0,s));return h}function Xh(u,s){return s.area-u.area}function Zp(u){let s=0;for(let h,d,m=0,v=u.length,b=v-1;m<v;b=m++)h=u[m],d=u[b],s+=(d.x-h.x)*(h.y+d.y);return s}const qh=1/298.257223563,Bc=qh*(2-qh),Nc=Math.PI/180;class zc{constructor(s){const h=6378.137*Nc*1e3,d=Math.cos(s*Nc),m=1/(1-Bc*(1-d*d)),v=Math.sqrt(m);this.kx=h*v*d,this.ky=h*v*m*(1-Bc)}distance(s,h){const d=this.wrap(s[0]-h[0])*this.kx,m=(s[1]-h[1])*this.ky;return Math.sqrt(d*d+m*m)}pointOnLine(s,h){let d,m,v,b,S=1/0;for(let E=0;E<s.length-1;E++){let C=s[E][0],k=s[E][1],D=this.wrap(s[E+1][0]-C)*this.kx,z=(s[E+1][1]-k)*this.ky,V=0;D===0&&z===0||(V=(this.wrap(h[0]-C)*this.kx*D+(h[1]-k)*this.ky*z)/(D*D+z*z),V>1?(C=s[E+1][0],k=s[E+1][1]):V>0&&(C+=D/this.kx*V,k+=z/this.ky*V)),D=this.wrap(h[0]-C)*this.kx,z=(h[1]-k)*this.ky;const $=D*D+z*z;$<S&&(S=$,d=C,m=k,v=E,b=V)}return{point:[d,m],index:v,t:Math.max(0,Math.min(1,b))}}wrap(s){for(;s<-180;)s+=360;for(;s>180;)s-=360;return s}}function Gh(u,s){return s[0]-u[0]}function hl(u){return u[1]-u[0]+1}function mn(u,s){return u[1]>=u[0]&&u[1]<s}function Uc(u,s){if(u[0]>u[1])return[null,null];const h=hl(u);if(s){if(h===2)return[u,null];const m=Math.floor(h/2);return[[u[0],u[0]+m],[u[0]+m,u[1]]]}if(h===1)return[u,null];const d=Math.floor(h/2)-1;return[[u[0],u[0]+d],[u[0]+d+1,u[1]]]}function Vc(u,s){if(!mn(s,u.length))return[1/0,1/0,-1/0,-1/0];const h=[1/0,1/0,-1/0,-1/0];for(let d=s[0];d<=s[1];++d)ha(h,u[d]);return h}function jc(u){const s=[1/0,1/0,-1/0,-1/0];for(const h of u)for(const d of h)ha(s,d);return s}function Yh(u){return u[0]!==-1/0&&u[1]!==-1/0&&u[2]!==1/0&&u[3]!==1/0}function ii(u,s,h){if(!Yh(u)||!Yh(s))return NaN;let d=0,m=0;return u[2]<s[0]&&(d=s[0]-u[2]),u[0]>s[2]&&(d=u[0]-s[2]),u[1]>s[3]&&(m=u[1]-s[3]),u[3]<s[1]&&(m=s[1]-u[3]),h.distance([0,0],[d,m])}function Ds(u,s,h){const d=h.pointOnLine(s,u);return h.distance(u,d.point)}function $c(u,s,h,d,m){const v=Math.min(Ds(u,[h,d],m),Ds(s,[h,d],m)),b=Math.min(Ds(h,[u,s],m),Ds(d,[u,s],m));return Math.min(v,b)}function Xp(u,s,h,d,m){if(!mn(s,u.length)||!mn(d,h.length))return 1/0;let v=1/0;for(let b=s[0];b<s[1];++b){const S=u[b],E=u[b+1];for(let C=d[0];C<d[1];++C){const k=h[C],D=h[C+1];if(ll(S,E,k,D))return 0;v=Math.min(v,$c(S,E,k,D,m))}}return v}function qp(u,s,h,d,m){if(!mn(s,u.length)||!mn(d,h.length))return NaN;let v=1/0;for(let b=s[0];b<=s[1];++b)for(let S=d[0];S<=d[1];++S)if(v=Math.min(v,m.distance(u[b],h[S])),v===0)return v;return v}function Gp(u,s,h){if(vo(u,s,!0))return 0;let d=1/0;for(const m of s){const v=m[0],b=m[m.length-1];if(v!==b&&(d=Math.min(d,Ds(u,[b,v],h)),d===0))return d;const S=h.pointOnLine(m,u);if(d=Math.min(d,h.distance(u,S.point)),d===0)return d}return d}function Yp(u,s,h,d){if(!mn(s,u.length))return NaN;for(let v=s[0];v<=s[1];++v)if(vo(u[v],h,!0))return 0;let m=1/0;for(let v=s[0];v<s[1];++v){const b=u[v],S=u[v+1];for(const E of h)for(let C=0,k=E.length,D=k-1;C<k;D=C++){const z=E[D],V=E[C];if(ll(b,S,z,V))return 0;m=Math.min(m,$c(b,S,z,V,d))}}return m}function Kh(u,s){for(const h of u)for(const d of h)if(vo(d,s,!0))return!0;return!1}function Kp(u,s,h,d=1/0){const m=jc(u),v=jc(s);if(d!==1/0&&ii(m,v,h)>=d)return d;if(xo(m,v)){if(Kh(u,s))return 0}else if(Kh(s,u))return 0;let b=1/0;for(const S of u)for(let E=0,C=S.length,k=C-1;E<C;k=E++){const D=S[k],z=S[E];for(const V of s)for(let $=0,H=V.length,J=H-1;$<H;J=$++){const re=V[J],me=V[$];if(ll(D,z,re,me))return 0;b=Math.min(b,$c(D,z,re,me,h))}}return b}function Jh(u,s,h,d,m,v){if(!v)return;const b=ii(Vc(d,v),m,h);b<s&&u.push([b,v,[0,0]])}function fl(u,s,h,d,m,v,b){if(!v||!b)return;const S=ii(Vc(d,v),Vc(m,b),h);S<s&&u.push([S,v,b])}function dl(u,s,h,d,m=1/0){let v=Math.min(d.distance(u[0],h[0][0]),m);if(v===0)return v;const b=new ul([[0,[0,u.length-1],[0,0]]],Gh),S=jc(h);for(;b.length>0;){const E=b.pop();if(E[0]>=v)continue;const C=E[1],k=s?50:100;if(hl(C)<=k){if(!mn(C,u.length))return NaN;if(s){const D=Yp(u,C,h,d);if(isNaN(D)||D===0)return D;v=Math.min(v,D)}else for(let D=C[0];D<=C[1];++D){const z=Gp(u[D],h,d);if(v=Math.min(v,z),v===0)return 0}}else{const D=Uc(C,s);Jh(b,v,d,u,S,D[0]),Jh(b,v,d,u,S,D[1])}}return v}function pl(u,s,h,d,m,v=1/0){let b=Math.min(v,m.distance(u[0],h[0]));if(b===0)return b;const S=new ul([[0,[0,u.length-1],[0,h.length-1]]],Gh);for(;S.length>0;){const E=S.pop();if(E[0]>=b)continue;const C=E[1],k=E[2],D=s?50:100,z=d?50:100;if(hl(C)<=D&&hl(k)<=z){if(!mn(C,u.length)&&mn(k,h.length))return NaN;let V;if(s&&d)V=Xp(u,C,h,k,m),b=Math.min(b,V);else if(s&&!d){const $=u.slice(C[0],C[1]+1);for(let H=k[0];H<=k[1];++H)if(V=Ds(h[H],$,m),b=Math.min(b,V),b===0)return b}else if(!s&&d){const $=h.slice(k[0],k[1]+1);for(let H=C[0];H<=C[1];++H)if(V=Ds(u[H],$,m),b=Math.min(b,V),b===0)return b}else V=qp(u,C,h,k,m),b=Math.min(b,V)}else{const V=Uc(C,s),$=Uc(k,d);fl(S,b,m,u,h,V[0],$[0]),fl(S,b,m,u,h,V[0],$[1]),fl(S,b,m,u,h,V[1],$[0]),fl(S,b,m,u,h,V[1],$[1])}}return b}function Wc(u){return u.type==="MultiPolygon"?u.coordinates.map(s=>({type:"Polygon",coordinates:s})):u.type==="MultiLineString"?u.coordinates.map(s=>({type:"LineString",coordinates:s})):u.type==="MultiPoint"?u.coordinates.map(s=>({type:"Point",coordinates:s})):[u]}class Os{constructor(s,h){this.type=et,this.geojson=s,this.geometries=h}static parse(s,h){if(s.length!==2)return h.error(`'distance' expression requires exactly one argument, but found ${s.length-1} instead.`);if(ss(s[1])){const d=s[1];if(d.type==="FeatureCollection")return new Os(d,d.features.map(m=>Wc(m.geometry)).flat());if(d.type==="Feature")return new Os(d,Wc(d.geometry));if("type"in d&&"coordinates"in d)return new Os(d,Wc(d))}return h.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(s){if(s.geometry()!=null&&s.canonicalID()!=null){if(s.geometryType()==="Point")return function(h,d){const m=h.geometry(),v=m.flat().map(E=>yo([E.x,E.y],h.canonical));if(m.length===0)return NaN;const b=new zc(v[0][1]);let S=1/0;for(const E of d){switch(E.type){case"Point":S=Math.min(S,pl(v,!1,[E.coordinates],!1,b,S));break;case"LineString":S=Math.min(S,pl(v,!1,E.coordinates,!0,b,S));break;case"Polygon":S=Math.min(S,dl(v,!1,E.coordinates,b,S))}if(S===0)return S}return S}(s,this.geometries);if(s.geometryType()==="LineString")return function(h,d){const m=h.geometry(),v=m.flat().map(E=>yo([E.x,E.y],h.canonical));if(m.length===0)return NaN;const b=new zc(v[0][1]);let S=1/0;for(const E of d){switch(E.type){case"Point":S=Math.min(S,pl(v,!0,[E.coordinates],!1,b,S));break;case"LineString":S=Math.min(S,pl(v,!0,E.coordinates,!0,b,S));break;case"Polygon":S=Math.min(S,dl(v,!0,E.coordinates,b,S))}if(S===0)return S}return S}(s,this.geometries);if(s.geometryType()==="Polygon")return function(h,d){const m=h.geometry();if(m.length===0||m[0].length===0)return NaN;const v=da(m,0).map(E=>E.map(C=>C.map(k=>yo([k.x,k.y],h.canonical)))),b=new zc(v[0][0][0][1]);let S=1/0;for(const E of d)for(const C of v){switch(E.type){case"Point":S=Math.min(S,dl([E.coordinates],!1,C,b,S));break;case"LineString":S=Math.min(S,dl(E.coordinates,!0,C,b,S));break;case"Polygon":S=Math.min(S,Kp(C,E.coordinates,b,S))}if(S===0)return S}return S}(s,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const bo={"==":Rc,"!=":Vp,">":al,"<":ol,">=":zh,"<=":nn,array:Mr,at:tn,boolean:Mr,case:ca,coalesce:mo,collator:Rs,format:_o,image:Dc,in:aa,"index-of":la,interpolate:mr,"interpolate-hcl":mr,"interpolate-lab":mr,length:Oc,let:Yt,literal:os,match:rl,number:Mr,"number-format":kc,object:Mr,slice:ua,step:go,string:Mr,"to-boolean":pn,"to-color":pn,"to-number":pn,"to-string":pn,var:po,within:ks,distance:Os};class Xr{constructor(s,h,d,m){this.name=s,this.type=h,this._evaluate=d,this.args=m}evaluate(s){return this._evaluate(s,this.args)}eachChild(s){this.args.forEach(s)}outputDefined(){return!1}static parse(s,h){const d=s[0],m=Xr.definitions[d];if(!m)return h.error(`Unknown expression "${d}". If you wanted a literal array, use ["literal", [...]].`,0);const v=Array.isArray(m)?m[0]:m.type,b=Array.isArray(m)?[[m[1],m[2]]]:m.overloads,S=b.filter(([C])=>!Array.isArray(C)||C.length===s.length-1);let E=null;for(const[C,k]of S){E=new fo(h.registry,gl,h.path,null,h.scope);const D=[];let z=!1;for(let V=1;V<s.length;V++){const $=s[V],H=Array.isArray(C)?C[V-1]:C.type,J=E.parse($,1+D.length,H);if(!J){z=!0;break}D.push(J)}if(!z)if(Array.isArray(C)&&C.length!==D.length)E.error(`Expected ${C.length} arguments, but found ${D.length} instead.`);else{for(let V=0;V<D.length;V++){const $=Array.isArray(C)?C[V]:C.type,H=D[V];E.concat(V+1).checkSubtype($,H.type)}if(E.errors.length===0)return new Xr(d,v,k,D)}}if(S.length===1)h.errors.push(...E.errors);else{const C=(S.length?S:b).map(([D])=>{return z=D,Array.isArray(z)?`(${z.map(Ii).join(", ")})`:`(${Ii(z.type)}...)`;var z}).join(" | "),k=[];for(let D=1;D<s.length;D++){const z=h.parse(s[D],1+k.length);if(!z)return null;k.push(Ii(z.type))}h.error(`Expected arguments of type ${C}, but found (${k.join(", ")}) instead.`)}return null}static register(s,h){Xr.definitions=h;for(const d in h)s[d]=Xr}}function Qh(u,[s,h,d,m]){s=s.evaluate(u),h=h.evaluate(u),d=d.evaluate(u);const v=m?m.evaluate(u):1,b=Fh(s,h,d,v);if(b)throw new Ai(b);return new Jt(s/255,h/255,d/255,v,!1)}function ef(u,s){return u in s}function Hc(u,s){const h=s[u];return h===void 0?null:h}function Fs(u){return{type:u}}function gl(u){if(u instanceof po)return gl(u.boundExpression);if(u instanceof Xr&&u.name==="error"||u instanceof Rs||u instanceof ks||u instanceof Os)return!1;const s=u instanceof pn||u instanceof Mr;let h=!0;return u.eachChild(d=>{h=s?h&&gl(d):h&&d instanceof os}),!!h&&ml(u)&&_l(u,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function ml(u){if(u instanceof Xr&&(u.name==="get"&&u.args.length===1||u.name==="feature-state"||u.name==="has"&&u.args.length===1||u.name==="properties"||u.name==="geometry-type"||u.name==="id"||/^filter-/.test(u.name))||u instanceof ks||u instanceof Os)return!1;let s=!0;return u.eachChild(h=>{s&&!ml(h)&&(s=!1)}),s}function pa(u){if(u instanceof Xr&&u.name==="feature-state")return!1;let s=!0;return u.eachChild(h=>{s&&!pa(h)&&(s=!1)}),s}function _l(u,s){if(u instanceof Xr&&s.indexOf(u.name)>=0)return!1;let h=!0;return u.eachChild(d=>{h&&!_l(d,s)&&(h=!1)}),h}function tf(u){return{result:"success",value:u}}function wo(u){return{result:"error",value:u}}function To(u){return u["property-type"]==="data-driven"||u["property-type"]==="cross-faded-data-driven"}function rf(u){return!!u.expression&&u.expression.parameters.indexOf("zoom")>-1}function Zc(u){return!!u.expression&&u.expression.interpolated}function Qt(u){return u instanceof Number?"number":u instanceof String?"string":u instanceof Boolean?"boolean":Array.isArray(u)?"array":u===null?"null":typeof u}function yl(u){return typeof u=="object"&&u!==null&&!Array.isArray(u)}function Xc(u){return u}function nf(u,s){const h=s.type==="color",d=u.stops&&typeof u.stops[0][0]=="object",m=d||!(d||u.property!==void 0),v=u.type||(Zc(s)?"exponential":"interval");if(h||s.type==="padding"){const k=h?Jt.parse:cr.parse;(u=Ft({},u)).stops&&(u.stops=u.stops.map(D=>[D[0],k(D[1])])),u.default=k(u.default?u.default:s.default)}if(u.colorSpace&&(b=u.colorSpace)!=="rgb"&&b!=="hcl"&&b!=="lab")throw new Error(`Unknown color space: "${u.colorSpace}"`);var b;let S,E,C;if(v==="exponential")S=of;else if(v==="interval")S=sf;else if(v==="categorical"){S=Jp,E=Object.create(null);for(const k of u.stops)E[k[0]]=k[1];C=typeof u.stops[0][0]}else{if(v!=="identity")throw new Error(`Unknown function type "${v}"`);S=Qp}if(d){const k={},D=[];for(let $=0;$<u.stops.length;$++){const H=u.stops[$],J=H[0].zoom;k[J]===void 0&&(k[J]={zoom:J,type:u.type,property:u.property,default:u.default,stops:[]},D.push(J)),k[J].stops.push([H[0].value,H[1]])}const z=[];for(const $ of D)z.push([k[$].zoom,nf(k[$],s)]);const V={name:"linear"};return{kind:"composite",interpolationType:V,interpolationFactor:mr.interpolationFactor.bind(void 0,V),zoomStops:z.map($=>$[0]),evaluate:({zoom:$},H)=>of({stops:z,base:u.base},s,$).evaluate($,H)}}if(m){const k=v==="exponential"?{name:"exponential",base:u.base!==void 0?u.base:1}:null;return{kind:"camera",interpolationType:k,interpolationFactor:mr.interpolationFactor.bind(void 0,k),zoomStops:u.stops.map(D=>D[0]),evaluate:({zoom:D})=>S(u,s,D,E,C)}}return{kind:"source",evaluate(k,D){const z=D&&D.properties?D.properties[u.property]:void 0;return z===void 0?ga(u.default,s.default):S(u,s,z,E,C)}}}function ga(u,s,h){return u!==void 0?u:s!==void 0?s:h!==void 0?h:void 0}function Jp(u,s,h,d,m){return ga(typeof h===m?d[h]:void 0,u.default,s.default)}function sf(u,s,h){if(Qt(h)!=="number")return ga(u.default,s.default);const d=u.stops.length;if(d===1||h<=u.stops[0][0])return u.stops[0][1];if(h>=u.stops[d-1][0])return u.stops[d-1][1];const m=nl(u.stops.map(v=>v[0]),h);return u.stops[m][1]}function of(u,s,h){const d=u.base!==void 0?u.base:1;if(Qt(h)!=="number")return ga(u.default,s.default);const m=u.stops.length;if(m===1||h<=u.stops[0][0])return u.stops[0][1];if(h>=u.stops[m-1][0])return u.stops[m-1][1];const v=nl(u.stops.map(k=>k[0]),h),b=function(k,D,z,V){const $=V-z,H=k-z;return $===0?0:D===1?H/$:(Math.pow(D,H)-1)/(Math.pow(D,$)-1)}(h,d,u.stops[v][0],u.stops[v+1][0]),S=u.stops[v][1],E=u.stops[v+1][1],C=rn[s.type]||Xc;return typeof S.evaluate=="function"?{evaluate(...k){const D=S.evaluate.apply(void 0,k),z=E.evaluate.apply(void 0,k);if(D!==void 0&&z!==void 0)return C(D,z,b,u.colorSpace)}}:C(S,E,b,u.colorSpace)}function Qp(u,s,h){switch(s.type){case"color":h=Jt.parse(h);break;case"formatted":h=br.fromString(h.toString());break;case"resolvedImage":h=Cr.fromString(h.toString());break;case"padding":h=cr.parse(h);break;default:Qt(h)===s.type||s.type==="enum"&&s.values[h]||(h=void 0)}return ga(h,u.default,s.default)}Xr.register(bo,{error:[{kind:"error"},[vt],(u,[s])=>{throw new Ai(s.evaluate(u))}],typeof:[vt,[Rt],(u,[s])=>Ii(Pi(s.evaluate(u)))],"to-rgba":[Ir(et,4),[zt],(u,[s])=>{const[h,d,m,v]=s.evaluate(u).rgb;return[255*h,255*d,255*m,v]}],rgb:[zt,[et,et,et],Qh],rgba:[zt,[et,et,et,et],Qh],has:{type:ct,overloads:[[[vt],(u,[s])=>ef(s.evaluate(u),u.properties())],[[vt,kn],(u,[s,h])=>ef(s.evaluate(u),h.evaluate(u))]]},get:{type:Rt,overloads:[[[vt],(u,[s])=>Hc(s.evaluate(u),u.properties())],[[vt,kn],(u,[s,h])=>Hc(s.evaluate(u),h.evaluate(u))]]},"feature-state":[Rt,[vt],(u,[s])=>Hc(s.evaluate(u),u.featureState||{})],properties:[kn,[],u=>u.properties()],"geometry-type":[vt,[],u=>u.geometryType()],id:[Rt,[],u=>u.id()],zoom:[et,[],u=>u.globals.zoom],"heatmap-density":[et,[],u=>u.globals.heatmapDensity||0],"line-progress":[et,[],u=>u.globals.lineProgress||0],accumulated:[Rt,[],u=>u.globals.accumulated===void 0?null:u.globals.accumulated],"+":[et,Fs(et),(u,s)=>{let h=0;for(const d of s)h+=d.evaluate(u);return h}],"*":[et,Fs(et),(u,s)=>{let h=1;for(const d of s)h*=d.evaluate(u);return h}],"-":{type:et,overloads:[[[et,et],(u,[s,h])=>s.evaluate(u)-h.evaluate(u)],[[et],(u,[s])=>-s.evaluate(u)]]},"/":[et,[et,et],(u,[s,h])=>s.evaluate(u)/h.evaluate(u)],"%":[et,[et,et],(u,[s,h])=>s.evaluate(u)%h.evaluate(u)],ln2:[et,[],()=>Math.LN2],pi:[et,[],()=>Math.PI],e:[et,[],()=>Math.E],"^":[et,[et,et],(u,[s,h])=>Math.pow(s.evaluate(u),h.evaluate(u))],sqrt:[et,[et],(u,[s])=>Math.sqrt(s.evaluate(u))],log10:[et,[et],(u,[s])=>Math.log(s.evaluate(u))/Math.LN10],ln:[et,[et],(u,[s])=>Math.log(s.evaluate(u))],log2:[et,[et],(u,[s])=>Math.log(s.evaluate(u))/Math.LN2],sin:[et,[et],(u,[s])=>Math.sin(s.evaluate(u))],cos:[et,[et],(u,[s])=>Math.cos(s.evaluate(u))],tan:[et,[et],(u,[s])=>Math.tan(s.evaluate(u))],asin:[et,[et],(u,[s])=>Math.asin(s.evaluate(u))],acos:[et,[et],(u,[s])=>Math.acos(s.evaluate(u))],atan:[et,[et],(u,[s])=>Math.atan(s.evaluate(u))],min:[et,Fs(et),(u,s)=>Math.min(...s.map(h=>h.evaluate(u)))],max:[et,Fs(et),(u,s)=>Math.max(...s.map(h=>h.evaluate(u)))],abs:[et,[et],(u,[s])=>Math.abs(s.evaluate(u))],round:[et,[et],(u,[s])=>{const h=s.evaluate(u);return h<0?-Math.round(-h):Math.round(h)}],floor:[et,[et],(u,[s])=>Math.floor(s.evaluate(u))],ceil:[et,[et],(u,[s])=>Math.ceil(s.evaluate(u))],"filter-==":[ct,[vt,Rt],(u,[s,h])=>u.properties()[s.value]===h.value],"filter-id-==":[ct,[Rt],(u,[s])=>u.id()===s.value],"filter-type-==":[ct,[vt],(u,[s])=>u.geometryType()===s.value],"filter-<":[ct,[vt,Rt],(u,[s,h])=>{const d=u.properties()[s.value],m=h.value;return typeof d==typeof m&&d<m}],"filter-id-<":[ct,[Rt],(u,[s])=>{const h=u.id(),d=s.value;return typeof h==typeof d&&h<d}],"filter->":[ct,[vt,Rt],(u,[s,h])=>{const d=u.properties()[s.value],m=h.value;return typeof d==typeof m&&d>m}],"filter-id->":[ct,[Rt],(u,[s])=>{const h=u.id(),d=s.value;return typeof h==typeof d&&h>d}],"filter-<=":[ct,[vt,Rt],(u,[s,h])=>{const d=u.properties()[s.value],m=h.value;return typeof d==typeof m&&d<=m}],"filter-id-<=":[ct,[Rt],(u,[s])=>{const h=u.id(),d=s.value;return typeof h==typeof d&&h<=d}],"filter->=":[ct,[vt,Rt],(u,[s,h])=>{const d=u.properties()[s.value],m=h.value;return typeof d==typeof m&&d>=m}],"filter-id->=":[ct,[Rt],(u,[s])=>{const h=u.id(),d=s.value;return typeof h==typeof d&&h>=d}],"filter-has":[ct,[Rt],(u,[s])=>s.value in u.properties()],"filter-has-id":[ct,[],u=>u.id()!==null&&u.id()!==void 0],"filter-type-in":[ct,[Ir(vt)],(u,[s])=>s.value.indexOf(u.geometryType())>=0],"filter-id-in":[ct,[Ir(Rt)],(u,[s])=>s.value.indexOf(u.id())>=0],"filter-in-small":[ct,[vt,Ir(Rt)],(u,[s,h])=>h.value.indexOf(u.properties()[s.value])>=0],"filter-in-large":[ct,[vt,Ir(Rt)],(u,[s,h])=>function(d,m,v,b){for(;v<=b;){const S=v+b>>1;if(m[S]===d)return!0;m[S]>d?b=S-1:v=S+1}return!1}(u.properties()[s.value],h.value,0,h.value.length-1)],all:{type:ct,overloads:[[[ct,ct],(u,[s,h])=>s.evaluate(u)&&h.evaluate(u)],[Fs(ct),(u,s)=>{for(const h of s)if(!h.evaluate(u))return!1;return!0}]]},any:{type:ct,overloads:[[[ct,ct],(u,[s,h])=>s.evaluate(u)||h.evaluate(u)],[Fs(ct),(u,s)=>{for(const h of s)if(h.evaluate(u))return!0;return!1}]]},"!":[ct,[ct],(u,[s])=>!s.evaluate(u)],"is-supported-script":[ct,[vt],(u,[s])=>{const h=u.globals&&u.globals.isSupportedScript;return!h||h(s.evaluate(u))}],upcase:[vt,[vt],(u,[s])=>s.evaluate(u).toUpperCase()],downcase:[vt,[vt],(u,[s])=>s.evaluate(u).toLowerCase()],concat:[vt,Fs(Rt),(u,s)=>s.map(h=>ho(h.evaluate(u))).join("")],"resolved-locale":[vt,[Gi],(u,[s])=>s.evaluate(u).resolvedLocale()]});class So{constructor(s,h){var d;this.expression=s,this._warningHistory={},this._evaluator=new Vt,this._defaultValue=h?(d=h).type==="color"&&yl(d.default)?new Jt(0,0,0,0):d.type==="color"?Jt.parse(d.default)||null:d.type==="padding"?cr.parse(d.default)||null:d.type==="variableAnchorOffsetCollection"?wr.parse(d.default)||null:d.type==="projectionDefinition"?Yi.parse(d.default)||null:d.default===void 0?null:d.default:null,this._enumValues=h&&h.type==="enum"?h.values:null}evaluateWithoutErrorHandling(s,h,d,m,v,b){return this._evaluator.globals=s,this._evaluator.feature=h,this._evaluator.featureState=d,this._evaluator.canonical=m,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=b,this.expression.evaluate(this._evaluator)}evaluate(s,h,d,m,v,b){this._evaluator.globals=s,this._evaluator.feature=h||null,this._evaluator.featureState=d||null,this._evaluator.canonical=m,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=b||null;try{const S=this.expression.evaluate(this._evaluator);if(S==null||typeof S=="number"&&S!=S)return this._defaultValue;if(this._enumValues&&!(S in this._enumValues))throw new Ai(`Expected value to be one of ${Object.keys(this._enumValues).map(E=>JSON.stringify(E)).join(", ")}, but found ${JSON.stringify(S)} instead.`);return S}catch(S){return this._warningHistory[S.message]||(this._warningHistory[S.message]=!0,typeof console<"u"&&console.warn(S.message)),this._defaultValue}}}function ma(u){return Array.isArray(u)&&u.length>0&&typeof u[0]=="string"&&u[0]in bo}function xl(u,s){const h=new fo(bo,gl,[],s?function(m){const v={color:zt,string:vt,number:et,enum:vt,boolean:ct,formatted:mi,padding:el,projectionDefinition:Mi,resolvedImage:so,variableAnchorOffsetCollection:is};return m.type==="array"?Ir(v[m.value]||Rt,m.length):v[m.type]}(s):void 0),d=h.parse(u,void 0,void 0,void 0,s&&s.type==="string"?{typeAnnotation:"coerce"}:void 0);return d?tf(new So(d,s)):wo(h.errors)}class qc{constructor(s,h){this.kind=s,this._styleExpression=h,this.isStateDependent=s!=="constant"&&!pa(h.expression)}evaluateWithoutErrorHandling(s,h,d,m,v,b){return this._styleExpression.evaluateWithoutErrorHandling(s,h,d,m,v,b)}evaluate(s,h,d,m,v,b){return this._styleExpression.evaluate(s,h,d,m,v,b)}}class Gc{constructor(s,h,d,m){this.kind=s,this.zoomStops=d,this._styleExpression=h,this.isStateDependent=s!=="camera"&&!pa(h.expression),this.interpolationType=m}evaluateWithoutErrorHandling(s,h,d,m,v,b){return this._styleExpression.evaluateWithoutErrorHandling(s,h,d,m,v,b)}evaluate(s,h,d,m,v,b){return this._styleExpression.evaluate(s,h,d,m,v,b)}interpolationFactor(s,h,d){return this.interpolationType?mr.interpolationFactor(this.interpolationType,s,h,d):0}}function af(u,s){const h=xl(u,s);if(h.result==="error")return h;const d=h.value.expression,m=ml(d);if(!m&&!To(s))return wo([new Et("","data expressions not supported")]);const v=_l(d,["zoom"]);if(!v&&!rf(s))return wo([new Et("","zoom expressions not supported")]);const b=_a(d);return b||v?b instanceof Et?wo([b]):b instanceof mr&&!Zc(s)?wo([new Et("",'"interpolate" expressions cannot be used with this property')]):tf(b?new Gc(m?"camera":"composite",h.value,b.labels,b instanceof mr?b.interpolation:void 0):new qc(m?"constant":"source",h.value)):wo([new Et("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class vl{constructor(s,h){this._parameters=s,this._specification=h,Ft(this,nf(this._parameters,this._specification))}static deserialize(s){return new vl(s._parameters,s._specification)}static serialize(s){return{_parameters:s._parameters,_specification:s._specification}}}function _a(u){let s=null;if(u instanceof Yt)s=_a(u.result);else if(u instanceof mo){for(const h of u.args)if(s=_a(h),s)break}else(u instanceof go||u instanceof mr)&&u.input instanceof Xr&&u.input.name==="zoom"&&(s=u);return s instanceof Et||u.eachChild(h=>{const d=_a(h);d instanceof Et?s=d:!s&&d?s=new Et("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):s&&d&&s!==d&&(s=new Et("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),s}function bl(u){if(u===!0||u===!1)return!0;if(!Array.isArray(u)||u.length===0)return!1;switch(u[0]){case"has":return u.length>=2&&u[1]!=="$id"&&u[1]!=="$type";case"in":return u.length>=3&&(typeof u[1]!="string"||Array.isArray(u[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return u.length!==3||Array.isArray(u[1])||Array.isArray(u[2]);case"any":case"all":for(const s of u.slice(1))if(!bl(s)&&typeof s!="boolean")return!1;return!0;default:return!0}}const eg={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Yc(u){if(u==null)return{filter:()=>!0,needGeometry:!1};bl(u)||(u=ya(u));const s=xl(u,eg);if(s.result==="error")throw new Error(s.value.map(h=>`${h.key}: ${h.message}`).join(", "));return{filter:(h,d,m)=>s.value.evaluate(h,d,{},m),needGeometry:Kc(u)}}function lf(u,s){return u<s?-1:u>s?1:0}function Kc(u){if(!Array.isArray(u))return!1;if(u[0]==="within"||u[0]==="distance")return!0;for(let s=1;s<u.length;s++)if(Kc(u[s]))return!0;return!1}function ya(u){if(!u)return!0;const s=u[0];return u.length<=1?s!=="any":s==="=="?wl(u[1],u[2],"=="):s==="!="?Ao(wl(u[1],u[2],"==")):s==="<"||s===">"||s==="<="||s===">="?wl(u[1],u[2],s):s==="any"?(h=u.slice(1),["any"].concat(h.map(ya))):s==="all"?["all"].concat(u.slice(1).map(ya)):s==="none"?["all"].concat(u.slice(1).map(ya).map(Ao)):s==="in"?Tl(u[1],u.slice(2)):s==="!in"?Ao(Tl(u[1],u.slice(2))):s==="has"?Sl(u[1]):s!=="!has"||Ao(Sl(u[1]));var h}function wl(u,s,h){switch(u){case"$type":return[`filter-type-${h}`,s];case"$id":return[`filter-id-${h}`,s];default:return[`filter-${h}`,u,s]}}function Tl(u,s){if(s.length===0)return!1;switch(u){case"$type":return["filter-type-in",["literal",s]];case"$id":return["filter-id-in",["literal",s]];default:return s.length>200&&!s.some(h=>typeof h!=typeof s[0])?["filter-in-large",u,["literal",s.sort(lf)]]:["filter-in-small",u,["literal",s]]}}function Sl(u){switch(u){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",u]}}function Ao(u){return["!",u]}function Po(u){const s=typeof u;if(s==="number"||s==="boolean"||s==="string"||u==null)return JSON.stringify(u);if(Array.isArray(u)){let m="[";for(const v of u)m+=`${Po(v)},`;return`${m}]`}const h=Object.keys(u).sort();let d="{";for(let m=0;m<h.length;m++)d+=`${JSON.stringify(h[m])}:${Po(u[h[m]])},`;return`${d}}`}function tg(u){let s="";for(const h of le)s+=`/${Po(u[h])}`;return s}function cf(u){const s=u.value;return s?[new Ue(u.key,s,"constants have been deprecated as of v8")]:[]}function Bi(u){return u instanceof Number||u instanceof String||u instanceof Boolean?u.valueOf():u}function Ls(u){if(Array.isArray(u))return u.map(Ls);if(u instanceof Object&&!(u instanceof Number||u instanceof String||u instanceof Boolean)){const s={};for(const h in u)s[h]=Ls(u[h]);return s}return Bi(u)}function qr(u){const s=u.key,h=u.value,d=u.valueSpec||{},m=u.objectElementValidators||{},v=u.style,b=u.styleSpec,S=u.validateSpec;let E=[];const C=Qt(h);if(C!=="object")return[new Ue(s,h,`object expected, ${C} found`)];for(const k in h){const D=k.split(".")[0],z=d[D]||d["*"];let V;if(m[D])V=m[D];else if(d[D])V=S;else if(m["*"])V=m["*"];else{if(!d["*"]){E.push(new Ue(s,h[k],`unknown property "${k}"`));continue}V=S}E=E.concat(V({key:(s&&`${s}.`)+k,value:h[k],valueSpec:z,style:v,styleSpec:b,object:h,objectKey:k,validateSpec:S},h))}for(const k in d)m[k]||d[k].required&&d[k].default===void 0&&h[k]===void 0&&E.push(new Ue(s,h,`missing required property "${k}"`));return E}function Jc(u){const s=u.value,h=u.valueSpec,d=u.style,m=u.styleSpec,v=u.key,b=u.arrayElementValidator||u.validateSpec;if(Qt(s)!=="array")return[new Ue(v,s,`array expected, ${Qt(s)} found`)];if(h.length&&s.length!==h.length)return[new Ue(v,s,`array length ${h.length} expected, length ${s.length} found`)];if(h["min-length"]&&s.length<h["min-length"])return[new Ue(v,s,`array length at least ${h["min-length"]} expected, length ${s.length} found`)];let S={type:h.value,values:h.values};m.$version<7&&(S.function=h.function),Qt(h.value)==="object"&&(S=h.value);let E=[];for(let C=0;C<s.length;C++)E=E.concat(b({array:s,arrayIndex:C,value:s[C],valueSpec:S,validateSpec:u.validateSpec,style:d,styleSpec:m,key:`${v}[${C}]`}));return E}function Al(u){const s=u.key,h=u.value,d=u.valueSpec;let m=Qt(h);return m==="number"&&h!=h&&(m="NaN"),m!=="number"?[new Ue(s,h,`number expected, ${m} found`)]:"minimum"in d&&h<d.minimum?[new Ue(s,h,`${h} is less than the minimum value ${d.minimum}`)]:"maximum"in d&&h>d.maximum?[new Ue(s,h,`${h} is greater than the maximum value ${d.maximum}`)]:[]}function Qc(u){const s=u.valueSpec,h=Bi(u.value.type);let d,m,v,b={};const S=h!=="categorical"&&u.value.property===void 0,E=!S,C=Qt(u.value.stops)==="array"&&Qt(u.value.stops[0])==="array"&&Qt(u.value.stops[0][0])==="object",k=qr({key:u.key,value:u.value,valueSpec:u.styleSpec.function,validateSpec:u.validateSpec,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(V){if(h==="identity")return[new Ue(V.key,V.value,'identity function may not have a "stops" property')];let $=[];const H=V.value;return $=$.concat(Jc({key:V.key,value:H,valueSpec:V.valueSpec,validateSpec:V.validateSpec,style:V.style,styleSpec:V.styleSpec,arrayElementValidator:D})),Qt(H)==="array"&&H.length===0&&$.push(new Ue(V.key,H,"array must have at least one stop")),$},default:function(V){return V.validateSpec({key:V.key,value:V.value,valueSpec:s,validateSpec:V.validateSpec,style:V.style,styleSpec:V.styleSpec})}}});return h==="identity"&&S&&k.push(new Ue(u.key,u.value,'missing required property "property"')),h==="identity"||u.value.stops||k.push(new Ue(u.key,u.value,'missing required property "stops"')),h==="exponential"&&u.valueSpec.expression&&!Zc(u.valueSpec)&&k.push(new Ue(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(E&&!To(u.valueSpec)?k.push(new Ue(u.key,u.value,"property functions not supported")):S&&!rf(u.valueSpec)&&k.push(new Ue(u.key,u.value,"zoom functions not supported"))),h!=="categorical"&&!C||u.value.property!==void 0||k.push(new Ue(u.key,u.value,'"property" property is required')),k;function D(V){let $=[];const H=V.value,J=V.key;if(Qt(H)!=="array")return[new Ue(J,H,`array expected, ${Qt(H)} found`)];if(H.length!==2)return[new Ue(J,H,`array length 2 expected, length ${H.length} found`)];if(C){if(Qt(H[0])!=="object")return[new Ue(J,H,`object expected, ${Qt(H[0])} found`)];if(H[0].zoom===void 0)return[new Ue(J,H,"object stop key must have zoom")];if(H[0].value===void 0)return[new Ue(J,H,"object stop key must have value")];if(v&&v>Bi(H[0].zoom))return[new Ue(J,H[0].zoom,"stop zoom values must appear in ascending order")];Bi(H[0].zoom)!==v&&(v=Bi(H[0].zoom),m=void 0,b={}),$=$.concat(qr({key:`${J}[0]`,value:H[0],valueSpec:{zoom:{}},validateSpec:V.validateSpec,style:V.style,styleSpec:V.styleSpec,objectElementValidators:{zoom:Al,value:z}}))}else $=$.concat(z({key:`${J}[0]`,value:H[0],validateSpec:V.validateSpec,style:V.style,styleSpec:V.styleSpec},H));return ma(Ls(H[1]))?$.concat([new Ue(`${J}[1]`,H[1],"expressions are not allowed in function stops.")]):$.concat(V.validateSpec({key:`${J}[1]`,value:H[1],valueSpec:s,validateSpec:V.validateSpec,style:V.style,styleSpec:V.styleSpec}))}function z(V,$){const H=Qt(V.value),J=Bi(V.value),re=V.value!==null?V.value:$;if(d){if(H!==d)return[new Ue(V.key,re,`${H} stop domain type must match previous stop domain type ${d}`)]}else d=H;if(H!=="number"&&H!=="string"&&H!=="boolean")return[new Ue(V.key,re,"stop domain value must be a number, string, or boolean")];if(H!=="number"&&h!=="categorical"){let me=`number expected, ${H} found`;return To(s)&&h===void 0&&(me+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ue(V.key,re,me)]}return h!=="categorical"||H!=="number"||isFinite(J)&&Math.floor(J)===J?h!=="categorical"&&H==="number"&&m!==void 0&&J<m?[new Ue(V.key,re,"stop domain values must appear in ascending order")]:(m=J,h==="categorical"&&J in b?[new Ue(V.key,re,"stop domain values must be unique")]:(b[J]=!0,[])):[new Ue(V.key,re,`integer expected, found ${J}`)]}}function Fn(u){const s=(u.expressionContext==="property"?af:xl)(Ls(u.value),u.valueSpec);if(s.result==="error")return s.value.map(d=>new Ue(`${u.key}${d.key}`,u.value,d.message));const h=s.value.expression||s.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!h.outputDefined())return[new Ue(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!pa(h))return[new Ue(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter"&&!pa(h))return[new Ue(u.key,u.value,'"feature-state" data expressions are not supported with filters.')];if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!_l(h,["zoom","feature-state"]))return[new Ue(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!ml(h))return[new Ue(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function xa(u){const s=u.key,h=u.value,d=u.valueSpec,m=[];return Array.isArray(d.values)?d.values.indexOf(Bi(h))===-1&&m.push(new Ue(s,h,`expected one of [${d.values.join(", ")}], ${JSON.stringify(h)} found`)):Object.keys(d.values).indexOf(Bi(h))===-1&&m.push(new Ue(s,h,`expected one of [${Object.keys(d.values).join(", ")}], ${JSON.stringify(h)} found`)),m}function Pl(u){return bl(Ls(u.value))?Fn(Ft({},u,{expressionContext:"filter",valueSpec:{value:"boolean"}})):eu(u)}function eu(u){const s=u.value,h=u.key;if(Qt(s)!=="array")return[new Ue(h,s,`array expected, ${Qt(s)} found`)];const d=u.styleSpec;let m,v=[];if(s.length<1)return[new Ue(h,s,"filter array must have at least 1 element")];switch(v=v.concat(xa({key:`${h}[0]`,value:s[0],valueSpec:d.filter_operator,style:u.style,styleSpec:u.styleSpec})),Bi(s[0])){case"<":case"<=":case">":case">=":s.length>=2&&Bi(s[1])==="$type"&&v.push(new Ue(h,s,`"$type" cannot be use with operator "${s[0]}"`));case"==":case"!=":s.length!==3&&v.push(new Ue(h,s,`filter array for operator "${s[0]}" must have 3 elements`));case"in":case"!in":s.length>=2&&(m=Qt(s[1]),m!=="string"&&v.push(new Ue(`${h}[1]`,s[1],`string expected, ${m} found`)));for(let b=2;b<s.length;b++)m=Qt(s[b]),Bi(s[1])==="$type"?v=v.concat(xa({key:`${h}[${b}]`,value:s[b],valueSpec:d.geometry_type,style:u.style,styleSpec:u.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&v.push(new Ue(`${h}[${b}]`,s[b],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let b=1;b<s.length;b++)v=v.concat(eu({key:`${h}[${b}]`,value:s[b],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":m=Qt(s[1]),s.length!==2?v.push(new Ue(h,s,`filter array for "${s[0]}" operator must have 2 elements`)):m!=="string"&&v.push(new Ue(`${h}[1]`,s[1],`string expected, ${m} found`))}return v}function uf(u,s){const h=u.key,d=u.validateSpec,m=u.style,v=u.styleSpec,b=u.value,S=u.objectKey,E=v[`${s}_${u.layerType}`];if(!E)return[];const C=S.match(/^(.*)-transition$/);if(s==="paint"&&C&&E[C[1]]&&E[C[1]].transition)return d({key:h,value:b,valueSpec:v.transition,style:m,styleSpec:v});const k=u.valueSpec||E[S];if(!k)return[new Ue(h,b,`unknown property "${S}"`)];let D;if(Qt(b)==="string"&&To(k)&&!k.tokens&&(D=/^{([^}]+)}$/.exec(b)))return[new Ue(h,b,`"${S}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(D[1])} }\`.`)];const z=[];return u.layerType==="symbol"&&(S==="text-field"&&m&&!m.glyphs&&z.push(new Ue(h,b,'use of "text-field" requires a style "glyphs" property')),S==="text-font"&&yl(Ls(b))&&Bi(b.type)==="identity"&&z.push(new Ue(h,b,'"text-font" does not support identity functions'))),z.concat(d({key:u.key,value:b,valueSpec:k,style:m,styleSpec:v,expressionContext:"property",propertyType:s,propertyKey:S}))}function tu(u){return uf(u,"paint")}function iu(u){return uf(u,"layout")}function Eo(u){let s=[];const h=u.value,d=u.key,m=u.style,v=u.styleSpec;h.type||h.ref||s.push(new Ue(d,h,'either "type" or "ref" is required'));let b=Bi(h.type);const S=Bi(h.ref);if(h.id){const E=Bi(h.id);for(let C=0;C<u.arrayIndex;C++){const k=m.layers[C];Bi(k.id)===E&&s.push(new Ue(d,h.id,`duplicate layer id "${h.id}", previously used at line ${k.id.__line__}`))}}if("ref"in h){let E;["type","source","source-layer","filter","layout"].forEach(C=>{C in h&&s.push(new Ue(d,h[C],`"${C}" is prohibited for ref layers`))}),m.layers.forEach(C=>{Bi(C.id)===S&&(E=C)}),E?E.ref?s.push(new Ue(d,h.ref,"ref cannot reference another ref layer")):b=Bi(E.type):s.push(new Ue(d,h.ref,`ref layer "${S}" not found`))}else if(b!=="background")if(h.source){const E=m.sources&&m.sources[h.source],C=E&&Bi(E.type);E?C==="vector"&&b==="raster"?s.push(new Ue(d,h.source,`layer "${h.id}" requires a raster source`)):C!=="raster-dem"&&b==="hillshade"?s.push(new Ue(d,h.source,`layer "${h.id}" requires a raster-dem source`)):C==="raster"&&b!=="raster"?s.push(new Ue(d,h.source,`layer "${h.id}" requires a vector source`)):C!=="vector"||h["source-layer"]?C==="raster-dem"&&b!=="hillshade"?s.push(new Ue(d,h.source,"raster-dem source can only be used with layer type 'hillshade'.")):b!=="line"||!h.paint||!h.paint["line-gradient"]||C==="geojson"&&E.lineMetrics||s.push(new Ue(d,h,`layer "${h.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):s.push(new Ue(d,h,`layer "${h.id}" must specify a "source-layer"`)):s.push(new Ue(d,h.source,`source "${h.source}" not found`))}else s.push(new Ue(d,h,'missing required property "source"'));return s=s.concat(qr({key:d,value:h,valueSpec:v.layer,style:u.style,styleSpec:u.styleSpec,validateSpec:u.validateSpec,objectElementValidators:{"*":()=>[],type:()=>u.validateSpec({key:`${d}.type`,value:h.type,valueSpec:v.layer.type,style:u.style,styleSpec:u.styleSpec,validateSpec:u.validateSpec,object:h,objectKey:"type"}),filter:Pl,layout:E=>qr({layer:h,key:E.key,value:E.value,style:E.style,styleSpec:E.styleSpec,validateSpec:E.validateSpec,objectElementValidators:{"*":C=>iu(Ft({layerType:b},C))}}),paint:E=>qr({layer:h,key:E.key,value:E.value,style:E.style,styleSpec:E.styleSpec,validateSpec:E.validateSpec,objectElementValidators:{"*":C=>tu(Ft({layerType:b},C))}})}})),s}function Bs(u){const s=u.value,h=u.key,d=Qt(s);return d!=="string"?[new Ue(h,s,`string expected, ${d} found`)]:[]}const hf={promoteId:function({key:u,value:s}){if(Qt(s)==="string")return Bs({key:u,value:s});{const h=[];for(const d in s)h.push(...Bs({key:`${u}.${d}`,value:s[d]}));return h}}};function ff(u){const s=u.value,h=u.key,d=u.styleSpec,m=u.style,v=u.validateSpec;if(!s.type)return[new Ue(h,s,'"type" is required')];const b=Bi(s.type);let S;switch(b){case"vector":case"raster":return S=qr({key:h,value:s,valueSpec:d[`source_${b.replace("-","_")}`],style:u.style,styleSpec:d,objectElementValidators:hf,validateSpec:v}),S;case"raster-dem":return S=function(E){var C;const k=(C=E.sourceName)!==null&&C!==void 0?C:"",D=E.value,z=E.styleSpec,V=z.source_raster_dem,$=E.style;let H=[];const J=Qt(D);if(D===void 0)return H;if(J!=="object")return H.push(new Ue("source_raster_dem",D,`object expected, ${J} found`)),H;const re=Bi(D.encoding)==="custom",me=["redFactor","greenFactor","blueFactor","baseShift"],oe=E.value.encoding?`"${E.value.encoding}"`:"Default";for(const U in D)!re&&me.includes(U)?H.push(new Ue(U,D[U],`In "${k}": "${U}" is only valid when "encoding" is set to "custom". ${oe} encoding found`)):V[U]?H=H.concat(E.validateSpec({key:U,value:D[U],valueSpec:V[U],validateSpec:E.validateSpec,style:$,styleSpec:z})):H.push(new Ue(U,D[U],`unknown property "${U}"`));return H}({sourceName:h,value:s,style:u.style,styleSpec:d,validateSpec:v}),S;case"geojson":if(S=qr({key:h,value:s,valueSpec:d.source_geojson,style:m,styleSpec:d,validateSpec:v,objectElementValidators:hf}),s.cluster)for(const E in s.clusterProperties){const[C,k]=s.clusterProperties[E],D=typeof C=="string"?[C,["accumulated"],["get",E]]:C;S.push(...Fn({key:`${h}.${E}.map`,value:k,expressionContext:"cluster-map"})),S.push(...Fn({key:`${h}.${E}.reduce`,value:D,expressionContext:"cluster-reduce"}))}return S;case"video":return qr({key:h,value:s,valueSpec:d.source_video,style:m,validateSpec:v,styleSpec:d});case"image":return qr({key:h,value:s,valueSpec:d.source_image,style:m,validateSpec:v,styleSpec:d});case"canvas":return[new Ue(h,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return xa({key:`${h}.type`,value:s.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function df(u){const s=u.value,h=u.styleSpec,d=h.light,m=u.style;let v=[];const b=Qt(s);if(s===void 0)return v;if(b!=="object")return v=v.concat([new Ue("light",s,`object expected, ${b} found`)]),v;for(const S in s){const E=S.match(/^(.*)-transition$/);v=v.concat(E&&d[E[1]]&&d[E[1]].transition?u.validateSpec({key:S,value:s[S],valueSpec:h.transition,validateSpec:u.validateSpec,style:m,styleSpec:h}):d[S]?u.validateSpec({key:S,value:s[S],valueSpec:d[S],validateSpec:u.validateSpec,style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)])}return v}function pf(u){const s=u.value,h=u.styleSpec,d=h.sky,m=u.style,v=Qt(s);if(s===void 0)return[];if(v!=="object")return[new Ue("sky",s,`object expected, ${v} found`)];let b=[];for(const S in s)b=b.concat(d[S]?u.validateSpec({key:S,value:s[S],valueSpec:d[S],style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)]);return b}function gf(u){const s=u.value,h=u.styleSpec,d=h.terrain,m=u.style;let v=[];const b=Qt(s);if(s===void 0)return v;if(b!=="object")return v=v.concat([new Ue("terrain",s,`object expected, ${b} found`)]),v;for(const S in s)v=v.concat(d[S]?u.validateSpec({key:S,value:s[S],valueSpec:d[S],validateSpec:u.validateSpec,style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)]);return v}function Io(u){let s=[];const h=u.value,d=u.key;if(Array.isArray(h)){const m=[],v=[];for(const b in h)h[b].id&&m.includes(h[b].id)&&s.push(new Ue(d,h,`all the sprites' ids must be unique, but ${h[b].id} is duplicated`)),m.push(h[b].id),h[b].url&&v.includes(h[b].url)&&s.push(new Ue(d,h,`all the sprites' URLs must be unique, but ${h[b].url} is duplicated`)),v.push(h[b].url),s=s.concat(qr({key:`${d}[${b}]`,value:h[b],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:u.validateSpec}));return s}return Bs({key:d,value:h})}const Co={"*":()=>[],array:Jc,boolean:function(u){const s=u.value,h=u.key,d=Qt(s);return d!=="boolean"?[new Ue(h,s,`boolean expected, ${d} found`)]:[]},number:Al,color:function(u){const s=u.key,h=u.value,d=Qt(h);return d!=="string"?[new Ue(s,h,`color expected, ${d} found`)]:Jt.parse(String(h))?[]:[new Ue(s,h,`color expected, "${h}" found`)]},constants:cf,enum:xa,filter:Pl,function:Qc,layer:Eo,object:qr,source:ff,light:df,sky:pf,terrain:gf,projection:function(u){const s=u.value,h=u.styleSpec,d=h.projection,m=u.style,v=Qt(s);if(s===void 0)return[];if(v!=="object")return[new Ue("projection",s,`object expected, ${v} found`)];let b=[];for(const S in s)b=b.concat(d[S]?u.validateSpec({key:S,value:s[S],valueSpec:d[S],style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)]);return b},projectionDefinition:function(u){const s=u.key;let h=u.value;h=h instanceof String?h.valueOf():h;const d=Qt(h);return d!=="array"||function(m){return Array.isArray(m)&&m.length===3&&typeof m[0]=="string"&&typeof m[1]=="string"&&typeof m[2]=="number"}(h)||function(m){return!!["interpolate","step","literal"].includes(m[0])}(h)?["array","string"].includes(d)?[]:[new Ue(s,h,`projection expected, invalid type "${d}" found`)]:[new Ue(s,h,`projection expected, invalid array ${JSON.stringify(h)} found`)]},string:Bs,formatted:function(u){return Bs(u).length===0?[]:Fn(u)},resolvedImage:function(u){return Bs(u).length===0?[]:Fn(u)},padding:function(u){const s=u.key,h=u.value;if(Qt(h)==="array"){if(h.length<1||h.length>4)return[new Ue(s,h,`padding requires 1 to 4 values; ${h.length} values found`)];const d={type:"number"};let m=[];for(let v=0;v<h.length;v++)m=m.concat(u.validateSpec({key:`${s}[${v}]`,value:h[v],validateSpec:u.validateSpec,valueSpec:d}));return m}return Al({key:s,value:h,valueSpec:{}})},variableAnchorOffsetCollection:function(u){const s=u.key,h=u.value,d=Qt(h),m=u.styleSpec;if(d!=="array"||h.length<1||h.length%2!=0)return[new Ue(s,h,"variableAnchorOffsetCollection requires a non-empty array of even length")];let v=[];for(let b=0;b<h.length;b+=2)v=v.concat(xa({key:`${s}[${b}]`,value:h[b],valueSpec:m.layout_symbol["text-anchor"]})),v=v.concat(Jc({key:`${s}[${b+1}]`,value:h[b+1],valueSpec:{length:2,value:"number"},validateSpec:u.validateSpec,style:u.style,styleSpec:m}));return v},sprite:Io};function _r(u){const s=u.value,h=u.valueSpec,d=u.styleSpec;return u.validateSpec=_r,h.expression&&yl(Bi(s))?Qc(u):h.expression&&ma(Ls(s))?Fn(u):h.type&&Co[h.type]?Co[h.type](u):qr(Ft({},u,{valueSpec:h.type?d[h.type]:h}))}function Mo(u){const s=u.value,h=u.key,d=Bs(u);return d.length||(s.indexOf("{fontstack}")===-1&&d.push(new Ue(h,s,'"glyphs" url must include a "{fontstack}" token')),s.indexOf("{range}")===-1&&d.push(new Ue(h,s,'"glyphs" url must include a "{range}" token'))),d}function Gr(u,s=j){let h=[];return h=h.concat(_r({key:"",value:u,valueSpec:s.$root,styleSpec:s,style:u,validateSpec:_r,objectElementValidators:{glyphs:Mo,"*":()=>[]}})),u.constants&&(h=h.concat(cf({key:"constants",value:u.constants}))),mf(h)}function _n(u){return function(s){return u({...s,validateSpec:_r})}}function mf(u){return[].concat(u).sort((s,h)=>s.line-h.line)}function Rr(u){return function(...s){return mf(u.apply(this,s))}}Gr.source=Rr(_n(ff)),Gr.sprite=Rr(_n(Io)),Gr.glyphs=Rr(_n(Mo)),Gr.light=Rr(_n(df)),Gr.sky=Rr(_n(pf)),Gr.terrain=Rr(_n(gf)),Gr.layer=Rr(_n(Eo)),Gr.filter=Rr(_n(Pl)),Gr.paintProperty=Rr(_n(tu)),Gr.layoutProperty=Rr(_n(iu));const Ns=Gr,ru=Ns.light,ig=Ns.sky,nu=Ns.paintProperty,rg=Ns.layoutProperty;function Ro(u,s){let h=!1;if(s&&s.length)for(const d of s)u.fire(new Z(new Error(d.message))),h=!0;return h}class va{constructor(s,h,d){const m=this.cells=[];if(s instanceof ArrayBuffer){this.arrayBuffer=s;const b=new Int32Array(this.arrayBuffer);s=b[0],this.d=(h=b[1])+2*(d=b[2]);for(let E=0;E<this.d*this.d;E++){const C=b[3+E],k=b[3+E+1];m.push(C===k?null:b.subarray(C,k))}const S=b[3+m.length+1];this.keys=b.subarray(b[3+m.length],S),this.bboxes=b.subarray(S),this.insert=this._insertReadonly}else{this.d=h+2*d;for(let b=0;b<this.d*this.d;b++)m.push([]);this.keys=[],this.bboxes=[]}this.n=h,this.extent=s,this.padding=d,this.scale=h/s,this.uid=0;const v=d/h*s;this.min=-v,this.max=s+v}insert(s,h,d,m,v){this._forEachCell(h,d,m,v,this._insertCell,this.uid++,void 0,void 0),this.keys.push(s),this.bboxes.push(h),this.bboxes.push(d),this.bboxes.push(m),this.bboxes.push(v)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(s,h,d,m,v,b){this.cells[v].push(b)}query(s,h,d,m,v){const b=this.min,S=this.max;if(s<=b&&h<=b&&S<=d&&S<=m&&!v)return Array.prototype.slice.call(this.keys);{const E=[];return this._forEachCell(s,h,d,m,this._queryCell,E,{},v),E}}_queryCell(s,h,d,m,v,b,S,E){const C=this.cells[v];if(C!==null){const k=this.keys,D=this.bboxes;for(let z=0;z<C.length;z++){const V=C[z];if(S[V]===void 0){const $=4*V;(E?E(D[$+0],D[$+1],D[$+2],D[$+3]):s<=D[$+2]&&h<=D[$+3]&&d>=D[$+0]&&m>=D[$+1])?(S[V]=!0,b.push(k[V])):S[V]=!1}}}}_forEachCell(s,h,d,m,v,b,S,E){const C=this._convertToCellCoord(s),k=this._convertToCellCoord(h),D=this._convertToCellCoord(d),z=this._convertToCellCoord(m);for(let V=C;V<=D;V++)for(let $=k;$<=z;$++){const H=this.d*$+V;if((!E||E(this._convertFromCellCoord(V),this._convertFromCellCoord($),this._convertFromCellCoord(V+1),this._convertFromCellCoord($+1)))&&v.call(this,s,h,d,m,H,b,S,E))return}}_convertFromCellCoord(s){return(s-this.padding)/this.scale}_convertToCellCoord(s){return Math.max(0,Math.min(this.d-1,Math.floor(s*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const s=this.cells,h=3+this.cells.length+1+1;let d=0;for(let b=0;b<this.cells.length;b++)d+=this.cells[b].length;const m=new Int32Array(h+d+this.keys.length+this.bboxes.length);m[0]=this.extent,m[1]=this.n,m[2]=this.padding;let v=h;for(let b=0;b<s.length;b++){const S=s[b];m[3+b]=v,m.set(S,v),v+=S.length}return m[3+s.length]=v,m.set(this.keys,v),v+=this.keys.length,m[3+s.length+1]=v,m.set(this.bboxes,v),v+=this.bboxes.length,m.buffer}static serialize(s,h){const d=s.toArrayBuffer();return h&&h.push(d),{buffer:d}}static deserialize(s){return new va(s.buffer)}}const zr={};function mt(u,s,h={}){if(zr[u])throw new Error(`${u} is already registered.`);Object.defineProperty(s,"_classRegistryKey",{value:u,writeable:!1}),zr[u]={klass:s,omit:h.omit||[],shallow:h.shallow||[]}}mt("Object",Object),mt("TransferableGridIndex",va),mt("Color",Jt),mt("Error",Error),mt("AJAXError",dn),mt("ResolvedImage",Cr),mt("StylePropertyFunction",vl),mt("StyleExpression",So,{omit:["_evaluator"]}),mt("ZoomDependentExpression",Gc),mt("ZoomConstantExpression",qc),mt("CompoundExpression",Xr,{omit:["_evaluate"]});for(const u in bo)bo[u]._classRegistryKey||mt(`Expression_${u}`,bo[u]);function _f(u){return u&&typeof ArrayBuffer<"u"&&(u instanceof ArrayBuffer||u.constructor&&u.constructor.name==="ArrayBuffer")}function ko(u){return u.$name||u.constructor._classRegistryKey}function yf(u){return!function(s){if(s===null||typeof s!="object")return!1;const h=ko(s);return!(!h||h==="Object")}(u)&&(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp||u instanceof Blob||u instanceof Error||_f(u)||qt(u)||ArrayBuffer.isView(u)||u instanceof ImageData)}function zs(u,s){if(yf(u))return(_f(u)||qt(u))&&s&&s.push(u),ArrayBuffer.isView(u)&&s&&s.push(u.buffer),u instanceof ImageData&&s&&s.push(u.data.buffer),u;if(Array.isArray(u)){const v=[];for(const b of u)v.push(zs(b,s));return v}if(typeof u!="object")throw new Error("can't serialize object of type "+typeof u);const h=ko(u);if(!h)throw new Error(`can't serialize object of unregistered class ${u.constructor.name}`);if(!zr[h])throw new Error(`${h} is not registered.`);const{klass:d}=zr[h],m=d.serialize?d.serialize(u,s):{};if(d.serialize){if(s&&m===s[s.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const v in u){if(!u.hasOwnProperty(v)||zr[h].omit.indexOf(v)>=0)continue;const b=u[v];m[v]=zr[h].shallow.indexOf(v)>=0?b:zs(b,s)}u instanceof Error&&(m.message=u.message)}if(m.$name)throw new Error("$name property is reserved for worker serialization logic.");return h!=="Object"&&(m.$name=h),m}function as(u){if(yf(u))return u;if(Array.isArray(u))return u.map(as);if(typeof u!="object")throw new Error("can't deserialize object of type "+typeof u);const s=ko(u)||"Object";if(!zr[s])throw new Error(`can't deserialize unregistered class ${s}`);const{klass:h}=zr[s];if(!h)throw new Error(`can't deserialize unregistered class ${s}`);if(h.deserialize)return h.deserialize(u);const d=Object.create(h.prototype);for(const m of Object.keys(u)){if(m==="$name")continue;const v=u[m];d[m]=zr[s].shallow.indexOf(m)>=0?v:as(v)}return d}class su{constructor(){this.first=!0}update(s,h){const d=Math.floor(s);return this.first?(this.first=!1,this.lastIntegerZoom=d,this.lastIntegerZoomTime=0,this.lastZoom=s,this.lastFloorZoom=d,!0):(this.lastFloorZoom>d?(this.lastIntegerZoom=d+1,this.lastIntegerZoomTime=h):this.lastFloorZoom<d&&(this.lastIntegerZoom=d,this.lastIntegerZoomTime=h),s!==this.lastZoom&&(this.lastZoom=s,this.lastFloorZoom=d,!0))}}const Ht={"Latin-1 Supplement":u=>u>=128&&u<=255,"Hangul Jamo":u=>u>=4352&&u<=4607,Khmer:u=>u>=6016&&u<=6143,"General Punctuation":u=>u>=8192&&u<=8303,"Letterlike Symbols":u=>u>=8448&&u<=8527,"Number Forms":u=>u>=8528&&u<=8591,"Miscellaneous Technical":u=>u>=8960&&u<=9215,"Control Pictures":u=>u>=9216&&u<=9279,"Optical Character Recognition":u=>u>=9280&&u<=9311,"Enclosed Alphanumerics":u=>u>=9312&&u<=9471,"Geometric Shapes":u=>u>=9632&&u<=9727,"Miscellaneous Symbols":u=>u>=9728&&u<=9983,"Miscellaneous Symbols and Arrows":u=>u>=11008&&u<=11263,"Ideographic Description Characters":u=>u>=12272&&u<=12287,"CJK Symbols and Punctuation":u=>u>=12288&&u<=12351,Hiragana:u=>u>=12352&&u<=12447,Katakana:u=>u>=12448&&u<=12543,Kanbun:u=>u>=12688&&u<=12703,"CJK Strokes":u=>u>=12736&&u<=12783,"Enclosed CJK Letters and Months":u=>u>=12800&&u<=13055,"CJK Compatibility":u=>u>=13056&&u<=13311,"Yijing Hexagram Symbols":u=>u>=19904&&u<=19967,"CJK Unified Ideographs":u=>u>=19968&&u<=40959,"Hangul Syllables":u=>u>=44032&&u<=55215,"Private Use Area":u=>u>=57344&&u<=63743,"Vertical Forms":u=>u>=65040&&u<=65055,"CJK Compatibility Forms":u=>u>=65072&&u<=65103,"Small Form Variants":u=>u>=65104&&u<=65135,"Halfwidth and Fullwidth Forms":u=>u>=65280&&u<=65519};function El(u){for(const s of u)if(au(s.charCodeAt(0)))return!0;return!1}function xf(u){for(const s of u)if(!ng(s.charCodeAt(0)))return!1;return!0}function ba(u){const s=u.map(h=>{try{return new RegExp(`\\p{sc=${h}}`,"u").source}catch{return null}}).filter(h=>h);return new RegExp(s.join("|"),"u")}const vf=ba(["Arab","Dupl","Mong","Ougr","Syrc"]);function ng(u){return!vf.test(String.fromCodePoint(u))}const ou=ba(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function au(u){return!(u!==746&&u!==747&&(u<4352||!(Ht["CJK Compatibility Forms"](u)&&!(u>=65097&&u<=65103)||Ht["CJK Compatibility"](u)||Ht["CJK Strokes"](u)||!(!Ht["CJK Symbols and Punctuation"](u)||u>=12296&&u<=12305||u>=12308&&u<=12319||u===12336)||Ht["Enclosed CJK Letters and Months"](u)||Ht["Ideographic Description Characters"](u)||Ht.Kanbun(u)||Ht.Katakana(u)&&u!==12540||!(!Ht["Halfwidth and Fullwidth Forms"](u)||u===65288||u===65289||u===65293||u>=65306&&u<=65310||u===65339||u===65341||u===65343||u>=65371&&u<=65503||u===65507||u>=65512&&u<=65519)||!(!Ht["Small Form Variants"](u)||u>=65112&&u<=65118||u>=65123&&u<=65126)||Ht["Vertical Forms"](u)||Ht["Yijing Hexagram Symbols"](u)||new RegExp("\\p{sc=Cans}","u").test(String.fromCodePoint(u))||new RegExp("\\p{sc=Hang}","u").test(String.fromCodePoint(u))||ou.test(String.fromCodePoint(u)))))}function lu(u){return!(au(u)||function(s){return!!(Ht["Latin-1 Supplement"](s)&&(s===167||s===169||s===174||s===177||s===188||s===189||s===190||s===215||s===247)||Ht["General Punctuation"](s)&&(s===8214||s===8224||s===8225||s===8240||s===8241||s===8251||s===8252||s===8258||s===8263||s===8264||s===8265||s===8273)||Ht["Letterlike Symbols"](s)||Ht["Number Forms"](s)||Ht["Miscellaneous Technical"](s)&&(s>=8960&&s<=8967||s>=8972&&s<=8991||s>=8996&&s<=9e3||s===9003||s>=9085&&s<=9114||s>=9150&&s<=9165||s===9167||s>=9169&&s<=9179||s>=9186&&s<=9215)||Ht["Control Pictures"](s)&&s!==9251||Ht["Optical Character Recognition"](s)||Ht["Enclosed Alphanumerics"](s)||Ht["Geometric Shapes"](s)||Ht["Miscellaneous Symbols"](s)&&!(s>=9754&&s<=9759)||Ht["Miscellaneous Symbols and Arrows"](s)&&(s>=11026&&s<=11055||s>=11088&&s<=11097||s>=11192&&s<=11243)||Ht["CJK Symbols and Punctuation"](s)||Ht.Katakana(s)||Ht["Private Use Area"](s)||Ht["CJK Compatibility Forms"](s)||Ht["Small Form Variants"](s)||Ht["Halfwidth and Fullwidth Forms"](s)||s===8734||s===8756||s===8757||s>=9984&&s<=10087||s>=10102&&s<=10131||s===65532||s===65533)}(u))}const bf=ba(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function cu(u){return bf.test(String.fromCodePoint(u))}function sg(u,s){return!(!s&&cu(u)||u>=2304&&u<=3583||u>=3840&&u<=4255||Ht.Khmer(u))}function og(u){for(const s of u)if(cu(s.charCodeAt(0)))return!0;return!1}const Ln=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(u){this.pluginStatus=u.pluginStatus,this.pluginURL=u.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(u){if(Ln.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=u.applyArabicShaping,this.processBidirectionalText=u.processBidirectionalText,this.processStyledBidirectionalText=u.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(u,s){return a(this,void 0,void 0,function*(){if(this.isParsed())return this.getState();if(u.pluginStatus!=="loading")return this.setState(u),u;const h=u.pluginURL,d=new Promise(v=>{this.loadScriptResolve=v});s(h);const m=new Promise(v=>setTimeout(()=>v(),this.TIMEOUT));if(yield Promise.race([d,m]),this.isParsed()){const v={pluginStatus:"loaded",pluginURL:h};return this.setState(v),v}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${h}`)})}};class yi{constructor(s,h){this.zoom=s,h?(this.now=h.now,this.fadeDuration=h.fadeDuration,this.zoomHistory=h.zoomHistory,this.transition=h.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new su,this.transition={})}isSupportedScript(s){return function(h,d){for(const m of h)if(!sg(m.charCodeAt(0),d))return!1;return!0}(s,Ln.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const s=this.zoom,h=s-Math.floor(s),d=this.crossFadingFactor();return s>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:h+(1-h)*d}:{fromScale:.5,toScale:1,t:1-(1-d)*h}}}class wa{constructor(s,h){this.property=s,this.value=h,this.expression=function(d,m){if(yl(d))return new vl(d,m);if(ma(d)){const v=af(d,m);if(v.result==="error")throw new Error(v.value.map(b=>`${b.key}: ${b.message}`).join(", "));return v.value}{let v=d;return m.type==="color"&&typeof d=="string"?v=Jt.parse(d):m.type!=="padding"||typeof d!="number"&&!Array.isArray(d)?m.type==="variableAnchorOffsetCollection"&&Array.isArray(d)?v=wr.parse(d):m.type==="projectionDefinition"&&typeof d=="string"&&(v=Yi.parse(d)):v=cr.parse(d),{kind:"constant",evaluate:()=>v}}}(h===void 0?s.specification.default:h,s.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(s,h,d){return this.property.possiblyEvaluate(this,s,h,d)}}class Il{constructor(s){this.property=s,this.value=new wa(s,void 0)}transitioned(s,h){return new wf(this.property,this.value,h,Tt({},s.transition,this.transition),s.now)}untransitioned(){return new wf(this.property,this.value,null,{},0)}}class Ta{constructor(s){this._properties=s,this._values=Object.create(s.defaultTransitionablePropertyValues)}getValue(s){return li(this._values[s].value.value)}setValue(s,h){Object.prototype.hasOwnProperty.call(this._values,s)||(this._values[s]=new Il(this._values[s].property)),this._values[s].value=new wa(this._values[s].property,h===null?void 0:li(h))}getTransition(s){return li(this._values[s].transition)}setTransition(s,h){Object.prototype.hasOwnProperty.call(this._values,s)||(this._values[s]=new Il(this._values[s].property)),this._values[s].transition=li(h)||void 0}serialize(){const s={};for(const h of Object.keys(this._values)){const d=this.getValue(h);d!==void 0&&(s[h]=d);const m=this.getTransition(h);m!==void 0&&(s[`${h}-transition`]=m)}return s}transitioned(s,h){const d=new Cl(this._properties);for(const m of Object.keys(this._values))d._values[m]=this._values[m].transitioned(s,h._values[m]);return d}untransitioned(){const s=new Cl(this._properties);for(const h of Object.keys(this._values))s._values[h]=this._values[h].untransitioned();return s}}class wf{constructor(s,h,d,m,v){this.property=s,this.value=h,this.begin=v+m.delay||0,this.end=this.begin+m.duration||0,s.specification.transition&&(m.delay||m.duration)&&(this.prior=d)}possiblyEvaluate(s,h,d){const m=s.now||0,v=this.value.possiblyEvaluate(s,h,d),b=this.prior;if(b){if(m>this.end)return this.prior=null,v;if(this.value.isDataDriven())return this.prior=null,v;if(m<this.begin)return b.possiblyEvaluate(s,h,d);{const S=(m-this.begin)/(this.end-this.begin);return this.property.interpolate(b.possiblyEvaluate(s,h,d),v,Qe(S))}}return v}}class Cl{constructor(s){this._properties=s,this._values=Object.create(s.defaultTransitioningPropertyValues)}possiblyEvaluate(s,h,d){const m=new Sa(this._properties);for(const v of Object.keys(this._values))m._values[v]=this._values[v].possiblyEvaluate(s,h,d);return m}hasTransition(){for(const s of Object.keys(this._values))if(this._values[s].prior)return!0;return!1}}class ag{constructor(s){this._properties=s,this._values=Object.create(s.defaultPropertyValues)}hasValue(s){return this._values[s].value!==void 0}getValue(s){return li(this._values[s].value)}setValue(s,h){this._values[s]=new wa(this._values[s].property,h===null?void 0:li(h))}serialize(){const s={};for(const h of Object.keys(this._values)){const d=this.getValue(h);d!==void 0&&(s[h]=d)}return s}possiblyEvaluate(s,h,d){const m=new Sa(this._properties);for(const v of Object.keys(this._values))m._values[v]=this._values[v].possiblyEvaluate(s,h,d);return m}}class yn{constructor(s,h,d){this.property=s,this.value=h,this.parameters=d}isConstant(){return this.value.kind==="constant"}constantOr(s){return this.value.kind==="constant"?this.value.value:s}evaluate(s,h,d,m){return this.property.evaluate(this.value,this.parameters,s,h,d,m)}}class Sa{constructor(s){this._properties=s,this._values=Object.create(s.defaultPossiblyEvaluatedValues)}get(s){return this._values[s]}}class St{constructor(s){this.specification=s}possiblyEvaluate(s,h){if(s.isDataDriven())throw new Error("Value should not be data driven");return s.expression.evaluate(h)}interpolate(s,h,d){const m=rn[this.specification.type];return m?m(s,h,d):s}}class Mt{constructor(s,h){this.specification=s,this.overrides=h}possiblyEvaluate(s,h,d,m){return new yn(this,s.expression.kind==="constant"||s.expression.kind==="camera"?{kind:"constant",value:s.expression.evaluate(h,null,{},d,m)}:s.expression,h)}interpolate(s,h,d){if(s.value.kind!=="constant"||h.value.kind!=="constant")return s;if(s.value.value===void 0||h.value.value===void 0)return new yn(this,{kind:"constant",value:void 0},s.parameters);const m=rn[this.specification.type];if(m){const v=m(s.value.value,h.value.value,d);return new yn(this,{kind:"constant",value:v},s.parameters)}return s}evaluate(s,h,d,m,v,b){return s.kind==="constant"?s.value:s.evaluate(h,d,m,v,b)}}class Ml extends Mt{possiblyEvaluate(s,h,d,m){if(s.value===void 0)return new yn(this,{kind:"constant",value:void 0},h);if(s.expression.kind==="constant"){const v=s.expression.evaluate(h,null,{},d,m),b=s.property.specification.type==="resolvedImage"&&typeof v!="string"?v.name:v,S=this._calculate(b,b,b,h);return new yn(this,{kind:"constant",value:S},h)}if(s.expression.kind==="camera"){const v=this._calculate(s.expression.evaluate({zoom:h.zoom-1}),s.expression.evaluate({zoom:h.zoom}),s.expression.evaluate({zoom:h.zoom+1}),h);return new yn(this,{kind:"constant",value:v},h)}return new yn(this,s.expression,h)}evaluate(s,h,d,m,v,b){if(s.kind==="source"){const S=s.evaluate(h,d,m,v,b);return this._calculate(S,S,S,h)}return s.kind==="composite"?this._calculate(s.evaluate({zoom:Math.floor(h.zoom)-1},d,m),s.evaluate({zoom:Math.floor(h.zoom)},d,m),s.evaluate({zoom:Math.floor(h.zoom)+1},d,m),h):s.value}_calculate(s,h,d,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:s,to:h}:{from:d,to:h}}interpolate(s){return s}}class uu{constructor(s){this.specification=s}possiblyEvaluate(s,h,d,m){if(s.value!==void 0){if(s.expression.kind==="constant"){const v=s.expression.evaluate(h,null,{},d,m);return this._calculate(v,v,v,h)}return this._calculate(s.expression.evaluate(new yi(Math.floor(h.zoom-1),h)),s.expression.evaluate(new yi(Math.floor(h.zoom),h)),s.expression.evaluate(new yi(Math.floor(h.zoom+1),h)),h)}}_calculate(s,h,d,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:s,to:h}:{from:d,to:h}}interpolate(s){return s}}class hu{constructor(s){this.specification=s}possiblyEvaluate(s,h,d,m){return!!s.expression.evaluate(h,null,{},d,m)}interpolate(){return!1}}class kr{constructor(s){this.properties=s,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const h in s){const d=s[h];d.specification.overridable&&this.overridableProperties.push(h);const m=this.defaultPropertyValues[h]=new wa(d,void 0),v=this.defaultTransitionablePropertyValues[h]=new Il(d);this.defaultTransitioningPropertyValues[h]=v.untransitioned(),this.defaultPossiblyEvaluatedValues[h]=m.possiblyEvaluate({})}}}mt("DataDrivenProperty",Mt),mt("DataConstantProperty",St),mt("CrossFadedDataDrivenProperty",Ml),mt("CrossFadedProperty",uu),mt("ColorRampProperty",hu);const Tf="-transition";class Tr extends q{constructor(s,h){if(super(),this.id=s.id,this.type=s.type,this._featureFilter={filter:()=>!0,needGeometry:!1},s.type!=="custom"&&(this.metadata=s.metadata,this.minzoom=s.minzoom,this.maxzoom=s.maxzoom,s.type!=="background"&&(this.source=s.source,this.sourceLayer=s["source-layer"],this.filter=s.filter),h.layout&&(this._unevaluatedLayout=new ag(h.layout)),h.paint)){this._transitionablePaint=new Ta(h.paint);for(const d in s.paint)this.setPaintProperty(d,s.paint[d],{validate:!1});for(const d in s.layout)this.setLayoutProperty(d,s.layout[d],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Sa(h.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(s){return s==="visibility"?this.visibility:this._unevaluatedLayout.getValue(s)}setLayoutProperty(s,h,d={}){h!=null&&this._validate(rg,`layers.${this.id}.layout.${s}`,s,h,d)||(s!=="visibility"?this._unevaluatedLayout.setValue(s,h):this.visibility=h)}getPaintProperty(s){return s.endsWith(Tf)?this._transitionablePaint.getTransition(s.slice(0,-11)):this._transitionablePaint.getValue(s)}setPaintProperty(s,h,d={}){if(h!=null&&this._validate(nu,`layers.${this.id}.paint.${s}`,s,h,d))return!1;if(s.endsWith(Tf))return this._transitionablePaint.setTransition(s.slice(0,-11),h||void 0),!1;{const m=this._transitionablePaint._values[s],v=m.property.specification["property-type"]==="cross-faded-data-driven",b=m.value.isDataDriven(),S=m.value;this._transitionablePaint.setValue(s,h),this._handleSpecialPaintPropertyUpdate(s);const E=this._transitionablePaint._values[s].value;return E.isDataDriven()||b||v||this._handleOverridablePaintPropertyUpdate(s,S,E)}}_handleSpecialPaintPropertyUpdate(s){}_handleOverridablePaintPropertyUpdate(s,h,d){return!1}isHidden(s){return!!(this.minzoom&&s<this.minzoom)||!!(this.maxzoom&&s>=this.maxzoom)||this.visibility==="none"}updateTransitions(s){this._transitioningPaint=this._transitionablePaint.transitioned(s,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(s,h){s.getCrossfadeParameters&&(this._crossfadeParameters=s.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(s,void 0,h)),this.paint=this._transitioningPaint.possiblyEvaluate(s,void 0,h)}serialize(){const s={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(s.layout=s.layout||{},s.layout.visibility=this.visibility),Xt(s,(h,d)=>!(h===void 0||d==="layout"&&!Object.keys(h).length||d==="paint"&&!Object.keys(h).length))}_validate(s,h,d,m,v={}){return(!v||v.validate!==!1)&&Ro(this,s.call(Ns,{key:h,layerType:this.type,objectKey:d,value:m,styleSpec:j,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const s in this.paint._values){const h=this.paint.get(s);if(h instanceof yn&&To(h.property.specification)&&(h.value.kind==="source"||h.value.kind==="composite")&&h.value.isStateDependent)return!0}return!1}}const lg={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Aa{constructor(s,h){this._structArray=s,this._pos1=h*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ri{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(s,h){return s._trim(),h&&(s.isTransferred=!0,h.push(s.arrayBuffer)),{length:s.length,arrayBuffer:s.arrayBuffer}}static deserialize(s){const h=Object.create(this.prototype);return h.arrayBuffer=s.arrayBuffer,h.length=s.length,h.capacity=s.arrayBuffer.byteLength/h.bytesPerElement,h._refreshViews(),h}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(s){this.reserve(s),this.length=s}reserve(s){if(s>this.capacity){this.capacity=Math.max(s,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const h=this.uint8;this._refreshViews(),h&&this.uint8.set(h)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Ni(u,s=1){let h=0,d=0;return{members:u.map(m=>{const v=lg[m.type].BYTES_PER_ELEMENT,b=h=Sf(h,Math.max(s,v)),S=m.components||1;return d=Math.max(d,v),h+=v*S,{name:m.name,type:m.type,components:S,offset:b}}),size:Sf(h,Math.max(d,s)),alignment:s}}function Sf(u,s){return Math.ceil(u/s)*s}class Pa extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h){const d=this.length;return this.resize(d+1),this.emplace(d,s,h)}emplace(s,h,d){const m=2*s;return this.int16[m+0]=h,this.int16[m+1]=d,s}}Pa.prototype.bytesPerElement=4,mt("StructArrayLayout2i4",Pa);class xn extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,d)}emplace(s,h,d,m){const v=3*s;return this.int16[v+0]=h,this.int16[v+1]=d,this.int16[v+2]=m,s}}xn.prototype.bytesPerElement=6,mt("StructArrayLayout3i6",xn);class Rl extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d,m){const v=this.length;return this.resize(v+1),this.emplace(v,s,h,d,m)}emplace(s,h,d,m,v){const b=4*s;return this.int16[b+0]=h,this.int16[b+1]=d,this.int16[b+2]=m,this.int16[b+3]=v,s}}Rl.prototype.bytesPerElement=8,mt("StructArrayLayout4i8",Rl);class Ea extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,d,m,v,b)}emplace(s,h,d,m,v,b,S){const E=6*s;return this.int16[E+0]=h,this.int16[E+1]=d,this.int16[E+2]=m,this.int16[E+3]=v,this.int16[E+4]=b,this.int16[E+5]=S,s}}Ea.prototype.bytesPerElement=12,mt("StructArrayLayout2i4i12",Ea);class kl extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,d,m,v,b)}emplace(s,h,d,m,v,b,S){const E=4*s,C=8*s;return this.int16[E+0]=h,this.int16[E+1]=d,this.uint8[C+4]=m,this.uint8[C+5]=v,this.uint8[C+6]=b,this.uint8[C+7]=S,s}}kl.prototype.bytesPerElement=8,mt("StructArrayLayout2i4ub8",kl);class Us extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h){const d=this.length;return this.resize(d+1),this.emplace(d,s,h)}emplace(s,h,d){const m=2*s;return this.float32[m+0]=h,this.float32[m+1]=d,s}}Us.prototype.bytesPerElement=8,mt("StructArrayLayout2f8",Us);class fu extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b,S,E,C,k){const D=this.length;return this.resize(D+1),this.emplace(D,s,h,d,m,v,b,S,E,C,k)}emplace(s,h,d,m,v,b,S,E,C,k,D){const z=10*s;return this.uint16[z+0]=h,this.uint16[z+1]=d,this.uint16[z+2]=m,this.uint16[z+3]=v,this.uint16[z+4]=b,this.uint16[z+5]=S,this.uint16[z+6]=E,this.uint16[z+7]=C,this.uint16[z+8]=k,this.uint16[z+9]=D,s}}fu.prototype.bytesPerElement=20,mt("StructArrayLayout10ui20",fu);class Do extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b,S,E,C,k,D,z){const V=this.length;return this.resize(V+1),this.emplace(V,s,h,d,m,v,b,S,E,C,k,D,z)}emplace(s,h,d,m,v,b,S,E,C,k,D,z,V){const $=12*s;return this.int16[$+0]=h,this.int16[$+1]=d,this.int16[$+2]=m,this.int16[$+3]=v,this.uint16[$+4]=b,this.uint16[$+5]=S,this.uint16[$+6]=E,this.uint16[$+7]=C,this.int16[$+8]=k,this.int16[$+9]=D,this.int16[$+10]=z,this.int16[$+11]=V,s}}Do.prototype.bytesPerElement=24,mt("StructArrayLayout4i4ui4i24",Do);class Vs extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,d)}emplace(s,h,d,m){const v=3*s;return this.float32[v+0]=h,this.float32[v+1]=d,this.float32[v+2]=m,s}}Vs.prototype.bytesPerElement=12,mt("StructArrayLayout3f12",Vs);class du extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(s){const h=this.length;return this.resize(h+1),this.emplace(h,s)}emplace(s,h){return this.uint32[1*s+0]=h,s}}du.prototype.bytesPerElement=4,mt("StructArrayLayout1ul4",du);class Dl extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b,S,E,C){const k=this.length;return this.resize(k+1),this.emplace(k,s,h,d,m,v,b,S,E,C)}emplace(s,h,d,m,v,b,S,E,C,k){const D=10*s,z=5*s;return this.int16[D+0]=h,this.int16[D+1]=d,this.int16[D+2]=m,this.int16[D+3]=v,this.int16[D+4]=b,this.int16[D+5]=S,this.uint32[z+3]=E,this.uint16[D+8]=C,this.uint16[D+9]=k,s}}Dl.prototype.bytesPerElement=20,mt("StructArrayLayout6i1ul2ui20",Dl);class js extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,d,m,v,b)}emplace(s,h,d,m,v,b,S){const E=6*s;return this.int16[E+0]=h,this.int16[E+1]=d,this.int16[E+2]=m,this.int16[E+3]=v,this.int16[E+4]=b,this.int16[E+5]=S,s}}js.prototype.bytesPerElement=12,mt("StructArrayLayout2i2i2i12",js);class pu extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v){const b=this.length;return this.resize(b+1),this.emplace(b,s,h,d,m,v)}emplace(s,h,d,m,v,b){const S=4*s,E=8*s;return this.float32[S+0]=h,this.float32[S+1]=d,this.float32[S+2]=m,this.int16[E+6]=v,this.int16[E+7]=b,s}}pu.prototype.bytesPerElement=16,mt("StructArrayLayout2f1f2i16",pu);class gu extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,d,m,v,b)}emplace(s,h,d,m,v,b,S){const E=16*s,C=4*s,k=8*s;return this.uint8[E+0]=h,this.uint8[E+1]=d,this.float32[C+1]=m,this.float32[C+2]=v,this.int16[k+6]=b,this.int16[k+7]=S,s}}gu.prototype.bytesPerElement=16,mt("StructArrayLayout2ub2f2i16",gu);class Ia extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,d)}emplace(s,h,d,m){const v=3*s;return this.uint16[v+0]=h,this.uint16[v+1]=d,this.uint16[v+2]=m,s}}Ia.prototype.bytesPerElement=6,mt("StructArrayLayout3ui6",Ia);class mu extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re){const me=this.length;return this.resize(me+1),this.emplace(me,s,h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re)}emplace(s,h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re,me){const oe=24*s,U=12*s,K=48*s;return this.int16[oe+0]=h,this.int16[oe+1]=d,this.uint16[oe+2]=m,this.uint16[oe+3]=v,this.uint32[U+2]=b,this.uint32[U+3]=S,this.uint32[U+4]=E,this.uint16[oe+10]=C,this.uint16[oe+11]=k,this.uint16[oe+12]=D,this.float32[U+7]=z,this.float32[U+8]=V,this.uint8[K+36]=$,this.uint8[K+37]=H,this.uint8[K+38]=J,this.uint32[U+10]=re,this.int16[oe+22]=me,s}}mu.prototype.bytesPerElement=48,mt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",mu);class _ extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re,me,oe,U,K,ce,Oe,Ye,Ne,Ve,nt,Je){const ot=this.length;return this.resize(ot+1),this.emplace(ot,s,h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re,me,oe,U,K,ce,Oe,Ye,Ne,Ve,nt,Je)}emplace(s,h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re,me,oe,U,K,ce,Oe,Ye,Ne,Ve,nt,Je,ot){const He=32*s,xt=16*s;return this.int16[He+0]=h,this.int16[He+1]=d,this.int16[He+2]=m,this.int16[He+3]=v,this.int16[He+4]=b,this.int16[He+5]=S,this.int16[He+6]=E,this.int16[He+7]=C,this.uint16[He+8]=k,this.uint16[He+9]=D,this.uint16[He+10]=z,this.uint16[He+11]=V,this.uint16[He+12]=$,this.uint16[He+13]=H,this.uint16[He+14]=J,this.uint16[He+15]=re,this.uint16[He+16]=me,this.uint16[He+17]=oe,this.uint16[He+18]=U,this.uint16[He+19]=K,this.uint16[He+20]=ce,this.uint16[He+21]=Oe,this.uint16[He+22]=Ye,this.uint32[xt+12]=Ne,this.float32[xt+13]=Ve,this.float32[xt+14]=nt,this.uint16[He+30]=Je,this.uint16[He+31]=ot,s}}_.prototype.bytesPerElement=64,mt("StructArrayLayout8i15ui1ul2f2ui64",_);class n extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s){const h=this.length;return this.resize(h+1),this.emplace(h,s)}emplace(s,h){return this.float32[1*s+0]=h,s}}n.prototype.bytesPerElement=4,mt("StructArrayLayout1f4",n);class l extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,d)}emplace(s,h,d,m){const v=3*s;return this.uint16[6*s+0]=h,this.float32[v+1]=d,this.float32[v+2]=m,s}}l.prototype.bytesPerElement=12,mt("StructArrayLayout1ui2f12",l);class p extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,d)}emplace(s,h,d,m){const v=4*s;return this.uint32[2*s+0]=h,this.uint16[v+2]=d,this.uint16[v+3]=m,s}}p.prototype.bytesPerElement=8,mt("StructArrayLayout1ul2ui8",p);class g extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h){const d=this.length;return this.resize(d+1),this.emplace(d,s,h)}emplace(s,h,d){const m=2*s;return this.uint16[m+0]=h,this.uint16[m+1]=d,s}}g.prototype.bytesPerElement=4,mt("StructArrayLayout2ui4",g);class x extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s){const h=this.length;return this.resize(h+1),this.emplace(h,s)}emplace(s,h){return this.uint16[1*s+0]=h,s}}x.prototype.bytesPerElement=2,mt("StructArrayLayout1ui2",x);class w extends Ri{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,d,m){const v=this.length;return this.resize(v+1),this.emplace(v,s,h,d,m)}emplace(s,h,d,m,v){const b=4*s;return this.float32[b+0]=h,this.float32[b+1]=d,this.float32[b+2]=m,this.float32[b+3]=v,s}}w.prototype.bytesPerElement=16,mt("StructArrayLayout4f16",w);class P extends Aa{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Y(this.anchorPointX,this.anchorPointY)}}P.prototype.size=20;class I extends Dl{get(s){return new P(this,s)}}mt("CollisionBoxArray",I);class R extends Aa{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(s){this._structArray.uint8[this._pos1+37]=s}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(s){this._structArray.uint8[this._pos1+38]=s}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(s){this._structArray.uint32[this._pos4+10]=s}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}R.prototype.size=48;class O extends mu{get(s){return new R(this,s)}}mt("PlacedSymbolArray",O);class N extends Aa{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(s){this._structArray.uint32[this._pos4+12]=s}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}N.prototype.size=64;class B extends _{get(s){return new N(this,s)}}mt("SymbolInstanceArray",B);class W extends n{getoffsetX(s){return this.float32[1*s+0]}}mt("GlyphOffsetArray",W);class X extends xn{getx(s){return this.int16[3*s+0]}gety(s){return this.int16[3*s+1]}gettileUnitDistanceFromAnchor(s){return this.int16[3*s+2]}}mt("SymbolLineVertexArray",X);class te extends Aa{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}te.prototype.size=12;class Q extends l{get(s){return new te(this,s)}}mt("TextAnchorOffsetArray",Q);class ie extends Aa{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}ie.prototype.size=8;class se extends p{get(s){return new ie(this,s)}}mt("FeatureIndexArray",se);class ue extends Pa{}class fe extends Pa{}class de extends Pa{}class ve extends Ea{}class ge extends kl{}class De extends Us{}class ke extends fu{}class We extends Do{}class Ze extends Vs{}class je extends du{}class lt extends js{}class at extends gu{}class qe extends Ia{}class bt extends g{}const Ut=Ni([{name:"a_pos",components:2,type:"Int16"}],4),{members:ni}=Ut;class jt{constructor(s=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=s}prepareSegment(s,h,d,m){const v=this.segments[this.segments.length-1];return s>jt.MAX_VERTEX_ARRAY_LENGTH&&Li(`Max vertices per segment is ${jt.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${s}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${jt.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!v||v.vertexLength+s>jt.MAX_VERTEX_ARRAY_LENGTH||v.sortKey!==m?this.createNewSegment(h,d,m):v}createNewSegment(s,h,d){const m={vertexOffset:s.length,primitiveOffset:h.length,vertexLength:0,primitiveLength:0,vaos:{}};return d!==void 0&&(m.sortKey=d),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(m),m}getOrCreateLatestSegment(s,h,d){return this.prepareSegment(0,s,h,d)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const s of this.segments)for(const h in s.vaos)s.vaos[h].destroy()}static simpleSegment(s,h,d,m){return new jt([{vertexOffset:s,primitiveOffset:h,vertexLength:d,primitiveLength:m,vaos:{},sortKey:0}])}}function ui(u,s){return 256*(u=pt(Math.floor(u),0,255))+pt(Math.floor(s),0,255)}jt.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,mt("SegmentVector",jt);const gi=Ni([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var xi,ci,hi,Ui={exports:{}},Ki={exports:{}},tr={exports:{}},Dr=function(){if(hi)return Ui.exports;hi=1;var u=(xi||(xi=1,Ki.exports=function(h,d){var m,v,b,S,E,C,k,D;for(v=h.length-(m=3&h.length),b=d,E=3432918353,C=461845907,D=0;D<v;)k=255&h.charCodeAt(D)|(255&h.charCodeAt(++D))<<8|(255&h.charCodeAt(++D))<<16|(255&h.charCodeAt(++D))<<24,++D,b=27492+(65535&(S=5*(65535&(b=(b^=k=(65535&(k=(k=(65535&k)*E+(((k>>>16)*E&65535)<<16)&4294967295)<<15|k>>>17))*C+(((k>>>16)*C&65535)<<16)&4294967295)<<13|b>>>19))+((5*(b>>>16)&65535)<<16)&4294967295))+((58964+(S>>>16)&65535)<<16);switch(k=0,m){case 3:k^=(255&h.charCodeAt(D+2))<<16;case 2:k^=(255&h.charCodeAt(D+1))<<8;case 1:b^=k=(65535&(k=(k=(65535&(k^=255&h.charCodeAt(D)))*E+(((k>>>16)*E&65535)<<16)&4294967295)<<15|k>>>17))*C+(((k>>>16)*C&65535)<<16)&4294967295}return b^=h.length,b=2246822507*(65535&(b^=b>>>16))+((2246822507*(b>>>16)&65535)<<16)&4294967295,b=3266489909*(65535&(b^=b>>>13))+((3266489909*(b>>>16)&65535)<<16)&4294967295,(b^=b>>>16)>>>0}),Ki.exports),s=(ci||(ci=1,tr.exports=function(h,d){for(var m,v=h.length,b=d^v,S=0;v>=4;)m=1540483477*(65535&(m=255&h.charCodeAt(S)|(255&h.charCodeAt(++S))<<8|(255&h.charCodeAt(++S))<<16|(255&h.charCodeAt(++S))<<24))+((1540483477*(m>>>16)&65535)<<16),b=1540483477*(65535&b)+((1540483477*(b>>>16)&65535)<<16)^(m=1540483477*(65535&(m^=m>>>24))+((1540483477*(m>>>16)&65535)<<16)),v-=4,++S;switch(v){case 3:b^=(255&h.charCodeAt(S+2))<<16;case 2:b^=(255&h.charCodeAt(S+1))<<8;case 1:b=1540483477*(65535&(b^=255&h.charCodeAt(S)))+((1540483477*(b>>>16)&65535)<<16)}return b=1540483477*(65535&(b^=b>>>13))+((1540483477*(b>>>16)&65535)<<16),(b^=b>>>15)>>>0}),tr.exports);return Ui.exports=u,Ui.exports.murmur3=u,Ui.exports.murmur2=s,Ui.exports}(),Bn=y(Dr);class vn{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(s,h,d,m){this.ids.push(ls(s)),this.positions.push(h,d,m)}getPositions(s){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const h=ls(s);let d=0,m=this.ids.length-1;for(;d<m;){const b=d+m>>1;this.ids[b]>=h?m=b:d=b+1}const v=[];for(;this.ids[d]===h;)v.push({index:this.positions[3*d],start:this.positions[3*d+1],end:this.positions[3*d+2]}),d++;return v}static serialize(s,h){const d=new Float64Array(s.ids),m=new Uint32Array(s.positions);return cs(d,m,0,d.length-1),h&&h.push(d.buffer,m.buffer),{ids:d,positions:m}}static deserialize(s){const h=new vn;return h.ids=s.ids,h.positions=s.positions,h.indexed=!0,h}}function ls(u){const s=+u;return!isNaN(s)&&s<=Number.MAX_SAFE_INTEGER?s:Bn(String(u))}function cs(u,s,h,d){for(;h<d;){const m=u[h+d>>1];let v=h-1,b=d+1;for(;;){do v++;while(u[v]<m);do b--;while(u[b]>m);if(v>=b)break;$s(u,v,b),$s(s,3*v,3*b),$s(s,3*v+1,3*b+1),$s(s,3*v+2,3*b+2)}b-h<d-b?(cs(u,s,h,b),h=b+1):(cs(u,s,b+1,d),d=b)}}function $s(u,s,h){const d=u[s];u[s]=u[h],u[h]=d}mt("FeaturePositionMap",vn);class bn{constructor(s,h){this.gl=s.gl,this.location=h}}class Nn extends bn{constructor(s,h){super(s,h),this.current=0}set(s){this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class Ur extends bn{constructor(s,h){super(s,h),this.current=[0,0,0,0]}set(s){s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3]))}}class zn extends bn{constructor(s,h){super(s,h),this.current=Jt.transparent}set(s){s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a))}}const Ws=new Float32Array(16);function Hs(u){return[ui(255*u.r,255*u.g),ui(255*u.b,255*u.a)]}class ki{constructor(s,h,d){this.value=s,this.uniformNames=h.map(m=>`u_${m}`),this.type=d}setUniform(s,h,d){s.set(d.constantOr(this.value))}getBinding(s,h,d){return this.type==="color"?new zn(s,h):new Nn(s,h)}}class Di{constructor(s,h){this.uniformNames=h.map(d=>`u_${d}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(s,h){this.pixelRatioFrom=h.pixelRatio,this.pixelRatioTo=s.pixelRatio,this.patternFrom=h.tlbr,this.patternTo=s.tlbr}setUniform(s,h,d,m){const v=m==="u_pattern_to"?this.patternTo:m==="u_pattern_from"?this.patternFrom:m==="u_pixel_ratio_to"?this.pixelRatioTo:m==="u_pixel_ratio_from"?this.pixelRatioFrom:null;v&&s.set(v)}getBinding(s,h,d){return d.substr(0,9)==="u_pattern"?new Ur(s,h):new Nn(s,h)}}class Wi{constructor(s,h,d,m){this.expression=s,this.type=d,this.maxValue=0,this.paintVertexAttributes=h.map(v=>({name:`a_${v}`,type:"Float32",components:d==="color"?2:1,offset:0})),this.paintVertexArray=new m}populatePaintArray(s,h,d,m,v){const b=this.paintVertexArray.length,S=this.expression.evaluate(new yi(0),h,{},m,[],v);this.paintVertexArray.resize(s),this._setPaintValue(b,s,S)}updatePaintArray(s,h,d,m){const v=this.expression.evaluate({zoom:0},d,m);this._setPaintValue(s,h,v)}_setPaintValue(s,h,d){if(this.type==="color"){const m=Hs(d);for(let v=s;v<h;v++)this.paintVertexArray.emplace(v,m[0],m[1])}else{for(let m=s;m<h;m++)this.paintVertexArray.emplace(m,d);this.maxValue=Math.max(this.maxValue,Math.abs(d))}}upload(s){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=s.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class di{constructor(s,h,d,m,v,b){this.expression=s,this.uniformNames=h.map(S=>`u_${S}_t`),this.type=d,this.useIntegerZoom=m,this.zoom=v,this.maxValue=0,this.paintVertexAttributes=h.map(S=>({name:`a_${S}`,type:"Float32",components:d==="color"?4:2,offset:0})),this.paintVertexArray=new b}populatePaintArray(s,h,d,m,v){const b=this.expression.evaluate(new yi(this.zoom),h,{},m,[],v),S=this.expression.evaluate(new yi(this.zoom+1),h,{},m,[],v),E=this.paintVertexArray.length;this.paintVertexArray.resize(s),this._setPaintValue(E,s,b,S)}updatePaintArray(s,h,d,m){const v=this.expression.evaluate({zoom:this.zoom},d,m),b=this.expression.evaluate({zoom:this.zoom+1},d,m);this._setPaintValue(s,h,v,b)}_setPaintValue(s,h,d,m){if(this.type==="color"){const v=Hs(d),b=Hs(m);for(let S=s;S<h;S++)this.paintVertexArray.emplace(S,v[0],v[1],b[0],b[1])}else{for(let v=s;v<h;v++)this.paintVertexArray.emplace(v,d,m);this.maxValue=Math.max(this.maxValue,Math.abs(d),Math.abs(m))}}upload(s){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=s.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(s,h){const d=this.useIntegerZoom?Math.floor(h.zoom):h.zoom,m=pt(this.expression.interpolationFactor(d,this.zoom,this.zoom+1),0,1);s.set(m)}getBinding(s,h,d){return new Nn(s,h)}}class us{constructor(s,h,d,m,v,b){this.expression=s,this.type=h,this.useIntegerZoom=d,this.zoom=m,this.layerId=b,this.zoomInPaintVertexArray=new v,this.zoomOutPaintVertexArray=new v}populatePaintArray(s,h,d){const m=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(s),this.zoomOutPaintVertexArray.resize(s),this._setPaintValues(m,s,h.patterns&&h.patterns[this.layerId],d)}updatePaintArray(s,h,d,m,v){this._setPaintValues(s,h,d.patterns&&d.patterns[this.layerId],v)}_setPaintValues(s,h,d,m){if(!m||!d)return;const{min:v,mid:b,max:S}=d,E=m[v],C=m[b],k=m[S];if(E&&C&&k)for(let D=s;D<h;D++)this.zoomInPaintVertexArray.emplace(D,C.tl[0],C.tl[1],C.br[0],C.br[1],E.tl[0],E.tl[1],E.br[0],E.br[1],C.pixelRatio,E.pixelRatio),this.zoomOutPaintVertexArray.emplace(D,C.tl[0],C.tl[1],C.br[0],C.br[1],k.tl[0],k.tl[1],k.br[0],k.br[1],C.pixelRatio,k.pixelRatio)}upload(s){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=s.createVertexBuffer(this.zoomInPaintVertexArray,gi.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=s.createVertexBuffer(this.zoomOutPaintVertexArray,gi.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Af{constructor(s,h,d){this.binders={},this._buffers=[];const m=[];for(const v in s.paint._values){if(!d(v))continue;const b=s.paint.get(v);if(!(b instanceof yn&&To(b.property.specification)))continue;const S=cg(v,s.type),E=b.value,C=b.property.specification.type,k=b.property.useIntegerZoom,D=b.property.specification["property-type"],z=D==="cross-faded"||D==="cross-faded-data-driven";if(E.kind==="constant")this.binders[v]=z?new Di(E.value,S):new ki(E.value,S,C),m.push(`/u_${v}`);else if(E.kind==="source"||z){const V=Pf(v,C,"source");this.binders[v]=z?new us(E,C,k,h,V,s.id):new Wi(E,S,C,V),m.push(`/a_${v}`)}else{const V=Pf(v,C,"composite");this.binders[v]=new di(E,S,C,k,h,V),m.push(`/z_${v}`)}}this.cacheKey=m.sort().join("")}getMaxValue(s){const h=this.binders[s];return h instanceof Wi||h instanceof di?h.maxValue:0}populatePaintArrays(s,h,d,m,v){for(const b in this.binders){const S=this.binders[b];(S instanceof Wi||S instanceof di||S instanceof us)&&S.populatePaintArray(s,h,d,m,v)}}setConstantPatternPositions(s,h){for(const d in this.binders){const m=this.binders[d];m instanceof Di&&m.setConstantPatternPositions(s,h)}}updatePaintArrays(s,h,d,m,v){let b=!1;for(const S in s){const E=h.getPositions(S);for(const C of E){const k=d.feature(C.index);for(const D in this.binders){const z=this.binders[D];if((z instanceof Wi||z instanceof di||z instanceof us)&&z.expression.isStateDependent===!0){const V=m.paint.get(D);z.expression=V.value,z.updatePaintArray(C.start,C.end,k,s[S],v),b=!0}}}}return b}defines(){const s=[];for(const h in this.binders){const d=this.binders[h];(d instanceof ki||d instanceof Di)&&s.push(...d.uniformNames.map(m=>`#define HAS_UNIFORM_${m}`))}return s}getBinderAttributes(){const s=[];for(const h in this.binders){const d=this.binders[h];if(d instanceof Wi||d instanceof di)for(let m=0;m<d.paintVertexAttributes.length;m++)s.push(d.paintVertexAttributes[m].name);else if(d instanceof us)for(let m=0;m<gi.members.length;m++)s.push(gi.members[m].name)}return s}getBinderUniforms(){const s=[];for(const h in this.binders){const d=this.binders[h];if(d instanceof ki||d instanceof Di||d instanceof di)for(const m of d.uniformNames)s.push(m)}return s}getPaintVertexBuffers(){return this._buffers}getUniforms(s,h){const d=[];for(const m in this.binders){const v=this.binders[m];if(v instanceof ki||v instanceof Di||v instanceof di){for(const b of v.uniformNames)if(h[b]){const S=v.getBinding(s,h[b],b);d.push({name:b,property:m,binding:S})}}}return d}setUniforms(s,h,d,m){for(const{name:v,property:b,binding:S}of h)this.binders[b].setUniform(S,m,d.get(b),v)}updatePaintBuffers(s){this._buffers=[];for(const h in this.binders){const d=this.binders[h];if(s&&d instanceof us){const m=s.fromScale===2?d.zoomInPaintVertexBuffer:d.zoomOutPaintVertexBuffer;m&&this._buffers.push(m)}else(d instanceof Wi||d instanceof di)&&d.paintVertexBuffer&&this._buffers.push(d.paintVertexBuffer)}}upload(s){for(const h in this.binders){const d=this.binders[h];(d instanceof Wi||d instanceof di||d instanceof us)&&d.upload(s)}this.updatePaintBuffers()}destroy(){for(const s in this.binders){const h=this.binders[s];(h instanceof Wi||h instanceof di||h instanceof us)&&h.destroy()}}}class Zs{constructor(s,h,d=()=>!0){this.programConfigurations={};for(const m of s)this.programConfigurations[m.id]=new Af(m,h,d);this.needsUpload=!1,this._featureMap=new vn,this._bufferOffset=0}populatePaintArrays(s,h,d,m,v,b){for(const S in this.programConfigurations)this.programConfigurations[S].populatePaintArrays(s,h,m,v,b);h.id!==void 0&&this._featureMap.add(h.id,d,this._bufferOffset,s),this._bufferOffset=s,this.needsUpload=!0}updatePaintArrays(s,h,d,m){for(const v of d)this.needsUpload=this.programConfigurations[v.id].updatePaintArrays(s,this._featureMap,h,v,m)||this.needsUpload}get(s){return this.programConfigurations[s]}upload(s){if(this.needsUpload){for(const h in this.programConfigurations)this.programConfigurations[h].upload(s);this.needsUpload=!1}}destroy(){for(const s in this.programConfigurations)this.programConfigurations[s].destroy()}}function cg(u,s){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[u]||[u.replace(`${s}-`,"").replace(/-/g,"_")]}function Pf(u,s,h){const d={color:{source:Us,composite:w},number:{source:n,composite:Us}},m=function(v){return{"line-pattern":{source:ke,composite:ke},"fill-pattern":{source:ke,composite:ke},"fill-extrusion-pattern":{source:ke,composite:ke}}[v]}(u);return m&&m[h]||d[s][h]}mt("ConstantBinder",ki),mt("CrossFadedConstantBinder",Di),mt("SourceExpressionBinder",Wi),mt("CrossFadedCompositeBinder",us),mt("CompositeExpressionBinder",di),mt("ProgramConfiguration",Af,{omit:["_buffers"]}),mt("ProgramConfigurationSet",Zs);const _u=Math.pow(2,14)-1,hs=-_u-1;function fs(u){const s=he/u.extent,h=u.loadGeometry();for(let d=0;d<h.length;d++){const m=h[d];for(let v=0;v<m.length;v++){const b=m[v],S=Math.round(b.x*s),E=Math.round(b.y*s);b.x=pt(S,hs,_u),b.y=pt(E,hs,_u),(S<b.x||S>b.x+1||E<b.y||E>b.y+1)&&Li("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return h}function ds(u,s){return{type:u.type,id:u.id,properties:u.properties,geometry:s?fs(u):[]}}const yu=-32768;function xu(u,s,h,d,m){u.emplaceBack(yu+8*s+d,yu+8*h+m)}class Ol{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(h=>h.id),this.index=s.index,this.hasPattern=!1,this.layoutVertexArray=new fe,this.indexArray=new qe,this.segments=new jt,this.programConfigurations=new Zs(s.layers,s.zoom),this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id)}populate(s,h,d){const m=this.layers[0],v=[];let b=null,S=!1,E=m.type==="heatmap";if(m.type==="circle"){const k=m;b=k.layout.get("circle-sort-key"),S=!b.isConstant(),E=E||k.paint.get("circle-pitch-alignment")==="map"}const C=E?h.subdivisionGranularity.circle:1;for(const{feature:k,id:D,index:z,sourceLayerIndex:V}of s){const $=this.layers[0]._featureFilter.needGeometry,H=ds(k,$);if(!this.layers[0]._featureFilter.filter(new yi(this.zoom),H,d))continue;const J=S?b.evaluate(H,{},d):void 0,re={id:D,properties:k.properties,type:k.type,sourceLayerIndex:V,index:z,geometry:$?H.geometry:fs(k),patterns:{},sortKey:J};v.push(re)}S&&v.sort((k,D)=>k.sortKey-D.sortKey);for(const k of v){const{geometry:D,index:z,sourceLayerIndex:V}=k,$=s[z].feature;this.addFeature(k,D,z,d,C),h.featureIndex.insert($,D,z,V,this.index)}}update(s,h,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,ni),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(s,h,d,m,v=1){let b;switch(v){case 1:b=[0,7];break;case 3:b=[0,2,5,7];break;case 5:b=[0,1,3,4,6,7];break;case 7:b=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${v}; valid values are 1, 3, 5, 7.`)}const S=b.length;for(const E of h)for(const C of E){const k=C.x,D=C.y;if(k<0||k>=he||D<0||D>=he)continue;const z=this.segments.prepareSegment(S*S,this.layoutVertexArray,this.indexArray,s.sortKey),V=z.vertexLength;for(let $=0;$<S;$++)for(let H=0;H<S;H++)xu(this.layoutVertexArray,k,D,b[H],b[$]);for(let $=0;$<S-1;$++)for(let H=0;H<S-1;H++){const J=V+$*S+H,re=V+($+1)*S+H;this.indexArray.emplaceBack(J,re+1,J+1),this.indexArray.emplaceBack(J,re,re+1)}z.vertexLength+=S*S,z.primitiveLength+=(S-1)*(S-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,d,{},m)}}function Fl(u,s){for(let h=0;h<u.length;h++)if(Ca(s,u[h]))return!0;for(let h=0;h<s.length;h++)if(Ca(u,s[h]))return!0;return!!ug(u,s)}function bT(u,s,h){return!!Ca(u,s)||!!hg(s,u,h)}function Ry(u,s){if(u.length===1)return Dy(s,u[0]);for(let h=0;h<s.length;h++){const d=s[h];for(let m=0;m<d.length;m++)if(Ca(u,d[m]))return!0}for(let h=0;h<u.length;h++)if(Dy(s,u[h]))return!0;for(let h=0;h<s.length;h++)if(ug(u,s[h]))return!0;return!1}function wT(u,s,h){if(u.length>1){if(ug(u,s))return!0;for(let d=0;d<s.length;d++)if(hg(s[d],u,h))return!0}for(let d=0;d<u.length;d++)if(hg(u[d],s,h))return!0;return!1}function ug(u,s){if(u.length===0||s.length===0)return!1;for(let h=0;h<u.length-1;h++){const d=u[h],m=u[h+1];for(let v=0;v<s.length-1;v++)if(TT(d,m,s[v],s[v+1]))return!0}return!1}function TT(u,s,h,d){return Ti(u,h,d)!==Ti(s,h,d)&&Ti(u,s,h)!==Ti(u,s,d)}function hg(u,s,h){const d=h*h;if(s.length===1)return u.distSqr(s[0])<d;for(let m=1;m<s.length;m++)if(ky(u,s[m-1],s[m])<d)return!0;return!1}function ky(u,s,h){const d=s.distSqr(h);if(d===0)return u.distSqr(s);const m=((u.x-s.x)*(h.x-s.x)+(u.y-s.y)*(h.y-s.y))/d;return u.distSqr(m<0?s:m>1?h:h.sub(s)._mult(m)._add(s))}function Dy(u,s){for(let h=0;h<u.length;h++)if(Ca(u[h],s))return!0;return!1}function Ca(u,s){let h=!1;for(let d=0,m=u.length-1;d<u.length;m=d++){const v=u[d],b=u[m];v.y>s.y!=b.y>s.y&&s.x<(b.x-v.x)*(s.y-v.y)/(b.y-v.y)+v.x&&(h=!h)}return h}function ST(u,s,h){const d=h[0],m=h[2];if(u.x<d.x&&s.x<d.x||u.x>m.x&&s.x>m.x||u.y<d.y&&s.y<d.y||u.y>m.y&&s.y>m.y)return!1;const v=Ti(u,s,h[0]);return v!==Ti(u,s,h[1])||v!==Ti(u,s,h[2])||v!==Ti(u,s,h[3])}function vu(u,s,h){const d=s.paint.get(u).value;return d.kind==="constant"?d.value:h.programConfigurations.get(s.id).getMaxValue(u)}function Ef(u){return Math.sqrt(u[0]*u[0]+u[1]*u[1])}function If(u,s,h,d,m){if(!s[0]&&!s[1])return u;const v=Y.convert(s)._mult(m);h==="viewport"&&v._rotate(-d);const b=[];for(let S=0;S<u.length;S++)b.push(u[S].sub(v));return b}let Oy,Fy;mt("CircleBucket",Ol,{omit:["layers"]});var AT={get paint(){return Fy=Fy||new kr({"circle-radius":new Mt(j.paint_circle["circle-radius"]),"circle-color":new Mt(j.paint_circle["circle-color"]),"circle-blur":new Mt(j.paint_circle["circle-blur"]),"circle-opacity":new Mt(j.paint_circle["circle-opacity"]),"circle-translate":new St(j.paint_circle["circle-translate"]),"circle-translate-anchor":new St(j.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new St(j.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new St(j.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Mt(j.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Mt(j.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Mt(j.paint_circle["circle-stroke-opacity"])})},get layout(){return Oy=Oy||new kr({"circle-sort-key":new Mt(j.layout_circle["circle-sort-key"])})}};class PT extends Tr{constructor(s){super(s,AT)}createBucket(s){return new Ol(s)}queryRadius(s){const h=s;return vu("circle-radius",this,h)+vu("circle-stroke-width",this,h)+Ef(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:s,feature:h,featureState:d,geometry:m,transform:v,pixelsToTileUnits:b,unwrappedTileID:S,getElevation:E}){const C=If(s,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-v.bearingInRadians,b),k=this.paint.get("circle-radius").evaluate(h,d)+this.paint.get("circle-stroke-width").evaluate(h,d),D=this.paint.get("circle-pitch-alignment")==="map",z=D?C:function($,H,J,re){return $.map(me=>Ly(me,H,J,re))}(C,v,S,E),V=D?k*b:k;for(const $ of m)for(const H of $){const J=D?H:Ly(H,v,S,E);let re=V;const me=v.projectTileCoordinates(H.x,H.y,S,E).signedDistanceFromCamera;if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?re*=me/v.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(re*=v.cameraToCenterDistance/me),bT(z,J,re))return!0}return!1}}function Ly(u,s,h,d){const m=s.projectTileCoordinates(u.x,u.y,h,d).point;return new Y((.5*m.x+.5)*s.width,(.5*-m.y+.5)*s.height)}class By extends Ol{}let Ny;mt("HeatmapBucket",By,{omit:["layers"]});var ET={get paint(){return Ny=Ny||new kr({"heatmap-radius":new Mt(j.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Mt(j.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new St(j.paint_heatmap["heatmap-intensity"]),"heatmap-color":new hu(j.paint_heatmap["heatmap-color"]),"heatmap-opacity":new St(j.paint_heatmap["heatmap-opacity"])})}};function fg(u,{width:s,height:h},d,m){if(m){if(m instanceof Uint8ClampedArray)m=new Uint8Array(m.buffer);else if(m.length!==s*h*d)throw new RangeError(`mismatched image size. expected: ${m.length} but got: ${s*h*d}`)}else m=new Uint8Array(s*h*d);return u.width=s,u.height=h,u.data=m,u}function zy(u,{width:s,height:h},d){if(s===u.width&&h===u.height)return;const m=fg({},{width:s,height:h},d);dg(u,m,{x:0,y:0},{x:0,y:0},{width:Math.min(u.width,s),height:Math.min(u.height,h)},d),u.width=s,u.height=h,u.data=m.data}function dg(u,s,h,d,m,v){if(m.width===0||m.height===0)return s;if(m.width>u.width||m.height>u.height||h.x>u.width-m.width||h.y>u.height-m.height)throw new RangeError("out of range source coordinates for image copy");if(m.width>s.width||m.height>s.height||d.x>s.width-m.width||d.y>s.height-m.height)throw new RangeError("out of range destination coordinates for image copy");const b=u.data,S=s.data;if(b===S)throw new Error("srcData equals dstData, so image is already copied");for(let E=0;E<m.height;E++){const C=((h.y+E)*u.width+h.x)*v,k=((d.y+E)*s.width+d.x)*v;for(let D=0;D<m.width*v;D++)S[k+D]=b[C+D]}return s}class bu{constructor(s,h){fg(this,s,1,h)}resize(s){zy(this,s,1)}clone(){return new bu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(s,h,d,m,v){dg(s,h,d,m,v,1)}}class sn{constructor(s,h){fg(this,s,4,h)}resize(s){zy(this,s,4)}replace(s,h){h?this.data.set(s):this.data=s instanceof Uint8ClampedArray?new Uint8Array(s.buffer):s}clone(){return new sn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(s,h,d,m,v){dg(s,h,d,m,v,4)}}function Uy(u){const s={},h=u.resolution||256,d=u.clips?u.clips.length:1,m=u.image||new sn({width:h,height:d});if(Math.log(h)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${h}`);const v=(b,S,E)=>{s[u.evaluationKey]=E;const C=u.expression.evaluate(s);m.data[b+S+0]=Math.floor(255*C.r/C.a),m.data[b+S+1]=Math.floor(255*C.g/C.a),m.data[b+S+2]=Math.floor(255*C.b/C.a),m.data[b+S+3]=Math.floor(255*C.a)};if(u.clips)for(let b=0,S=0;b<d;++b,S+=4*h)for(let E=0,C=0;E<h;E++,C+=4){const k=E/(h-1),{start:D,end:z}=u.clips[b];v(S,C,D*(1-k)+z*k)}else for(let b=0,S=0;b<h;b++,S+=4)v(0,S,b/(h-1));return m}mt("AlphaImage",bu),mt("RGBAImage",sn);const pg="big-fb";class IT extends Tr{createBucket(s){return new By(s)}constructor(s){super(s,ET),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(s){s==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Uy({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(pg)&&this.heatmapFbos.delete(pg)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Vy;var CT={get paint(){return Vy=Vy||new kr({"hillshade-illumination-direction":new St(j.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new St(j.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new St(j.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new St(j.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new St(j.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new St(j.paint_hillshade["hillshade-accent-color"])})}};class MT extends Tr{constructor(s){super(s,CT)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const RT=Ni([{name:"a_pos",components:2,type:"Int16"}],4),{members:kT}=RT;function gg(u,s,h){const d=h.patternDependencies;let m=!1;for(const v of s){const b=v.paint.get(`${u}-pattern`);b.isConstant()||(m=!0);const S=b.constantOr(null);S&&(m=!0,d[S.to]=!0,d[S.from]=!0)}return m}function mg(u,s,h,d,m){const v=m.patternDependencies;for(const b of s){const S=b.paint.get(`${u}-pattern`).value;if(S.kind!=="constant"){let E=S.evaluate({zoom:d-1},h,{},m.availableImages),C=S.evaluate({zoom:d},h,{},m.availableImages),k=S.evaluate({zoom:d+1},h,{},m.availableImages);E=E&&E.name?E.name:E,C=C&&C.name?C.name:C,k=k&&k.name?k.name:k,v[E]=!0,v[C]=!0,v[k]=!0,h.patterns[b.id]={min:E,mid:C,max:k}}}return h}function jy(u,s,h,d,m){let v;if(m===function(b,S,E,C){let k=0;for(let D=S,z=E-C;D<E;D+=C)k+=(b[z]-b[D])*(b[D+1]+b[z+1]),z=D;return k}(u,s,h,d)>0)for(let b=s;b<h;b+=d)v=Zy(b/d|0,u[b],u[b+1],v);else for(let b=h-d;b>=s;b-=d)v=Zy(b/d|0,u[b],u[b+1],v);return v&&Ll(v,v.next)&&(Au(v),v=v.next),v}function Ma(u,s){if(!u)return u;s||(s=u);let h,d=u;do if(h=!1,d.steiner||!Ll(d,d.next)&&Vi(d.prev,d,d.next)!==0)d=d.next;else{if(Au(d),d=s=d.prev,d===d.next)break;h=!0}while(h||d!==s);return s}function wu(u,s,h,d,m,v,b){if(!u)return;!b&&v&&function(E,C,k,D){let z=E;do z.z===0&&(z.z=_g(z.x,z.y,C,k,D)),z.prevZ=z.prev,z.nextZ=z.next,z=z.next;while(z!==E);z.prevZ.nextZ=null,z.prevZ=null,function(V){let $,H=1;do{let J,re=V;V=null;let me=null;for($=0;re;){$++;let oe=re,U=0;for(let ce=0;ce<H&&(U++,oe=oe.nextZ,oe);ce++);let K=H;for(;U>0||K>0&&oe;)U!==0&&(K===0||!oe||re.z<=oe.z)?(J=re,re=re.nextZ,U--):(J=oe,oe=oe.nextZ,K--),me?me.nextZ=J:V=J,J.prevZ=me,me=J;re=oe}me.nextZ=null,H*=2}while($>1)}(z)}(u,d,m,v);let S=u;for(;u.prev!==u.next;){const E=u.prev,C=u.next;if(v?OT(u,d,m,v):DT(u))s.push(E.i,u.i,C.i),Au(u),u=C.next,S=C.next;else if((u=C)===S){b?b===1?wu(u=FT(Ma(u),s),s,h,d,m,v,2):b===2&&LT(u,s,h,d,m,v):wu(Ma(u),s,h,d,m,v,1);break}}}function DT(u){const s=u.prev,h=u,d=u.next;if(Vi(s,h,d)>=0)return!1;const m=s.x,v=h.x,b=d.x,S=s.y,E=h.y,C=d.y,k=Math.min(m,v,b),D=Math.min(S,E,C),z=Math.max(m,v,b),V=Math.max(S,E,C);let $=d.next;for(;$!==s;){if($.x>=k&&$.x<=z&&$.y>=D&&$.y<=V&&Tu(m,S,v,E,b,C,$.x,$.y)&&Vi($.prev,$,$.next)>=0)return!1;$=$.next}return!0}function OT(u,s,h,d){const m=u.prev,v=u,b=u.next;if(Vi(m,v,b)>=0)return!1;const S=m.x,E=v.x,C=b.x,k=m.y,D=v.y,z=b.y,V=Math.min(S,E,C),$=Math.min(k,D,z),H=Math.max(S,E,C),J=Math.max(k,D,z),re=_g(V,$,s,h,d),me=_g(H,J,s,h,d);let oe=u.prevZ,U=u.nextZ;for(;oe&&oe.z>=re&&U&&U.z<=me;){if(oe.x>=V&&oe.x<=H&&oe.y>=$&&oe.y<=J&&oe!==m&&oe!==b&&Tu(S,k,E,D,C,z,oe.x,oe.y)&&Vi(oe.prev,oe,oe.next)>=0||(oe=oe.prevZ,U.x>=V&&U.x<=H&&U.y>=$&&U.y<=J&&U!==m&&U!==b&&Tu(S,k,E,D,C,z,U.x,U.y)&&Vi(U.prev,U,U.next)>=0))return!1;U=U.nextZ}for(;oe&&oe.z>=re;){if(oe.x>=V&&oe.x<=H&&oe.y>=$&&oe.y<=J&&oe!==m&&oe!==b&&Tu(S,k,E,D,C,z,oe.x,oe.y)&&Vi(oe.prev,oe,oe.next)>=0)return!1;oe=oe.prevZ}for(;U&&U.z<=me;){if(U.x>=V&&U.x<=H&&U.y>=$&&U.y<=J&&U!==m&&U!==b&&Tu(S,k,E,D,C,z,U.x,U.y)&&Vi(U.prev,U,U.next)>=0)return!1;U=U.nextZ}return!0}function FT(u,s){let h=u;do{const d=h.prev,m=h.next.next;!Ll(d,m)&&Wy(d,h,h.next,m)&&Su(d,m)&&Su(m,d)&&(s.push(d.i,h.i,m.i),Au(h),Au(h.next),h=u=m),h=h.next}while(h!==u);return Ma(h)}function LT(u,s,h,d,m,v){let b=u;do{let S=b.next.next;for(;S!==b.prev;){if(b.i!==S.i&&VT(b,S)){let E=Hy(b,S);return b=Ma(b,b.next),E=Ma(E,E.next),wu(b,s,h,d,m,v,0),void wu(E,s,h,d,m,v,0)}S=S.next}b=b.next}while(b!==u)}function BT(u,s){let h=u.x-s.x;return h===0&&(h=u.y-s.y,h===0)&&(h=(u.next.y-u.y)/(u.next.x-u.x)-(s.next.y-s.y)/(s.next.x-s.x)),h}function NT(u,s){const h=function(m,v){let b=v;const S=m.x,E=m.y;let C,k=-1/0;if(Ll(m,b))return b;do{if(Ll(m,b.next))return b.next;if(E<=b.y&&E>=b.next.y&&b.next.y!==b.y){const H=b.x+(E-b.y)*(b.next.x-b.x)/(b.next.y-b.y);if(H<=S&&H>k&&(k=H,C=b.x<b.next.x?b:b.next,H===S))return C}b=b.next}while(b!==v);if(!C)return null;const D=C,z=C.x,V=C.y;let $=1/0;b=C;do{if(S>=b.x&&b.x>=z&&S!==b.x&&$y(E<V?S:k,E,z,V,E<V?k:S,E,b.x,b.y)){const H=Math.abs(E-b.y)/(S-b.x);Su(b,m)&&(H<$||H===$&&(b.x>C.x||b.x===C.x&&zT(C,b)))&&(C=b,$=H)}b=b.next}while(b!==D);return C}(u,s);if(!h)return s;const d=Hy(h,u);return Ma(d,d.next),Ma(h,h.next)}function zT(u,s){return Vi(u.prev,u,s.prev)<0&&Vi(s.next,u,u.next)<0}function _g(u,s,h,d,m){return(u=1431655765&((u=858993459&((u=252645135&((u=16711935&((u=(u-h)*m|0)|u<<8))|u<<4))|u<<2))|u<<1))|(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=(s-d)*m|0)|s<<8))|s<<4))|s<<2))|s<<1))<<1}function UT(u){let s=u,h=u;do(s.x<h.x||s.x===h.x&&s.y<h.y)&&(h=s),s=s.next;while(s!==u);return h}function $y(u,s,h,d,m,v,b,S){return(m-b)*(s-S)>=(u-b)*(v-S)&&(u-b)*(d-S)>=(h-b)*(s-S)&&(h-b)*(v-S)>=(m-b)*(d-S)}function Tu(u,s,h,d,m,v,b,S){return!(u===b&&s===S)&&$y(u,s,h,d,m,v,b,S)}function VT(u,s){return u.next.i!==s.i&&u.prev.i!==s.i&&!function(h,d){let m=h;do{if(m.i!==h.i&&m.next.i!==h.i&&m.i!==d.i&&m.next.i!==d.i&&Wy(m,m.next,h,d))return!0;m=m.next}while(m!==h);return!1}(u,s)&&(Su(u,s)&&Su(s,u)&&function(h,d){let m=h,v=!1;const b=(h.x+d.x)/2,S=(h.y+d.y)/2;do m.y>S!=m.next.y>S&&m.next.y!==m.y&&b<(m.next.x-m.x)*(S-m.y)/(m.next.y-m.y)+m.x&&(v=!v),m=m.next;while(m!==h);return v}(u,s)&&(Vi(u.prev,u,s.prev)||Vi(u,s.prev,s))||Ll(u,s)&&Vi(u.prev,u,u.next)>0&&Vi(s.prev,s,s.next)>0)}function Vi(u,s,h){return(s.y-u.y)*(h.x-s.x)-(s.x-u.x)*(h.y-s.y)}function Ll(u,s){return u.x===s.x&&u.y===s.y}function Wy(u,s,h,d){const m=Mf(Vi(u,s,h)),v=Mf(Vi(u,s,d)),b=Mf(Vi(h,d,u)),S=Mf(Vi(h,d,s));return m!==v&&b!==S||!(m!==0||!Cf(u,h,s))||!(v!==0||!Cf(u,d,s))||!(b!==0||!Cf(h,u,d))||!(S!==0||!Cf(h,s,d))}function Cf(u,s,h){return s.x<=Math.max(u.x,h.x)&&s.x>=Math.min(u.x,h.x)&&s.y<=Math.max(u.y,h.y)&&s.y>=Math.min(u.y,h.y)}function Mf(u){return u>0?1:u<0?-1:0}function Su(u,s){return Vi(u.prev,u,u.next)<0?Vi(u,s,u.next)>=0&&Vi(u,u.prev,s)>=0:Vi(u,s,u.prev)<0||Vi(u,u.next,s)<0}function Hy(u,s){const h=yg(u.i,u.x,u.y),d=yg(s.i,s.x,s.y),m=u.next,v=s.prev;return u.next=s,s.prev=u,h.next=m,m.prev=h,d.next=h,h.prev=d,v.next=d,d.prev=v,d}function Zy(u,s,h,d){const m=yg(u,s,h);return d?(m.next=d.next,m.prev=d,d.next.prev=m,d.next=m):(m.prev=m,m.next=m),m}function Au(u){u.next.prev=u.prev,u.prev.next=u.next,u.prevZ&&(u.prevZ.nextZ=u.nextZ),u.nextZ&&(u.nextZ.prevZ=u.prevZ)}function yg(u,s,h){return{i:u,x:s,y:h,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Bl{constructor(s,h){if(h>s)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=s,this._minGranularity=h}getGranularityForZoomLevel(s){return Math.max(Math.floor(this._baseZoomGranularity/(1<<s)),this._minGranularity,1)}}class Rf{constructor(s){this.fill=s.fill,this.line=s.line,this.tile=s.tile,this.stencil=s.stencil,this.circle=s.circle}}Rf.noSubdivision=new Rf({fill:new Bl(0,0),line:new Bl(0,0),tile:new Bl(0,0),stencil:new Bl(0,0),circle:1}),mt("SubdivisionGranularityExpression",Bl),mt("SubdivisionGranularitySetting",Rf);const Nl=-32768,Pu=32767;class jT{constructor(s,h){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=s,this._granularityCellSize=he/s,this._canonical=h}_getKey(s,h){return(s+=32768)<<16|(h+=32768)<<0}_vertexToIndex(s,h){if(s<-32768||h<-32768||s>32767||h>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const d=0|Math.round(s),m=0|Math.round(h),v=this._getKey(d,m);if(this._vertexDictionary.has(v))return this._vertexDictionary.get(v);const b=this._vertexBuffer.length/2;return this._vertexDictionary.set(v,b),this._vertexBuffer.push(d,m),b}_subdivideTrianglesScanline(s){if(this._granularity<2)return function(m,v){const b=[];for(let S=0;S<v.length;S+=3){const E=v[S],C=v[S+1],k=v[S+2],D=m[2*E],z=m[2*E+1];(m[2*C]-D)*(m[2*k+1]-z)-(m[2*C+1]-z)*(m[2*k]-D)>0?(b.push(E),b.push(k),b.push(C)):(b.push(E),b.push(C),b.push(k))}return b}(this._vertexBuffer,s);const h=[],d=s.length;for(let m=0;m<d;m+=3){const v=[s[m+0],s[m+1],s[m+2]],b=[this._vertexBuffer[2*s[m+0]+0],this._vertexBuffer[2*s[m+0]+1],this._vertexBuffer[2*s[m+1]+0],this._vertexBuffer[2*s[m+1]+1],this._vertexBuffer[2*s[m+2]+0],this._vertexBuffer[2*s[m+2]+1]];let S=1/0,E=1/0,C=-1/0,k=-1/0;for(let H=0;H<3;H++){const J=b[2*H],re=b[2*H+1];S=Math.min(S,J),C=Math.max(C,J),E=Math.min(E,re),k=Math.max(k,re)}if(S===C||E===k)continue;const D=Math.floor(S/this._granularityCellSize),z=Math.ceil(C/this._granularityCellSize),V=Math.floor(E/this._granularityCellSize),$=Math.ceil(k/this._granularityCellSize);if(D!==z||V!==$)for(let H=V;H<$;H++){const J=this._scanlineGenerateVertexRingForCellRow(H,b,v);$T(this._vertexBuffer,J,h)}else h.push(...v)}return h}_scanlineGenerateVertexRingForCellRow(s,h,d){const m=s*this._granularityCellSize,v=m+this._granularityCellSize,b=[];for(let S=0;S<3;S++){const E=h[2*S],C=h[2*S+1],k=h[2*(S+1)%6],D=h[(2*(S+1)+1)%6],z=h[2*(S+2)%6],V=h[(2*(S+2)+1)%6],$=k-E,H=D-C,J=$===0,re=H===0,me=(m-C)/H,oe=(v-C)/H,U=Math.min(me,oe),K=Math.max(me,oe);if(!re&&(U>=1||K<=0)||re&&(C<m||C>v)){D>=m&&D<=v&&b.push(d[(S+1)%3]);continue}!re&&U>0&&b.push(this._vertexToIndex(E+$*U,C+H*U));const ce=E+$*Math.max(U,0),Oe=E+$*Math.min(K,1);J||this._generateIntraEdgeVertices(b,E,C,k,D,ce,Oe),!re&&K<1&&b.push(this._vertexToIndex(E+$*K,C+H*K)),(re||D>=m&&D<=v)&&b.push(d[(S+1)%3]),!re&&(D<=m||D>=v)&&this._generateInterEdgeVertices(b,E,C,k,D,z,V,Oe,m,v)}return b}_generateIntraEdgeVertices(s,h,d,m,v,b,S){const E=m-h,C=v-d,k=C===0,D=k?Math.min(h,m):Math.min(b,S),z=k?Math.max(h,m):Math.max(b,S),V=Math.floor(D/this._granularityCellSize)+1,$=Math.ceil(z/this._granularityCellSize)-1;if(k?h<m:b<S)for(let H=V;H<=$;H++){const J=H*this._granularityCellSize;s.push(this._vertexToIndex(J,d+C*(J-h)/E))}else for(let H=$;H>=V;H--){const J=H*this._granularityCellSize;s.push(this._vertexToIndex(J,d+C*(J-h)/E))}}_generateInterEdgeVertices(s,h,d,m,v,b,S,E,C,k){const D=v-d,z=b-m,V=S-v,$=(C-v)/V,H=(k-v)/V,J=Math.min($,H),re=Math.max($,H),me=m+z*J;let oe=Math.floor(Math.min(me,E)/this._granularityCellSize)+1,U=Math.ceil(Math.max(me,E)/this._granularityCellSize)-1,K=E<me;const ce=V===0;if(ce&&(S===C||S===k))return;if(ce||J>=1||re<=0){const Ye=d-S,Ne=b+(h-b)*Math.min((C-S)/Ye,(k-S)/Ye);oe=Math.floor(Math.min(Ne,E)/this._granularityCellSize)+1,U=Math.ceil(Math.max(Ne,E)/this._granularityCellSize)-1,K=E<Ne}const Oe=D>0?k:C;if(K)for(let Ye=oe;Ye<=U;Ye++)s.push(this._vertexToIndex(Ye*this._granularityCellSize,Oe));else for(let Ye=U;Ye>=oe;Ye--)s.push(this._vertexToIndex(Ye*this._granularityCellSize,Oe))}_generateOutline(s){const h=[];for(const d of s){const m=Ra(d,this._granularity,!0),v=this._pointArrayToIndices(m),b=[];for(let S=1;S<v.length;S++)b.push(v[S-1]),b.push(v[S]);h.push(b)}return h}_handlePoles(s){let h=!1,d=!1;this._canonical&&(this._canonical.y===0&&(h=!0),this._canonical.y===(1<<this._canonical.z)-1&&(d=!0)),(h||d)&&this._fillPoles(s,h,d)}_ensureNoPoleVertices(){const s=this._vertexBuffer;for(let h=0;h<s.length;h+=2){const d=s[h+1];d===Nl&&(s[h+1]=-32767),d===Pu&&(s[h+1]=32766)}}_generatePoleQuad(s,h,d,m,v,b){m>v!=(b===Nl)?(s.push(h),s.push(d),s.push(this._vertexToIndex(m,b)),s.push(d),s.push(this._vertexToIndex(v,b)),s.push(this._vertexToIndex(m,b))):(s.push(d),s.push(h),s.push(this._vertexToIndex(m,b)),s.push(this._vertexToIndex(v,b)),s.push(d),s.push(this._vertexToIndex(m,b)))}_fillPoles(s,h,d){const m=this._vertexBuffer,v=he,b=s.length;for(let S=2;S<b;S+=3){const E=s[S-2],C=s[S-1],k=s[S],D=m[2*E],z=m[2*E+1],V=m[2*C],$=m[2*C+1],H=m[2*k],J=m[2*k+1];h&&(z===0&&$===0&&this._generatePoleQuad(s,E,C,D,V,Nl),$===0&&J===0&&this._generatePoleQuad(s,C,k,V,H,Nl),J===0&&z===0&&this._generatePoleQuad(s,k,E,H,D,Nl)),d&&(z===v&&$===v&&this._generatePoleQuad(s,E,C,D,V,Pu),$===v&&J===v&&this._generatePoleQuad(s,C,k,V,H,Pu),J===v&&z===v&&this._generatePoleQuad(s,k,E,H,D,Pu))}}_initializeVertices(s){for(let h=0;h<s.length;h+=2)this._vertexToIndex(s[h],s[h+1])}subdividePolygonInternal(s,h){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:d,holeIndices:m}=function(S){const E=[],C=[];for(const k of S)if(k.length!==0){k!==S[0]&&E.push(C.length/2);for(let D=0;D<k.length;D++)C.push(k[D].x),C.push(k[D].y)}return{flattened:C,holeIndices:E}}(s);let v;this._initializeVertices(d);try{const S=function(C,k,D=2){const z=k&&k.length,V=z?k[0]*D:C.length;let $=jy(C,0,V,D,!0);const H=[];if(!$||$.next===$.prev)return H;let J,re,me;if(z&&($=function(oe,U,K,ce){const Oe=[];for(let Ye=0,Ne=U.length;Ye<Ne;Ye++){const Ve=jy(oe,U[Ye]*ce,Ye<Ne-1?U[Ye+1]*ce:oe.length,ce,!1);Ve===Ve.next&&(Ve.steiner=!0),Oe.push(UT(Ve))}Oe.sort(BT);for(let Ye=0;Ye<Oe.length;Ye++)K=NT(Oe[Ye],K);return K}(C,k,$,D)),C.length>80*D){J=1/0,re=1/0;let oe=-1/0,U=-1/0;for(let K=D;K<V;K+=D){const ce=C[K],Oe=C[K+1];ce<J&&(J=ce),Oe<re&&(re=Oe),ce>oe&&(oe=ce),Oe>U&&(U=Oe)}me=Math.max(oe-J,U-re),me=me!==0?32767/me:0}return wu($,H,D,J,re,me,0),H}(d,m),E=this._convertIndices(d,S);v=this._subdivideTrianglesScanline(E)}catch(S){console.error(S)}let b=[];return h&&(b=this._generateOutline(s)),this._ensureNoPoleVertices(),this._handlePoles(v),{verticesFlattened:this._vertexBuffer,indicesTriangles:v,indicesLineList:b}}_convertIndices(s,h){const d=[];for(let m=0;m<h.length;m++)d.push(this._vertexToIndex(s[2*h[m]],s[2*h[m]+1]));return d}_pointArrayToIndices(s){const h=[];for(let d=0;d<s.length;d++){const m=s[d];h.push(this._vertexToIndex(m.x,m.y))}return h}}function Xy(u,s,h,d=!0){return new jT(h,s).subdividePolygonInternal(u,d)}function Ra(u,s,h=!1){if(!u||u.length<1)return[];if(u.length<2)return[];const d=u[0],m=u[u.length-1],v=h&&(d.x!==m.x||d.y!==m.y);if(s<2)return v?[...u,u[0]]:[...u];const b=Math.floor(he/s),S=[];S.push(new Y(u[0].x,u[0].y));const E=u.length,C=v?E:E-1;for(let k=0;k<C;k++){const D=u[k],z=k<E-1?u[k+1]:u[0],V=D.x,$=D.y,H=z.x,J=z.y,re=V!==H,me=$!==J;if(!re&&!me)continue;const oe=H-V,U=J-$,K=Math.abs(oe),ce=Math.abs(U);let Oe=V,Ye=$;for(;;){const Ve=oe>0?(Math.floor(Oe/b)+1)*b:(Math.ceil(Oe/b)-1)*b,nt=U>0?(Math.floor(Ye/b)+1)*b:(Math.ceil(Ye/b)-1)*b,Je=Math.abs(Oe-Ve),ot=Math.abs(Ye-nt),He=Math.abs(Oe-H),xt=Math.abs(Ye-J),It=re?Je/K:Number.POSITIVE_INFINITY,At=me?ot/ce:Number.POSITIVE_INFINITY;if((He<=Je||!re)&&(xt<=ot||!me))break;if(It<At&&re||!me){Oe=Ve,Ye+=U*It;const wt=new Y(Oe,Math.round(Ye));S[S.length-1].x===wt.x&&S[S.length-1].y===wt.y||S.push(wt)}else{Oe+=oe*At,Ye=nt;const wt=new Y(Math.round(Oe),Ye);S[S.length-1].x===wt.x&&S[S.length-1].y===wt.y||S.push(wt)}}const Ne=new Y(H,J);S[S.length-1].x===Ne.x&&S[S.length-1].y===Ne.y||S.push(Ne)}return S}function $T(u,s,h){if(s.length===0)throw new Error("Subdivision vertex ring is empty.");let d=0,m=u[2*s[0]];for(let E=1;E<s.length;E++){const C=u[2*s[E]];C<m&&(m=C,d=E)}const v=s.length;let b=d,S=(b+1)%v;for(;;){const E=b-1>=0?b-1:v-1,C=(S+1)%v,k=u[2*s[E]],D=u[2*s[C]],z=u[2*s[b]],V=u[2*s[b]+1],$=u[2*s[S]+1];let H=!1;if(k<D)H=!0;else if(k>D)H=!1;else{const J=$-V,re=-(u[2*s[S]]-z),me=V<$?1:-1;((k-z)*J+(u[2*s[E]+1]-V)*re)*me>((D-z)*J+(u[2*s[C]+1]-V)*re)*me&&(H=!0)}if(H){const J=s[E],re=s[b],me=s[S];J!==re&&J!==me&&re!==me&&h.push(me,re,J),b--,b<0&&(b=v-1)}else{const J=s[C],re=s[b],me=s[S];J!==re&&J!==me&&re!==me&&h.push(me,re,J),S++,S>=v&&(S=0)}if(E===C)break}}function qy(u,s,h,d,m,v,b,S,E){const C=m.length/2,k=b&&S&&E;if(C<jt.MAX_VERTEX_ARRAY_LENGTH){const D=s.prepareSegment(C,h,d),z=D.vertexLength;for(let H=0;H<v.length;H+=3)d.emplaceBack(z+v[H],z+v[H+1],z+v[H+2]);let V,$;D.vertexLength+=C,D.primitiveLength+=v.length/3,k&&($=b.prepareSegment(C,h,S),V=$.vertexLength,$.vertexLength+=C);for(let H=0;H<m.length;H+=2)u(m[H],m[H+1]);if(k)for(let H=0;H<E.length;H++){const J=E[H];for(let re=1;re<J.length;re+=2)S.emplaceBack(V+J[re-1],V+J[re]);$.primitiveLength+=J.length/2}}else(function(D,z,V,$,H,J){const re=[];for(let ce=0;ce<$.length/2;ce++)re.push(-1);const me={count:0};let oe=0,U=D.getOrCreateLatestSegment(z,V),K=U.vertexLength;for(let ce=2;ce<H.length;ce+=3){const Oe=H[ce-2],Ye=H[ce-1],Ne=H[ce];let Ve=re[Oe]<oe,nt=re[Ye]<oe,Je=re[Ne]<oe;U.vertexLength+((Ve?1:0)+(nt?1:0)+(Je?1:0))>jt.MAX_VERTEX_ARRAY_LENGTH&&(U=D.createNewSegment(z,V),oe=me.count,Ve=!0,nt=!0,Je=!0,K=0);const ot=Eu(re,$,J,me,Oe,Ve,U),He=Eu(re,$,J,me,Ye,nt,U),xt=Eu(re,$,J,me,Ne,Je,U);V.emplaceBack(K+ot-oe,K+He-oe,K+xt-oe),U.primitiveLength++}})(s,h,d,m,v,u),k&&function(D,z,V,$,H,J){const re=[];for(let ce=0;ce<$.length/2;ce++)re.push(-1);const me={count:0};let oe=0,U=D.getOrCreateLatestSegment(z,V),K=U.vertexLength;for(let ce=0;ce<H.length;ce++){const Oe=H[ce];for(let Ye=1;Ye<H[ce].length;Ye+=2){const Ne=Oe[Ye-1],Ve=Oe[Ye];let nt=re[Ne]<oe,Je=re[Ve]<oe;U.vertexLength+((nt?1:0)+(Je?1:0))>jt.MAX_VERTEX_ARRAY_LENGTH&&(U=D.createNewSegment(z,V),oe=me.count,nt=!0,Je=!0,K=0);const ot=Eu(re,$,J,me,Ne,nt,U),He=Eu(re,$,J,me,Ve,Je,U);V.emplaceBack(K+ot-oe,K+He-oe),U.primitiveLength++}}}(b,h,S,m,E,u),s.forceNewSegmentOnNextPrepare(),b==null||b.forceNewSegmentOnNextPrepare()}function Eu(u,s,h,d,m,v,b){if(v){const S=d.count;return h(s[2*m],s[2*m+1]),u[m]=d.count,d.count++,b.vertexLength++,S}return u[m]}class xg{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(h=>h.id),this.index=s.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new de,this.indexArray=new qe,this.indexArray2=new bt,this.programConfigurations=new Zs(s.layers,s.zoom),this.segments=new jt,this.segments2=new jt,this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id)}populate(s,h,d){this.hasPattern=gg("fill",this.layers,h);const m=this.layers[0].layout.get("fill-sort-key"),v=!m.isConstant(),b=[];for(const{feature:S,id:E,index:C,sourceLayerIndex:k}of s){const D=this.layers[0]._featureFilter.needGeometry,z=ds(S,D);if(!this.layers[0]._featureFilter.filter(new yi(this.zoom),z,d))continue;const V=v?m.evaluate(z,{},d,h.availableImages):void 0,$={id:E,properties:S.properties,type:S.type,sourceLayerIndex:k,index:C,geometry:D?z.geometry:fs(S),patterns:{},sortKey:V};b.push($)}v&&b.sort((S,E)=>S.sortKey-E.sortKey);for(const S of b){const{geometry:E,index:C,sourceLayerIndex:k}=S;if(this.hasPattern){const D=mg("fill",this.layers,S,this.zoom,h);this.patternFeatures.push(D)}else this.addFeature(S,E,C,d,{},h.subdivisionGranularity);h.featureIndex.insert(s[C].feature,E,C,k,this.index)}}update(s,h,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,d)}addFeatures(s,h,d){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,h,d,s.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,kT),this.indexBuffer=s.createIndexBuffer(this.indexArray),this.indexBuffer2=s.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(s,h,d,m,v,b){for(const S of da(h,500)){const E=Xy(S,m,b.fill.getGranularityForZoomLevel(m.z)),C=this.layoutVertexArray;qy((k,D)=>{C.emplaceBack(k,D)},this.segments,this.layoutVertexArray,this.indexArray,E.verticesFlattened,E.indicesTriangles,this.segments2,this.indexArray2,E.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,d,v,m)}}let Gy,Yy;mt("FillBucket",xg,{omit:["layers","patternFeatures"]});var WT={get paint(){return Yy=Yy||new kr({"fill-antialias":new St(j.paint_fill["fill-antialias"]),"fill-opacity":new Mt(j.paint_fill["fill-opacity"]),"fill-color":new Mt(j.paint_fill["fill-color"]),"fill-outline-color":new Mt(j.paint_fill["fill-outline-color"]),"fill-translate":new St(j.paint_fill["fill-translate"]),"fill-translate-anchor":new St(j.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ml(j.paint_fill["fill-pattern"])})},get layout(){return Gy=Gy||new kr({"fill-sort-key":new Mt(j.layout_fill["fill-sort-key"])})}};class HT extends Tr{constructor(s){super(s,WT)}recalculate(s,h){super.recalculate(s,h);const d=this.paint._values["fill-outline-color"];d.value.kind==="constant"&&d.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(s){return new xg(s)}queryRadius(){return Ef(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:s,geometry:h,transform:d,pixelsToTileUnits:m}){return Ry(If(s,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-d.bearingInRadians,m),h)}isTileClipped(){return!0}}const ZT=Ni([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),XT=Ni([{name:"a_centroid",components:2,type:"Int16"}],4),{members:qT}=ZT;var vg,Ky,bg,Jy,wg,Qy,ex,kf={};function tx(){if(Ky)return vg;Ky=1;var u=M();function s(m,v,b,S,E){this.properties={},this.extent=b,this.type=0,this._pbf=m,this._geometry=-1,this._keys=S,this._values=E,m.readFields(h,this,v)}function h(m,v,b){m==1?v.id=b.readVarint():m==2?function(S,E){for(var C=S.readVarint()+S.pos;S.pos<C;){var k=E._keys[S.readVarint()],D=E._values[S.readVarint()];E.properties[k]=D}}(b,v):m==3?v.type=b.readVarint():m==4&&(v._geometry=b.pos)}function d(m){for(var v,b,S=0,E=0,C=m.length,k=C-1;E<C;k=E++)S+=((b=m[k]).x-(v=m[E]).x)*(v.y+b.y);return S}return vg=s,s.types=["Unknown","Point","LineString","Polygon"],s.prototype.loadGeometry=function(){var m=this._pbf;m.pos=this._geometry;for(var v,b=m.readVarint()+m.pos,S=1,E=0,C=0,k=0,D=[];m.pos<b;){if(E<=0){var z=m.readVarint();S=7&z,E=z>>3}if(E--,S===1||S===2)C+=m.readSVarint(),k+=m.readSVarint(),S===1&&(v&&D.push(v),v=[]),v.push(new u(C,k));else{if(S!==7)throw new Error("unknown command "+S);v&&v.push(v[0].clone())}}return v&&D.push(v),D},s.prototype.bbox=function(){var m=this._pbf;m.pos=this._geometry;for(var v=m.readVarint()+m.pos,b=1,S=0,E=0,C=0,k=1/0,D=-1/0,z=1/0,V=-1/0;m.pos<v;){if(S<=0){var $=m.readVarint();b=7&$,S=$>>3}if(S--,b===1||b===2)(E+=m.readSVarint())<k&&(k=E),E>D&&(D=E),(C+=m.readSVarint())<z&&(z=C),C>V&&(V=C);else if(b!==7)throw new Error("unknown command "+b)}return[k,z,D,V]},s.prototype.toGeoJSON=function(m,v,b){var S,E,C=this.extent*Math.pow(2,b),k=this.extent*m,D=this.extent*v,z=this.loadGeometry(),V=s.types[this.type];function $(re){for(var me=0;me<re.length;me++){var oe=re[me];re[me]=[360*(oe.x+k)/C-180,360/Math.PI*Math.atan(Math.exp((180-360*(oe.y+D)/C)*Math.PI/180))-90]}}switch(this.type){case 1:var H=[];for(S=0;S<z.length;S++)H[S]=z[S][0];$(z=H);break;case 2:for(S=0;S<z.length;S++)$(z[S]);break;case 3:for(z=function(re){var me=re.length;if(me<=1)return[re];for(var oe,U,K=[],ce=0;ce<me;ce++){var Oe=d(re[ce]);Oe!==0&&(U===void 0&&(U=Oe<0),U===Oe<0?(oe&&K.push(oe),oe=[re[ce]]):oe.push(re[ce]))}return oe&&K.push(oe),K}(z),S=0;S<z.length;S++)for(E=0;E<z[S].length;E++)$(z[S][E])}z.length===1?z=z[0]:V="Multi"+V;var J={type:"Feature",geometry:{type:V,coordinates:z},properties:this.properties};return"id"in this&&(J.id=this.id),J},vg}function ix(){if(Jy)return bg;Jy=1;var u=tx();function s(d,m){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=d,this._keys=[],this._values=[],this._features=[],d.readFields(h,this,m),this.length=this._features.length}function h(d,m,v){d===15?m.version=v.readVarint():d===1?m.name=v.readString():d===5?m.extent=v.readVarint():d===2?m._features.push(v.pos):d===3?m._keys.push(v.readString()):d===4&&m._values.push(function(b){for(var S=null,E=b.readVarint()+b.pos;b.pos<E;){var C=b.readVarint()>>3;S=C===1?b.readString():C===2?b.readFloat():C===3?b.readDouble():C===4?b.readVarint64():C===5?b.readVarint():C===6?b.readSVarint():C===7?b.readBoolean():null}return S}(v))}return bg=s,s.prototype.feature=function(d){if(d<0||d>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[d];var m=this._pbf.readVarint()+this._pbf.pos;return new u(this._pbf,m,this.extent,this._keys,this._values)},bg}function rx(){return ex||(ex=1,kf.VectorTile=function(){if(Qy)return wg;Qy=1;var u=ix();function s(h,d,m){if(h===3){var v=new u(m,m.readVarint()+m.pos);v.length&&(d[v.name]=v)}}return wg=function(h,d){this.layers=h.readFields(s,{},d)},wg}(),kf.VectorTileFeature=tx(),kf.VectorTileLayer=ix()),kf}var Iu=y(rx());const GT=Iu.VectorTileFeature.types,Tg=Math.pow(2,13);function Cu(u,s,h,d,m,v,b,S){u.emplaceBack(s,h,2*Math.floor(d*Tg)+b,m*Tg*2,v*Tg*2,Math.round(S))}class Sg{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(h=>h.id),this.index=s.index,this.hasPattern=!1,this.layoutVertexArray=new ve,this.centroidVertexArray=new ue,this.indexArray=new qe,this.programConfigurations=new Zs(s.layers,s.zoom),this.segments=new jt,this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id)}populate(s,h,d){this.features=[],this.hasPattern=gg("fill-extrusion",this.layers,h);for(const{feature:m,id:v,index:b,sourceLayerIndex:S}of s){const E=this.layers[0]._featureFilter.needGeometry,C=ds(m,E);if(!this.layers[0]._featureFilter.filter(new yi(this.zoom),C,d))continue;const k={id:v,sourceLayerIndex:S,index:b,geometry:E?C.geometry:fs(m),properties:m.properties,type:m.type,patterns:{}};this.hasPattern?this.features.push(mg("fill-extrusion",this.layers,k,this.zoom,h)):this.addFeature(k,k.geometry,b,d,{},h.subdivisionGranularity),h.featureIndex.insert(m,k.geometry,b,S,this.index,!0)}}addFeatures(s,h,d){for(const m of this.features){const{geometry:v}=m;this.addFeature(m,v,m.index,h,d,s.subdivisionGranularity)}}update(s,h,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,d)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,qT),this.centroidVertexBuffer=s.createVertexBuffer(this.centroidVertexArray,XT.members,!0),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(s,h,d,m,v,b){for(const S of da(h,500)){const E={x:0,y:0,sampleCount:0},C=this.layoutVertexArray.length;this.processPolygon(E,m,s,S,b);const k=this.layoutVertexArray.length-C,D=Math.floor(E.x/E.sampleCount),z=Math.floor(E.y/E.sampleCount);for(let V=0;V<k;V++)this.centroidVertexArray.emplaceBack(D,z)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,d,v,m)}processPolygon(s,h,d,m,v){if(m.length<1||nx(m[0]))return;for(const D of m)D.length!==0&&YT(s,D);const b={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},S=v.fill.getGranularityForZoomLevel(h.z),E=GT[d.type]==="Polygon";for(const D of m){if(D.length===0||nx(D))continue;const z=Ra(D,S,E);this._generateSideFaces(z,b)}if(!E)return;const C=Xy(m,h,S,!1),k=this.layoutVertexArray;qy((D,z)=>{Cu(k,D,z,0,0,1,1,0)},this.segments,this.layoutVertexArray,this.indexArray,C.verticesFlattened,C.indicesTriangles)}_generateSideFaces(s,h){let d=0;for(let m=1;m<s.length;m++){const v=s[m],b=s[m-1];if(KT(v,b))continue;h.segment.vertexLength+4>jt.MAX_VERTEX_ARRAY_LENGTH&&(h.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const S=v.sub(b)._perp()._unit(),E=b.dist(v);d+E>32768&&(d=0),Cu(this.layoutVertexArray,v.x,v.y,S.x,S.y,0,0,d),Cu(this.layoutVertexArray,v.x,v.y,S.x,S.y,0,1,d),d+=E,Cu(this.layoutVertexArray,b.x,b.y,S.x,S.y,0,0,d),Cu(this.layoutVertexArray,b.x,b.y,S.x,S.y,0,1,d);const C=h.segment.vertexLength;this.indexArray.emplaceBack(C,C+2,C+1),this.indexArray.emplaceBack(C+1,C+2,C+3),h.segment.vertexLength+=4,h.segment.primitiveLength+=2}}}function YT(u,s){for(let h=0;h<s.length;h++){const d=s[h];h===s.length-1&&s[0].x===d.x&&s[0].y===d.y||(u.x+=d.x,u.y+=d.y,u.sampleCount++)}}function KT(u,s){return u.x===s.x&&(u.x<0||u.x>he)||u.y===s.y&&(u.y<0||u.y>he)}function nx(u){return u.every(s=>s.x<0)||u.every(s=>s.x>he)||u.every(s=>s.y<0)||u.every(s=>s.y>he)}let sx;mt("FillExtrusionBucket",Sg,{omit:["layers","features"]});var JT={get paint(){return sx=sx||new kr({"fill-extrusion-opacity":new St(j["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Mt(j["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new St(j["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new St(j["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ml(j["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Mt(j["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Mt(j["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new St(j["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class QT extends Tr{constructor(s){super(s,JT)}createBucket(s){return new Sg(s)}queryRadius(){return Ef(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:s,feature:h,featureState:d,geometry:m,transform:v,pixelsToTileUnits:b,pixelPosMatrix:S}){const E=If(s,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-v.bearingInRadians,b),C=this.paint.get("fill-extrusion-height").evaluate(h,d),k=this.paint.get("fill-extrusion-base").evaluate(h,d),D=function(V,$,H){const J=[];for(const re of V){const me=[re.x,re.y,0,1];Lt(me,me,$),J.push(new Y(me[0]/me[3],me[1]/me[3]))}return J}(E,S),z=function(V,$,H,J){const re=[],me=[],oe=J[8]*$,U=J[9]*$,K=J[10]*$,ce=J[11]*$,Oe=J[8]*H,Ye=J[9]*H,Ne=J[10]*H,Ve=J[11]*H;for(const nt of V){const Je=[],ot=[];for(const He of nt){const xt=He.x,It=He.y,At=J[0]*xt+J[4]*It+J[12],wt=J[1]*xt+J[5]*It+J[13],Zt=J[2]*xt+J[6]*It+J[14],Oi=J[3]*xt+J[7]*It+J[15],Qi=Zt+K,xr=Oi+ce,an=At+Oe,jr=wt+Ye,hr=Zt+Ne,Ci=Oi+Ve,ir=new Y((At+oe)/xr,(wt+U)/xr);ir.z=Qi/xr,Je.push(ir);const fr=new Y(an/Ci,jr/Ci);fr.z=hr/Ci,ot.push(fr)}re.push(Je),me.push(ot)}return[re,me]}(m,k,C,S);return function(V,$,H){let J=1/0;Ry(H,$)&&(J=ox(H,$[0]));for(let re=0;re<$.length;re++){const me=$[re],oe=V[re];for(let U=0;U<me.length-1;U++){const K=me[U],ce=[K,me[U+1],oe[U+1],oe[U],K];Fl(H,ce)&&(J=Math.min(J,ox(H,ce)))}}return J!==1/0&&J}(z[0],z[1],D)}}function Mu(u,s){return u.x*s.x+u.y*s.y}function ox(u,s){if(u.length===1){let h=0;const d=s[h++];let m;for(;!m||d.equals(m);)if(m=s[h++],!m)return 1/0;for(;h<s.length;h++){const v=s[h],b=u[0],S=m.sub(d),E=v.sub(d),C=b.sub(d),k=Mu(S,S),D=Mu(S,E),z=Mu(E,E),V=Mu(C,S),$=Mu(C,E),H=k*z-D*D,J=(z*V-D*$)/H,re=(k*$-D*V)/H,me=d.z*(1-J-re)+m.z*J+v.z*re;if(isFinite(me))return me}return 1/0}{let h=1/0;for(const d of s)h=Math.min(h,d.z);return h}}const eS=Ni([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:tS}=eS,iS=Ni([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:rS}=iS,nS=Iu.VectorTileFeature.types,sS=Math.cos(Math.PI/180*37.5),ax=Math.pow(2,14)/.5;class Ag{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(h=>h.id),this.index=s.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(h=>{this.gradients[h.id]={}}),this.layoutVertexArray=new ge,this.layoutVertexArray2=new De,this.indexArray=new qe,this.programConfigurations=new Zs(s.layers,s.zoom),this.segments=new jt,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id)}populate(s,h,d){this.hasPattern=gg("line",this.layers,h);const m=this.layers[0].layout.get("line-sort-key"),v=!m.isConstant(),b=[];for(const{feature:S,id:E,index:C,sourceLayerIndex:k}of s){const D=this.layers[0]._featureFilter.needGeometry,z=ds(S,D);if(!this.layers[0]._featureFilter.filter(new yi(this.zoom),z,d))continue;const V=v?m.evaluate(z,{},d):void 0,$={id:E,properties:S.properties,type:S.type,sourceLayerIndex:k,index:C,geometry:D?z.geometry:fs(S),patterns:{},sortKey:V};b.push($)}v&&b.sort((S,E)=>S.sortKey-E.sortKey);for(const S of b){const{geometry:E,index:C,sourceLayerIndex:k}=S;if(this.hasPattern){const D=mg("line",this.layers,S,this.zoom,h);this.patternFeatures.push(D)}else this.addFeature(S,E,C,d,{},h.subdivisionGranularity);h.featureIndex.insert(s[C].feature,E,C,k,this.index)}}update(s,h,d){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,d)}addFeatures(s,h,d){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,h,d,s.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=s.createVertexBuffer(this.layoutVertexArray2,rS)),this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,tS),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(s){if(s.properties&&Object.prototype.hasOwnProperty.call(s.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(s.properties,"mapbox_clip_end"))return{start:+s.properties.mapbox_clip_start,end:+s.properties.mapbox_clip_end}}addFeature(s,h,d,m,v,b){const S=this.layers[0].layout,E=S.get("line-join").evaluate(s,{}),C=S.get("line-cap"),k=S.get("line-miter-limit"),D=S.get("line-round-limit");this.lineClips=this.lineFeatureClips(s);for(const z of h)this.addLine(z,s,E,C,k,D,m,b);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,d,v,m)}addLine(s,h,d,m,v,b,S,E){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,s=Ra(s,S?E.line.getGranularityForZoomLevel(S.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let oe=0;oe<s.length-1;oe++)this.totalDistance+=s[oe].dist(s[oe+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const C=nS[h.type]==="Polygon";let k=s.length;for(;k>=2&&s[k-1].equals(s[k-2]);)k--;let D=0;for(;D<k-1&&s[D].equals(s[D+1]);)D++;if(k<(C?3:2))return;d==="bevel"&&(v=1.05);const z=this.overscaling<=16?15*he/(512*this.overscaling):0,V=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let $,H,J,re,me;this.e1=this.e2=-1,C&&($=s[k-2],me=s[D].sub($)._unit()._perp());for(let oe=D;oe<k;oe++){if(J=oe===k-1?C?s[D+1]:void 0:s[oe+1],J&&s[oe].equals(J))continue;me&&(re=me),$&&(H=$),$=s[oe],me=J?J.sub($)._unit()._perp():re,re=re||me;let U=re.add(me);U.x===0&&U.y===0||U._unit();const K=re.x*me.x+re.y*me.y,ce=U.x*me.x+U.y*me.y,Oe=ce!==0?1/ce:1/0,Ye=2*Math.sqrt(2-2*ce),Ne=ce<sS&&H&&J,Ve=re.x*me.y-re.y*me.x>0;if(Ne&&oe>D){const ot=$.dist(H);if(ot>2*z){const He=$.sub($.sub(H)._mult(z/ot)._round());this.updateDistance(H,He),this.addCurrentVertex(He,re,0,0,V),H=He}}const nt=H&&J;let Je=nt?d:C?"butt":m;if(nt&&Je==="round"&&(Oe<b?Je="miter":Oe<=2&&(Je="fakeround")),Je==="miter"&&Oe>v&&(Je="bevel"),Je==="bevel"&&(Oe>2&&(Je="flipbevel"),Oe<v&&(Je="miter")),H&&this.updateDistance(H,$),Je==="miter")U._mult(Oe),this.addCurrentVertex($,U,0,0,V);else if(Je==="flipbevel"){if(Oe>100)U=me.mult(-1);else{const ot=Oe*re.add(me).mag()/re.sub(me).mag();U._perp()._mult(ot*(Ve?-1:1))}this.addCurrentVertex($,U,0,0,V),this.addCurrentVertex($,U.mult(-1),0,0,V)}else if(Je==="bevel"||Je==="fakeround"){const ot=-Math.sqrt(Oe*Oe-1),He=Ve?ot:0,xt=Ve?0:ot;if(H&&this.addCurrentVertex($,re,He,xt,V),Je==="fakeround"){const It=Math.round(180*Ye/Math.PI/20);for(let At=1;At<It;At++){let wt=At/It;if(wt!==.5){const Oi=wt-.5;wt+=wt*Oi*(wt-1)*((1.0904+K*(K*(3.55645-1.43519*K)-3.2452))*Oi*Oi+(.848013+K*(.215638*K-1.06021)))}const Zt=me.sub(re)._mult(wt)._add(re)._unit()._mult(Ve?-1:1);this.addHalfVertex($,Zt.x,Zt.y,!1,Ve,0,V)}}J&&this.addCurrentVertex($,me,-He,-xt,V)}else if(Je==="butt")this.addCurrentVertex($,U,0,0,V);else if(Je==="square"){const ot=H?1:-1;this.addCurrentVertex($,U,ot,ot,V)}else Je==="round"&&(H&&(this.addCurrentVertex($,re,0,0,V),this.addCurrentVertex($,re,1,1,V,!0)),J&&(this.addCurrentVertex($,me,-1,-1,V,!0),this.addCurrentVertex($,me,0,0,V)));if(Ne&&oe<k-1){const ot=$.dist(J);if(ot>2*z){const He=$.add(J.sub($)._mult(z/ot)._round());this.updateDistance($,He),this.addCurrentVertex(He,me,0,0,V),$=He}}}}addCurrentVertex(s,h,d,m,v,b=!1){const S=h.y*m-h.x,E=-h.y-h.x*m;this.addHalfVertex(s,h.x+h.y*d,h.y-h.x*d,b,!1,d,v),this.addHalfVertex(s,S,E,b,!0,-m,v),this.distance>ax/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(s,h,d,m,v,b))}addHalfVertex({x:s,y:h},d,m,v,b,S,E){const C=.5*(this.lineClips?this.scaledDistance*(ax-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((s<<1)+(v?1:0),(h<<1)+(b?1:0),Math.round(63*d)+128,Math.round(63*m)+128,1+(S===0?0:S<0?-1:1)|(63&C)<<2,C>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const k=E.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,k,this.e2),E.primitiveLength++),b?this.e2=k:this.e1=k}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(s,h){this.distance+=s.dist(h),this.updateScaledDistance()}}let lx,cx;mt("LineBucket",Ag,{omit:["layers","patternFeatures"]});var ux={get paint(){return cx=cx||new kr({"line-opacity":new Mt(j.paint_line["line-opacity"]),"line-color":new Mt(j.paint_line["line-color"]),"line-translate":new St(j.paint_line["line-translate"]),"line-translate-anchor":new St(j.paint_line["line-translate-anchor"]),"line-width":new Mt(j.paint_line["line-width"]),"line-gap-width":new Mt(j.paint_line["line-gap-width"]),"line-offset":new Mt(j.paint_line["line-offset"]),"line-blur":new Mt(j.paint_line["line-blur"]),"line-dasharray":new uu(j.paint_line["line-dasharray"]),"line-pattern":new Ml(j.paint_line["line-pattern"]),"line-gradient":new hu(j.paint_line["line-gradient"])})},get layout(){return lx=lx||new kr({"line-cap":new St(j.layout_line["line-cap"]),"line-join":new Mt(j.layout_line["line-join"]),"line-miter-limit":new St(j.layout_line["line-miter-limit"]),"line-round-limit":new St(j.layout_line["line-round-limit"]),"line-sort-key":new Mt(j.layout_line["line-sort-key"])})}};class oS extends Mt{possiblyEvaluate(s,h){return h=new yi(Math.floor(h.zoom),{now:h.now,fadeDuration:h.fadeDuration,zoomHistory:h.zoomHistory,transition:h.transition}),super.possiblyEvaluate(s,h)}evaluate(s,h,d,m){return h=Tt({},h,{zoom:Math.floor(h.zoom)}),super.evaluate(s,h,d,m)}}let Df;class aS extends Tr{constructor(s){super(s,ux),this.gradientVersion=0,Df||(Df=new oS(ux.paint.properties["line-width"].specification),Df.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(s){if(s==="line-gradient"){const h=this.gradientExpression();this.stepInterpolant=!!function(d){return d._styleExpression!==void 0}(h)&&h._styleExpression.expression instanceof go,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(s,h){super.recalculate(s,h),this.paint._values["line-floorwidth"]=Df.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,s)}createBucket(s){return new Ag(s)}queryRadius(s){const h=s,d=hx(vu("line-width",this,h),vu("line-gap-width",this,h)),m=vu("line-offset",this,h);return d/2+Math.abs(m)+Ef(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:s,feature:h,featureState:d,geometry:m,transform:v,pixelsToTileUnits:b}){const S=If(s,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-v.bearingInRadians,b),E=b/2*hx(this.paint.get("line-width").evaluate(h,d),this.paint.get("line-gap-width").evaluate(h,d)),C=this.paint.get("line-offset").evaluate(h,d);return C&&(m=function(k,D){const z=[];for(let V=0;V<k.length;V++){const $=k[V],H=[];for(let J=0;J<$.length;J++){const re=$[J-1],me=$[J],oe=$[J+1],U=J===0?new Y(0,0):me.sub(re)._unit()._perp(),K=J===$.length-1?new Y(0,0):oe.sub(me)._unit()._perp(),ce=U._add(K)._unit(),Oe=ce.x*K.x+ce.y*K.y;Oe!==0&&ce._mult(1/Oe),H.push(ce._mult(D)._add(me))}z.push(H)}return z}(m,C*b)),function(k,D,z){for(let V=0;V<D.length;V++){const $=D[V];if(k.length>=3){for(let H=0;H<$.length;H++)if(Ca(k,$[H]))return!0}if(wT(k,$,z))return!0}return!1}(S,m,E)}isTileClipped(){return!0}}function hx(u,s){return s>0?s+2*u:u}const lS=Ni([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),cS=Ni([{name:"a_projected_pos",components:3,type:"Float32"}],4);Ni([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const uS=Ni([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Ni([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const fx=Ni([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),hS=Ni([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function fS(u,s,h){return u.sections.forEach(d=>{d.text=function(m,v,b){const S=v.layout.get("text-transform").evaluate(b,{});return S==="uppercase"?m=m.toLocaleUpperCase():S==="lowercase"&&(m=m.toLocaleLowerCase()),Ln.applyArabicShaping&&(m=Ln.applyArabicShaping(m)),m}(d.text,s,h)}),u}Ni([{name:"triangle",components:3,type:"Uint16"}]),Ni([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Ni([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Ni([{type:"Float32",name:"offsetX"}]),Ni([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Ni([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const Ru={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var dx,Pg,px,Ji=24,Eg={};function dS(){return dx||(dx=1,Eg.read=function(u,s,h,d,m){var v,b,S=8*m-d-1,E=(1<<S)-1,C=E>>1,k=-7,D=h?m-1:0,z=h?-1:1,V=u[s+D];for(D+=z,v=V&(1<<-k)-1,V>>=-k,k+=S;k>0;v=256*v+u[s+D],D+=z,k-=8);for(b=v&(1<<-k)-1,v>>=-k,k+=d;k>0;b=256*b+u[s+D],D+=z,k-=8);if(v===0)v=1-C;else{if(v===E)return b?NaN:1/0*(V?-1:1);b+=Math.pow(2,d),v-=C}return(V?-1:1)*b*Math.pow(2,v-d)},Eg.write=function(u,s,h,d,m,v){var b,S,E,C=8*v-m-1,k=(1<<C)-1,D=k>>1,z=m===23?Math.pow(2,-24)-Math.pow(2,-77):0,V=d?0:v-1,$=d?1:-1,H=s<0||s===0&&1/s<0?1:0;for(s=Math.abs(s),isNaN(s)||s===1/0?(S=isNaN(s)?1:0,b=k):(b=Math.floor(Math.log(s)/Math.LN2),s*(E=Math.pow(2,-b))<1&&(b--,E*=2),(s+=b+D>=1?z/E:z*Math.pow(2,1-D))*E>=2&&(b++,E/=2),b+D>=k?(S=0,b=k):b+D>=1?(S=(s*E-1)*Math.pow(2,m),b+=D):(S=s*Math.pow(2,D-1)*Math.pow(2,m),b=0));m>=8;u[h+V]=255&S,V+=$,S/=256,m-=8);for(b=b<<m|S,C+=m;C>0;u[h+V]=255&b,V+=$,b/=256,C-=8);u[h+V-$]|=128*H}),Eg}function gx(){if(px)return Pg;px=1,Pg=s;var u=dS();function s(U){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(U)?U:new Uint8Array(U||0),this.pos=0,this.type=0,this.length=this.buf.length}s.Varint=0,s.Fixed64=1,s.Bytes=2,s.Fixed32=5;var h=4294967296,d=1/h,m=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function v(U){return U.type===s.Bytes?U.readVarint()+U.pos:U.pos+1}function b(U,K,ce){return ce?4294967296*K+(U>>>0):4294967296*(K>>>0)+(U>>>0)}function S(U,K,ce){var Oe=K<=16383?1:K<=2097151?2:K<=268435455?3:Math.floor(Math.log(K)/(7*Math.LN2));ce.realloc(Oe);for(var Ye=ce.pos-1;Ye>=U;Ye--)ce.buf[Ye+Oe]=ce.buf[Ye]}function E(U,K){for(var ce=0;ce<U.length;ce++)K.writeVarint(U[ce])}function C(U,K){for(var ce=0;ce<U.length;ce++)K.writeSVarint(U[ce])}function k(U,K){for(var ce=0;ce<U.length;ce++)K.writeFloat(U[ce])}function D(U,K){for(var ce=0;ce<U.length;ce++)K.writeDouble(U[ce])}function z(U,K){for(var ce=0;ce<U.length;ce++)K.writeBoolean(U[ce])}function V(U,K){for(var ce=0;ce<U.length;ce++)K.writeFixed32(U[ce])}function $(U,K){for(var ce=0;ce<U.length;ce++)K.writeSFixed32(U[ce])}function H(U,K){for(var ce=0;ce<U.length;ce++)K.writeFixed64(U[ce])}function J(U,K){for(var ce=0;ce<U.length;ce++)K.writeSFixed64(U[ce])}function re(U,K){return(U[K]|U[K+1]<<8|U[K+2]<<16)+16777216*U[K+3]}function me(U,K,ce){U[ce]=K,U[ce+1]=K>>>8,U[ce+2]=K>>>16,U[ce+3]=K>>>24}function oe(U,K){return(U[K]|U[K+1]<<8|U[K+2]<<16)+(U[K+3]<<24)}return s.prototype={destroy:function(){this.buf=null},readFields:function(U,K,ce){for(ce=ce||this.length;this.pos<ce;){var Oe=this.readVarint(),Ye=Oe>>3,Ne=this.pos;this.type=7&Oe,U(Ye,K,this),this.pos===Ne&&this.skip(Oe)}return K},readMessage:function(U,K){return this.readFields(U,K,this.readVarint()+this.pos)},readFixed32:function(){var U=re(this.buf,this.pos);return this.pos+=4,U},readSFixed32:function(){var U=oe(this.buf,this.pos);return this.pos+=4,U},readFixed64:function(){var U=re(this.buf,this.pos)+re(this.buf,this.pos+4)*h;return this.pos+=8,U},readSFixed64:function(){var U=re(this.buf,this.pos)+oe(this.buf,this.pos+4)*h;return this.pos+=8,U},readFloat:function(){var U=u.read(this.buf,this.pos,!0,23,4);return this.pos+=4,U},readDouble:function(){var U=u.read(this.buf,this.pos,!0,52,8);return this.pos+=8,U},readVarint:function(U){var K,ce,Oe=this.buf;return K=127&(ce=Oe[this.pos++]),ce<128?K:(K|=(127&(ce=Oe[this.pos++]))<<7,ce<128?K:(K|=(127&(ce=Oe[this.pos++]))<<14,ce<128?K:(K|=(127&(ce=Oe[this.pos++]))<<21,ce<128?K:function(Ye,Ne,Ve){var nt,Je,ot=Ve.buf;if(nt=(112&(Je=ot[Ve.pos++]))>>4,Je<128||(nt|=(127&(Je=ot[Ve.pos++]))<<3,Je<128)||(nt|=(127&(Je=ot[Ve.pos++]))<<10,Je<128)||(nt|=(127&(Je=ot[Ve.pos++]))<<17,Je<128)||(nt|=(127&(Je=ot[Ve.pos++]))<<24,Je<128)||(nt|=(1&(Je=ot[Ve.pos++]))<<31,Je<128))return b(Ye,nt,Ne);throw new Error("Expected varint not more than 10 bytes")}(K|=(15&(ce=Oe[this.pos]))<<28,U,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var U=this.readVarint();return U%2==1?(U+1)/-2:U/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var U=this.readVarint()+this.pos,K=this.pos;return this.pos=U,U-K>=12&&m?function(ce,Oe,Ye){return m.decode(ce.subarray(Oe,Ye))}(this.buf,K,U):function(ce,Oe,Ye){for(var Ne="",Ve=Oe;Ve<Ye;){var nt,Je,ot,He=ce[Ve],xt=null,It=He>239?4:He>223?3:He>191?2:1;if(Ve+It>Ye)break;It===1?He<128&&(xt=He):It===2?(192&(nt=ce[Ve+1]))==128&&(xt=(31&He)<<6|63&nt)<=127&&(xt=null):It===3?(Je=ce[Ve+2],(192&(nt=ce[Ve+1]))==128&&(192&Je)==128&&((xt=(15&He)<<12|(63&nt)<<6|63&Je)<=2047||xt>=55296&&xt<=57343)&&(xt=null)):It===4&&(Je=ce[Ve+2],ot=ce[Ve+3],(192&(nt=ce[Ve+1]))==128&&(192&Je)==128&&(192&ot)==128&&((xt=(15&He)<<18|(63&nt)<<12|(63&Je)<<6|63&ot)<=65535||xt>=1114112)&&(xt=null)),xt===null?(xt=65533,It=1):xt>65535&&(xt-=65536,Ne+=String.fromCharCode(xt>>>10&1023|55296),xt=56320|1023&xt),Ne+=String.fromCharCode(xt),Ve+=It}return Ne}(this.buf,K,U)},readBytes:function(){var U=this.readVarint()+this.pos,K=this.buf.subarray(this.pos,U);return this.pos=U,K},readPackedVarint:function(U,K){if(this.type!==s.Bytes)return U.push(this.readVarint(K));var ce=v(this);for(U=U||[];this.pos<ce;)U.push(this.readVarint(K));return U},readPackedSVarint:function(U){if(this.type!==s.Bytes)return U.push(this.readSVarint());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readSVarint());return U},readPackedBoolean:function(U){if(this.type!==s.Bytes)return U.push(this.readBoolean());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readBoolean());return U},readPackedFloat:function(U){if(this.type!==s.Bytes)return U.push(this.readFloat());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readFloat());return U},readPackedDouble:function(U){if(this.type!==s.Bytes)return U.push(this.readDouble());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readDouble());return U},readPackedFixed32:function(U){if(this.type!==s.Bytes)return U.push(this.readFixed32());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readFixed32());return U},readPackedSFixed32:function(U){if(this.type!==s.Bytes)return U.push(this.readSFixed32());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readSFixed32());return U},readPackedFixed64:function(U){if(this.type!==s.Bytes)return U.push(this.readFixed64());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readFixed64());return U},readPackedSFixed64:function(U){if(this.type!==s.Bytes)return U.push(this.readSFixed64());var K=v(this);for(U=U||[];this.pos<K;)U.push(this.readSFixed64());return U},skip:function(U){var K=7&U;if(K===s.Varint)for(;this.buf[this.pos++]>127;);else if(K===s.Bytes)this.pos=this.readVarint()+this.pos;else if(K===s.Fixed32)this.pos+=4;else{if(K!==s.Fixed64)throw new Error("Unimplemented type: "+K);this.pos+=8}},writeTag:function(U,K){this.writeVarint(U<<3|K)},realloc:function(U){for(var K=this.length||16;K<this.pos+U;)K*=2;if(K!==this.length){var ce=new Uint8Array(K);ce.set(this.buf),this.buf=ce,this.length=K}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(U){this.realloc(4),me(this.buf,U,this.pos),this.pos+=4},writeSFixed32:function(U){this.realloc(4),me(this.buf,U,this.pos),this.pos+=4},writeFixed64:function(U){this.realloc(8),me(this.buf,-1&U,this.pos),me(this.buf,Math.floor(U*d),this.pos+4),this.pos+=8},writeSFixed64:function(U){this.realloc(8),me(this.buf,-1&U,this.pos),me(this.buf,Math.floor(U*d),this.pos+4),this.pos+=8},writeVarint:function(U){(U=+U||0)>268435455||U<0?function(K,ce){var Oe,Ye;if(K>=0?(Oe=K%4294967296|0,Ye=K/4294967296|0):(Ye=~(-K/4294967296),4294967295^(Oe=~(-K%4294967296))?Oe=Oe+1|0:(Oe=0,Ye=Ye+1|0)),K>=18446744073709552e3||K<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");ce.realloc(10),function(Ne,Ve,nt){nt.buf[nt.pos++]=127&Ne|128,Ne>>>=7,nt.buf[nt.pos++]=127&Ne|128,Ne>>>=7,nt.buf[nt.pos++]=127&Ne|128,Ne>>>=7,nt.buf[nt.pos++]=127&Ne|128,nt.buf[nt.pos]=127&(Ne>>>=7)}(Oe,0,ce),function(Ne,Ve){var nt=(7&Ne)<<4;Ve.buf[Ve.pos++]|=nt|((Ne>>>=3)?128:0),Ne&&(Ve.buf[Ve.pos++]=127&Ne|((Ne>>>=7)?128:0),Ne&&(Ve.buf[Ve.pos++]=127&Ne|((Ne>>>=7)?128:0),Ne&&(Ve.buf[Ve.pos++]=127&Ne|((Ne>>>=7)?128:0),Ne&&(Ve.buf[Ve.pos++]=127&Ne|((Ne>>>=7)?128:0),Ne&&(Ve.buf[Ve.pos++]=127&Ne)))))}(Ye,ce)}(U,this):(this.realloc(4),this.buf[this.pos++]=127&U|(U>127?128:0),U<=127||(this.buf[this.pos++]=127&(U>>>=7)|(U>127?128:0),U<=127||(this.buf[this.pos++]=127&(U>>>=7)|(U>127?128:0),U<=127||(this.buf[this.pos++]=U>>>7&127))))},writeSVarint:function(U){this.writeVarint(U<0?2*-U-1:2*U)},writeBoolean:function(U){this.writeVarint(!!U)},writeString:function(U){U=String(U),this.realloc(4*U.length),this.pos++;var K=this.pos;this.pos=function(Oe,Ye,Ne){for(var Ve,nt,Je=0;Je<Ye.length;Je++){if((Ve=Ye.charCodeAt(Je))>55295&&Ve<57344){if(!nt){Ve>56319||Je+1===Ye.length?(Oe[Ne++]=239,Oe[Ne++]=191,Oe[Ne++]=189):nt=Ve;continue}if(Ve<56320){Oe[Ne++]=239,Oe[Ne++]=191,Oe[Ne++]=189,nt=Ve;continue}Ve=nt-55296<<10|Ve-56320|65536,nt=null}else nt&&(Oe[Ne++]=239,Oe[Ne++]=191,Oe[Ne++]=189,nt=null);Ve<128?Oe[Ne++]=Ve:(Ve<2048?Oe[Ne++]=Ve>>6|192:(Ve<65536?Oe[Ne++]=Ve>>12|224:(Oe[Ne++]=Ve>>18|240,Oe[Ne++]=Ve>>12&63|128),Oe[Ne++]=Ve>>6&63|128),Oe[Ne++]=63&Ve|128)}return Ne}(this.buf,U,this.pos);var ce=this.pos-K;ce>=128&&S(K,ce,this),this.pos=K-1,this.writeVarint(ce),this.pos+=ce},writeFloat:function(U){this.realloc(4),u.write(this.buf,U,this.pos,!0,23,4),this.pos+=4},writeDouble:function(U){this.realloc(8),u.write(this.buf,U,this.pos,!0,52,8),this.pos+=8},writeBytes:function(U){var K=U.length;this.writeVarint(K),this.realloc(K);for(var ce=0;ce<K;ce++)this.buf[this.pos++]=U[ce]},writeRawMessage:function(U,K){this.pos++;var ce=this.pos;U(K,this);var Oe=this.pos-ce;Oe>=128&&S(ce,Oe,this),this.pos=ce-1,this.writeVarint(Oe),this.pos+=Oe},writeMessage:function(U,K,ce){this.writeTag(U,s.Bytes),this.writeRawMessage(K,ce)},writePackedVarint:function(U,K){K.length&&this.writeMessage(U,E,K)},writePackedSVarint:function(U,K){K.length&&this.writeMessage(U,C,K)},writePackedBoolean:function(U,K){K.length&&this.writeMessage(U,z,K)},writePackedFloat:function(U,K){K.length&&this.writeMessage(U,k,K)},writePackedDouble:function(U,K){K.length&&this.writeMessage(U,D,K)},writePackedFixed32:function(U,K){K.length&&this.writeMessage(U,V,K)},writePackedSFixed32:function(U,K){K.length&&this.writeMessage(U,$,K)},writePackedFixed64:function(U,K){K.length&&this.writeMessage(U,H,K)},writePackedSFixed64:function(U,K){K.length&&this.writeMessage(U,J,K)},writeBytesField:function(U,K){this.writeTag(U,s.Bytes),this.writeBytes(K)},writeFixed32Field:function(U,K){this.writeTag(U,s.Fixed32),this.writeFixed32(K)},writeSFixed32Field:function(U,K){this.writeTag(U,s.Fixed32),this.writeSFixed32(K)},writeFixed64Field:function(U,K){this.writeTag(U,s.Fixed64),this.writeFixed64(K)},writeSFixed64Field:function(U,K){this.writeTag(U,s.Fixed64),this.writeSFixed64(K)},writeVarintField:function(U,K){this.writeTag(U,s.Varint),this.writeVarint(K)},writeSVarintField:function(U,K){this.writeTag(U,s.Varint),this.writeSVarint(K)},writeStringField:function(U,K){this.writeTag(U,s.Bytes),this.writeString(K)},writeFloatField:function(U,K){this.writeTag(U,s.Fixed32),this.writeFloat(K)},writeDoubleField:function(U,K){this.writeTag(U,s.Fixed64),this.writeDouble(K)},writeBooleanField:function(U,K){this.writeVarintField(U,!!K)}},Pg}var Ig=y(gx());const Cg=3;function pS(u,s,h){u===1&&h.readMessage(gS,s)}function gS(u,s,h){if(u===3){const{id:d,bitmap:m,width:v,height:b,left:S,top:E,advance:C}=h.readMessage(mS,{});s.push({id:d,bitmap:new bu({width:v+2*Cg,height:b+2*Cg},m),metrics:{width:v,height:b,left:S,top:E,advance:C}})}}function mS(u,s,h){u===1?s.id=h.readVarint():u===2?s.bitmap=h.readBytes():u===3?s.width=h.readVarint():u===4?s.height=h.readVarint():u===5?s.left=h.readSVarint():u===6?s.top=h.readSVarint():u===7&&(s.advance=h.readVarint())}const _S=Cg;function mx(u){let s=0,h=0;for(const b of u)s+=b.w*b.h,h=Math.max(h,b.w);u.sort((b,S)=>S.h-b.h);const d=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(s/.95)),h),h:1/0}];let m=0,v=0;for(const b of u)for(let S=d.length-1;S>=0;S--){const E=d[S];if(!(b.w>E.w||b.h>E.h)){if(b.x=E.x,b.y=E.y,v=Math.max(v,b.y+b.h),m=Math.max(m,b.x+b.w),b.w===E.w&&b.h===E.h){const C=d.pop();S<d.length&&(d[S]=C)}else b.h===E.h?(E.x+=b.w,E.w-=b.w):b.w===E.w?(E.y+=b.h,E.h-=b.h):(d.push({x:E.x+b.w,y:E.y,w:E.w-b.w,h:b.h}),E.y+=b.h,E.h-=b.h);break}}return{w:m,h:v,fill:s/(m*v)||0}}const Vr=1;class Mg{constructor(s,{pixelRatio:h,version:d,stretchX:m,stretchY:v,content:b,textFitWidth:S,textFitHeight:E}){this.paddedRect=s,this.pixelRatio=h,this.stretchX=m,this.stretchY=v,this.content=b,this.version=d,this.textFitWidth=S,this.textFitHeight=E}get tl(){return[this.paddedRect.x+Vr,this.paddedRect.y+Vr]}get br(){return[this.paddedRect.x+this.paddedRect.w-Vr,this.paddedRect.y+this.paddedRect.h-Vr]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*Vr)/this.pixelRatio,(this.paddedRect.h-2*Vr)/this.pixelRatio]}}class _x{constructor(s,h){const d={},m={};this.haveRenderCallbacks=[];const v=[];this.addImages(s,d,v),this.addImages(h,m,v);const{w:b,h:S}=mx(v),E=new sn({width:b||1,height:S||1});for(const C in s){const k=s[C],D=d[C].paddedRect;sn.copy(k.data,E,{x:0,y:0},{x:D.x+Vr,y:D.y+Vr},k.data)}for(const C in h){const k=h[C],D=m[C].paddedRect,z=D.x+Vr,V=D.y+Vr,$=k.data.width,H=k.data.height;sn.copy(k.data,E,{x:0,y:0},{x:z,y:V},k.data),sn.copy(k.data,E,{x:0,y:H-1},{x:z,y:V-1},{width:$,height:1}),sn.copy(k.data,E,{x:0,y:0},{x:z,y:V+H},{width:$,height:1}),sn.copy(k.data,E,{x:$-1,y:0},{x:z-1,y:V},{width:1,height:H}),sn.copy(k.data,E,{x:0,y:0},{x:z+$,y:V},{width:1,height:H})}this.image=E,this.iconPositions=d,this.patternPositions=m}addImages(s,h,d){for(const m in s){const v=s[m],b={x:0,y:0,w:v.data.width+2*Vr,h:v.data.height+2*Vr};d.push(b),h[m]=new Mg(b,v),v.hasRenderCallback&&this.haveRenderCallbacks.push(m)}}patchUpdatedImages(s,h){s.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const d in s.updatedImages)this.patchUpdatedImage(this.iconPositions[d],s.getImage(d),h),this.patchUpdatedImage(this.patternPositions[d],s.getImage(d),h)}patchUpdatedImage(s,h,d){if(!s||!h||s.version===h.version)return;s.version=h.version;const[m,v]=s.tl;d.update(h.data,void 0,{x:m,y:v})}}var Oo;mt("ImagePosition",Mg),mt("ImageAtlas",_x),f.ah=void 0,(Oo=f.ah||(f.ah={}))[Oo.none=0]="none",Oo[Oo.horizontal=1]="horizontal",Oo[Oo.vertical=2]="vertical",Oo[Oo.horizontalOnly=3]="horizontalOnly";const Of=-17;class ku{constructor(){this.scale=1,this.fontStack="",this.imageName=null,this.verticalAlign="bottom"}static forText(s,h,d){const m=new ku;return m.scale=s||1,m.fontStack=h,m.verticalAlign=d||"bottom",m}static forImage(s,h){const d=new ku;return d.imageName=s,d.verticalAlign=h||"bottom",d}}class zl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(s,h){const d=new zl;for(let m=0;m<s.sections.length;m++){const v=s.sections[m];v.image?d.addImageSection(v):d.addTextSection(v,h)}return d}length(){return this.text.length}getSection(s){return this.sections[this.sectionIndex[s]]}getSectionIndex(s){return this.sectionIndex[s]}getCharCode(s){return this.text.charCodeAt(s)}verticalizePunctuation(){this.text=function(s){let h="";for(let d=0;d<s.length;d++){const m=s.charCodeAt(d+1)||null,v=s.charCodeAt(d-1)||null;h+=m&&lu(m)&&!Ru[s[d+1]]||v&&lu(v)&&!Ru[s[d-1]]||!Ru[s[d]]?s[d]:Ru[s[d]]}return h}(this.text)}trim(){let s=0;for(let d=0;d<this.text.length&&Lf[this.text.charCodeAt(d)];d++)s++;let h=this.text.length;for(let d=this.text.length-1;d>=0&&d>=s&&Lf[this.text.charCodeAt(d)];d--)h--;this.text=this.text.substring(s,h),this.sectionIndex=this.sectionIndex.slice(s,h)}substring(s,h){const d=new zl;return d.text=this.text.substring(s,h),d.sectionIndex=this.sectionIndex.slice(s,h),d.sections=this.sections,d}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((s,h)=>Math.max(s,this.sections[h].scale),0)}getMaxImageSize(s){let h=0,d=0;for(let m=0;m<this.length();m++){const v=this.getSection(m);if(v.imageName){const b=s[v.imageName];if(!b)continue;const S=b.displaySize;h=Math.max(h,S[0]),d=Math.max(d,S[1])}}return{maxImageWidth:h,maxImageHeight:d}}addTextSection(s,h){this.text+=s.text,this.sections.push(ku.forText(s.scale,s.fontStack||h,s.verticalAlign));const d=this.sections.length-1;for(let m=0;m<s.text.length;++m)this.sectionIndex.push(d)}addImageSection(s){const h=s.image?s.image.name:"";if(h.length===0)return void Li("Can't add FormattedSection with an empty image.");const d=this.getNextImageSectionCharCode();d?(this.text+=String.fromCharCode(d),this.sections.push(ku.forImage(h,s.verticalAlign)),this.sectionIndex.push(this.sections.length-1)):Li("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Ff(u,s,h,d,m,v,b,S,E,C,k,D,z,V,$){const H=zl.fromFeature(u,m);let J;D===f.ah.vertical&&H.verticalizePunctuation();const{processBidirectionalText:re,processStyledBidirectionalText:me}=Ln;if(re&&H.sections.length===1){J=[];const K=re(H.toString(),Rg(H,C,v,s,d,V));for(const ce of K){const Oe=new zl;Oe.text=ce,Oe.sections=H.sections;for(let Ye=0;Ye<ce.length;Ye++)Oe.sectionIndex.push(0);J.push(Oe)}}else if(me){J=[];const K=me(H.text,H.sectionIndex,Rg(H,C,v,s,d,V));for(const ce of K){const Oe=new zl;Oe.text=ce[0],Oe.sectionIndex=ce[1],Oe.sections=H.sections,J.push(Oe)}}else J=function(K,ce){const Oe=[],Ye=K.text;let Ne=0;for(const Ve of ce)Oe.push(K.substring(Ne,Ve)),Ne=Ve;return Ne<Ye.length&&Oe.push(K.substring(Ne,Ye.length)),Oe}(H,Rg(H,C,v,s,d,V));const oe=[],U={positionedLines:oe,text:H.toString(),top:k[1],bottom:k[1],left:k[0],right:k[0],writingMode:D,iconsInText:!1,verticalizable:!1};return function(K,ce,Oe,Ye,Ne,Ve,nt,Je,ot,He,xt,It){let At=0,wt=0,Zt=0,Oi=0;const Qi=Je==="right"?1:Je==="left"?0:.5,xr=Ji/It;let an=0;for(const Ci of Ne){Ci.trim();const ir=Ci.getMaxScale(),fr={positionedGlyphs:[],lineOffset:0};K.positionedLines[an]=fr;const dr=fr.positionedGlyphs;let Or=0;if(!Ci.length()){wt+=Ve,++an;continue}const ln=bS(Ye,Ci,xr);for(let $r=0;$r<Ci.length();$r++){const er=Ci.getSection($r),nr=Ci.getSectionIndex($r),sr=Ci.getCharCode($r),Hi=wS(ot,xt,sr);let vi;if(er.imageName){if(K.iconsInText=!0,er.scale=er.scale*xr,vi=SS(er,Hi,ir,ln,Ye),!vi)continue;Or=Math.max(Or,vi.imageOffset)}else if(vi=TS(er,sr,Hi,ln,ce,Oe),!vi)continue;const{rect:Un,metrics:$l,baselineOffset:Vn}=vi;dr.push({glyph:sr,imageName:er.imageName,x:At,y:wt+Vn+Of,vertical:Hi,scale:er.scale,fontStack:er.fontStack,sectionIndex:nr,metrics:$l,rect:Un}),Hi?(K.verticalizable=!0,At+=(er.imageName?$l.advance:Ji)*er.scale+He):At+=$l.advance*er.scale+He}dr.length!==0&&(Zt=Math.max(At-He,Zt),AS(dr,0,dr.length-1,Qi)),At=0,fr.lineOffset=Math.max(Or,(ir-1)*Ji);const rr=Ve*ir+Or;wt+=rr,Oi=Math.max(rr,Oi),++an}const{horizontalAlign:jr,verticalAlign:hr}=kg(nt);(function(Ci,ir,fr,dr,Or,ln,rr,$r,er){const nr=(ir-fr)*Or;let sr=0;sr=ln!==rr?-$r*dr-Of:-dr*er*rr+.5*rr;for(const Hi of Ci)for(const vi of Hi.positionedGlyphs)vi.x+=nr,vi.y+=sr})(K.positionedLines,Qi,jr,hr,Zt,Oi,Ve,wt,Ne.length),K.top+=-hr*wt,K.bottom=K.top+wt,K.left+=-jr*Zt,K.right=K.left+Zt}(U,s,h,d,J,b,S,E,D,C,z,$),!function(K){for(const ce of K)if(ce.positionedGlyphs.length!==0)return!1;return!0}(oe)&&U}const Lf={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},yS={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},xS={40:!0};function yx(u,s,h,d,m,v){if(s.imageName){const b=d[s.imageName];return b?b.displaySize[0]*s.scale*Ji/v+m:0}{const b=h[s.fontStack],S=b&&b[u];return S?S.metrics.advance*s.scale+m:0}}function xx(u,s,h,d){const m=Math.pow(u-s,2);return d?u<s?m/2:2*m:m+Math.abs(h)*h}function vS(u,s,h){let d=0;return u===10&&(d-=1e4),h&&(d+=150),u!==40&&u!==65288||(d+=50),s!==41&&s!==65289||(d+=50),d}function vx(u,s,h,d,m,v){let b=null,S=xx(s,h,m,v);for(const E of d){const C=xx(s-E.x,h,m,v)+E.badness;C<=S&&(b=E,S=C)}return{index:u,x:s,priorBreak:b,badness:S}}function bx(u){return u?bx(u.priorBreak).concat(u.index):[]}function Rg(u,s,h,d,m,v){if(!u)return[];const b=[],S=function(D,z,V,$,H,J){let re=0;for(let me=0;me<D.length();me++){const oe=D.getSection(me);re+=yx(D.getCharCode(me),oe,$,H,z,J)}return re/Math.max(1,Math.ceil(re/V))}(u,s,h,d,m,v),E=u.text.indexOf("​")>=0;let C=0;for(let D=0;D<u.length();D++){const z=u.getSection(D),V=u.getCharCode(D);if(Lf[V]||(C+=yx(V,z,d,m,s,v)),D<u.length()-1){const $=!((k=V)<11904)&&(!!Ht["CJK Compatibility Forms"](k)||!!Ht["CJK Compatibility"](k)||!!Ht["CJK Strokes"](k)||!!Ht["CJK Symbols and Punctuation"](k)||!!Ht["Enclosed CJK Letters and Months"](k)||!!Ht["Halfwidth and Fullwidth Forms"](k)||!!Ht["Ideographic Description Characters"](k)||!!Ht["Vertical Forms"](k)||ou.test(String.fromCodePoint(k)));(yS[V]||$||z.imageName||D!==u.length()-2&&xS[u.getCharCode(D+1)])&&b.push(vx(D+1,C,S,b,vS(V,u.getCharCode(D+1),$&&E),!1))}}var k;return bx(vx(u.length(),C,S,b,0,!0))}function kg(u){let s=.5,h=.5;switch(u){case"right":case"top-right":case"bottom-right":s=1;break;case"left":case"top-left":case"bottom-left":s=0}switch(u){case"bottom":case"bottom-right":case"bottom-left":h=1;break;case"top":case"top-right":case"top-left":h=0}return{horizontalAlign:s,verticalAlign:h}}function bS(u,s,h){const d=s.getMaxScale()*Ji,{maxImageWidth:m,maxImageHeight:v}=s.getMaxImageSize(u),b=Math.max(d,v*h);return{verticalLineContentWidth:Math.max(d,m*h),horizontalLineContentHeight:b}}function wx(u){switch(u){case"top":return 0;case"center":return .5;default:return 1}}function wS(u,s,h){return!(u===f.ah.horizontal||!s&&!au(h)||s&&(Lf[h]||(d=h,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(d)))));var d}function TS(u,s,h,d,m,v){const b=v[u.fontStack],S=function(C,k,D,z){if(C&&C.rect)return C;const V=k[D.fontStack],$=V&&V[z];return $?{rect:null,metrics:$.metrics}:null}(b&&b[s],m,u,s);if(S===null)return null;let E;if(h)E=d.verticalLineContentWidth-u.scale*Ji;else{const C=wx(u.verticalAlign);E=(d.horizontalLineContentHeight-u.scale*Ji)*C}return{rect:S.rect,metrics:S.metrics,baselineOffset:E}}function SS(u,s,h,d,m){const v=m[u.imageName];if(!v)return null;const b=v.paddedRect,S=v.displaySize,E={width:S[0],height:S[1],left:Vr,top:-3,advance:s?S[1]:S[0]};let C;if(s)C=d.verticalLineContentWidth-S[1]*u.scale;else{const k=wx(u.verticalAlign);C=(d.horizontalLineContentHeight-S[1]*u.scale)*k}return{rect:b,metrics:E,baselineOffset:C,imageOffset:(s?S[0]:S[1])*u.scale-Ji*h}}function AS(u,s,h,d){if(d===0)return;const m=u[h],v=(u[h].x+m.metrics.advance*m.scale)*d;for(let b=s;b<=h;b++)u[b].x-=v}function PS(u,s,h){const{horizontalAlign:d,verticalAlign:m}=kg(h),v=s[0]-u.displaySize[0]*d,b=s[1]-u.displaySize[1]*m;return{image:u,top:b,bottom:b+u.displaySize[1],left:v,right:v+u.displaySize[0]}}function Tx(u){var s,h;let d=u.left,m=u.top,v=u.right-d,b=u.bottom-m;const S=(s=u.image.textFitWidth)!==null&&s!==void 0?s:"stretchOrShrink",E=(h=u.image.textFitHeight)!==null&&h!==void 0?h:"stretchOrShrink",C=(u.image.content[2]-u.image.content[0])/(u.image.content[3]-u.image.content[1]);if(E==="proportional"){if(S==="stretchOnly"&&v/b<C||S==="proportional"){const k=Math.ceil(b*C);d*=k/v,v=k}}else if(S==="proportional"&&E==="stretchOnly"&&C!==0&&v/b>C){const k=Math.ceil(v/C);m*=k/b,b=k}return{x1:d,y1:m,x2:d+v,y2:m+b}}function Sx(u,s,h,d,m,v){const b=u.image;let S;if(b.content){const J=b.content,re=b.pixelRatio||1;S=[J[0]/re,J[1]/re,b.displaySize[0]-J[2]/re,b.displaySize[1]-J[3]/re]}const E=s.left*v,C=s.right*v;let k,D,z,V;h==="width"||h==="both"?(V=m[0]+E-d[3],D=m[0]+C+d[1]):(V=m[0]+(E+C-b.displaySize[0])/2,D=V+b.displaySize[0]);const $=s.top*v,H=s.bottom*v;return h==="height"||h==="both"?(k=m[1]+$-d[0],z=m[1]+H+d[2]):(k=m[1]+($+H-b.displaySize[1])/2,z=k+b.displaySize[1]),{image:b,top:k,right:D,bottom:z,left:V,collisionPadding:S}}const Du=255,ps=128,Fo=Du*ps;function Ax(u,s){const{expression:h}=s;if(h.kind==="constant")return{kind:"constant",layoutSize:h.evaluate(new yi(u+1))};if(h.kind==="source")return{kind:"source"};{const{zoomStops:d,interpolationType:m}=h;let v=0;for(;v<d.length&&d[v]<=u;)v++;v=Math.max(0,v-1);let b=v;for(;b<d.length&&d[b]<u+1;)b++;b=Math.min(d.length-1,b);const S=d[v],E=d[b];return h.kind==="composite"?{kind:"composite",minZoom:S,maxZoom:E,interpolationType:m}:{kind:"camera",minZoom:S,maxZoom:E,minSize:h.evaluate(new yi(S)),maxSize:h.evaluate(new yi(E)),interpolationType:m}}}function Dg(u,s,h){let d="never";const m=u.get(s);return m?d=m:u.get(h)&&(d="always"),d}const ES=Iu.VectorTileFeature.types,IS=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Bf(u,s,h,d,m,v,b,S,E,C,k,D,z){const V=S?Math.min(Fo,Math.round(S[0])):0,$=S?Math.min(Fo,Math.round(S[1])):0;u.emplaceBack(s,h,Math.round(32*d),Math.round(32*m),v,b,(V<<1)+(E?1:0),$,16*C,16*k,256*D,256*z)}function Og(u,s,h){u.emplaceBack(s.x,s.y,h),u.emplaceBack(s.x,s.y,h),u.emplaceBack(s.x,s.y,h),u.emplaceBack(s.x,s.y,h)}function CS(u){for(const s of u.sections)if(og(s.text))return!0;return!1}class Fg{constructor(s){this.layoutVertexArray=new We,this.indexArray=new qe,this.programConfigurations=s,this.segments=new jt,this.dynamicLayoutVertexArray=new Ze,this.opacityVertexArray=new je,this.hasVisibleVertices=!1,this.placedSymbolArray=new O}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(s,h,d,m){this.isEmpty()||(d&&(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,lS.members),this.indexBuffer=s.createIndexBuffer(this.indexArray,h),this.dynamicLayoutVertexBuffer=s.createVertexBuffer(this.dynamicLayoutVertexArray,cS.members,!0),this.opacityVertexBuffer=s.createVertexBuffer(this.opacityVertexArray,IS,!0),this.opacityVertexBuffer.itemSize=1),(d||m)&&this.programConfigurations.upload(s))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}mt("SymbolBuffers",Fg);class Lg{constructor(s,h,d){this.layoutVertexArray=new s,this.layoutAttributes=h,this.indexArray=new d,this.segments=new jt,this.collisionVertexArray=new at}upload(s){this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=s.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=s.createVertexBuffer(this.collisionVertexArray,uS.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}mt("CollisionBuffers",Lg);class Ul{constructor(s){this.collisionBoxArray=s.collisionBoxArray,this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(b=>b.id),this.index=s.index,this.pixelRatio=s.pixelRatio,this.sourceLayerIndex=s.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const h=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Ax(this.zoom,h["text-size"]),this.iconSizeData=Ax(this.zoom,h["icon-size"]);const d=this.layers[0].layout,m=d.get("symbol-sort-key"),v=d.get("symbol-z-order");this.canOverlap=Dg(d,"text-overlap","text-allow-overlap")!=="never"||Dg(d,"icon-overlap","icon-allow-overlap")!=="never"||d.get("text-ignore-placement")||d.get("icon-ignore-placement"),this.sortFeaturesByKey=v!=="viewport-y"&&!m.isConstant(),this.sortFeaturesByY=(v==="viewport-y"||v==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,d.get("symbol-placement")==="point"&&(this.writingModes=d.get("text-writing-mode").map(b=>f.ah[b])),this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id),this.sourceID=s.sourceID}createArrays(){this.text=new Fg(new Zs(this.layers,this.zoom,s=>/^text/.test(s))),this.icon=new Fg(new Zs(this.layers,this.zoom,s=>/^icon/.test(s))),this.glyphOffsetArray=new W,this.lineVertexArray=new X,this.symbolInstances=new B,this.textAnchorOffsets=new Q}calculateGlyphDependencies(s,h,d,m,v){for(let b=0;b<s.length;b++)if(h[s.charCodeAt(b)]=!0,(d||m)&&v){const S=Ru[s.charAt(b)];S&&(h[S.charCodeAt(0)]=!0)}}populate(s,h,d){const m=this.layers[0],v=m.layout,b=v.get("text-font"),S=v.get("text-field"),E=v.get("icon-image"),C=(S.value.kind!=="constant"||S.value.value instanceof br&&!S.value.value.isEmpty()||S.value.value.toString().length>0)&&(b.value.kind!=="constant"||b.value.value.length>0),k=E.value.kind!=="constant"||!!E.value.value||Object.keys(E.parameters).length>0,D=v.get("symbol-sort-key");if(this.features=[],!C&&!k)return;const z=h.iconDependencies,V=h.glyphDependencies,$=h.availableImages,H=new yi(this.zoom);for(const{feature:J,id:re,index:me,sourceLayerIndex:oe}of s){const U=m._featureFilter.needGeometry,K=ds(J,U);if(!m._featureFilter.filter(H,K,d))continue;let ce,Oe;if(U||(K.geometry=fs(J)),C){const Ne=m.getValueAndResolveTokens("text-field",K,d,$),Ve=br.factory(Ne),nt=this.hasRTLText=this.hasRTLText||CS(Ve);(!nt||Ln.getRTLTextPluginStatus()==="unavailable"||nt&&Ln.isParsed())&&(ce=fS(Ve,m,K))}if(k){const Ne=m.getValueAndResolveTokens("icon-image",K,d,$);Oe=Ne instanceof Cr?Ne:Cr.fromString(Ne)}if(!ce&&!Oe)continue;const Ye=this.sortFeaturesByKey?D.evaluate(K,{},d):void 0;if(this.features.push({id:re,text:ce,icon:Oe,index:me,sourceLayerIndex:oe,geometry:K.geometry,properties:J.properties,type:ES[J.type],sortKey:Ye}),Oe&&(z[Oe.name]=!0),ce){const Ne=b.evaluate(K,{},d).join(","),Ve=v.get("text-rotation-alignment")!=="viewport"&&v.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(f.ah.vertical)>=0;for(const nt of ce.sections)if(nt.image)z[nt.image.name]=!0;else{const Je=El(ce.toString()),ot=nt.fontStack||Ne,He=V[ot]=V[ot]||{};this.calculateGlyphDependencies(nt.text,He,Ve,this.allowVerticalPlacement,Je)}}}v.get("symbol-placement")==="line"&&(this.features=function(J){const re={},me={},oe=[];let U=0;function K(Ne){oe.push(J[Ne]),U++}function ce(Ne,Ve,nt){const Je=me[Ne];return delete me[Ne],me[Ve]=Je,oe[Je].geometry[0].pop(),oe[Je].geometry[0]=oe[Je].geometry[0].concat(nt[0]),Je}function Oe(Ne,Ve,nt){const Je=re[Ve];return delete re[Ve],re[Ne]=Je,oe[Je].geometry[0].shift(),oe[Je].geometry[0]=nt[0].concat(oe[Je].geometry[0]),Je}function Ye(Ne,Ve,nt){const Je=nt?Ve[0][Ve[0].length-1]:Ve[0][0];return`${Ne}:${Je.x}:${Je.y}`}for(let Ne=0;Ne<J.length;Ne++){const Ve=J[Ne],nt=Ve.geometry,Je=Ve.text?Ve.text.toString():null;if(!Je){K(Ne);continue}const ot=Ye(Je,nt),He=Ye(Je,nt,!0);if(ot in me&&He in re&&me[ot]!==re[He]){const xt=Oe(ot,He,nt),It=ce(ot,He,oe[xt].geometry);delete re[ot],delete me[He],me[Ye(Je,oe[It].geometry,!0)]=It,oe[xt].geometry=null}else ot in me?ce(ot,He,nt):He in re?Oe(ot,He,nt):(K(Ne),re[ot]=U-1,me[He]=U-1)}return oe.filter(Ne=>Ne.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((J,re)=>J.sortKey-re.sortKey)}update(s,h,d){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(s,h,this.layers,d),this.icon.programConfigurations.updatePaintArrays(s,h,this.layers,d))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(s){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(s),this.iconCollisionBox.upload(s)),this.text.upload(s,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(s,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(s,h){const d=this.lineVertexArray.length;if(s.segment!==void 0){let m=s.dist(h[s.segment+1]),v=s.dist(h[s.segment]);const b={};for(let S=s.segment+1;S<h.length;S++)b[S]={x:h[S].x,y:h[S].y,tileUnitDistanceFromAnchor:m},S<h.length-1&&(m+=h[S+1].dist(h[S]));for(let S=s.segment||0;S>=0;S--)b[S]={x:h[S].x,y:h[S].y,tileUnitDistanceFromAnchor:v},S>0&&(v+=h[S-1].dist(h[S]));for(let S=0;S<h.length;S++){const E=b[S];this.lineVertexArray.emplaceBack(E.x,E.y,E.tileUnitDistanceFromAnchor)}}return{lineStartIndex:d,lineLength:this.lineVertexArray.length-d}}addSymbols(s,h,d,m,v,b,S,E,C,k,D,z){const V=s.indexArray,$=s.layoutVertexArray,H=s.segments.prepareSegment(4*h.length,$,V,this.canOverlap?b.sortKey:void 0),J=this.glyphOffsetArray.length,re=H.vertexLength,me=this.allowVerticalPlacement&&S===f.ah.vertical?Math.PI/2:0,oe=b.text&&b.text.sections;for(let U=0;U<h.length;U++){const{tl:K,tr:ce,bl:Oe,br:Ye,tex:Ne,pixelOffsetTL:Ve,pixelOffsetBR:nt,minFontScaleX:Je,minFontScaleY:ot,glyphOffset:He,isSDF:xt,sectionIndex:It}=h[U],At=H.vertexLength,wt=He[1];Bf($,E.x,E.y,K.x,wt+K.y,Ne.x,Ne.y,d,xt,Ve.x,Ve.y,Je,ot),Bf($,E.x,E.y,ce.x,wt+ce.y,Ne.x+Ne.w,Ne.y,d,xt,nt.x,Ve.y,Je,ot),Bf($,E.x,E.y,Oe.x,wt+Oe.y,Ne.x,Ne.y+Ne.h,d,xt,Ve.x,nt.y,Je,ot),Bf($,E.x,E.y,Ye.x,wt+Ye.y,Ne.x+Ne.w,Ne.y+Ne.h,d,xt,nt.x,nt.y,Je,ot),Og(s.dynamicLayoutVertexArray,E,me),V.emplaceBack(At,At+2,At+1),V.emplaceBack(At+1,At+2,At+3),H.vertexLength+=4,H.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(He[0]),U!==h.length-1&&It===h[U+1].sectionIndex||s.programConfigurations.populatePaintArrays($.length,b,b.index,{},z,oe&&oe[It])}s.placedSymbolArray.emplaceBack(E.x,E.y,J,this.glyphOffsetArray.length-J,re,C,k,E.segment,d?d[0]:0,d?d[1]:0,m[0],m[1],S,0,!1,0,D)}_addCollisionDebugVertex(s,h,d,m,v,b){return h.emplaceBack(0,0),s.emplaceBack(d.x,d.y,m,v,Math.round(b.x),Math.round(b.y))}addCollisionDebugVertices(s,h,d,m,v,b,S){const E=v.segments.prepareSegment(4,v.layoutVertexArray,v.indexArray),C=E.vertexLength,k=v.layoutVertexArray,D=v.collisionVertexArray,z=S.anchorX,V=S.anchorY;this._addCollisionDebugVertex(k,D,b,z,V,new Y(s,h)),this._addCollisionDebugVertex(k,D,b,z,V,new Y(d,h)),this._addCollisionDebugVertex(k,D,b,z,V,new Y(d,m)),this._addCollisionDebugVertex(k,D,b,z,V,new Y(s,m)),E.vertexLength+=4;const $=v.indexArray;$.emplaceBack(C,C+1),$.emplaceBack(C+1,C+2),$.emplaceBack(C+2,C+3),$.emplaceBack(C+3,C),E.primitiveLength+=4}addDebugCollisionBoxes(s,h,d,m){for(let v=s;v<h;v++){const b=this.collisionBoxArray.get(v);this.addCollisionDebugVertices(b.x1,b.y1,b.x2,b.y2,m?this.textCollisionBox:this.iconCollisionBox,b.anchorPoint,d)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Lg(lt,fx.members,bt),this.iconCollisionBox=new Lg(lt,fx.members,bt);for(let s=0;s<this.symbolInstances.length;s++){const h=this.symbolInstances.get(s);this.addDebugCollisionBoxes(h.textBoxStartIndex,h.textBoxEndIndex,h,!0),this.addDebugCollisionBoxes(h.verticalTextBoxStartIndex,h.verticalTextBoxEndIndex,h,!0),this.addDebugCollisionBoxes(h.iconBoxStartIndex,h.iconBoxEndIndex,h,!1),this.addDebugCollisionBoxes(h.verticalIconBoxStartIndex,h.verticalIconBoxEndIndex,h,!1)}}_deserializeCollisionBoxesForSymbol(s,h,d,m,v,b,S,E,C){const k={};for(let D=h;D<d;D++){const z=s.get(D);k.textBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},k.textFeatureIndex=z.featureIndex;break}for(let D=m;D<v;D++){const z=s.get(D);k.verticalTextBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},k.verticalTextFeatureIndex=z.featureIndex;break}for(let D=b;D<S;D++){const z=s.get(D);k.iconBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},k.iconFeatureIndex=z.featureIndex;break}for(let D=E;D<C;D++){const z=s.get(D);k.verticalIconBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},k.verticalIconFeatureIndex=z.featureIndex;break}return k}deserializeCollisionBoxes(s){this.collisionArrays=[];for(let h=0;h<this.symbolInstances.length;h++){const d=this.symbolInstances.get(h);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(s,d.textBoxStartIndex,d.textBoxEndIndex,d.verticalTextBoxStartIndex,d.verticalTextBoxEndIndex,d.iconBoxStartIndex,d.iconBoxEndIndex,d.verticalIconBoxStartIndex,d.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(s,h){const d=s.placedSymbolArray.get(h),m=d.vertexStartIndex+4*d.numGlyphs;for(let v=d.vertexStartIndex;v<m;v+=4)s.indexArray.emplaceBack(v,v+2,v+1),s.indexArray.emplaceBack(v+1,v+2,v+3)}getSortedSymbolIndexes(s){if(this.sortedAngle===s&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const h=Math.sin(s),d=Math.cos(s),m=[],v=[],b=[];for(let S=0;S<this.symbolInstances.length;++S){b.push(S);const E=this.symbolInstances.get(S);m.push(0|Math.round(h*E.anchorX+d*E.anchorY)),v.push(E.featureIndex)}return b.sort((S,E)=>m[S]-m[E]||v[E]-v[S]),b}addToSortKeyRanges(s,h){const d=this.sortKeyRanges[this.sortKeyRanges.length-1];d&&d.sortKey===h?d.symbolInstanceEnd=s+1:this.sortKeyRanges.push({sortKey:h,symbolInstanceStart:s,symbolInstanceEnd:s+1})}sortFeatures(s){if(this.sortFeaturesByY&&this.sortedAngle!==s&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(s),this.sortedAngle=s,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const h of this.symbolInstanceIndexes){const d=this.symbolInstances.get(h);this.featureSortOrder.push(d.featureIndex),[d.rightJustifiedTextSymbolIndex,d.centerJustifiedTextSymbolIndex,d.leftJustifiedTextSymbolIndex].forEach((m,v,b)=>{m>=0&&b.indexOf(m)===v&&this.addIndicesForPlacedSymbol(this.text,m)}),d.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,d.verticalPlacedTextSymbolIndex),d.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,d.placedIconSymbolIndex),d.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,d.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Px,Ex;mt("SymbolBucket",Ul,{omit:["layers","collisionBoxArray","features","compareText"]}),Ul.MAX_GLYPHS=65535,Ul.addDynamicAttributes=Og;var Bg={get paint(){return Ex=Ex||new kr({"icon-opacity":new Mt(j.paint_symbol["icon-opacity"]),"icon-color":new Mt(j.paint_symbol["icon-color"]),"icon-halo-color":new Mt(j.paint_symbol["icon-halo-color"]),"icon-halo-width":new Mt(j.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Mt(j.paint_symbol["icon-halo-blur"]),"icon-translate":new St(j.paint_symbol["icon-translate"]),"icon-translate-anchor":new St(j.paint_symbol["icon-translate-anchor"]),"text-opacity":new Mt(j.paint_symbol["text-opacity"]),"text-color":new Mt(j.paint_symbol["text-color"],{runtimeType:zt,getOverride:u=>u.textColor,hasOverride:u=>!!u.textColor}),"text-halo-color":new Mt(j.paint_symbol["text-halo-color"]),"text-halo-width":new Mt(j.paint_symbol["text-halo-width"]),"text-halo-blur":new Mt(j.paint_symbol["text-halo-blur"]),"text-translate":new St(j.paint_symbol["text-translate"]),"text-translate-anchor":new St(j.paint_symbol["text-translate-anchor"])})},get layout(){return Px=Px||new kr({"symbol-placement":new St(j.layout_symbol["symbol-placement"]),"symbol-spacing":new St(j.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new St(j.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Mt(j.layout_symbol["symbol-sort-key"]),"symbol-z-order":new St(j.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new St(j.layout_symbol["icon-allow-overlap"]),"icon-overlap":new St(j.layout_symbol["icon-overlap"]),"icon-ignore-placement":new St(j.layout_symbol["icon-ignore-placement"]),"icon-optional":new St(j.layout_symbol["icon-optional"]),"icon-rotation-alignment":new St(j.layout_symbol["icon-rotation-alignment"]),"icon-size":new Mt(j.layout_symbol["icon-size"]),"icon-text-fit":new St(j.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new St(j.layout_symbol["icon-text-fit-padding"]),"icon-image":new Mt(j.layout_symbol["icon-image"]),"icon-rotate":new Mt(j.layout_symbol["icon-rotate"]),"icon-padding":new Mt(j.layout_symbol["icon-padding"]),"icon-keep-upright":new St(j.layout_symbol["icon-keep-upright"]),"icon-offset":new Mt(j.layout_symbol["icon-offset"]),"icon-anchor":new Mt(j.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new St(j.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new St(j.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new St(j.layout_symbol["text-rotation-alignment"]),"text-field":new Mt(j.layout_symbol["text-field"]),"text-font":new Mt(j.layout_symbol["text-font"]),"text-size":new Mt(j.layout_symbol["text-size"]),"text-max-width":new Mt(j.layout_symbol["text-max-width"]),"text-line-height":new St(j.layout_symbol["text-line-height"]),"text-letter-spacing":new Mt(j.layout_symbol["text-letter-spacing"]),"text-justify":new Mt(j.layout_symbol["text-justify"]),"text-radial-offset":new Mt(j.layout_symbol["text-radial-offset"]),"text-variable-anchor":new St(j.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new Mt(j.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new Mt(j.layout_symbol["text-anchor"]),"text-max-angle":new St(j.layout_symbol["text-max-angle"]),"text-writing-mode":new St(j.layout_symbol["text-writing-mode"]),"text-rotate":new Mt(j.layout_symbol["text-rotate"]),"text-padding":new St(j.layout_symbol["text-padding"]),"text-keep-upright":new St(j.layout_symbol["text-keep-upright"]),"text-transform":new Mt(j.layout_symbol["text-transform"]),"text-offset":new Mt(j.layout_symbol["text-offset"]),"text-allow-overlap":new St(j.layout_symbol["text-allow-overlap"]),"text-overlap":new St(j.layout_symbol["text-overlap"]),"text-ignore-placement":new St(j.layout_symbol["text-ignore-placement"]),"text-optional":new St(j.layout_symbol["text-optional"])})}};class Ix{constructor(s){if(s.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=s.property.overrides?s.property.overrides.runtimeType:Kt,this.defaultValue=s}evaluate(s){if(s.formattedSection){const h=this.defaultValue.property.overrides;if(h&&h.hasOverride(s.formattedSection))return h.getOverride(s.formattedSection)}return s.feature&&s.featureState?this.defaultValue.evaluate(s.feature,s.featureState):this.defaultValue.property.specification.default}eachChild(s){this.defaultValue.isConstant()||s(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}mt("FormatSectionOverride",Ix,{omit:["defaultValue"]});class Nf extends Tr{constructor(s){super(s,Bg)}recalculate(s,h){if(super.recalculate(s,h),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const d=this.layout.get("text-writing-mode");if(d){const m=[];for(const v of d)m.indexOf(v)<0&&m.push(v);this.layout._values["text-writing-mode"]=m}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(s,h,d,m){const v=this.layout.get(s).evaluate(h,{},d,m),b=this._unevaluatedLayout._values[s];return b.isDataDriven()||ma(b.value)||!v?v:function(S,E){return E.replace(/{([^{}]+)}/g,(C,k)=>S&&k in S?String(S[k]):"")}(h.properties,v)}createBucket(s){return new Ul(s)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const s of Bg.paint.overridableProperties){if(!Nf.hasPaintOverride(this.layout,s))continue;const h=this.paint.get(s),d=new Ix(h),m=new So(d,h.property.specification);let v=null;v=h.value.kind==="constant"||h.value.kind==="source"?new qc("source",m):new Gc("composite",m,h.value.zoomStops),this.paint._values[s]=new yn(h.property,v,h.parameters)}}_handleOverridablePaintPropertyUpdate(s,h,d){return!(!this.layout||h.isDataDriven()||d.isDataDriven())&&Nf.hasPaintOverride(this.layout,s)}static hasPaintOverride(s,h){const d=s.get("text-field"),m=Bg.paint.properties[h];let v=!1;const b=S=>{for(const E of S)if(m.overrides&&m.overrides.hasOverride(E))return void(v=!0)};if(d.value.kind==="constant"&&d.value.value instanceof br)b(d.value.value.sections);else if(d.value.kind==="source"){const S=C=>{v||(C instanceof os&&Pi(C.value)===mi?b(C.value.sections):C instanceof _o?b(C.sections):C.eachChild(S))},E=d.value;E._styleExpression&&S(E._styleExpression.expression)}return v}}let Cx;var MS={get paint(){return Cx=Cx||new kr({"background-color":new St(j.paint_background["background-color"]),"background-pattern":new uu(j.paint_background["background-pattern"]),"background-opacity":new St(j.paint_background["background-opacity"])})}};class RS extends Tr{constructor(s){super(s,MS)}}let Mx;var kS={get paint(){return Mx=Mx||new kr({"raster-opacity":new St(j.paint_raster["raster-opacity"]),"raster-hue-rotate":new St(j.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new St(j.paint_raster["raster-brightness-min"]),"raster-brightness-max":new St(j.paint_raster["raster-brightness-max"]),"raster-saturation":new St(j.paint_raster["raster-saturation"]),"raster-contrast":new St(j.paint_raster["raster-contrast"]),"raster-resampling":new St(j.paint_raster["raster-resampling"]),"raster-fade-duration":new St(j.paint_raster["raster-fade-duration"])})}};class DS extends Tr{constructor(s){super(s,kS)}}class OS extends Tr{constructor(s){super(s,{}),this.onAdd=h=>{this.implementation.onAdd&&this.implementation.onAdd(h,h.painter.context.gl)},this.onRemove=h=>{this.implementation.onRemove&&this.implementation.onRemove(h,h.painter.context.gl)},this.implementation=s}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class FS{constructor(s){this._methodToThrottle=s,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const LS={once:!0},Ng=63710088e-1;class Lo{constructor(s,h){if(isNaN(s)||isNaN(h))throw new Error(`Invalid LngLat object: (${s}, ${h})`);if(this.lng=+s,this.lat=+h,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Lo(Ct(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(s){const h=Math.PI/180,d=this.lat*h,m=s.lat*h,v=Math.sin(d)*Math.sin(m)+Math.cos(d)*Math.cos(m)*Math.cos((s.lng-this.lng)*h);return Ng*Math.acos(Math.min(v,1))}static convert(s){if(s instanceof Lo)return s;if(Array.isArray(s)&&(s.length===2||s.length===3))return new Lo(Number(s[0]),Number(s[1]));if(!Array.isArray(s)&&typeof s=="object"&&s!==null)return new Lo(Number("lng"in s?s.lng:s.lon),Number(s.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Rx=2*Math.PI*Ng;function kx(u){return Rx*Math.cos(u*Math.PI/180)}function Dx(u){return(180+u)/360}function Ox(u){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u*Math.PI/360)))/360}function Fx(u,s){return u/kx(s)}function zg(u){return 360/Math.PI*Math.atan(Math.exp((180-360*u)*Math.PI/180))-90}function Lx(u,s){return u*kx(zg(s))}class Ou{constructor(s,h,d=0){this.x=+s,this.y=+h,this.z=+d}static fromLngLat(s,h=0){const d=Lo.convert(s);return new Ou(Dx(d.lng),Ox(d.lat),Fx(h,d.lat))}toLngLat(){return new Lo(360*this.x-180,zg(this.y))}toAltitude(){return Lx(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Rx*(s=zg(this.y),1/Math.cos(s*Math.PI/180));var s}}function Bx(u,s,h){var d=2*Math.PI*6378137/256/Math.pow(2,h);return[u*d-2*Math.PI*6378137/2,s*d-2*Math.PI*6378137/2]}class Ug{constructor(s,h,d){if(!function(m,v,b){return!(m<0||m>25||b<0||b>=Math.pow(2,m)||v<0||v>=Math.pow(2,m))}(s,h,d))throw new Error(`x=${h}, y=${d}, z=${s} outside of bounds. 0<=x<${Math.pow(2,s)}, 0<=y<${Math.pow(2,s)} 0<=z<=25 `);this.z=s,this.x=h,this.y=d,this.key=Vl(0,s,s,h,d)}equals(s){return this.z===s.z&&this.x===s.x&&this.y===s.y}url(s,h,d){const m=(b=this.y,S=this.z,E=Bx(256*(v=this.x),256*(b=Math.pow(2,S)-b-1),S),C=Bx(256*(v+1),256*(b+1),S),E[0]+","+E[1]+","+C[0]+","+C[1]);var v,b,S,E,C;const k=function(D,z,V){let $,H="";for(let J=D;J>0;J--)$=1<<J-1,H+=(z&$?1:0)+(V&$?2:0);return H}(this.z,this.x,this.y);return s[(this.x+this.y)%s.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(d==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,h>1?"@2x":"").replace(/{quadkey}/g,k).replace(/{bbox-epsg-3857}/g,m)}isChildOf(s){const h=this.z-s.z;return h>0&&s.x===this.x>>h&&s.y===this.y>>h}getTilePoint(s){const h=Math.pow(2,this.z);return new Y((s.x*h-this.x)*he,(s.y*h-this.y)*he)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Nx{constructor(s,h){this.wrap=s,this.canonical=h,this.key=Vl(s,h.z,h.z,h.x,h.y)}}class on{constructor(s,h,d,m,v){if(this.terrainRttPosMatrix32f=null,s<d)throw new Error(`overscaledZ should be >= z; overscaledZ = ${s}; z = ${d}`);this.overscaledZ=s,this.wrap=h,this.canonical=new Ug(d,+m,+v),this.key=Vl(h,s,d,m,v)}clone(){return new on(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(s){return this.overscaledZ===s.overscaledZ&&this.wrap===s.wrap&&this.canonical.equals(s.canonical)}scaledTo(s){if(s>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${s}; overscaledZ = ${this.overscaledZ}`);const h=this.canonical.z-s;return s>this.canonical.z?new on(s,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new on(s,this.wrap,s,this.canonical.x>>h,this.canonical.y>>h)}calculateScaledKey(s,h){if(s>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${s}; overscaledZ = ${this.overscaledZ}`);const d=this.canonical.z-s;return s>this.canonical.z?Vl(this.wrap*+h,s,this.canonical.z,this.canonical.x,this.canonical.y):Vl(this.wrap*+h,s,s,this.canonical.x>>d,this.canonical.y>>d)}isChildOf(s){if(s.wrap!==this.wrap)return!1;const h=this.canonical.z-s.canonical.z;return s.overscaledZ===0||s.overscaledZ<this.overscaledZ&&s.canonical.x===this.canonical.x>>h&&s.canonical.y===this.canonical.y>>h}children(s){if(this.overscaledZ>=s)return[new on(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const h=this.canonical.z+1,d=2*this.canonical.x,m=2*this.canonical.y;return[new on(h,this.wrap,h,d,m),new on(h,this.wrap,h,d+1,m),new on(h,this.wrap,h,d,m+1),new on(h,this.wrap,h,d+1,m+1)]}isLessThan(s){return this.wrap<s.wrap||!(this.wrap>s.wrap)&&(this.overscaledZ<s.overscaledZ||!(this.overscaledZ>s.overscaledZ)&&(this.canonical.x<s.canonical.x||!(this.canonical.x>s.canonical.x)&&this.canonical.y<s.canonical.y))}wrapped(){return new on(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(s){return new on(this.overscaledZ,s,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Nx(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(s){return this.canonical.getTilePoint(new Ou(s.x-this.wrap,s.y))}}function Vl(u,s,h,d,m){(u*=2)<0&&(u=-1*u-1);const v=1<<h;return(v*v*u+v*m+d).toString(36)+h.toString(36)+s.toString(36)}mt("CanonicalTileID",Ug),mt("OverscaledTileID",on,{omit:["terrainRttPosMatrix32f"]});class zx{constructor(s,h,d,m=1,v=1,b=1,S=0){if(this.uid=s,h.height!==h.width)throw new RangeError("DEM tiles must be square");if(d&&!["mapbox","terrarium","custom"].includes(d))return void Li(`"${d}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=h.height;const E=this.dim=h.height-2;switch(this.data=new Uint32Array(h.data.buffer),d){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=m,this.greenFactor=v,this.blueFactor=b,this.baseShift=S;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let C=0;C<E;C++)this.data[this._idx(-1,C)]=this.data[this._idx(0,C)],this.data[this._idx(E,C)]=this.data[this._idx(E-1,C)],this.data[this._idx(C,-1)]=this.data[this._idx(C,0)],this.data[this._idx(C,E)]=this.data[this._idx(C,E-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(E,-1)]=this.data[this._idx(E-1,0)],this.data[this._idx(-1,E)]=this.data[this._idx(0,E-1)],this.data[this._idx(E,E)]=this.data[this._idx(E-1,E-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let C=0;C<E;C++)for(let k=0;k<E;k++){const D=this.get(C,k);D>this.max&&(this.max=D),D<this.min&&(this.min=D)}}get(s,h){const d=new Uint8Array(this.data.buffer),m=4*this._idx(s,h);return this.unpack(d[m],d[m+1],d[m+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(s,h){if(s<-1||s>=this.dim+1||h<-1||h>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(h+1)*this.stride+(s+1)}unpack(s,h,d){return s*this.redFactor+h*this.greenFactor+d*this.blueFactor-this.baseShift}getPixels(){return new sn({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(s,h,d){if(this.dim!==s.dim)throw new Error("dem dimension mismatch");let m=h*this.dim,v=h*this.dim+this.dim,b=d*this.dim,S=d*this.dim+this.dim;switch(h){case-1:m=v-1;break;case 1:v=m+1}switch(d){case-1:b=S-1;break;case 1:S=b+1}const E=-h*this.dim,C=-d*this.dim;for(let k=b;k<S;k++)for(let D=m;D<v;D++)this.data[this._idx(D,k)]=s.data[this._idx(D+E,k+C)]}}mt("DEMData",zx);class Ux{constructor(s){this._stringToNumber={},this._numberToString=[];for(let h=0;h<s.length;h++){const d=s[h];this._stringToNumber[d]=h,this._numberToString[h]=d}}encode(s){return this._stringToNumber[s]}decode(s){if(s>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${s} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[s]}}class Vx{constructor(s,h,d,m,v){this.type="Feature",this._vectorTileFeature=s,s._z=h,s._x=d,s._y=m,this.properties=s.properties,this.id=v}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(s){this._geometry=s}toJSON(){const s={geometry:this.geometry};for(const h in this)h!=="_geometry"&&h!=="_vectorTileFeature"&&(s[h]=this[h]);return s}}class jx{constructor(s,h){this.tileID=s,this.x=s.canonical.x,this.y=s.canonical.y,this.z=s.canonical.z,this.grid=new va(he,16,0),this.grid3D=new va(he,16,0),this.featureIndexArray=new se,this.promoteId=h}insert(s,h,d,m,v,b){const S=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(d,m,v);const E=b?this.grid3D:this.grid;for(let C=0;C<h.length;C++){const k=h[C],D=[1/0,1/0,-1/0,-1/0];for(let z=0;z<k.length;z++){const V=k[z];D[0]=Math.min(D[0],V.x),D[1]=Math.min(D[1],V.y),D[2]=Math.max(D[2],V.x),D[3]=Math.max(D[3],V.y)}D[0]<he&&D[1]<he&&D[2]>=0&&D[3]>=0&&E.insert(S,D[0],D[1],D[2],D[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Iu.VectorTile(new Ig(this.rawTileData)).layers,this.sourceLayerCoder=new Ux(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(s,h,d,m){this.loadVTLayers();const v=s.params,b=he/s.tileSize/s.scale,S=Yc(v.filter),E=s.queryGeometry,C=s.queryPadding*b,k=Wx(E),D=this.grid.query(k.minX-C,k.minY-C,k.maxX+C,k.maxY+C),z=Wx(s.cameraQueryGeometry),V=this.grid3D.query(z.minX-C,z.minY-C,z.maxX+C,z.maxY+C,(J,re,me,oe)=>function(U,K,ce,Oe,Ye){for(const Ve of U)if(K<=Ve.x&&ce<=Ve.y&&Oe>=Ve.x&&Ye>=Ve.y)return!0;const Ne=[new Y(K,ce),new Y(K,Ye),new Y(Oe,Ye),new Y(Oe,ce)];if(U.length>2){for(const Ve of Ne)if(Ca(U,Ve))return!0}for(let Ve=0;Ve<U.length-1;Ve++)if(ST(U[Ve],U[Ve+1],Ne))return!0;return!1}(s.cameraQueryGeometry,J-C,re-C,me+C,oe+C));for(const J of V)D.push(J);D.sort(BS);const $={};let H;for(let J=0;J<D.length;J++){const re=D[J];if(re===H)continue;H=re;const me=this.featureIndexArray.get(re);let oe=null;this.loadMatchingFeature($,me.bucketIndex,me.sourceLayerIndex,me.featureIndex,S,v.layers,v.availableImages,h,d,m,(U,K,ce)=>(oe||(oe=fs(U)),K.queryIntersectsFeature({queryGeometry:E,feature:U,featureState:ce,geometry:oe,zoom:this.z,transform:s.transform,pixelsToTileUnits:b,pixelPosMatrix:s.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:s.getElevation})))}return $}loadMatchingFeature(s,h,d,m,v,b,S,E,C,k,D){const z=this.bucketLayerIDs[h];if(b&&!z.some(J=>b.has(J)))return;const V=this.sourceLayerCoder.decode(d),$=this.vtLayers[V].feature(m);if(v.needGeometry){const J=ds($,!0);if(!v.filter(new yi(this.tileID.overscaledZ),J,this.tileID.canonical))return}else if(!v.filter(new yi(this.tileID.overscaledZ),$))return;const H=this.getId($,V);for(let J=0;J<z.length;J++){const re=z[J];if(b&&!b.has(re))continue;const me=E[re];if(!me)continue;let oe={};H&&k&&(oe=k.getState(me.sourceLayer||"_geojsonTileLayer",H));const U=Tt({},C[re]);U.paint=$x(U.paint,me.paint,$,oe,S),U.layout=$x(U.layout,me.layout,$,oe,S);const K=!D||D($,me,oe);if(!K)continue;const ce=new Vx($,this.z,this.x,this.y,H);ce.layer=U;let Oe=s[re];Oe===void 0&&(Oe=s[re]=[]),Oe.push({featureIndex:m,feature:ce,intersectionZ:K})}}lookupSymbolFeatures(s,h,d,m,v,b,S,E){const C={};this.loadVTLayers();const k=Yc(v);for(const D of s)this.loadMatchingFeature(C,d,m,D,k,b,S,E,h);return C}hasLayer(s){for(const h of this.bucketLayerIDs)for(const d of h)if(s===d)return!0;return!1}getId(s,h){var d;let m=s.id;return this.promoteId&&(m=s.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[h]],typeof m=="boolean"&&(m=Number(m)),m===void 0&&(!((d=s.properties)===null||d===void 0)&&d.cluster)&&this.promoteId&&(m=Number(s.properties.cluster_id))),m}}function $x(u,s,h,d,m){return ei(u,(v,b)=>{const S=s instanceof Sa?s.get(b):null;return S&&S.evaluate?S.evaluate(h,d,m):S})}function Wx(u){let s=1/0,h=1/0,d=-1/0,m=-1/0;for(const v of u)s=Math.min(s,v.x),h=Math.min(h,v.y),d=Math.max(d,v.x),m=Math.max(m,v.y);return{minX:s,minY:h,maxX:d,maxY:m}}function BS(u,s){return s-u}function Hx(u,s,h,d,m){const v=[];for(let b=0;b<u.length;b++){const S=u[b];let E;for(let C=0;C<S.length-1;C++){let k=S[C],D=S[C+1];k.x<s&&D.x<s||(k.x<s?k=new Y(s,k.y+(s-k.x)/(D.x-k.x)*(D.y-k.y))._round():D.x<s&&(D=new Y(s,k.y+(s-k.x)/(D.x-k.x)*(D.y-k.y))._round()),k.y<h&&D.y<h||(k.y<h?k=new Y(k.x+(h-k.y)/(D.y-k.y)*(D.x-k.x),h)._round():D.y<h&&(D=new Y(k.x+(h-k.y)/(D.y-k.y)*(D.x-k.x),h)._round()),k.x>=d&&D.x>=d||(k.x>=d?k=new Y(d,k.y+(d-k.x)/(D.x-k.x)*(D.y-k.y))._round():D.x>=d&&(D=new Y(d,k.y+(d-k.x)/(D.x-k.x)*(D.y-k.y))._round()),k.y>=m&&D.y>=m||(k.y>=m?k=new Y(k.x+(m-k.y)/(D.y-k.y)*(D.x-k.x),m)._round():D.y>=m&&(D=new Y(k.x+(m-k.y)/(D.y-k.y)*(D.x-k.x),m)._round()),E&&k.equals(E[E.length-1])||(E=[k],v.push(E)),E.push(D)))))}}return v}mt("FeatureIndex",jx,{omit:["rawTileData","sourceLayerCoder"]});class Bo extends Y{constructor(s,h,d,m){super(s,h),this.angle=d,m!==void 0&&(this.segment=m)}clone(){return new Bo(this.x,this.y,this.angle,this.segment)}}function Zx(u,s,h,d,m){if(s.segment===void 0||h===0)return!0;let v=s,b=s.segment+1,S=0;for(;S>-h/2;){if(b--,b<0)return!1;S-=u[b].dist(v),v=u[b]}S+=u[b].dist(u[b+1]),b++;const E=[];let C=0;for(;S<h/2;){const k=u[b],D=u[b+1];if(!D)return!1;let z=u[b-1].angleTo(k)-k.angleTo(D);for(z=Math.abs((z+3*Math.PI)%(2*Math.PI)-Math.PI),E.push({distance:S,angleDelta:z}),C+=z;S-E[0].distance>d;)C-=E.shift().angleDelta;if(C>m)return!1;b++,S+=k.dist(D)}return!0}function Xx(u){let s=0;for(let h=0;h<u.length-1;h++)s+=u[h].dist(u[h+1]);return s}function qx(u,s,h){return u?.6*s*h:0}function Gx(u,s){return Math.max(u?u.right-u.left:0,s?s.right-s.left:0)}function NS(u,s,h,d,m,v){const b=qx(h,m,v),S=Gx(h,d)*v;let E=0;const C=Xx(u)/2;for(let k=0;k<u.length-1;k++){const D=u[k],z=u[k+1],V=D.dist(z);if(E+V>C){const $=(C-E)/V,H=rn.number(D.x,z.x,$),J=rn.number(D.y,z.y,$),re=new Bo(H,J,z.angleTo(D),k);return re._round(),!b||Zx(u,re,S,b,s)?re:void 0}E+=V}}function zS(u,s,h,d,m,v,b,S,E){const C=qx(d,v,b),k=Gx(d,m),D=k*b,z=u[0].x===0||u[0].x===E||u[0].y===0||u[0].y===E;return s-D<s/4&&(s=D+s/4),Yx(u,z?s/2*S%s:(k/2+2*v)*b*S%s,s,C,h,D,z,!1,E)}function Yx(u,s,h,d,m,v,b,S,E){const C=v/2,k=Xx(u);let D=0,z=s-h,V=[];for(let $=0;$<u.length-1;$++){const H=u[$],J=u[$+1],re=H.dist(J),me=J.angleTo(H);for(;z+h<D+re;){z+=h;const oe=(z-D)/re,U=rn.number(H.x,J.x,oe),K=rn.number(H.y,J.y,oe);if(U>=0&&U<E&&K>=0&&K<E&&z-C>=0&&z+C<=k){const ce=new Bo(U,K,me,$);ce._round(),d&&!Zx(u,ce,v,d,m)||V.push(ce)}}D+=re}return S||V.length||b||(V=Yx(u,D/2,h,d,m,v,b,!0,E)),V}mt("Anchor",Bo);const Fu=Vr;function Kx(u,s,h,d){const m=[],v=u.image,b=v.pixelRatio,S=v.paddedRect.w-2*Fu,E=v.paddedRect.h-2*Fu;let C={x1:u.left,y1:u.top,x2:u.right,y2:u.bottom};const k=v.stretchX||[[0,S]],D=v.stretchY||[[0,E]],z=(He,xt)=>He+xt[1]-xt[0],V=k.reduce(z,0),$=D.reduce(z,0),H=S-V,J=E-$;let re=0,me=V,oe=0,U=$,K=0,ce=H,Oe=0,Ye=J;if(v.content&&d){const He=v.content,xt=He[2]-He[0],It=He[3]-He[1];(v.textFitWidth||v.textFitHeight)&&(C=Tx(u)),re=zf(k,0,He[0]),oe=zf(D,0,He[1]),me=zf(k,He[0],He[2]),U=zf(D,He[1],He[3]),K=He[0]-re,Oe=He[1]-oe,ce=xt-me,Ye=It-U}const Ne=C.x1,Ve=C.y1,nt=C.x2-Ne,Je=C.y2-Ve,ot=(He,xt,It,At)=>{const wt=Uf(He.stretch-re,me,nt,Ne),Zt=Vf(He.fixed-K,ce,He.stretch,V),Oi=Uf(xt.stretch-oe,U,Je,Ve),Qi=Vf(xt.fixed-Oe,Ye,xt.stretch,$),xr=Uf(It.stretch-re,me,nt,Ne),an=Vf(It.fixed-K,ce,It.stretch,V),jr=Uf(At.stretch-oe,U,Je,Ve),hr=Vf(At.fixed-Oe,Ye,At.stretch,$),Ci=new Y(wt,Oi),ir=new Y(xr,Oi),fr=new Y(xr,jr),dr=new Y(wt,jr),Or=new Y(Zt/b,Qi/b),ln=new Y(an/b,hr/b),rr=s*Math.PI/180;if(rr){const nr=Math.sin(rr),sr=Math.cos(rr),Hi=[sr,-nr,nr,sr];Ci._matMult(Hi),ir._matMult(Hi),dr._matMult(Hi),fr._matMult(Hi)}const $r=He.stretch+He.fixed,er=xt.stretch+xt.fixed;return{tl:Ci,tr:ir,bl:dr,br:fr,tex:{x:v.paddedRect.x+Fu+$r,y:v.paddedRect.y+Fu+er,w:It.stretch+It.fixed-$r,h:At.stretch+At.fixed-er},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Or,pixelOffsetBR:ln,minFontScaleX:ce/b/nt,minFontScaleY:Ye/b/Je,isSDF:h}};if(d&&(v.stretchX||v.stretchY)){const He=Jx(k,H,V),xt=Jx(D,J,$);for(let It=0;It<He.length-1;It++){const At=He[It],wt=He[It+1];for(let Zt=0;Zt<xt.length-1;Zt++)m.push(ot(At,xt[Zt],wt,xt[Zt+1]))}}else m.push(ot({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:S+1},{fixed:0,stretch:E+1}));return m}function zf(u,s,h){let d=0;for(const m of u)d+=Math.max(s,Math.min(h,m[1]))-Math.max(s,Math.min(h,m[0]));return d}function Jx(u,s,h){const d=[{fixed:-1,stretch:0}];for(const[m,v]of u){const b=d[d.length-1];d.push({fixed:m-b.stretch,stretch:b.stretch}),d.push({fixed:m-b.stretch,stretch:b.stretch+(v-m)})}return d.push({fixed:s+Fu,stretch:h}),d}function Uf(u,s,h,d){return u/s*h+d}function Vf(u,s,h,d){return u-s*h/d}class jf{constructor(s,h,d,m,v,b,S,E,C,k){var D;if(this.boxStartIndex=s.length,C){let z=b.top,V=b.bottom;const $=b.collisionPadding;$&&(z-=$[1],V+=$[3]);let H=V-z;H>0&&(H=Math.max(10,H),this.circleDiameter=H)}else{const z=!((D=b.image)===null||D===void 0)&&D.content&&(b.image.textFitWidth||b.image.textFitHeight)?Tx(b):{x1:b.left,y1:b.top,x2:b.right,y2:b.bottom};z.y1=z.y1*S-E[0],z.y2=z.y2*S+E[2],z.x1=z.x1*S-E[3],z.x2=z.x2*S+E[1];const V=b.collisionPadding;if(V&&(z.x1-=V[0]*S,z.y1-=V[1]*S,z.x2+=V[2]*S,z.y2+=V[3]*S),k){const $=new Y(z.x1,z.y1),H=new Y(z.x2,z.y1),J=new Y(z.x1,z.y2),re=new Y(z.x2,z.y2),me=k*Math.PI/180;$._rotate(me),H._rotate(me),J._rotate(me),re._rotate(me),z.x1=Math.min($.x,H.x,J.x,re.x),z.x2=Math.max($.x,H.x,J.x,re.x),z.y1=Math.min($.y,H.y,J.y,re.y),z.y2=Math.max($.y,H.y,J.y,re.y)}s.emplaceBack(h.x,h.y,z.x1,z.y1,z.x2,z.y2,d,m,v)}this.boxEndIndex=s.length}}class US{constructor(s=[],h=(d,m)=>d<m?-1:d>m?1:0){if(this.data=s,this.length=this.data.length,this.compare=h,this.length>0)for(let d=(this.length>>1)-1;d>=0;d--)this._down(d)}push(s){this.data.push(s),this._up(this.length++)}pop(){if(this.length===0)return;const s=this.data[0],h=this.data.pop();return--this.length>0&&(this.data[0]=h,this._down(0)),s}peek(){return this.data[0]}_up(s){const{data:h,compare:d}=this,m=h[s];for(;s>0;){const v=s-1>>1,b=h[v];if(d(m,b)>=0)break;h[s]=b,s=v}h[s]=m}_down(s){const{data:h,compare:d}=this,m=this.length>>1,v=h[s];for(;s<m;){let b=1+(s<<1);const S=b+1;if(S<this.length&&d(h[S],h[b])<0&&(b=S),d(h[b],v)>=0)break;h[s]=h[b],s=b}h[s]=v}}function VS(u,s=1,h=!1){let d=1/0,m=1/0,v=-1/0,b=-1/0;const S=u[0];for(let V=0;V<S.length;V++){const $=S[V];(!V||$.x<d)&&(d=$.x),(!V||$.y<m)&&(m=$.y),(!V||$.x>v)&&(v=$.x),(!V||$.y>b)&&(b=$.y)}const E=Math.min(v-d,b-m);let C=E/2;const k=new US([],jS);if(E===0)return new Y(d,m);for(let V=d;V<v;V+=E)for(let $=m;$<b;$+=E)k.push(new jl(V+C,$+C,C,u));let D=function(V){let $=0,H=0,J=0;const re=V[0];for(let me=0,oe=re.length,U=oe-1;me<oe;U=me++){const K=re[me],ce=re[U],Oe=K.x*ce.y-ce.x*K.y;H+=(K.x+ce.x)*Oe,J+=(K.y+ce.y)*Oe,$+=3*Oe}return new jl(H/$,J/$,0,V)}(u),z=k.length;for(;k.length;){const V=k.pop();(V.d>D.d||!D.d)&&(D=V,h&&console.log("found best %d after %d probes",Math.round(1e4*V.d)/1e4,z)),V.max-D.d<=s||(C=V.h/2,k.push(new jl(V.p.x-C,V.p.y-C,C,u)),k.push(new jl(V.p.x+C,V.p.y-C,C,u)),k.push(new jl(V.p.x-C,V.p.y+C,C,u)),k.push(new jl(V.p.x+C,V.p.y+C,C,u)),z+=4)}return h&&(console.log(`num probes: ${z}`),console.log(`best distance: ${D.d}`)),D.p}function jS(u,s){return s.max-u.max}function jl(u,s,h,d){this.p=new Y(u,s),this.h=h,this.d=function(m,v){let b=!1,S=1/0;for(let E=0;E<v.length;E++){const C=v[E];for(let k=0,D=C.length,z=D-1;k<D;z=k++){const V=C[k],$=C[z];V.y>m.y!=$.y>m.y&&m.x<($.x-V.x)*(m.y-V.y)/($.y-V.y)+V.x&&(b=!b),S=Math.min(S,ky(m,V,$))}}return(b?1:-1)*Math.sqrt(S)}(this.p,d),this.max=this.d+this.h*Math.SQRT2}var yr;f.ay=void 0,(yr=f.ay||(f.ay={}))[yr.center=1]="center",yr[yr.left=2]="left",yr[yr.right=3]="right",yr[yr.top=4]="top",yr[yr.bottom=5]="bottom",yr[yr["top-left"]=6]="top-left",yr[yr["top-right"]=7]="top-right",yr[yr["bottom-left"]=8]="bottom-left",yr[yr["bottom-right"]=9]="bottom-right";const No=7,Vg=Number.POSITIVE_INFINITY;function Qx(u,s){return s[1]!==Vg?function(h,d,m){let v=0,b=0;switch(d=Math.abs(d),m=Math.abs(m),h){case"top-right":case"top-left":case"top":b=m-No;break;case"bottom-right":case"bottom-left":case"bottom":b=-m+No}switch(h){case"top-right":case"bottom-right":case"right":v=-d;break;case"top-left":case"bottom-left":case"left":v=d}return[v,b]}(u,s[0],s[1]):function(h,d){let m=0,v=0;d<0&&(d=0);const b=d/Math.SQRT2;switch(h){case"top-right":case"top-left":v=b-No;break;case"bottom-right":case"bottom-left":v=-b+No;break;case"bottom":v=-d+No;break;case"top":v=d-No}switch(h){case"top-right":case"bottom-right":m=-b;break;case"top-left":case"bottom-left":m=b;break;case"left":m=d;break;case"right":m=-d}return[m,v]}(u,s[0])}function ev(u,s,h){var d;const m=u.layout,v=(d=m.get("text-variable-anchor-offset"))===null||d===void 0?void 0:d.evaluate(s,{},h);if(v){const S=v.values,E=[];for(let C=0;C<S.length;C+=2){const k=E[C]=S[C],D=S[C+1].map(z=>z*Ji);k.startsWith("top")?D[1]-=No:k.startsWith("bottom")&&(D[1]+=No),E[C+1]=D}return new wr(E)}const b=m.get("text-variable-anchor");if(b){let S;S=u._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[m.get("text-radial-offset").evaluate(s,{},h)*Ji,Vg]:m.get("text-offset").evaluate(s,{},h).map(C=>C*Ji);const E=[];for(const C of b)E.push(C,Qx(C,S));return new wr(E)}return null}function jg(u){switch(u){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function $S(u,s,h,d,m,v,b,S,E,C,k,D){let z=v.textMaxSize.evaluate(s,{});z===void 0&&(z=b);const V=u.layers[0].layout,$=V.get("icon-offset").evaluate(s,{},k),H=iv(h.horizontal),J=b/24,re=u.tilePixelRatio*J,me=u.tilePixelRatio*z/24,oe=u.tilePixelRatio*S,U=u.tilePixelRatio*V.get("symbol-spacing"),K=V.get("text-padding")*u.tilePixelRatio,ce=function(It,At,wt,Zt=1){const Oi=It.get("icon-padding").evaluate(At,{},wt),Qi=Oi&&Oi.values;return[Qi[0]*Zt,Qi[1]*Zt,Qi[2]*Zt,Qi[3]*Zt]}(V,s,k,u.tilePixelRatio),Oe=V.get("text-max-angle")/180*Math.PI,Ye=V.get("text-rotation-alignment")!=="viewport"&&V.get("symbol-placement")!=="point",Ne=V.get("icon-rotation-alignment")==="map"&&V.get("symbol-placement")!=="point",Ve=V.get("symbol-placement"),nt=U/2,Je=V.get("icon-text-fit");let ot;d&&Je!=="none"&&(u.allowVerticalPlacement&&h.vertical&&(ot=Sx(d,h.vertical,Je,V.get("icon-text-fit-padding"),$,J)),H&&(d=Sx(d,H,Je,V.get("icon-text-fit-padding"),$,J)));const He=k?D.line.getGranularityForZoomLevel(k.z):1,xt=(It,At)=>{At.x<0||At.x>=he||At.y<0||At.y>=he||function(wt,Zt,Oi,Qi,xr,an,jr,hr,Ci,ir,fr,dr,Or,ln,rr,$r,er,nr,sr,Hi,vi,Un,$l,Vn,ZS){const Wl=wt.addToLineVertexArray(Zt,Oi);let ka,Hl,Zl,Xl,ov=0,av=0,lv=0,cv=0,Yg=-1,Kg=-1;const Xs={};let uv=Bn("");if(wt.allowVerticalPlacement&&Qi.vertical){const Sr=hr.layout.get("text-rotate").evaluate(vi,{},Vn)+90;Zl=new jf(Ci,Zt,ir,fr,dr,Qi.vertical,Or,ln,rr,Sr),jr&&(Xl=new jf(Ci,Zt,ir,fr,dr,jr,er,nr,rr,Sr))}if(xr){const Sr=hr.layout.get("icon-rotate").evaluate(vi,{}),cn=hr.layout.get("icon-text-fit")!=="none",Da=Kx(xr,Sr,$l,cn),$n=jr?Kx(jr,Sr,$l,cn):void 0;Hl=new jf(Ci,Zt,ir,fr,dr,xr,er,nr,!1,Sr),ov=4*Da.length;const Oa=wt.iconSizeData;let gs=null;Oa.kind==="source"?(gs=[ps*hr.layout.get("icon-size").evaluate(vi,{})],gs[0]>Fo&&Li(`${wt.layerIds[0]}: Value for "icon-size" is >= ${Du}. Reduce your "icon-size".`)):Oa.kind==="composite"&&(gs=[ps*Un.compositeIconSizes[0].evaluate(vi,{},Vn),ps*Un.compositeIconSizes[1].evaluate(vi,{},Vn)],(gs[0]>Fo||gs[1]>Fo)&&Li(`${wt.layerIds[0]}: Value for "icon-size" is >= ${Du}. Reduce your "icon-size".`)),wt.addSymbols(wt.icon,Da,gs,Hi,sr,vi,f.ah.none,Zt,Wl.lineStartIndex,Wl.lineLength,-1,Vn),Yg=wt.icon.placedSymbolArray.length-1,$n&&(av=4*$n.length,wt.addSymbols(wt.icon,$n,gs,Hi,sr,vi,f.ah.vertical,Zt,Wl.lineStartIndex,Wl.lineLength,-1,Vn),Kg=wt.icon.placedSymbolArray.length-1)}const hv=Object.keys(Qi.horizontal);for(const Sr of hv){const cn=Qi.horizontal[Sr];if(!ka){uv=Bn(cn.text);const $n=hr.layout.get("text-rotate").evaluate(vi,{},Vn);ka=new jf(Ci,Zt,ir,fr,dr,cn,Or,ln,rr,$n)}const Da=cn.positionedLines.length===1;if(lv+=tv(wt,Zt,cn,an,hr,rr,vi,$r,Wl,Qi.vertical?f.ah.horizontal:f.ah.horizontalOnly,Da?hv:[Sr],Xs,Yg,Un,Vn),Da)break}Qi.vertical&&(cv+=tv(wt,Zt,Qi.vertical,an,hr,rr,vi,$r,Wl,f.ah.vertical,["vertical"],Xs,Kg,Un,Vn));const XS=ka?ka.boxStartIndex:wt.collisionBoxArray.length,qS=ka?ka.boxEndIndex:wt.collisionBoxArray.length,GS=Zl?Zl.boxStartIndex:wt.collisionBoxArray.length,YS=Zl?Zl.boxEndIndex:wt.collisionBoxArray.length,KS=Hl?Hl.boxStartIndex:wt.collisionBoxArray.length,JS=Hl?Hl.boxEndIndex:wt.collisionBoxArray.length,QS=Xl?Xl.boxStartIndex:wt.collisionBoxArray.length,eA=Xl?Xl.boxEndIndex:wt.collisionBoxArray.length;let jn=-1;const Wf=(Sr,cn)=>Sr&&Sr.circleDiameter?Math.max(Sr.circleDiameter,cn):cn;jn=Wf(ka,jn),jn=Wf(Zl,jn),jn=Wf(Hl,jn),jn=Wf(Xl,jn);const fv=jn>-1?1:0;fv&&(jn*=ZS/Ji),wt.glyphOffsetArray.length>=Ul.MAX_GLYPHS&&Li("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),vi.sortKey!==void 0&&wt.addToSortKeyRanges(wt.symbolInstances.length,vi.sortKey);const tA=ev(hr,vi,Vn),[iA,rA]=function(Sr,cn){const Da=Sr.length,$n=cn==null?void 0:cn.values;if(($n==null?void 0:$n.length)>0)for(let Oa=0;Oa<$n.length;Oa+=2){const gs=$n[Oa+1];Sr.emplaceBack(f.ay[$n[Oa]],gs[0],gs[1])}return[Da,Sr.length]}(wt.textAnchorOffsets,tA);wt.symbolInstances.emplaceBack(Zt.x,Zt.y,Xs.right>=0?Xs.right:-1,Xs.center>=0?Xs.center:-1,Xs.left>=0?Xs.left:-1,Xs.vertical||-1,Yg,Kg,uv,XS,qS,GS,YS,KS,JS,QS,eA,ir,lv,cv,ov,av,fv,0,Or,jn,iA,rA)}(u,At,It,h,d,m,ot,u.layers[0],u.collisionBoxArray,s.index,s.sourceLayerIndex,u.index,re,[K,K,K,K],Ye,E,oe,ce,Ne,$,s,v,C,k,b)};if(Ve==="line")for(const It of Hx(s.geometry,0,0,he,he)){const At=Ra(It,He),wt=zS(At,U,Oe,h.vertical||H,d,24,me,u.overscaling,he);for(const Zt of wt)H&&WS(u,H.text,nt,Zt)||xt(At,Zt)}else if(Ve==="line-center"){for(const It of s.geometry)if(It.length>1){const At=Ra(It,He),wt=NS(At,Oe,h.vertical||H,d,24,me);wt&&xt(At,wt)}}else if(s.type==="Polygon")for(const It of da(s.geometry,0)){const At=VS(It,16);xt(Ra(It[0],He,!0),new Bo(At.x,At.y,0))}else if(s.type==="LineString")for(const It of s.geometry){const At=Ra(It,He);xt(At,new Bo(At[0].x,At[0].y,0))}else if(s.type==="Point")for(const It of s.geometry)for(const At of It)xt([At],new Bo(At.x,At.y,0))}function tv(u,s,h,d,m,v,b,S,E,C,k,D,z,V,$){const H=function(me,oe,U,K,ce,Oe,Ye,Ne){const Ve=K.layout.get("text-rotate").evaluate(Oe,{})*Math.PI/180,nt=[];for(const Je of oe.positionedLines)for(const ot of Je.positionedGlyphs){if(!ot.rect)continue;const He=ot.rect||{};let xt=_S+1,It=!0,At=1,wt=0;const Zt=(ce||Ne)&&ot.vertical,Oi=ot.metrics.advance*ot.scale/2;if(Ne&&oe.verticalizable&&(wt=Je.lineOffset/2-(ot.imageName?-(Ji-ot.metrics.width*ot.scale)/2:(ot.scale-1)*Ji)),ot.imageName){const nr=Ye[ot.imageName];It=nr.sdf,At=nr.pixelRatio,xt=Vr/At}const Qi=ce?[ot.x+Oi,ot.y]:[0,0];let xr=ce?[0,0]:[ot.x+Oi+U[0],ot.y+U[1]-wt],an=[0,0];Zt&&(an=xr,xr=[0,0]);const jr=ot.metrics.isDoubleResolution?2:1,hr=(ot.metrics.left-xt)*ot.scale-Oi+xr[0],Ci=(-ot.metrics.top-xt)*ot.scale+xr[1],ir=hr+He.w/jr*ot.scale/At,fr=Ci+He.h/jr*ot.scale/At,dr=new Y(hr,Ci),Or=new Y(ir,Ci),ln=new Y(hr,fr),rr=new Y(ir,fr);if(Zt){const nr=new Y(-Oi,Oi-Of),sr=-Math.PI/2,Hi=Ji/2-Oi,vi=new Y(5-Of-Hi,-(ot.imageName?Hi:0)),Un=new Y(...an);dr._rotateAround(sr,nr)._add(vi)._add(Un),Or._rotateAround(sr,nr)._add(vi)._add(Un),ln._rotateAround(sr,nr)._add(vi)._add(Un),rr._rotateAround(sr,nr)._add(vi)._add(Un)}if(Ve){const nr=Math.sin(Ve),sr=Math.cos(Ve),Hi=[sr,-nr,nr,sr];dr._matMult(Hi),Or._matMult(Hi),ln._matMult(Hi),rr._matMult(Hi)}const $r=new Y(0,0),er=new Y(0,0);nt.push({tl:dr,tr:Or,bl:ln,br:rr,tex:He,writingMode:oe.writingMode,glyphOffset:Qi,sectionIndex:ot.sectionIndex,isSDF:It,pixelOffsetTL:$r,pixelOffsetBR:er,minFontScaleX:0,minFontScaleY:0})}return nt}(0,h,S,m,v,b,d,u.allowVerticalPlacement),J=u.textSizeData;let re=null;J.kind==="source"?(re=[ps*m.layout.get("text-size").evaluate(b,{})],re[0]>Fo&&Li(`${u.layerIds[0]}: Value for "text-size" is >= ${Du}. Reduce your "text-size".`)):J.kind==="composite"&&(re=[ps*V.compositeTextSizes[0].evaluate(b,{},$),ps*V.compositeTextSizes[1].evaluate(b,{},$)],(re[0]>Fo||re[1]>Fo)&&Li(`${u.layerIds[0]}: Value for "text-size" is >= ${Du}. Reduce your "text-size".`)),u.addSymbols(u.text,H,re,S,v,b,C,s,E.lineStartIndex,E.lineLength,z,$);for(const me of k)D[me]=u.text.placedSymbolArray.length-1;return 4*H.length}function iv(u){for(const s in u)return u[s];return null}function WS(u,s,h,d){const m=u.compareText;if(s in m){const v=m[s];for(let b=v.length-1;b>=0;b--)if(d.dist(v[b])<h)return!0}else m[s]=[];return m[s].push(d),!1}const rv=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class $g{static from(s){if(!(s instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[h,d]=new Uint8Array(s,0,2);if(h!==219)throw new Error("Data does not appear to be in a KDBush format.");const m=d>>4;if(m!==1)throw new Error(`Got v${m} data when expected v1.`);const v=rv[15&d];if(!v)throw new Error("Unrecognized array type.");const[b]=new Uint16Array(s,2,1),[S]=new Uint32Array(s,4,1);return new $g(S,b,v,s)}constructor(s,h=64,d=Float64Array,m){if(isNaN(s)||s<0)throw new Error(`Unpexpected numItems value: ${s}.`);this.numItems=+s,this.nodeSize=Math.min(Math.max(+h,2),65535),this.ArrayType=d,this.IndexArrayType=s<65536?Uint16Array:Uint32Array;const v=rv.indexOf(this.ArrayType),b=2*s*this.ArrayType.BYTES_PER_ELEMENT,S=s*this.IndexArrayType.BYTES_PER_ELEMENT,E=(8-S%8)%8;if(v<0)throw new Error(`Unexpected typed array class: ${d}.`);m&&m instanceof ArrayBuffer?(this.data=m,this.ids=new this.IndexArrayType(this.data,8,s),this.coords=new this.ArrayType(this.data,8+S+E,2*s),this._pos=2*s,this._finished=!0):(this.data=new ArrayBuffer(8+b+S+E),this.ids=new this.IndexArrayType(this.data,8,s),this.coords=new this.ArrayType(this.data,8+S+E,2*s),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+v]),new Uint16Array(this.data,2,1)[0]=h,new Uint32Array(this.data,4,1)[0]=s)}add(s,h){const d=this._pos>>1;return this.ids[d]=d,this.coords[this._pos++]=s,this.coords[this._pos++]=h,d}finish(){const s=this._pos>>1;if(s!==this.numItems)throw new Error(`Added ${s} items when expected ${this.numItems}.`);return Wg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(s,h,d,m){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:v,coords:b,nodeSize:S}=this,E=[0,v.length-1,0],C=[];for(;E.length;){const k=E.pop()||0,D=E.pop()||0,z=E.pop()||0;if(D-z<=S){for(let J=z;J<=D;J++){const re=b[2*J],me=b[2*J+1];re>=s&&re<=d&&me>=h&&me<=m&&C.push(v[J])}continue}const V=z+D>>1,$=b[2*V],H=b[2*V+1];$>=s&&$<=d&&H>=h&&H<=m&&C.push(v[V]),(k===0?s<=$:h<=H)&&(E.push(z),E.push(V-1),E.push(1-k)),(k===0?d>=$:m>=H)&&(E.push(V+1),E.push(D),E.push(1-k))}return C}within(s,h,d){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:v,nodeSize:b}=this,S=[0,m.length-1,0],E=[],C=d*d;for(;S.length;){const k=S.pop()||0,D=S.pop()||0,z=S.pop()||0;if(D-z<=b){for(let J=z;J<=D;J++)sv(v[2*J],v[2*J+1],s,h)<=C&&E.push(m[J]);continue}const V=z+D>>1,$=v[2*V],H=v[2*V+1];sv($,H,s,h)<=C&&E.push(m[V]),(k===0?s-d<=$:h-d<=H)&&(S.push(z),S.push(V-1),S.push(1-k)),(k===0?s+d>=$:h+d>=H)&&(S.push(V+1),S.push(D),S.push(1-k))}return E}}function Wg(u,s,h,d,m,v){if(m-d<=h)return;const b=d+m>>1;nv(u,s,b,d,m,v),Wg(u,s,h,d,b-1,1-v),Wg(u,s,h,b+1,m,1-v)}function nv(u,s,h,d,m,v){for(;m>d;){if(m-d>600){const C=m-d+1,k=h-d+1,D=Math.log(C),z=.5*Math.exp(2*D/3),V=.5*Math.sqrt(D*z*(C-z)/C)*(k-C/2<0?-1:1);nv(u,s,h,Math.max(d,Math.floor(h-k*z/C+V)),Math.min(m,Math.floor(h+(C-k)*z/C+V)),v)}const b=s[2*h+v];let S=d,E=m;for(Lu(u,s,d,h),s[2*m+v]>b&&Lu(u,s,d,m);S<E;){for(Lu(u,s,S,E),S++,E--;s[2*S+v]<b;)S++;for(;s[2*E+v]>b;)E--}s[2*d+v]===b?Lu(u,s,d,E):(E++,Lu(u,s,E,m)),E<=h&&(d=E+1),h<=E&&(m=E-1)}}function Lu(u,s,h,d){Hg(u,h,d),Hg(s,2*h,2*d),Hg(s,2*h+1,2*d+1)}function Hg(u,s,h){const d=u[s];u[s]=u[h],u[h]=d}function sv(u,s,h,d){const m=u-h,v=s-d;return m*m+v*v}var Zg;f.ck=void 0,(Zg=f.ck||(f.ck={})).create="create",Zg.load="load",Zg.fullLoad="fullLoad";let $f=null,Bu=[];const Xg=1e3/60,qg="loadTime",Gg="fullLoadTime",HS={mark(u){performance.mark(u)},frame(u){const s=u;$f!=null&&Bu.push(s-$f),$f=s},clearMetrics(){$f=null,Bu=[],performance.clearMeasures(qg),performance.clearMeasures(Gg);for(const u in f.ck)performance.clearMarks(f.ck[u])},getPerformanceMetrics(){performance.measure(qg,f.ck.create,f.ck.load),performance.measure(Gg,f.ck.create,f.ck.fullLoad);const u=performance.getEntriesByName(qg)[0].duration,s=performance.getEntriesByName(Gg)[0].duration,h=Bu.length,d=1/(Bu.reduce((v,b)=>v+b,0)/h/1e3),m=Bu.filter(v=>v>Xg).reduce((v,b)=>v+(b-Xg)/Xg,0);return{loadTime:u,fullLoadTime:s,fps:d,percentDroppedFrames:m/(h+m)*100,totalFrames:h}}};f.$=Ou,f.A=gt,f.B=rn,f.C=yi,f.D=St,f.E=q,f.F=ig,f.G=function(u){if(Si==null){const s=u.navigator?u.navigator.userAgent:null;Si=!!u.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Si},f.H=class{constructor(u,s){this.target=u,this.mapId=s,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new FS(()=>this.process()),this.subscription=Jr(this.target,"message",h=>this.receive(h),!1),this.globalScope=Hr(self)?u:window}registerMessageHandler(u,s){this.messageHandlers[u]=s}sendAsync(u,s){return new Promise((h,d)=>{const m=Math.round(1e18*Math.random()).toString(36).substring(0,10),v=s?Jr(s.signal,"abort",()=>{v==null||v.unsubscribe(),delete this.resolveRejects[m];const E={id:m,type:"<cancel>",origin:location.origin,targetMapId:u.targetMapId,sourceMapId:this.mapId};this.target.postMessage(E)},LS):null;this.resolveRejects[m]={resolve:E=>{v==null||v.unsubscribe(),h(E)},reject:E=>{v==null||v.unsubscribe(),d(E)}};const b=[],S=Object.assign(Object.assign({},u),{id:m,sourceMapId:this.mapId,origin:location.origin,data:zs(u.data,b)});this.target.postMessage(S,{transfer:b})})}receive(u){const s=u.data,h=s.id;if(!(s.origin!=="file://"&&location.origin!=="file://"&&s.origin!=="resource://android"&&location.origin!=="resource://android"&&s.origin!==location.origin||s.targetMapId&&this.mapId!==s.targetMapId)){if(s.type==="<cancel>"){delete this.tasks[h];const d=this.abortControllers[h];return delete this.abortControllers[h],void(d&&d.abort())}if(Hr(self)||s.mustQueue)return this.tasks[h]=s,this.taskQueue.push(h),void this.invoker.trigger();this.processTask(h,s)}}process(){if(this.taskQueue.length===0)return;const u=this.taskQueue.shift(),s=this.tasks[u];delete this.tasks[u],this.taskQueue.length>0&&this.invoker.trigger(),s&&this.processTask(u,s)}processTask(u,s){return a(this,void 0,void 0,function*(){if(s.type==="<response>"){const m=this.resolveRejects[u];return delete this.resolveRejects[u],m?void(s.error?m.reject(as(s.error)):m.resolve(as(s.data))):void 0}if(!this.messageHandlers[s.type])return void this.completeTask(u,new Error(`Could not find a registered handler for ${s.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const h=as(s.data),d=new AbortController;this.abortControllers[u]=d;try{const m=yield this.messageHandlers[s.type](s.sourceMapId,h,d);this.completeTask(u,null,m)}catch(m){this.completeTask(u,m)}})}completeTask(u,s,h){const d=[];delete this.abortControllers[u];const m={id:u,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:s?zs(s):null,data:zs(h,d)};this.target.postMessage(m,{transfer:d})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},f.I=Mg,f.J=Cn,f.K=function(){var u=new gt(16);return gt!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0),u[0]=1,u[5]=1,u[10]=1,u[15]=1,u},f.L=function(u,s,h){var d,m,v,b,S,E,C,k,D,z,V,$,H=h[0],J=h[1],re=h[2];return s===u?(u[12]=s[0]*H+s[4]*J+s[8]*re+s[12],u[13]=s[1]*H+s[5]*J+s[9]*re+s[13],u[14]=s[2]*H+s[6]*J+s[10]*re+s[14],u[15]=s[3]*H+s[7]*J+s[11]*re+s[15]):(m=s[1],v=s[2],b=s[3],S=s[4],E=s[5],C=s[6],k=s[7],D=s[8],z=s[9],V=s[10],$=s[11],u[0]=d=s[0],u[1]=m,u[2]=v,u[3]=b,u[4]=S,u[5]=E,u[6]=C,u[7]=k,u[8]=D,u[9]=z,u[10]=V,u[11]=$,u[12]=d*H+S*J+D*re+s[12],u[13]=m*H+E*J+z*re+s[13],u[14]=v*H+C*J+V*re+s[14],u[15]=b*H+k*J+$*re+s[15]),u},f.M=function(u,s,h){var d=h[0],m=h[1],v=h[2];return u[0]=s[0]*d,u[1]=s[1]*d,u[2]=s[2]*d,u[3]=s[3]*d,u[4]=s[4]*m,u[5]=s[5]*m,u[6]=s[6]*m,u[7]=s[7]*m,u[8]=s[8]*v,u[9]=s[9]*v,u[10]=s[10]*v,u[11]=s[11]*v,u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15],u},f.N=function(u,s,h){var d=s[0],m=s[1],v=s[2],b=s[3],S=s[4],E=s[5],C=s[6],k=s[7],D=s[8],z=s[9],V=s[10],$=s[11],H=s[12],J=s[13],re=s[14],me=s[15],oe=h[0],U=h[1],K=h[2],ce=h[3];return u[0]=oe*d+U*S+K*D+ce*H,u[1]=oe*m+U*E+K*z+ce*J,u[2]=oe*v+U*C+K*V+ce*re,u[3]=oe*b+U*k+K*$+ce*me,u[4]=(oe=h[4])*d+(U=h[5])*S+(K=h[6])*D+(ce=h[7])*H,u[5]=oe*m+U*E+K*z+ce*J,u[6]=oe*v+U*C+K*V+ce*re,u[7]=oe*b+U*k+K*$+ce*me,u[8]=(oe=h[8])*d+(U=h[9])*S+(K=h[10])*D+(ce=h[11])*H,u[9]=oe*m+U*E+K*z+ce*J,u[10]=oe*v+U*C+K*V+ce*re,u[11]=oe*b+U*k+K*$+ce*me,u[12]=(oe=h[12])*d+(U=h[13])*S+(K=h[14])*D+(ce=h[15])*H,u[13]=oe*m+U*E+K*z+ce*J,u[14]=oe*v+U*C+K*V+ce*re,u[15]=oe*b+U*k+K*$+ce*me,u},f.O=function(u,s){const h={};for(let d=0;d<s.length;d++){const m=s[d];m in u&&(h[m]=u[m])}return h},f.P=Y,f.Q=Lo,f.R=sn,f.S=Ox,f.T=Ta,f.U=Dx,f.V=xe,f.W=Ce,f.X=Kr,f.Y=on,f.Z=he,f._=a,f.a=ts,f.a$=function(u,s,h){var d=Math.sin(h),m=Math.cos(h),v=s[4],b=s[5],S=s[6],E=s[7],C=s[8],k=s[9],D=s[10],z=s[11];return s!==u&&(u[0]=s[0],u[1]=s[1],u[2]=s[2],u[3]=s[3],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u[4]=v*m+C*d,u[5]=b*m+k*d,u[6]=S*m+D*d,u[7]=E*m+z*d,u[8]=C*m-v*d,u[9]=k*m-b*d,u[10]=D*m-S*d,u[11]=z*m-E*d,u},f.a0=25,f.a1=Ug,f.a2=u=>{const s=window.document.createElement("video");return s.muted=!0,new Promise(h=>{s.onloadstart=()=>{h(s)};for(const d of u){const m=window.document.createElement("source");ia(d)||(s.crossOrigin="Anonymous"),m.src=d,s.appendChild(m)}})},f.a3=Ue,f.a4=function(){return ai++},f.a5=I,f.a6=Ul,f.a7=Yc,f.a8=ds,f.a9=Vx,f.aA=jg,f.aB=kg,f.aC=$g,f.aD=Ni,f.aE=Rf,f.aF=ue,f.aG=jt,f.aH=qe,f.aI=function(u){return Math.pow(2,u)},f.aJ=85.051129,f.aK=Fx,f.aL=Ct,f.aM=Qr,f.aN=Lx,f.aO=function(u,s,h){return u[0]=s[0]*h,u[1]=s[1]*h,u[2]=s[2]*h,u},f.aP=function(u,s,h){return u[0]=s[0]+h[0],u[1]=s[1]+h[1],u[2]=s[2]+h[2],u},f.aQ=function(u){var s=new gt(3);return s[0]=u[0],s[1]=u[1],s[2]=u[2],s},f.aR=function(u,s,h){return u[0]=s[0]*h[0],u[1]=s[1]*h[1],u[2]=s[2]*h[2],u[3]=s[3]*h[3],u},f.aS=function(u,s,h){return u[0]=s[0]-h[0],u[1]=s[1]-h[1],u[2]=s[2]-h[2],u},f.aT=function(u,s){var h=s[0],d=s[1],m=s[2],v=h*h+d*d+m*m;return v>0&&(v=1/Math.sqrt(v)),u[0]=s[0]*v,u[1]=s[1]*v,u[2]=s[2]*v,u},f.aU=function(u,s,h){var d=s[0],m=s[1],v=s[2],b=h[0],S=h[1],E=h[2];return u[0]=m*E-v*S,u[1]=v*b-d*E,u[2]=d*S-m*b,u},f.aV=function(u,s){return u[0]*s[0]+u[1]*s[1]+u[2]*s[2]},f.aW=Nx,f.aX=Vl,f.aY=function(u,s,h,d,m){var v,b=1/Math.tan(s/2);return u[0]=b/h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=b,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,m!=null&&m!==1/0?(u[10]=(m+d)*(v=1/(d-m)),u[14]=2*m*d*v):(u[10]=-1,u[14]=-2*d),u},f.aZ=function(u){var s=new gt(16);return s[0]=u[0],s[1]=u[1],s[2]=u[2],s[3]=u[3],s[4]=u[4],s[5]=u[5],s[6]=u[6],s[7]=u[7],s[8]=u[8],s[9]=u[9],s[10]=u[10],s[11]=u[11],s[12]=u[12],s[13]=u[13],s[14]=u[14],s[15]=u[15],s},f.a_=function(u,s,h){var d=Math.sin(h),m=Math.cos(h),v=s[0],b=s[1],S=s[2],E=s[3],C=s[4],k=s[5],D=s[6],z=s[7];return s!==u&&(u[8]=s[8],u[9]=s[9],u[10]=s[10],u[11]=s[11],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u[0]=v*m+C*d,u[1]=b*m+k*d,u[2]=S*m+D*d,u[3]=E*m+z*d,u[4]=C*m-v*d,u[5]=k*m-b*d,u[6]=D*m-S*d,u[7]=z*m-E*d,u},f.aa=function(u){const s={};if(u.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(h,d,m,v)=>{const b=m||v;return s[d]=!b||b.toLowerCase(),""}),s["max-age"]){const h=parseInt(s["max-age"],10);isNaN(h)?delete s["max-age"]:s["max-age"]=h}return s},f.ab=function(u){return Math.log(u)/Math.LN2},f.ac=function(u){var s=u[0],h=u[1];return s*s+h*h},f.ad=function(u){return u*Math.PI/180},f.ae=pt,f.af=function(u,s){const h=[];for(const d in u)d in s||h.push(d);return h},f.ag=function(u,s){let h=0,d=0;if(u.kind==="constant")d=u.layoutSize;else if(u.kind!=="source"){const{interpolationType:m,minZoom:v,maxZoom:b}=u,S=m?pt(mr.interpolationFactor(m,s,v,b),0,1):0;u.kind==="camera"?d=rn.number(u.minSize,u.maxSize,S):h=S}return{uSizeT:h,uSize:d}},f.ai=function(u,{uSize:s,uSizeT:h},{lowerSize:d,upperSize:m}){return u.kind==="source"?d/ps:u.kind==="composite"?rn.number(d/ps,m/ps,h):s},f.aj=function(u,s){var h=s[0],d=s[1],m=s[2],v=s[3],b=s[4],S=s[5],E=s[6],C=s[7],k=s[8],D=s[9],z=s[10],V=s[11],$=s[12],H=s[13],J=s[14],re=s[15],me=h*S-d*b,oe=h*E-m*b,U=h*C-v*b,K=d*E-m*S,ce=d*C-v*S,Oe=m*C-v*E,Ye=k*H-D*$,Ne=k*J-z*$,Ve=k*re-V*$,nt=D*J-z*H,Je=D*re-V*H,ot=z*re-V*J,He=me*ot-oe*Je+U*nt+K*Ve-ce*Ne+Oe*Ye;return He?(u[0]=(S*ot-E*Je+C*nt)*(He=1/He),u[1]=(m*Je-d*ot-v*nt)*He,u[2]=(H*Oe-J*ce+re*K)*He,u[3]=(z*ce-D*Oe-V*K)*He,u[4]=(E*Ve-b*ot-C*Ne)*He,u[5]=(h*ot-m*Ve+v*Ne)*He,u[6]=(J*U-$*Oe-re*oe)*He,u[7]=(k*Oe-z*U+V*oe)*He,u[8]=(b*Je-S*Ve+C*Ye)*He,u[9]=(d*Ve-h*Je-v*Ye)*He,u[10]=($*ce-H*U+re*me)*He,u[11]=(D*U-k*ce-V*me)*He,u[12]=(S*Ne-b*nt-E*Ye)*He,u[13]=(h*nt-d*Ne+m*Ye)*He,u[14]=(H*oe-$*K-J*me)*He,u[15]=(k*K-D*oe+z*me)*He,u):null},f.ak=kt,f.al=function(u){return Math.hypot(u[0],u[1])},f.am=function(u){return u[0]=0,u[1]=0,u},f.an=function(u,s,h){return u[0]=s[0]*h,u[1]=s[1]*h,u},f.ao=Og,f.ap=Lt,f.aq=function(u,s,h,d){const m=s.y-u.y,v=s.x-u.x,b=d.y-h.y,S=d.x-h.x,E=b*v-S*m;if(E===0)return null;const C=(S*(u.y-h.y)-b*(u.x-h.x))/E;return new Y(u.x+C*v,u.y+C*m)},f.ar=Hx,f.as=Fl,f.at=yt,f.au=function(u){let s=1/0,h=1/0,d=-1/0,m=-1/0;for(const v of u)s=Math.min(s,v.x),h=Math.min(h,v.y),d=Math.max(d,v.x),m=Math.max(m,v.y);return[s,h,d,m]},f.av=Ji,f.aw=Le,f.ax=function(u,s,h,d,m=!1){if(!h[0]&&!h[1])return[0,0];const v=m?d==="map"?-u.bearingInRadians:0:d==="viewport"?u.bearingInRadians:0;if(v){const b=Math.sin(v),S=Math.cos(v);h=[h[0]*S-h[1]*b,h[0]*b+h[1]*S]}return[m?h[0]:Le(s,h[0],u.zoom),m?h[1]:Le(s,h[1],u.zoom)]},f.az=Dg,f.b=qt,f.b$=u=>u.type==="symbol",f.b0=function(){const u=new Float32Array(16);return yt(u),u},f.b1=function(){const u=new Float64Array(16);return yt(u),u},f.b2=function(){return new Float64Array(16)},f.b3=function(u,s,h){const d=new Float64Array(4);return function(m,v,b,S){var E=.5*Math.PI/180;v*=E,b*=E,S*=E;var C=Math.sin(v),k=Math.cos(v),D=Math.sin(b),z=Math.cos(b),V=Math.sin(S),$=Math.cos(S);m[0]=C*z*$-k*D*V,m[1]=k*D*$+C*z*V,m[2]=k*z*V-C*D*$,m[3]=k*z*$+C*D*V}(d,u,s-90,h),d},f.b4=function(u,s,h,d){var m,v,b,S,E,C=s[0],k=s[1],D=s[2],z=s[3],V=h[0],$=h[1],H=h[2],J=h[3];return(v=C*V+k*$+D*H+z*J)<0&&(v=-v,V=-V,$=-$,H=-H,J=-J),1-v>Xe?(m=Math.acos(v),b=Math.sin(m),S=Math.sin((1-d)*m)/b,E=Math.sin(d*m)/b):(S=1-d,E=d),u[0]=S*C+E*V,u[1]=S*k+E*$,u[2]=S*D+E*H,u[3]=S*z+E*J,u},f.b5=function(u){const s=new Float64Array(9);var h,d,m,v,b,S,E,C,k,D,z,V,$,H,J,re,me,oe;D=(m=(d=u)[0])*(E=m+m),z=(v=d[1])*E,$=(b=d[2])*E,H=b*(C=v+v),re=(S=d[3])*E,me=S*C,oe=S*(k=b+b),(h=s)[0]=1-(V=v*C)-(J=b*k),h[3]=z-oe,h[6]=$+me,h[1]=z+oe,h[4]=1-D-J,h[7]=H-re,h[2]=$-me,h[5]=H+re,h[8]=1-D-V;const U=Qr(-Math.asin(pt(s[2],-1,1)));let K,ce;return Math.hypot(s[5],s[8])<.001?(K=0,ce=-Qr(Math.atan2(s[3],s[4]))):(K=Qr(s[5]===0&&s[8]===0?0:Math.atan2(s[5],s[8])),ce=Qr(s[1]===0&&s[0]===0?0:Math.atan2(s[1],s[0]))),{roll:K,pitch:U+90,bearing:ce}},f.b6=function(u,s){return u.roll==s.roll&&u.pitch==s.pitch&&u.bearing==s.bearing},f.b7=Jt,f.b8=Nn,f.b9=Nl,f.bA=function(u,s){if(!u)return[{command:"setStyle",args:[s]}];let h=[];try{if(!_e(u.version,s.version))return[{command:"setStyle",args:[s]}];_e(u.center,s.center)||h.push({command:"setCenter",args:[s.center]}),_e(u.centerAltitude,s.centerAltitude)||h.push({command:"setCenterAltitude",args:[s.centerAltitude]}),_e(u.zoom,s.zoom)||h.push({command:"setZoom",args:[s.zoom]}),_e(u.bearing,s.bearing)||h.push({command:"setBearing",args:[s.bearing]}),_e(u.pitch,s.pitch)||h.push({command:"setPitch",args:[s.pitch]}),_e(u.roll,s.roll)||h.push({command:"setRoll",args:[s.roll]}),_e(u.sprite,s.sprite)||h.push({command:"setSprite",args:[s.sprite]}),_e(u.glyphs,s.glyphs)||h.push({command:"setGlyphs",args:[s.glyphs]}),_e(u.transition,s.transition)||h.push({command:"setTransition",args:[s.transition]}),_e(u.light,s.light)||h.push({command:"setLight",args:[s.light]}),_e(u.terrain,s.terrain)||h.push({command:"setTerrain",args:[s.terrain]}),_e(u.sky,s.sky)||h.push({command:"setSky",args:[s.sky]}),_e(u.projection,s.projection)||h.push({command:"setProjection",args:[s.projection]});const d={},m=[];(function(b,S,E,C){let k;for(k in S=S||{},b=b||{})Object.prototype.hasOwnProperty.call(b,k)&&(Object.prototype.hasOwnProperty.call(S,k)||$e(k,E,C));for(k in S)Object.prototype.hasOwnProperty.call(S,k)&&(Object.prototype.hasOwnProperty.call(b,k)?_e(b[k],S[k])||(b[k].type==="geojson"&&S[k].type==="geojson"&&Ie(b,S,k)?Re(E,{command:"setGeoJSONSourceData",args:[k,S[k].data]}):ze(k,S,E,C)):be(k,S,E))})(u.sources,s.sources,m,d);const v=[];u.layers&&u.layers.forEach(b=>{"source"in b&&d[b.source]?h.push({command:"removeLayer",args:[b.id]}):v.push(b)}),h=h.concat(m),function(b,S,E){S=S||[];const C=(b=b||[]).map(ht),k=S.map(ht),D=b.reduce(dt,{}),z=S.reduce(dt,{}),V=C.slice(),$=Object.create(null);let H,J,re,me,oe;for(let U=0,K=0;U<C.length;U++)H=C[U],Object.prototype.hasOwnProperty.call(z,H)?K++:(Re(E,{command:"removeLayer",args:[H]}),V.splice(V.indexOf(H,K),1));for(let U=0,K=0;U<k.length;U++)H=k[k.length-1-U],V[V.length-1-U]!==H&&(Object.prototype.hasOwnProperty.call(D,H)?(Re(E,{command:"removeLayer",args:[H]}),V.splice(V.lastIndexOf(H,V.length-K),1)):K++,me=V[V.length-U],Re(E,{command:"addLayer",args:[z[H],me]}),V.splice(V.length-U,0,H),$[H]=!0);for(let U=0;U<k.length;U++)if(H=k[U],J=D[H],re=z[H],!$[H]&&!_e(J,re))if(_e(J.source,re.source)&&_e(J["source-layer"],re["source-layer"])&&_e(J.type,re.type)){for(oe in Ge(J.layout,re.layout,E,H,null,"setLayoutProperty"),Ge(J.paint,re.paint,E,H,null,"setPaintProperty"),_e(J.filter,re.filter)||Re(E,{command:"setFilter",args:[H,re.filter]}),_e(J.minzoom,re.minzoom)&&_e(J.maxzoom,re.maxzoom)||Re(E,{command:"setLayerZoomRange",args:[H,re.minzoom,re.maxzoom]}),J)Object.prototype.hasOwnProperty.call(J,oe)&&oe!=="layout"&&oe!=="paint"&&oe!=="filter"&&oe!=="metadata"&&oe!=="minzoom"&&oe!=="maxzoom"&&(oe.indexOf("paint.")===0?Ge(J[oe],re[oe],E,H,oe.slice(6),"setPaintProperty"):_e(J[oe],re[oe])||Re(E,{command:"setLayerProperty",args:[H,oe,re[oe]]}));for(oe in re)Object.prototype.hasOwnProperty.call(re,oe)&&!Object.prototype.hasOwnProperty.call(J,oe)&&oe!=="layout"&&oe!=="paint"&&oe!=="filter"&&oe!=="metadata"&&oe!=="minzoom"&&oe!=="maxzoom"&&(oe.indexOf("paint.")===0?Ge(J[oe],re[oe],E,H,oe.slice(6),"setPaintProperty"):_e(J[oe],re[oe])||Re(E,{command:"setLayerProperty",args:[H,oe,re[oe]]}))}else Re(E,{command:"removeLayer",args:[H]}),me=V[V.lastIndexOf(H)+1],Re(E,{command:"addLayer",args:[re,me]})}(v,s.layers,h)}catch(d){console.warn("Unable to compute style diff:",d),h=[{command:"setStyle",args:[s]}]}return h},f.bB=function(u){const s=[],h=u.id;return h===void 0&&s.push({message:`layers.${h}: missing required property "id"`}),u.render===void 0&&s.push({message:`layers.${h}: missing required method "render"`}),u.renderingMode&&u.renderingMode!=="2d"&&u.renderingMode!=="3d"&&s.push({message:`layers.${h}: property "renderingMode" must be either "2d" or "3d"`}),s},f.bC=function u(s,h){if(Array.isArray(s)){if(!Array.isArray(h)||s.length!==h.length)return!1;for(let d=0;d<s.length;d++)if(!u(s[d],h[d]))return!1;return!0}if(typeof s=="object"&&s!==null&&h!==null){if(typeof h!="object"||Object.keys(s).length!==Object.keys(h).length)return!1;for(const d in s)if(!u(s[d],h[d]))return!1;return!0}return s===h},f.bD=ei,f.bE=Xt,f.bF=class extends bn{constructor(u,s){super(u,s),this.current=0}set(u){this.current!==u&&(this.current=u,this.gl.uniform1i(this.location,u))}},f.bG=zn,f.bH=class extends bn{constructor(u,s){super(u,s),this.current=Ws}set(u){if(u[12]!==this.current[12]||u[0]!==this.current[0])return this.current=u,void this.gl.uniformMatrix4fv(this.location,!1,u);for(let s=1;s<16;s++)if(u[s]!==this.current[s]){this.current=u,this.gl.uniformMatrix4fv(this.location,!1,u);break}}},f.bI=Ur,f.bJ=class extends bn{constructor(u,s){super(u,s),this.current=[0,0,0]}set(u){u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]||(this.current=u,this.gl.uniform3f(this.location,u[0],u[1],u[2]))}},f.bK=class extends bn{constructor(u,s){super(u,s),this.current=[0,0]}set(u){u[0]===this.current[0]&&u[1]===this.current[1]||(this.current=u,this.gl.uniform2f(this.location,u[0],u[1]))}},f.bL=ft,f.bM=function(u,s){var h=Math.sin(s),d=Math.cos(s);return u[0]=d,u[1]=h,u[2]=0,u[3]=-h,u[4]=d,u[5]=0,u[6]=0,u[7]=0,u[8]=1,u},f.bN=function(u,s,h){var d=s[0],m=s[1],v=s[2];return u[0]=d*h[0]+m*h[3]+v*h[6],u[1]=d*h[1]+m*h[4]+v*h[7],u[2]=d*h[2]+m*h[5]+v*h[8],u},f.bO=function(u,s,h,d,m,v,b){var S=1/(s-h),E=1/(d-m),C=1/(v-b);return u[0]=-2*S,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*E,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*C,u[11]=0,u[12]=(s+h)*S,u[13]=(m+d)*E,u[14]=(b+v)*C,u[15]=1,u},f.bP=class extends pu{},f.bQ=hS,f.bR=class extends Ia{},f.bS=pg,f.bT=function(u){return u<=1?1:Math.pow(2,Math.ceil(Math.log(u)/Math.LN2))},f.bU=Uy,f.bV=function(u,s,h){var d=s[0],m=s[1],v=s[2],b=h[3]*d+h[7]*m+h[11]*v+h[15];return u[0]=(h[0]*d+h[4]*m+h[8]*v+h[12])/(b=b||1),u[1]=(h[1]*d+h[5]*m+h[9]*v+h[13])/b,u[2]=(h[2]*d+h[6]*m+h[10]*v+h[14])/b,u},f.bW=class extends Rl{},f.bX=class extends x{},f.bY=function(u,s){return u[0]===s[0]&&u[1]===s[1]&&u[2]===s[2]&&u[3]===s[3]&&u[4]===s[4]&&u[5]===s[5]&&u[6]===s[6]&&u[7]===s[7]&&u[8]===s[8]&&u[9]===s[9]&&u[10]===s[10]&&u[11]===s[11]&&u[12]===s[12]&&u[13]===s[13]&&u[14]===s[14]&&u[15]===s[15]},f.bZ=function(u,s){var h=u[0],d=u[1],m=u[2],v=u[3],b=u[4],S=u[5],E=u[6],C=u[7],k=u[8],D=u[9],z=u[10],V=u[11],$=u[12],H=u[13],J=u[14],re=u[15],me=s[0],oe=s[1],U=s[2],K=s[3],ce=s[4],Oe=s[5],Ye=s[6],Ne=s[7],Ve=s[8],nt=s[9],Je=s[10],ot=s[11],He=s[12],xt=s[13],It=s[14],At=s[15];return Math.abs(h-me)<=Xe*Math.max(1,Math.abs(h),Math.abs(me))&&Math.abs(d-oe)<=Xe*Math.max(1,Math.abs(d),Math.abs(oe))&&Math.abs(m-U)<=Xe*Math.max(1,Math.abs(m),Math.abs(U))&&Math.abs(v-K)<=Xe*Math.max(1,Math.abs(v),Math.abs(K))&&Math.abs(b-ce)<=Xe*Math.max(1,Math.abs(b),Math.abs(ce))&&Math.abs(S-Oe)<=Xe*Math.max(1,Math.abs(S),Math.abs(Oe))&&Math.abs(E-Ye)<=Xe*Math.max(1,Math.abs(E),Math.abs(Ye))&&Math.abs(C-Ne)<=Xe*Math.max(1,Math.abs(C),Math.abs(Ne))&&Math.abs(k-Ve)<=Xe*Math.max(1,Math.abs(k),Math.abs(Ve))&&Math.abs(D-nt)<=Xe*Math.max(1,Math.abs(D),Math.abs(nt))&&Math.abs(z-Je)<=Xe*Math.max(1,Math.abs(z),Math.abs(Je))&&Math.abs(V-ot)<=Xe*Math.max(1,Math.abs(V),Math.abs(ot))&&Math.abs($-He)<=Xe*Math.max(1,Math.abs($),Math.abs(He))&&Math.abs(H-xt)<=Xe*Math.max(1,Math.abs(H),Math.abs(xt))&&Math.abs(J-It)<=Xe*Math.max(1,Math.abs(J),Math.abs(It))&&Math.abs(re-At)<=Xe*Math.max(1,Math.abs(re),Math.abs(At))},f.b_=function(u,s){return u[0]=s[0],u[1]=s[1],u[2]=s[2],u[3]=s[3],u[4]=s[4],u[5]=s[5],u[6]=s[6],u[7]=s[7],u[8]=s[8],u[9]=s[9],u[10]=s[10],u[11]=s[11],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15],u},f.ba=Pu,f.bb=Bl,f.bc=Ke,f.bd=Qe,f.be=Yi,f.bf=function(u,s,h,d,m){return Ke(d,m,pt((u-s)/(h-s),0,1))},f.bg=we,f.bh=function(){return new Float64Array(4)},f.bi=function(){return new Float64Array(3)},f.bj=function(u,s,h,d){var m=[],v=[];return m[0]=s[0]-h[0],m[1]=s[1]-h[1],m[2]=s[2]-h[2],v[0]=m[0]*Math.cos(d)-m[1]*Math.sin(d),v[1]=m[0]*Math.sin(d)+m[1]*Math.cos(d),v[2]=m[2],u[0]=v[0]+h[0],u[1]=v[1]+h[1],u[2]=v[2]+h[2],u},f.bk=function(u,s,h,d){var m=[],v=[];return m[0]=s[0]-h[0],m[1]=s[1]-h[1],m[2]=s[2]-h[2],v[0]=m[0],v[1]=m[1]*Math.cos(d)-m[2]*Math.sin(d),v[2]=m[1]*Math.sin(d)+m[2]*Math.cos(d),u[0]=v[0]+h[0],u[1]=v[1]+h[1],u[2]=v[2]+h[2],u},f.bl=function(u,s,h,d){var m=[],v=[];return m[0]=s[0]-h[0],m[1]=s[1]-h[1],m[2]=s[2]-h[2],v[0]=m[2]*Math.sin(d)+m[0]*Math.cos(d),v[1]=m[1],v[2]=m[2]*Math.cos(d)-m[0]*Math.sin(d),u[0]=v[0]+h[0],u[1]=v[1]+h[1],u[2]=v[2]+h[2],u},f.bm=function(u,s,h){var d=Math.sin(h),m=Math.cos(h),v=s[0],b=s[1],S=s[2],E=s[3],C=s[8],k=s[9],D=s[10],z=s[11];return s!==u&&(u[4]=s[4],u[5]=s[5],u[6]=s[6],u[7]=s[7],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u[0]=v*m-C*d,u[1]=b*m-k*d,u[2]=S*m-D*d,u[3]=E*m-z*d,u[8]=v*d+C*m,u[9]=b*d+k*m,u[10]=S*d+D*m,u[11]=E*d+z*m,u},f.bn=function(u,s){const h=we(u,360),d=we(s,360),m=d-h,v=d>h?m-360:m+360;return Math.abs(m)<Math.abs(v)?m:v},f.bo=function(u){return u[0]=0,u[1]=0,u[2]=0,u},f.bp=function(u,s,h,d){const m=Math.sqrt(u*u+s*s),v=Math.sqrt(h*h+d*d);u/=m,s/=m,h/=v,d/=v;const b=Math.acos(u*h+s*d);return-s*h+u*d>0?b:-b},f.bq=function(u,s){return u[0]*s[0]+u[1]*s[1]+u[2]*s[2]+u[3]},f.br=Ng,f.bs=function(u,s){const h=we(u,2*Math.PI),d=we(s,2*Math.PI);return Math.min(Math.abs(h-d),Math.abs(h-d+2*Math.PI),Math.abs(h-d-2*Math.PI))},f.bt=function(u){return Math.hypot(u[0],u[1],u[2])},f.bu=function(){const u={},s=j.$version;for(const h in j.$root){const d=j.$root[h];if(d.required){let m=null;m=h==="version"?s:d.type==="array"?[]:{},m!=null&&(u[h]=m)}}return u},f.bv=su,f.bw=Mn,f.bx=function(u){u=u.slice();const s=Object.create(null);for(let h=0;h<u.length;h++)s[u[h].id]=u[h];for(let h=0;h<u.length;h++)"ref"in u[h]&&(u[h]=ye(u[h],s[u[h].ref]));return u},f.by=function(u){if(u.type==="custom")return new OS(u);switch(u.type){case"background":return new RS(u);case"circle":return new PT(u);case"fill":return new HT(u);case"fill-extrusion":return new QT(u);case"heatmap":return new IT(u);case"hillshade":return new MT(u);case"line":return new aS(u);case"raster":return new DS(u);case"symbol":return new Nf(u)}},f.bz=li,f.c=Es,f.c0=u=>u.type==="circle",f.c1=u=>u.type==="heatmap",f.c2=u=>u.type==="line",f.c3=u=>u.type==="fill",f.c4=u=>u.type==="fill-extrusion",f.c5=u=>u.type==="hillshade",f.c6=u=>u.type==="raster",f.c7=u=>u.type==="background",f.c8=u=>u.type==="custom",f.c9=st,f.cA=class{constructor(u){this._marks={start:[u.url,"start"].join("#"),end:[u.url,"end"].join("#"),measure:u.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let u=performance.getEntriesByName(this._marks.measure);return u.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),u=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),u}},f.cB=function(u,s,h,d,m){return a(this,void 0,void 0,function*(){if(Ce())try{return yield Kr(u,s,h,d,m)}catch{}return function(v,b,S,E,C){const k=v.width,D=v.height;Qn&&es||(Qn=new OffscreenCanvas(k,D),es=Qn.getContext("2d",{willReadFrequently:!0})),Qn.width=k,Qn.height=D,es.drawImage(v,0,0,k,D);const z=es.getImageData(b,S,E,C);return es.clearRect(0,0,k,D),z.data}(u,s,h,d,m)})},f.cC=zx,f.cD=y,f.cE=M,f.cF=rx,f.cG=gx,f.cH=xl,f.cI=Ln,f.ca=function(u,s,h){const d=ji(s.x-h.x,s.y-h.y),m=ji(u.x-h.x,u.y-h.y);var v,b;return Qr(Math.atan2(d[0]*m[1]-d[1]*m[0],(v=d)[0]*(b=m)[0]+v[1]*b[1]))},f.cb=rt,f.cc=function(u,s){return io[s]&&(u instanceof MouseEvent||u instanceof WheelEvent)},f.cd=function(u,s){return to[s]&&"touches"in u},f.ce=function(u){return to[u]||io[u]},f.cf=function(u,s,h){var d=s[0],m=s[1];return u[0]=h[0]*d+h[4]*m+h[12],u[1]=h[1]*d+h[5]*m+h[13],u},f.cg=function(u,s){const{x:h,y:d}=Ou.fromLngLat(s);return!(u<0||u>25||d<0||d>=1||h<0||h>=1)},f.ch=function(u,s){return u[0]=s[0],u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=s[1],u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=s[2],u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u},f.ci=class extends xn{},f.cj=HS,f.cl=function(u){return u.message===ta},f.cm=dn,f.cn=function(u,s){ts.REGISTERED_PROTOCOLS[u]=s},f.co=function(u){delete ts.REGISTERED_PROTOCOLS[u]},f.cp=function(u,s){const h={};for(let m=0;m<u.length;m++){const v=s&&s[u[m].id]||tg(u[m]);s&&(s[u[m].id]=v);let b=h[v];b||(b=h[v]=[]),b.push(u[m])}const d=[];for(const m in h)d.push(h[m]);return d},f.cq=mt,f.cr=Ux,f.cs=jx,f.ct=_x,f.cu=function(u){u.bucket.createArrays(),u.bucket.tilePixelRatio=he/(512*u.bucket.overscaling),u.bucket.compareText={},u.bucket.iconsNeedLinear=!1;const s=u.bucket.layers[0],h=s.layout,d=s._unevaluatedLayout._values,m={layoutIconSize:d["icon-size"].possiblyEvaluate(new yi(u.bucket.zoom+1),u.canonical),layoutTextSize:d["text-size"].possiblyEvaluate(new yi(u.bucket.zoom+1),u.canonical),textMaxSize:d["text-size"].possiblyEvaluate(new yi(18))};if(u.bucket.textSizeData.kind==="composite"){const{minZoom:C,maxZoom:k}=u.bucket.textSizeData;m.compositeTextSizes=[d["text-size"].possiblyEvaluate(new yi(C),u.canonical),d["text-size"].possiblyEvaluate(new yi(k),u.canonical)]}if(u.bucket.iconSizeData.kind==="composite"){const{minZoom:C,maxZoom:k}=u.bucket.iconSizeData;m.compositeIconSizes=[d["icon-size"].possiblyEvaluate(new yi(C),u.canonical),d["icon-size"].possiblyEvaluate(new yi(k),u.canonical)]}const v=h.get("text-line-height")*Ji,b=h.get("text-rotation-alignment")!=="viewport"&&h.get("symbol-placement")!=="point",S=h.get("text-keep-upright"),E=h.get("text-size");for(const C of u.bucket.features){const k=h.get("text-font").evaluate(C,{},u.canonical).join(","),D=E.evaluate(C,{},u.canonical),z=m.layoutTextSize.evaluate(C,{},u.canonical),V=m.layoutIconSize.evaluate(C,{},u.canonical),$={horizontal:{},vertical:void 0},H=C.text;let J,re=[0,0];if(H){const U=H.toString(),K=h.get("text-letter-spacing").evaluate(C,{},u.canonical)*Ji,ce=xf(U)?K:0,Oe=h.get("text-anchor").evaluate(C,{},u.canonical),Ye=ev(s,C,u.canonical);if(!Ye){const Je=h.get("text-radial-offset").evaluate(C,{},u.canonical);re=Je?Qx(Oe,[Je*Ji,Vg]):h.get("text-offset").evaluate(C,{},u.canonical).map(ot=>ot*Ji)}let Ne=b?"center":h.get("text-justify").evaluate(C,{},u.canonical);const Ve=h.get("symbol-placement")==="point"?h.get("text-max-width").evaluate(C,{},u.canonical)*Ji:1/0,nt=()=>{u.bucket.allowVerticalPlacement&&El(U)&&($.vertical=Ff(H,u.glyphMap,u.glyphPositions,u.imagePositions,k,Ve,v,Oe,"left",ce,re,f.ah.vertical,!0,z,D))};if(!b&&Ye){const Je=new Set;if(Ne==="auto")for(let He=0;He<Ye.values.length;He+=2)Je.add(jg(Ye.values[He]));else Je.add(Ne);let ot=!1;for(const He of Je)if(!$.horizontal[He])if(ot)$.horizontal[He]=$.horizontal[0];else{const xt=Ff(H,u.glyphMap,u.glyphPositions,u.imagePositions,k,Ve,v,"center",He,ce,re,f.ah.horizontal,!1,z,D);xt&&($.horizontal[He]=xt,ot=xt.positionedLines.length===1)}nt()}else{Ne==="auto"&&(Ne=jg(Oe));const Je=Ff(H,u.glyphMap,u.glyphPositions,u.imagePositions,k,Ve,v,Oe,Ne,ce,re,f.ah.horizontal,!1,z,D);Je&&($.horizontal[Ne]=Je),nt(),El(U)&&b&&S&&($.vertical=Ff(H,u.glyphMap,u.glyphPositions,u.imagePositions,k,Ve,v,Oe,Ne,ce,re,f.ah.vertical,!1,z,D))}}let me=!1;if(C.icon&&C.icon.name){const U=u.imageMap[C.icon.name];U&&(J=PS(u.imagePositions[C.icon.name],h.get("icon-offset").evaluate(C,{},u.canonical),h.get("icon-anchor").evaluate(C,{},u.canonical)),me=!!U.sdf,u.bucket.sdfIcons===void 0?u.bucket.sdfIcons=me:u.bucket.sdfIcons!==me&&Li("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(U.pixelRatio!==u.bucket.pixelRatio||h.get("icon-rotate").constantOr(1)!==0)&&(u.bucket.iconsNeedLinear=!0))}const oe=iv($.horizontal)||$.vertical;u.bucket.iconsInText=!!oe&&oe.iconsInText,(oe||J)&&$S(u.bucket,C,$,J,u.imageMap,m,z,V,re,me,u.canonical,u.subdivisionGranularity)}u.showCollisionBoxes&&u.bucket.generateCollisionDebugBuffers()},f.cv=Ag,f.cw=xg,f.cx=Sg,f.cy=Iu,f.cz=Ig,f.d=ia,f.e=Tt,f.f=u=>a(void 0,void 0,void 0,function*(){if(u.byteLength===0)return createImageBitmap(new ImageData(1,1));const s=new Blob([new Uint8Array(u)],{type:"image/png"});try{return createImageBitmap(s)}catch(h){throw new Error(`Could not load image because of ${h.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),f.g=ro,f.h=u=>new Promise((s,h)=>{const d=new Image;d.onload=()=>{s(d),URL.revokeObjectURL(d.src),d.onload=null,window.requestAnimationFrame(()=>{d.src=Gt})},d.onerror=()=>h(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const m=new Blob([new Uint8Array(u)],{type:"image/png"});d.src=u.byteLength?URL.createObjectURL(m):Gt}),f.i=Hr,f.j=(u,s)=>no(Tt(u,{type:"json"}),s),f.k=Z,f.l=Pe,f.m=no,f.n=(u,s)=>no(Tt(u,{type:"arrayBuffer"}),s),f.o=function(u){return new Ig(u).readFields(pS,[])},f.p=mx,f.q=bu,f.r=kr,f.s=Jr,f.t=ru,f.u=Ht,f.v=j,f.w=Li,f.x=Ro,f.y=Ns,f.z=function([u,s,h]){return s+=90,s*=Math.PI/180,h*=Math.PI/180,{x:u*Math.cos(s)*Math.sin(h),y:u*Math.sin(s)*Math.sin(h),z:u*Math.cos(h)}}}),o("worker",["./shared"],function(f){class a{constructor(Z){this.keyCache={},Z&&this.replace(Z)}replace(Z){this._layerConfigs={},this._layers={},this.update(Z,[])}update(Z,q){for(const le of Z){this._layerConfigs[le.id]=le;const ye=this._layers[le.id]=f.by(le);ye._featureFilter=f.a7(ye.filter),this.keyCache[le.id]&&delete this.keyCache[le.id]}for(const le of q)delete this.keyCache[le],delete this._layerConfigs[le],delete this._layers[le];this.familiesBySource={};const j=f.cp(Object.values(this._layerConfigs),this.keyCache);for(const le of j){const ye=le.map(Ie=>this._layers[Ie.id]),_e=ye[0];if(_e.visibility==="none")continue;const Re=_e.source||"";let be=this.familiesBySource[Re];be||(be=this.familiesBySource[Re]={});const $e=_e.sourceLayer||"_geojsonTileLayer";let ze=be[$e];ze||(ze=be[$e]=[]),ze.push(ye)}}}class y{constructor(Z){const q={},j=[];for(const Re in Z){const be=Z[Re],$e=q[Re]={};for(const ze in be){const Ie=be[+ze];if(!Ie||Ie.bitmap.width===0||Ie.bitmap.height===0)continue;const Ge={x:0,y:0,w:Ie.bitmap.width+2,h:Ie.bitmap.height+2};j.push(Ge),$e[ze]={rect:Ge,metrics:Ie.metrics}}}const{w:le,h:ye}=f.p(j),_e=new f.q({width:le||1,height:ye||1});for(const Re in Z){const be=Z[Re];for(const $e in be){const ze=be[+$e];if(!ze||ze.bitmap.width===0||ze.bitmap.height===0)continue;const Ie=q[Re][$e].rect;f.q.copy(ze.bitmap,_e,{x:0,y:0},{x:Ie.x+1,y:Ie.y+1},ze.bitmap)}}this.image=_e,this.positions=q}}f.cq("GlyphAtlas",y);class T{constructor(Z){this.tileID=new f.Y(Z.tileID.overscaledZ,Z.tileID.wrap,Z.tileID.canonical.z,Z.tileID.canonical.x,Z.tileID.canonical.y),this.uid=Z.uid,this.zoom=Z.zoom,this.pixelRatio=Z.pixelRatio,this.tileSize=Z.tileSize,this.source=Z.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=Z.showCollisionBoxes,this.collectResourceTiming=!!Z.collectResourceTiming,this.returnDependencies=!!Z.returnDependencies,this.promoteId=Z.promoteId,this.inFlightDependencies=[]}parse(Z,q,j,le,ye){return f._(this,void 0,void 0,function*(){this.status="parsing",this.data=Z,this.collisionBoxArray=new f.a5;const _e=new f.cr(Object.keys(Z.layers).sort()),Re=new f.cs(this.tileID,this.promoteId);Re.bucketLayerIDs=[];const be={},$e={featureIndex:Re,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:j,subdivisionGranularity:ye},ze=q.familiesBySource[this.source];for(const ct in ze){const zt=Z.layers[ct];if(!zt)continue;zt.version===1&&f.w(`Vector tile source "${this.source}" layer "${ct}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Mi=_e.encode(ct),kn=[];for(let Rt=0;Rt<zt.length;Rt++){const Gi=zt.feature(Rt),mi=Re.getId(Gi,ct);kn.push({feature:Gi,id:mi,index:Rt,sourceLayerIndex:Mi})}for(const Rt of ze[ct]){const Gi=Rt[0];Gi.source!==this.source&&f.w(`layer.source = ${Gi.source} does not equal this.source = ${this.source}`),Gi.minzoom&&this.zoom<Math.floor(Gi.minzoom)||Gi.maxzoom&&this.zoom>=Gi.maxzoom||Gi.visibility!=="none"&&(A(Rt,this.zoom,j),(be[Gi.id]=Gi.createBucket({index:Re.bucketLayerIDs.length,layers:Rt,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Mi,sourceID:this.source})).populate(kn,$e,this.tileID.canonical),Re.bucketLayerIDs.push(Rt.map(mi=>mi.id)))}}const Ie=f.bD($e.glyphDependencies,ct=>Object.keys(ct).map(Number));this.inFlightDependencies.forEach(ct=>ct==null?void 0:ct.abort()),this.inFlightDependencies=[];let Ge=Promise.resolve({});if(Object.keys(Ie).length){const ct=new AbortController;this.inFlightDependencies.push(ct),Ge=le.sendAsync({type:"GG",data:{stacks:Ie,source:this.source,tileID:this.tileID,type:"glyphs"}},ct)}const ht=Object.keys($e.iconDependencies);let dt=Promise.resolve({});if(ht.length){const ct=new AbortController;this.inFlightDependencies.push(ct),dt=le.sendAsync({type:"GI",data:{icons:ht,source:this.source,tileID:this.tileID,type:"icons"}},ct)}const Ue=Object.keys($e.patternDependencies);let Ft=Promise.resolve({});if(Ue.length){const ct=new AbortController;this.inFlightDependencies.push(ct),Ft=le.sendAsync({type:"GI",data:{icons:Ue,source:this.source,tileID:this.tileID,type:"patterns"}},ct)}const[Et,Ot,Kt]=yield Promise.all([Ge,dt,Ft]),et=new y(Et),vt=new f.ct(Ot,Kt);for(const ct in be){const zt=be[ct];zt instanceof f.a6?(A(zt.layers,this.zoom,j),f.cu({bucket:zt,glyphMap:Et,glyphPositions:et.positions,imageMap:Ot,imagePositions:vt.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:$e.subdivisionGranularity})):zt.hasPattern&&(zt instanceof f.cv||zt instanceof f.cw||zt instanceof f.cx)&&(A(zt.layers,this.zoom,j),zt.addFeatures($e,this.tileID.canonical,vt.patternPositions))}return this.status="done",{buckets:Object.values(be).filter(ct=>!ct.isEmpty()),featureIndex:Re,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:et.image,imageAtlas:vt,glyphMap:this.returnDependencies?Et:null,iconMap:this.returnDependencies?Ot:null,glyphPositions:this.returnDependencies?et.positions:null}})}}function A(Pe,Z,q){const j=new f.C(Z);for(const le of Pe)le.recalculate(j,q)}class M{constructor(Z,q,j){this.actor=Z,this.layerIndex=q,this.availableImages=j,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(Z,q){return f._(this,void 0,void 0,function*(){const j=yield f.n(Z.request,q);try{return{vectorTile:new f.cy.VectorTile(new f.cz(j.data)),rawData:j.data,cacheControl:j.cacheControl,expires:j.expires}}catch(le){const ye=new Uint8Array(j.data);let _e=`Unable to parse the tile at ${Z.request.url}, `;throw _e+=ye[0]===31&&ye[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${le.message}`,new Error(_e)}})}loadTile(Z){return f._(this,void 0,void 0,function*(){const q=Z.uid,j=!!(Z&&Z.request&&Z.request.collectResourceTiming)&&new f.cA(Z.request),le=new T(Z);this.loading[q]=le;const ye=new AbortController;le.abort=ye;try{const _e=yield this.loadVectorTile(Z,ye);if(delete this.loading[q],!_e)return null;const Re=_e.rawData,be={};_e.expires&&(be.expires=_e.expires),_e.cacheControl&&(be.cacheControl=_e.cacheControl);const $e={};if(j){const Ie=j.finish();Ie&&($e.resourceTiming=JSON.parse(JSON.stringify(Ie)))}le.vectorTile=_e.vectorTile;const ze=le.parse(_e.vectorTile,this.layerIndex,this.availableImages,this.actor,Z.subdivisionGranularity);this.loaded[q]=le,this.fetching[q]={rawTileData:Re,cacheControl:be,resourceTiming:$e};try{const Ie=yield ze;return f.e({rawTileData:Re.slice(0)},Ie,be,$e)}finally{delete this.fetching[q]}}catch(_e){throw delete this.loading[q],le.status="done",this.loaded[q]=le,_e}})}reloadTile(Z){return f._(this,void 0,void 0,function*(){const q=Z.uid;if(!this.loaded||!this.loaded[q])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const j=this.loaded[q];if(j.showCollisionBoxes=Z.showCollisionBoxes,j.status==="parsing"){const le=yield j.parse(j.vectorTile,this.layerIndex,this.availableImages,this.actor,Z.subdivisionGranularity);let ye;if(this.fetching[q]){const{rawTileData:_e,cacheControl:Re,resourceTiming:be}=this.fetching[q];delete this.fetching[q],ye=f.e({rawTileData:_e.slice(0)},le,Re,be)}else ye=le;return ye}if(j.status==="done"&&j.vectorTile)return j.parse(j.vectorTile,this.layerIndex,this.availableImages,this.actor,Z.subdivisionGranularity)})}abortTile(Z){return f._(this,void 0,void 0,function*(){const q=this.loading,j=Z.uid;q&&q[j]&&q[j].abort&&(q[j].abort.abort(),delete q[j])})}removeTile(Z){return f._(this,void 0,void 0,function*(){this.loaded&&this.loaded[Z.uid]&&delete this.loaded[Z.uid]})}}class F{constructor(){this.loaded={}}loadTile(Z){return f._(this,void 0,void 0,function*(){const{uid:q,encoding:j,rawImageData:le,redFactor:ye,greenFactor:_e,blueFactor:Re,baseShift:be}=Z,$e=le.width+2,ze=le.height+2,Ie=f.b(le)?new f.R({width:$e,height:ze},yield f.cB(le,-1,-1,$e,ze)):le,Ge=new f.cC(q,Ie,j,ye,_e,Re,be);return this.loaded=this.loaded||{},this.loaded[q]=Ge,Ge})}removeTile(Z){const q=this.loaded,j=Z.uid;q&&q[j]&&delete q[j]}}var L,Y,ae=function(){if(Y)return L;function Pe(q,j){if(q.length!==0){Z(q[0],j);for(var le=1;le<q.length;le++)Z(q[le],!j)}}function Z(q,j){for(var le=0,ye=0,_e=0,Re=q.length,be=Re-1;_e<Re;be=_e++){var $e=(q[_e][0]-q[be][0])*(q[be][1]+q[_e][1]),ze=le+$e;ye+=Math.abs(le)>=Math.abs($e)?le-ze+$e:$e-ze+le,le=ze}le+ye>=0!=!!j&&q.reverse()}return Y=1,L=function q(j,le){var ye,_e=j&&j.type;if(_e==="FeatureCollection")for(ye=0;ye<j.features.length;ye++)q(j.features[ye],le);else if(_e==="GeometryCollection")for(ye=0;ye<j.geometries.length;ye++)q(j.geometries[ye],le);else if(_e==="Feature")q(j.geometry,le);else if(_e==="Polygon")Pe(j.coordinates,le);else if(_e==="MultiPolygon")for(ye=0;ye<j.coordinates.length;ye++)Pe(j.coordinates[ye],le);return j}}(),pe=f.cD(ae);const Ee=f.cy.VectorTileFeature.prototype.toGeoJSON;class Be{constructor(Z){this._feature=Z,this.extent=f.Z,this.type=Z.type,this.properties=Z.tags,"id"in Z&&!isNaN(Z.id)&&(this.id=parseInt(Z.id,10))}loadGeometry(){if(this._feature.type===1){const Z=[];for(const q of this._feature.geometry)Z.push([new f.P(q[0],q[1])]);return Z}{const Z=[];for(const q of this._feature.geometry){const j=[];for(const le of q)j.push(new f.P(le[0],le[1]));Z.push(j)}return Z}}toGeoJSON(Z,q,j){return Ee.call(this,Z,q,j)}}class xe{constructor(Z){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=f.Z,this.length=Z.length,this._features=Z}feature(Z){return new Be(this._features[Z])}}var Ce,tt,Xe,gt={exports:{}},ft=function(){if(Xe)return gt.exports;Xe=1;var Pe=f.cG(),Z=function(){if(tt)return Ce;tt=1;var ze=f.cE(),Ie=f.cF().VectorTileFeature;function Ge(dt,Ue){this.options=Ue||{},this.features=dt,this.length=dt.length}function ht(dt,Ue){this.id=typeof dt.id=="number"?dt.id:void 0,this.type=dt.type,this.rawGeometry=dt.type===1?[dt.geometry]:dt.geometry,this.properties=dt.tags,this.extent=Ue||4096}return Ce=Ge,Ge.prototype.feature=function(dt){return new ht(this.features[dt],this.options.extent)},ht.prototype.loadGeometry=function(){var dt=this.rawGeometry;this.geometry=[];for(var Ue=0;Ue<dt.length;Ue++){for(var Ft=dt[Ue],Et=[],Ot=0;Ot<Ft.length;Ot++)Et.push(new ze(Ft[Ot][0],Ft[Ot][1]));this.geometry.push(Et)}return this.geometry},ht.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var dt=this.geometry,Ue=1/0,Ft=-1/0,Et=1/0,Ot=-1/0,Kt=0;Kt<dt.length;Kt++)for(var et=dt[Kt],vt=0;vt<et.length;vt++){var ct=et[vt];Ue=Math.min(Ue,ct.x),Ft=Math.max(Ft,ct.x),Et=Math.min(Et,ct.y),Ot=Math.max(Ot,ct.y)}return[Ue,Et,Ft,Ot]},ht.prototype.toGeoJSON=Ie.prototype.toGeoJSON,Ce}();function q(ze){var Ie=new Pe;return function(Ge,ht){for(var dt in Ge.layers)ht.writeMessage(3,j,Ge.layers[dt])}(ze,Ie),Ie.finish()}function j(ze,Ie){var Ge;Ie.writeVarintField(15,ze.version||1),Ie.writeStringField(1,ze.name||""),Ie.writeVarintField(5,ze.extent||4096);var ht={keys:[],values:[],keycache:{},valuecache:{}};for(Ge=0;Ge<ze.length;Ge++)ht.feature=ze.feature(Ge),Ie.writeMessage(2,le,ht);var dt=ht.keys;for(Ge=0;Ge<dt.length;Ge++)Ie.writeStringField(3,dt[Ge]);var Ue=ht.values;for(Ge=0;Ge<Ue.length;Ge++)Ie.writeMessage(4,$e,Ue[Ge])}function le(ze,Ie){var Ge=ze.feature;Ge.id!==void 0&&Ie.writeVarintField(1,Ge.id),Ie.writeMessage(2,ye,ze),Ie.writeVarintField(3,Ge.type),Ie.writeMessage(4,be,Ge)}function ye(ze,Ie){var Ge=ze.feature,ht=ze.keys,dt=ze.values,Ue=ze.keycache,Ft=ze.valuecache;for(var Et in Ge.properties){var Ot=Ge.properties[Et],Kt=Ue[Et];if(Ot!==null){Kt===void 0&&(ht.push(Et),Ue[Et]=Kt=ht.length-1),Ie.writeVarint(Kt);var et=typeof Ot;et!=="string"&&et!=="boolean"&&et!=="number"&&(Ot=JSON.stringify(Ot));var vt=et+":"+Ot,ct=Ft[vt];ct===void 0&&(dt.push(Ot),Ft[vt]=ct=dt.length-1),Ie.writeVarint(ct)}}}function _e(ze,Ie){return(Ie<<3)+(7&ze)}function Re(ze){return ze<<1^ze>>31}function be(ze,Ie){for(var Ge=ze.loadGeometry(),ht=ze.type,dt=0,Ue=0,Ft=Ge.length,Et=0;Et<Ft;Et++){var Ot=Ge[Et],Kt=1;ht===1&&(Kt=Ot.length),Ie.writeVarint(_e(1,Kt));for(var et=ht===3?Ot.length-1:Ot.length,vt=0;vt<et;vt++){vt===1&&ht!==1&&Ie.writeVarint(_e(2,et-1));var ct=Ot[vt].x-dt,zt=Ot[vt].y-Ue;Ie.writeVarint(Re(ct)),Ie.writeVarint(Re(zt)),dt+=ct,Ue+=zt}ht===3&&Ie.writeVarint(_e(7,1))}}function $e(ze,Ie){var Ge=typeof ze;Ge==="string"?Ie.writeStringField(1,ze):Ge==="boolean"?Ie.writeBooleanField(7,ze):Ge==="number"&&(ze%1!=0?Ie.writeDoubleField(3,ze):ze<0?Ie.writeSVarintField(6,ze):Ie.writeVarintField(5,ze))}return gt.exports=q,gt.exports.fromVectorTileJs=q,gt.exports.fromGeojsonVt=function(ze,Ie){Ie=Ie||{};var Ge={};for(var ht in ze)Ge[ht]=new Z(ze[ht].features,Ie),Ge[ht].name=ht,Ge[ht].version=Ie.version,Ge[ht].extent=Ie.extent;return q({layers:Ge})},gt.exports.GeoJSONWrapper=Z,gt.exports}(),yt=f.cD(ft);const Bt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Pe=>Pe},Pt=Math.fround||(Lt=new Float32Array(1),Pe=>(Lt[0]=+Pe,Lt[0]));var Lt;const Dt=3,kt=5,ji=6;class he{constructor(Z){this.options=Object.assign(Object.create(Bt),Z),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Z){const{log:q,minZoom:j,maxZoom:le}=this.options;q&&console.time("total time");const ye=`prepare ${Z.length} points`;q&&console.time(ye),this.points=Z;const _e=[];for(let be=0;be<Z.length;be++){const $e=Z[be];if(!$e.geometry)continue;const[ze,Ie]=$e.geometry.coordinates,Ge=Pt(Ke(ze)),ht=Pt(Qe(Ie));_e.push(Ge,ht,1/0,be,-1,1),this.options.reduce&&_e.push(0)}let Re=this.trees[le+1]=this._createTree(_e);q&&console.timeEnd(ye);for(let be=le;be>=j;be--){const $e=+Date.now();Re=this.trees[be]=this._createTree(this._cluster(Re,be)),q&&console.log("z%d: %d clusters in %dms",be,Re.numItems,+Date.now()-$e)}return q&&console.timeEnd("total time"),this}getClusters(Z,q){let j=((Z[0]+180)%360+360)%360-180;const le=Math.max(-90,Math.min(90,Z[1]));let ye=Z[2]===180?180:((Z[2]+180)%360+360)%360-180;const _e=Math.max(-90,Math.min(90,Z[3]));if(Z[2]-Z[0]>=360)j=-180,ye=180;else if(j>ye){const Ie=this.getClusters([j,le,180,_e],q),Ge=this.getClusters([-180,le,ye,_e],q);return Ie.concat(Ge)}const Re=this.trees[this._limitZoom(q)],be=Re.range(Ke(j),Qe(_e),Ke(ye),Qe(le)),$e=Re.data,ze=[];for(const Ie of be){const Ge=this.stride*Ie;ze.push($e[Ge+kt]>1?Le($e,Ge,this.clusterProps):this.points[$e[Ge+Dt]])}return ze}getChildren(Z){const q=this._getOriginId(Z),j=this._getOriginZoom(Z),le="No cluster with the specified id.",ye=this.trees[j];if(!ye)throw new Error(le);const _e=ye.data;if(q*this.stride>=_e.length)throw new Error(le);const Re=this.options.radius/(this.options.extent*Math.pow(2,j-1)),be=ye.within(_e[q*this.stride],_e[q*this.stride+1],Re),$e=[];for(const ze of be){const Ie=ze*this.stride;_e[Ie+4]===Z&&$e.push(_e[Ie+kt]>1?Le(_e,Ie,this.clusterProps):this.points[_e[Ie+Dt]])}if($e.length===0)throw new Error(le);return $e}getLeaves(Z,q,j){const le=[];return this._appendLeaves(le,Z,q=q||10,j=j||0,0),le}getTile(Z,q,j){const le=this.trees[this._limitZoom(Z)],ye=Math.pow(2,Z),{extent:_e,radius:Re}=this.options,be=Re/_e,$e=(j-be)/ye,ze=(j+1+be)/ye,Ie={features:[]};return this._addTileFeatures(le.range((q-be)/ye,$e,(q+1+be)/ye,ze),le.data,q,j,ye,Ie),q===0&&this._addTileFeatures(le.range(1-be/ye,$e,1,ze),le.data,ye,j,ye,Ie),q===ye-1&&this._addTileFeatures(le.range(0,$e,be/ye,ze),le.data,-1,j,ye,Ie),Ie.features.length?Ie:null}getClusterExpansionZoom(Z){let q=this._getOriginZoom(Z)-1;for(;q<=this.options.maxZoom;){const j=this.getChildren(Z);if(q++,j.length!==1)break;Z=j[0].properties.cluster_id}return q}_appendLeaves(Z,q,j,le,ye){const _e=this.getChildren(q);for(const Re of _e){const be=Re.properties;if(be&&be.cluster?ye+be.point_count<=le?ye+=be.point_count:ye=this._appendLeaves(Z,be.cluster_id,j,le,ye):ye<le?ye++:Z.push(Re),Z.length===j)break}return ye}_createTree(Z){const q=new f.aC(Z.length/this.stride|0,this.options.nodeSize,Float32Array);for(let j=0;j<Z.length;j+=this.stride)q.add(Z[j],Z[j+1]);return q.finish(),q.data=Z,q}_addTileFeatures(Z,q,j,le,ye,_e){for(const Re of Z){const be=Re*this.stride,$e=q[be+kt]>1;let ze,Ie,Ge;if($e)ze=we(q,be,this.clusterProps),Ie=q[be],Ge=q[be+1];else{const Ue=this.points[q[be+Dt]];ze=Ue.properties;const[Ft,Et]=Ue.geometry.coordinates;Ie=Ke(Ft),Ge=Qe(Et)}const ht={type:1,geometry:[[Math.round(this.options.extent*(Ie*ye-j)),Math.round(this.options.extent*(Ge*ye-le))]],tags:ze};let dt;dt=$e||this.options.generateId?q[be+Dt]:this.points[q[be+Dt]].id,dt!==void 0&&(ht.id=dt),_e.features.push(ht)}}_limitZoom(Z){return Math.max(this.options.minZoom,Math.min(Math.floor(+Z),this.options.maxZoom+1))}_cluster(Z,q){const{radius:j,extent:le,reduce:ye,minPoints:_e}=this.options,Re=j/(le*Math.pow(2,q)),be=Z.data,$e=[],ze=this.stride;for(let Ie=0;Ie<be.length;Ie+=ze){if(be[Ie+2]<=q)continue;be[Ie+2]=q;const Ge=be[Ie],ht=be[Ie+1],dt=Z.within(be[Ie],be[Ie+1],Re),Ue=be[Ie+kt];let Ft=Ue;for(const Et of dt){const Ot=Et*ze;be[Ot+2]>q&&(Ft+=be[Ot+kt])}if(Ft>Ue&&Ft>=_e){let Et,Ot=Ge*Ue,Kt=ht*Ue,et=-1;const vt=((Ie/ze|0)<<5)+(q+1)+this.points.length;for(const ct of dt){const zt=ct*ze;if(be[zt+2]<=q)continue;be[zt+2]=q;const Mi=be[zt+kt];Ot+=be[zt]*Mi,Kt+=be[zt+1]*Mi,be[zt+4]=vt,ye&&(Et||(Et=this._map(be,Ie,!0),et=this.clusterProps.length,this.clusterProps.push(Et)),ye(Et,this._map(be,zt)))}be[Ie+4]=vt,$e.push(Ot/Ft,Kt/Ft,1/0,vt,-1,Ft),ye&&$e.push(et)}else{for(let Et=0;Et<ze;Et++)$e.push(be[Ie+Et]);if(Ft>1)for(const Et of dt){const Ot=Et*ze;if(!(be[Ot+2]<=q)){be[Ot+2]=q;for(let Kt=0;Kt<ze;Kt++)$e.push(be[Ot+Kt])}}}}return $e}_getOriginId(Z){return Z-this.points.length>>5}_getOriginZoom(Z){return(Z-this.points.length)%32}_map(Z,q,j){if(Z[q+kt]>1){const _e=this.clusterProps[Z[q+ji]];return j?Object.assign({},_e):_e}const le=this.points[Z[q+Dt]].properties,ye=this.options.map(le);return j&&ye===le?Object.assign({},ye):ye}}function Le(Pe,Z,q){return{type:"Feature",id:Pe[Z+Dt],properties:we(Pe,Z,q),geometry:{type:"Point",coordinates:[(j=Pe[Z],360*(j-.5)),st(Pe[Z+1])]}};var j}function we(Pe,Z,q){const j=Pe[Z+kt],le=j>=1e4?`${Math.round(j/1e3)}k`:j>=1e3?Math.round(j/100)/10+"k":j,ye=Pe[Z+ji],_e=ye===-1?{}:Object.assign({},q[ye]);return Object.assign(_e,{cluster:!0,cluster_id:Pe[Z+Dt],point_count:j,point_count_abbreviated:le})}function Ke(Pe){return Pe/360+.5}function Qe(Pe){const Z=Math.sin(Pe*Math.PI/180),q=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return q<0?0:q>1?1:q}function st(Pe){const Z=(180-360*Pe)*Math.PI/180;return 360*Math.atan(Math.exp(Z))/Math.PI-90}function rt(Pe,Z,q,j){let le=j;const ye=Z+(q-Z>>1);let _e,Re=q-Z;const be=Pe[Z],$e=Pe[Z+1],ze=Pe[q],Ie=Pe[q+1];for(let Ge=Z+3;Ge<q;Ge+=3){const ht=pt(Pe[Ge],Pe[Ge+1],be,$e,ze,Ie);if(ht>le)_e=Ge,le=ht;else if(ht===le){const dt=Math.abs(Ge-ye);dt<Re&&(_e=Ge,Re=dt)}}le>j&&(_e-Z>3&&rt(Pe,Z,_e,j),Pe[_e+2]=le,q-_e>3&&rt(Pe,_e,q,j))}function pt(Pe,Z,q,j,le,ye){let _e=le-q,Re=ye-j;if(_e!==0||Re!==0){const be=((Pe-q)*_e+(Z-j)*Re)/(_e*_e+Re*Re);be>1?(q=le,j=ye):be>0&&(q+=_e*be,j+=Re*be)}return _e=Pe-q,Re=Z-j,_e*_e+Re*Re}function Ct(Pe,Z,q,j){const le={id:Pe??null,type:Z,geometry:q,tags:j,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(Z==="Point"||Z==="MultiPoint"||Z==="LineString")Tt(le,q);else if(Z==="Polygon")Tt(le,q[0]);else if(Z==="MultiLineString")for(const ye of q)Tt(le,ye);else if(Z==="MultiPolygon")for(const ye of q)Tt(le,ye[0]);return le}function Tt(Pe,Z){for(let q=0;q<Z.length;q+=3)Pe.minX=Math.min(Pe.minX,Z[q]),Pe.minY=Math.min(Pe.minY,Z[q+1]),Pe.maxX=Math.max(Pe.maxX,Z[q]),Pe.maxY=Math.max(Pe.maxY,Z[q+1])}function ai(Pe,Z,q,j){if(!Z.geometry)return;const le=Z.geometry.coordinates;if(le&&le.length===0)return;const ye=Z.geometry.type,_e=Math.pow(q.tolerance/((1<<q.maxZoom)*q.extent),2);let Re=[],be=Z.id;if(q.promoteId?be=Z.properties[q.promoteId]:q.generateId&&(be=j||0),ye==="Point")ei(le,Re);else if(ye==="MultiPoint")for(const $e of le)ei($e,Re);else if(ye==="LineString")Xt(le,Re,_e,!1);else if(ye==="MultiLineString"){if(q.lineMetrics){for(const $e of le)Re=[],Xt($e,Re,_e,!1),Pe.push(Ct(be,"LineString",Re,Z.properties));return}li(le,Re,_e,!1)}else if(ye==="Polygon")li(le,Re,_e,!0);else{if(ye!=="MultiPolygon"){if(ye==="GeometryCollection"){for(const $e of Z.geometry.geometries)ai(Pe,{id:be,geometry:$e,properties:Z.properties},q,j);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const $e of le){const ze=[];li($e,ze,_e,!0),Re.push(ze)}}Pe.push(Ct(be,ye,Re,Z.properties))}function ei(Pe,Z){Z.push(si(Pe[0]),Li(Pe[1]),0)}function Xt(Pe,Z,q,j){let le,ye,_e=0;for(let be=0;be<Pe.length;be++){const $e=si(Pe[be][0]),ze=Li(Pe[be][1]);Z.push($e,ze,0),be>0&&(_e+=j?(le*ze-$e*ye)/2:Math.sqrt(Math.pow($e-le,2)+Math.pow(ze-ye,2))),le=$e,ye=ze}const Re=Z.length-3;Z[2]=1,rt(Z,0,Re,q),Z[Re+2]=1,Z.size=Math.abs(_e),Z.start=0,Z.end=Z.size}function li(Pe,Z,q,j){for(let le=0;le<Pe.length;le++){const ye=[];Xt(Pe[le],ye,q,j),Z.push(ye)}}function si(Pe){return Pe/360+.5}function Li(Pe){const Z=Math.sin(Pe*Math.PI/180),q=.5-.25*Math.log((1+Z)/(1-Z))/Math.PI;return q<0?0:q>1?1:q}function Ti(Pe,Z,q,j,le,ye,_e,Re){if(j/=Z,ye>=(q/=Z)&&_e<j)return Pe;if(_e<q||ye>=j)return null;const be=[];for(const $e of Pe){const ze=$e.geometry;let Ie=$e.type;const Ge=le===0?$e.minX:$e.minY,ht=le===0?$e.maxX:$e.maxY;if(Ge>=q&&ht<j){be.push($e);continue}if(ht<q||Ge>=j)continue;let dt=[];if(Ie==="Point"||Ie==="MultiPoint")Hr(ze,dt,q,j,le);else if(Ie==="LineString")Si(ze,dt,q,j,le,!1,Re.lineMetrics);else if(Ie==="MultiLineString")Gt(ze,dt,q,j,le,!1);else if(Ie==="Polygon")Gt(ze,dt,q,j,le,!0);else if(Ie==="MultiPolygon")for(const Ue of ze){const Ft=[];Gt(Ue,Ft,q,j,le,!0),Ft.length&&dt.push(Ft)}if(dt.length){if(Re.lineMetrics&&Ie==="LineString"){for(const Ue of dt)be.push(Ct($e.id,Ie,Ue,$e.tags));continue}Ie!=="LineString"&&Ie!=="MultiLineString"||(dt.length===1?(Ie="LineString",dt=dt[0]):Ie="MultiLineString"),Ie!=="Point"&&Ie!=="MultiPoint"||(Ie=dt.length===3?"Point":"MultiPoint"),be.push(Ct($e.id,Ie,dt,$e.tags))}}return be.length?be:null}function Hr(Pe,Z,q,j,le){for(let ye=0;ye<Pe.length;ye+=3){const _e=Pe[ye+le];_e>=q&&_e<=j&&Kr(Z,Pe[ye],Pe[ye+1],Pe[ye+2])}}function Si(Pe,Z,q,j,le,ye,_e){let Re=qt(Pe);const be=le===0?Qn:es;let $e,ze,Ie=Pe.start;for(let Ft=0;Ft<Pe.length-3;Ft+=3){const Et=Pe[Ft],Ot=Pe[Ft+1],Kt=Pe[Ft+2],et=Pe[Ft+3],vt=Pe[Ft+4],ct=le===0?Et:Ot,zt=le===0?et:vt;let Mi=!1;_e&&($e=Math.sqrt(Math.pow(Et-et,2)+Math.pow(Ot-vt,2))),ct<q?zt>q&&(ze=be(Re,Et,Ot,et,vt,q),_e&&(Re.start=Ie+$e*ze)):ct>j?zt<j&&(ze=be(Re,Et,Ot,et,vt,j),_e&&(Re.start=Ie+$e*ze)):Kr(Re,Et,Ot,Kt),zt<q&&ct>=q&&(ze=be(Re,Et,Ot,et,vt,q),Mi=!0),zt>j&&ct<=j&&(ze=be(Re,Et,Ot,et,vt,j),Mi=!0),!ye&&Mi&&(_e&&(Re.end=Ie+$e*ze),Z.push(Re),Re=qt(Pe)),_e&&(Ie+=$e)}let Ge=Pe.length-3;const ht=Pe[Ge],dt=Pe[Ge+1],Ue=le===0?ht:dt;Ue>=q&&Ue<=j&&Kr(Re,ht,dt,Pe[Ge+2]),Ge=Re.length-3,ye&&Ge>=3&&(Re[Ge]!==Re[0]||Re[Ge+1]!==Re[1])&&Kr(Re,Re[0],Re[1],Re[2]),Re.length&&Z.push(Re)}function qt(Pe){const Z=[];return Z.size=Pe.size,Z.start=Pe.start,Z.end=Pe.end,Z}function Gt(Pe,Z,q,j,le,ye){for(const _e of Pe)Si(_e,Z,q,j,le,ye,!1)}function Kr(Pe,Z,q,j){Pe.push(Z,q,j)}function Qn(Pe,Z,q,j,le,ye){const _e=(ye-Z)/(j-Z);return Kr(Pe,ye,q+(le-q)*_e,1),_e}function es(Pe,Z,q,j,le,ye){const _e=(ye-q)/(le-q);return Kr(Pe,Z+(j-Z)*_e,ye,1),_e}function Jr(Pe,Z){const q=[];for(let j=0;j<Pe.length;j++){const le=Pe[j],ye=le.type;let _e;if(ye==="Point"||ye==="MultiPoint"||ye==="LineString")_e=Qr(le.geometry,Z);else if(ye==="MultiLineString"||ye==="Polygon"){_e=[];for(const Re of le.geometry)_e.push(Qr(Re,Z))}else if(ye==="MultiPolygon"){_e=[];for(const Re of le.geometry){const be=[];for(const $e of Re)be.push(Qr($e,Z));_e.push(be)}}q.push(Ct(le.id,ye,_e,le.tags))}return q}function Qr(Pe,Z){const q=[];q.size=Pe.size,Pe.start!==void 0&&(q.start=Pe.start,q.end=Pe.end);for(let j=0;j<Pe.length;j+=3)q.push(Pe[j]+Z,Pe[j+1],Pe[j+2]);return q}function to(Pe,Z){if(Pe.transformed)return Pe;const q=1<<Pe.z,j=Pe.x,le=Pe.y;for(const ye of Pe.features){const _e=ye.geometry,Re=ye.type;if(ye.geometry=[],Re===1)for(let be=0;be<_e.length;be+=2)ye.geometry.push(io(_e[be],_e[be+1],Z,q,j,le));else for(let be=0;be<_e.length;be++){const $e=[];for(let ze=0;ze<_e[be].length;ze+=2)$e.push(io(_e[be][ze],_e[be][ze+1],Z,q,j,le));ye.geometry.push($e)}}return Pe.transformed=!0,Pe}function io(Pe,Z,q,j,le,ye){return[Math.round(q*(Pe*j-le)),Math.round(q*(Z*j-ye))]}function ta(Pe,Z,q,j,le){const ye=Z===le.maxZoom?0:le.tolerance/((1<<Z)*le.extent),_e={features:[],numPoints:0,numSimplified:0,numFeatures:Pe.length,source:null,x:q,y:j,z:Z,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Re of Pe)Es(_e,Re,ye,le);return _e}function Es(Pe,Z,q,j){const le=Z.geometry,ye=Z.type,_e=[];if(Pe.minX=Math.min(Pe.minX,Z.minX),Pe.minY=Math.min(Pe.minY,Z.minY),Pe.maxX=Math.max(Pe.maxX,Z.maxX),Pe.maxY=Math.max(Pe.maxY,Z.maxY),ye==="Point"||ye==="MultiPoint")for(let Re=0;Re<le.length;Re+=3)_e.push(le[Re],le[Re+1]),Pe.numPoints++,Pe.numSimplified++;else if(ye==="LineString")ts(_e,le,Pe,q,!1,!1);else if(ye==="MultiLineString"||ye==="Polygon")for(let Re=0;Re<le.length;Re++)ts(_e,le[Re],Pe,q,ye==="Polygon",Re===0);else if(ye==="MultiPolygon")for(let Re=0;Re<le.length;Re++){const be=le[Re];for(let $e=0;$e<be.length;$e++)ts(_e,be[$e],Pe,q,!0,$e===0)}if(_e.length){let Re=Z.tags||null;if(ye==="LineString"&&j.lineMetrics){Re={};for(const $e in Z.tags)Re[$e]=Z.tags[$e];Re.mapbox_clip_start=le.start/le.size,Re.mapbox_clip_end=le.end/le.size}const be={geometry:_e,type:ye==="Polygon"||ye==="MultiPolygon"?3:ye==="LineString"||ye==="MultiLineString"?2:1,tags:Re};Z.id!==null&&(be.id=Z.id),Pe.features.push(be)}}function ts(Pe,Z,q,j,le,ye){const _e=j*j;if(j>0&&Z.size<(le?_e:j))return void(q.numPoints+=Z.length/3);const Re=[];for(let be=0;be<Z.length;be+=3)(j===0||Z[be+2]>_e)&&(q.numSimplified++,Re.push(Z[be],Z[be+1])),q.numPoints++;le&&function(be,$e){let ze=0;for(let Ie=0,Ge=be.length,ht=Ge-2;Ie<Ge;ht=Ie,Ie+=2)ze+=(be[Ie]-be[ht])*(be[Ie+1]+be[ht+1]);if(ze>0===$e)for(let Ie=0,Ge=be.length;Ie<Ge/2;Ie+=2){const ht=be[Ie],dt=be[Ie+1];be[Ie]=be[Ge-2-Ie],be[Ie+1]=be[Ge-1-Ie],be[Ge-2-Ie]=ht,be[Ge-1-Ie]=dt}}(Re,ye),Pe.push(Re)}const ro={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Cn{constructor(Z,q){const j=(q=this.options=function(ye,_e){for(const Re in _e)ye[Re]=_e[Re];return ye}(Object.create(ro),q)).debug;if(j&&console.time("preprocess data"),q.maxZoom<0||q.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(q.promoteId&&q.generateId)throw new Error("promoteId and generateId cannot be used together.");let le=function(ye,_e){const Re=[];if(ye.type==="FeatureCollection")for(let be=0;be<ye.features.length;be++)ai(Re,ye.features[be],_e,be);else ai(Re,ye.type==="Feature"?ye:{geometry:ye},_e);return Re}(Z,q);this.tiles={},this.tileCoords=[],j&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",q.indexMaxZoom,q.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),le=function(ye,_e){const Re=_e.buffer/_e.extent;let be=ye;const $e=Ti(ye,1,-1-Re,Re,0,-1,2,_e),ze=Ti(ye,1,1-Re,2+Re,0,-1,2,_e);return($e||ze)&&(be=Ti(ye,1,-Re,1+Re,0,-1,2,_e)||[],$e&&(be=Jr($e,1).concat(be)),ze&&(be=be.concat(Jr(ze,-1)))),be}(le,q),le.length&&this.splitTile(le,0,0,0),j&&(le.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Z,q,j,le,ye,_e,Re){const be=[Z,q,j,le],$e=this.options,ze=$e.debug;for(;be.length;){le=be.pop(),j=be.pop(),q=be.pop(),Z=be.pop();const Ie=1<<q,Ge=dn(q,j,le);let ht=this.tiles[Ge];if(!ht&&(ze>1&&console.time("creation"),ht=this.tiles[Ge]=ta(Z,q,j,le,$e),this.tileCoords.push({z:q,x:j,y:le}),ze)){ze>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",q,j,le,ht.numFeatures,ht.numPoints,ht.numSimplified),console.timeEnd("creation"));const Mi=`z${q}`;this.stats[Mi]=(this.stats[Mi]||0)+1,this.total++}if(ht.source=Z,ye==null){if(q===$e.indexMaxZoom||ht.numPoints<=$e.indexMaxPoints)continue}else{if(q===$e.maxZoom||q===ye)continue;if(ye!=null){const Mi=ye-q;if(j!==_e>>Mi||le!==Re>>Mi)continue}}if(ht.source=null,Z.length===0)continue;ze>1&&console.time("clipping");const dt=.5*$e.buffer/$e.extent,Ue=.5-dt,Ft=.5+dt,Et=1+dt;let Ot=null,Kt=null,et=null,vt=null,ct=Ti(Z,Ie,j-dt,j+Ft,0,ht.minX,ht.maxX,$e),zt=Ti(Z,Ie,j+Ue,j+Et,0,ht.minX,ht.maxX,$e);Z=null,ct&&(Ot=Ti(ct,Ie,le-dt,le+Ft,1,ht.minY,ht.maxY,$e),Kt=Ti(ct,Ie,le+Ue,le+Et,1,ht.minY,ht.maxY,$e),ct=null),zt&&(et=Ti(zt,Ie,le-dt,le+Ft,1,ht.minY,ht.maxY,$e),vt=Ti(zt,Ie,le+Ue,le+Et,1,ht.minY,ht.maxY,$e),zt=null),ze>1&&console.timeEnd("clipping"),be.push(Ot||[],q+1,2*j,2*le),be.push(Kt||[],q+1,2*j,2*le+1),be.push(et||[],q+1,2*j+1,2*le),be.push(vt||[],q+1,2*j+1,2*le+1)}}getTile(Z,q,j){Z=+Z,q=+q,j=+j;const le=this.options,{extent:ye,debug:_e}=le;if(Z<0||Z>24)return null;const Re=1<<Z,be=dn(Z,q=q+Re&Re-1,j);if(this.tiles[be])return to(this.tiles[be],ye);_e>1&&console.log("drilling down to z%d-%d-%d",Z,q,j);let $e,ze=Z,Ie=q,Ge=j;for(;!$e&&ze>0;)ze--,Ie>>=1,Ge>>=1,$e=this.tiles[dn(ze,Ie,Ge)];return $e&&$e.source?(_e>1&&(console.log("found parent tile z%d-%d-%d",ze,Ie,Ge),console.time("drilling down")),this.splitTile($e.source,ze,Ie,Ge,Z,q,j),_e>1&&console.timeEnd("drilling down"),this.tiles[be]?to(this.tiles[be],ye):null):null}}function dn(Pe,Z,q){return 32*((1<<Pe)*q+Z)+Pe}function Mn(Pe,Z){return Z?Pe.properties[Z]:Pe.id}function no(Pe,Z){if(Pe==null)return!0;if(Pe.type==="Feature")return Mn(Pe,Z)!=null;if(Pe.type==="FeatureCollection"){const q=new Set;for(const j of Pe.features){const le=Mn(j,Z);if(le==null||q.has(le))return!1;q.add(le)}return!0}return!1}function ia(Pe,Z){const q=new Map;if(Pe!=null)if(Pe.type==="Feature")q.set(Mn(Pe,Z),Pe);else for(const j of Pe.features)q.set(Mn(j,Z),j);return q}class Qa extends M{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(Z,q){return f._(this,void 0,void 0,function*(){const j=Z.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const le=this._geoJSONIndex.getTile(j.z,j.x,j.y);if(!le)return null;const ye=new xe(le.features);let _e=yt(ye);return _e.byteOffset===0&&_e.byteLength===_e.buffer.byteLength||(_e=new Uint8Array(_e)),{vectorTile:ye,rawData:_e.buffer}})}loadData(Z){return f._(this,void 0,void 0,function*(){var q;(q=this._pendingRequest)===null||q===void 0||q.abort();const j=!!(Z&&Z.request&&Z.request.collectResourceTiming)&&new f.cA(Z.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(Z,this._pendingRequest),this._geoJSONIndex=Z.cluster?new he(function({superclusterOptions:_e,clusterProperties:Re}){if(!Re||!_e)return _e;const be={},$e={},ze={accumulated:null,zoom:0},Ie={properties:null},Ge=Object.keys(Re);for(const ht of Ge){const[dt,Ue]=Re[ht],Ft=f.cH(Ue),Et=f.cH(typeof dt=="string"?[dt,["accumulated"],["get",ht]]:dt);be[ht]=Ft.value,$e[ht]=Et.value}return _e.map=ht=>{Ie.properties=ht;const dt={};for(const Ue of Ge)dt[Ue]=be[Ue].evaluate(ze,Ie);return dt},_e.reduce=(ht,dt)=>{Ie.properties=dt;for(const Ue of Ge)ze.accumulated=ht[Ue],ht[Ue]=$e[Ue].evaluate(ze,Ie)},_e}(Z)).load((yield this._pendingData).features):(le=yield this._pendingData,new Cn(le,Z.geojsonVtOptions)),this.loaded={};const ye={};if(j){const _e=j.finish();_e&&(ye.resourceTiming={},ye.resourceTiming[Z.source]=JSON.parse(JSON.stringify(_e)))}return ye}catch(ye){if(delete this._pendingRequest,f.cl(ye))return{abandoned:!0};throw ye}var le})}getData(){return f._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(Z){const q=this.loaded;return q&&q[Z.uid]?super.reloadTile(Z):this.loadTile(Z)}loadAndProcessGeoJSON(Z,q){return f._(this,void 0,void 0,function*(){let j=yield this.loadGeoJSON(Z,q);if(delete this._pendingRequest,typeof j!="object")throw new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`);if(pe(j,!0),Z.filter){const le=f.cH(Z.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(le.result==="error")throw new Error(le.value.map(_e=>`${_e.key}: ${_e.message}`).join(", "));j={type:"FeatureCollection",features:j.features.filter(_e=>le.value.evaluate({zoom:0},_e))}}return j})}loadGeoJSON(Z,q){return f._(this,void 0,void 0,function*(){const{promoteId:j}=Z;if(Z.request){const le=yield f.j(Z.request,q);return this._dataUpdateable=no(le.data,j)?ia(le.data,j):void 0,le.data}if(typeof Z.data=="string")try{const le=JSON.parse(Z.data);return this._dataUpdateable=no(le,j)?ia(le,j):void 0,le}catch{throw new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`)}if(!Z.dataDiff)throw new Error(`Input data given to '${Z.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${Z.source}`);return function(le,ye,_e){var Re,be,$e,ze;if(ye.removeAll&&le.clear(),ye.remove)for(const Ie of ye.remove)le.delete(Ie);if(ye.add)for(const Ie of ye.add){const Ge=Mn(Ie,_e);Ge!=null&&le.set(Ge,Ie)}if(ye.update)for(const Ie of ye.update){let Ge=le.get(Ie.id);if(Ge==null)continue;const ht=!Ie.removeAllProperties&&(((Re=Ie.removeProperties)===null||Re===void 0?void 0:Re.length)>0||((be=Ie.addOrUpdateProperties)===null||be===void 0?void 0:be.length)>0);if((Ie.newGeometry||Ie.removeAllProperties||ht)&&(Ge=Object.assign({},Ge),le.set(Ie.id,Ge),ht&&(Ge.properties=Object.assign({},Ge.properties))),Ie.newGeometry&&(Ge.geometry=Ie.newGeometry),Ie.removeAllProperties)Ge.properties={};else if((($e=Ie.removeProperties)===null||$e===void 0?void 0:$e.length)>0)for(const dt of Ie.removeProperties)Object.prototype.hasOwnProperty.call(Ge.properties,dt)&&delete Ge.properties[dt];if(((ze=Ie.addOrUpdateProperties)===null||ze===void 0?void 0:ze.length)>0)for(const{key:dt,value:Ue}of Ie.addOrUpdateProperties)Ge.properties[dt]=Ue}}(this._dataUpdateable,Z.dataDiff,j),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(Z){return f._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(Z){return this._geoJSONIndex.getClusterExpansionZoom(Z.clusterId)}getClusterChildren(Z){return this._geoJSONIndex.getChildren(Z.clusterId)}getClusterLeaves(Z){return this._geoJSONIndex.getLeaves(Z.clusterId,Z.limit,Z.offset)}}class Rn{constructor(Z){this.self=Z,this.actor=new f.H(Z),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(q,j)=>{if(this.externalWorkerSourceTypes[q])throw new Error(`Worker source with name "${q}" already registered.`);this.externalWorkerSourceTypes[q]=j},this.self.addProtocol=f.cn,this.self.removeProtocol=f.co,this.self.registerRTLTextPlugin=q=>{f.cI.setMethods(q)},this.actor.registerMessageHandler("LDT",(q,j)=>this._getDEMWorkerSource(q,j.source).loadTile(j)),this.actor.registerMessageHandler("RDT",(q,j)=>f._(this,void 0,void 0,function*(){this._getDEMWorkerSource(q,j.source).removeTile(j)})),this.actor.registerMessageHandler("GCEZ",(q,j)=>f._(this,void 0,void 0,function*(){return this._getWorkerSource(q,j.type,j.source).getClusterExpansionZoom(j)})),this.actor.registerMessageHandler("GCC",(q,j)=>f._(this,void 0,void 0,function*(){return this._getWorkerSource(q,j.type,j.source).getClusterChildren(j)})),this.actor.registerMessageHandler("GCL",(q,j)=>f._(this,void 0,void 0,function*(){return this._getWorkerSource(q,j.type,j.source).getClusterLeaves(j)})),this.actor.registerMessageHandler("LD",(q,j)=>this._getWorkerSource(q,j.type,j.source).loadData(j)),this.actor.registerMessageHandler("GD",(q,j)=>this._getWorkerSource(q,j.type,j.source).getData()),this.actor.registerMessageHandler("LT",(q,j)=>this._getWorkerSource(q,j.type,j.source).loadTile(j)),this.actor.registerMessageHandler("RT",(q,j)=>this._getWorkerSource(q,j.type,j.source).reloadTile(j)),this.actor.registerMessageHandler("AT",(q,j)=>this._getWorkerSource(q,j.type,j.source).abortTile(j)),this.actor.registerMessageHandler("RMT",(q,j)=>this._getWorkerSource(q,j.type,j.source).removeTile(j)),this.actor.registerMessageHandler("RS",(q,j)=>f._(this,void 0,void 0,function*(){if(!this.workerSources[q]||!this.workerSources[q][j.type]||!this.workerSources[q][j.type][j.source])return;const le=this.workerSources[q][j.type][j.source];delete this.workerSources[q][j.type][j.source],le.removeSource!==void 0&&le.removeSource(j)})),this.actor.registerMessageHandler("RM",q=>f._(this,void 0,void 0,function*(){delete this.layerIndexes[q],delete this.availableImages[q],delete this.workerSources[q],delete this.demWorkerSources[q]})),this.actor.registerMessageHandler("SR",(q,j)=>f._(this,void 0,void 0,function*(){this.referrer=j})),this.actor.registerMessageHandler("SRPS",(q,j)=>this._syncRTLPluginState(q,j)),this.actor.registerMessageHandler("IS",(q,j)=>f._(this,void 0,void 0,function*(){this.self.importScripts(j)})),this.actor.registerMessageHandler("SI",(q,j)=>this._setImages(q,j)),this.actor.registerMessageHandler("UL",(q,j)=>f._(this,void 0,void 0,function*(){this._getLayerIndex(q).update(j.layers,j.removedIds)})),this.actor.registerMessageHandler("SL",(q,j)=>f._(this,void 0,void 0,function*(){this._getLayerIndex(q).replace(j)}))}_setImages(Z,q){return f._(this,void 0,void 0,function*(){this.availableImages[Z]=q;for(const j in this.workerSources[Z]){const le=this.workerSources[Z][j];for(const ye in le)le[ye].availableImages=q}})}_syncRTLPluginState(Z,q){return f._(this,void 0,void 0,function*(){return yield f.cI.syncState(q,this.self.importScripts)})}_getAvailableImages(Z){let q=this.availableImages[Z];return q||(q=[]),q}_getLayerIndex(Z){let q=this.layerIndexes[Z];return q||(q=this.layerIndexes[Z]=new a),q}_getWorkerSource(Z,q,j){if(this.workerSources[Z]||(this.workerSources[Z]={}),this.workerSources[Z][q]||(this.workerSources[Z][q]={}),!this.workerSources[Z][q][j]){const le={sendAsync:(ye,_e)=>(ye.targetMapId=Z,this.actor.sendAsync(ye,_e))};switch(q){case"vector":this.workerSources[Z][q][j]=new M(le,this._getLayerIndex(Z),this._getAvailableImages(Z));break;case"geojson":this.workerSources[Z][q][j]=new Qa(le,this._getLayerIndex(Z),this._getAvailableImages(Z));break;default:this.workerSources[Z][q][j]=new this.externalWorkerSourceTypes[q](le,this._getLayerIndex(Z),this._getAvailableImages(Z))}}return this.workerSources[Z][q][j]}_getDEMWorkerSource(Z,q){return this.demWorkerSources[Z]||(this.demWorkerSources[Z]={}),this.demWorkerSources[Z][q]||(this.demWorkerSources[Z][q]=new F),this.demWorkerSources[Z][q]}}return f.i(self)&&(self.worker=new Rn(self)),Rn}),o("index",["exports","./shared"],function(f,a){var y="5.3.0";function T(){var _=new a.A(4);return a.A!=Float32Array&&(_[1]=0,_[2]=0),_[0]=1,_[3]=1,_}let A,M;const F={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(_,n,l){const p=requestAnimationFrame(x=>{g(),n(x)}),{unsubscribe:g}=a.s(_.signal,"abort",()=>{g(),cancelAnimationFrame(p),l(a.c())},!1)},frameAsync(_){return new Promise((n,l)=>{this.frame(_,n,l)})},getImageData(_,n=0){return this.getImageCanvasContext(_).getImageData(-n,-n,_.width+2*n,_.height+2*n)},getImageCanvasContext(_){const n=window.document.createElement("canvas"),l=n.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return n.width=_.width,n.height=_.height,l.drawImage(_,0,0,_.width,_.height),l},resolveURL:_=>(A||(A=document.createElement("a")),A.href=_,A.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(M==null&&(M=matchMedia("(prefers-reduced-motion: reduce)")),M.matches)}};class L{static testProp(n){if(!L.docStyle)return n[0];for(let l=0;l<n.length;l++)if(n[l]in L.docStyle)return n[l];return n[0]}static create(n,l,p){const g=window.document.createElement(n);return l!==void 0&&(g.className=l),p&&p.appendChild(g),g}static createNS(n,l){return window.document.createElementNS(n,l)}static disableDrag(){L.docStyle&&L.selectProp&&(L.userSelect=L.docStyle[L.selectProp],L.docStyle[L.selectProp]="none")}static enableDrag(){L.docStyle&&L.selectProp&&(L.docStyle[L.selectProp]=L.userSelect)}static setTransform(n,l){n.style[L.transformProp]=l}static addEventListener(n,l,p,g={}){n.addEventListener(l,p,"passive"in g?g:g.capture)}static removeEventListener(n,l,p,g={}){n.removeEventListener(l,p,"passive"in g?g:g.capture)}static suppressClickInternal(n){n.preventDefault(),n.stopPropagation(),window.removeEventListener("click",L.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",L.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",L.suppressClickInternal,!0)},0)}static getScale(n){const l=n.getBoundingClientRect();return{x:l.width/n.offsetWidth||1,y:l.height/n.offsetHeight||1,boundingClientRect:l}}static getPoint(n,l,p){const g=l.boundingClientRect;return new a.P((p.clientX-g.left)/l.x-n.clientLeft,(p.clientY-g.top)/l.y-n.clientTop)}static mousePos(n,l){const p=L.getScale(n);return L.getPoint(n,p,l)}static touchPos(n,l){const p=[],g=L.getScale(n);for(let x=0;x<l.length;x++)p.push(L.getPoint(n,g,l[x]));return p}static mouseButton(n){return n.button}static remove(n){n.parentNode&&n.parentNode.removeChild(n)}static sanitize(n){const l=new DOMParser().parseFromString(n,"text/html").body||document.createElement("body"),p=l.querySelectorAll("script");for(const g of p)g.remove();return L.clean(l),l.innerHTML}static isPossiblyDangerous(n,l){const p=l.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(n)||!p.includes("javascript:")&&!p.includes("data:"))||!!n.startsWith("on")||void 0}static clean(n){const l=n.children;for(const p of l)L.removeAttributes(p),L.clean(p)}static removeAttributes(n){for(const{name:l,value:p}of n.attributes)L.isPossiblyDangerous(l,p)&&n.removeAttribute(l)}}L.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,L.selectProp=L.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),L.transformProp=L.testProp(["transform","WebkitTransform"]);const Y={supported:!1,testSupport:function(_){!Ee&&pe&&(Be?xe(_):ae=_)}};let ae,pe,Ee=!1,Be=!1;function xe(_){const n=_.createTexture();_.bindTexture(_.TEXTURE_2D,n);try{if(_.texImage2D(_.TEXTURE_2D,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,pe),_.isContextLost())return;Y.supported=!0}catch{}_.deleteTexture(n),Ee=!0}var Ce;typeof document<"u"&&(pe=document.createElement("img"),pe.onload=()=>{ae&&xe(ae),ae=null,Be=!0},pe.onerror=()=>{Ee=!0,ae=null},pe.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(_){let n,l,p,g;_.resetRequestQueue=()=>{n=[],l=0,p=0,g={}},_.addThrottleControl=I=>{const R=p++;return g[R]=I,R},_.removeThrottleControl=I=>{delete g[I],w()},_.getImage=(I,R,O=!0)=>new Promise((N,B)=>{Y.supported&&(I.headers||(I.headers={}),I.headers.accept="image/webp,*/*"),a.e(I,{type:"image"}),n.push({abortController:R,requestParameters:I,supportImageRefresh:O,state:"queued",onError:W=>{B(W)},onSuccess:W=>{N(W)}}),w()});const x=I=>a._(this,void 0,void 0,function*(){I.state="running";const{requestParameters:R,supportImageRefresh:O,onError:N,onSuccess:B,abortController:W}=I,X=O===!1&&!a.i(self)&&!a.g(R.url)&&(!R.headers||Object.keys(R.headers).reduce((ie,se)=>ie&&se==="accept",!0));l++;const te=X?P(R,W):a.m(R,W);try{const ie=yield te;delete I.abortController,I.state="completed",ie.data instanceof HTMLImageElement||a.b(ie.data)?B(ie):ie.data&&B({data:yield(Q=ie.data,typeof createImageBitmap=="function"?a.f(Q):a.h(Q)),cacheControl:ie.cacheControl,expires:ie.expires})}catch(ie){delete I.abortController,N(ie)}finally{l--,w()}var Q}),w=()=>{const I=(()=>{for(const R of Object.keys(g))if(g[R]())return!0;return!1})()?a.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:a.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let R=l;R<I&&n.length>0;R++){const O=n.shift();O.abortController.signal.aborted?R--:x(O)}},P=(I,R)=>new Promise((O,N)=>{const B=new Image,W=I.url,X=I.credentials;X&&X==="include"?B.crossOrigin="use-credentials":(X&&X==="same-origin"||!a.d(W))&&(B.crossOrigin="anonymous"),R.signal.addEventListener("abort",()=>{B.src="",N(a.c())}),B.fetchPriority="high",B.onload=()=>{B.onerror=B.onload=null,O({data:B})},B.onerror=()=>{B.onerror=B.onload=null,R.signal.aborted||N(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},B.src=W})}(Ce||(Ce={})),Ce.resetRequestQueue();class tt{constructor(n){this._transformRequestFn=n}transformRequest(n,l){return this._transformRequestFn&&this._transformRequestFn(n,l)||{url:n}}setTransformRequest(n){this._transformRequestFn=n}}function Xe(_){const n=[];if(typeof _=="string")n.push({id:"default",url:_});else if(_&&_.length>0){const l=[];for(const{id:p,url:g}of _){const x=`${p}${g}`;l.indexOf(x)===-1&&(l.push(x),n.push({id:p,url:g}))}}return n}function gt(_,n,l){try{const p=new URL(_);return p.pathname+=`${n}${l}`,p.toString()}catch{throw new Error(`Invalid sprite URL "${_}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}class ft{constructor(n,l,p,g){this.context=n,this.format=p,this.texture=n.gl.createTexture(),this.update(l,g)}update(n,l,p){const{width:g,height:x}=n,w=!(this.size&&this.size[0]===g&&this.size[1]===x||p),{context:P}=this,{gl:I}=P;if(this.useMipmap=!!(l&&l.useMipmap),I.bindTexture(I.TEXTURE_2D,this.texture),P.pixelStoreUnpackFlipY.set(!1),P.pixelStoreUnpack.set(1),P.pixelStoreUnpackPremultiplyAlpha.set(this.format===I.RGBA&&(!l||l.premultiply!==!1)),w)this.size=[g,x],n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||a.b(n)?I.texImage2D(I.TEXTURE_2D,0,this.format,this.format,I.UNSIGNED_BYTE,n):I.texImage2D(I.TEXTURE_2D,0,this.format,g,x,0,this.format,I.UNSIGNED_BYTE,n.data);else{const{x:R,y:O}=p||{x:0,y:0};n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||a.b(n)?I.texSubImage2D(I.TEXTURE_2D,0,R,O,I.RGBA,I.UNSIGNED_BYTE,n):I.texSubImage2D(I.TEXTURE_2D,0,R,O,g,x,I.RGBA,I.UNSIGNED_BYTE,n.data)}this.useMipmap&&this.isSizePowerOfTwo()&&I.generateMipmap(I.TEXTURE_2D)}bind(n,l,p){const{context:g}=this,{gl:x}=g;x.bindTexture(x.TEXTURE_2D,this.texture),p!==x.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(p=x.LINEAR),n!==this.filter&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,n),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,p||n),this.filter=n),l!==this.wrap&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,l),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,l),this.wrap=l)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}}function yt(_){const{userImage:n}=_;return!!(n&&n.render&&n.render())&&(_.data.replace(new Uint8Array(n.data.buffer)),!0)}class Bt extends a.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new a.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(n){if(this.loaded!==n&&(this.loaded=n,n)){for(const{ids:l,promiseResolve:p}of this.requestors)p(this._getImagesForIds(l));this.requestors=[]}}getImage(n){const l=this.images[n];if(l&&!l.data&&l.spriteData){const p=l.spriteData;l.data=new a.R({width:p.width,height:p.height},p.context.getImageData(p.x,p.y,p.width,p.height).data),l.spriteData=null}return l}addImage(n,l){if(this.images[n])throw new Error(`Image id ${n} already exist, use updateImage instead`);this._validate(n,l)&&(this.images[n]=l)}_validate(n,l){let p=!0;const g=l.data||l.spriteData;return this._validateStretch(l.stretchX,g&&g.width)||(this.fire(new a.k(new Error(`Image "${n}" has invalid "stretchX" value`))),p=!1),this._validateStretch(l.stretchY,g&&g.height)||(this.fire(new a.k(new Error(`Image "${n}" has invalid "stretchY" value`))),p=!1),this._validateContent(l.content,l)||(this.fire(new a.k(new Error(`Image "${n}" has invalid "content" value`))),p=!1),p}_validateStretch(n,l){if(!n)return!0;let p=0;for(const g of n){if(g[0]<p||g[1]<g[0]||l<g[1])return!1;p=g[1]}return!0}_validateContent(n,l){if(!n)return!0;if(n.length!==4)return!1;const p=l.spriteData,g=p&&p.width||l.data.width,x=p&&p.height||l.data.height;return!(n[0]<0||g<n[0]||n[1]<0||x<n[1]||n[2]<0||g<n[2]||n[3]<0||x<n[3]||n[2]<n[0]||n[3]<n[1])}updateImage(n,l,p=!0){const g=this.getImage(n);if(p&&(g.data.width!==l.data.width||g.data.height!==l.data.height))throw new Error(`size mismatch between old image (${g.data.width}x${g.data.height}) and new image (${l.data.width}x${l.data.height}).`);l.version=g.version+1,this.images[n]=l,this.updatedImages[n]=!0}removeImage(n){const l=this.images[n];delete this.images[n],delete this.patterns[n],l.userImage&&l.userImage.onRemove&&l.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(n){return new Promise((l,p)=>{let g=!0;if(!this.isLoaded())for(const x of n)this.images[x]||(g=!1);this.isLoaded()||g?l(this._getImagesForIds(n)):this.requestors.push({ids:n,promiseResolve:l})})}_getImagesForIds(n){const l={};for(const p of n){let g=this.getImage(p);g||(this.fire(new a.l("styleimagemissing",{id:p})),g=this.getImage(p)),g?l[p]={data:g.data.clone(),pixelRatio:g.pixelRatio,sdf:g.sdf,version:g.version,stretchX:g.stretchX,stretchY:g.stretchY,content:g.content,textFitWidth:g.textFitWidth,textFitHeight:g.textFitHeight,hasRenderCallback:!!(g.userImage&&g.userImage.render)}:a.w(`Image "${p}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return l}getPixelSize(){const{width:n,height:l}=this.atlasImage;return{width:n,height:l}}getPattern(n){const l=this.patterns[n],p=this.getImage(n);if(!p)return null;if(l&&l.position.version===p.version)return l.position;if(l)l.position.version=p.version;else{const g={w:p.data.width+2,h:p.data.height+2,x:0,y:0},x=new a.I(g,p);this.patterns[n]={bin:g,position:x}}return this._updatePatternAtlas(),this.patterns[n].position}bind(n){const l=n.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new ft(n,this.atlasImage,l.RGBA),this.atlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE)}_updatePatternAtlas(){const n=[];for(const x in this.patterns)n.push(this.patterns[x].bin);const{w:l,h:p}=a.p(n),g=this.atlasImage;g.resize({width:l||1,height:p||1});for(const x in this.patterns){const{bin:w}=this.patterns[x],P=w.x+1,I=w.y+1,R=this.getImage(x).data,O=R.width,N=R.height;a.R.copy(R,g,{x:0,y:0},{x:P,y:I},{width:O,height:N}),a.R.copy(R,g,{x:0,y:N-1},{x:P,y:I-1},{width:O,height:1}),a.R.copy(R,g,{x:0,y:0},{x:P,y:I+N},{width:O,height:1}),a.R.copy(R,g,{x:O-1,y:0},{x:P-1,y:I},{width:1,height:N}),a.R.copy(R,g,{x:0,y:0},{x:P+O,y:I},{width:1,height:N})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(n){for(const l of n){if(this.callbackDispatchedThisFrame[l])continue;this.callbackDispatchedThisFrame[l]=!0;const p=this.getImage(l);p||a.w(`Image with ID: "${l}" was not found`),yt(p)&&this.updateImage(l,p)}}}const Pt=1e20;function Lt(_,n,l,p,g,x,w,P,I){for(let R=n;R<n+p;R++)Dt(_,l*x+R,x,g,w,P,I);for(let R=l;R<l+g;R++)Dt(_,R*x+n,1,p,w,P,I)}function Dt(_,n,l,p,g,x,w){x[0]=0,w[0]=-1e20,w[1]=Pt,g[0]=_[n];for(let P=1,I=0,R=0;P<p;P++){g[P]=_[n+P*l];const O=P*P;do{const N=x[I];R=(g[P]-g[N]+O-N*N)/(P-N)/2}while(R<=w[I]&&--I>-1);I++,x[I]=P,w[I]=R,w[I+1]=Pt}for(let P=0,I=0;P<p;P++){for(;w[I+1]<P;)I++;const R=x[I],O=P-R;_[n+P*l]=g[R]+O*O}}class kt{constructor(n,l){this.requestManager=n,this.localIdeographFontFamily=l,this.entries={}}setURL(n){this.url=n}getGlyphs(n){return a._(this,void 0,void 0,function*(){const l=[];for(const x in n)for(const w of n[x])l.push(this._getAndCacheGlyphsPromise(x,w));const p=yield Promise.all(l),g={};for(const{stack:x,id:w,glyph:P}of p)g[x]||(g[x]={}),g[x][w]=P&&{id:P.id,bitmap:P.bitmap.clone(),metrics:P.metrics};return g})}_getAndCacheGlyphsPromise(n,l){return a._(this,void 0,void 0,function*(){let p=this.entries[n];p||(p=this.entries[n]={glyphs:{},requests:{},ranges:{}});let g=p.glyphs[l];if(g!==void 0)return{stack:n,id:l,glyph:g};if(g=this._tinySDF(p,n,l),g)return p.glyphs[l]=g,{stack:n,id:l,glyph:g};const x=Math.floor(l/256);if(256*x>65535)throw new Error("glyphs > 65535 not supported");if(p.ranges[x])return{stack:n,id:l,glyph:g};if(!this.url)throw new Error("glyphsUrl is not set");if(!p.requests[x]){const P=kt.loadGlyphRange(n,x,this.url,this.requestManager);p.requests[x]=P}const w=yield p.requests[x];for(const P in w)this._doesCharSupportLocalGlyph(+P)||(p.glyphs[+P]=w[+P]);return p.ranges[x]=!0,{stack:n,id:l,glyph:w[l]||null}})}_doesCharSupportLocalGlyph(n){return!!this.localIdeographFontFamily&&(new RegExp("\\p{Ideo}|\\p{sc=Hang}|\\p{sc=Hira}|\\p{sc=Kana}","u").test(String.fromCodePoint(n))||a.u["CJK Unified Ideographs"](n)||a.u["Hangul Syllables"](n)||a.u.Hiragana(n)||a.u.Katakana(n)||a.u["CJK Symbols and Punctuation"](n)||a.u["Halfwidth and Fullwidth Forms"](n))}_tinySDF(n,l,p){const g=this.localIdeographFontFamily;if(!g||!this._doesCharSupportLocalGlyph(p))return;let x=n.tinySDF;if(!x){let P="400";/bold/i.test(l)?P="900":/medium/i.test(l)?P="500":/light/i.test(l)&&(P="200"),x=n.tinySDF=new kt.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:g,fontWeight:P})}const w=x.draw(String.fromCharCode(p));return{id:p,bitmap:new a.q({width:w.width||60,height:w.height||60},w.data),metrics:{width:w.glyphWidth/2||24,height:w.glyphHeight/2||24,left:w.glyphLeft/2+.5||0,top:w.glyphTop/2-27.5||-8,advance:w.glyphAdvance/2||24,isDoubleResolution:!0}}}}kt.loadGlyphRange=function(_,n,l,p){return a._(this,void 0,void 0,function*(){const g=256*n,x=g+255,w=p.transformRequest(l.replace("{fontstack}",_).replace("{range}",`${g}-${x}`),"Glyphs"),P=yield a.n(w,new AbortController);if(!P||!P.data)throw new Error(`Could not load glyph range. range: ${n}, ${g}-${x}`);const I={};for(const R of a.o(P.data))I[R.id]=R;return I})},kt.TinySDF=class{constructor({fontSize:_=24,buffer:n=3,radius:l=8,cutoff:p=.25,fontFamily:g="sans-serif",fontWeight:x="normal",fontStyle:w="normal"}={}){this.buffer=n,this.cutoff=p,this.radius=l;const P=this.size=_+4*n,I=this._createCanvas(P),R=this.ctx=I.getContext("2d",{willReadFrequently:!0});R.font=`${w} ${x} ${_}px ${g}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(P*P),this.gridInner=new Float64Array(P*P),this.f=new Float64Array(P),this.z=new Float64Array(P+1),this.v=new Uint16Array(P)}_createCanvas(_){const n=document.createElement("canvas");return n.width=n.height=_,n}draw(_){const{width:n,actualBoundingBoxAscent:l,actualBoundingBoxDescent:p,actualBoundingBoxLeft:g,actualBoundingBoxRight:x}=this.ctx.measureText(_),w=Math.ceil(l),P=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(x-g))),I=Math.min(this.size-this.buffer,w+Math.ceil(p)),R=P+2*this.buffer,O=I+2*this.buffer,N=Math.max(R*O,0),B=new Uint8ClampedArray(N),W={data:B,width:R,height:O,glyphWidth:P,glyphHeight:I,glyphTop:w,glyphLeft:0,glyphAdvance:n};if(P===0||I===0)return W;const{ctx:X,buffer:te,gridInner:Q,gridOuter:ie}=this;X.clearRect(te,te,P,I),X.fillText(_,te,te+w);const se=X.getImageData(te,te,P,I);ie.fill(Pt,0,N),Q.fill(0,0,N);for(let ue=0;ue<I;ue++)for(let fe=0;fe<P;fe++){const de=se.data[4*(ue*P+fe)+3]/255;if(de===0)continue;const ve=(ue+te)*R+fe+te;if(de===1)ie[ve]=0,Q[ve]=Pt;else{const ge=.5-de;ie[ve]=ge>0?ge*ge:0,Q[ve]=ge<0?ge*ge:0}}Lt(ie,0,0,R,O,R,this.f,this.v,this.z),Lt(Q,te,te,P,I,R,this.f,this.v,this.z);for(let ue=0;ue<N;ue++){const fe=Math.sqrt(ie[ue])-Math.sqrt(Q[ue]);B[ue]=Math.round(255-255*(fe/this.radius+this.cutoff))}return W}};class ji{constructor(){this.specification=a.v.light.position}possiblyEvaluate(n,l){return a.z(n.expression.evaluate(l))}interpolate(n,l,p){return{x:a.B.number(n.x,l.x,p),y:a.B.number(n.y,l.y,p),z:a.B.number(n.z,l.z,p)}}}let he;class Le extends a.E{constructor(n){super(),he=he||new a.r({anchor:new a.D(a.v.light.anchor),position:new ji,color:new a.D(a.v.light.color),intensity:new a.D(a.v.light.intensity)}),this._transitionable=new a.T(he),this.setLight(n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(n,l={}){if(!this._validate(a.t,n,l))for(const p in n){const g=n[p];p.endsWith("-transition")?this._transitionable.setTransition(p.slice(0,-11),g):this._transitionable.setValue(p,g)}}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,l,p){return(!p||p.validate!==!1)&&a.x(this,n.call(a.y,{value:l,style:{glyphs:!0,sprite:!0},styleSpec:a.v}))}}const we=new a.r({"sky-color":new a.D(a.v.sky["sky-color"]),"horizon-color":new a.D(a.v.sky["horizon-color"]),"fog-color":new a.D(a.v.sky["fog-color"]),"fog-ground-blend":new a.D(a.v.sky["fog-ground-blend"]),"horizon-fog-blend":new a.D(a.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new a.D(a.v.sky["sky-horizon-blend"]),"atmosphere-blend":new a.D(a.v.sky["atmosphere-blend"])});class Ke extends a.E{constructor(n){super(),this._transitionable=new a.T(we),this.setSky(n),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new a.C(0))}setSky(n,l={}){if(!this._validate(a.F,n,l)){n||(n={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const p in n){const g=n[p];p.endsWith("-transition")?this._transitionable.setTransition(p.slice(0,-11),g):this._transitionable.setValue(p,g)}}}getSky(){return this._transitionable.serialize()}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,l,p={}){return(p==null?void 0:p.validate)!==!1&&a.x(this,n.call(a.y,a.e({value:l,style:{glyphs:!0,sprite:!0},styleSpec:a.v})))}calculateFogBlendOpacity(n){return n<60?0:n<70?(n-60)/10:1}}class Qe{constructor(n,l){this.width=n,this.height=l,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(n,l){const p=n.join(",")+String(l);return this.dashEntry[p]||(this.dashEntry[p]=this.addDash(n,l)),this.dashEntry[p]}getDashRanges(n,l,p){const g=[];let x=n.length%2==1?-n[n.length-1]*p:0,w=n[0]*p,P=!0;g.push({left:x,right:w,isDash:P,zeroLength:n[0]===0});let I=n[0];for(let R=1;R<n.length;R++){P=!P;const O=n[R];x=I*p,I+=O,w=I*p,g.push({left:x,right:w,isDash:P,zeroLength:O===0})}return g}addRoundDash(n,l,p){const g=l/2;for(let x=-p;x<=p;x++){const w=this.width*(this.nextRow+p+x);let P=0,I=n[P];for(let R=0;R<this.width;R++){R/I.right>1&&(I=n[++P]);const O=Math.abs(R-I.left),N=Math.abs(R-I.right),B=Math.min(O,N);let W;const X=x/p*(g+1);if(I.isDash){const te=g-Math.abs(X);W=Math.sqrt(B*B+te*te)}else W=g-Math.sqrt(B*B+X*X);this.data[w+R]=Math.max(0,Math.min(255,W+128))}}}addRegularDash(n){for(let P=n.length-1;P>=0;--P){const I=n[P],R=n[P+1];I.zeroLength?n.splice(P,1):R&&R.isDash===I.isDash&&(R.left=I.left,n.splice(P,1))}const l=n[0],p=n[n.length-1];l.isDash===p.isDash&&(l.left=p.left-this.width,p.right=l.right+this.width);const g=this.width*this.nextRow;let x=0,w=n[x];for(let P=0;P<this.width;P++){P/w.right>1&&(w=n[++x]);const I=Math.abs(P-w.left),R=Math.abs(P-w.right),O=Math.min(I,R);this.data[g+P]=Math.max(0,Math.min(255,(w.isDash?O:-O)+128))}}addDash(n,l){const p=l?7:0,g=2*p+1;if(this.nextRow+g>this.height)return a.w("LineAtlas out of space"),null;let x=0;for(let P=0;P<n.length;P++)x+=n[P];if(x!==0){const P=this.width/x,I=this.getDashRanges(n,this.width,P);l?this.addRoundDash(I,P,p):this.addRegularDash(I)}const w={y:(this.nextRow+p+.5)/this.height,height:2*p/this.height,width:x};return this.nextRow+=g,this.dirty=!0,w}bind(n){const l=n.gl;this.texture?(l.bindTexture(l.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,l.texSubImage2D(l.TEXTURE_2D,0,0,0,this.width,this.height,l.ALPHA,l.UNSIGNED_BYTE,this.data))):(this.texture=l.createTexture(),l.bindTexture(l.TEXTURE_2D,this.texture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.REPEAT),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.REPEAT),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texImage2D(l.TEXTURE_2D,0,l.ALPHA,this.width,this.height,0,l.ALPHA,l.UNSIGNED_BYTE,this.data))}}const st="maplibre_preloaded_worker_pool";class rt{constructor(){this.active={}}acquire(n){if(!this.workers)for(this.workers=[];this.workers.length<rt.workerCount;)this.workers.push(new Worker(a.a.WORKER_URL));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.numActive()===0&&(this.workers.forEach(l=>{l.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[st]}numActive(){return Object.keys(this.active).length}}const pt=Math.floor(F.hardwareConcurrency/2);let Ct,Tt;function ai(){return Ct||(Ct=new rt),Ct}rt.workerCount=a.G(globalThis)?Math.max(Math.min(pt,3),1):1;class ei{constructor(n,l){this.workerPool=n,this.actors=[],this.currentActor=0,this.id=l;const p=this.workerPool.acquire(l);for(let g=0;g<p.length;g++){const x=new a.H(p[g],l);x.name=`Worker ${g}`,this.actors.push(x)}if(!this.actors.length)throw new Error("No actors found")}broadcast(n,l){const p=[];for(const g of this.actors)p.push(g.sendAsync({type:n,data:l}));return Promise.all(p)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(n=!0){this.actors.forEach(l=>{l.remove()}),this.actors=[],n&&this.workerPool.release(this.id)}registerMessageHandler(n,l){for(const p of this.actors)p.registerMessageHandler(n,l)}}function Xt(){return Tt||(Tt=new ei(ai(),a.J),Tt.registerMessageHandler("GR",(_,n,l)=>a.m(n,l))),Tt}function li(_,n){const l=a.K();return a.L(l,l,[1,1,0]),a.M(l,l,[.5*_.width,.5*_.height,1]),_.calculatePosMatrix?a.N(l,l,_.calculatePosMatrix(n.toUnwrapped())):l}function si(_,n,l,p,g,x,w){var P;const I=function(B,W,X){if(B)for(const te of B){const Q=W[te];if(Q&&Q.source===X&&Q.type==="fill-extrusion")return!0}else for(const te in W){const Q=W[te];if(Q.source===X&&Q.type==="fill-extrusion")return!0}return!1}((P=g==null?void 0:g.layers)!==null&&P!==void 0?P:null,n,_.id),R=x.maxPitchScaleFactor(),O=_.tilesIn(p,R,I);O.sort(Li);const N=[];for(const B of O)N.push({wrappedTileID:B.tileID.wrapped().key,queryResults:B.tile.queryRenderedFeatures(n,l,_._state,B.queryGeometry,B.cameraQueryGeometry,B.scale,g,x,R,li(_.transform,B.tileID),w?(W,X)=>w(B.tileID,W,X):void 0)});return function(B,W){for(const X in B)for(const te of B[X])Ti(te,W);return B}(function(B){const W={},X={};for(const te of B){const Q=te.queryResults,ie=te.wrappedTileID,se=X[ie]=X[ie]||{};for(const ue in Q){const fe=Q[ue],de=se[ue]=se[ue]||{},ve=W[ue]=W[ue]||[];for(const ge of fe)de[ge.featureIndex]||(de[ge.featureIndex]=!0,ve.push(ge))}}return W}(N),_)}function Li(_,n){const l=_.tileID,p=n.tileID;return l.overscaledZ-p.overscaledZ||l.canonical.y-p.canonical.y||l.wrap-p.wrap||l.canonical.x-p.canonical.x}function Ti(_,n){const l=_.feature,p=n.getFeatureState(l.layer["source-layer"],l.id);l.source=l.layer.source,l.layer["source-layer"]&&(l.sourceLayer=l.layer["source-layer"]),l.state=p}function Hr(_,n,l){return a._(this,void 0,void 0,function*(){let p=_;if(_.url?p=(yield a.j(n.transformRequest(_.url,"Source"),l)).data:yield F.frameAsync(l),!p)return null;const g=a.O(a.e(p,_),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in p&&p.vector_layers&&(g.vectorLayerIds=p.vector_layers.map(x=>x.id)),g})}class Si{constructor(n,l){n&&(l?this.setSouthWest(n).setNorthEast(l):Array.isArray(n)&&(n.length===4?this.setSouthWest([n[0],n[1]]).setNorthEast([n[2],n[3]]):this.setSouthWest(n[0]).setNorthEast(n[1])))}setNorthEast(n){return this._ne=n instanceof a.Q?new a.Q(n.lng,n.lat):a.Q.convert(n),this}setSouthWest(n){return this._sw=n instanceof a.Q?new a.Q(n.lng,n.lat):a.Q.convert(n),this}extend(n){const l=this._sw,p=this._ne;let g,x;if(n instanceof a.Q)g=n,x=n;else{if(!(n instanceof Si))return Array.isArray(n)?n.length===4||n.every(Array.isArray)?this.extend(Si.convert(n)):this.extend(a.Q.convert(n)):n&&("lng"in n||"lon"in n)&&"lat"in n?this.extend(a.Q.convert(n)):this;if(g=n._sw,x=n._ne,!g||!x)return this}return l||p?(l.lng=Math.min(g.lng,l.lng),l.lat=Math.min(g.lat,l.lat),p.lng=Math.max(x.lng,p.lng),p.lat=Math.max(x.lat,p.lat)):(this._sw=new a.Q(g.lng,g.lat),this._ne=new a.Q(x.lng,x.lat)),this}getCenter(){return new a.Q((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new a.Q(this.getWest(),this.getNorth())}getSouthEast(){return new a.Q(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(n){const{lng:l,lat:p}=a.Q.convert(n);let g=this._sw.lng<=l&&l<=this._ne.lng;return this._sw.lng>this._ne.lng&&(g=this._sw.lng>=l&&l>=this._ne.lng),this._sw.lat<=p&&p<=this._ne.lat&&g}static convert(n){return n instanceof Si?n:n&&new Si(n)}static fromLngLat(n,l=0){const p=360*l/40075017,g=p/Math.cos(Math.PI/180*n.lat);return new Si(new a.Q(n.lng-g,n.lat-p),new a.Q(n.lng+g,n.lat+p))}adjustAntiMeridian(){const n=new a.Q(this._sw.lng,this._sw.lat),l=new a.Q(this._ne.lng,this._ne.lat);return new Si(n,n.lng>l.lng?new a.Q(l.lng+360,l.lat):l)}}class qt{constructor(n,l,p){this.bounds=Si.convert(this.validateBounds(n)),this.minzoom=l||0,this.maxzoom=p||24}validateBounds(n){return Array.isArray(n)&&n.length===4?[Math.max(-180,n[0]),Math.max(-90,n[1]),Math.min(180,n[2]),Math.min(90,n[3])]:[-180,-90,180,90]}contains(n){const l=Math.pow(2,n.z),p=Math.floor(a.U(this.bounds.getWest())*l),g=Math.floor(a.S(this.bounds.getNorth())*l),x=Math.ceil(a.U(this.bounds.getEast())*l),w=Math.ceil(a.S(this.bounds.getSouth())*l);return n.x>=p&&n.x<x&&n.y>=g&&n.y<w}}class Gt extends a.E{constructor(n,l,p,g){if(super(),this.id=n,this.dispatcher=p,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,a.e(this,a.O(l,["url","scheme","tileSize","promoteId"])),this._options=a.e({type:"vector"},l),this._collectResourceTiming=l.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g)}load(){return a._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new a.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const n=yield Hr(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),n&&(a.e(this,n),n.bounds&&(this.tileBounds=new qt(n.bounds,this.minzoom,this.maxzoom)),this.fire(new a.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.l("data",{dataType:"source",sourceDataType:"content"})))}catch(n){this._tileJSONRequest=null,this.fire(new a.k(n))}})}loaded(){return this._loaded}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}onAdd(n){this.map=n,this.load()}setSourceProperty(n){this._tileJSONRequest&&this._tileJSONRequest.abort(),n(),this.load()}setTiles(n){return this.setSourceProperty(()=>{this._options.tiles=n}),this}setUrl(n){return this.setSourceProperty(()=>{this.url=n,this._options.url=n}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return a.e({},this._options)}loadTile(n){return a._(this,void 0,void 0,function*(){const l=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),p={request:this.map._requestManager.transformRequest(l,"Tile"),uid:n.uid,tileID:n.tileID,zoom:n.tileID.overscaledZ,tileSize:this.tileSize*n.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};p.request.collectResourceTiming=this._collectResourceTiming;let g="RT";if(n.actor&&n.state!=="expired"){if(n.state==="loading")return new Promise((x,w)=>{n.reloadPromise={resolve:x,reject:w}})}else n.actor=this.dispatcher.getActor(),g="LT";n.abortController=new AbortController;try{const x=yield n.actor.sendAsync({type:g,data:p},n.abortController);if(delete n.abortController,n.aborted)return;this._afterTileLoadWorkerResponse(n,x)}catch(x){if(delete n.abortController,n.aborted)return;if(x&&x.status!==404)throw x;this._afterTileLoadWorkerResponse(n,null)}})}_afterTileLoadWorkerResponse(n,l){if(l&&l.resourceTiming&&(n.resourceTiming=l.resourceTiming),l&&this.map._refreshExpiredTiles&&n.setExpiryData(l),n.loadVectorData(l,this.map.painter),n.reloadPromise){const p=n.reloadPromise;n.reloadPromise=null,this.loadTile(n).then(p.resolve).catch(p.reject)}}abortTile(n){return a._(this,void 0,void 0,function*(){n.abortController&&(n.abortController.abort(),delete n.abortController),n.actor&&(yield n.actor.sendAsync({type:"AT",data:{uid:n.uid,type:this.type,source:this.id}}))})}unloadTile(n){return a._(this,void 0,void 0,function*(){n.unloadVectorData(),n.actor&&(yield n.actor.sendAsync({type:"RMT",data:{uid:n.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class Kr extends a.E{constructor(n,l,p,g){super(),this.id=n,this.dispatcher=p,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=a.e({type:"raster"},l),a.e(this,a.O(l,["url","scheme","tileSize"]))}load(){return a._(this,arguments,void 0,function*(n=!1){this._loaded=!1,this.fire(new a.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const l=yield Hr(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,l&&(a.e(this,l),l.bounds&&(this.tileBounds=new qt(l.bounds,this.minzoom,this.maxzoom)),this.fire(new a.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:n})))}catch(l){this._tileJSONRequest=null,this.fire(new a.k(l))}})}loaded(){return this._loaded}onAdd(n){this.map=n,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(n){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),n(),this.load(!0)}setTiles(n){return this.setSourceProperty(()=>{this._options.tiles=n}),this}setUrl(n){return this.setSourceProperty(()=>{this.url=n,this._options.url=n}),this}serialize(){return a.e({},this._options)}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}loadTile(n){return a._(this,void 0,void 0,function*(){const l=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);n.abortController=new AbortController;try{const p=yield Ce.getImage(this.map._requestManager.transformRequest(l,"Tile"),n.abortController,this.map._refreshExpiredTiles);if(delete n.abortController,n.aborted)return void(n.state="unloaded");if(p&&p.data){this.map._refreshExpiredTiles&&p.cacheControl&&p.expires&&n.setExpiryData({cacheControl:p.cacheControl,expires:p.expires});const g=this.map.painter.context,x=g.gl,w=p.data;n.texture=this.map.painter.getTileTexture(w.width),n.texture?n.texture.update(w,{useMipmap:!0}):(n.texture=new ft(g,w,x.RGBA,{useMipmap:!0}),n.texture.bind(x.LINEAR,x.CLAMP_TO_EDGE,x.LINEAR_MIPMAP_NEAREST)),n.state="loaded"}}catch(p){if(delete n.abortController,n.aborted)n.state="unloaded";else if(p)throw n.state="errored",p}})}abortTile(n){return a._(this,void 0,void 0,function*(){n.abortController&&(n.abortController.abort(),delete n.abortController)})}unloadTile(n){return a._(this,void 0,void 0,function*(){n.texture&&this.map.painter.saveTileTexture(n.texture)})}hasTransition(){return!1}}class Qn extends Kr{constructor(n,l,p,g){super(n,l,p,g),this.type="raster-dem",this.maxzoom=22,this._options=a.e({type:"raster-dem"},l),this.encoding=l.encoding||"mapbox",this.redFactor=l.redFactor,this.greenFactor=l.greenFactor,this.blueFactor=l.blueFactor,this.baseShift=l.baseShift}loadTile(n){return a._(this,void 0,void 0,function*(){const l=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),p=this.map._requestManager.transformRequest(l,"Tile");n.neighboringTiles=this._getNeighboringTiles(n.tileID),n.abortController=new AbortController;try{const g=yield Ce.getImage(p,n.abortController,this.map._refreshExpiredTiles);if(delete n.abortController,n.aborted)return void(n.state="unloaded");if(g&&g.data){const x=g.data;this.map._refreshExpiredTiles&&g.cacheControl&&g.expires&&n.setExpiryData({cacheControl:g.cacheControl,expires:g.expires});const w=a.b(x)&&a.V()?x:yield this.readImageNow(x),P={type:this.type,uid:n.uid,source:this.id,rawImageData:w,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!n.actor||n.state==="expired"){n.actor=this.dispatcher.getActor();const I=yield n.actor.sendAsync({type:"LDT",data:P});n.dem=I,n.needsHillshadePrepare=!0,n.needsTerrainPrepare=!0,n.state="loaded"}}}catch(g){if(delete n.abortController,n.aborted)n.state="unloaded";else if(g)throw n.state="errored",g}})}readImageNow(n){return a._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&a.W()){const l=n.width+2,p=n.height+2;try{return new a.R({width:l,height:p},yield a.X(n,-1,-1,l,p))}catch{}}return F.getImageData(n,1)})}_getNeighboringTiles(n){const l=n.canonical,p=Math.pow(2,l.z),g=(l.x-1+p)%p,x=l.x===0?n.wrap-1:n.wrap,w=(l.x+1+p)%p,P=l.x+1===p?n.wrap+1:n.wrap,I={};return I[new a.Y(n.overscaledZ,x,l.z,g,l.y).key]={backfilled:!1},I[new a.Y(n.overscaledZ,P,l.z,w,l.y).key]={backfilled:!1},l.y>0&&(I[new a.Y(n.overscaledZ,x,l.z,g,l.y-1).key]={backfilled:!1},I[new a.Y(n.overscaledZ,n.wrap,l.z,l.x,l.y-1).key]={backfilled:!1},I[new a.Y(n.overscaledZ,P,l.z,w,l.y-1).key]={backfilled:!1}),l.y+1<p&&(I[new a.Y(n.overscaledZ,x,l.z,g,l.y+1).key]={backfilled:!1},I[new a.Y(n.overscaledZ,n.wrap,l.z,l.x,l.y+1).key]={backfilled:!1},I[new a.Y(n.overscaledZ,P,l.z,w,l.y+1).key]={backfilled:!1}),I}unloadTile(n){return a._(this,void 0,void 0,function*(){n.demTexture&&this.map.painter.saveTileTexture(n.demTexture),n.fbo&&(n.fbo.destroy(),delete n.fbo),n.dem&&delete n.dem,delete n.neighboringTiles,n.state="unloaded",n.actor&&(yield n.actor.sendAsync({type:"RDT",data:{type:this.type,uid:n.uid,source:this.id}}))})}}class es extends a.E{constructor(n,l,p,g){super(),this.id=n,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=p.getActor(),this.setEventedParent(g),this._data=l.data,this._options=a.e({},l),this._collectResourceTiming=l.collectResourceTiming,l.maxzoom!==void 0&&(this.maxzoom=l.maxzoom),l.type&&(this.type=l.type),l.attribution&&(this.attribution=l.attribution),this.promoteId=l.promoteId,l.clusterMaxZoom!==void 0&&this.maxzoom<=l.clusterMaxZoom&&a.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${l.clusterMaxZoom}".`),this.workerOptions=a.e({source:this.id,cluster:l.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(l.buffer!==void 0?l.buffer:128),tolerance:this._pixelsToTileUnits(l.tolerance!==void 0?l.tolerance:.375),extent:a.Z,maxZoom:this.maxzoom,lineMetrics:l.lineMetrics||!1,generateId:l.generateId||!1},superclusterOptions:{maxZoom:l.clusterMaxZoom!==void 0?l.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,l.clusterMinPoints||2),extent:a.Z,radius:this._pixelsToTileUnits(l.clusterRadius||50),log:!1,generateId:l.generateId||!1},clusterProperties:l.clusterProperties,filter:l.filter},l.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_pixelsToTileUnits(n){return n*(a.Z/this.tileSize)}load(){return a._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(n){this.map=n,this.load()}setData(n){return this._data=n,this._updateWorkerData(),this}updateData(n){return this._updateWorkerData(n),this}getData(){return a._(this,void 0,void 0,function*(){const n=a.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:n})})}getCoordinatesFromGeometry(n){return n.type==="GeometryCollection"?n.geometries.map(l=>l.coordinates).flat(1/0):n.coordinates.flat(1/0)}getBounds(){return a._(this,void 0,void 0,function*(){const n=new Si,l=yield this.getData();let p;switch(l.type){case"FeatureCollection":p=l.features.map(g=>this.getCoordinatesFromGeometry(g.geometry)).flat(1/0);break;case"Feature":p=this.getCoordinatesFromGeometry(l.geometry);break;default:p=this.getCoordinatesFromGeometry(l)}if(p.length==0)return n;for(let g=0;g<p.length-1;g+=2)n.extend([p[g],p[g+1]]);return n})}setClusterOptions(n){return this.workerOptions.cluster=n.cluster,n&&(n.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(n.clusterRadius)),n.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=n.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(n){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:n,source:this.id}})}getClusterChildren(n){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:n,source:this.id}})}getClusterLeaves(n,l,p){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:n,limit:l,offset:p}})}_updateWorkerData(n){return a._(this,void 0,void 0,function*(){const l=a.e({type:this.type},this.workerOptions);n?l.dataDiff=n:typeof this._data=="string"?(l.request=this.map._requestManager.transformRequest(F.resolveURL(this._data),"Source"),l.request.collectResourceTiming=this._collectResourceTiming):l.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new a.l("dataloading",{dataType:"source"}));try{const p=yield this.actor.sendAsync({type:"LD",data:l});if(this._pendingLoads--,this._removed||p.abandoned)return void this.fire(new a.l("dataabort",{dataType:"source"}));let g=null;p.resourceTiming&&p.resourceTiming[this.id]&&(g=p.resourceTiming[this.id].slice(0));const x={dataType:"source"};this._collectResourceTiming&&g&&g.length>0&&a.e(x,{resourceTiming:g}),this.fire(new a.l("data",Object.assign(Object.assign({},x),{sourceDataType:"metadata"}))),this.fire(new a.l("data",Object.assign(Object.assign({},x),{sourceDataType:"content"})))}catch(p){if(this._pendingLoads--,this._removed)return void this.fire(new a.l("dataabort",{dataType:"source"}));this.fire(new a.k(p))}})}loaded(){return this._pendingLoads===0}loadTile(n){return a._(this,void 0,void 0,function*(){const l=n.actor?"RT":"LT";n.actor=this.actor;const p={type:this.type,uid:n.uid,tileID:n.tileID,zoom:n.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};n.abortController=new AbortController;const g=yield this.actor.sendAsync({type:l,data:p},n.abortController);delete n.abortController,n.unloadVectorData(),n.aborted||n.loadVectorData(g,this.map.painter,l==="RT")})}abortTile(n){return a._(this,void 0,void 0,function*(){n.abortController&&(n.abortController.abort(),delete n.abortController),n.aborted=!0})}unloadTile(n){return a._(this,void 0,void 0,function*(){n.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:n.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return a.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}class Jr extends a.E{constructor(n,l,p,g){super(),this.flippedWindingOrder=!1,this.id=n,this.dispatcher=p,this.coordinates=l.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(g),this.options=l}load(n){return a._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new a.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const l=yield Ce.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,l&&l.data&&(this.image=l.data,n&&(this.coordinates=n),this._finishLoading())}catch(l){this._request=null,this._loaded=!0,this.fire(new a.k(l))}})}loaded(){return this._loaded}updateImage(n){return n.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=n.url,this.load(n.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new a.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(n){this.map=n,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(n){this.coordinates=n;const l=n.map(a.$.fromLngLat);var p;return this.tileID=function(g){let x=1/0,w=1/0,P=-1/0,I=-1/0;for(const B of g)x=Math.min(x,B.x),w=Math.min(w,B.y),P=Math.max(P,B.x),I=Math.max(I,B.y);const R=Math.max(P-x,I-w),O=Math.max(0,Math.floor(-Math.log(R)/Math.LN2)),N=Math.pow(2,O);return new a.a1(O,Math.floor((x+P)/2*N),Math.floor((w+I)/2*N))}(l),this.terrainTileRanges=this._getOverlappingTileRanges(l),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=l.map(g=>this.tileID.getTilePoint(g)._round()),this.flippedWindingOrder=((p=this.tileCoords)[1].x-p[0].x)*(p[2].y-p[0].y)-(p[1].y-p[0].y)*(p[2].x-p[0].x)<0,this.fire(new a.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const n=this.map.painter.context,l=n.gl;this.texture||(this.texture=new ft(n,this.image,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));let p=!1;for(const g in this.tiles){const x=this.tiles[g];x.state!=="loaded"&&(x.state="loaded",x.texture=this.texture,p=!0)}p&&this.fire(new a.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(n){return a._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(n.tileID.canonical)?(this.tiles[String(n.tileID.wrap)]=n,n.buckets={}):n.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(n){let l=1/0,p=1/0,g=-1/0,x=-1/0;for(const P of n)l=Math.min(l,P.x),p=Math.min(p,P.y),g=Math.max(g,P.x),x=Math.max(x,P.y);const w={};for(let P=0;P<=a.a0;P++){const I=Math.pow(2,P),R=Math.floor(l*I),O=Math.floor(p*I),N=Math.floor(g*I),B=Math.floor(x*I);w[P]={minTileX:R,minTileY:O,maxTileX:N,maxTileY:B}}return w}}class Qr extends Jr{constructor(n,l,p,g){super(n,l,p,g),this.roundZoom=!0,this.type="video",this.options=l}load(){return a._(this,void 0,void 0,function*(){this._loaded=!1;const n=this.options;this.urls=[];for(const l of n.urls)this.urls.push(this.map._requestManager.transformRequest(l,"Source").url);try{const l=yield a.a2(this.urls);if(this._loaded=!0,!l)return;this.video=l,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(l){this.fire(new a.k(l))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(n){if(this.video){const l=this.video.seekable;n<l.start(0)||n>l.end(0)?this.fire(new a.k(new a.a3(`sources.${this.id}`,null,`Playback for this video can be set only between the ${l.start(0)} and ${l.end(0)}-second mark.`))):this.video.currentTime=n}}getVideo(){return this.video}onAdd(n){this.map||(this.map=n,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const n=this.map.painter.context,l=n.gl;this.texture?this.video.paused||(this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE),l.texSubImage2D(l.TEXTURE_2D,0,0,0,l.RGBA,l.UNSIGNED_BYTE,this.video)):(this.texture=new ft(n,this.video,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));let p=!1;for(const g in this.tiles){const x=this.tiles[g];x.state!=="loaded"&&(x.state="loaded",x.texture=this.texture,p=!0)}p&&this.fire(new a.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class to extends Jr{constructor(n,l,p,g){super(n,l,p,g),l.coordinates?Array.isArray(l.coordinates)&&l.coordinates.length===4&&!l.coordinates.some(x=>!Array.isArray(x)||x.length!==2||x.some(w=>typeof w!="number"))||this.fire(new a.k(new a.a3(`sources.${n}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new a.k(new a.a3(`sources.${n}`,null,'missing required property "coordinates"'))),l.animate&&typeof l.animate!="boolean"&&this.fire(new a.k(new a.a3(`sources.${n}`,null,'optional "animate" property must be a boolean value'))),l.canvas?typeof l.canvas=="string"||l.canvas instanceof HTMLCanvasElement||this.fire(new a.k(new a.a3(`sources.${n}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new a.k(new a.a3(`sources.${n}`,null,'missing required property "canvas"'))),this.options=l,this.animate=l.animate===void 0||l.animate}load(){return a._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new a.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(n){this.map=n,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let n=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,n=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,n=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const l=this.map.painter.context,p=l.gl;this.texture?(n||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new ft(l,this.canvas,p.RGBA,{premultiply:!0});let g=!1;for(const x in this.tiles){const w=this.tiles[x];w.state!=="loaded"&&(w.state="loaded",w.texture=this.texture,g=!0)}g&&this.fire(new a.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const n of[this.canvas.width,this.canvas.height])if(isNaN(n)||n<=0)return!0;return!1}}const io={},ta=_=>{switch(_){case"geojson":return es;case"image":return Jr;case"raster":return Kr;case"raster-dem":return Qn;case"vector":return Gt;case"video":return Qr;case"canvas":return to}return io[_]},Es="RTLPluginLoaded";class ts extends a.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Xt()}_syncState(n){return this.status=n,this.dispatcher.broadcast("SRPS",{pluginStatus:n,pluginURL:this.url}).catch(l=>{throw this.status="error",l})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(n){return a._(this,arguments,void 0,function*(l,p=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=F.resolveURL(l),!this.url)throw new Error(`requested url ${l} is invalid`);if(this.status==="unavailable"){if(!p)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return a._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new a.l(Es))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let ro=null;function Cn(){return ro||(ro=new ts),ro}class dn{constructor(n,l){this.timeAdded=0,this.fadeEndTime=0,this.tileID=n,this.uid=a.a4(),this.uses=0,this.tileSize=l,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(n){const l=n+this.timeAdded;l<this.fadeEndTime||(this.fadeEndTime=l)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(n){this.demTexture&&n.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(n,l,p){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",n){n.featureIndex&&(this.latestFeatureIndex=n.featureIndex,n.rawTileData?(this.latestRawTileData=n.rawTileData,this.latestFeatureIndex.rawTileData=n.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=n.collisionBoxArray,this.buckets=function(g,x){const w={};if(!x)return w;for(const P of g){const I=P.layerIds.map(R=>x.getLayer(R)).filter(Boolean);if(I.length!==0){P.layers=I,P.stateDependentLayerIds&&(P.stateDependentLayers=P.stateDependentLayerIds.map(R=>I.filter(O=>O.id===R)[0]));for(const R of I)w[R.id]=P}}return w}(n.buckets,l==null?void 0:l.style),this.hasSymbolBuckets=!1;for(const g in this.buckets){const x=this.buckets[g];if(x instanceof a.a6){if(this.hasSymbolBuckets=!0,!p)break;x.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const g in this.buckets){const x=this.buckets[g];if(x instanceof a.a6&&x.hasRTLText){this.hasRTLText=!0,Cn().lazyLoad();break}}this.queryPadding=0;for(const g in this.buckets){const x=this.buckets[g];this.queryPadding=Math.max(this.queryPadding,l.style.getLayer(g).queryRadius(x))}n.imageAtlas&&(this.imageAtlas=n.imageAtlas),n.glyphAtlasImage&&(this.glyphAtlasImage=n.glyphAtlasImage)}else this.collisionBoxArray=new a.a5}unloadVectorData(){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(n){return this.buckets[n.id]}upload(n){for(const p in this.buckets){const g=this.buckets[p];g.uploadPending()&&g.upload(n)}const l=n.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new ft(n,this.imageAtlas.image,l.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new ft(n,this.glyphAtlasImage,l.ALPHA),this.glyphAtlasImage=null)}prepare(n){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(n,this.imageAtlasTexture)}queryRenderedFeatures(n,l,p,g,x,w,P,I,R,O,N){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:g,cameraQueryGeometry:x,scale:w,tileSize:this.tileSize,pixelPosMatrix:O,transform:I,params:P,queryPadding:this.queryPadding*R,getElevation:N},n,l,p):{}}querySourceFeatures(n,l){const p=this.latestFeatureIndex;if(!p||!p.rawTileData)return;const g=p.loadVTLayers(),x=l&&l.sourceLayer?l.sourceLayer:"",w=g._geojsonTileLayer||g[x];if(!w)return;const P=a.a7(l&&l.filter),{z:I,x:R,y:O}=this.tileID.canonical,N={z:I,x:R,y:O};for(let B=0;B<w.length;B++){const W=w.feature(B);if(P.needGeometry){const Q=a.a8(W,!0);if(!P.filter(new a.C(this.tileID.overscaledZ),Q,this.tileID.canonical))continue}else if(!P.filter(new a.C(this.tileID.overscaledZ),W))continue;const X=p.getId(W,x),te=new a.a9(W,I,R,O,X);te.tile=N,n.push(te)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(n){const l=this.expirationTime;if(n.cacheControl){const p=a.aa(n.cacheControl);p["max-age"]&&(this.expirationTime=Date.now()+1e3*p["max-age"])}else n.expires&&(this.expirationTime=new Date(n.expires).getTime());if(this.expirationTime){const p=Date.now();let g=!1;if(this.expirationTime>p)g=!1;else if(l)if(this.expirationTime<l)g=!0;else{const x=this.expirationTime-l;x?this.expirationTime=p+Math.max(x,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(n,l){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(n).length===0)return;const p=this.latestFeatureIndex.loadVTLayers();for(const g in this.buckets){if(!l.style.hasLayer(g))continue;const x=this.buckets[g],w=x.layers[0].sourceLayer||"_geojsonTileLayer",P=p[w],I=n[w];if(!P||!I||Object.keys(I).length===0)continue;x.update(I,P,this.imageAtlas&&this.imageAtlas.patternPositions||{});const R=l&&l.style&&l.style.getLayer(g);R&&(this.queryPadding=Math.max(this.queryPadding,R.queryRadius(x)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<F.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(n){this.symbolFadeHoldUntil=F.now()+n}setDependencies(n,l){const p={};for(const g of l)p[g]=!0;this.dependencies[n]=p}hasDependency(n,l){for(const p of n){const g=this.dependencies[p];if(g){for(const x of l)if(g[x])return!0}}return!1}}class Mn{constructor(n,l){this.max=n,this.onRemove=l,this.reset()}reset(){for(const n in this.data)for(const l of this.data[n])l.timeout&&clearTimeout(l.timeout),this.onRemove(l.value);return this.data={},this.order=[],this}add(n,l,p){const g=n.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);const x={value:l,timeout:void 0};if(p!==void 0&&(x.timeout=setTimeout(()=>{this.remove(n,x)},p)),this.data[g].push(x),this.order.push(g),this.order.length>this.max){const w=this._getAndRemoveByKey(this.order[0]);w&&this.onRemove(w)}return this}has(n){return n.wrapped().key in this.data}getAndRemove(n){return this.has(n)?this._getAndRemoveByKey(n.wrapped().key):null}_getAndRemoveByKey(n){const l=this.data[n].shift();return l.timeout&&clearTimeout(l.timeout),this.data[n].length===0&&delete this.data[n],this.order.splice(this.order.indexOf(n),1),l.value}getByKey(n){const l=this.data[n];return l?l[0].value:null}get(n){return this.has(n)?this.data[n.wrapped().key][0].value:null}remove(n,l){if(!this.has(n))return this;const p=n.wrapped().key,g=l===void 0?0:this.data[p].indexOf(l),x=this.data[p][g];return this.data[p].splice(g,1),x.timeout&&clearTimeout(x.timeout),this.data[p].length===0&&delete this.data[p],this.onRemove(x.value),this.order.splice(this.order.indexOf(p),1),this}setMaxSize(n){for(this.max=n;this.order.length>this.max;){const l=this._getAndRemoveByKey(this.order[0]);l&&this.onRemove(l)}return this}filter(n){const l=[];for(const p in this.data)for(const g of this.data[p])n(g.value)||l.push(g);for(const p of l)this.remove(p.value.tileID,p)}}class no{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(n,l,p){const g=String(l);if(this.stateChanges[n]=this.stateChanges[n]||{},this.stateChanges[n][g]=this.stateChanges[n][g]||{},a.e(this.stateChanges[n][g],p),this.deletedStates[n]===null){this.deletedStates[n]={};for(const x in this.state[n])x!==g&&(this.deletedStates[n][x]=null)}else if(this.deletedStates[n]&&this.deletedStates[n][g]===null){this.deletedStates[n][g]={};for(const x in this.state[n][g])p[x]||(this.deletedStates[n][g][x]=null)}else for(const x in p)this.deletedStates[n]&&this.deletedStates[n][g]&&this.deletedStates[n][g][x]===null&&delete this.deletedStates[n][g][x]}removeFeatureState(n,l,p){if(this.deletedStates[n]===null)return;const g=String(l);if(this.deletedStates[n]=this.deletedStates[n]||{},p&&l!==void 0)this.deletedStates[n][g]!==null&&(this.deletedStates[n][g]=this.deletedStates[n][g]||{},this.deletedStates[n][g][p]=null);else if(l!==void 0)if(this.stateChanges[n]&&this.stateChanges[n][g])for(p in this.deletedStates[n][g]={},this.stateChanges[n][g])this.deletedStates[n][g][p]=null;else this.deletedStates[n][g]=null;else this.deletedStates[n]=null}getState(n,l){const p=String(l),g=a.e({},(this.state[n]||{})[p],(this.stateChanges[n]||{})[p]);if(this.deletedStates[n]===null)return{};if(this.deletedStates[n]){const x=this.deletedStates[n][l];if(x===null)return{};for(const w in x)delete g[w]}return g}initializeTileState(n,l){n.setFeatureState(this.state,l)}coalesceChanges(n,l){const p={};for(const g in this.stateChanges){this.state[g]=this.state[g]||{};const x={};for(const w in this.stateChanges[g])this.state[g][w]||(this.state[g][w]={}),a.e(this.state[g][w],this.stateChanges[g][w]),x[w]=this.state[g][w];p[g]=x}for(const g in this.deletedStates){this.state[g]=this.state[g]||{};const x={};if(this.deletedStates[g]===null)for(const w in this.state[g])x[w]={},this.state[g][w]={};else for(const w in this.deletedStates[g]){if(this.deletedStates[g][w]===null)this.state[g][w]={};else for(const P of Object.keys(this.deletedStates[g][w]))delete this.state[g][w][P];x[w]=this.state[g][w]}p[g]=p[g]||{},a.e(p[g],x)}if(this.stateChanges={},this.deletedStates={},Object.keys(p).length!==0)for(const g in n)n[g].setFeatureState(p,l)}}function ia(_,n,l){const p=n.intersectsFrustum(_);if(!l)return p;const g=n.intersectsPlane(l);return p===0||g===0?0:p===2&&g===2?2:1}function Qa(_,n,l,p,g){let x=_;const w=Math.atan(n/l),P=Math.hypot(n,l);return x=_+a.ab(p/P/Math.max(.5,Math.cos(a.ad(g/2)))),x+=1*a.ab(Math.cos(w))/2,x+=a.ae(_-x,-0,0),x}function Rn(_,n){const l=(n.roundZoom?Math.round:Math.floor)(_.zoom+a.ab(_.tileSize/n.tileSize));return Math.max(0,l)}function Pe(_,n){const l=_.getCameraFrustum(),p=_.getClippingPlane(),g=_.screenPointToMercatorCoordinate(_.getCameraPoint()),x=a.$.fromLngLat(_.center,_.elevation);g.z=x.z+Math.cos(_.pitchInRadians)*_.cameraToCenterDistance/_.worldSize;const w=_.getCoveringTilesDetailsProvider(),P=w.allowVariableZoom(_,n),I=Rn(_,n),R=n.minzoom||0,O=n.maxzoom!==void 0?n.maxzoom:_.maxZoom,N=Math.min(Math.max(0,I),O),B=Math.pow(2,N),W=[B*g.x,B*g.y,0],X=[B*x.x,B*x.y,0],te=Math.hypot(x.x-g.x,x.y-g.y),Q=Math.abs(x.z-g.z),ie=Math.hypot(te,Q),se=de=>({zoom:0,x:0,y:0,wrap:de,fullyVisible:!1}),ue=[],fe=[];if(_.renderWorldCopies&&w.allowWorldCopies())for(let de=1;de<=3;de++)ue.push(se(-de)),ue.push(se(de));for(ue.push(se(0));ue.length>0;){const de=ue.pop(),ve=de.x,ge=de.y;let De=de.fullyVisible;const ke={x:ve,y:ge,z:de.zoom},We=w.getTileAABB(ke,de.wrap,_.elevation,n);if(!De){const at=ia(l,We,p);if(at===0)continue;De=at===2}const Ze=w.distanceToTile2d(g.x,g.y,ke,We);let je=I;P&&(je=(n.calculateTileZoom||Qa)(_.zoom+a.ab(_.tileSize/n.tileSize),Ze,Q,ie,_.fov)),je=(n.roundZoom?Math.round:Math.floor)(je),je=Math.max(0,je);const lt=Math.min(je,O);if(de.wrap=w.getWrap(x,ke,de.wrap),de.zoom>=lt){if(de.zoom<R)continue;const at=N-de.zoom,qe=W[0]-.5-(ve<<at),bt=W[1]-.5-(ge<<at),Ut=n.reparseOverscaled?Math.max(de.zoom,je):de.zoom;fe.push({tileID:new a.Y(de.zoom===O?Ut:de.zoom,de.wrap,de.zoom,ve,ge),distanceSq:a.ac([X[0]-.5-ve,X[1]-.5-ge]),tileDistanceToCamera:Math.sqrt(qe*qe+bt*bt)})}else for(let at=0;at<4;at++)ue.push({zoom:de.zoom+1,x:(ve<<1)+at%2,y:(ge<<1)+(at>>1),wrap:de.wrap,fullyVisible:De})}return fe.sort((de,ve)=>de.distanceSq-ve.distanceSq).map(de=>de.tileID)}class Z extends a.E{constructor(n,l,p){super(),this.id=n,this.dispatcher=p,this.on("data",g=>this._dataHandler(g)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((g,x,w,P)=>{const I=new(ta(x.type))(g,x,w,P);if(I.id!==g)throw new Error(`Expected Source id to be ${g} instead of ${I.id}`);return I})(n,l,p,this),this._tiles={},this._cache=new Mn(0,g=>this._unloadTile(g)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new no,this._didEmitContent=!1,this._updated=!1}onAdd(n){this.map=n,this._maxTileCacheSize=n?n._maxTileCacheSize:null,this._maxTileCacheZoomLevels=n?n._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(n)}onRemove(n){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(n)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const n in this._tiles){const l=this._tiles[n];if(l.state!=="loaded"&&l.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const n=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,n&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(n,l,p){return a._(this,void 0,void 0,function*(){try{yield this._source.loadTile(n),this._tileLoaded(n,l,p)}catch(g){n.state="errored",g.status!==404?this._source.fire(new a.k(g,{tile:n})):this.update(this.transform,this.terrain)}})}_unloadTile(n){this._source.unloadTile&&this._source.unloadTile(n)}_abortTile(n){this._source.abortTile&&this._source.abortTile(n),this._source.fire(new a.l("dataabort",{tile:n,coord:n.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(n){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const l in this._tiles){const p=this._tiles[l];p.upload(n),p.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(n=>n.tileID).sort(q).map(n=>n.key)}getRenderableIds(n){const l=[];for(const p in this._tiles)this._isIdRenderable(p,n)&&l.push(this._tiles[p]);return n?l.sort((p,g)=>{const x=p.tileID,w=g.tileID,P=new a.P(x.canonical.x,x.canonical.y)._rotate(-this.transform.bearingInRadians),I=new a.P(w.canonical.x,w.canonical.y)._rotate(-this.transform.bearingInRadians);return x.overscaledZ-w.overscaledZ||I.y-P.y||I.x-P.x}).map(p=>p.tileID.key):l.map(p=>p.tileID).sort(q).map(p=>p.key)}hasRenderableParent(n){const l=this.findLoadedParent(n,0);return!!l&&this._isIdRenderable(l.tileID.key)}_isIdRenderable(n,l){return this._tiles[n]&&this._tiles[n].hasData()&&!this._coveredTiles[n]&&(l||!this._tiles[n].holdingForFade())}reload(n){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const l in this._tiles)(n||this._tiles[l].state!=="errored")&&this._reloadTile(l,"reloading")}}_reloadTile(n,l){return a._(this,void 0,void 0,function*(){const p=this._tiles[n];p&&(p.state!=="loading"&&(p.state=l),yield this._loadTile(p,n,l))})}_tileLoaded(n,l,p){n.timeAdded=F.now(),p==="expired"&&(n.refreshedUponExpiration=!0),this._setTileReloadTimer(l,n),this.getSource().type==="raster-dem"&&n.dem&&this._backfillDEM(n),this._state.initializeTileState(n,this.map?this.map.painter:null),n.aborted||this._source.fire(new a.l("data",{dataType:"source",tile:n,coord:n.tileID}))}_backfillDEM(n){const l=this.getRenderableIds();for(let g=0;g<l.length;g++){const x=l[g];if(n.neighboringTiles&&n.neighboringTiles[x]){const w=this.getTileByID(x);p(n,w),p(w,n)}}function p(g,x){g.needsHillshadePrepare=!0,g.needsTerrainPrepare=!0;let w=x.tileID.canonical.x-g.tileID.canonical.x;const P=x.tileID.canonical.y-g.tileID.canonical.y,I=Math.pow(2,g.tileID.canonical.z),R=x.tileID.key;w===0&&P===0||Math.abs(P)>1||(Math.abs(w)>1&&(Math.abs(w+I)===1?w+=I:Math.abs(w-I)===1&&(w-=I)),x.dem&&g.dem&&(g.dem.backfillBorder(x.dem,w,P),g.neighboringTiles&&g.neighboringTiles[R]&&(g.neighboringTiles[R].backfilled=!0)))}}getTile(n){return this.getTileByID(n.key)}getTileByID(n){return this._tiles[n]}_retainLoadedChildren(n,l,p,g){for(const x in this._tiles){let w=this._tiles[x];if(g[x]||!w.hasData()||w.tileID.overscaledZ<=l||w.tileID.overscaledZ>p)continue;let P=w.tileID;for(;w&&w.tileID.overscaledZ>l+1;){const R=w.tileID.scaledTo(w.tileID.overscaledZ-1);w=this._tiles[R.key],w&&w.hasData()&&(P=R)}let I=P;for(;I.overscaledZ>l;)if(I=I.scaledTo(I.overscaledZ-1),n[I.key]||n[I.canonical.key]){g[P.key]=P;break}}}findLoadedParent(n,l){if(n.key in this._loadedParentTiles){const p=this._loadedParentTiles[n.key];return p&&p.tileID.overscaledZ>=l?p:null}for(let p=n.overscaledZ-1;p>=l;p--){const g=n.scaledTo(p),x=this._getLoadedTile(g);if(x)return x}}findLoadedSibling(n){return this._getLoadedTile(n)}_getLoadedTile(n){const l=this._tiles[n.key];return l&&l.hasData()?l:this._cache.getByKey(n.wrapped().key)}updateCacheSize(n){const l=Math.ceil(n.width/this._source.tileSize)+1,p=Math.ceil(n.height/this._source.tileSize)+1,g=Math.floor(l*p*(this._maxTileCacheZoomLevels===null?a.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),x=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,g):g;this._cache.setMaxSize(x)}handleWrapJump(n){const l=Math.round((n-(this._prevLng===void 0?n:this._prevLng))/360);if(this._prevLng=n,l){const p={};for(const g in this._tiles){const x=this._tiles[g];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+l),p[x.tileID.key]=x}this._tiles=p;for(const g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(const g in this._tiles)this._setTileReloadTimer(g,this._tiles[g])}}_updateCoveredAndRetainedTiles(n,l,p,g,x,w){const P={},I={},R=Object.keys(n),O=F.now();for(const N of R){const B=n[N],W=this._tiles[N];if(!W||W.fadeEndTime!==0&&W.fadeEndTime<=O)continue;const X=this.findLoadedParent(B,l),te=this.findLoadedSibling(B),Q=X||te||null;Q&&(this._addTile(Q.tileID),P[Q.tileID.key]=Q.tileID),I[N]=B}this._retainLoadedChildren(I,g,p,n);for(const N in P)n[N]||(this._coveredTiles[N]=!0,n[N]=P[N]);if(w){const N={},B={};for(const W of x)this._tiles[W.key].hasData()?N[W.key]=W:B[W.key]=W;for(const W in B){const X=B[W].children(this._source.maxzoom);this._tiles[X[0].key]&&this._tiles[X[1].key]&&this._tiles[X[2].key]&&this._tiles[X[3].key]&&(N[X[0].key]=n[X[0].key]=X[0],N[X[1].key]=n[X[1].key]=X[1],N[X[2].key]=n[X[2].key]=X[2],N[X[3].key]=n[X[3].key]=X[3],delete B[W])}for(const W in B){const X=B[W],te=this.findLoadedParent(X,this._source.minzoom),Q=this.findLoadedSibling(X),ie=te||Q||null;if(ie){N[ie.tileID.key]=n[ie.tileID.key]=ie.tileID;for(const se in N)N[se].isChildOf(ie.tileID)&&delete N[se]}}for(const W in this._tiles)N[W]||(this._coveredTiles[W]=!0)}}update(n,l){if(!this._sourceLoaded||this._paused)return;let p;this.transform=n,this.terrain=l,this.updateCacheSize(n),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?p=n.getVisibleUnwrappedCoordinates(this._source.tileID).map(O=>new a.Y(O.canonical.z,O.wrap,O.canonical.z,O.canonical.x,O.canonical.y)):(p=Pe(n,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:l,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(p=p.filter(O=>this._source.hasTile(O)))):p=[];const g=Rn(n,this._source),x=Math.max(g-Z.maxOverzooming,this._source.minzoom),w=Math.max(g+Z.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const O={};for(const N of p)if(N.canonical.z>this._source.minzoom){const B=N.scaledTo(N.canonical.z-1);O[B.key]=B;const W=N.scaledTo(Math.max(this._source.minzoom,Math.min(N.canonical.z,5)));O[W.key]=W}p=p.concat(Object.values(O))}const P=p.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,P&&this.fire(new a.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const I=this._updateRetainedTiles(p,g);j(this._source.type)&&this._updateCoveredAndRetainedTiles(I,x,w,g,p,l);for(const O in I)this._tiles[O].clearFadeHold();const R=a.af(this._tiles,I);for(const O of R){const N=this._tiles[O];N.hasSymbolBuckets&&!N.holdingForFade()?N.setHoldDuration(this.map._fadeDuration):N.hasSymbolBuckets&&!N.symbolFadeFinished()||this._removeTile(O)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const n in this._tiles)this._tiles[n].holdingForFade()&&this._removeTile(n)}_updateRetainedTiles(n,l){var p;const g={},x={},w=Math.max(l-Z.maxOverzooming,this._source.minzoom),P=Math.max(l+Z.maxUnderzooming,this._source.minzoom),I={};for(const R of n){const O=this._addTile(R);g[R.key]=R,O.hasData()||l<this._source.maxzoom&&(I[R.key]=R)}this._retainLoadedChildren(I,l,P,g);for(const R of n){let O=this._tiles[R.key];if(O.hasData())continue;if(l+1>this._source.maxzoom){const B=R.children(this._source.maxzoom)[0],W=this.getTile(B);if(W&&W.hasData()){g[B.key]=B;continue}}else{const B=R.children(this._source.maxzoom);if(g[B[0].key]&&g[B[1].key]&&g[B[2].key]&&g[B[3].key])continue}let N=O.wasRequested();for(let B=R.overscaledZ-1;B>=w;--B){const W=R.scaledTo(B);if(x[W.key])break;if(x[W.key]=!0,O=this.getTile(W),!O&&N&&(O=this._addTile(W)),O){const X=O.hasData();if((X||!(!((p=this.map)===null||p===void 0)&&p.cancelPendingTileRequestsWhileZooming)||N)&&(g[W.key]=W),N=O.wasRequested(),X)break}}}return g}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const n in this._tiles){const l=[];let p,g=this._tiles[n].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){p=this._loadedParentTiles[g.key];break}l.push(g.key);const x=g.scaledTo(g.overscaledZ-1);if(p=this._getLoadedTile(x),p)break;g=x}for(const x of l)this._loadedParentTiles[x]=p}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const n in this._tiles){const l=this._tiles[n].tileID,p=this._getLoadedTile(l);this._loadedSiblingTiles[l.key]=p}}_addTile(n){let l=this._tiles[n.key];if(l)return l;l=this._cache.getAndRemove(n),l&&(this._setTileReloadTimer(n.key,l),l.tileID=n,this._state.initializeTileState(l,this.map?this.map.painter:null),this._cacheTimers[n.key]&&(clearTimeout(this._cacheTimers[n.key]),delete this._cacheTimers[n.key],this._setTileReloadTimer(n.key,l)));const p=l;return l||(l=new dn(n,this._source.tileSize*n.overscaleFactor()),this._loadTile(l,n.key,l.state)),l.uses++,this._tiles[n.key]=l,p||this._source.fire(new a.l("dataloading",{tile:l,coord:l.tileID,dataType:"source"})),l}_setTileReloadTimer(n,l){n in this._timers&&(clearTimeout(this._timers[n]),delete this._timers[n]);const p=l.getExpiryTimeout();p&&(this._timers[n]=setTimeout(()=>{this._reloadTile(n,"expired"),delete this._timers[n]},p))}_removeTile(n){const l=this._tiles[n];l&&(l.uses--,delete this._tiles[n],this._timers[n]&&(clearTimeout(this._timers[n]),delete this._timers[n]),l.uses>0||(l.hasData()&&l.state!=="reloading"?this._cache.add(l.tileID,l,l.getExpiryTimeout()):(l.aborted=!0,this._abortTile(l),this._unloadTile(l))))}_dataHandler(n){const l=n.sourceDataType;n.dataType==="source"&&l==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&n.dataType==="source"&&l==="content"&&(this.reload(n.sourceDataChanged),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const n in this._tiles)this._removeTile(n);this._cache.reset()}tilesIn(n,l,p){const g=[],x=this.transform;if(!x)return g;const w=p?x.getCameraQueryGeometry(n):n,P=n.map(X=>x.screenPointToMercatorCoordinate(X,this.terrain)),I=w.map(X=>x.screenPointToMercatorCoordinate(X,this.terrain)),R=this.getIds();let O=1/0,N=1/0,B=-1/0,W=-1/0;for(const X of I)O=Math.min(O,X.x),N=Math.min(N,X.y),B=Math.max(B,X.x),W=Math.max(W,X.y);for(let X=0;X<R.length;X++){const te=this._tiles[R[X]];if(te.holdingForFade())continue;const Q=te.tileID,ie=Math.pow(2,x.zoom-te.tileID.overscaledZ),se=l*te.queryPadding*a.Z/te.tileSize/ie,ue=[Q.getTilePoint(new a.$(O,N)),Q.getTilePoint(new a.$(B,W))];if(ue[0].x-se<a.Z&&ue[0].y-se<a.Z&&ue[1].x+se>=0&&ue[1].y+se>=0){const fe=P.map(ve=>Q.getTilePoint(ve)),de=I.map(ve=>Q.getTilePoint(ve));g.push({tile:te,tileID:Q,queryGeometry:fe,cameraQueryGeometry:de,scale:ie})}}return g}getVisibleCoordinates(n){const l=this.getRenderableIds(n).map(p=>this._tiles[p].tileID);return this.transform&&this.transform.populateCache(l),l}hasTransition(){if(this._source.hasTransition())return!0;if(j(this._source.type)){const n=F.now();for(const l in this._tiles)if(this._tiles[l].fadeEndTime>=n)return!0}return!1}setFeatureState(n,l,p){this._state.updateState(n=n||"_geojsonTileLayer",l,p)}removeFeatureState(n,l,p){this._state.removeFeatureState(n=n||"_geojsonTileLayer",l,p)}getFeatureState(n,l){return this._state.getState(n=n||"_geojsonTileLayer",l)}setDependencies(n,l,p){const g=this._tiles[n];g&&g.setDependencies(l,p)}reloadTilesForDependencies(n,l){for(const p in this._tiles)this._tiles[p].hasDependency(n,l)&&this._reloadTile(p,"reloading");this._cache.filter(p=>!p.hasDependency(n,l))}}function q(_,n){const l=Math.abs(2*_.wrap)-+(_.wrap<0),p=Math.abs(2*n.wrap)-+(n.wrap<0);return _.overscaledZ-n.overscaledZ||p-l||n.canonical.y-_.canonical.y||n.canonical.x-_.canonical.x}function j(_){return _==="raster"||_==="image"||_==="video"}Z.maxOverzooming=10,Z.maxUnderzooming=3;class le{constructor(n,l){this.reset(n,l)}reset(n,l){this.points=n||[],this._distances=[0];for(let p=1;p<this.points.length;p++)this._distances[p]=this._distances[p-1]+this.points[p].dist(this.points[p-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(l||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(n){if(this.points.length===1)return this.points[0];n=a.ae(n,0,1);let l=1,p=this._distances[l];const g=n*this.paddedLength+this.padding;for(;p<g&&l<this._distances.length;)p=this._distances[++l];const x=l-1,w=this._distances[x],P=p-w,I=P>0?(g-w)/P:0;return this.points[x].mult(1-I).add(this.points[l].mult(I))}}function ye(_,n){let l=!0;return _==="always"||_!=="never"&&n!=="never"||(l=!1),l}class _e{constructor(n,l,p){const g=this.boxCells=[],x=this.circleCells=[];this.xCellCount=Math.ceil(n/p),this.yCellCount=Math.ceil(l/p);for(let w=0;w<this.xCellCount*this.yCellCount;w++)g.push([]),x.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=n,this.height=l,this.xScale=this.xCellCount/n,this.yScale=this.yCellCount/l,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(n,l,p,g,x){this._forEachCell(l,p,g,x,this._insertBoxCell,this.boxUid++),this.boxKeys.push(n),this.bboxes.push(l),this.bboxes.push(p),this.bboxes.push(g),this.bboxes.push(x)}insertCircle(n,l,p,g){this._forEachCell(l-g,p-g,l+g,p+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(n),this.circles.push(l),this.circles.push(p),this.circles.push(g)}_insertBoxCell(n,l,p,g,x,w){this.boxCells[x].push(w)}_insertCircleCell(n,l,p,g,x,w){this.circleCells[x].push(w)}_query(n,l,p,g,x,w,P){if(p<0||n>this.width||g<0||l>this.height)return[];const I=[];if(n<=0&&l<=0&&this.width<=p&&this.height<=g){if(x)return[{key:null,x1:n,y1:l,x2:p,y2:g}];for(let R=0;R<this.boxKeys.length;R++)I.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const O=this.circles[3*R],N=this.circles[3*R+1],B=this.circles[3*R+2];I.push({key:this.circleKeys[R],x1:O-B,y1:N-B,x2:O+B,y2:N+B})}}else this._forEachCell(n,l,p,g,this._queryCell,I,{hitTest:x,overlapMode:w,seenUids:{box:{},circle:{}}},P);return I}query(n,l,p,g){return this._query(n,l,p,g,!1,null)}hitTest(n,l,p,g,x,w){return this._query(n,l,p,g,!0,x,w).length>0}hitTestCircle(n,l,p,g,x){const w=n-p,P=n+p,I=l-p,R=l+p;if(P<0||w>this.width||R<0||I>this.height)return!1;const O=[];return this._forEachCell(w,I,P,R,this._queryCellCircle,O,{hitTest:!0,overlapMode:g,circle:{x:n,y:l,radius:p},seenUids:{box:{},circle:{}}},x),O.length>0}_queryCell(n,l,p,g,x,w,P,I){const{seenUids:R,hitTest:O,overlapMode:N}=P,B=this.boxCells[x];if(B!==null){const X=this.bboxes;for(const te of B)if(!R.box[te]){R.box[te]=!0;const Q=4*te,ie=this.boxKeys[te];if(n<=X[Q+2]&&l<=X[Q+3]&&p>=X[Q+0]&&g>=X[Q+1]&&(!I||I(ie))&&(!O||!ye(N,ie.overlapMode))&&(w.push({key:ie,x1:X[Q],y1:X[Q+1],x2:X[Q+2],y2:X[Q+3]}),O))return!0}}const W=this.circleCells[x];if(W!==null){const X=this.circles;for(const te of W)if(!R.circle[te]){R.circle[te]=!0;const Q=3*te,ie=this.circleKeys[te];if(this._circleAndRectCollide(X[Q],X[Q+1],X[Q+2],n,l,p,g)&&(!I||I(ie))&&(!O||!ye(N,ie.overlapMode))){const se=X[Q],ue=X[Q+1],fe=X[Q+2];if(w.push({key:ie,x1:se-fe,y1:ue-fe,x2:se+fe,y2:ue+fe}),O)return!0}}}return!1}_queryCellCircle(n,l,p,g,x,w,P,I){const{circle:R,seenUids:O,overlapMode:N}=P,B=this.boxCells[x];if(B!==null){const X=this.bboxes;for(const te of B)if(!O.box[te]){O.box[te]=!0;const Q=4*te,ie=this.boxKeys[te];if(this._circleAndRectCollide(R.x,R.y,R.radius,X[Q+0],X[Q+1],X[Q+2],X[Q+3])&&(!I||I(ie))&&!ye(N,ie.overlapMode))return w.push(!0),!0}}const W=this.circleCells[x];if(W!==null){const X=this.circles;for(const te of W)if(!O.circle[te]){O.circle[te]=!0;const Q=3*te,ie=this.circleKeys[te];if(this._circlesCollide(X[Q],X[Q+1],X[Q+2],R.x,R.y,R.radius)&&(!I||I(ie))&&!ye(N,ie.overlapMode))return w.push(!0),!0}}}_forEachCell(n,l,p,g,x,w,P,I){const R=this._convertToXCellCoord(n),O=this._convertToYCellCoord(l),N=this._convertToXCellCoord(p),B=this._convertToYCellCoord(g);for(let W=R;W<=N;W++)for(let X=O;X<=B;X++)if(x.call(this,n,l,p,g,this.xCellCount*X+W,w,P,I))return}_convertToXCellCoord(n){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(n*this.xScale)))}_convertToYCellCoord(n){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(n*this.yScale)))}_circlesCollide(n,l,p,g,x,w){const P=g-n,I=x-l,R=p+w;return R*R>P*P+I*I}_circleAndRectCollide(n,l,p,g,x,w,P){const I=(w-g)/2,R=Math.abs(n-(g+I));if(R>I+p)return!1;const O=(P-x)/2,N=Math.abs(l-(x+O));if(N>O+p)return!1;if(R<=I||N<=O)return!0;const B=R-I,W=N-O;return B*B+W*W<=p*p}}function Re(_,n,l){const p=a.K();if(!_){const{vecSouth:N,vecEast:B}=$e(n),W=T();W[0]=B[0],W[1]=B[1],W[2]=N[0],W[3]=N[1],g=W,(O=(w=(x=W)[0])*(R=x[3])-(I=x[2])*(P=x[1]))&&(g[0]=R*(O=1/O),g[1]=-P*O,g[2]=-I*O,g[3]=w*O),p[0]=W[0],p[1]=W[1],p[4]=W[2],p[5]=W[3]}var g,x,w,P,I,R,O;return a.M(p,p,[1/l,1/l,1]),p}function be(_,n,l,p){if(_){const g=a.K();if(!n){const{vecSouth:x,vecEast:w}=$e(l);g[0]=w[0],g[1]=w[1],g[4]=x[0],g[5]=x[1]}return a.M(g,g,[p,p,1]),g}return l.pixelsToClipSpaceMatrix}function $e(_){const n=Math.cos(_.rollInRadians),l=Math.sin(_.rollInRadians),p=Math.cos(_.pitchInRadians),g=Math.cos(_.bearingInRadians),x=Math.sin(_.bearingInRadians),w=a.ak();w[0]=-g*p*l-x*n,w[1]=-x*p*l+g*n;const P=a.al(w);P<1e-9?a.am(w):a.an(w,w,1/P);const I=a.ak();I[0]=g*p*n-x*l,I[1]=x*p*n+g*l;const R=a.al(I);return R<1e-9?a.am(I):a.an(I,I,1/R),{vecEast:I,vecSouth:w}}function ze(_,n,l,p){let g;p?(g=[_,n,p(_,n),1],a.ap(g,g,l)):(g=[_,n,0,1],Gi(g,g,l));const x=g[3];return{point:new a.P(g[0]/x,g[1]/x),signedDistanceFromCamera:x,isOccluded:!1}}function Ie(_,n){return .5+_/n*.5}function Ge(_,n){return _.x>=-n[0]&&_.x<=n[0]&&_.y>=-n[1]&&_.y<=n[1]}function ht(_,n,l,p,g,x,w,P,I,R,O,N,B){const W=l?_.textSizeData:_.iconSizeData,X=a.ag(W,n.transform.zoom),te=[256/n.width*2+1,256/n.height*2+1],Q=l?_.text.dynamicLayoutVertexArray:_.icon.dynamicLayoutVertexArray;Q.clear();const ie=_.lineVertexArray,se=l?_.text.placedSymbolArray:_.icon.placedSymbolArray,ue=n.transform.width/n.transform.height;let fe=!1;for(let de=0;de<se.length;de++){const ve=se.get(de);if(ve.hidden||ve.writingMode===a.ah.vertical&&!fe){Rt(ve.numGlyphs,Q);continue}fe=!1;const ge=new a.P(ve.anchorX,ve.anchorY),De={getElevation:B,pitchedLabelPlaneMatrix:p,lineVertexArray:ie,pitchWithMap:x,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:n.transform,tileAnchorPoint:ge,unwrappedTileID:I,width:R,height:O,translation:N},ke=vt(ve.anchorX,ve.anchorY,De);if(!Ge(ke.point,te)){Rt(ve.numGlyphs,Q);continue}const We=Ie(n.transform.cameraToCenterDistance,ke.signedDistanceFromCamera),Ze=a.ai(W,X,ve),je=x?Ze*n.transform.getPitchedTextCorrection(ve.anchorX,ve.anchorY,I)/We:Ze*We,lt=Ft({projectionContext:De,pitchedLabelPlaneMatrixInverse:g,symbol:ve,fontSize:je,flip:!1,keepUpright:w,glyphOffsetArray:_.glyphOffsetArray,dynamicLayoutVertexArray:Q,aspectRatio:ue,rotateToLine:P});fe=lt.useVertical,(lt.notEnoughRoom||fe||lt.needsFlipping&&Ft({projectionContext:De,pitchedLabelPlaneMatrixInverse:g,symbol:ve,fontSize:je,flip:!0,keepUpright:w,glyphOffsetArray:_.glyphOffsetArray,dynamicLayoutVertexArray:Q,aspectRatio:ue,rotateToLine:P}).notEnoughRoom)&&Rt(ve.numGlyphs,Q)}l?_.text.dynamicLayoutVertexBuffer.updateData(Q):_.icon.dynamicLayoutVertexBuffer.updateData(Q)}function dt(_,n,l,p,g,x,w,P){const I=x.glyphStartIndex+x.numGlyphs,R=x.lineStartIndex,O=x.lineStartIndex+x.lineLength,N=n.getoffsetX(x.glyphStartIndex),B=n.getoffsetX(I-1),W=Mi(_*N,l,p,g,x.segment,R,O,P,w);if(!W)return null;const X=Mi(_*B,l,p,g,x.segment,R,O,P,w);return X?P.projectionCache.anyProjectionOccluded?null:{first:W,last:X}:null}function Ue(_,n,l,p){return _===a.ah.horizontal&&Math.abs(l.y-n.y)>Math.abs(l.x-n.x)*p?{useVertical:!0}:(_===a.ah.vertical?n.y<l.y:n.x>l.x)?{needsFlipping:!0}:null}function Ft(_){const{projectionContext:n,pitchedLabelPlaneMatrixInverse:l,symbol:p,fontSize:g,flip:x,keepUpright:w,glyphOffsetArray:P,dynamicLayoutVertexArray:I,aspectRatio:R,rotateToLine:O}=_,N=g/24,B=p.lineOffsetX*N,W=p.lineOffsetY*N;let X;if(p.numGlyphs>1){const te=p.glyphStartIndex+p.numGlyphs,Q=p.lineStartIndex,ie=p.lineStartIndex+p.lineLength,se=dt(N,P,B,W,x,p,O,n);if(!se)return{notEnoughRoom:!0};const ue=et(se.first.point.x,se.first.point.y,n,l),fe=et(se.last.point.x,se.last.point.y,n,l);if(w&&!x){const de=Ue(p.writingMode,ue,fe,R);if(de)return de}X=[se.first];for(let de=p.glyphStartIndex+1;de<te-1;de++)X.push(Mi(N*P.getoffsetX(de),B,W,x,p.segment,Q,ie,n,O));X.push(se.last)}else{if(w&&!x){const Q=Kt(n.tileAnchorPoint.x,n.tileAnchorPoint.y,n).point,ie=p.lineStartIndex+p.segment+1,se=new a.P(n.lineVertexArray.getx(ie),n.lineVertexArray.gety(ie)),ue=Kt(se.x,se.y,n),fe=ue.signedDistanceFromCamera>0?ue.point:Et(n.tileAnchorPoint,se,Q,1,n),de=et(Q.x,Q.y,n,l),ve=et(fe.x,fe.y,n,l),ge=Ue(p.writingMode,de,ve,R);if(ge)return ge}const te=Mi(N*P.getoffsetX(p.glyphStartIndex),B,W,x,p.segment,p.lineStartIndex,p.lineStartIndex+p.lineLength,n,O);if(!te||n.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};X=[te]}for(const te of X)a.ao(I,te.point,te.angle);return{}}function Et(_,n,l,p,g){const x=_.add(_.sub(n)._unit()),w=Kt(x.x,x.y,g).point,P=l.sub(w);return l.add(P._mult(p/P.mag()))}function Ot(_,n,l){const p=n.projectionCache;if(p.projections[_])return p.projections[_];const g=new a.P(n.lineVertexArray.getx(_),n.lineVertexArray.gety(_)),x=Kt(g.x,g.y,n);if(x.signedDistanceFromCamera>0)return p.projections[_]=x.point,p.anyProjectionOccluded=p.anyProjectionOccluded||x.isOccluded,x.point;const w=_-l.direction;return Et(l.distanceFromAnchor===0?n.tileAnchorPoint:new a.P(n.lineVertexArray.getx(w),n.lineVertexArray.gety(w)),g,l.previousVertex,l.absOffsetX-l.distanceFromAnchor+1,n)}function Kt(_,n,l){const p=_+l.translation[0],g=n+l.translation[1];let x;return l.pitchWithMap?(x=ze(p,g,l.pitchedLabelPlaneMatrix,l.getElevation),x.isOccluded=!1):(x=l.transform.projectTileCoordinates(p,g,l.unwrappedTileID,l.getElevation),x.point.x=(.5*x.point.x+.5)*l.width,x.point.y=(.5*-x.point.y+.5)*l.height),x}function et(_,n,l,p){if(l.pitchWithMap){const g=[_,n,0,1];return a.ap(g,g,p),l.transform.projectTileCoordinates(g[0]/g[3],g[1]/g[3],l.unwrappedTileID,l.getElevation).point}return{x:_/l.width*2-1,y:n/l.height*2-1}}function vt(_,n,l){return l.transform.projectTileCoordinates(_,n,l.unwrappedTileID,l.getElevation)}function ct(_,n,l){return _._unit()._perp()._mult(n*l)}function zt(_,n,l,p,g,x,w,P,I){if(P.projectionCache.offsets[_])return P.projectionCache.offsets[_];const R=l.add(n);if(_+I.direction<p||_+I.direction>=g)return P.projectionCache.offsets[_]=R,R;const O=Ot(_+I.direction,P,I),N=ct(O.sub(l),w,I.direction),B=l.add(N),W=O.add(N);return P.projectionCache.offsets[_]=a.aq(x,R,B,W)||R,P.projectionCache.offsets[_]}function Mi(_,n,l,p,g,x,w,P,I){const R=p?_-n:_+n;let O=R>0?1:-1,N=0;p&&(O*=-1,N=Math.PI),O<0&&(N+=Math.PI);let B,W=O>0?x+g:x+g+1;P.projectionCache.cachedAnchorPoint?B=P.projectionCache.cachedAnchorPoint:(B=Kt(P.tileAnchorPoint.x,P.tileAnchorPoint.y,P).point,P.projectionCache.cachedAnchorPoint=B);let X,te,Q=B,ie=B,se=0,ue=0;const fe=Math.abs(R),de=[];let ve;for(;se+ue<=fe;){if(W+=O,W<x||W>=w)return null;se+=ue,ie=Q,te=X;const ke={absOffsetX:fe,direction:O,distanceFromAnchor:se,previousVertex:ie};if(Q=Ot(W,P,ke),l===0)de.push(ie),ve=Q.sub(ie);else{let We;const Ze=Q.sub(ie);We=Ze.mag()===0?ct(Ot(W+O,P,ke).sub(Q),l,O):ct(Ze,l,O),te||(te=ie.add(We)),X=zt(W,We,Q,x,w,te,l,P,ke),de.push(te),ve=X.sub(te)}ue=ve.mag()}const ge=ve._mult((fe-se)/ue)._add(te||ie),De=N+Math.atan2(Q.y-ie.y,Q.x-ie.x);return de.push(ge),{point:ge,angle:I?De:0,path:de}}const kn=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Rt(_,n){for(let l=0;l<_;l++){const p=n.length;n.resize(p+4),n.float32.set(kn,3*p)}}function Gi(_,n,l){const p=n[0],g=n[1];return _[0]=l[0]*p+l[4]*g+l[12],_[1]=l[1]*p+l[5]*g+l[13],_[3]=l[3]*p+l[7]*g+l[15],_}const mi=100;class el{constructor(n,l=new _e(n.width+200,n.height+200,25),p=new _e(n.width+200,n.height+200,25)){this.transform=n,this.grid=l,this.ignoredGrid=p,this.pitchFactor=Math.cos(n.pitch*Math.PI/180)*n.cameraToCenterDistance,this.screenRightBoundary=n.width+mi,this.screenBottomBoundary=n.height+mi,this.gridRightBoundary=n.width+200,this.gridBottomBoundary=n.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(n,l,p,g,x,w,P,I,R,O,N,B){const W=this.projectAndGetPerspectiveRatio(n.anchorPointX+I[0],n.anchorPointY+I[1],x,O,B),X=p*W.perspectiveRatio;let te;if(w||P)te=this._projectCollisionBox(n,X,g,x,w,P,I,W,O,N,B);else{const ve=W.x+(N?N.x*X:0),ge=W.y+(N?N.y*X:0);te={allPointsOccluded:!1,box:[ve+n.x1*X,ge+n.y1*X,ve+n.x2*X,ge+n.y2*X]}}const[Q,ie,se,ue]=te.box,fe=w?te.allPointsOccluded:W.isOccluded;let de=fe;return de||(de=W.perspectiveRatio<this.perspectiveRatioCutoff),de||(de=!this.isInsideGrid(Q,ie,se,ue)),de||l!=="always"&&this.grid.hitTest(Q,ie,se,ue,l,R)?{box:[Q,ie,se,ue],placeable:!1,offscreen:!1,occluded:fe}:{box:[Q,ie,se,ue],placeable:!0,offscreen:this.isOffscreen(Q,ie,se,ue),occluded:fe}}placeCollisionCircles(n,l,p,g,x,w,P,I,R,O,N,B,W,X){const te=[],Q=new a.P(l.anchorX,l.anchorY),ie=this.getPerspectiveRatio(Q.x,Q.y,w,X),se=(R?x*this.transform.getPitchedTextCorrection(l.anchorX,l.anchorY,w)/ie:x*ie)/a.av,ue={getElevation:X,pitchedLabelPlaneMatrix:P,lineVertexArray:p,pitchWithMap:R,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:Q,unwrappedTileID:w,width:this.transform.width,height:this.transform.height,translation:W},fe=dt(se,g,l.lineOffsetX*se,l.lineOffsetY*se,!1,l,!1,ue);let de=!1,ve=!1,ge=!0;if(fe){const De=.5*N*ie+B,ke=new a.P(-100,-100),We=new a.P(this.screenRightBoundary,this.screenBottomBoundary),Ze=new le,je=fe.first,lt=fe.last;let at=[];for(let Ut=je.path.length-1;Ut>=1;Ut--)at.push(je.path[Ut]);for(let Ut=1;Ut<lt.path.length;Ut++)at.push(lt.path[Ut]);const qe=2.5*De;if(R){const Ut=this.projectPathToScreenSpace(at,ue);at=Ut.some(ni=>ni.signedDistanceFromCamera<=0)?[]:Ut.map(ni=>ni.point)}let bt=[];if(at.length>0){const Ut=at[0].clone(),ni=at[0].clone();for(let jt=1;jt<at.length;jt++)Ut.x=Math.min(Ut.x,at[jt].x),Ut.y=Math.min(Ut.y,at[jt].y),ni.x=Math.max(ni.x,at[jt].x),ni.y=Math.max(ni.y,at[jt].y);bt=Ut.x>=ke.x&&ni.x<=We.x&&Ut.y>=ke.y&&ni.y<=We.y?[at]:ni.x<ke.x||Ut.x>We.x||ni.y<ke.y||Ut.y>We.y?[]:a.ar([at],ke.x,ke.y,We.x,We.y)}for(const Ut of bt){Ze.reset(Ut,.25*De);let ni=0;ni=Ze.length<=.5*De?1:Math.ceil(Ze.paddedLength/qe)+1;for(let jt=0;jt<ni;jt++){const ui=jt/Math.max(ni-1,1),gi=Ze.lerp(ui),xi=gi.x+mi,ci=gi.y+mi;te.push(xi,ci,De,0);const hi=xi-De,Ui=ci-De,Ki=xi+De,tr=ci+De;if(ge=ge&&this.isOffscreen(hi,Ui,Ki,tr),ve=ve||this.isInsideGrid(hi,Ui,Ki,tr),n!=="always"&&this.grid.hitTestCircle(xi,ci,De,n,O)&&(de=!0,!I))return{circles:[],offscreen:!1,collisionDetected:de}}}}return{circles:!I&&de||!ve||ie<this.perspectiveRatioCutoff?[]:te,offscreen:ge,collisionDetected:de}}projectPathToScreenSpace(n,l){const p=function(g,x){const w=a.K();return a.aj(w,x.pitchedLabelPlaneMatrix),g.map(P=>{const I=ze(P.x,P.y,w,x.getElevation),R=x.transform.projectTileCoordinates(I.point.x,I.point.y,x.unwrappedTileID,x.getElevation);return R.point.x=(.5*R.point.x+.5)*x.width,R.point.y=(.5*-R.point.y+.5)*x.height,R})}(n,l);return function(g){let x=0,w=0,P=0,I=0;for(let R=0;R<g.length;R++)g[R].isOccluded?(P=R+1,I=0):(I++,I>w&&(w=I,x=P));return g.slice(x,x+w)}(p)}queryRenderedSymbols(n){if(n.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const l=[];let p=1/0,g=1/0,x=-1/0,w=-1/0;for(const O of n){const N=new a.P(O.x+mi,O.y+mi);p=Math.min(p,N.x),g=Math.min(g,N.y),x=Math.max(x,N.x),w=Math.max(w,N.y),l.push(N)}const P=this.grid.query(p,g,x,w).concat(this.ignoredGrid.query(p,g,x,w)),I={},R={};for(const O of P){const N=O.key;if(I[N.bucketInstanceId]===void 0&&(I[N.bucketInstanceId]={}),I[N.bucketInstanceId][N.featureIndex])continue;const B=[new a.P(O.x1,O.y1),new a.P(O.x2,O.y1),new a.P(O.x2,O.y2),new a.P(O.x1,O.y2)];a.as(l,B)&&(I[N.bucketInstanceId][N.featureIndex]=!0,R[N.bucketInstanceId]===void 0&&(R[N.bucketInstanceId]=[]),R[N.bucketInstanceId].push(N.featureIndex))}return R}insertCollisionBox(n,l,p,g,x,w){(p?this.ignoredGrid:this.grid).insert({bucketInstanceId:g,featureIndex:x,collisionGroupID:w,overlapMode:l},n[0],n[1],n[2],n[3])}insertCollisionCircles(n,l,p,g,x,w){const P=p?this.ignoredGrid:this.grid,I={bucketInstanceId:g,featureIndex:x,collisionGroupID:w,overlapMode:l};for(let R=0;R<n.length;R+=4)P.insertCircle(I,n[R],n[R+1],n[R+2])}projectAndGetPerspectiveRatio(n,l,p,g,x){if(x){let w;g?(w=[n,l,g(n,l),1],a.ap(w,w,x)):(w=[n,l,0,1],Gi(w,w,x));const P=w[3];return{x:(w[0]/P+1)/2*this.transform.width+mi,y:(-w[1]/P+1)/2*this.transform.height+mi,perspectiveRatio:.5+this.transform.cameraToCenterDistance/P*.5,isOccluded:!1,signedDistanceFromCamera:P}}{const w=this.transform.projectTileCoordinates(n,l,p,g);return{x:(w.point.x+1)/2*this.transform.width+mi,y:(1-w.point.y)/2*this.transform.height+mi,perspectiveRatio:.5+this.transform.cameraToCenterDistance/w.signedDistanceFromCamera*.5,isOccluded:w.isOccluded,signedDistanceFromCamera:w.signedDistanceFromCamera}}}getPerspectiveRatio(n,l,p,g){const x=this.transform.projectTileCoordinates(n,l,p,g);return .5+this.transform.cameraToCenterDistance/x.signedDistanceFromCamera*.5}isOffscreen(n,l,p,g){return p<mi||n>=this.screenRightBoundary||g<mi||l>this.screenBottomBoundary}isInsideGrid(n,l,p,g){return p>=0&&n<this.gridRightBoundary&&g>=0&&l<this.gridBottomBoundary}getViewportMatrix(){const n=a.at([]);return a.L(n,n,[-100,-100,0]),n}_projectCollisionBox(n,l,p,g,x,w,P,I,R,O,N){let B=1,W=0,X=0,te=1;const Q=n.anchorPointX+P[0],ie=n.anchorPointY+P[1];if(w&&!x){const at=this.projectAndGetPerspectiveRatio(Q+1,ie,g,R,N),qe=at.x-I.x,bt=Math.atan((at.y-I.y)/qe)+(qe<0?Math.PI:0),Ut=Math.sin(bt),ni=Math.cos(bt);B=ni,W=Ut,X=-Ut,te=ni}else if(!w&&x){const at=$e(this.transform);B=at.vecEast[0],W=at.vecEast[1],X=at.vecSouth[0],te=at.vecSouth[1]}let se=I.x,ue=I.y,fe=l;x&&(se=Q,ue=ie,fe=Math.pow(2,-(this.transform.zoom-p.overscaledZ)),fe*=this.transform.getPitchedTextCorrection(Q,ie,g),O||(fe*=a.ae(.5+I.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),O&&(se+=B*O.x*fe+X*O.y*fe,ue+=W*O.x*fe+te*O.y*fe);const de=n.x1*fe,ve=n.x2*fe,ge=(de+ve)/2,De=n.y1*fe,ke=n.y2*fe,We=(De+ke)/2,Ze=[{offsetX:de,offsetY:De},{offsetX:ge,offsetY:De},{offsetX:ve,offsetY:De},{offsetX:ve,offsetY:We},{offsetX:ve,offsetY:ke},{offsetX:ge,offsetY:ke},{offsetX:de,offsetY:ke},{offsetX:de,offsetY:We}];let je=[];for(const{offsetX:at,offsetY:qe}of Ze)je.push(new a.P(se+B*at+X*qe,ue+W*at+te*qe));let lt=!1;if(x){const at=je.map(qe=>this.projectAndGetPerspectiveRatio(qe.x,qe.y,g,R,N));lt=at.some(qe=>!qe.isOccluded),je=at.map(qe=>new a.P(qe.x,qe.y))}else lt=!0;return{box:a.au(je),allPointsOccluded:!lt}}}class so{constructor(n,l,p,g){this.opacity=n?Math.max(0,Math.min(1,n.opacity+(n.placed?l:-l))):g&&p?1:0,this.placed=p}isHidden(){return this.opacity===0&&!this.placed}}class is{constructor(n,l,p,g,x){this.text=new so(n?n.text:null,l,p,x),this.icon=new so(n?n.icon:null,l,g,x)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Ir{constructor(n,l,p){this.text=n,this.icon=l,this.skipFade=p}}class Ii{constructor(n,l,p,g,x){this.bucketInstanceId=n,this.featureIndex=l,this.sourceLayerIndex=p,this.bucketIndex=g,this.tileID=x}}class zp{constructor(n){this.crossSourceCollisions=n,this.maxGroupID=0,this.collisionGroups={}}get(n){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[n]){const l=++this.maxGroupID;this.collisionGroups[n]={ID:l,predicate:p=>p.collisionGroupID===l}}return this.collisionGroups[n]}}function oo(_,n,l,p,g){const{horizontalAlign:x,verticalAlign:w}=a.aB(_);return new a.P(-(x-.5)*n+p[0]*g,-(w-.5)*l+p[1]*g)}class Ec{constructor(n,l,p,g,x){this.transform=n.clone(),this.terrain=l,this.collisionIndex=new el(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=p,this.retainedQueryData={},this.collisionGroups=new zp(g),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=x,x&&(x.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(n){const l=this.terrain;return l?(p,g)=>l.getElevation(n,p,g):null}getBucketParts(n,l,p,g){const x=p.getBucket(l),w=p.latestFeatureIndex;if(!x||!w||l.id!==x.layerIds[0])return;const P=p.collisionBoxArray,I=x.layers[0].layout,R=x.layers[0].paint,O=Math.pow(2,this.transform.zoom-p.tileID.overscaledZ),N=p.tileSize/a.Z,B=p.tileID.toUnwrapped(),W=I.get("text-rotation-alignment")==="map",X=a.aw(p,1,this.transform.zoom),te=a.ax(this.collisionIndex.transform,p,R.get("text-translate"),R.get("text-translate-anchor")),Q=a.ax(this.collisionIndex.transform,p,R.get("icon-translate"),R.get("icon-translate-anchor")),ie=Re(W,this.transform,X);this.retainedQueryData[x.bucketInstanceId]=new Ii(x.bucketInstanceId,w,x.sourceLayerIndex,x.index,p.tileID);const se={bucket:x,layout:I,translationText:te,translationIcon:Q,unwrappedTileID:B,pitchedLabelPlaneMatrix:ie,scale:O,textPixelRatio:N,holdingForFade:p.holdingForFade(),collisionBoxArray:P,partiallyEvaluatedTextSize:a.ag(x.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(x.sourceID)};if(g)for(const ue of x.sortKeyRanges){const{sortKey:fe,symbolInstanceStart:de,symbolInstanceEnd:ve}=ue;n.push({sortKey:fe,symbolInstanceStart:de,symbolInstanceEnd:ve,parameters:se})}else n.push({symbolInstanceStart:0,symbolInstanceEnd:x.symbolInstances.length,parameters:se})}attemptAnchorPlacement(n,l,p,g,x,w,P,I,R,O,N,B,W,X,te,Q,ie,se,ue,fe){const de=a.ay[n.textAnchor],ve=[n.textOffset0,n.textOffset1],ge=oo(de,p,g,ve,x),De=this.collisionIndex.placeCollisionBox(l,B,I,R,O,P,w,Q,N.predicate,ue,ge,fe);if((!se||this.collisionIndex.placeCollisionBox(se,B,I,R,O,P,w,ie,N.predicate,ue,ge,fe).placeable)&&De.placeable){let ke;if(this.prevPlacement&&this.prevPlacement.variableOffsets[W.crossTileID]&&this.prevPlacement.placements[W.crossTileID]&&this.prevPlacement.placements[W.crossTileID].text&&(ke=this.prevPlacement.variableOffsets[W.crossTileID].anchor),W.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[W.crossTileID]={textOffset:ve,width:p,height:g,anchor:de,textBoxScale:x,prevAnchor:ke},this.markUsedJustification(X,de,W,te),X.allowVerticalPlacement&&(this.markUsedOrientation(X,te,W),this.placedOrientations[W.crossTileID]=te),{shift:ge,placedGlyphBoxes:De}}}placeLayerBucketPart(n,l,p){const{bucket:g,layout:x,translationText:w,translationIcon:P,unwrappedTileID:I,pitchedLabelPlaneMatrix:R,textPixelRatio:O,holdingForFade:N,collisionBoxArray:B,partiallyEvaluatedTextSize:W,collisionGroup:X}=n.parameters,te=x.get("text-optional"),Q=x.get("icon-optional"),ie=a.az(x,"text-overlap","text-allow-overlap"),se=ie==="always",ue=a.az(x,"icon-overlap","icon-allow-overlap"),fe=ue==="always",de=x.get("text-rotation-alignment")==="map",ve=x.get("text-pitch-alignment")==="map",ge=x.get("icon-text-fit")!=="none",De=x.get("symbol-z-order")==="viewport-y",ke=se&&(fe||!g.hasIconData()||Q),We=fe&&(se||!g.hasTextData()||te);!g.collisionArrays&&B&&g.deserializeCollisionBoxes(B);const Ze=this.retainedQueryData[g.bucketInstanceId].tileID,je=this._getTerrainElevationFunc(Ze),lt=this.transform.getFastPathSimpleProjectionMatrix(Ze),at=(qe,bt,Ut)=>{var ni,jt;if(l[qe.crossTileID])return;if(N)return void(this.placements[qe.crossTileID]=new Ir(!1,!1,!1));let ui=!1,gi=!1,xi=!0,ci=null,hi={box:null,placeable:!1,offscreen:null,occluded:!1},Ui={placeable:!1},Ki=null,tr=null,Dr=null,Bn=0,vn=0,ls=0;bt.textFeatureIndex?Bn=bt.textFeatureIndex:qe.useRuntimeCollisionCircles&&(Bn=qe.featureIndex),bt.verticalTextFeatureIndex&&(vn=bt.verticalTextFeatureIndex);const cs=bt.textBox;if(cs){const Ur=ki=>{let Di=a.ah.horizontal;if(g.allowVerticalPlacement&&!ki&&this.prevPlacement){const Wi=this.prevPlacement.placedOrientations[qe.crossTileID];Wi&&(this.placedOrientations[qe.crossTileID]=Wi,Di=Wi,this.markUsedOrientation(g,Di,qe))}return Di},zn=(ki,Di)=>{if(g.allowVerticalPlacement&&qe.numVerticalGlyphVertices>0&&bt.verticalTextBox){for(const Wi of g.writingModes)if(Wi===a.ah.vertical?(hi=Di(),Ui=hi):hi=ki(),hi&&hi.placeable)break}else hi=ki()},Ws=qe.textAnchorOffsetStartIndex,Hs=qe.textAnchorOffsetEndIndex;if(Hs===Ws){const ki=(Di,Wi)=>{const di=this.collisionIndex.placeCollisionBox(Di,ie,O,Ze,I,ve,de,w,X.predicate,je,void 0,lt);return di&&di.placeable&&(this.markUsedOrientation(g,Wi,qe),this.placedOrientations[qe.crossTileID]=Wi),di};zn(()=>ki(cs,a.ah.horizontal),()=>{const Di=bt.verticalTextBox;return g.allowVerticalPlacement&&qe.numVerticalGlyphVertices>0&&Di?ki(Di,a.ah.vertical):{box:null,offscreen:null}}),Ur(hi&&hi.placeable)}else{let ki=a.ay[(jt=(ni=this.prevPlacement)===null||ni===void 0?void 0:ni.variableOffsets[qe.crossTileID])===null||jt===void 0?void 0:jt.anchor];const Di=(di,us,Af)=>{const Zs=di.x2-di.x1,cg=di.y2-di.y1,Pf=qe.textBoxScale,_u=ge&&ue==="never"?us:null;let hs=null,fs=ie==="never"?1:2,ds="never";ki&&fs++;for(let yu=0;yu<fs;yu++){for(let xu=Ws;xu<Hs;xu++){const Ol=g.textAnchorOffsets.get(xu);if(ki&&Ol.textAnchor!==ki)continue;const Fl=this.attemptAnchorPlacement(Ol,di,Zs,cg,Pf,de,ve,O,Ze,I,X,ds,qe,g,Af,w,P,_u,je);if(Fl&&(hs=Fl.placedGlyphBoxes,hs&&hs.placeable))return ui=!0,ci=Fl.shift,hs}ki?ki=null:ds=ie}return p&&!hs&&(hs={box:this.collisionIndex.placeCollisionBox(cs,"always",O,Ze,I,ve,de,w,X.predicate,je,void 0,lt).box,offscreen:!1,placeable:!1,occluded:!1}),hs};zn(()=>Di(cs,bt.iconBox,a.ah.horizontal),()=>{const di=bt.verticalTextBox;return g.allowVerticalPlacement&&(!hi||!hi.placeable)&&qe.numVerticalGlyphVertices>0&&di?Di(di,bt.verticalIconBox,a.ah.vertical):{box:null,occluded:!0,offscreen:null}}),hi&&(ui=hi.placeable,xi=hi.offscreen);const Wi=Ur(hi&&hi.placeable);if(!ui&&this.prevPlacement){const di=this.prevPlacement.variableOffsets[qe.crossTileID];di&&(this.variableOffsets[qe.crossTileID]=di,this.markUsedJustification(g,di.anchor,qe,Wi))}}}if(Ki=hi,ui=Ki&&Ki.placeable,xi=Ki&&Ki.offscreen,qe.useRuntimeCollisionCircles){const Ur=g.text.placedSymbolArray.get(qe.centerJustifiedTextSymbolIndex),zn=a.ai(g.textSizeData,W,Ur),Ws=x.get("text-padding");tr=this.collisionIndex.placeCollisionCircles(ie,Ur,g.lineVertexArray,g.glyphOffsetArray,zn,I,R,p,ve,X.predicate,qe.collisionCircleDiameter,Ws,w,je),tr.circles.length&&tr.collisionDetected&&!p&&a.w("Collisions detected, but collision boxes are not shown"),ui=se||tr.circles.length>0&&!tr.collisionDetected,xi=xi&&tr.offscreen}if(bt.iconFeatureIndex&&(ls=bt.iconFeatureIndex),bt.iconBox){const Ur=zn=>this.collisionIndex.placeCollisionBox(zn,ue,O,Ze,I,ve,de,P,X.predicate,je,ge&&ci?ci:void 0,lt);Ui&&Ui.placeable&&bt.verticalIconBox?(Dr=Ur(bt.verticalIconBox),gi=Dr.placeable):(Dr=Ur(bt.iconBox),gi=Dr.placeable),xi=xi&&Dr.offscreen}const $s=te||qe.numHorizontalGlyphVertices===0&&qe.numVerticalGlyphVertices===0,bn=Q||qe.numIconVertices===0;$s||bn?bn?$s||(gi=gi&&ui):ui=gi&&ui:gi=ui=gi&&ui;const Nn=gi&&Dr.placeable;if(ui&&Ki.placeable&&this.collisionIndex.insertCollisionBox(Ki.box,ie,x.get("text-ignore-placement"),g.bucketInstanceId,Ui&&Ui.placeable&&vn?vn:Bn,X.ID),Nn&&this.collisionIndex.insertCollisionBox(Dr.box,ue,x.get("icon-ignore-placement"),g.bucketInstanceId,ls,X.ID),tr&&ui&&this.collisionIndex.insertCollisionCircles(tr.circles,ie,x.get("text-ignore-placement"),g.bucketInstanceId,Bn,X.ID),p&&this.storeCollisionData(g.bucketInstanceId,Ut,bt,Ki,Dr,tr),qe.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(g.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[qe.crossTileID]=new Ir((ui||ke)&&!(Ki!=null&&Ki.occluded),(gi||We)&&!(Dr!=null&&Dr.occluded),xi||g.justReloaded),l[qe.crossTileID]=!0};if(De){if(n.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const qe=g.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let bt=qe.length-1;bt>=0;--bt){const Ut=qe[bt];at(g.symbolInstances.get(Ut),g.collisionArrays[Ut],Ut)}}else for(let qe=n.symbolInstanceStart;qe<n.symbolInstanceEnd;qe++)at(g.symbolInstances.get(qe),g.collisionArrays[qe],qe);g.justReloaded=!1}storeCollisionData(n,l,p,g,x,w){if(p.textBox||p.iconBox){let P,I;this.collisionBoxArrays.has(n)?P=this.collisionBoxArrays.get(n):(P=new Map,this.collisionBoxArrays.set(n,P)),P.has(l)?I=P.get(l):(I={text:null,icon:null},P.set(l,I)),p.textBox&&(I.text=g.box),p.iconBox&&(I.icon=x.box)}if(w){let P=this.collisionCircleArrays[n];P===void 0&&(P=this.collisionCircleArrays[n]=[]);for(let I=0;I<w.circles.length;I+=4)P.push(w.circles[I+0]-mi),P.push(w.circles[I+1]-mi),P.push(w.circles[I+2]),P.push(w.collisionDetected?1:0)}}markUsedJustification(n,l,p,g){let x;x=g===a.ah.vertical?p.verticalPlacedTextSymbolIndex:{left:p.leftJustifiedTextSymbolIndex,center:p.centerJustifiedTextSymbolIndex,right:p.rightJustifiedTextSymbolIndex}[a.aA(l)];const w=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex,p.verticalPlacedTextSymbolIndex];for(const P of w)P>=0&&(n.text.placedSymbolArray.get(P).crossTileID=x>=0&&P!==x?0:p.crossTileID)}markUsedOrientation(n,l,p){const g=l===a.ah.horizontal||l===a.ah.horizontalOnly?l:0,x=l===a.ah.vertical?l:0,w=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex];for(const P of w)n.text.placedSymbolArray.get(P).placedOrientation=g;p.verticalPlacedTextSymbolIndex&&(n.text.placedSymbolArray.get(p.verticalPlacedTextSymbolIndex).placedOrientation=x)}commit(n){this.commitTime=n,this.zoomAtLastRecencyCheck=this.transform.zoom;const l=this.prevPlacement;let p=!1;this.prevZoomAdjustment=l?l.zoomAdjustment(this.transform.zoom):0;const g=l?l.symbolFadeChange(n):1,x=l?l.opacities:{},w=l?l.variableOffsets:{},P=l?l.placedOrientations:{};for(const I in this.placements){const R=this.placements[I],O=x[I];O?(this.opacities[I]=new is(O,g,R.text,R.icon),p=p||R.text!==O.text.placed||R.icon!==O.icon.placed):(this.opacities[I]=new is(null,g,R.text,R.icon,R.skipFade),p=p||R.text||R.icon)}for(const I in x){const R=x[I];if(!this.opacities[I]){const O=new is(R,g,!1,!1);O.isHidden()||(this.opacities[I]=O,p=p||R.text.placed||R.icon.placed)}}for(const I in w)this.variableOffsets[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.variableOffsets[I]=w[I]);for(const I in P)this.placedOrientations[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.placedOrientations[I]=P[I]);if(l&&l.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");p?this.lastPlacementChangeTime=n:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=l?l.lastPlacementChangeTime:n)}updateLayerOpacities(n,l){const p={};for(const g of l){const x=g.getBucket(n);x&&g.latestFeatureIndex&&n.id===x.layerIds[0]&&this.updateBucketOpacities(x,g.tileID,p,g.collisionBoxArray)}}updateBucketOpacities(n,l,p,g){n.hasTextData()&&(n.text.opacityVertexArray.clear(),n.text.hasVisibleVertices=!1),n.hasIconData()&&(n.icon.opacityVertexArray.clear(),n.icon.hasVisibleVertices=!1),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexArray.clear(),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexArray.clear();const x=n.layers[0],w=x.layout,P=new is(null,0,!1,!1,!0),I=w.get("text-allow-overlap"),R=w.get("icon-allow-overlap"),O=x._unevaluatedLayout.hasValue("text-variable-anchor")||x._unevaluatedLayout.hasValue("text-variable-anchor-offset"),N=w.get("text-rotation-alignment")==="map",B=w.get("text-pitch-alignment")==="map",W=w.get("icon-text-fit")!=="none",X=new is(null,0,I&&(R||!n.hasIconData()||w.get("icon-optional")),R&&(I||!n.hasTextData()||w.get("text-optional")),!0);!n.collisionArrays&&g&&(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData())&&n.deserializeCollisionBoxes(g);const te=(ie,se,ue)=>{for(let fe=0;fe<se/4;fe++)ie.opacityVertexArray.emplaceBack(ue);ie.hasVisibleVertices=ie.hasVisibleVertices||ue!==ra},Q=this.collisionBoxArrays.get(n.bucketInstanceId);for(let ie=0;ie<n.symbolInstances.length;ie++){const se=n.symbolInstances.get(ie),{numHorizontalGlyphVertices:ue,numVerticalGlyphVertices:fe,crossTileID:de}=se;let ve=this.opacities[de];p[de]?ve=P:ve||(ve=X,this.opacities[de]=ve),p[de]=!0;const ge=se.numIconVertices>0,De=this.placedOrientations[se.crossTileID],ke=De===a.ah.vertical,We=De===a.ah.horizontal||De===a.ah.horizontalOnly;if(ue>0||fe>0){const je=Rh(ve.text);te(n.text,ue,ke?ra:je),te(n.text,fe,We?ra:je);const lt=ve.text.isHidden();[se.rightJustifiedTextSymbolIndex,se.centerJustifiedTextSymbolIndex,se.leftJustifiedTextSymbolIndex].forEach(bt=>{bt>=0&&(n.text.placedSymbolArray.get(bt).hidden=lt||ke?1:0)}),se.verticalPlacedTextSymbolIndex>=0&&(n.text.placedSymbolArray.get(se.verticalPlacedTextSymbolIndex).hidden=lt||We?1:0);const at=this.variableOffsets[se.crossTileID];at&&this.markUsedJustification(n,at.anchor,se,De);const qe=this.placedOrientations[se.crossTileID];qe&&(this.markUsedJustification(n,"left",se,qe),this.markUsedOrientation(n,qe,se))}if(ge){const je=Rh(ve.icon),lt=!(W&&se.verticalPlacedIconSymbolIndex&&ke);se.placedIconSymbolIndex>=0&&(te(n.icon,se.numIconVertices,lt?je:ra),n.icon.placedSymbolArray.get(se.placedIconSymbolIndex).hidden=ve.icon.isHidden()),se.verticalPlacedIconSymbolIndex>=0&&(te(n.icon,se.numVerticalIconVertices,lt?ra:je),n.icon.placedSymbolArray.get(se.verticalPlacedIconSymbolIndex).hidden=ve.icon.isHidden())}const Ze=Q&&Q.has(ie)?Q.get(ie):{text:null,icon:null};if(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData()){const je=n.collisionArrays[ie];if(je){let lt=new a.P(0,0);if(je.textBox||je.verticalTextBox){let at=!0;if(O){const qe=this.variableOffsets[de];qe?(lt=oo(qe.anchor,qe.width,qe.height,qe.textOffset,qe.textBoxScale),N&&lt._rotate(B?-this.transform.bearingInRadians:this.transform.bearingInRadians)):at=!1}if(je.textBox||je.verticalTextBox){let qe;je.textBox&&(qe=ke),je.verticalTextBox&&(qe=We),rs(n.textCollisionBox.collisionVertexArray,ve.text.placed,!at||qe,Ze.text,lt.x,lt.y)}}if(je.iconBox||je.verticalIconBox){const at=!!(!We&&je.verticalIconBox);let qe;je.iconBox&&(qe=at),je.verticalIconBox&&(qe=!at),rs(n.iconCollisionBox.collisionVertexArray,ve.icon.placed,qe,Ze.icon,W?lt.x:0,W?lt.y:0)}}}}if(n.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[n.bucketInstanceId]&&(this.retainedQueryData[n.bucketInstanceId].featureSortOrder=n.featureSortOrder),n.hasTextData()&&n.text.opacityVertexBuffer&&n.text.opacityVertexBuffer.updateData(n.text.opacityVertexArray),n.hasIconData()&&n.icon.opacityVertexBuffer&&n.icon.opacityVertexBuffer.updateData(n.icon.opacityVertexArray),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexBuffer&&n.iconCollisionBox.collisionVertexBuffer.updateData(n.iconCollisionBox.collisionVertexArray),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexBuffer&&n.textCollisionBox.collisionVertexBuffer.updateData(n.textCollisionBox.collisionVertexArray),n.text.opacityVertexArray.length!==n.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${n.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${n.text.layoutVertexArray.length}) / 4`);if(n.icon.opacityVertexArray.length!==n.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${n.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${n.icon.layoutVertexArray.length}) / 4`);n.bucketInstanceId in this.collisionCircleArrays&&(n.collisionCircleArray=this.collisionCircleArrays[n.bucketInstanceId],delete this.collisionCircleArrays[n.bucketInstanceId])}symbolFadeChange(n){return this.fadeDuration===0?1:(n-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(n){return Math.max(0,(this.transform.zoom-n)/1.5)}hasTransitions(n){return this.stale||n-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(n,l){const p=this.zoomAtLastRecencyCheck===l?1-this.zoomAdjustment(l):1;return this.zoomAtLastRecencyCheck=l,this.commitTime+this.fadeDuration*p>n}setStale(){this.stale=!0}}function rs(_,n,l,p,g,x){p&&p.length!==0||(p=[0,0,0,0]);const w=p[0]-mi,P=p[1]-mi,I=p[2]-mi,R=p[3]-mi;_.emplaceBack(n?1:0,l?1:0,g||0,x||0,w,P),_.emplaceBack(n?1:0,l?1:0,g||0,x||0,I,P),_.emplaceBack(n?1:0,l?1:0,g||0,x||0,I,R),_.emplaceBack(n?1:0,l?1:0,g||0,x||0,w,R)}const ao=Math.pow(2,25),Eh=Math.pow(2,24),Ih=Math.pow(2,17),Ch=Math.pow(2,16),lo=Math.pow(2,9),Mh=Math.pow(2,8),Up=Math.pow(2,1);function Rh(_){if(_.opacity===0&&!_.placed)return 0;if(_.opacity===1&&_.placed)return 4294967295;const n=_.placed?1:0,l=Math.floor(127*_.opacity);return l*ao+n*Eh+l*Ih+n*Ch+l*lo+n*Mh+l*Up+n}const ra=0;class kh{constructor(n){this._sortAcrossTiles=n.layout.get("symbol-z-order")!=="viewport-y"&&!n.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(n,l,p,g,x){const w=this._bucketParts;for(;this._currentTileIndex<n.length;)if(l.getBucketParts(w,g,n[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,x())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,w.sort((P,I)=>P.sortKey-I.sortKey));this._currentPartIndex<w.length;)if(l.placeLayerBucketPart(w[this._currentPartIndex],this._seenCrossTileIDs,p),this._currentPartIndex++,x())return!0;return!1}}class Dh{constructor(n,l,p,g,x,w,P,I){this.placement=new Ec(n,l,w,P,I),this._currentPlacementIndex=p.length-1,this._forceFullPlacement=g,this._showCollisionBoxes=x,this._done=!1}isDone(){return this._done}continuePlacement(n,l,p){const g=F.now(),x=()=>!this._forceFullPlacement&&F.now()-g>2;for(;this._currentPlacementIndex>=0;){const w=l[n[this._currentPlacementIndex]],P=this.placement.collisionIndex.transform.zoom;if(w.type==="symbol"&&(!w.minzoom||w.minzoom<=P)&&(!w.maxzoom||w.maxzoom>P)){if(this._inProgressLayer||(this._inProgressLayer=new kh(w)),this._inProgressLayer.continuePlacement(p[w.source],this.placement,this._showCollisionBoxes,w,x))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(n){return this.placement.commit(n),this.placement}}const Is=512/a.Z/2;class Ic{constructor(n,l,p){this.tileID=n,this.bucketInstanceId=p,this._symbolsByKey={};const g=new Map;for(let x=0;x<l.length;x++){const w=l.get(x),P=w.key,I=g.get(P);I?I.push(w):g.set(P,[w])}for(const[x,w]of g){const P={positions:w.map(I=>({x:Math.floor(I.anchorX*Is),y:Math.floor(I.anchorY*Is)})),crossTileIDs:w.map(I=>I.crossTileID)};if(P.positions.length>128){const I=new a.aC(P.positions.length,16,Uint16Array);for(const{x:R,y:O}of P.positions)I.add(R,O);I.finish(),delete P.positions,P.index=I}this._symbolsByKey[x]=P}}getScaledCoordinates(n,l){const{x:p,y:g,z:x}=this.tileID.canonical,{x:w,y:P,z:I}=l.canonical,R=Is/Math.pow(2,I-x),O=(P*a.Z+n.anchorY)*R,N=g*a.Z*Is;return{x:Math.floor((w*a.Z+n.anchorX)*R-p*a.Z*Is),y:Math.floor(O-N)}}findMatches(n,l,p){const g=this.tileID.canonical.z<l.canonical.z?1:Math.pow(2,this.tileID.canonical.z-l.canonical.z);for(let x=0;x<n.length;x++){const w=n.get(x);if(w.crossTileID)continue;const P=this._symbolsByKey[w.key];if(!P)continue;const I=this.getScaledCoordinates(w,l);if(P.index){const R=P.index.range(I.x-g,I.y-g,I.x+g,I.y+g).sort();for(const O of R){const N=P.crossTileIDs[O];if(!p[N]){p[N]=!0,w.crossTileID=N;break}}}else if(P.positions)for(let R=0;R<P.positions.length;R++){const O=P.positions[R],N=P.crossTileIDs[R];if(Math.abs(O.x-I.x)<=g&&Math.abs(O.y-I.y)<=g&&!p[N]){p[N]=!0,w.crossTileID=N;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:n})=>n)}}class Oh{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Cc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(n){const l=Math.round((n-this.lng)/360);if(l!==0)for(const p in this.indexes){const g=this.indexes[p],x={};for(const w in g){const P=g[w];P.tileID=P.tileID.unwrapTo(P.tileID.wrap+l),x[P.tileID.key]=P}this.indexes[p]=x}this.lng=n}addBucket(n,l,p){if(this.indexes[n.overscaledZ]&&this.indexes[n.overscaledZ][n.key]){if(this.indexes[n.overscaledZ][n.key].bucketInstanceId===l.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(n.overscaledZ,this.indexes[n.overscaledZ][n.key])}for(let x=0;x<l.symbolInstances.length;x++)l.symbolInstances.get(x).crossTileID=0;this.usedCrossTileIDs[n.overscaledZ]||(this.usedCrossTileIDs[n.overscaledZ]={});const g=this.usedCrossTileIDs[n.overscaledZ];for(const x in this.indexes){const w=this.indexes[x];if(Number(x)>n.overscaledZ)for(const P in w){const I=w[P];I.tileID.isChildOf(n)&&I.findMatches(l.symbolInstances,n,g)}else{const P=w[n.scaledTo(Number(x)).key];P&&P.findMatches(l.symbolInstances,n,g)}}for(let x=0;x<l.symbolInstances.length;x++){const w=l.symbolInstances.get(x);w.crossTileID||(w.crossTileID=p.generate(),g[w.crossTileID]=!0)}return this.indexes[n.overscaledZ]===void 0&&(this.indexes[n.overscaledZ]={}),this.indexes[n.overscaledZ][n.key]=new Ic(n,l.symbolInstances,l.bucketInstanceId),!0}removeBucketCrossTileIDs(n,l){for(const p of l.getCrossTileIDsLists())for(const g of p)delete this.usedCrossTileIDs[n][g]}removeStaleBuckets(n){let l=!1;for(const p in this.indexes){const g=this.indexes[p];for(const x in g)n[g[x].bucketInstanceId]||(this.removeBucketCrossTileIDs(p,g[x]),delete g[x],l=!0)}return l}}class tl{constructor(){this.layerIndexes={},this.crossTileIDs=new Oh,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(n,l,p){let g=this.layerIndexes[n.id];g===void 0&&(g=this.layerIndexes[n.id]=new Cc);let x=!1;const w={};g.handleWrapJump(p);for(const P of l){const I=P.getBucket(n);I&&n.id===I.layerIds[0]&&(I.bucketInstanceId||(I.bucketInstanceId=++this.maxBucketInstanceId),g.addBucket(P.tileID,I,this.crossTileIDs)&&(x=!0),w[I.bucketInstanceId]=!0)}return g.removeStaleBuckets(w)&&(x=!0),x}pruneUnusedLayers(n){const l={};n.forEach(p=>{l[p]=!0});for(const p in this.layerIndexes)l[p]||delete this.layerIndexes[p]}}var na="void main() {fragColor=vec4(1.0);}";const en={prelude:Wt(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:Wt("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:Wt("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:Wt(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:Wt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Wt(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Wt(na,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:Wt(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:Wt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Wt("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Wt("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Wt("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:Wt(na,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:Wt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:Wt(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:Wt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:Wt(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Wt(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Wt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Wt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));fragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Wt(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:Wt(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Wt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Wt(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Wt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Wt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:Wt(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Wt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Wt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Wt("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Wt("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Wt("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:Wt("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:Wt(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:Wt("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Wt(_,n){const l=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,p=n.match(/in ([\w]+) ([\w]+)/g),g=_.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),x=n.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),w=x?x.concat(g):g,P={};return{fragmentSource:_=_.replace(l,(I,R,O,N,B)=>(P[B]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${B}
in ${O} ${N} ${B};
#else
uniform ${O} ${N} u_${B};
#endif
`:`
#ifdef HAS_UNIFORM_u_${B}
    ${O} ${N} ${B} = u_${B};
#endif
`)),vertexSource:n=n.replace(l,(I,R,O,N,B)=>{const W=N==="float"?"vec2":"vec4",X=B.match(/color/)?"color":W;return P[B]?R==="define"?`
#ifndef HAS_UNIFORM_u_${B}
uniform lowp float u_${B}_t;
in ${O} ${W} a_${B};
out ${O} ${N} ${B};
#else
uniform ${O} ${N} u_${B};
#endif
`:X==="vec4"?`
#ifndef HAS_UNIFORM_u_${B}
    ${B} = a_${B};
#else
    ${O} ${N} ${B} = u_${B};
#endif
`:`
#ifndef HAS_UNIFORM_u_${B}
    ${B} = unpack_mix_${X}(a_${B}, u_${B}_t);
#else
    ${O} ${N} ${B} = u_${B};
#endif
`:R==="define"?`
#ifndef HAS_UNIFORM_u_${B}
uniform lowp float u_${B}_t;
in ${O} ${W} a_${B};
#else
uniform ${O} ${N} u_${B};
#endif
`:X==="vec4"?`
#ifndef HAS_UNIFORM_u_${B}
    ${O} ${N} ${B} = a_${B};
#else
    ${O} ${N} ${B} = u_${B};
#endif
`:`
#ifndef HAS_UNIFORM_u_${B}
    ${O} ${N} ${B} = unpack_mix_${X}(a_${B}, u_${B}_t);
#else
    ${O} ${N} ${B} = u_${B};
#endif
`}),staticAttributes:p,staticUniforms:w}}class Cs{constructor(n,l,p){this.vertexBuffer=n,this.indexBuffer=l,this.segments=p}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var ns=a.aD([{name:"a_pos",type:"Int16",components:2}]);const Dn="#define PROJECTION_MERCATOR",co="mercator";class Jt{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return co}get shaderDefine(){return Dn}get shaderPreludeCode(){return en.projectionMercator}get vertexShaderPreludeCode(){return en.projectionMercator.vertexSource}get subdivisionGranularity(){return a.aE.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(n){}getMeshFromTileID(n,l,p,g,x){if(this._cachedMesh)return this._cachedMesh;const w=new a.aF;w.emplaceBack(0,0),w.emplaceBack(a.Z,0),w.emplaceBack(0,a.Z),w.emplaceBack(a.Z,a.Z);const P=n.createVertexBuffer(w,ns.members),I=a.aG.simpleSegment(0,0,4,2),R=new a.aH;R.emplaceBack(1,0,2),R.emplaceBack(1,2,3);const O=n.createIndexBuffer(R);return this._cachedMesh=new Cs(P,O,I),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(n){}}function Zr(_,n){const l=a.ae(n.lat,-85.051129,a.aJ);return new a.P(a.U(n.lng)*_,a.S(l)*_)}function sa(_,n){return new a.$(n.x/_,n.y/_).toLngLat()}function uo(_){return _.cameraToCenterDistance*Math.min(.85*Math.tan(a.ad(90-_.pitch)),Math.tan(a.ad(89.25-_.pitch)))}function br(_,n){const l=_.canonical,p=n/a.aI(l.z),g=l.x+Math.pow(2,l.z)*_.wrap,x=a.at(new Float64Array(16));return a.L(x,x,[g*p,l.y*p,0]),a.M(x,x,[p/a.Z,p/a.Z,1]),x}function cr(_,n,l,p,g){const x=a.$.fromLngLat(_,n),w=g*a.aK(1,_.lat),P=w*Math.cos(a.ad(l)),I=Math.sqrt(w*w-P*P),R=I*Math.sin(a.ad(-p)),O=I*Math.cos(a.ad(-p));return new a.$(x.x+R,x.y+O,x.z+P)}class Ai{constructor(n=0,l=0,p=0,g=0){if(isNaN(n)||n<0||isNaN(l)||l<0||isNaN(p)||p<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=n,this.bottom=l,this.left=p,this.right=g}interpolate(n,l,p){return l.top!=null&&n.top!=null&&(this.top=a.B.number(n.top,l.top,p)),l.bottom!=null&&n.bottom!=null&&(this.bottom=a.B.number(n.bottom,l.bottom,p)),l.left!=null&&n.left!=null&&(this.left=a.B.number(n.left,l.left,p)),l.right!=null&&n.right!=null&&(this.right=a.B.number(n.right,l.right,p)),this}getCenter(n,l){const p=a.ae((this.left+n-this.right)/2,0,n),g=a.ae((this.top+l-this.bottom)/2,0,l);return new a.P(p,g)}equals(n){return this.top===n.top&&this.bottom===n.bottom&&this.left===n.left&&this.right===n.right}clone(){return new Ai(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function il(_,n){if(!_.renderWorldCopies||_.lngRange)return;const l=n.lng-_.center.lng;n.lng+=l>180?-360:l<-180?360:0}function wr(_){return Math.max(0,Math.floor(_))}class Cr{constructor(n,l,p,g,x,w){this._callbacks=n,this._tileSize=512,this._renderWorldCopies=w===void 0||!!w,this._minZoom=l||0,this._maxZoom=p||22,this._minPitch=g??0,this._maxPitch=x??60,this.setMaxBounds(),this._width=0,this._height=0,this._center=new a.Q(0,0),this._elevation=0,this._zoom=0,this._tileZoom=wr(this._zoom),this._scale=a.aI(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new Ai,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(n,l,p){this._latRange=n.latRange,this._lngRange=n.lngRange,this._width=n.width,this._height=n.height,this._center=n.center,this._elevation=n.elevation,this._minElevationForCurrentTile=n.minElevationForCurrentTile,this._zoom=n.zoom,this._tileZoom=wr(this._zoom),this._scale=a.aI(this._zoom),this._bearingInRadians=n.bearingInRadians,this._fovInRadians=n.fovInRadians,this._pitchInRadians=n.pitchInRadians,this._rollInRadians=n.rollInRadians,this._unmodified=n.unmodified,this._edgeInsets=new Ai(n.padding.top,n.padding.bottom,n.padding.left,n.padding.right),this._minZoom=n.minZoom,this._maxZoom=n.maxZoom,this._minPitch=n.minPitch,this._maxPitch=n.maxPitch,this._renderWorldCopies=n.renderWorldCopies,this._cameraToCenterDistance=n.cameraToCenterDistance,this._nearZ=n.nearZ,this._farZ=n.farZ,this._autoCalculateNearFarZ=!p&&n.autoCalculateNearFarZ,l&&this._constrain(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(n){this._minElevationForCurrentTile=n}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(n){this._minZoom!==n&&(this._minZoom=n,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(n){this._maxZoom!==n&&(this._maxZoom=n,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(n){this._minPitch!==n&&(this._minPitch=n,this.setPitch(Math.max(this.pitch,n)))}get maxPitch(){return this._maxPitch}setMaxPitch(n){this._maxPitch!==n&&(this._maxPitch=n,this.setPitch(Math.min(this.pitch,n)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(n){n===void 0?n=!0:n===null&&(n=!1),this._renderWorldCopies=n}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new a.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(n){const l=a.aL(n,-180,180)*Math.PI/180;var p,g,x,w,P,I,R,O,N;this._bearingInRadians!==l&&(this._unmodified=!1,this._bearingInRadians=l,this._calcMatrices(),this._rotationMatrix=T(),p=this._rotationMatrix,x=-this._bearingInRadians,w=(g=this._rotationMatrix)[0],P=g[1],I=g[2],R=g[3],O=Math.sin(x),N=Math.cos(x),p[0]=w*N+I*O,p[1]=P*N+R*O,p[2]=w*-O+I*N,p[3]=P*-O+R*N)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(n){const l=a.ae(n,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==l&&(this._unmodified=!1,this._pitchInRadians=l,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(n){const l=n/180*Math.PI;this._rollInRadians!==l&&(this._unmodified=!1,this._rollInRadians=l,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return a.aM(this._fovInRadians)}setFov(n){n=a.ae(n,.1,150),this.fov!==n&&(this._unmodified=!1,this._fovInRadians=a.ad(n),this._calcMatrices())}get zoom(){return this._zoom}setZoom(n){const l=this.getConstrained(this._center,n).zoom;this._zoom!==l&&(this._unmodified=!1,this._zoom=l,this._tileZoom=Math.max(0,Math.floor(l)),this._scale=a.aI(l),this._constrain(),this._calcMatrices())}get center(){return this._center}setCenter(n){n.lat===this._center.lat&&n.lng===this._center.lng||(this._unmodified=!1,this._center=n,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(n){n!==this._elevation&&(this._elevation=n,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(n){this._edgeInsets.equals(n)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,n,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(n,l){this._autoCalculateNearFarZ=!1,this._nearZ=n,this._farZ=l,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(n){return this._edgeInsets.equals(n)}interpolatePadding(n,l,p){this._unmodified=!1,this._edgeInsets.interpolate(n,l,p),this._constrain(),this._calcMatrices()}resize(n,l,p=!0){this._width=n,this._height=l,p&&this._constrain(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new Si([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(n){n?(this._lngRange=[n.getWest(),n.getEast()],this._latRange=[n.getSouth(),n.getNorth()],this._constrain()):(this._lngRange=null,this._latRange=[-85.051129,a.aJ])}getConstrained(n,l){return this._callbacks.getConstrained(n,l)}getCameraQueryGeometry(n,l){if(l.length===1)return[l[0],n];{let p=n.x,g=n.y,x=n.x,w=n.y;for(const P of l)p=Math.min(p,P.x),g=Math.min(g,P.y),x=Math.max(x,P.x),w=Math.max(w,P.y);return[new a.P(p,g),new a.P(x,g),new a.P(x,w),new a.P(p,w),new a.P(p,g)]}}_constrain(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const n=this._unmodified,{center:l,zoom:p}=this.getConstrained(this.center,this.zoom);this.setCenter(l),this.setZoom(p),this._unmodified=n,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let n=a.at(new Float64Array(16));a.M(n,n,[this._width/2,-this._height/2,1]),a.L(n,n,[1,-1,0]),this._clipSpaceToPixelsMatrix=n,n=a.at(new Float64Array(16)),a.M(n,n,[1,-1,1]),a.L(n,n,[-1,-1,0]),a.M(n,n,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=n,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(n,l,p,g){const x=p!==void 0?p:this.bearing,w=g=g!==void 0?g:this.pitch,P=a.$.fromLngLat(n,l),I=-Math.cos(a.ad(w)),R=Math.sin(a.ad(w)),O=R*Math.sin(a.ad(x)),N=-R*Math.cos(a.ad(x));let B=this.elevation;const W=l-B;let X;I*W>=0||Math.abs(I)<.1?(X=1e4,B=l+X*I):X=-W/I;let te,Q,ie=a.aN(1,P.y),se=0;do{if(se+=1,se>10)break;Q=X/ie,te=new a.$(P.x+O*Q,P.y+N*Q),ie=1/te.meterInMercatorCoordinateUnits()}while(Math.abs(X-Q*ie)>1e-12);return{center:te.toLngLat(),elevation:B,zoom:a.ab(this.height/2/Math.tan(this.fovInRadians/2)/Q/this.tileSize)}}recalculateZoomAndCenter(n){if(this.elevation-n==0)return;const l=a.aK(1,this.center.lat)*this.worldSize,p=this.cameraToCenterDistance/l,g=a.$.fromLngLat(this.center,this.elevation),x=cr(this.center,this.elevation,this.pitch,this.bearing,p);this._elevation=n;const w=this.calculateCenterFromCameraLngLatAlt(x.toLngLat(),a.aN(x.z,g.y),this.bearing,this.pitch);this._elevation=w.elevation,this._center=w.center,this.setZoom(w.zoom)}getCameraPoint(){const n=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new a.P(n*Math.sin(this.rollInRadians),n*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const n=a.aK(1,this.center.lat)*this.worldSize;return cr(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/n).toLngLat()}getMercatorTileCoordinates(n){if(!n)return[0,0,1,1];const l=n.canonical.z>=0?1<<n.canonical.z:Math.pow(2,n.canonical.z);return[n.canonical.x/l,n.canonical.y/l,1/l/a.Z,1/l/a.Z]}}class Yi{constructor(n,l){this.min=n,this.max=l,this.center=a.aO([],a.aP([],this.min,this.max),.5)}quadrant(n){const l=[n%2==0,n<2],p=a.aQ(this.min),g=a.aQ(this.max);for(let x=0;x<l.length;x++)p[x]=l[x]?this.min[x]:this.center[x],g[x]=l[x]?this.center[x]:this.max[x];return g[2]=this.max[2],new Yi(p,g)}distanceX(n){return Math.max(Math.min(this.max[0],n[0]),this.min[0])-n[0]}distanceY(n){return Math.max(Math.min(this.max[1],n[1]),this.min[1])-n[1]}intersectsFrustum(n){let l=!0;for(let p=0;p<n.planes.length;p++){const g=this.intersectsPlane(n.planes[p]);if(g===0)return 0;g===1&&(l=!1)}return l?2:n.aabb.min[0]>this.max[0]||n.aabb.min[1]>this.max[1]||n.aabb.min[2]>this.max[2]||n.aabb.max[0]<this.min[0]||n.aabb.max[1]<this.min[1]||n.aabb.max[2]<this.min[2]?0:1}intersectsPlane(n){let l=n[3],p=n[3];for(let g=0;g<3;g++)n[g]>0?(l+=n[g]*this.min[g],p+=n[g]*this.max[g]):(p+=n[g]*this.min[g],l+=n[g]*this.max[g]);return l>=0?2:p<0?0:1}}class Fh{distanceToTile2d(n,l,p,g){const x=g.distanceX([n,l]),w=g.distanceY([n,l]);return Math.hypot(x,w)}getWrap(n,l,p){return p}getTileAABB(n,l,p,g){var x,w;let P=p,I=p;if(g.terrain){const O=new a.Y(n.z,l,n.z,n.x,n.y),N=g.terrain.getMinMaxElevation(O);P=(x=N.minElevation)!==null&&x!==void 0?x:p,I=(w=N.maxElevation)!==null&&w!==void 0?w:p}const R=1<<n.z;return new Yi([l+n.x/R,n.y/R,P],[l+(n.x+1)/R,(n.y+1)/R,I])}allowVariableZoom(n,l){const p=n.fov*(Math.abs(Math.cos(n.rollInRadians))*n.height+Math.abs(Math.sin(n.rollInRadians))*n.width)/n.height,g=a.ae(78.5-p/2,0,60);return!!l.terrain||n.pitch>g}allowWorldCopies(){return!0}recalculateCache(){}}class ss{constructor(n,l,p){this.points=n,this.planes=l,this.aabb=p}static fromInvProjectionMatrix(n,l=1,p=0){const g=Math.pow(2,p),x=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(R=>{const O=1/(R=a.ap([],R,n))[3]/l*g;return a.aR(R,R,[O,O,1/R[3],O])}),w=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(R=>{const O=a.aS([],x[R[0]],x[R[1]]),N=a.aS([],x[R[2]],x[R[1]]),B=a.aT([],a.aU([],O,N)),W=-a.aV(B,x[R[1]]);return B.concat(W)}),P=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],I=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const R of x)for(let O=0;O<3;O++)P[O]=Math.min(P[O],R[O]),I[O]=Math.max(I[O],R[O]);return new ss(x,w,new Yi(P,I))}}class Pi{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(n){this._helper.setMinZoom(n)}setMaxZoom(n){this._helper.setMaxZoom(n)}setMinPitch(n){this._helper.setMinPitch(n)}setMaxPitch(n){this._helper.setMaxPitch(n)}setRenderWorldCopies(n){this._helper.setRenderWorldCopies(n)}setBearing(n){this._helper.setBearing(n)}setPitch(n){this._helper.setPitch(n)}setRoll(n){this._helper.setRoll(n)}setFov(n){this._helper.setFov(n)}setZoom(n){this._helper.setZoom(n)}setCenter(n){this._helper.setCenter(n)}setElevation(n){this._helper.setElevation(n)}setMinElevationForCurrentTile(n){this._helper.setMinElevationForCurrentTile(n)}setPadding(n){this._helper.setPadding(n)}interpolatePadding(n,l,p){return this._helper.interpolatePadding(n,l,p)}isPaddingEqual(n){return this._helper.isPaddingEqual(n)}resize(n,l,p=!0){this._helper.resize(n,l,p)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(n){this._helper.setMaxBounds(n)}overrideNearFarZ(n,l){this._helper.overrideNearFarZ(n,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(n){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),n)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(n,l){}constructor(n,l,p,g,x){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this._helper=new Cr({calcMatrices:()=>{this._calcMatrices()},getConstrained:(w,P)=>this.getConstrained(w,P)},n,l,p,g,x),this._coveringTilesDetailsProvider=new Fh}clone(){const n=new Pi;return n.apply(this),n}apply(n,l,p){this._helper.apply(n,l,p)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(n){const l=[new a.aW(0,n)];if(this._helper._renderWorldCopies){const p=this.screenPointToMercatorCoordinate(new a.P(0,0)),g=this.screenPointToMercatorCoordinate(new a.P(this._helper._width,0)),x=this.screenPointToMercatorCoordinate(new a.P(this._helper._width,this._helper._height)),w=this.screenPointToMercatorCoordinate(new a.P(0,this._helper._height)),P=Math.floor(Math.min(p.x,g.x,x.x,w.x)),I=Math.floor(Math.max(p.x,g.x,x.x,w.x)),R=1;for(let O=P-R;O<=I+R;O++)O!==0&&l.push(new a.aW(O,n))}return l}getCameraFrustum(){return ss.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(n){const l=this.screenPointToLocation(this.centerPoint,n),p=n?n.getElevationForLngLatZoom(l,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(p)}setLocationAtPoint(n,l){const p=a.aK(this.elevation,this.center.lat),g=this.screenPointToMercatorCoordinateAtZ(l,p),x=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,p),w=a.$.fromLngLat(n),P=new a.$(w.x-(g.x-x.x),w.y-(g.y-x.y));this.setCenter(P==null?void 0:P.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(n,l){return l?this.coordinatePoint(a.$.fromLngLat(n),l.getElevationForLngLatZoom(n,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(a.$.fromLngLat(n))}screenPointToLocation(n,l){var p;return(p=this.screenPointToMercatorCoordinate(n,l))===null||p===void 0?void 0:p.toLngLat()}screenPointToMercatorCoordinate(n,l){if(l){const p=l.pointCoordinate(n);if(p!=null)return p}return this.screenPointToMercatorCoordinateAtZ(n)}screenPointToMercatorCoordinateAtZ(n,l){const p=l||0,g=[n.x,n.y,0,1],x=[n.x,n.y,1,1];a.ap(g,g,this._pixelMatrixInverse),a.ap(x,x,this._pixelMatrixInverse);const w=g[3],P=x[3],I=g[1]/w,R=x[1]/P,O=g[2]/w,N=x[2]/P,B=O===N?0:(p-O)/(N-O);return new a.$(a.B.number(g[0]/w,x[0]/P,B)/this.worldSize,a.B.number(I,R,B)/this.worldSize,p)}coordinatePoint(n,l=0,p=this._pixelMatrix){const g=[n.x*this.worldSize,n.y*this.worldSize,l,1];return a.ap(g,g,p),new a.P(g[0]/g[3],g[1]/g[3])}getBounds(){const n=Math.max(0,this._helper._height/2-uo(this));return new Si().extend(this.screenPointToLocation(new a.P(0,n))).extend(this.screenPointToLocation(new a.P(this._helper._width,n))).extend(this.screenPointToLocation(new a.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new a.P(0,this._helper._height)))}isPointOnMapSurface(n,l){return l?l.pointCoordinate(n)!=null:n.y>this.height/2-uo(this)}calculatePosMatrix(n,l=!1,p){var g;const x=(g=n.key)!==null&&g!==void 0?g:a.aX(n.wrap,n.canonical.z,n.canonical.z,n.canonical.x,n.canonical.y),w=l?this._alignedPosMatrixCache:this._posMatrixCache;if(w.has(x)){const R=w.get(x);return p?R.f32:R.f64}const P=br(n,this.worldSize);a.N(P,l?this._alignedProjMatrix:this._viewProjMatrix,P);const I={f64:P,f32:new Float32Array(P)};return w.set(x,I),p?I.f32:I.f64}calculateFogMatrix(n){const l=n.key,p=this._fogMatrixCacheF32;if(p.has(l))return p.get(l);const g=br(n,this.worldSize);return a.N(g,this._fogMatrix,g),p.set(l,new Float32Array(g)),p.get(l)}getConstrained(n,l){l=a.ae(+l,this.minZoom,this.maxZoom);const p={center:new a.Q(n.lng,n.lat),zoom:l};let g=this._helper._lngRange;this._helper._renderWorldCopies||g!==null||(g=[-179.9999999999,180-1e-10]);const x=this.tileSize*a.aI(p.zoom);let w=0,P=x,I=0,R=x,O=0,N=0;const{x:B,y:W}=this.size;if(this._helper._latRange){const ue=this._helper._latRange;w=a.S(ue[1])*x,P=a.S(ue[0])*x,P-w<W&&(O=W/(P-w))}g&&(I=a.aL(a.U(g[0])*x,0,x),R=a.aL(a.U(g[1])*x,0,x),R<I&&(R+=x),R-I<B&&(N=B/(R-I)));const{x:X,y:te}=Zr(x,n);let Q,ie;const se=Math.max(N||0,O||0);if(se){const ue=new a.P(N?(R+I)/2:X,O?(P+w)/2:te);return p.center=sa(x,ue).wrap(),p.zoom+=a.ab(se),p}if(this._helper._latRange){const ue=W/2;te-ue<w&&(ie=w+ue),te+ue>P&&(ie=P-ue)}if(g){const ue=(I+R)/2;let fe=X;this._helper._renderWorldCopies&&(fe=a.aL(X,ue-x/2,ue+x/2));const de=B/2;fe-de<I&&(Q=I+de),fe+de>R&&(Q=R-de)}if(Q!==void 0||ie!==void 0){const ue=new a.P(Q??X,ie??te);p.center=sa(x,ue).wrap()}return p}calculateCenterFromCameraLngLatAlt(n,l,p,g){return this._helper.calculateCenterFromCameraLngLatAlt(n,l,p,g)}_calculateNearFarZIfNeeded(n,l,p){if(!this._helper.autoCalculateNearFarZ)return;const g=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),x=n-g*this._helper._pixelPerMeter/Math.cos(l),w=g<0?x:n,P=Math.PI/2+this.pitchInRadians,I=a.ad(this.fov)*(Math.abs(Math.cos(a.ad(this.roll)))*this.height+Math.abs(Math.sin(a.ad(this.roll)))*this.width)/this.height*(.5+p.y/this.height),R=Math.sin(I)*w/Math.sin(a.ae(Math.PI-P-I,.01,Math.PI-.01)),O=uo(this),N=Math.atan(O/this._helper.cameraToCenterDistance),B=a.ad(.75),W=N>B?2*N*(.5+p.y/(2*O)):B,X=Math.sin(W)*w/Math.sin(a.ae(Math.PI-P-W,.01,Math.PI-.01)),te=Math.min(R,X);this._helper._farZ=1.01*(Math.cos(Math.PI/2-l)*te+w),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const n=this.centerOffset,l=Zr(this.worldSize,this.center),p=l.x,g=l.y;this._helper._pixelPerMeter=a.aK(1,this.center.lat)*this.worldSize;const x=a.ad(Math.min(this.pitch,89.25)),w=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(x));let P;this._calculateNearFarZIfNeeded(w,x,n),P=new Float64Array(16),a.aY(P,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),a.aj(this._invProjMatrix,P),P[8]=2*-n.x/this._helper._width,P[9]=2*n.y/this._helper._height,this._projectionMatrix=a.aZ(P),a.M(P,P,[1,-1,1]),a.L(P,P,[0,0,-this._helper.cameraToCenterDistance]),a.a_(P,P,-this.rollInRadians),a.a$(P,P,this.pitchInRadians),a.a_(P,P,-this.bearingInRadians),a.L(P,P,[-p,-g,0]),this._mercatorMatrix=a.M([],P,[this.worldSize,this.worldSize,this.worldSize]),a.M(P,P,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=a.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,P),a.L(P,P,[0,0,-this.elevation]),this._viewProjMatrix=P,this._invViewProjMatrix=a.aj([],P);const I=[0,0,-1,1];a.ap(I,I,this._invViewProjMatrix),this._cameraPosition=[I[0]/I[3],I[1]/I[3],I[2]/I[3]],this._fogMatrix=new Float64Array(16),a.aY(this._fogMatrix,this.fovInRadians,this.width/this.height,w,this._helper._farZ),this._fogMatrix[8]=2*-n.x/this.width,this._fogMatrix[9]=2*n.y/this.height,a.M(this._fogMatrix,this._fogMatrix,[1,-1,1]),a.L(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),a.a_(this._fogMatrix,this._fogMatrix,-this.rollInRadians),a.a$(this._fogMatrix,this._fogMatrix,this.pitchInRadians),a.a_(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),a.L(this._fogMatrix,this._fogMatrix,[-p,-g,0]),a.M(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),a.L(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=a.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,P);const R=this._helper._width%2/2,O=this._helper._height%2/2,N=Math.cos(this.bearingInRadians),B=Math.sin(-this.bearingInRadians),W=p-Math.round(p)+N*R+B*O,X=g-Math.round(g)+N*O+B*R,te=new Float64Array(P);if(a.L(te,te,[W>.5?W-1:W,X>.5?X-1:X,0]),this._alignedProjMatrix=te,P=a.aj(new Float64Array(16),this._pixelMatrix),!P)throw new Error("failed to invert matrix");this._pixelMatrixInverse=P,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const n=this.screenPointToMercatorCoordinate(new a.P(0,0)),l=[n.x*this.worldSize,n.y*this.worldSize,0,1];return a.ap(l,l,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const n=a.aK(1,this.center.lat)*this.worldSize;return cr(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/n).toLngLat()}lngLatToCameraDepth(n,l){const p=a.$.fromLngLat(n),g=[p.x*this.worldSize,p.y*this.worldSize,l,1];return a.ap(g,g,this._viewProjMatrix),g[2]/g[3]}getProjectionData(n){const{overscaledTileID:l,aligned:p,applyTerrainMatrix:g}=n,x=this._helper.getMercatorTileCoordinates(l),w=l?this.calculatePosMatrix(l,p,!0):null;let P;return P=l&&l.terrainRttPosMatrix32f&&g?l.terrainRttPosMatrix32f:w||a.b0(),{mainMatrix:P,tileMercatorCoords:x,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:P}}isLocationOccluded(n){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(n,l,p){return 1}transformLightDirection(n){return a.aQ(n)}getRayDirectionFromPixel(n){throw new Error("Not implemented.")}projectTileCoordinates(n,l,p,g){const x=this.calculatePosMatrix(p);let w;g?(w=[n,l,g(n,l),1],a.ap(w,w,x)):(w=[n,l,0,1],Gi(w,w,x));const P=w[3];return{point:new a.P(w[0]/P,w[1]/P),signedDistanceFromCamera:P,isOccluded:!1}}populateCache(n){for(const l of n)this.calculatePosMatrix(l)}getMatrixForModel(n,l){const p=a.$.fromLngLat(n,l),g=p.meterInMercatorCoordinateUnits(),x=a.b1();return a.L(x,x,[p.x,p.y,p.z]),a.a_(x,x,Math.PI),a.a$(x,x,Math.PI/2),a.M(x,x,[-g,g,g]),x}getProjectionDataForCustomLayer(n=!0){const l=new a.Y(0,0,0,0,0),p=this.getProjectionData({overscaledTileID:l,applyGlobeMatrix:n}),g=br(l,this.worldSize);a.N(g,this._viewProjMatrix,g),p.tileMercatorCoords=[0,0,1,1];const x=[a.Z,a.Z,this.worldSize/this._helper.pixelsPerMeter],w=a.b2();return a.M(w,g,x),p.fallbackMatrix=w,p.mainMatrix=w,p}getFastPathSimpleProjectionMatrix(n){return this.calculatePosMatrix(n)}}function ho(){a.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function os(_){if(_.useSlerp)if(_.k<1){const n=a.b3(_.startEulerAngles.roll,_.startEulerAngles.pitch,_.startEulerAngles.bearing),l=a.b3(_.endEulerAngles.roll,_.endEulerAngles.pitch,_.endEulerAngles.bearing),p=new Float64Array(4);a.b4(p,n,l,_.k);const g=a.b5(p);_.tr.setRoll(g.roll),_.tr.setPitch(g.pitch),_.tr.setBearing(g.bearing)}else _.tr.setRoll(_.endEulerAngles.roll),_.tr.setPitch(_.endEulerAngles.pitch),_.tr.setBearing(_.endEulerAngles.bearing);else _.tr.setRoll(a.B.number(_.startEulerAngles.roll,_.endEulerAngles.roll,_.k)),_.tr.setPitch(a.B.number(_.startEulerAngles.pitch,_.endEulerAngles.pitch,_.k)),_.tr.setBearing(a.B.number(_.startEulerAngles.bearing,_.endEulerAngles.bearing,_.k))}function oa(_,n,l,p,g){const x=g.padding,w=Zr(g.worldSize,l.getNorthWest()),P=Zr(g.worldSize,l.getNorthEast()),I=Zr(g.worldSize,l.getSouthEast()),R=Zr(g.worldSize,l.getSouthWest()),O=a.ad(-p),N=w.rotate(O),B=P.rotate(O),W=I.rotate(O),X=R.rotate(O),te=new a.P(Math.max(N.x,B.x,X.x,W.x),Math.max(N.y,B.y,X.y,W.y)),Q=new a.P(Math.min(N.x,B.x,X.x,W.x),Math.min(N.y,B.y,X.y,W.y)),ie=te.sub(Q),se=(g.width-(x.left+x.right+n.left+n.right))/ie.x,ue=(g.height-(x.top+x.bottom+n.top+n.bottom))/ie.y;if(ue<0||se<0)return void ho();const fe=Math.min(a.ab(g.scale*Math.min(se,ue)),_.maxZoom),de=a.P.convert(_.offset),ve=new a.P((n.left-n.right)/2,(n.top-n.bottom)/2).rotate(a.ad(p)),ge=de.add(ve).mult(g.scale/a.aI(fe));return{center:sa(g.worldSize,w.add(I).div(2).sub(ge)),zoom:fe,bearing:p}}class Mr{get useGlobeControls(){return!1}handlePanInertia(n,l){return{easingOffset:n,easingCenter:l.center}}handleMapControlsRollPitchBearingZoom(n,l){n.bearingDelta&&l.setBearing(l.bearing+n.bearingDelta),n.pitchDelta&&l.setPitch(l.pitch+n.pitchDelta),n.rollDelta&&l.setRoll(l.roll+n.rollDelta),n.zoomDelta&&l.setZoom(l.zoom+n.zoomDelta)}handleMapControlsPan(n,l,p){n.around.distSqr(l.centerPoint)<.01||l.setLocationAtPoint(p,n.around)}cameraForBoxAndBearing(n,l,p,g,x){return oa(n,l,p,g,x)}handleJumpToCenterZoom(n,l){n.zoom!==(l.zoom!==void 0?+l.zoom:n.zoom)&&n.setZoom(+l.zoom),l.center!==void 0&&n.setCenter(a.Q.convert(l.center))}handleEaseTo(n,l){const p=n.zoom,g=n.padding,x={roll:n.roll,pitch:n.pitch,bearing:n.bearing},w={roll:l.roll===void 0?n.roll:l.roll,pitch:l.pitch===void 0?n.pitch:l.pitch,bearing:l.bearing===void 0?n.bearing:l.bearing},P=l.zoom!==void 0,I=!n.isPaddingEqual(l.padding);let R=!1;const O=P?+l.zoom:n.zoom;let N=n.centerPoint.add(l.offsetAsPoint);const B=n.screenPointToLocation(N),{center:W,zoom:X}=n.getConstrained(a.Q.convert(l.center||B),O??p);il(n,W);const te=Zr(n.worldSize,B),Q=Zr(n.worldSize,W).sub(te),ie=a.aI(X-p);return R=X!==p,{easeFunc:se=>{if(R&&n.setZoom(a.B.number(p,X,se)),a.b6(x,w)||os({startEulerAngles:x,endEulerAngles:w,tr:n,k:se,useSlerp:x.roll!=w.roll}),I&&(n.interpolatePadding(g,l.padding,se),N=n.centerPoint.add(l.offsetAsPoint)),l.around)n.setLocationAtPoint(l.around,l.aroundPoint);else{const ue=a.aI(n.zoom-p),fe=X>p?Math.min(2,ie):Math.max(.5,ie),de=Math.pow(fe,1-se),ve=sa(n.worldSize,te.add(Q.mult(se*de)).mult(ue));n.setLocationAtPoint(n.renderWorldCopies?ve.wrap():ve,N)}},isZooming:R,elevationCenter:W}}handleFlyTo(n,l){const p=l.zoom!==void 0,g=n.zoom,x=n.getConstrained(a.Q.convert(l.center||l.locationAtOffset),p?+l.zoom:g),w=x.center,P=x.zoom;il(n,w);const I=Zr(n.worldSize,l.locationAtOffset),R=Zr(n.worldSize,w).sub(I),O=R.mag(),N=a.aI(P-g);let B;if(l.minZoom!==void 0){const W=Math.min(+l.minZoom,g,P),X=n.getConstrained(w,W).zoom;B=a.aI(X-g)}return{easeFunc:(W,X,te,Q)=>{n.setZoom(W===1?P:g+a.ab(X));const ie=W===1?w:sa(n.worldSize,I.add(R.mult(te)).mult(X));n.setLocationAtPoint(n.renderWorldCopies?ie.wrap():ie,Q)},scaleOfZoom:N,targetCenter:w,scaleOfMinZoom:B,pixelPathLength:O}}}class _i{constructor(n,l,p){this.blendFunction=n,this.blendColor=l,this.mask=p}}_i.Replace=[1,0],_i.disabled=new _i(_i.Replace,a.b7.transparent,[!1,!1,!1,!1]),_i.unblended=new _i(_i.Replace,a.b7.transparent,[!0,!0,!0,!0]),_i.alphaBlended=new _i([1,771],a.b7.transparent,[!0,!0,!0,!0]);const pn=2305;class ti{constructor(n,l,p){this.enable=n,this.mode=l,this.frontFace=p}}ti.disabled=new ti(!1,1029,pn),ti.backCCW=new ti(!0,1029,pn),ti.frontCCW=new ti(!0,1028,pn);class Vt{constructor(n,l,p){this.func=n,this.mask=l,this.range=p}}Vt.ReadOnly=!1,Vt.ReadWrite=!0,Vt.disabled=new Vt(519,Vt.ReadOnly,[0,1]);const fo=7680;class Yt{constructor(n,l,p,g,x,w){this.test=n,this.ref=l,this.mask=p,this.fail=g,this.depthFail=x,this.pass=w}}Yt.disabled=new Yt({func:519,mask:0},0,0,fo,fo,fo);const po=new WeakMap;function tn(_){var n;if(po.has(_))return po.get(_);{const l=(n=_.getParameter(_.VERSION))===null||n===void 0?void 0:n.startsWith("WebGL 2.0");return po.set(_,l),l}}class aa{get awaitingQuery(){return!!this._readbackQueue}constructor(n){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=n;const l=n.context,p=l.gl;this._texFormat=p.RGBA,this._texType=p.UNSIGNED_BYTE;const g=new a.aF;g.emplaceBack(-1,-1),g.emplaceBack(2,-1),g.emplaceBack(-1,2);const x=new a.aH;x.emplaceBack(0,1,2),this._fullscreenTriangle=new Cs(l.createVertexBuffer(g,ns.members),l.createIndexBuffer(x),a.aG.simpleSegment(0,0,g.length,x.length)),this._resultBuffer=new Uint8Array(4),l.activeTexture.set(p.TEXTURE1);const w=p.createTexture();p.bindTexture(p.TEXTURE_2D,w),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texImage2D(p.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=l.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(w),tn(p)&&(this._pbo=p.createBuffer(),p.bindBuffer(p.PIXEL_PACK_BUFFER,this._pbo),p.bufferData(p.PIXEL_PACK_BUFFER,4,p.STREAM_READ),p.bindBuffer(p.PIXEL_PACK_BUFFER,null))}destroy(){const n=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),n.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(n,l){const p=this._updateCount;return this._readbackQueue?p>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():p>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(n,l),this._updateCount++,this._measuredError}_bindFramebuffer(){const n=this._cachedRenderContext.context,l=n.gl;n.activeTexture.set(l.TEXTURE1),l.bindTexture(l.TEXTURE_2D,this._fbo.colorAttachment.get()),n.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(n,l){const p=this._cachedRenderContext.context,g=p.gl;if(this._bindFramebuffer(),p.viewport.set([0,0,this._texWidth,this._texHeight]),p.clear({color:a.b7.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(p,g.TRIANGLES,Vt.disabled,Yt.disabled,_i.unblended,ti.disabled,((x,w)=>({u_input:x,u_output_expected:w}))(n,l),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&tn(g)){g.bindBuffer(g.PIXEL_PACK_BUFFER,this._pbo),g.readBuffer(g.COLOR_ATTACHMENT0),g.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),g.bindBuffer(g.PIXEL_PACK_BUFFER,null);const x=g.fenceSync(g.SYNC_GPU_COMMANDS_COMPLETE,0);g.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:x}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const n=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&tn(n)){const l=n.clientWaitSync(this._readbackQueue.sync,0,0);if(l===n.WAIT_FAILED)return a.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(l===n.TIMEOUT_EXPIRED)return;n.bindBuffer(n.PIXEL_PACK_BUFFER,this._pbo),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),n.bindBuffer(n.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),n.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=aa._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(n){let l=0;return l+=n[0]/256,l+=n[1]/65536,l+=n[2]/16777216,n[3]<127&&(l=-l),l/128}}const la=a.Z/128;function rl(_,n){const l=_.granularity!==void 0?Math.max(_.granularity,1):1,p=l+(_.generateBorders?2:0),g=l+(_.extendToNorthPole||_.generateBorders?1:0)+(_.extendToSouthPole||_.generateBorders?1:0),x=p+1,w=g+1,P=_.generateBorders?-1:0,I=_.generateBorders||_.extendToNorthPole?-1:0,R=l+(_.generateBorders?1:0),O=l+(_.generateBorders||_.extendToSouthPole?1:0),N=x*w,B=p*g*6,W=x*w>65536;if(W&&n==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const X=W||n==="32bit",te=new Int16Array(2*N);let Q=0;for(let ue=I;ue<=O;ue++)for(let fe=P;fe<=R;fe++){let de=fe/l*a.Z;fe===-1&&(de=-64),fe===l+1&&(de=a.Z+la);let ve=ue/l*a.Z;ue===-1&&(ve=_.extendToNorthPole?a.b9:-64),ue===l+1&&(ve=_.extendToSouthPole?a.ba:a.Z+la),te[Q++]=de,te[Q++]=ve}const ie=X?new Uint32Array(B):new Uint16Array(B);let se=0;for(let ue=0;ue<g;ue++)for(let fe=0;fe<p;fe++){const de=fe+1+ue*x,ve=fe+(ue+1)*x,ge=fe+1+(ue+1)*x;ie[se++]=fe+ue*x,ie[se++]=ve,ie[se++]=de,ie[se++]=de,ie[se++]=ve,ie[se++]=ge}return{vertices:te.buffer.slice(0),indices:ie.buffer.slice(0),uses32bitIndices:X}}const ca=new a.aE({fill:new a.bb(128,2),line:new a.bb(512,0),tile:new a.bb(128,32),stencil:new a.bb(128,1),circle:3});class ua{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return en.projectionGlobe}get vertexShaderPreludeCode(){return en.projectionMercator.vertexSource}get subdivisionGranularity(){return ca}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(n){this._errorMeasurement||(this._errorMeasurement=new aa(n));const l=a.S(this._errorQueryLatitudeDegrees),p=2*Math.atan(Math.exp(Math.PI-l*Math.PI*2))-.5*Math.PI,g=this._errorMeasurement.updateErrorLoop(l,p),x=F.now();g!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=g,this._errorMeasurementLastChangeTime=x);const w=Math.min(Math.max((x-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=a.bc(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,a.bd(w))}_getMeshKey(n){return`${n.granularity.toString(36)}_${n.generateBorders?"b":""}${n.extendToNorthPole?"n":""}${n.extendToSouthPole?"s":""}`}getMeshFromTileID(n,l,p,g,x){const w=(x==="stencil"?ca.stencil:ca.tile).getGranularityForZoomLevel(l.z);return this._getMesh(n,{granularity:w,generateBorders:p,extendToNorthPole:l.y===0&&g,extendToSouthPole:l.y===(1<<l.z)-1&&g})}_getMesh(n,l){const p=this._getMeshKey(l);if(p in this._tileMeshCache)return this._tileMeshCache[p];const g=function(x,w){const P=rl(w,"16bit"),I=a.aF.deserialize({arrayBuffer:P.vertices,length:P.vertices.byteLength/2/2}),R=a.aH.deserialize({arrayBuffer:P.indices,length:P.indices.byteLength/2/3});return new Cs(x.createVertexBuffer(I,ns.members),x.createIndexBuffer(R),a.aG.simpleSegment(0,0,I.length,R.length))}(n,l);return this._tileMeshCache[p]=g,g}recalculate(n){}hasTransition(){const n=F.now();let l=!1;return l=l||(n-this._errorMeasurementLastChangeTime)/1e3<.7,l=l||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,l}setErrorQueryLatitudeDegrees(n){this._errorQueryLatitudeDegrees=n}}const nl=new a.r({type:new a.D(a.v.projection.type)});class go extends a.E{constructor(n){super(),this._transitionable=new a.T(nl),this.setProjection(n),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new a.C(0)),this._mercatorProjection=new Jt,this._verticalPerspectiveProjection=new ua}get transitionState(){const n=this.properties.get("type");if(typeof n=="string"&&n==="mercator")return 0;if(typeof n=="string"&&n==="vertical-perspective")return 1;if(n instanceof a.be){if(n.from==="vertical-perspective"&&n.to==="mercator")return 1-n.transition;if(n.from==="mercator"&&n.to==="vertical-perspective")return n.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(n){this._mercatorProjection.updateGPUdependent(n),this._verticalPerspectiveProjection.updateGPUdependent(n)}getMeshFromTileID(n,l,p,g,x){return this.currentProjection.getMeshFromTileID(n,l,p,g,x)}setProjection(n){this._transitionable.setValue("type",(n==null?void 0:n.type)||"mercator")}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}setErrorQueryLatitudeDegrees(n){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(n),this._mercatorProjection.setErrorQueryLatitudeDegrees(n)}}function Lh(_){const n=sl(_.worldSize,_.center.lat);return 2*Math.PI*n}function Ms(_,n,l,p,g){const x=1/(1<<g),w=n/a.Z*x+p*x,P=a.bg((_/a.Z*x+l*x)*Math.PI*2+Math.PI,2*Math.PI),I=2*Math.atan(Math.exp(Math.PI-w*Math.PI*2))-.5*Math.PI,R=Math.cos(I),O=new Float64Array(3);return O[0]=Math.sin(P)*R,O[1]=Math.sin(I),O[2]=Math.cos(P)*R,O}function ur(_){return function(n,l){const p=Math.cos(l),g=new Float64Array(3);return g[0]=Math.sin(n)*p,g[1]=Math.sin(l),g[2]=Math.cos(n)*p,g}(_.lng*Math.PI/180,_.lat*Math.PI/180)}function sl(_,n){return _/(2*Math.PI)/Math.cos(n*Math.PI/180)}function Bh(_){const n=Math.asin(_[1])/Math.PI*180,l=Math.sqrt(_[0]*_[0]+_[2]*_[2]);if(l>1e-6){const p=_[0]/l,g=Math.acos(_[2]/l),x=(p>0?g:-g)/Math.PI*180;return new a.Q(a.aL(x,-180,180),n)}return new a.Q(0,n)}function mr(_){return Math.cos(_*Math.PI/180)}function $i(_,n){const l=mr(_),p=mr(n);return a.ab(p/l)}function rn(_,n){const l=_.rotate(n.bearingInRadians),p=n.zoom+$i(n.center.lat,0),g=a.bc(1/mr(n.center.lat),1/mr(Math.min(Math.abs(n.center.lat),60)),a.bf(p,7,3,0,1)),x=360/Lh({worldSize:n.worldSize,center:{lat:n.center.lat}});return new a.Q(n.center.lng-l.x*x*g,a.ae(n.center.lat+l.y*x,-85.051129,a.aJ))}function mo(_){const n=.5*_,l=Math.sin(n),p=Math.cos(n);return Math.log(l+p)-Math.log(p-l)}function Mc(_,n,l,p){const g=_.lat+l*p;if(Math.abs(l)>1){const x=(Math.sign(_.lat+l)!==Math.sign(_.lat)?-Math.abs(_.lat):Math.abs(_.lat))*Math.PI/180,w=Math.abs(_.lat+l)*Math.PI/180,P=mo(x+p*(w-x)),I=mo(x),R=mo(w);return new a.Q(_.lng+n*((P-I)/(R-I)),g)}return new a.Q(_.lng+n*p,g)}class Nh{constructor(n){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._aabbFactory=n}recalculateCache(){if(!this._hadAnyChanges)return;const n=this._cachePrevious;this._cachePrevious=this._cache,this._cache=n,this._cache.clear(),this._hadAnyChanges=!1}getTileAABB(n,l,p,g){const x=`${n.z}_${n.x}_${n.y}`,w=this._cache.get(x);if(w)return w;const P=this._cachePrevious.get(x);if(P)return this._cache.set(x,P),P;const I=this._aabbFactory(n,l,p,g);return this._cache.set(x,I),this._hadAnyChanges=!0,I}}function On(_,n,l){const p=_-n;return p<0?-p:Math.max(0,p-l)}function Rc(_,n,l,p,g){const x=_-l;let w;return w=x<0?Math.min(-x,1+x-g):x>1?Math.min(Math.max(x-g,0),1-x):0,Math.max(w,On(n,p,g))}class Vp{constructor(){this._aabbCache=new Nh(this._computeTileAABB)}recalculateCache(){this._aabbCache.recalculateCache()}distanceToTile2d(n,l,p,g){const x=1<<p.z,w=1/x,P=p.x/x,I=p.y/x;let R=2;return R=Math.min(R,Rc(n,l,P,I,w)),R=Math.min(R,Rc(n,l,P+.5,-I-w,w)),R=Math.min(R,Rc(n,l,P+.5,2-I-w,w)),R}getWrap(n,l,p){const g=1<<l.z,x=1/g,w=l.x/g,P=On(n.x,w,x),I=On(n.x,w-1,x),R=On(n.x,w+1,x),O=Math.min(P,I,R);return O===R?1:O===I?-1:0}allowVariableZoom(n,l){return Rn(n,l)>4}allowWorldCopies(){return!1}getTileAABB(n,l,p,g){return this._aabbCache.getTileAABB(n,l,p,g)}_computeTileAABB(n,l,p,g){if(n.z<=0)return new Yi([-1,-1,-1],[1,1,1]);if(n.z===1)return new Yi([n.x===0?-1:0,n.y===0?0:-1,-1],[n.x===0?0:1,n.y===0?1:0,1]);{const x=[Ms(0,0,n.x,n.y,n.z),Ms(a.Z,0,n.x,n.y,n.z),Ms(a.Z,a.Z,n.x,n.y,n.z),Ms(0,a.Z,n.x,n.y,n.z)],w=[1,1,1],P=[-1,-1,-1];for(const I of x)for(let R=0;R<3;R++)w[R]=Math.min(w[R],I[R]),P[R]=Math.max(P[R],I[R]);if(n.y===0||n.y===(1<<n.z)-1){const I=[0,n.y===0?1:-1,0];for(let R=0;R<3;R++)w[R]=Math.min(w[R],I[R]),P[R]=Math.max(P[R],I[R])}return new Yi(w,P)}}}class ol{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(n){this._helper.setMinZoom(n)}setMaxZoom(n){this._helper.setMaxZoom(n)}setMinPitch(n){this._helper.setMinPitch(n)}setMaxPitch(n){this._helper.setMaxPitch(n)}setRenderWorldCopies(n){this._helper.setRenderWorldCopies(n)}setBearing(n){this._helper.setBearing(n)}setPitch(n){this._helper.setPitch(n)}setRoll(n){this._helper.setRoll(n)}setFov(n){this._helper.setFov(n)}setZoom(n){this._helper.setZoom(n)}setCenter(n){this._helper.setCenter(n)}setElevation(n){this._helper.setElevation(n)}setMinElevationForCurrentTile(n){this._helper.setMinElevationForCurrentTile(n)}setPadding(n){this._helper.setPadding(n)}interpolatePadding(n,l,p){return this._helper.interpolatePadding(n,l,p)}isPaddingEqual(n){return this._helper.isPaddingEqual(n)}resize(n,l){this._helper.resize(n,l)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(n){this._helper.setMaxBounds(n)}overrideNearFarZ(n,l){this._helper.overrideNearFarZ(n,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(n){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),n)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(n){}constructor(){this._cachedClippingPlane=a.bh(),this._projectionMatrix=a.b1(),this._globeViewProjMatrix32f=a.b0(),this._globeViewProjMatrixNoCorrection=a.b1(),this._globeViewProjMatrixNoCorrectionInverted=a.b1(),this._globeProjMatrixInverted=a.b1(),this._cameraPosition=a.bi(),this._globeLatitudeErrorCorrectionRadians=0,this._helper=new Cr({calcMatrices:()=>{this._calcMatrices()},getConstrained:(n,l)=>this.getConstrained(n,l)}),this._coveringTilesDetailsProvider=new Vp}clone(){const n=new ol;return n.apply(this),n}apply(n,l){this._globeLatitudeErrorCorrectionRadians=l||0,this._helper.apply(n)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const n=a.bi();return n[0]=this._cameraPosition[0],n[1]=this._cameraPosition[1],n[2]=this._cameraPosition[2],n}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(n){const{overscaledTileID:l,applyGlobeMatrix:p}=n,g=this._helper.getMercatorTileCoordinates(l);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:g,clippingPlane:this._cachedClippingPlane,projectionTransition:p?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(n){const l=this.pitchInRadians,p=this.cameraToCenterDistance/n,g=Math.sin(l)*p,x=Math.cos(l)*p+1,w=1/Math.sqrt(g*g+x*x)*1;let P=-g,I=x;const R=Math.sqrt(P*P+I*I);P/=R,I/=R;const O=[0,P,I];return a.bj(O,O,[0,0,0],-this.bearingInRadians),a.bk(O,O,[0,0,0],-1*this.center.lat*Math.PI/180),a.bl(O,O,[0,0,0],this.center.lng*Math.PI/180),a.aO(O,O,.25),[...O,.25*-w]}isLocationOccluded(n){return!this.isSurfacePointVisible(ur(n))}transformLightDirection(n){const l=this._helper._center.lng*Math.PI/180,p=this._helper._center.lat*Math.PI/180,g=Math.cos(p),x=[Math.sin(l)*g,Math.sin(p),Math.cos(l)*g],w=[x[2],0,-x[0]],P=[0,0,0];a.aU(P,w,x),a.aT(w,w),a.aT(P,P);const I=[0,0,0];return a.aT(I,[w[0]*n[0]+P[0]*n[1]+x[0]*n[2],w[1]*n[0]+P[1]*n[1]+x[1]*n[2],w[2]*n[0]+P[2]*n[1]+x[2]*n[2]]),I}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(n,l,p){const g=function(P,I,R){const O=1/(1<<R.z);return new a.$(P/a.Z*O+R.x*O,I/a.Z*O+R.y*O)}(n,l,p.canonical),x=(w=g.y,[a.bg(g.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-w*Math.PI*2))-.5*Math.PI]);var w;return this.getCircleRadiusCorrection()/Math.cos(x[1])}projectTileCoordinates(n,l,p,g){const x=p.canonical,w=Ms(n,l,x.x,x.y,x.z),P=1+(g?g(n,l):0)/a.br,I=[w[0]*P,w[1]*P,w[2]*P,1];a.ap(I,I,this._globeViewProjMatrixNoCorrection);const R=this._cachedClippingPlane,O=R[0]*w[0]+R[1]*w[1]+R[2]*w[2]+R[3]<0;return{point:new a.P(I[0]/I[3],I[1]/I[3]),signedDistanceFromCamera:I[3],isOccluded:O}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const n=sl(this.worldSize,this.center.lat),l=a.b2(),p=a.b2();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*n),a.aY(l,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const g=this.centerOffset;l[8]=2*-g.x/this._helper._width,l[9]=2*g.y/this._helper._height,this._projectionMatrix=a.aZ(l),this._globeProjMatrixInverted=a.b2(),a.aj(this._globeProjMatrixInverted,l),a.L(l,l,[0,0,-this.cameraToCenterDistance]),a.a_(l,l,this.rollInRadians),a.a$(l,l,-this.pitchInRadians),a.a_(l,l,this.bearingInRadians),a.L(l,l,[0,0,-n]);const x=a.bi();x[0]=n,x[1]=n,x[2]=n,a.a$(p,l,this.center.lat*Math.PI/180),a.bm(p,p,-this.center.lng*Math.PI/180),a.M(p,p,x),this._globeViewProjMatrixNoCorrection=p,a.a$(l,l,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),a.bm(l,l,-this.center.lng*Math.PI/180),a.M(l,l,x),this._globeViewProjMatrix32f=new Float32Array(l),this._globeViewProjMatrixNoCorrectionInverted=a.b2(),a.aj(this._globeViewProjMatrixNoCorrectionInverted,p);const w=a.bi();this._cameraPosition=a.bi(),this._cameraPosition[2]=this.cameraToCenterDistance/n,a.bj(this._cameraPosition,this._cameraPosition,w,-this.rollInRadians),a.bk(this._cameraPosition,this._cameraPosition,w,this.pitchInRadians),a.bj(this._cameraPosition,this._cameraPosition,w,-this.bearingInRadians),a.aP(this._cameraPosition,this._cameraPosition,[0,0,1]),a.bk(this._cameraPosition,this._cameraPosition,w,-this.center.lat*Math.PI/180),a.bl(this._cameraPosition,this._cameraPosition,w,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(n);const P=a.aZ(this._globeViewProjMatrixNoCorrectionInverted);a.M(P,P,[1,1,-1]),this._cachedFrustum=ss.fromInvProjectionMatrix(P)}calculateFogMatrix(n){a.w("calculateFogMatrix is not supported on globe projection.");const l=a.b2();return a.at(l),l}getVisibleUnwrappedCoordinates(n){return[new a.aW(0,n)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(n){n&&a.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(n,l){if(!this._globeViewProjMatrixNoCorrection)return 1;const p=ur(n);a.aO(p,p,1+l/a.br);const g=a.bh();return a.ap(g,[p[0],p[1],p[2],1],this._globeViewProjMatrixNoCorrection),g[2]/g[3]}populateCache(n){}getBounds(){const n=.5*this.width,l=.5*this.height,p=[new a.P(0,0),new a.P(n,0),new a.P(this.width,0),new a.P(this.width,l),new a.P(this.width,this.height),new a.P(n,this.height),new a.P(0,this.height),new a.P(0,l)],g=[];for(const N of p)g.push(this.unprojectScreenPoint(N));let x=0,w=0,P=0,I=0;const R=this.center;for(const N of g){const B=a.bn(R.lng,N.lng),W=a.bn(R.lat,N.lat);B<w&&(w=B),B>x&&(x=B),W<I&&(I=W),W>P&&(P=W)}const O=[R.lng+w,R.lat+I,R.lng+x,R.lat+P];return this.isSurfacePointOnScreen([0,1,0])&&(O[3]=90,O[0]=-180,O[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(O[1]=-90,O[0]=-180,O[2]=180),new Si(O)}getConstrained(n,l){const p=a.ae(n.lat,-85.051129,a.aJ),g=a.ae(+l,this.minZoom+$i(0,p),this.maxZoom);return{center:new a.Q(n.lng,p),zoom:g}}calculateCenterFromCameraLngLatAlt(n,l,p,g){return this._helper.calculateCenterFromCameraLngLatAlt(n,l,p,g)}setLocationAtPoint(n,l){const p=ur(this.unprojectScreenPoint(l)),g=ur(n),x=a.bi();a.bo(x);const w=a.bi();a.bl(w,p,x,-this.center.lng*Math.PI/180),a.bk(w,w,x,this.center.lat*Math.PI/180);const P=g[0]*g[0]+g[2]*g[2],I=w[0]*w[0];if(P<I)return;const R=Math.sqrt(P-I),O=-R,N=a.bp(g[0],g[2],w[0],R),B=a.bp(g[0],g[2],w[0],O),W=a.bi();a.bl(W,g,x,-N);const X=a.bp(W[1],W[2],w[1],w[2]),te=a.bi();a.bl(te,g,x,-B);const Q=a.bp(te[1],te[2],w[1],w[2]),ie=.5*Math.PI,se=X>=-ie&&X<=ie,ue=Q>=-ie&&Q<=ie;let fe,de;if(se&&ue){const ke=this.center.lng*Math.PI/180,We=this.center.lat*Math.PI/180;a.bs(N,ke)+a.bs(X,We)<a.bs(B,ke)+a.bs(Q,We)?(fe=N,de=X):(fe=B,de=Q)}else if(se)fe=N,de=X;else{if(!ue)return;fe=B,de=Q}const ve=fe/Math.PI*180,ge=de/Math.PI*180,De=this.center.lat;this.setCenter(new a.Q(ve,a.ae(ge,-90,90))),this.setZoom(this.zoom+$i(De,this.center.lat))}locationToScreenPoint(n,l){const p=ur(n);if(l){const g=l.getElevationForLngLatZoom(n,this._helper._tileZoom);a.aO(p,p,1+g/a.br)}return this._projectSurfacePointToScreen(p)}_projectSurfacePointToScreen(n){const l=a.bh();return a.ap(l,[...n,1],this._globeViewProjMatrixNoCorrection),l[0]/=l[3],l[1]/=l[3],new a.P((.5*l[0]+.5)*this.width,(.5*-l[1]+.5)*this.height)}screenPointToMercatorCoordinate(n,l){if(l){const p=l.pointCoordinate(n);if(p)return p}return a.$.fromLngLat(this.unprojectScreenPoint(n))}screenPointToLocation(n,l){var p;return(p=this.screenPointToMercatorCoordinate(n,l))===null||p===void 0?void 0:p.toLngLat()}isPointOnMapSurface(n,l){const p=this._cameraPosition,g=this.getRayDirectionFromPixel(n);return!!this.rayPlanetIntersection(p,g)}getRayDirectionFromPixel(n){const l=a.bh();l[0]=n.x/this.width*2-1,l[1]=-1*(n.y/this.height*2-1),l[2]=1,l[3]=1,a.ap(l,l,this._globeViewProjMatrixNoCorrectionInverted),l[0]/=l[3],l[1]/=l[3],l[2]/=l[3];const p=a.bi();p[0]=l[0]-this._cameraPosition[0],p[1]=l[1]-this._cameraPosition[1],p[2]=l[2]-this._cameraPosition[2];const g=a.bi();return a.aT(g,p),g}isSurfacePointVisible(n){const l=this._cachedClippingPlane;return l[0]*n[0]+l[1]*n[1]+l[2]*n[2]+l[3]>=0}isSurfacePointOnScreen(n){if(!this.isSurfacePointVisible(n))return!1;const l=a.bh();return a.ap(l,[...n,1],this._globeViewProjMatrixNoCorrection),l[0]/=l[3],l[1]/=l[3],l[2]/=l[3],l[0]>-1&&l[0]<1&&l[1]>-1&&l[1]<1&&l[2]>-1&&l[2]<1}rayPlanetIntersection(n,l){const p=a.aV(n,l),g=a.bi(),x=a.bi();a.aO(x,l,p),a.aS(g,n,x);const w=1-a.aV(g,g);if(w<0)return null;const P=a.aV(n,n)-1,I=-p+(p<0?1:-1)*Math.sqrt(w),R=P/I,O=I;return{tMin:Math.min(R,O),tMax:Math.max(R,O)}}unprojectScreenPoint(n){const l=this._cameraPosition,p=this.getRayDirectionFromPixel(n),g=this.rayPlanetIntersection(l,p);if(g){const R=a.bi();a.aP(R,l,[p[0]*g.tMin,p[1]*g.tMin,p[2]*g.tMin]);const O=a.bi();return a.aT(O,R),Bh(O)}const x=this._cachedClippingPlane[0]*p[0]+this._cachedClippingPlane[1]*p[1]+this._cachedClippingPlane[2]*p[2],w=-a.bq(this._cachedClippingPlane,l)/x,P=a.bi();if(w>0)a.aP(P,l,[p[0]*w,p[1]*w,p[2]*w]);else{const R=a.bi();a.aP(R,l,[2*p[0],2*p[1],2*p[2]]);const O=a.bq(this._cachedClippingPlane,R);a.aS(P,R,[this._cachedClippingPlane[0]*O,this._cachedClippingPlane[1]*O,this._cachedClippingPlane[2]*O])}const I=a.bi();return a.aT(I,P),Bh(I)}getMatrixForModel(n,l){const p=a.Q.convert(n),g=1/a.br,x=a.b1();return a.bm(x,x,p.lng/180*Math.PI),a.a$(x,x,-p.lat/180*Math.PI),a.L(x,x,[0,0,1+l/a.br]),a.a$(x,x,.5*Math.PI),a.M(x,x,[g,g,g]),x}getProjectionDataForCustomLayer(n=!0){const l=this.getProjectionData({overscaledTileID:new a.Y(0,0,0,0,0),applyGlobeMatrix:n});return l.tileMercatorCoords=[0,0,1,1],l}getFastPathSimpleProjectionMatrix(n){}}class al{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(n){this._helper.setMinZoom(n)}setMaxZoom(n){this._helper.setMaxZoom(n)}setMinPitch(n){this._helper.setMinPitch(n)}setMaxPitch(n){this._helper.setMaxPitch(n)}setRenderWorldCopies(n){this._helper.setRenderWorldCopies(n)}setBearing(n){this._helper.setBearing(n)}setPitch(n){this._helper.setPitch(n)}setRoll(n){this._helper.setRoll(n)}setFov(n){this._helper.setFov(n)}setZoom(n){this._helper.setZoom(n)}setCenter(n){this._helper.setCenter(n)}setElevation(n){this._helper.setElevation(n)}setMinElevationForCurrentTile(n){this._helper.setMinElevationForCurrentTile(n)}setPadding(n){this._helper.setPadding(n)}interpolatePadding(n,l,p){return this._helper.interpolatePadding(n,l,p)}isPaddingEqual(n){return this._helper.isPaddingEqual(n)}resize(n,l,p=!0){this._helper.resize(n,l,p)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(n){this._helper.setMaxBounds(n)}overrideNearFarZ(n,l){this._helper.overrideNearFarZ(n,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(n){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),n)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(n,l){this._globeness=n,this._globeLatitudeErrorCorrectionRadians=l,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().recalculateCache(),this._mercatorTransform.getCoveringTilesDetailsProvider().recalculateCache()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this._helper=new Cr({calcMatrices:()=>{this._calcMatrices()},getConstrained:(n,l)=>this.getConstrained(n,l)}),this._globeness=1,this._mercatorTransform=new Pi,this._verticalPerspectiveTransform=new ol}clone(){const n=new al;return n._globeness=this._globeness,n._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,n.apply(this),n}apply(n){this._helper.apply(n),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(n){const l=this._mercatorTransform.getProjectionData(n),p=this._verticalPerspectiveTransform.getProjectionData(n);return{mainMatrix:this.isGlobeRendering?p.mainMatrix:l.mainMatrix,clippingPlane:p.clippingPlane,tileMercatorCoords:p.tileMercatorCoords,projectionTransition:n.applyGlobeMatrix?this._globeness:0,fallbackMatrix:l.fallbackMatrix}}isLocationOccluded(n){return this.currentTransform.isLocationOccluded(n)}transformLightDirection(n){return this.currentTransform.transformLightDirection(n)}getPixelScale(){return a.bc(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return a.bc(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(n,l,p){const g=this._mercatorTransform.getPitchedTextCorrection(n,l,p),x=this._verticalPerspectiveTransform.getPitchedTextCorrection(n,l,p);return a.bc(g,x,this._globeness)}projectTileCoordinates(n,l,p,g){return this.currentTransform.projectTileCoordinates(n,l,p,g)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(n){return this.currentTransform.calculateFogMatrix(n)}getVisibleUnwrappedCoordinates(n){return this.currentTransform.getVisibleUnwrappedCoordinates(n)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(n){this._mercatorTransform.recalculateZoomAndCenter(n),this._verticalPerspectiveTransform.recalculateZoomAndCenter(n)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(n,l){return this.currentTransform.lngLatToCameraDepth(n,l)}populateCache(n){this._mercatorTransform.populateCache(n),this._verticalPerspectiveTransform.populateCache(n)}getBounds(){return this.currentTransform.getBounds()}getConstrained(n,l){return this.currentTransform.getConstrained(n,l)}calculateCenterFromCameraLngLatAlt(n,l,p,g){return this._helper.calculateCenterFromCameraLngLatAlt(n,l,p,g)}setLocationAtPoint(n,l){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(n,l),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(n,l),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(n,l){return this.currentTransform.locationToScreenPoint(n,l)}screenPointToMercatorCoordinate(n,l){return this.currentTransform.screenPointToMercatorCoordinate(n,l)}screenPointToLocation(n,l){return this.currentTransform.screenPointToLocation(n,l)}isPointOnMapSurface(n,l){return this.currentTransform.isPointOnMapSurface(n,l)}getRayDirectionFromPixel(n){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(n)}getMatrixForModel(n,l){return this.currentTransform.getMatrixForModel(n,l)}getProjectionDataForCustomLayer(n=!0){const l=this._mercatorTransform.getProjectionDataForCustomLayer(n);if(!this.isGlobeRendering)return l;const p=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(n);return p.fallbackMatrix=l.mainMatrix,p}getFastPathSimpleProjectionMatrix(n){return this.currentTransform.getFastPathSimpleProjectionMatrix(n)}}class nn{get useGlobeControls(){return!0}handlePanInertia(n,l){const p=rn(n,l);return Math.abs(p.lng-l.center.lng)>180&&(p.lng=l.center.lng+179.5*Math.sign(p.lng-l.center.lng)),{easingCenter:p,easingOffset:new a.P(0,0)}}handleMapControlsRollPitchBearingZoom(n,l){const p=n.around,g=l.screenPointToLocation(p);n.bearingDelta&&l.setBearing(l.bearing+n.bearingDelta),n.pitchDelta&&l.setPitch(l.pitch+n.pitchDelta),n.rollDelta&&l.setRoll(l.roll+n.rollDelta);const x=l.zoom;n.zoomDelta&&l.setZoom(l.zoom+n.zoomDelta);const w=l.zoom-x;if(w===0)return;const P=a.bn(l.center.lng,g.lng),I=P/(Math.abs(P/180)+1),R=a.bn(l.center.lat,g.lat),O=l.getRayDirectionFromPixel(p),N=l.cameraPosition,B=-1*a.aV(N,O),W=a.bi();a.aP(W,N,[O[0]*B,O[1]*B,O[2]*B]);const X=a.bt(W)-1,te=Math.exp(.5*-Math.max(X-.3,0)),Q=sl(l.worldSize,l.center.lat)/Math.min(l.width,l.height),ie=a.bf(Q,.9,.5,1,.25),se=(1-a.aI(-w))*Math.min(te,ie),ue=l.center.lat,fe=l.zoom,de=new a.Q(l.center.lng+I*se,a.ae(l.center.lat+R*se,-85.051129,a.aJ));l.setLocationAtPoint(g,p);const ve=l.center,ge=a.bf(Math.abs(P),45,85,0,1),De=a.bf(Q,.75,.35,0,1),ke=Math.pow(Math.max(ge,De),.25),We=a.bn(ve.lng,de.lng),Ze=a.bn(ve.lat,de.lat);l.setCenter(new a.Q(ve.lng+We*ke,ve.lat+Ze*ke).wrap()),l.setZoom(fe+$i(ue,l.center.lat))}handleMapControlsPan(n,l,p){if(!n.panDelta)return;const g=l.center.lat,x=l.zoom;l.setCenter(rn(n.panDelta,l).wrap()),l.setZoom(x+$i(g,l.center.lat))}cameraForBoxAndBearing(n,l,p,g,x){const w=oa(n,l,p,g,x),P=l.left/x.width*2-1,I=(x.width-l.right)/x.width*2-1,R=l.top/x.height*-2+1,O=(x.height-l.bottom)/x.height*-2+1,N=a.bn(p.getWest(),p.getEast())<0,B=N?p.getEast():p.getWest(),W=N?p.getWest():p.getEast(),X=Math.max(p.getNorth(),p.getSouth()),te=Math.min(p.getNorth(),p.getSouth()),Q=B+.5*a.bn(B,W),ie=X+.5*a.bn(X,te),se=x.clone();se.setCenter(w.center),se.setBearing(w.bearing),se.setPitch(0),se.setRoll(0),se.setZoom(w.zoom);const ue=se.modelViewProjectionMatrix,fe=[ur(p.getNorthWest()),ur(p.getNorthEast()),ur(p.getSouthWest()),ur(p.getSouthEast()),ur(new a.Q(W,ie)),ur(new a.Q(B,ie)),ur(new a.Q(Q,X)),ur(new a.Q(Q,te))],de=ur(w.center);let ve=Number.POSITIVE_INFINITY;for(const ge of fe)P<0&&(ve=nn.getLesserNonNegativeNonNull(ve,nn.solveVectorScale(ge,de,ue,"x",P))),I>0&&(ve=nn.getLesserNonNegativeNonNull(ve,nn.solveVectorScale(ge,de,ue,"x",I))),R>0&&(ve=nn.getLesserNonNegativeNonNull(ve,nn.solveVectorScale(ge,de,ue,"y",R))),O<0&&(ve=nn.getLesserNonNegativeNonNull(ve,nn.solveVectorScale(ge,de,ue,"y",O)));if(Number.isFinite(ve)&&ve!==0)return w.zoom=se.zoom+a.ab(ve),w;ho()}handleJumpToCenterZoom(n,l){const p=n.center.lat,g=n.getConstrained(l.center?a.Q.convert(l.center):n.center,n.zoom).center;n.setCenter(g.wrap());const x=l.zoom!==void 0?+l.zoom:n.zoom+$i(p,g.lat);n.zoom!==x&&n.setZoom(x)}handleEaseTo(n,l){const p=n.zoom,g=n.center,x=n.padding,w={roll:n.roll,pitch:n.pitch,bearing:n.bearing},P={roll:l.roll===void 0?n.roll:l.roll,pitch:l.pitch===void 0?n.pitch:l.pitch,bearing:l.bearing===void 0?n.bearing:l.bearing},I=l.zoom!==void 0,R=!n.isPaddingEqual(l.padding);let O=!1;const N=l.center?a.Q.convert(l.center):g,B=n.getConstrained(N,p).center;il(n,B);const W=n.clone();W.setCenter(B),W.setZoom(I?+l.zoom:p+$i(g.lat,N.lat)),W.setBearing(l.bearing);const X=new a.P(a.ae(n.centerPoint.x+l.offsetAsPoint.x,0,n.width),a.ae(n.centerPoint.y+l.offsetAsPoint.y,0,n.height));W.setLocationAtPoint(B,X);const te=(l.offset&&l.offsetAsPoint.mag())>0?W.center:B,Q=I?+l.zoom:p+$i(g.lat,te.lat),ie=p+$i(g.lat,0),se=Q+$i(te.lat,0),ue=a.bn(g.lng,te.lng),fe=a.bn(g.lat,te.lat),de=a.aI(se-ie);return O=Q!==p,{easeFunc:ve=>{if(a.b6(w,P)||os({startEulerAngles:w,endEulerAngles:P,tr:n,k:ve,useSlerp:w.roll!=P.roll}),R&&n.interpolatePadding(x,l.padding,ve),l.around)a.w("Easing around a point is not supported under globe projection."),n.setLocationAtPoint(l.around,l.aroundPoint);else{const ge=se>ie?Math.min(2,de):Math.max(.5,de),De=Math.pow(ge,1-ve),ke=Mc(g,ue,fe,ve*De);n.setCenter(ke.wrap())}if(O){const ge=a.B.number(ie,se,ve)+$i(0,n.center.lat);n.setZoom(ge)}},isZooming:O,elevationCenter:te}}handleFlyTo(n,l){const p=l.zoom!==void 0,g=n.center,x=n.zoom,w=n.padding,P=!n.isPaddingEqual(l.padding),I=n.getConstrained(a.Q.convert(l.center||l.locationAtOffset),x).center,R=p?+l.zoom:n.zoom+$i(n.center.lat,I.lat),O=n.clone();O.setCenter(I),O.setZoom(R),O.setBearing(l.bearing);const N=new a.P(a.ae(n.centerPoint.x+l.offsetAsPoint.x,0,n.width),a.ae(n.centerPoint.y+l.offsetAsPoint.y,0,n.height));O.setLocationAtPoint(I,N);const B=O.center;il(n,B);const W=function(fe,de,ve){const ge=ur(de),De=ur(ve),ke=a.aV(ge,De),We=Math.acos(ke),Ze=Lh(fe);return We/(2*Math.PI)*Ze}(n,g,B),X=x+$i(g.lat,0),te=R+$i(B.lat,0),Q=a.aI(te-X);let ie;if(typeof l.minZoom=="number"){const fe=+l.minZoom+$i(B.lat,0),de=Math.min(fe,X,te)+$i(0,B.lat),ve=n.getConstrained(B,de).zoom+$i(B.lat,0);ie=a.aI(ve-X)}const se=a.bn(g.lng,B.lng),ue=a.bn(g.lat,B.lat);return{easeFunc:(fe,de,ve,ge)=>{const De=Mc(g,se,ue,ve);P&&n.interpolatePadding(w,l.padding,fe);const ke=fe===1?B:De;n.setCenter(ke.wrap());const We=X+a.ab(de);n.setZoom(fe===1?R:We+$i(0,ke.lat))},scaleOfZoom:Q,targetCenter:B,scaleOfMinZoom:ie,pixelPathLength:W}}static solveVectorScale(n,l,p,g,x){const w=g==="x"?[p[0],p[4],p[8],p[12]]:[p[1],p[5],p[9],p[13]],P=[p[3],p[7],p[11],p[15]],I=n[0]*w[0]+n[1]*w[1]+n[2]*w[2],R=n[0]*P[0]+n[1]*P[1]+n[2]*P[2],O=l[0]*w[0]+l[1]*w[1]+l[2]*w[2],N=l[0]*P[0]+l[1]*P[1]+l[2]*P[2];return O+x*R===I+x*N||P[3]*(I-O)+w[3]*(N-R)+I*N==O*R?null:(O+w[3]-x*N-x*P[3])/(O-I-x*N+x*R)}static getLesserNonNegativeNonNull(n,l){return l!==null&&l>=0&&l<n?l:n}}class zh{constructor(n){this._globe=n,this._mercatorCameraHelper=new Mr,this._verticalPerspectiveCameraHelper=new nn}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(n,l){return this.currentHelper.handlePanInertia(n,l)}handleMapControlsRollPitchBearingZoom(n,l){return this.currentHelper.handleMapControlsRollPitchBearingZoom(n,l)}handleMapControlsPan(n,l,p){this.currentHelper.handleMapControlsPan(n,l,p)}cameraForBoxAndBearing(n,l,p,g,x){return this.currentHelper.cameraForBoxAndBearing(n,l,p,g,x)}handleJumpToCenterZoom(n,l){this.currentHelper.handleJumpToCenterZoom(n,l)}handleEaseTo(n,l){return this.currentHelper.handleEaseTo(n,l)}handleFlyTo(n,l){return this.currentHelper.handleFlyTo(n,l)}}const Rs=(_,n)=>a.x(_,n&&n.filter(l=>l.identifier!=="source.canvas")),kc=a.bu();class _o extends a.E{constructor(n,l={}){super(),this._rtlPluginLoaded=()=>{for(const p in this.sourceCaches){const g=this.sourceCaches[p].getSource().type;g!=="vector"&&g!=="geojson"||this.sourceCaches[p].reload()}},this.map=n,this.dispatcher=new ei(ai(),n._getMapId()),this.dispatcher.registerMessageHandler("GG",(p,g)=>this.getGlyphs(p,g)),this.dispatcher.registerMessageHandler("GI",(p,g)=>this.getImages(p,g)),this.imageManager=new Bt,this.imageManager.setEventedParent(this),this.glyphManager=new kt(n._requestManager,l.localIdeographFontFamily),this.lineAtlas=new Qe(256,512),this.crossTileSymbolIndex=new tl,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new a.bv,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",a.bw()),Cn().on(Es,this._rtlPluginLoaded),this.on("data",p=>{if(p.dataType!=="source"||p.sourceDataType!=="metadata")return;const g=this.sourceCaches[p.sourceId];if(!g)return;const x=g.getSource();if(x&&x.vectorLayerIds)for(const w in this._layers){const P=this._layers[w];P.source===x.id&&this._validateLayer(P)}})}loadURL(n,l={},p){this.fire(new a.l("dataloading",{dataType:"style"})),l.validate=typeof l.validate!="boolean"||l.validate;const g=this.map._requestManager.transformRequest(n,"Style");this._loadStyleRequest=new AbortController;const x=this._loadStyleRequest;a.j(g,this._loadStyleRequest).then(w=>{this._loadStyleRequest=null,this._load(w.data,l,p)}).catch(w=>{this._loadStyleRequest=null,w&&!x.signal.aborted&&this.fire(new a.k(w))})}loadJSON(n,l={},p){this.fire(new a.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,F.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,l.validate=l.validate!==!1,this._load(n,l,p)}).catch(()=>{})}loadEmpty(){this.fire(new a.l("dataloading",{dataType:"style"})),this._load(kc,{validate:!1})}_load(n,l,p){var g,x;const w=l.transformStyle?l.transformStyle(p,n):n;if(!l.validate||!Rs(this,a.y(w))){this._loaded=!0,this.stylesheet=w;for(const P in w.sources)this.addSource(P,w.sources[P],{validate:!1});w.sprite?this._loadSprite(w.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(w.glyphs),this._createLayers(),this.light=new Le(this.stylesheet.light),this._setProjectionInternal(((g=this.stylesheet.projection)===null||g===void 0?void 0:g.type)||"mercator"),this.sky=new Ke(this.stylesheet.sky),this.map.setTerrain((x=this.stylesheet.terrain)!==null&&x!==void 0?x:null),this.fire(new a.l("data",{dataType:"style"})),this.fire(new a.l("style.load"))}}_createLayers(){const n=a.bx(this.stylesheet.layers);this.dispatcher.broadcast("SL",n),this._order=n.map(l=>l.id),this._layers={},this._serializedLayers=null;for(const l of n){const p=a.by(l);p.setEventedParent(this,{layer:{id:l.id}}),this._layers[l.id]=p}}_loadSprite(n,l=!1,p=void 0){let g;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(x,w,P,I){return a._(this,void 0,void 0,function*(){const R=Xe(x),O=P>1?"@2x":"",N={},B={};for(const{id:W,url:X}of R){const te=w.transformRequest(gt(X,O,".json"),"SpriteJSON");N[W]=a.j(te,I);const Q=w.transformRequest(gt(X,O,".png"),"SpriteImage");B[W]=Ce.getImage(Q,I)}return yield Promise.all([...Object.values(N),...Object.values(B)]),function(W,X){return a._(this,void 0,void 0,function*(){const te={};for(const Q in W){te[Q]={};const ie=F.getImageCanvasContext((yield X[Q]).data),se=(yield W[Q]).data;for(const ue in se){const{width:fe,height:de,x:ve,y:ge,sdf:De,pixelRatio:ke,stretchX:We,stretchY:Ze,content:je,textFitWidth:lt,textFitHeight:at}=se[ue];te[Q][ue]={data:null,pixelRatio:ke,sdf:De,stretchX:We,stretchY:Ze,content:je,textFitWidth:lt,textFitHeight:at,spriteData:{width:fe,height:de,x:ve,y:ge,context:ie}}}}return te})}(N,B)})}(n,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(x=>{if(this._spriteRequest=null,x)for(const w in x){this._spritesImagesIds[w]=[];const P=this._spritesImagesIds[w]?this._spritesImagesIds[w].filter(I=>!(I in x)):[];for(const I of P)this.imageManager.removeImage(I),this._changedImages[I]=!0;for(const I in x[w]){const R=w==="default"?I:`${w}:${I}`;this._spritesImagesIds[w].push(R),R in this.imageManager.images?this.imageManager.updateImage(R,x[w][I],!1):this.imageManager.addImage(R,x[w][I]),l&&(this._changedImages[R]=!0)}}}).catch(x=>{this._spriteRequest=null,g=x,this.fire(new a.k(g))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),l&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"})),p&&p(g)})}_unloadSprite(){for(const n of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(n),this._changedImages[n]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"}))}_validateLayer(n){const l=this.sourceCaches[n.source];if(!l)return;const p=n.sourceLayer;if(!p)return;const g=l.getSource();(g.type==="geojson"||g.vectorLayerIds&&g.vectorLayerIds.indexOf(p)===-1)&&this.fire(new a.k(new Error(`Source layer "${p}" does not exist on source "${g.id}" as specified by style layer "${n.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const n in this.sourceCaches)if(!this.sourceCaches[n].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(n,l=!1){const p=this._serializedAllLayers();if(!n||n.length===0)return Object.values(l?a.bz(p):p);const g=[];for(const x of n)if(p[x]){const w=l?a.bz(p[x]):p[x];g.push(w)}return g}_serializedAllLayers(){let n=this._serializedLayers;if(n)return n;n=this._serializedLayers={};const l=Object.keys(this._layers);for(const p of l){const g=this._layers[p];g.type!=="custom"&&(n[p]=g.serialize())}return n}hasTransitions(){var n,l,p;if(!((n=this.light)===null||n===void 0)&&n.hasTransition()||!((l=this.sky)===null||l===void 0)&&l.hasTransition()||!((p=this.projection)===null||p===void 0)&&p.hasTransition())return!0;for(const g in this.sourceCaches)if(this.sourceCaches[g].hasTransition())return!0;for(const g in this._layers)if(this._layers[g].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(n){if(!this._loaded)return;const l=this._changed;if(l){const g=Object.keys(this._updatedLayers),x=Object.keys(this._removedLayers);(g.length||x.length)&&this._updateWorkerLayers(g,x);for(const w in this._updatedSources){const P=this._updatedSources[w];if(P==="reload")this._reloadSource(w);else{if(P!=="clear")throw new Error(`Invalid action ${P}`);this._clearSource(w)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const w in this._updatedPaintProps)this._layers[w].updateTransitions(n);this.light.updateTransitions(n),this.sky.updateTransitions(n),this._resetUpdates()}const p={};for(const g in this.sourceCaches){const x=this.sourceCaches[g];p[g]=x.used,x.used=!1}for(const g of this._order){const x=this._layers[g];x.recalculate(n,this._availableImages),!x.isHidden(n.zoom)&&x.source&&(this.sourceCaches[x.source].used=!0)}for(const g in p){const x=this.sourceCaches[g];!!p[g]!=!!x.used&&x.fire(new a.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:g}))}this.light.recalculate(n),this.sky.recalculate(n),this.projection.recalculate(n),this.z=n.zoom,l&&this.fire(new a.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const n=Object.keys(this._changedImages);if(n.length){for(const l in this.sourceCaches)this.sourceCaches[l].reloadTilesForDependencies(["icons","patterns"],n);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(n,l){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(n,!1),removedIds:l})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(n,l={}){var p;this._checkLoaded();const g=this.serialize();if(n=l.transformStyle?l.transformStyle(g,n):n,((p=l.validate)===null||p===void 0||p)&&Rs(this,a.y(n)))return!1;(n=a.bz(n)).layers=a.bx(n.layers);const x=a.bA(g,n),w=this._getOperationsToPerform(x);if(w.unimplemented.length>0)throw new Error(`Unimplemented: ${w.unimplemented.join(", ")}.`);if(w.operations.length===0)return!1;for(const P of w.operations)P();return this.stylesheet=n,this._serializedLayers=null,!0}_getOperationsToPerform(n){const l=[],p=[];for(const g of n)switch(g.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":l.push(()=>this.addLayer.apply(this,g.args));break;case"removeLayer":l.push(()=>this.removeLayer.apply(this,g.args));break;case"setPaintProperty":l.push(()=>this.setPaintProperty.apply(this,g.args));break;case"setLayoutProperty":l.push(()=>this.setLayoutProperty.apply(this,g.args));break;case"setFilter":l.push(()=>this.setFilter.apply(this,g.args));break;case"addSource":l.push(()=>this.addSource.apply(this,g.args));break;case"removeSource":l.push(()=>this.removeSource.apply(this,g.args));break;case"setLayerZoomRange":l.push(()=>this.setLayerZoomRange.apply(this,g.args));break;case"setLight":l.push(()=>this.setLight.apply(this,g.args));break;case"setGeoJSONSourceData":l.push(()=>this.setGeoJSONSourceData.apply(this,g.args));break;case"setGlyphs":l.push(()=>this.setGlyphs.apply(this,g.args));break;case"setSprite":l.push(()=>this.setSprite.apply(this,g.args));break;case"setTerrain":l.push(()=>this.map.setTerrain.apply(this,g.args));break;case"setSky":l.push(()=>this.setSky.apply(this,g.args));break;case"setProjection":this.setProjection.apply(this,g.args);break;case"setTransition":l.push(()=>{});break;default:p.push(g.command)}return{operations:l,unimplemented:p}}addImage(n,l){if(this.getImage(n))return this.fire(new a.k(new Error(`An image named "${n}" already exists.`)));this.imageManager.addImage(n,l),this._afterImageUpdated(n)}updateImage(n,l){this.imageManager.updateImage(n,l)}getImage(n){return this.imageManager.getImage(n)}removeImage(n){if(!this.getImage(n))return this.fire(new a.k(new Error(`An image named "${n}" does not exist.`)));this.imageManager.removeImage(n),this._afterImageUpdated(n)}_afterImageUpdated(n){this._availableImages=this.imageManager.listImages(),this._changedImages[n]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(n,l,p={}){if(this._checkLoaded(),this.sourceCaches[n]!==void 0)throw new Error(`Source "${n}" already exists.`);if(!l.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(l).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(l.type)>=0&&this._validate(a.y.source,`sources.${n}`,l,null,p))return;this.map&&this.map._collectResourceTiming&&(l.collectResourceTiming=!0);const g=this.sourceCaches[n]=new Z(n,l,this.dispatcher);g.style=this,g.setEventedParent(this,()=>({isSourceLoaded:g.loaded(),source:g.serialize(),sourceId:n})),g.onAdd(this.map),this._changed=!0}removeSource(n){if(this._checkLoaded(),this.sourceCaches[n]===void 0)throw new Error("There is no source with this ID");for(const p in this._layers)if(this._layers[p].source===n)return this.fire(new a.k(new Error(`Source "${n}" cannot be removed while layer "${p}" is using it.`)));const l=this.sourceCaches[n];delete this.sourceCaches[n],delete this._updatedSources[n],l.fire(new a.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:n})),l.setEventedParent(null),l.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(n,l){if(this._checkLoaded(),this.sourceCaches[n]===void 0)throw new Error(`There is no source with this ID=${n}`);const p=this.sourceCaches[n].getSource();if(p.type!=="geojson")throw new Error(`geojsonSource.type is ${p.type}, which is !== 'geojson`);p.setData(l),this._changed=!0}getSource(n){return this.sourceCaches[n]&&this.sourceCaches[n].getSource()}addLayer(n,l,p={}){this._checkLoaded();const g=n.id;if(this.getLayer(g))return void this.fire(new a.k(new Error(`Layer "${g}" already exists on this map.`)));let x;if(n.type==="custom"){if(Rs(this,a.bB(n)))return;x=a.by(n)}else{if("source"in n&&typeof n.source=="object"&&(this.addSource(g,n.source),n=a.bz(n),n=a.e(n,{source:g})),this._validate(a.y.layer,`layers.${g}`,n,{arrayIndex:-1},p))return;x=a.by(n),this._validateLayer(x),x.setEventedParent(this,{layer:{id:g}})}const w=l?this._order.indexOf(l):this._order.length;if(l&&w===-1)this.fire(new a.k(new Error(`Cannot add layer "${g}" before non-existing layer "${l}".`)));else{if(this._order.splice(w,0,g),this._layerOrderChanged=!0,this._layers[g]=x,this._removedLayers[g]&&x.source&&x.type!=="custom"){const P=this._removedLayers[g];delete this._removedLayers[g],P.type!==x.type?this._updatedSources[x.source]="clear":(this._updatedSources[x.source]="reload",this.sourceCaches[x.source].pause())}this._updateLayer(x),x.onAdd&&x.onAdd(this.map)}}moveLayer(n,l){if(this._checkLoaded(),this._changed=!0,!this._layers[n])return void this.fire(new a.k(new Error(`The layer '${n}' does not exist in the map's style and cannot be moved.`)));if(n===l)return;const p=this._order.indexOf(n);this._order.splice(p,1);const g=l?this._order.indexOf(l):this._order.length;l&&g===-1?this.fire(new a.k(new Error(`Cannot move layer "${n}" before non-existing layer "${l}".`))):(this._order.splice(g,0,n),this._layerOrderChanged=!0)}removeLayer(n){this._checkLoaded();const l=this._layers[n];if(!l)return void this.fire(new a.k(new Error(`Cannot remove non-existing layer "${n}".`)));l.setEventedParent(null);const p=this._order.indexOf(n);this._order.splice(p,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[n]=l,delete this._layers[n],this._serializedLayers&&delete this._serializedLayers[n],delete this._updatedLayers[n],delete this._updatedPaintProps[n],l.onRemove&&l.onRemove(this.map)}getLayer(n){return this._layers[n]}getLayersOrder(){return[...this._order]}hasLayer(n){return n in this._layers}setLayerZoomRange(n,l,p){this._checkLoaded();const g=this.getLayer(n);g?g.minzoom===l&&g.maxzoom===p||(l!=null&&(g.minzoom=l),p!=null&&(g.maxzoom=p),this._updateLayer(g)):this.fire(new a.k(new Error(`Cannot set the zoom range of non-existing layer "${n}".`)))}setFilter(n,l,p={}){this._checkLoaded();const g=this.getLayer(n);if(g){if(!a.bC(g.filter,l))return l==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(a.y.filter,`layers.${g.id}.filter`,l,null,p)||(g.filter=a.bz(l),this._updateLayer(g)))}else this.fire(new a.k(new Error(`Cannot filter non-existing layer "${n}".`)))}getFilter(n){return a.bz(this.getLayer(n).filter)}setLayoutProperty(n,l,p,g={}){this._checkLoaded();const x=this.getLayer(n);x?a.bC(x.getLayoutProperty(l),p)||(x.setLayoutProperty(l,p,g),this._updateLayer(x)):this.fire(new a.k(new Error(`Cannot style non-existing layer "${n}".`)))}getLayoutProperty(n,l){const p=this.getLayer(n);if(p)return p.getLayoutProperty(l);this.fire(new a.k(new Error(`Cannot get style of non-existing layer "${n}".`)))}setPaintProperty(n,l,p,g={}){this._checkLoaded();const x=this.getLayer(n);x?a.bC(x.getPaintProperty(l),p)||(x.setPaintProperty(l,p,g)&&this._updateLayer(x),this._changed=!0,this._updatedPaintProps[n]=!0,this._serializedLayers=null):this.fire(new a.k(new Error(`Cannot style non-existing layer "${n}".`)))}getPaintProperty(n,l){return this.getLayer(n).getPaintProperty(l)}setFeatureState(n,l){this._checkLoaded();const p=n.source,g=n.sourceLayer,x=this.sourceCaches[p];if(x===void 0)return void this.fire(new a.k(new Error(`The source '${p}' does not exist in the map's style.`)));const w=x.getSource().type;w==="geojson"&&g?this.fire(new a.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):w!=="vector"||g?(n.id===void 0&&this.fire(new a.k(new Error("The feature id parameter must be provided."))),x.setFeatureState(g,n.id,l)):this.fire(new a.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(n,l){this._checkLoaded();const p=n.source,g=this.sourceCaches[p];if(g===void 0)return void this.fire(new a.k(new Error(`The source '${p}' does not exist in the map's style.`)));const x=g.getSource().type,w=x==="vector"?n.sourceLayer:void 0;x!=="vector"||w?l&&typeof n.id!="string"&&typeof n.id!="number"?this.fire(new a.k(new Error("A feature id is required to remove its specific state property."))):g.removeFeatureState(w,n.id,l):this.fire(new a.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(n){this._checkLoaded();const l=n.source,p=n.sourceLayer,g=this.sourceCaches[l];if(g!==void 0)return g.getSource().type!=="vector"||p?(n.id===void 0&&this.fire(new a.k(new Error("The feature id parameter must be provided."))),g.getFeatureState(p,n.id)):void this.fire(new a.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new a.k(new Error(`The source '${l}' does not exist in the map's style.`)))}getTransition(){return a.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const n=a.bD(this.sourceCaches,x=>x.serialize()),l=this._serializeByIds(this._order,!0),p=this.map.getTerrain()||void 0,g=this.stylesheet;return a.bE({version:g.version,name:g.name,metadata:g.metadata,light:g.light,sky:g.sky,center:g.center,zoom:g.zoom,bearing:g.bearing,pitch:g.pitch,sprite:g.sprite,glyphs:g.glyphs,transition:g.transition,projection:g.projection,sources:n,layers:l,terrain:p},x=>x!==void 0)}_updateLayer(n){this._updatedLayers[n.id]=!0,n.source&&!this._updatedSources[n.source]&&this.sourceCaches[n.source].getSource().type!=="raster"&&(this._updatedSources[n.source]="reload",this.sourceCaches[n.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(n){const l=w=>this._layers[w].type==="fill-extrusion",p={},g=[];for(let w=this._order.length-1;w>=0;w--){const P=this._order[w];if(l(P)){p[P]=w;for(const I of n){const R=I[P];if(R)for(const O of R)g.push(O)}}}g.sort((w,P)=>P.intersectionZ-w.intersectionZ);const x=[];for(let w=this._order.length-1;w>=0;w--){const P=this._order[w];if(l(P))for(let I=g.length-1;I>=0;I--){const R=g[I].feature;if(p[R.layer.id]<w)break;x.push(R),g.pop()}else for(const I of n){const R=I[P];if(R)for(const O of R)x.push(O.feature)}}return x}queryRenderedFeatures(n,l,p){l&&l.filter&&this._validate(a.y.filter,"queryRenderedFeatures.filter",l.filter,null,l);const g={};if(l&&l.layers){if(!(Array.isArray(l.layers)||l.layers instanceof Set))return this.fire(new a.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const R of l.layers){const O=this._layers[R];if(!O)return this.fire(new a.k(new Error(`The layer '${R}' does not exist in the map's style and cannot be queried for features.`))),[];g[O.source]=!0}}const x=[];l.availableImages=this._availableImages;const w=this._serializedAllLayers(),P=l.layers instanceof Set?l.layers:Array.isArray(l.layers)?new Set(l.layers):null,I=Object.assign(Object.assign({},l),{layers:P});for(const R in this.sourceCaches)l.layers&&!g[R]||x.push(si(this.sourceCaches[R],this._layers,w,n,I,p,this.map.terrain?(O,N,B)=>this.map.terrain.getElevation(O,N,B):void 0));return this.placement&&x.push(function(R,O,N,B,W,X,te){const Q={},ie=X.queryRenderedSymbols(B),se=[];for(const ue of Object.keys(ie).map(Number))se.push(te[ue]);se.sort(Li);for(const ue of se){const fe=ue.featureIndex.lookupSymbolFeatures(ie[ue.bucketInstanceId],O,ue.bucketIndex,ue.sourceLayerIndex,W.filter,W.layers,W.availableImages,R);for(const de in fe){const ve=Q[de]=Q[de]||[],ge=fe[de];ge.sort((De,ke)=>{const We=ue.featureSortOrder;if(We){const Ze=We.indexOf(De.featureIndex);return We.indexOf(ke.featureIndex)-Ze}return ke.featureIndex-De.featureIndex});for(const De of ge)ve.push(De)}}return function(ue,fe,de){for(const ve in ue)for(const ge of ue[ve])Ti(ge,de[fe[ve].source]);return ue}(Q,R,N)}(this._layers,w,this.sourceCaches,n,I,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(x)}querySourceFeatures(n,l){l&&l.filter&&this._validate(a.y.filter,"querySourceFeatures.filter",l.filter,null,l);const p=this.sourceCaches[n];return p?function(g,x){const w=g.getRenderableIds().map(R=>g.getTileByID(R)),P=[],I={};for(let R=0;R<w.length;R++){const O=w[R],N=O.tileID.canonical.key;I[N]||(I[N]=!0,O.querySourceFeatures(P,x))}return P}(p,l):[]}getLight(){return this.light.getLight()}setLight(n,l={}){this._checkLoaded();const p=this.light.getLight();let g=!1;for(const w in n)if(!a.bC(n[w],p[w])){g=!0;break}if(!g)return;const x={now:F.now(),transition:a.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(n,l),this.light.updateTransitions(x)}getProjection(){var n;return(n=this.stylesheet)===null||n===void 0?void 0:n.projection}setProjection(n){if(this._checkLoaded(),this.projection){if(this.projection.name===n.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=n,this._setProjectionInternal(n.type)}getSky(){var n;return(n=this.stylesheet)===null||n===void 0?void 0:n.sky}setSky(n,l={}){this._checkLoaded();const p=this.getSky();let g=!1;if(!n&&!p)return;if(n&&!p)g=!0;else if(!n&&p)g=!0;else for(const w in n)if(!a.bC(n[w],p[w])){g=!0;break}if(!g)return;const x={now:F.now(),transition:a.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=n,this.sky.setSky(n,l),this.sky.updateTransitions(x)}_setProjectionInternal(n){const l=function(p){if(Array.isArray(p)){const g=new go({type:p});return{projection:g,transform:new al,cameraHelper:new zh(g)}}switch(p){case"mercator":return{projection:new Jt,transform:new Pi,cameraHelper:new Mr};case"globe":{const g=new go({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:g,transform:new al,cameraHelper:new zh(g)}}case"vertical-perspective":return{projection:new ua,transform:new ol,cameraHelper:new nn};default:return a.w(`Unknown projection name: ${p}. Falling back to mercator projection.`),{projection:new Jt,transform:new Pi,cameraHelper:new Mr}}}(n);this.projection=l.projection,this.map.migrateProjection(l.transform,l.cameraHelper);for(const p in this.sourceCaches)this.sourceCaches[p].reload()}_validate(n,l,p,g,x={}){return(!x||x.validate!==!1)&&Rs(this,n.call(a.y,a.e({key:l,style:this.serialize(),value:p,styleSpec:a.v},g)))}_remove(n=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Cn().off(Es,this._rtlPluginLoaded);for(const l in this._layers)this._layers[l].setEventedParent(null);for(const l in this.sourceCaches){const p=this.sourceCaches[l];p.setEventedParent(null),p.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),n&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(n)}_clearSource(n){this.sourceCaches[n].clearTiles()}_reloadSource(n){this.sourceCaches[n].resume(),this.sourceCaches[n].reload()}_updateSources(n){for(const l in this.sourceCaches)this.sourceCaches[l].update(n,this.map.terrain)}_generateCollisionBoxes(){for(const n in this.sourceCaches)this._reloadSource(n)}_updatePlacement(n,l,p,g,x=!1){let w=!1,P=!1;const I={};for(const R of this._order){const O=this._layers[R];if(O.type!=="symbol")continue;if(!I[O.source]){const B=this.sourceCaches[O.source];I[O.source]=B.getRenderableIds(!0).map(W=>B.getTileByID(W)).sort((W,X)=>X.tileID.overscaledZ-W.tileID.overscaledZ||(W.tileID.isLessThan(X.tileID)?-1:1))}const N=this.crossTileSymbolIndex.addLayer(O,I[O.source],n.center.lng);w=w||N}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((x=x||this._layerOrderChanged||p===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(F.now(),n.zoom))&&(this.pauseablePlacement=new Dh(n,this.map.terrain,this._order,x,l,p,g,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,I),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(F.now()),P=!0),w&&this.pauseablePlacement.placement.setStale()),P||w)for(const R of this._order){const O=this._layers[R];O.type==="symbol"&&this.placement.updateLayerOpacities(O,I[O.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(F.now())}_releaseSymbolFadeTiles(){for(const n in this.sourceCaches)this.sourceCaches[n].releaseSymbolFadeTiles()}getImages(n,l){return a._(this,void 0,void 0,function*(){const p=yield this.imageManager.getImages(l.icons);this._updateTilesForChangedImages();const g=this.sourceCaches[l.source];return g&&g.setDependencies(l.tileID.key,l.type,l.icons),p})}getGlyphs(n,l){return a._(this,void 0,void 0,function*(){const p=yield this.glyphManager.getGlyphs(l.stacks),g=this.sourceCaches[l.source];return g&&g.setDependencies(l.tileID.key,l.type,[""]),p})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(n,l={}){this._checkLoaded(),n&&this._validate(a.y.glyphs,"glyphs",n,null,l)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=n,this.glyphManager.entries={},this.glyphManager.setURL(n))}addSprite(n,l,p={},g){this._checkLoaded();const x=[{id:n,url:l}],w=[...Xe(this.stylesheet.sprite),...x];this._validate(a.y.sprite,"sprite",w,null,p)||(this.stylesheet.sprite=w,this._loadSprite(x,!0,g))}removeSprite(n){this._checkLoaded();const l=Xe(this.stylesheet.sprite);if(l.find(p=>p.id===n)){if(this._spritesImagesIds[n])for(const p of this._spritesImagesIds[n])this.imageManager.removeImage(p),this._changedImages[p]=!0;l.splice(l.findIndex(p=>p.id===n),1),this.stylesheet.sprite=l.length>0?l:void 0,delete this._spritesImagesIds[n],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"}))}else this.fire(new a.k(new Error(`Sprite "${n}" doesn't exists on this map.`)))}getSprite(){return Xe(this.stylesheet.sprite)}setSprite(n,l={},p){this._checkLoaded(),n&&this._validate(a.y.sprite,"sprite",n,null,l)||(this.stylesheet.sprite=n,n?this._loadSprite(n,!0,p):(this._unloadSprite(),p&&p(null)))}}var Dc=a.aD([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Oc{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(n,l,p,g,x,w,P,I,R){this.context=n;let O=this.boundPaintVertexBuffers.length!==g.length;for(let N=0;!O&&N<g.length;N++)this.boundPaintVertexBuffers[N]!==g[N]&&(O=!0);!this.vao||this.boundProgram!==l||this.boundLayoutVertexBuffer!==p||O||this.boundIndexBuffer!==x||this.boundVertexOffset!==w||this.boundDynamicVertexBuffer!==P||this.boundDynamicVertexBuffer2!==I||this.boundDynamicVertexBuffer3!==R?this.freshBind(l,p,g,x,w,P,I,R):(n.bindVertexArray.set(this.vao),P&&P.bind(),x&&x.dynamicDraw&&x.bind(),I&&I.bind(),R&&R.bind())}freshBind(n,l,p,g,x,w,P,I){const R=n.numAttributes,O=this.context,N=O.gl;this.vao&&this.destroy(),this.vao=O.createVertexArray(),O.bindVertexArray.set(this.vao),this.boundProgram=n,this.boundLayoutVertexBuffer=l,this.boundPaintVertexBuffers=p,this.boundIndexBuffer=g,this.boundVertexOffset=x,this.boundDynamicVertexBuffer=w,this.boundDynamicVertexBuffer2=P,this.boundDynamicVertexBuffer3=I,l.enableAttributes(N,n);for(const B of p)B.enableAttributes(N,n);w&&w.enableAttributes(N,n),P&&P.enableAttributes(N,n),I&&I.enableAttributes(N,n),l.bind(),l.setVertexAttribPointers(N,n,x);for(const B of p)B.bind(),B.setVertexAttribPointers(N,n,x);w&&(w.bind(),w.setVertexAttribPointers(N,n,x)),g&&g.bind(),P&&(P.bind(),P.setVertexAttribPointers(N,n,x)),I&&(I.bind(),I.setVertexAttribPointers(N,n,x)),O.currentNumAttributes=R}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const gn=(_,n,l,p,g)=>({u_texture:0,u_ele_delta:_,u_fog_matrix:n,u_fog_color:l?l.properties.get("fog-color"):a.b7.white,u_fog_ground_blend:l?l.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:g?0:l?l.calculateFogBlendOpacity(p):0,u_horizon_color:l?l.properties.get("horizon-color"):a.b7.white,u_horizon_fog_blend:l?l.properties.get("horizon-fog-blend"):1,u_is_globe_mode:g?1:0}),jp={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function yo(_){const n=[];for(let l=0;l<_.length;l++){if(_[l]===null)continue;const p=_[l].split(" ");n.push(p.pop())}return n}class ha{constructor(n,l,p,g,x,w,P,I){const R=n.gl;this.program=R.createProgram();const O=yo(l.staticAttributes),N=p?p.getBinderAttributes():[],B=O.concat(N),W=en.prelude.staticUniforms?yo(en.prelude.staticUniforms):[],X=P.staticUniforms?yo(P.staticUniforms):[],te=l.staticUniforms?yo(l.staticUniforms):[],Q=p?p.getBinderUniforms():[],ie=W.concat(X).concat(te).concat(Q),se=[];for(const ke of ie)se.indexOf(ke)<0&&se.push(ke);const ue=p?p.defines():[];tn(R)&&ue.unshift("#version 300 es"),x&&ue.push("#define OVERDRAW_INSPECTOR;"),w&&ue.push("#define TERRAIN3D;"),I&&ue.push(I);let fe=ue.concat(en.prelude.fragmentSource,P.fragmentSource,l.fragmentSource).join(`
`),de=ue.concat(en.prelude.vertexSource,P.vertexSource,l.vertexSource).join(`
`);tn(R)||(fe=function(ke){return ke.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(fe),de=function(ke){return ke.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(de));const ve=R.createShader(R.FRAGMENT_SHADER);if(R.isContextLost())return void(this.failedToCreate=!0);if(R.shaderSource(ve,fe),R.compileShader(ve),!R.getShaderParameter(ve,R.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${R.getShaderInfoLog(ve)}`);R.attachShader(this.program,ve);const ge=R.createShader(R.VERTEX_SHADER);if(R.isContextLost())return void(this.failedToCreate=!0);if(R.shaderSource(ge,de),R.compileShader(ge),!R.getShaderParameter(ge,R.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${R.getShaderInfoLog(ge)}`);R.attachShader(this.program,ge),this.attributes={};const De={};this.numAttributes=B.length;for(let ke=0;ke<this.numAttributes;ke++)B[ke]&&(R.bindAttribLocation(this.program,ke,B[ke]),this.attributes[B[ke]]=ke);if(R.linkProgram(this.program),!R.getProgramParameter(this.program,R.LINK_STATUS))throw new Error(`Program failed to link: ${R.getProgramInfoLog(this.program)}`);R.deleteShader(ge),R.deleteShader(ve);for(let ke=0;ke<se.length;ke++){const We=se[ke];if(We&&!De[We]){const Ze=R.getUniformLocation(this.program,We);Ze&&(De[We]=Ze)}}this.fixedUniforms=g(n,De),this.terrainUniforms=((ke,We)=>({u_depth:new a.bF(ke,We.u_depth),u_terrain:new a.bF(ke,We.u_terrain),u_terrain_dim:new a.b8(ke,We.u_terrain_dim),u_terrain_matrix:new a.bH(ke,We.u_terrain_matrix),u_terrain_unpack:new a.bI(ke,We.u_terrain_unpack),u_terrain_exaggeration:new a.b8(ke,We.u_terrain_exaggeration)}))(n,De),this.projectionUniforms=((ke,We)=>({u_projection_matrix:new a.bH(ke,We.u_projection_matrix),u_projection_tile_mercator_coords:new a.bI(ke,We.u_projection_tile_mercator_coords),u_projection_clipping_plane:new a.bI(ke,We.u_projection_clipping_plane),u_projection_transition:new a.b8(ke,We.u_projection_transition),u_projection_fallback_matrix:new a.bH(ke,We.u_projection_fallback_matrix)}))(n,De),this.binderUniforms=p?p.getUniforms(n,De):[]}draw(n,l,p,g,x,w,P,I,R,O,N,B,W,X,te,Q,ie,se,ue){const fe=n.gl;if(this.failedToCreate)return;if(n.program.set(this.program),n.setDepthMode(p),n.setStencilMode(g),n.setColorMode(x),n.setCullFace(w),I){n.activeTexture.set(fe.TEXTURE2),fe.bindTexture(fe.TEXTURE_2D,I.depthTexture),n.activeTexture.set(fe.TEXTURE3),fe.bindTexture(fe.TEXTURE_2D,I.texture);for(const ve in this.terrainUniforms)this.terrainUniforms[ve].set(I[ve])}if(R)for(const ve in R)this.projectionUniforms[jp[ve]].set(R[ve]);if(P)for(const ve in this.fixedUniforms)this.fixedUniforms[ve].set(P[ve]);Q&&Q.setUniforms(n,this.binderUniforms,X,{zoom:te});let de=0;switch(l){case fe.LINES:de=2;break;case fe.TRIANGLES:de=3;break;case fe.LINE_STRIP:de=1}for(const ve of W.get()){const ge=ve.vaos||(ve.vaos={});(ge[O]||(ge[O]=new Oc)).bind(n,this,N,Q?Q.getPaintVertexBuffers():[],B,ve.vertexOffset,ie,se,ue),fe.drawElements(l,ve.primitiveLength*de,fe.UNSIGNED_SHORT,ve.primitiveOffset*de*2)}}}function xo(_,n,l){const p=1/a.aw(l,1,n.transform.tileZoom),g=Math.pow(2,l.tileID.overscaledZ),x=l.tileSize*Math.pow(2,n.transform.tileZoom)/g,w=x*(l.tileID.canonical.x+l.tileID.wrap*g),P=x*l.tileID.canonical.y;return{u_image:0,u_texsize:l.imageAtlasTexture.size,u_scale:[p,_.fromScale,_.toScale],u_fade:_.t,u_pixel_coord_upper:[w>>16,P>>16],u_pixel_coord_lower:[65535&w,65535&P]}}const Uh=(_,n,l,p)=>{const g=_.style.light,x=g.properties.get("position"),w=[x.x,x.y,x.z],P=a.bL();g.properties.get("anchor")==="viewport"&&a.bM(P,_.transform.bearingInRadians),a.bN(w,w,P);const I=_.transform.transformLightDirection(w),R=g.properties.get("color");return{u_lightpos:w,u_lightpos_globe:I,u_lightintensity:g.properties.get("intensity"),u_lightcolor:[R.r,R.g,R.b],u_vertical_gradient:+n,u_opacity:l,u_fill_translate:p}},ll=(_,n,l,p,g,x,w)=>a.e(Uh(_,n,l,p),xo(x,_,w),{u_height_factor:-Math.pow(2,g.overscaledZ)/w.tileSize/8}),Vh=(_,n,l,p)=>a.e(xo(n,_,l),{u_fill_translate:p}),vo=(_,n)=>({u_world:_,u_fill_translate:n}),$p=(_,n,l,p,g)=>a.e(Vh(_,n,l,g),{u_world:p}),jh=(_,n,l,p,g)=>{const x=_.transform;let w,P,I=0;if(l.paint.get("circle-pitch-alignment")==="map"){const R=a.aw(n,1,x.zoom);w=!0,P=[R,R],I=R/(a.Z*Math.pow(2,n.tileID.overscaledZ))*2*Math.PI*g}else w=!1,P=x.pixelsToGLUnits;return{u_camera_to_center_distance:x.cameraToCenterDistance,u_scale_with_map:+(l.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+w,u_device_pixel_ratio:_.pixelRatio,u_extrude_scale:P,u_globe_extrude_scale:I,u_translate:p}},Wp=_=>({u_pixel_extrude_scale:[1/_.width,1/_.height]}),$h=_=>({u_viewport_size:[_.width,_.height]}),cl=(_,n=1)=>({u_color:_,u_overlay:0,u_overlay_scale:n}),Fc=(_,n,l,p)=>{const g=a.aw(_,1,n)/(a.Z*Math.pow(2,_.tileID.overscaledZ))*2*Math.PI*p;return{u_extrude_scale:a.aw(_,1,n),u_intensity:l,u_globe_extrude_scale:g}},Lc=(_,n,l,p)=>{const g=a.K();a.bO(g,0,_.width,_.height,0,0,1);const x=_.context.gl;return{u_matrix:g,u_world:[x.drawingBufferWidth,x.drawingBufferHeight],u_image:l,u_color_ramp:p,u_opacity:n.paint.get("heatmap-opacity")}},Wh=(_,n,l)=>{const p=l.paint.get("hillshade-shadow-color"),g=l.paint.get("hillshade-highlight-color"),x=l.paint.get("hillshade-accent-color");let w=l.paint.get("hillshade-illumination-direction")*(Math.PI/180);return l.paint.get("hillshade-illumination-anchor")==="viewport"&&(w+=_.transform.bearingInRadians),{u_image:0,u_latrange:ks(0,n.tileID),u_light:[l.paint.get("hillshade-exaggeration"),w],u_shadow:p,u_highlight:g,u_accent:x}},Hh=(_,n)=>{const l=n.stride,p=a.K();return a.bO(p,0,a.Z,-8192,0,0,1),a.L(p,p,[0,-8192,0]),{u_matrix:p,u_image:1,u_dimension:[l,l],u_zoom:_.overscaledZ,u_unpack:n.getUnpackVector()}};function ks(_,n){const l=Math.pow(2,n.canonical.z),p=n.canonical.y;return[new a.$(0,p/l).toLngLat().lat,new a.$(0,(p+1)/l).toLngLat().lat]}const ul=(_,n,l,p)=>{const g=_.transform;return{u_translation:Xh(_,n,l),u_ratio:p/a.aw(n,1,g.zoom),u_device_pixel_ratio:_.pixelRatio,u_units_to_pixels:[1/g.pixelsToGLUnits[0],1/g.pixelsToGLUnits[1]]}},Zh=(_,n,l,p,g)=>a.e(ul(_,n,l,p),{u_image:0,u_image_height:g}),fa=(_,n,l,p,g)=>{const x=_.transform,w=da(n,x);return{u_translation:Xh(_,n,l),u_texsize:n.imageAtlasTexture.size,u_ratio:p/a.aw(n,1,x.zoom),u_device_pixel_ratio:_.pixelRatio,u_image:0,u_scale:[w,g.fromScale,g.toScale],u_fade:g.t,u_units_to_pixels:[1/x.pixelsToGLUnits[0],1/x.pixelsToGLUnits[1]]}},Hp=(_,n,l,p,g,x)=>{const w=_.lineAtlas,P=da(n,_.transform),I=l.layout.get("line-cap")==="round",R=w.getDash(g.from,I),O=w.getDash(g.to,I),N=R.width*x.fromScale,B=O.width*x.toScale;return a.e(ul(_,n,l,p),{u_patternscale_a:[P/N,-R.height/2],u_patternscale_b:[P/B,-O.height/2],u_sdfgamma:w.width/(256*Math.min(N,B)*_.pixelRatio)/2,u_image:0,u_tex_y_a:R.y,u_tex_y_b:O.y,u_mix:x.t})};function da(_,n){return 1/a.aw(_,1,n.tileZoom)}function Xh(_,n,l){return a.ax(_.transform,n,l.paint.get("line-translate"),l.paint.get("line-translate-anchor"))}const Zp=(_,n,l,p,g)=>{return{u_tl_parent:_,u_scale_parent:n,u_buffer_scale:1,u_fade_t:l.mix,u_opacity:l.opacity*p.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:p.paint.get("raster-brightness-min"),u_brightness_high:p.paint.get("raster-brightness-max"),u_saturation_factor:(w=p.paint.get("raster-saturation"),w>0?1-1/(1.001-w):-w),u_contrast_factor:(x=p.paint.get("raster-contrast"),x>0?1/(1-x):1+x),u_spin_weights:qh(p.paint.get("raster-hue-rotate")),u_coords_top:[g[0].x,g[0].y,g[1].x,g[1].y],u_coords_bottom:[g[3].x,g[3].y,g[2].x,g[2].y]};var x,w};function qh(_){_*=Math.PI/180;const n=Math.sin(_),l=Math.cos(_);return[(2*l+1)/3,(-Math.sqrt(3)*n-l+1)/3,(Math.sqrt(3)*n-l+1)/3]}const Bc=(_,n,l,p,g,x,w,P,I,R,O,N,B)=>{const W=w.transform;return{u_is_size_zoom_constant:+(_==="constant"||_==="source"),u_is_size_feature_constant:+(_==="constant"||_==="camera"),u_size_t:n?n.uSizeT:0,u_size:n?n.uSize:0,u_camera_to_center_distance:W.cameraToCenterDistance,u_pitch:W.pitch/360*2*Math.PI,u_rotate_symbol:+l,u_aspect_ratio:W.width/W.height,u_fade_change:w.options.fadeDuration?w.symbolFadeChange:1,u_label_plane_matrix:P,u_coord_matrix:I,u_is_text:+O,u_pitch_with_map:+p,u_is_along_line:g,u_is_variable_anchor:x,u_texsize:N,u_texture:0,u_translation:R,u_pitched_scale:B}},Nc=(_,n,l,p,g,x,w,P,I,R,O,N,B,W)=>{const X=w.transform;return a.e(Bc(_,n,l,p,g,x,w,P,I,R,O,N,W),{u_gamma_scale:p?Math.cos(X.pitch*Math.PI/180)*X.cameraToCenterDistance:1,u_device_pixel_ratio:w.pixelRatio,u_is_halo:1})},zc=(_,n,l,p,g,x,w,P,I,R,O,N,B)=>a.e(Nc(_,n,l,p,g,x,w,P,I,R,!0,O,0,B),{u_texsize_icon:N,u_texture_icon:1}),Gh=(_,n)=>({u_opacity:_,u_color:n}),hl=(_,n,l,p,g)=>a.e(function(x,w,P,I){const R=P.imageManager.getPattern(x.from.toString()),O=P.imageManager.getPattern(x.to.toString()),{width:N,height:B}=P.imageManager.getPixelSize(),W=Math.pow(2,I.tileID.overscaledZ),X=I.tileSize*Math.pow(2,P.transform.tileZoom)/W,te=X*(I.tileID.canonical.x+I.tileID.wrap*W),Q=X*I.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:R.tl,u_pattern_br_a:R.br,u_pattern_tl_b:O.tl,u_pattern_br_b:O.br,u_texsize:[N,B],u_mix:w.t,u_pattern_size_a:R.displaySize,u_pattern_size_b:O.displaySize,u_scale_a:w.fromScale,u_scale_b:w.toScale,u_tile_units_to_pixels:1/a.aw(I,1,P.transform.tileZoom),u_pixel_coord_upper:[te>>16,Q>>16],u_pixel_coord_lower:[65535&te,65535&Q]}}(l,g,n,p),{u_opacity:_}),mn=(_,n)=>{},Uc={fillExtrusion:(_,n)=>({u_lightpos:new a.bJ(_,n.u_lightpos),u_lightpos_globe:new a.bJ(_,n.u_lightpos_globe),u_lightintensity:new a.b8(_,n.u_lightintensity),u_lightcolor:new a.bJ(_,n.u_lightcolor),u_vertical_gradient:new a.b8(_,n.u_vertical_gradient),u_opacity:new a.b8(_,n.u_opacity),u_fill_translate:new a.bK(_,n.u_fill_translate)}),fillExtrusionPattern:(_,n)=>({u_lightpos:new a.bJ(_,n.u_lightpos),u_lightpos_globe:new a.bJ(_,n.u_lightpos_globe),u_lightintensity:new a.b8(_,n.u_lightintensity),u_lightcolor:new a.bJ(_,n.u_lightcolor),u_vertical_gradient:new a.b8(_,n.u_vertical_gradient),u_height_factor:new a.b8(_,n.u_height_factor),u_opacity:new a.b8(_,n.u_opacity),u_fill_translate:new a.bK(_,n.u_fill_translate),u_image:new a.bF(_,n.u_image),u_texsize:new a.bK(_,n.u_texsize),u_pixel_coord_upper:new a.bK(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bK(_,n.u_pixel_coord_lower),u_scale:new a.bJ(_,n.u_scale),u_fade:new a.b8(_,n.u_fade)}),fill:(_,n)=>({u_fill_translate:new a.bK(_,n.u_fill_translate)}),fillPattern:(_,n)=>({u_image:new a.bF(_,n.u_image),u_texsize:new a.bK(_,n.u_texsize),u_pixel_coord_upper:new a.bK(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bK(_,n.u_pixel_coord_lower),u_scale:new a.bJ(_,n.u_scale),u_fade:new a.b8(_,n.u_fade),u_fill_translate:new a.bK(_,n.u_fill_translate)}),fillOutline:(_,n)=>({u_world:new a.bK(_,n.u_world),u_fill_translate:new a.bK(_,n.u_fill_translate)}),fillOutlinePattern:(_,n)=>({u_world:new a.bK(_,n.u_world),u_image:new a.bF(_,n.u_image),u_texsize:new a.bK(_,n.u_texsize),u_pixel_coord_upper:new a.bK(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bK(_,n.u_pixel_coord_lower),u_scale:new a.bJ(_,n.u_scale),u_fade:new a.b8(_,n.u_fade),u_fill_translate:new a.bK(_,n.u_fill_translate)}),circle:(_,n)=>({u_camera_to_center_distance:new a.b8(_,n.u_camera_to_center_distance),u_scale_with_map:new a.bF(_,n.u_scale_with_map),u_pitch_with_map:new a.bF(_,n.u_pitch_with_map),u_extrude_scale:new a.bK(_,n.u_extrude_scale),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_globe_extrude_scale:new a.b8(_,n.u_globe_extrude_scale),u_translate:new a.bK(_,n.u_translate)}),collisionBox:(_,n)=>({u_pixel_extrude_scale:new a.bK(_,n.u_pixel_extrude_scale)}),collisionCircle:(_,n)=>({u_viewport_size:new a.bK(_,n.u_viewport_size)}),debug:(_,n)=>({u_color:new a.bG(_,n.u_color),u_overlay:new a.bF(_,n.u_overlay),u_overlay_scale:new a.b8(_,n.u_overlay_scale)}),depth:mn,clippingMask:mn,heatmap:(_,n)=>({u_extrude_scale:new a.b8(_,n.u_extrude_scale),u_intensity:new a.b8(_,n.u_intensity),u_globe_extrude_scale:new a.b8(_,n.u_globe_extrude_scale)}),heatmapTexture:(_,n)=>({u_matrix:new a.bH(_,n.u_matrix),u_world:new a.bK(_,n.u_world),u_image:new a.bF(_,n.u_image),u_color_ramp:new a.bF(_,n.u_color_ramp),u_opacity:new a.b8(_,n.u_opacity)}),hillshade:(_,n)=>({u_image:new a.bF(_,n.u_image),u_latrange:new a.bK(_,n.u_latrange),u_light:new a.bK(_,n.u_light),u_shadow:new a.bG(_,n.u_shadow),u_highlight:new a.bG(_,n.u_highlight),u_accent:new a.bG(_,n.u_accent)}),hillshadePrepare:(_,n)=>({u_matrix:new a.bH(_,n.u_matrix),u_image:new a.bF(_,n.u_image),u_dimension:new a.bK(_,n.u_dimension),u_zoom:new a.b8(_,n.u_zoom),u_unpack:new a.bI(_,n.u_unpack)}),line:(_,n)=>({u_translation:new a.bK(_,n.u_translation),u_ratio:new a.b8(_,n.u_ratio),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_units_to_pixels:new a.bK(_,n.u_units_to_pixels)}),lineGradient:(_,n)=>({u_translation:new a.bK(_,n.u_translation),u_ratio:new a.b8(_,n.u_ratio),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_units_to_pixels:new a.bK(_,n.u_units_to_pixels),u_image:new a.bF(_,n.u_image),u_image_height:new a.b8(_,n.u_image_height)}),linePattern:(_,n)=>({u_translation:new a.bK(_,n.u_translation),u_texsize:new a.bK(_,n.u_texsize),u_ratio:new a.b8(_,n.u_ratio),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_image:new a.bF(_,n.u_image),u_units_to_pixels:new a.bK(_,n.u_units_to_pixels),u_scale:new a.bJ(_,n.u_scale),u_fade:new a.b8(_,n.u_fade)}),lineSDF:(_,n)=>({u_translation:new a.bK(_,n.u_translation),u_ratio:new a.b8(_,n.u_ratio),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_units_to_pixels:new a.bK(_,n.u_units_to_pixels),u_patternscale_a:new a.bK(_,n.u_patternscale_a),u_patternscale_b:new a.bK(_,n.u_patternscale_b),u_sdfgamma:new a.b8(_,n.u_sdfgamma),u_image:new a.bF(_,n.u_image),u_tex_y_a:new a.b8(_,n.u_tex_y_a),u_tex_y_b:new a.b8(_,n.u_tex_y_b),u_mix:new a.b8(_,n.u_mix)}),raster:(_,n)=>({u_tl_parent:new a.bK(_,n.u_tl_parent),u_scale_parent:new a.b8(_,n.u_scale_parent),u_buffer_scale:new a.b8(_,n.u_buffer_scale),u_fade_t:new a.b8(_,n.u_fade_t),u_opacity:new a.b8(_,n.u_opacity),u_image0:new a.bF(_,n.u_image0),u_image1:new a.bF(_,n.u_image1),u_brightness_low:new a.b8(_,n.u_brightness_low),u_brightness_high:new a.b8(_,n.u_brightness_high),u_saturation_factor:new a.b8(_,n.u_saturation_factor),u_contrast_factor:new a.b8(_,n.u_contrast_factor),u_spin_weights:new a.bJ(_,n.u_spin_weights),u_coords_top:new a.bI(_,n.u_coords_top),u_coords_bottom:new a.bI(_,n.u_coords_bottom)}),symbolIcon:(_,n)=>({u_is_size_zoom_constant:new a.bF(_,n.u_is_size_zoom_constant),u_is_size_feature_constant:new a.bF(_,n.u_is_size_feature_constant),u_size_t:new a.b8(_,n.u_size_t),u_size:new a.b8(_,n.u_size),u_camera_to_center_distance:new a.b8(_,n.u_camera_to_center_distance),u_pitch:new a.b8(_,n.u_pitch),u_rotate_symbol:new a.bF(_,n.u_rotate_symbol),u_aspect_ratio:new a.b8(_,n.u_aspect_ratio),u_fade_change:new a.b8(_,n.u_fade_change),u_label_plane_matrix:new a.bH(_,n.u_label_plane_matrix),u_coord_matrix:new a.bH(_,n.u_coord_matrix),u_is_text:new a.bF(_,n.u_is_text),u_pitch_with_map:new a.bF(_,n.u_pitch_with_map),u_is_along_line:new a.bF(_,n.u_is_along_line),u_is_variable_anchor:new a.bF(_,n.u_is_variable_anchor),u_texsize:new a.bK(_,n.u_texsize),u_texture:new a.bF(_,n.u_texture),u_translation:new a.bK(_,n.u_translation),u_pitched_scale:new a.b8(_,n.u_pitched_scale)}),symbolSDF:(_,n)=>({u_is_size_zoom_constant:new a.bF(_,n.u_is_size_zoom_constant),u_is_size_feature_constant:new a.bF(_,n.u_is_size_feature_constant),u_size_t:new a.b8(_,n.u_size_t),u_size:new a.b8(_,n.u_size),u_camera_to_center_distance:new a.b8(_,n.u_camera_to_center_distance),u_pitch:new a.b8(_,n.u_pitch),u_rotate_symbol:new a.bF(_,n.u_rotate_symbol),u_aspect_ratio:new a.b8(_,n.u_aspect_ratio),u_fade_change:new a.b8(_,n.u_fade_change),u_label_plane_matrix:new a.bH(_,n.u_label_plane_matrix),u_coord_matrix:new a.bH(_,n.u_coord_matrix),u_is_text:new a.bF(_,n.u_is_text),u_pitch_with_map:new a.bF(_,n.u_pitch_with_map),u_is_along_line:new a.bF(_,n.u_is_along_line),u_is_variable_anchor:new a.bF(_,n.u_is_variable_anchor),u_texsize:new a.bK(_,n.u_texsize),u_texture:new a.bF(_,n.u_texture),u_gamma_scale:new a.b8(_,n.u_gamma_scale),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_is_halo:new a.bF(_,n.u_is_halo),u_translation:new a.bK(_,n.u_translation),u_pitched_scale:new a.b8(_,n.u_pitched_scale)}),symbolTextAndIcon:(_,n)=>({u_is_size_zoom_constant:new a.bF(_,n.u_is_size_zoom_constant),u_is_size_feature_constant:new a.bF(_,n.u_is_size_feature_constant),u_size_t:new a.b8(_,n.u_size_t),u_size:new a.b8(_,n.u_size),u_camera_to_center_distance:new a.b8(_,n.u_camera_to_center_distance),u_pitch:new a.b8(_,n.u_pitch),u_rotate_symbol:new a.bF(_,n.u_rotate_symbol),u_aspect_ratio:new a.b8(_,n.u_aspect_ratio),u_fade_change:new a.b8(_,n.u_fade_change),u_label_plane_matrix:new a.bH(_,n.u_label_plane_matrix),u_coord_matrix:new a.bH(_,n.u_coord_matrix),u_is_text:new a.bF(_,n.u_is_text),u_pitch_with_map:new a.bF(_,n.u_pitch_with_map),u_is_along_line:new a.bF(_,n.u_is_along_line),u_is_variable_anchor:new a.bF(_,n.u_is_variable_anchor),u_texsize:new a.bK(_,n.u_texsize),u_texsize_icon:new a.bK(_,n.u_texsize_icon),u_texture:new a.bF(_,n.u_texture),u_texture_icon:new a.bF(_,n.u_texture_icon),u_gamma_scale:new a.b8(_,n.u_gamma_scale),u_device_pixel_ratio:new a.b8(_,n.u_device_pixel_ratio),u_is_halo:new a.bF(_,n.u_is_halo),u_translation:new a.bK(_,n.u_translation),u_pitched_scale:new a.b8(_,n.u_pitched_scale)}),background:(_,n)=>({u_opacity:new a.b8(_,n.u_opacity),u_color:new a.bG(_,n.u_color)}),backgroundPattern:(_,n)=>({u_opacity:new a.b8(_,n.u_opacity),u_image:new a.bF(_,n.u_image),u_pattern_tl_a:new a.bK(_,n.u_pattern_tl_a),u_pattern_br_a:new a.bK(_,n.u_pattern_br_a),u_pattern_tl_b:new a.bK(_,n.u_pattern_tl_b),u_pattern_br_b:new a.bK(_,n.u_pattern_br_b),u_texsize:new a.bK(_,n.u_texsize),u_mix:new a.b8(_,n.u_mix),u_pattern_size_a:new a.bK(_,n.u_pattern_size_a),u_pattern_size_b:new a.bK(_,n.u_pattern_size_b),u_scale_a:new a.b8(_,n.u_scale_a),u_scale_b:new a.b8(_,n.u_scale_b),u_pixel_coord_upper:new a.bK(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bK(_,n.u_pixel_coord_lower),u_tile_units_to_pixels:new a.b8(_,n.u_tile_units_to_pixels)}),terrain:(_,n)=>({u_texture:new a.bF(_,n.u_texture),u_ele_delta:new a.b8(_,n.u_ele_delta),u_fog_matrix:new a.bH(_,n.u_fog_matrix),u_fog_color:new a.bG(_,n.u_fog_color),u_fog_ground_blend:new a.b8(_,n.u_fog_ground_blend),u_fog_ground_blend_opacity:new a.b8(_,n.u_fog_ground_blend_opacity),u_horizon_color:new a.bG(_,n.u_horizon_color),u_horizon_fog_blend:new a.b8(_,n.u_horizon_fog_blend),u_is_globe_mode:new a.b8(_,n.u_is_globe_mode)}),terrainDepth:(_,n)=>({u_ele_delta:new a.b8(_,n.u_ele_delta)}),terrainCoords:(_,n)=>({u_texture:new a.bF(_,n.u_texture),u_terrain_coords_id:new a.b8(_,n.u_terrain_coords_id),u_ele_delta:new a.b8(_,n.u_ele_delta)}),projectionErrorMeasurement:(_,n)=>({u_input:new a.b8(_,n.u_input),u_output_expected:new a.b8(_,n.u_output_expected)}),atmosphere:(_,n)=>({u_sun_pos:new a.bJ(_,n.u_sun_pos),u_atmosphere_blend:new a.b8(_,n.u_atmosphere_blend),u_globe_position:new a.bJ(_,n.u_globe_position),u_globe_radius:new a.b8(_,n.u_globe_radius),u_inv_proj_matrix:new a.bH(_,n.u_inv_proj_matrix)}),sky:(_,n)=>({u_sky_color:new a.bG(_,n.u_sky_color),u_horizon_color:new a.bG(_,n.u_horizon_color),u_horizon:new a.bK(_,n.u_horizon),u_horizon_normal:new a.bK(_,n.u_horizon_normal),u_sky_horizon_blend:new a.b8(_,n.u_sky_horizon_blend),u_sky_blend:new a.b8(_,n.u_sky_blend)})};class Vc{constructor(n,l,p){this.context=n;const g=n.gl;this.buffer=g.createBuffer(),this.dynamicDraw=!!p,this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),g.bufferData(g.ELEMENT_ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?g.DYNAMIC_DRAW:g.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){const l=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),l.bufferSubData(l.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const jc={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Yh{constructor(n,l,p,g){this.length=l.length,this.attributes=p,this.itemSize=l.bytesPerElement,this.dynamicDraw=g,this.context=n;const x=n.gl;this.buffer=x.createBuffer(),n.bindVertexBuffer.set(this.buffer),x.bufferData(x.ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(n){if(n.length!==this.length)throw new Error(`Length of new data is ${n.length}, which doesn't match current length of ${this.length}`);const l=this.context.gl;this.bind(),l.bufferSubData(l.ARRAY_BUFFER,0,n.arrayBuffer)}enableAttributes(n,l){for(let p=0;p<this.attributes.length;p++){const g=l.attributes[this.attributes[p].name];g!==void 0&&n.enableVertexAttribArray(g)}}setVertexAttribPointers(n,l,p){for(let g=0;g<this.attributes.length;g++){const x=this.attributes[g],w=l.attributes[x.name];w!==void 0&&n.vertexAttribPointer(w,x.components,n[jc[x.type]],!1,this.itemSize,x.offset+this.itemSize*(p||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class ii{constructor(n){this.gl=n.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(n){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ds extends ii{getDefault(){return a.b7.transparent}set(n){const l=this.current;(n.r!==l.r||n.g!==l.g||n.b!==l.b||n.a!==l.a||this.dirty)&&(this.gl.clearColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class $c extends ii{getDefault(){return 1}set(n){(n!==this.current||this.dirty)&&(this.gl.clearDepth(n),this.current=n,this.dirty=!1)}}class Xp extends ii{getDefault(){return 0}set(n){(n!==this.current||this.dirty)&&(this.gl.clearStencil(n),this.current=n,this.dirty=!1)}}class qp extends ii{getDefault(){return[!0,!0,!0,!0]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||n[2]!==l[2]||n[3]!==l[3]||this.dirty)&&(this.gl.colorMask(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class Gp extends ii{getDefault(){return!0}set(n){(n!==this.current||this.dirty)&&(this.gl.depthMask(n),this.current=n,this.dirty=!1)}}class Yp extends ii{getDefault(){return 255}set(n){(n!==this.current||this.dirty)&&(this.gl.stencilMask(n),this.current=n,this.dirty=!1)}}class Kh extends ii{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(n){const l=this.current;(n.func!==l.func||n.ref!==l.ref||n.mask!==l.mask||this.dirty)&&(this.gl.stencilFunc(n.func,n.ref,n.mask),this.current=n,this.dirty=!1)}}class Kp extends ii{getDefault(){const n=this.gl;return[n.KEEP,n.KEEP,n.KEEP]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||n[2]!==l[2]||this.dirty)&&(this.gl.stencilOp(n[0],n[1],n[2]),this.current=n,this.dirty=!1)}}class Jh extends ii{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),this.current=n,this.dirty=!1}}class fl extends ii{getDefault(){return[0,1]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||this.dirty)&&(this.gl.depthRange(n[0],n[1]),this.current=n,this.dirty=!1)}}class dl extends ii{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),this.current=n,this.dirty=!1}}class pl extends ii{getDefault(){return this.gl.LESS}set(n){(n!==this.current||this.dirty)&&(this.gl.depthFunc(n),this.current=n,this.dirty=!1)}}class Wc extends ii{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.BLEND):l.disable(l.BLEND),this.current=n,this.dirty=!1}}class Os extends ii{getDefault(){const n=this.gl;return[n.ONE,n.ZERO]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||this.dirty)&&(this.gl.blendFunc(n[0],n[1]),this.current=n,this.dirty=!1)}}class bo extends ii{getDefault(){return a.b7.transparent}set(n){const l=this.current;(n.r!==l.r||n.g!==l.g||n.b!==l.b||n.a!==l.a||this.dirty)&&(this.gl.blendColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class Xr extends ii{getDefault(){return this.gl.FUNC_ADD}set(n){(n!==this.current||this.dirty)&&(this.gl.blendEquation(n),this.current=n,this.dirty=!1)}}class Qh extends ii{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.CULL_FACE):l.disable(l.CULL_FACE),this.current=n,this.dirty=!1}}class ef extends ii{getDefault(){return this.gl.BACK}set(n){(n!==this.current||this.dirty)&&(this.gl.cullFace(n),this.current=n,this.dirty=!1)}}class Hc extends ii{getDefault(){return this.gl.CCW}set(n){(n!==this.current||this.dirty)&&(this.gl.frontFace(n),this.current=n,this.dirty=!1)}}class Fs extends ii{getDefault(){return null}set(n){(n!==this.current||this.dirty)&&(this.gl.useProgram(n),this.current=n,this.dirty=!1)}}class gl extends ii{getDefault(){return this.gl.TEXTURE0}set(n){(n!==this.current||this.dirty)&&(this.gl.activeTexture(n),this.current=n,this.dirty=!1)}}class ml extends ii{getDefault(){const n=this.gl;return[0,0,n.drawingBufferWidth,n.drawingBufferHeight]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||n[2]!==l[2]||n[3]!==l[3]||this.dirty)&&(this.gl.viewport(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class pa extends ii{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,n),this.current=n,this.dirty=!1}}class _l extends ii{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindRenderbuffer(l.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class tf extends ii{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindTexture(l.TEXTURE_2D,n),this.current=n,this.dirty=!1}}class wo extends ii{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindBuffer(l.ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class To extends ii{getDefault(){return null}set(n){const l=this.gl;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class rf extends ii{getDefault(){return null}set(n){var l;if(n===this.current&&!this.dirty)return;const p=this.gl;tn(p)?p.bindVertexArray(n):(l=p.getExtension("OES_vertex_array_object"))===null||l===void 0||l.bindVertexArrayOES(n),this.current=n,this.dirty=!1}}class Zc extends ii{getDefault(){return 4}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_ALIGNMENT,n),this.current=n,this.dirty=!1}}class Qt extends ii{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n),this.current=n,this.dirty=!1}}class yl extends ii{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,n),this.current=n,this.dirty=!1}}class Xc extends ii{constructor(n,l){super(n),this.context=n,this.parent=l}getDefault(){return null}}class nf extends Xc{setDirty(){this.dirty=!0}set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,n,0),this.current=n,this.dirty=!1}}class ga extends Xc{set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,l.DEPTH_ATTACHMENT,l.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class Jp extends Xc{set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,l.DEPTH_STENCIL_ATTACHMENT,l.RENDERBUFFER,n),this.current=n,this.dirty=!1}}const sf="Framebuffer is not complete";class of{constructor(n,l,p,g,x){this.context=n,this.width=l,this.height=p;const w=n.gl,P=this.framebuffer=w.createFramebuffer();if(this.colorAttachment=new nf(n,P),g)this.depthAttachment=x?new Jp(n,P):new ga(n,P);else if(x)throw new Error("Stencil cannot be set without depth");if(w.checkFramebufferStatus(w.FRAMEBUFFER)!==w.FRAMEBUFFER_COMPLETE)throw new Error(sf)}destroy(){const n=this.context.gl,l=this.colorAttachment.get();if(l&&n.deleteTexture(l),this.depthAttachment){const p=this.depthAttachment.get();p&&n.deleteRenderbuffer(p)}n.deleteFramebuffer(this.framebuffer)}}class Qp{constructor(n){var l,p;if(this.gl=n,this.clearColor=new Ds(this),this.clearDepth=new $c(this),this.clearStencil=new Xp(this),this.colorMask=new qp(this),this.depthMask=new Gp(this),this.stencilMask=new Yp(this),this.stencilFunc=new Kh(this),this.stencilOp=new Kp(this),this.stencilTest=new Jh(this),this.depthRange=new fl(this),this.depthTest=new dl(this),this.depthFunc=new pl(this),this.blend=new Wc(this),this.blendFunc=new Os(this),this.blendColor=new bo(this),this.blendEquation=new Xr(this),this.cullFace=new Qh(this),this.cullFaceSide=new ef(this),this.frontFace=new Hc(this),this.program=new Fs(this),this.activeTexture=new gl(this),this.viewport=new ml(this),this.bindFramebuffer=new pa(this),this.bindRenderbuffer=new _l(this),this.bindTexture=new tf(this),this.bindVertexBuffer=new wo(this),this.bindElementBuffer=new To(this),this.bindVertexArray=new rf(this),this.pixelStoreUnpack=new Zc(this),this.pixelStoreUnpackPremultiplyAlpha=new Qt(this),this.pixelStoreUnpackFlipY=new yl(this),this.extTextureFilterAnisotropic=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=n.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),tn(n)){this.HALF_FLOAT=n.HALF_FLOAT;const g=n.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(l=n.RGBA16F)!==null&&l!==void 0?l:g==null?void 0:g.RGBA16F_EXT,this.RGB16F=(p=n.RGB16F)!==null&&p!==void 0?p:g==null?void 0:g.RGB16F_EXT,n.getExtension("EXT_color_buffer_float")}else{n.getExtension("EXT_color_buffer_half_float"),n.getExtension("OES_texture_half_float_linear");const g=n.getExtension("OES_texture_half_float");this.HALF_FLOAT=g==null?void 0:g.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(n,l){return new Vc(this,n,l)}createVertexBuffer(n,l,p){return new Yh(this,n,l,p)}createRenderbuffer(n,l,p){const g=this.gl,x=g.createRenderbuffer();return this.bindRenderbuffer.set(x),g.renderbufferStorage(g.RENDERBUFFER,n,l,p),this.bindRenderbuffer.set(null),x}createFramebuffer(n,l,p,g){return new of(this,n,l,p,g)}clear({color:n,depth:l,stencil:p}){const g=this.gl;let x=0;n&&(x|=g.COLOR_BUFFER_BIT,this.clearColor.set(n),this.colorMask.set([!0,!0,!0,!0])),l!==void 0&&(x|=g.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(l),this.depthMask.set(!0)),p!==void 0&&(x|=g.STENCIL_BUFFER_BIT,this.clearStencil.set(p),this.stencilMask.set(255)),g.clear(x)}setCullFace(n){n.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(n.mode),this.frontFace.set(n.frontFace))}setDepthMode(n){n.func!==this.gl.ALWAYS||n.mask?(this.depthTest.set(!0),this.depthFunc.set(n.func),this.depthMask.set(n.mask),this.depthRange.set(n.range)):this.depthTest.set(!1)}setStencilMode(n){n.test.func!==this.gl.ALWAYS||n.mask?(this.stencilTest.set(!0),this.stencilMask.set(n.mask),this.stencilOp.set([n.fail,n.depthFail,n.pass]),this.stencilFunc.set({func:n.test.func,ref:n.ref,mask:n.test.mask})):this.stencilTest.set(!1)}setColorMode(n){a.bC(n.blendFunction,_i.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(n.blendFunction),this.blendColor.set(n.blendColor)),this.colorMask.set(n.mask)}createVertexArray(){var n;return tn(this.gl)?this.gl.createVertexArray():(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.createVertexArrayOES()}deleteVertexArray(n){var l;return tn(this.gl)?this.gl.deleteVertexArray(n):(l=this.gl.getExtension("OES_vertex_array_object"))===null||l===void 0?void 0:l.deleteVertexArrayOES(n)}unbindVAO(){this.bindVertexArray.set(null)}}let So;function ma(_,n,l,p,g){const x=_.context,w=_.transform,P=x.gl,I=_.useProgram("collisionBox"),R=[];let O=0,N=0;for(let ie=0;ie<p.length;ie++){const se=p[ie],ue=n.getTile(se).getBucket(l);if(!ue)continue;const fe=g?ue.textCollisionBox:ue.iconCollisionBox,de=ue.collisionCircleArray;de.length>0&&(R.push({circleArray:de,circleOffset:N,coord:se}),O+=de.length/4,N=O),fe&&I.draw(x,P.LINES,Vt.disabled,Yt.disabled,_.colorModeForRenderPass(),ti.disabled,Wp(_.transform),_.style.map.terrain&&_.style.map.terrain.getTerrainData(se),w.getProjectionData({overscaledTileID:se,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),l.id,fe.layoutVertexBuffer,fe.indexBuffer,fe.segments,null,_.transform.zoom,null,null,fe.collisionVertexBuffer)}if(!g||!R.length)return;const B=_.useProgram("collisionCircle"),W=new a.bP;W.resize(4*O),W._trim();let X=0;for(const ie of R)for(let se=0;se<ie.circleArray.length/4;se++){const ue=4*se,fe=ie.circleArray[ue+0],de=ie.circleArray[ue+1],ve=ie.circleArray[ue+2],ge=ie.circleArray[ue+3];W.emplace(X++,fe,de,ve,ge,0),W.emplace(X++,fe,de,ve,ge,1),W.emplace(X++,fe,de,ve,ge,2),W.emplace(X++,fe,de,ve,ge,3)}(!So||So.length<2*O)&&(So=function(ie){const se=2*ie,ue=new a.bR;ue.resize(se),ue._trim();for(let fe=0;fe<se;fe++){const de=6*fe;ue.uint16[de+0]=4*fe+0,ue.uint16[de+1]=4*fe+1,ue.uint16[de+2]=4*fe+2,ue.uint16[de+3]=4*fe+2,ue.uint16[de+4]=4*fe+3,ue.uint16[de+5]=4*fe+0}return ue}(O));const te=x.createIndexBuffer(So,!0),Q=x.createVertexBuffer(W,a.bQ.members,!0);for(const ie of R){const se=$h(_.transform);B.draw(x,P.TRIANGLES,Vt.disabled,Yt.disabled,_.colorModeForRenderPass(),ti.disabled,se,_.style.map.terrain&&_.style.map.terrain.getTerrainData(ie.coord),null,l.id,Q,te,a.aG.simpleSegment(0,2*ie.circleOffset,ie.circleArray.length,ie.circleArray.length/2),null,_.transform.zoom,null,null,null)}Q.destroy(),te.destroy()}const xl=a.at(new Float32Array(16));function qc(_,n,l,p,g,x){const{horizontalAlign:w,verticalAlign:P}=a.aB(_);return new a.P((-(w-.5)*n/g+p[0])*x,(-(P-.5)*l/g+p[1])*x)}function Gc(_,n,l,p,g,x){const w=n.tileAnchorPoint.add(new a.P(n.translation[0],n.translation[1]));if(n.pitchWithMap){let P=p.mult(x);l||(P=P.rotate(-g));const I=w.add(P);return ze(I.x,I.y,n.pitchedLabelPlaneMatrix,n.getElevation).point}if(l){const P=Kt(n.tileAnchorPoint.x+1,n.tileAnchorPoint.y,n).point.sub(_),I=Math.atan(P.y/P.x)+(P.x<0?Math.PI:0);return _.add(p.rotate(I))}return _.add(p)}function af(_,n,l,p,g,x,w,P,I,R,O,N){const B=_.text.placedSymbolArray,W=_.text.dynamicLayoutVertexArray,X=_.icon.dynamicLayoutVertexArray,te={};W.clear();for(let Q=0;Q<B.length;Q++){const ie=B.get(Q),se=ie.hidden||!ie.crossTileID||_.allowVerticalPlacement&&!ie.placedOrientation?null:p[ie.crossTileID];if(se){const ue=new a.P(ie.anchorX,ie.anchorY),fe={getElevation:N,width:g.width,height:g.height,pitchedLabelPlaneMatrix:x,pitchWithMap:l,transform:g,tileAnchorPoint:ue,translation:R,unwrappedTileID:O},de=l?vt(ue.x,ue.y,fe):Kt(ue.x,ue.y,fe),ve=Ie(g.cameraToCenterDistance,de.signedDistanceFromCamera);let ge=a.ai(_.textSizeData,P,ie)*ve/a.av;l&&(ge*=_.tilePixelRatio/w);const{width:De,height:ke,anchor:We,textOffset:Ze,textBoxScale:je}=se,lt=qc(We,De,ke,Ze,je,ge),at=g.getPitchedTextCorrection(ue.x+R[0],ue.y+R[1],O),qe=Gc(de.point,fe,n,lt,-g.bearingInRadians,at),bt=_.allowVerticalPlacement&&ie.placedOrientation===a.ah.vertical?Math.PI/2:0;for(let Ut=0;Ut<ie.numGlyphs;Ut++)a.ao(W,qe,bt);I&&ie.associatedIconIndex>=0&&(te[ie.associatedIconIndex]={shiftedAnchor:qe,angle:bt})}else Rt(ie.numGlyphs,W)}if(I){X.clear();const Q=_.icon.placedSymbolArray;for(let ie=0;ie<Q.length;ie++){const se=Q.get(ie);if(se.hidden)Rt(se.numGlyphs,X);else{const ue=te[ie];if(ue)for(let fe=0;fe<se.numGlyphs;fe++)a.ao(X,ue.shiftedAnchor,ue.angle);else Rt(se.numGlyphs,X)}}_.icon.dynamicLayoutVertexBuffer.updateData(X)}_.text.dynamicLayoutVertexBuffer.updateData(W)}function vl(_,n,l){return l.iconsInText&&n?"symbolTextAndIcon":_?"symbolSDF":"symbolIcon"}function _a(_,n,l,p,g,x,w,P,I,R,O,N,B){const W=_.context,X=W.gl,te=_.transform,Q=P==="map",ie=I==="map",se=P!=="viewport"&&l.layout.get("symbol-placement")!=="point",ue=Q&&!ie&&!se,fe=!l.layout.get("symbol-sort-key").isConstant();let de=!1;const ve=_.getDepthModeForSublayer(0,Vt.ReadOnly),ge=l._unevaluatedLayout.hasValue("text-variable-anchor")||l._unevaluatedLayout.hasValue("text-variable-anchor-offset"),De=[],ke=te.getCircleRadiusCorrection();for(const We of p){const Ze=n.getTile(We),je=Ze.getBucket(l);if(!je)continue;const lt=g?je.text:je.icon;if(!lt||!lt.segments.get().length||!lt.hasVisibleVertices)continue;const at=lt.programConfigurations.get(l.id),qe=g||je.sdfIcons,bt=g?je.textSizeData:je.iconSizeData,Ut=ie||te.pitch!==0,ni=_.useProgram(vl(qe,g,je),at),jt=a.ag(bt,te.zoom),ui=_.style.map.terrain&&_.style.map.terrain.getTerrainData(We);let gi,xi,ci,hi,Ui=[0,0],Ki=null;if(g)xi=Ze.glyphAtlasTexture,ci=X.LINEAR,gi=Ze.glyphAtlasTexture.size,je.iconsInText&&(Ui=Ze.imageAtlasTexture.size,Ki=Ze.imageAtlasTexture,hi=Ut||_.options.rotating||_.options.zooming||bt.kind==="composite"||bt.kind==="camera"?X.LINEAR:X.NEAREST);else{const ki=l.layout.get("icon-size").constantOr(0)!==1||je.iconsNeedLinear;xi=Ze.imageAtlasTexture,ci=qe||_.options.rotating||_.options.zooming||ki||Ut?X.LINEAR:X.NEAREST,gi=Ze.imageAtlasTexture.size}const tr=a.aw(Ze,1,_.transform.zoom),Dr=Re(Q,_.transform,tr),Bn=a.K();a.aj(Bn,Dr);const vn=be(ie,Q,_.transform,tr),ls=a.ax(te,Ze,x,w),cs=te.getProjectionData({overscaledTileID:We,applyGlobeMatrix:!B,applyTerrainMatrix:!0}),$s=ge&&je.hasTextData(),bn=l.layout.get("icon-text-fit")!=="none"&&$s&&je.hasIconData();if(se){const ki=_.style.map.terrain?(Wi,di)=>_.style.map.terrain.getElevation(We,Wi,di):null,Di=l.layout.get("text-rotation-alignment")==="map";ht(je,_,g,Dr,Bn,ie,R,Di,We.toUnwrapped(),te.width,te.height,ls,ki)}const Nn=g&&ge||bn,Ur=se||Nn?xl:ie?Dr:_.transform.clipSpaceToPixelsMatrix,zn=qe&&l.paint.get(g?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Ws;Ws=qe?je.iconsInText?zc(bt.kind,jt,ue,ie,se,Nn,_,Ur,vn,ls,gi,Ui,ke):Nc(bt.kind,jt,ue,ie,se,Nn,_,Ur,vn,ls,g,gi,0,ke):Bc(bt.kind,jt,ue,ie,se,Nn,_,Ur,vn,ls,g,gi,ke);const Hs={program:ni,buffers:lt,uniformValues:Ws,projectionData:cs,atlasTexture:xi,atlasTextureIcon:Ki,atlasInterpolation:ci,atlasInterpolationIcon:hi,isSDF:qe,hasHalo:zn};if(fe&&je.canOverlap){de=!0;const ki=lt.segments.get();for(const Di of ki)De.push({segments:new a.aG([Di]),sortKey:Di.sortKey,state:Hs,terrainData:ui})}else De.push({segments:lt.segments,sortKey:0,state:Hs,terrainData:ui})}de&&De.sort((We,Ze)=>We.sortKey-Ze.sortKey);for(const We of De){const Ze=We.state;if(W.activeTexture.set(X.TEXTURE0),Ze.atlasTexture.bind(Ze.atlasInterpolation,X.CLAMP_TO_EDGE),Ze.atlasTextureIcon&&(W.activeTexture.set(X.TEXTURE1),Ze.atlasTextureIcon&&Ze.atlasTextureIcon.bind(Ze.atlasInterpolationIcon,X.CLAMP_TO_EDGE)),Ze.isSDF){const je=Ze.uniformValues;Ze.hasHalo&&(je.u_is_halo=1,bl(Ze.buffers,We.segments,l,_,Ze.program,ve,O,N,je,Ze.projectionData,We.terrainData)),je.u_is_halo=0}bl(Ze.buffers,We.segments,l,_,Ze.program,ve,O,N,Ze.uniformValues,Ze.projectionData,We.terrainData)}}function bl(_,n,l,p,g,x,w,P,I,R,O){const N=p.context;g.draw(N,N.gl.TRIANGLES,x,w,P,ti.backCCW,I,O,R,l.id,_.layoutVertexBuffer,_.indexBuffer,n,l.paint,p.transform.zoom,_.programConfigurations.get(l.id),_.dynamicLayoutVertexBuffer,_.opacityVertexBuffer)}function eg(_,n,l,p,g){const x=_.context,w=x.gl,P=Yt.disabled,I=new _i([w.ONE,w.ONE],a.b7.transparent,[!0,!0,!0,!0]),R=n.getBucket(l);if(!R)return;const O=p.key;let N=l.heatmapFbos.get(O);N||(N=lf(x,n.tileSize,n.tileSize),l.heatmapFbos.set(O,N)),x.bindFramebuffer.set(N.framebuffer),x.viewport.set([0,0,n.tileSize,n.tileSize]),x.clear({color:a.b7.transparent});const B=R.programConfigurations.get(l.id),W=_.useProgram("heatmap",B,!g),X=_.transform.getProjectionData({overscaledTileID:n.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),te=_.style.map.terrain.getTerrainData(p);W.draw(x,w.TRIANGLES,Vt.disabled,P,I,ti.disabled,Fc(n,_.transform.zoom,l.paint.get("heatmap-intensity"),1),te,X,l.id,R.layoutVertexBuffer,R.indexBuffer,R.segments,l.paint,_.transform.zoom,B)}function Yc(_,n,l,p,g){const x=_.context,w=x.gl,P=_.transform;x.setColorMode(_.colorModeForRenderPass());const I=Kc(x,n),R=l.key,O=n.heatmapFbos.get(R);if(!O)return;x.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_2D,O.colorAttachment.get()),x.activeTexture.set(w.TEXTURE1),I.bind(w.LINEAR,w.CLAMP_TO_EDGE);const N=P.getProjectionData({overscaledTileID:l,applyTerrainMatrix:g,applyGlobeMatrix:!p});_.useProgram("heatmapTexture").draw(x,w.TRIANGLES,Vt.disabled,Yt.disabled,_.colorModeForRenderPass(),ti.disabled,Lc(_,n,0,1),null,N,n.id,_.rasterBoundsBuffer,_.quadTriangleIndexBuffer,_.rasterBoundsSegments,n.paint,P.zoom),O.destroy(),n.heatmapFbos.delete(R)}function lf(_,n,l){var p,g;const x=_.gl,w=x.createTexture();x.bindTexture(x.TEXTURE_2D,w),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.LINEAR);const P=(p=_.HALF_FLOAT)!==null&&p!==void 0?p:x.UNSIGNED_BYTE,I=(g=_.RGBA16F)!==null&&g!==void 0?g:x.RGBA;x.texImage2D(x.TEXTURE_2D,0,I,n,l,0,x.RGBA,P,null);const R=_.createFramebuffer(n,l,!1,!1);return R.colorAttachment.set(w),R}function Kc(_,n){return n.colorRampTexture||(n.colorRampTexture=new ft(_,n.colorRamp,_.gl.RGBA)),n.colorRampTexture}function ya(_,n,l,p,g){if(!l||!p||!p.imageAtlas)return;const x=p.imageAtlas.patternPositions;let w=x[l.to.toString()],P=x[l.from.toString()];if(!w&&P&&(w=P),!P&&w&&(P=w),!w||!P){const I=g.getPaintProperty(n);w=x[I],P=x[I]}w&&P&&_.setConstantPatternPositions(w,P)}function wl(_,n,l,p,g,x,w,P){const I=_.context.gl,R="fill-pattern",O=l.paint.get(R),N=O&&O.constantOr(1),B=l.getCrossfadeParameters();let W,X,te,Q,ie;const se=_.transform,ue=l.paint.get("fill-translate"),fe=l.paint.get("fill-translate-anchor");w?(X=N&&!l.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",W=I.LINES):(X=N?"fillPattern":"fill",W=I.TRIANGLES);const de=O.constantOr(null);for(const ve of p){const ge=n.getTile(ve);if(N&&!ge.patternsLoaded())continue;const De=ge.getBucket(l);if(!De)continue;const ke=De.programConfigurations.get(l.id),We=_.useProgram(X,ke),Ze=_.style.map.terrain&&_.style.map.terrain.getTerrainData(ve);N&&(_.context.activeTexture.set(I.TEXTURE0),ge.imageAtlasTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),ke.updatePaintBuffers(B)),ya(ke,R,de,ge,l);const je=se.getProjectionData({overscaledTileID:ve,applyGlobeMatrix:!P,applyTerrainMatrix:!0}),lt=a.ax(se,ge,ue,fe);if(w){Q=De.indexBuffer2,ie=De.segments2;const qe=[I.drawingBufferWidth,I.drawingBufferHeight];te=X==="fillOutlinePattern"&&N?$p(_,B,ge,qe,lt):vo(qe,lt)}else Q=De.indexBuffer,ie=De.segments,te=N?Vh(_,B,ge,lt):{u_fill_translate:lt};let at;if(_.renderPass==="translucent"&&P){const[qe]=_.getStencilConfigForOverlapAndUpdateStencilID(p);at=qe[ve.overscaledZ]}else at=_.stencilModeForClipping(ve);We.draw(_.context,W,g,at,x,ti.backCCW,te,Ze,je,l.id,De.layoutVertexBuffer,Q,ie,l.paint,_.transform.zoom,ke)}}function Tl(_,n,l,p,g,x,w,P){const I=_.context,R=I.gl,O="fill-extrusion-pattern",N=l.paint.get(O),B=N.constantOr(1),W=l.getCrossfadeParameters(),X=l.paint.get("fill-extrusion-opacity"),te=N.constantOr(null),Q=_.transform;for(const ie of p){const se=n.getTile(ie),ue=se.getBucket(l);if(!ue)continue;const fe=_.style.map.terrain&&_.style.map.terrain.getTerrainData(ie),de=ue.programConfigurations.get(l.id),ve=_.useProgram(B?"fillExtrusionPattern":"fillExtrusion",de);B&&(_.context.activeTexture.set(R.TEXTURE0),se.imageAtlasTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),de.updatePaintBuffers(W));const ge=Q.getProjectionData({overscaledTileID:ie,applyGlobeMatrix:!P,applyTerrainMatrix:!0});ya(de,O,te,se,l);const De=a.ax(Q,se,l.paint.get("fill-extrusion-translate"),l.paint.get("fill-extrusion-translate-anchor")),ke=l.paint.get("fill-extrusion-vertical-gradient"),We=B?ll(_,ke,X,De,ie,W,se):Uh(_,ke,X,De);ve.draw(I,I.gl.TRIANGLES,g,x,w,ti.backCCW,We,fe,ge,l.id,ue.layoutVertexBuffer,ue.indexBuffer,ue.segments,l.paint,_.transform.zoom,de,_.style.map.terrain&&ue.centroidVertexBuffer)}}function Sl(_,n,l,p,g,x,w,P,I){var R;const O=_.style.projection,N=_.context,B=_.transform,W=N.gl,X=_.useProgram("hillshade"),te=!_.options.moving;for(const Q of p){const ie=n.getTile(Q),se=ie.fbo;if(!se)continue;const ue=O.getMeshFromTileID(N,Q.canonical,P,!0,"raster"),fe=(R=_.style.map.terrain)===null||R===void 0?void 0:R.getTerrainData(Q);N.activeTexture.set(W.TEXTURE0),W.bindTexture(W.TEXTURE_2D,se.colorAttachment.get());const de=B.getProjectionData({overscaledTileID:Q,aligned:te,applyGlobeMatrix:!I,applyTerrainMatrix:!0});X.draw(N,W.TRIANGLES,x,g[Q.overscaledZ],w,ti.backCCW,Wh(_,ie,l),fe,de,l.id,ue.vertexBuffer,ue.indexBuffer,ue.segments)}}const Ao=[new a.P(0,0),new a.P(a.Z,0),new a.P(a.Z,a.Z),new a.P(0,a.Z)];function Po(_,n,l,p,g,x,w,P,I=!1,R=!1){const O=p[p.length-1].overscaledZ,N=_.context,B=N.gl,W=_.useProgram("raster"),X=_.transform,te=_.style.projection,Q=_.colorModeForRenderPass(),ie=!_.options.moving;for(const se of p){const ue=_.getDepthModeForSublayer(se.overscaledZ-O,l.paint.get("raster-opacity")===1?Vt.ReadWrite:Vt.ReadOnly,B.LESS),fe=n.getTile(se);fe.registerFadeDuration(l.paint.get("raster-fade-duration"));const de=n.findLoadedParent(se,0),ve=n.findLoadedSibling(se),ge=tg(fe,de||ve||null,n,l,_.transform,_.style.map.terrain);let De,ke;const We=l.paint.get("raster-resampling")==="nearest"?B.NEAREST:B.LINEAR;N.activeTexture.set(B.TEXTURE0),fe.texture.bind(We,B.CLAMP_TO_EDGE,B.LINEAR_MIPMAP_NEAREST),N.activeTexture.set(B.TEXTURE1),de?(de.texture.bind(We,B.CLAMP_TO_EDGE,B.LINEAR_MIPMAP_NEAREST),De=Math.pow(2,de.tileID.overscaledZ-fe.tileID.overscaledZ),ke=[fe.tileID.canonical.x*De%1,fe.tileID.canonical.y*De%1]):fe.texture.bind(We,B.CLAMP_TO_EDGE,B.LINEAR_MIPMAP_NEAREST),fe.texture.useMipmap&&N.extTextureFilterAnisotropic&&_.transform.pitch>20&&B.texParameterf(B.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const Ze=_.style.map.terrain&&_.style.map.terrain.getTerrainData(se),je=X.getProjectionData({overscaledTileID:se,aligned:ie,applyGlobeMatrix:!R,applyTerrainMatrix:!0}),lt=Zp(ke||[0,0],De||1,ge,l,P),at=te.getMeshFromTileID(N,se.canonical,x,w,"raster");W.draw(N,B.TRIANGLES,ue,g?g[se.overscaledZ]:Yt.disabled,Q,I?ti.frontCCW:ti.backCCW,lt,Ze,je,l.id,at.vertexBuffer,at.indexBuffer,at.segments)}}function tg(_,n,l,p,g,x){const w=p.paint.get("raster-fade-duration");if(!x&&w>0){const P=F.now(),I=(P-_.timeAdded)/w,R=n?(P-n.timeAdded)/w:-1,O=l.getSource(),N=Rn(g,{tileSize:O.tileSize,roundZoom:O.roundZoom}),B=!n||Math.abs(n.tileID.overscaledZ-N)>Math.abs(_.tileID.overscaledZ-N),W=B&&_.refreshedUponExpiration?1:a.ae(B?I:1-R,0,1);return _.refreshedUponExpiration&&I>=1&&(_.refreshedUponExpiration=!1),n?{opacity:1,mix:1-W}:{opacity:W,mix:0}}return{opacity:1,mix:0}}const cf=new a.b7(1,0,0,1),Bi=new a.b7(0,1,0,1),Ls=new a.b7(0,0,1,1),qr=new a.b7(1,0,1,1),Jc=new a.b7(0,1,1,1);function Al(_,n,l,p){Fn(_,0,n+l/2,_.transform.width,l,p)}function Qc(_,n,l,p){Fn(_,n-l/2,0,l,_.transform.height,p)}function Fn(_,n,l,p,g,x){const w=_.context,P=w.gl;P.enable(P.SCISSOR_TEST),P.scissor(n*_.pixelRatio,l*_.pixelRatio,p*_.pixelRatio,g*_.pixelRatio),w.clear({color:x}),P.disable(P.SCISSOR_TEST)}function xa(_,n,l){const p=_.context,g=p.gl,x=_.useProgram("debug"),w=Vt.disabled,P=Yt.disabled,I=_.colorModeForRenderPass(),R="$debug",O=_.style.map.terrain&&_.style.map.terrain.getTerrainData(l);p.activeTexture.set(g.TEXTURE0);const N=n.getTileByID(l.key).latestRawTileData,B=Math.floor((N&&N.byteLength||0)/1024),W=n.getTile(l).tileSize,X=512/Math.min(W,512)*(l.overscaledZ/_.transform.zoom)*.5;let te=l.canonical.toString();l.overscaledZ!==l.canonical.z&&(te+=` => ${l.overscaledZ}`),function(ie,se){ie.initDebugOverlayCanvas();const ue=ie.debugOverlayCanvas,fe=ie.context.gl,de=ie.debugOverlayCanvas.getContext("2d");de.clearRect(0,0,ue.width,ue.height),de.shadowColor="white",de.shadowBlur=2,de.lineWidth=1.5,de.strokeStyle="white",de.textBaseline="top",de.font="bold 36px Open Sans, sans-serif",de.fillText(se,5,5),de.strokeText(se,5,5),ie.debugOverlayTexture.update(ue),ie.debugOverlayTexture.bind(fe.LINEAR,fe.CLAMP_TO_EDGE)}(_,`${te} ${B}kB`);const Q=_.transform.getProjectionData({overscaledTileID:l,applyGlobeMatrix:!0,applyTerrainMatrix:!0});x.draw(p,g.TRIANGLES,w,P,_i.alphaBlended,ti.disabled,cl(a.b7.transparent,X),null,Q,R,_.debugBuffer,_.quadTriangleIndexBuffer,_.debugSegments),x.draw(p,g.LINE_STRIP,w,P,I,ti.disabled,cl(a.b7.red),O,Q,R,_.debugBuffer,_.tileBorderIndexBuffer,_.debugSegments)}function Pl(_,n,l,p){const{isRenderingGlobe:g}=p,x=_.context,w=x.gl,P=_.transform,I=_.colorModeForRenderPass(),R=_.getDepthModeFor3D(),O=_.useProgram("terrain");x.bindFramebuffer.set(null),x.viewport.set([0,0,_.width,_.height]);for(const N of l){const B=n.getTerrainMesh(N.tileID),W=_.renderToTexture.getTexture(N),X=n.getTerrainData(N.tileID);x.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_2D,W.texture);const te=n.getMeshFrameDelta(P.zoom),Q=P.calculateFogMatrix(N.tileID.toUnwrapped()),ie=gn(te,Q,_.style.sky,P.pitch,g),se=P.getProjectionData({overscaledTileID:N.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});O.draw(x,w.TRIANGLES,R,Yt.disabled,I,ti.backCCW,ie,X,se,"terrain",B.vertexBuffer,B.indexBuffer,B.segments)}}function eu(_,n){if(!n.mesh){const l=new a.aF;l.emplaceBack(-1,-1),l.emplaceBack(1,-1),l.emplaceBack(1,1),l.emplaceBack(-1,1);const p=new a.aH;p.emplaceBack(0,1,2),p.emplaceBack(0,2,3),n.mesh=new Cs(_.createVertexBuffer(l,ns.members),_.createIndexBuffer(p),a.aG.simpleSegment(0,0,l.length,p.length))}return n.mesh}class uf{constructor(n,l){this.context=new Qp(n),this.transform=l,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:a.at(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=Z.maxUnderzooming+Z.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new tl}resize(n,l,p){if(this.width=Math.floor(n*p),this.height=Math.floor(l*p),this.pixelRatio=p,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const g of this.style._order)this.style._layers[g].resize()}setup(){const n=this.context,l=new a.aF;l.emplaceBack(0,0),l.emplaceBack(a.Z,0),l.emplaceBack(0,a.Z),l.emplaceBack(a.Z,a.Z),this.tileExtentBuffer=n.createVertexBuffer(l,ns.members),this.tileExtentSegments=a.aG.simpleSegment(0,0,4,2);const p=new a.aF;p.emplaceBack(0,0),p.emplaceBack(a.Z,0),p.emplaceBack(0,a.Z),p.emplaceBack(a.Z,a.Z),this.debugBuffer=n.createVertexBuffer(p,ns.members),this.debugSegments=a.aG.simpleSegment(0,0,4,5);const g=new a.bW;g.emplaceBack(0,0,0,0),g.emplaceBack(a.Z,0,a.Z,0),g.emplaceBack(0,a.Z,0,a.Z),g.emplaceBack(a.Z,a.Z,a.Z,a.Z),this.rasterBoundsBuffer=n.createVertexBuffer(g,Dc.members),this.rasterBoundsSegments=a.aG.simpleSegment(0,0,4,2);const x=new a.aF;x.emplaceBack(0,0),x.emplaceBack(a.Z,0),x.emplaceBack(0,a.Z),x.emplaceBack(a.Z,a.Z),this.rasterBoundsBufferPosOnly=n.createVertexBuffer(x,ns.members),this.rasterBoundsSegmentsPosOnly=a.aG.simpleSegment(0,0,4,5);const w=new a.aF;w.emplaceBack(0,0),w.emplaceBack(1,0),w.emplaceBack(0,1),w.emplaceBack(1,1),this.viewportBuffer=n.createVertexBuffer(w,ns.members),this.viewportSegments=a.aG.simpleSegment(0,0,4,2);const P=new a.bX;P.emplaceBack(0),P.emplaceBack(1),P.emplaceBack(3),P.emplaceBack(2),P.emplaceBack(0),this.tileBorderIndexBuffer=n.createIndexBuffer(P);const I=new a.aH;I.emplaceBack(1,0,2),I.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=n.createIndexBuffer(I);const R=this.context.gl;this.stencilClearMode=new Yt({func:R.ALWAYS,mask:0},0,255,R.ZERO,R.ZERO,R.ZERO),this.tileExtentMesh=new Cs(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const n=this.context,l=n.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const p=a.K();a.bO(p,0,this.width,this.height,0,0,1),a.M(p,p,[l.drawingBufferWidth,l.drawingBufferHeight,0]);const g={mainMatrix:p,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:p};this.useProgram("clippingMask",null,!0).draw(n,l.TRIANGLES,Vt.disabled,this.stencilClearMode,_i.disabled,ti.disabled,null,null,g,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(n,l,p){if(this.currentStencilSource===n.source||!n.isTileClipped()||!l||!l.length)return;this.currentStencilSource=n.source,this.nextStencilID+l.length>256&&this.clearStencil();const g=this.context;g.setColorMode(_i.disabled),g.setDepthMode(Vt.disabled);const x={};for(const w of l)x[w.key]=this.nextStencilID++;this._renderTileMasks(x,l,p,!0),this._renderTileMasks(x,l,p,!1),this._tileClippingMaskIDs=x}_renderTileMasks(n,l,p,g){const x=this.context,w=x.gl,P=this.style.projection,I=this.transform,R=this.useProgram("clippingMask");for(const O of l){const N=n[O.key],B=this.style.map.terrain&&this.style.map.terrain.getTerrainData(O),W=P.getMeshFromTileID(this.context,O.canonical,g,!0,"stencil"),X=I.getProjectionData({overscaledTileID:O,applyGlobeMatrix:!0,applyTerrainMatrix:!0});R.draw(x,w.TRIANGLES,Vt.disabled,new Yt({func:w.ALWAYS,mask:0},N,255,w.KEEP,w.KEEP,w.REPLACE),_i.disabled,p?ti.disabled:ti.backCCW,null,B,X,"$clipping",W.vertexBuffer,W.indexBuffer,W.segments)}}_renderTilesDepthBuffer(){const n=this.context,l=n.gl,p=this.style.projection,g=this.transform,x=this.useProgram("depth"),w=this.getDepthModeFor3D(),P=Pe(g,{tileSize:g.tileSize});for(const I of P){const R=this.style.map.terrain&&this.style.map.terrain.getTerrainData(I),O=p.getMeshFromTileID(this.context,I.canonical,!0,!0,"raster"),N=g.getProjectionData({overscaledTileID:I,applyGlobeMatrix:!0,applyTerrainMatrix:!0});x.draw(n,l.TRIANGLES,w,Yt.disabled,_i.disabled,ti.backCCW,null,R,N,"$clipping",O.vertexBuffer,O.indexBuffer,O.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const n=this.nextStencilID++,l=this.context.gl;return new Yt({func:l.NOTEQUAL,mask:255},n,255,l.KEEP,l.KEEP,l.REPLACE)}stencilModeForClipping(n){const l=this.context.gl;return new Yt({func:l.EQUAL,mask:255},this._tileClippingMaskIDs[n.key],0,l.KEEP,l.KEEP,l.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(n){const l=this.context.gl,p=n.sort((w,P)=>P.overscaledZ-w.overscaledZ),g=p[p.length-1].overscaledZ,x=p[0].overscaledZ-g+1;if(x>1){this.currentStencilSource=void 0,this.nextStencilID+x>256&&this.clearStencil();const w={};for(let P=0;P<x;P++)w[P+g]=new Yt({func:l.GEQUAL,mask:255},P+this.nextStencilID,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID+=x,[w,p]}return[{[g]:Yt.disabled},p]}stencilConfigForOverlapTwoPass(n){const l=this.context.gl,p=n.sort((w,P)=>P.overscaledZ-w.overscaledZ),g=p[p.length-1].overscaledZ,x=p[0].overscaledZ-g+1;if(this.clearStencil(),x>1){const w={},P={};for(let I=0;I<x;I++)w[I+g]=new Yt({func:l.GREATER,mask:255},x+1+I,255,l.KEEP,l.KEEP,l.REPLACE),P[I+g]=new Yt({func:l.GREATER,mask:255},1+I,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID=2*x+1,[w,P,p]}return this.nextStencilID=3,[{[g]:new Yt({func:l.GREATER,mask:255},2,255,l.KEEP,l.KEEP,l.REPLACE)},{[g]:new Yt({func:l.GREATER,mask:255},1,255,l.KEEP,l.KEEP,l.REPLACE)},p]}colorModeForRenderPass(){const n=this.context.gl;return this._showOverdrawInspector?new _i([n.CONSTANT_COLOR,n.ONE],new a.b7(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?_i.unblended:_i.alphaBlended}getDepthModeForSublayer(n,l,p){if(!this.opaquePassEnabledForLayer())return Vt.disabled;const g=1-((1+this.currentLayer)*this.numSublayers+n)*this.depthEpsilon;return new Vt(p||this.context.gl.LEQUAL,l,[g,g])}getDepthModeFor3D(){return new Vt(this.context.gl.LEQUAL,Vt.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(n,l){var p,g;this.style=n,this.options=l,this.lineAtlas=n.lineAtlas,this.imageManager=n.imageManager,this.glyphManager=n.glyphManager,this.symbolFadeChange=n.placement.symbolFadeChange(F.now()),this.imageManager.beginFrame();const x=this.style._order,w=this.style.sourceCaches,P={},I={},R={},O={isRenderingToTexture:!1,isRenderingGlobe:((p=n.projection)===null||p===void 0?void 0:p.transitionState)>0};for(const B in w){const W=w[B];W.used&&W.prepare(this.context),P[B]=W.getVisibleCoordinates(!1),I[B]=P[B].slice().reverse(),R[B]=W.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let B=0;B<x.length;B++)if(this.style._layers[x[B]].is3D()){this.opaquePassCutoff=B;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const B of x){const W=this.style._layers[B];if(!W.hasOffscreenPass()||W.isHidden(this.transform.zoom))continue;const X=I[W.source];(W.type==="custom"||X.length)&&this.renderLayer(this,w[W.source],W,X,O)}if((g=this.style.projection)===null||g===void 0||g.updateGPUdependent({context:this.context,useProgram:B=>this.useProgram(B)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:l.showOverdrawInspector?a.b7.black:a.b7.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(B,W){const X=B.context,te=X.gl,Q=((ve,ge,De)=>{const ke=Math.cos(ge.rollInRadians),We=Math.sin(ge.rollInRadians),Ze=uo(ge),je=ge.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:ve.properties.get("sky-color"),u_horizon_color:ve.properties.get("horizon-color"),u_horizon:[(ge.width/2-Ze*We)*De,(ge.height/2+Ze*ke)*De],u_horizon_normal:[-We,ke],u_sky_horizon_blend:ve.properties.get("sky-horizon-blend")*ge.height/2*De,u_sky_blend:je}})(W,B.style.map.transform,B.pixelRatio),ie=new Vt(te.LEQUAL,Vt.ReadWrite,[0,1]),se=Yt.disabled,ue=B.colorModeForRenderPass(),fe=B.useProgram("sky"),de=eu(X,W);fe.draw(X,te.TRIANGLES,ie,se,ue,ti.disabled,Q,null,void 0,"sky",de.vertexBuffer,de.indexBuffer,de.segments)}(this,this.style.sky),this._showOverdrawInspector=l.showOverdrawInspector,this.depthRangeFor3D=[0,1-(n._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=x.length-1;this.currentLayer>=0;this.currentLayer--){const B=this.style._layers[x[this.currentLayer]],W=w[B.source],X=P[B.source];this._renderTileClippingMasks(B,X,!1),this.renderLayer(this,W,B,X,O)}this.renderPass="translucent";let N=!1;for(this.currentLayer=0;this.currentLayer<x.length;this.currentLayer++){const B=this.style._layers[x[this.currentLayer]],W=w[B.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(B,O))continue;this.opaquePassEnabledForLayer()||N||(N=!0,O.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const X=(B.type==="symbol"?R:I)[B.source];this._renderTileClippingMasks(B,P[B.source],!1),this.renderLayer(this,W,B,X,O)}if(O.isRenderingGlobe&&function(B,W,X){const te=B.context,Q=te.gl,ie=B.useProgram("atmosphere"),se=new Vt(Q.LEQUAL,Vt.ReadOnly,[0,1]),ue=B.transform,fe=function(je,lt){const at=je.properties.get("position"),qe=[-at.x,-at.y,-at.z],bt=a.at(new Float64Array(16));return je.properties.get("anchor")==="map"&&(a.a_(bt,bt,lt.rollInRadians),a.a$(bt,bt,-lt.pitchInRadians),a.a_(bt,bt,lt.bearingInRadians),a.a$(bt,bt,lt.center.lat*Math.PI/180),a.bm(bt,bt,-lt.center.lng*Math.PI/180)),a.bV(qe,qe,bt),qe}(X,B.transform),de=ue.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),ve=W.properties.get("atmosphere-blend")*de.projectionTransition;if(ve===0)return;const ge=sl(ue.worldSize,ue.center.lat),De=ue.inverseProjectionMatrix,ke=new Float64Array(4);ke[3]=1,a.ap(ke,ke,ue.modelViewProjectionMatrix),ke[0]/=ke[3],ke[1]/=ke[3],ke[2]/=ke[3],ke[3]=1,a.ap(ke,ke,De),ke[0]/=ke[3],ke[1]/=ke[3],ke[2]/=ke[3],ke[3]=1;const We=((je,lt,at,qe,bt)=>({u_sun_pos:je,u_atmosphere_blend:lt,u_globe_position:at,u_globe_radius:qe,u_inv_proj_matrix:bt}))(fe,ve,[ke[0],ke[1],ke[2]],ge,De),Ze=eu(te,W);ie.draw(te,Q.TRIANGLES,se,Yt.disabled,_i.alphaBlended,ti.disabled,We,null,null,"atmosphere",Ze.vertexBuffer,Ze.indexBuffer,Ze.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const B=function(W,X){let te=null;const Q=Object.values(W._layers).flatMap(fe=>fe.source&&!fe.isHidden(X)?[W.sourceCaches[fe.source]]:[]),ie=Q.filter(fe=>fe.getSource().type==="vector"),se=Q.filter(fe=>fe.getSource().type!=="vector"),ue=fe=>{(!te||te.getSource().maxzoom<fe.getSource().maxzoom)&&(te=fe)};return ie.forEach(fe=>ue(fe)),te||se.forEach(fe=>ue(fe)),te}(this.style,this.transform.zoom);B&&function(W,X,te){for(let Q=0;Q<te.length;Q++)xa(W,X,te[Q])}(this,B,B.getVisibleCoordinates())}this.options.showPadding&&function(B){const W=B.transform.padding;Al(B,B.transform.height-(W.top||0),3,cf),Al(B,W.bottom||0,3,Bi),Qc(B,W.left||0,3,Ls),Qc(B,B.transform.width-(W.right||0),3,qr);const X=B.transform.centerPoint;(function(te,Q,ie,se){Fn(te,Q-1,ie-10,2,20,se),Fn(te,Q-10,ie-1,20,2,se)})(B,X.x,B.transform.height-X.y,Jc)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(n){if(!this.style||!this.style.map||!this.style.map.terrain)return;const l=this.terrainFacilitator.matrix,p=this.transform.modelViewProjectionMatrix;let g=this.terrainFacilitator.dirty;g||(g=n?!a.bY(l,p):!a.bZ(l,p)),g||(g=this.style.map.terrain.sourceCache.anyTilesAfterTime(this.terrainFacilitator.renderTime)),g&&(a.b_(l,p),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(x,w){const P=x.context,I=P.gl,R=x.transform,O=_i.unblended,N=new Vt(I.LEQUAL,Vt.ReadWrite,[0,1]),B=w.sourceCache.getRenderableTiles(),W=x.useProgram("terrainDepth");P.bindFramebuffer.set(w.getFramebuffer("depth").framebuffer),P.viewport.set([0,0,x.width/devicePixelRatio,x.height/devicePixelRatio]),P.clear({color:a.b7.transparent,depth:1});for(const X of B){const te=w.getTerrainMesh(X.tileID),Q=w.getTerrainData(X.tileID),ie=R.getProjectionData({overscaledTileID:X.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),se={u_ele_delta:w.getMeshFrameDelta(R.zoom)};W.draw(P,I.TRIANGLES,N,Yt.disabled,O,ti.backCCW,se,Q,ie,"terrain",te.vertexBuffer,te.indexBuffer,te.segments)}P.bindFramebuffer.set(null),P.viewport.set([0,0,x.width,x.height])}(this,this.style.map.terrain),function(x,w){const P=x.context,I=P.gl,R=x.transform,O=_i.unblended,N=new Vt(I.LEQUAL,Vt.ReadWrite,[0,1]),B=w.getCoordsTexture(),W=w.sourceCache.getRenderableTiles(),X=x.useProgram("terrainCoords");P.bindFramebuffer.set(w.getFramebuffer("coords").framebuffer),P.viewport.set([0,0,x.width/devicePixelRatio,x.height/devicePixelRatio]),P.clear({color:a.b7.transparent,depth:1}),w.coordsIndex=[];for(const te of W){const Q=w.getTerrainMesh(te.tileID),ie=w.getTerrainData(te.tileID);P.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,B.texture);const se={u_terrain_coords_id:(255-w.coordsIndex.length)/255,u_texture:0,u_ele_delta:w.getMeshFrameDelta(R.zoom)},ue=R.getProjectionData({overscaledTileID:te.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});X.draw(P,I.TRIANGLES,N,Yt.disabled,O,ti.backCCW,se,ie,ue,"terrain",Q.vertexBuffer,Q.indexBuffer,Q.segments),w.coordsIndex.push(te.tileID.key)}P.bindFramebuffer.set(null),P.viewport.set([0,0,x.width,x.height])}(this,this.style.map.terrain))}renderLayer(n,l,p,g,x){p.isHidden(this.transform.zoom)||(p.type==="background"||p.type==="custom"||(g||[]).length)&&(this.id=p.id,a.b$(p)?function(w,P,I,R,O,N){if(w.renderPass!=="translucent")return;const{isRenderingToTexture:B}=N,W=Yt.disabled,X=w.colorModeForRenderPass();(I._unevaluatedLayout.hasValue("text-variable-anchor")||I._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(te,Q,ie,se,ue,fe,de,ve,ge){const De=Q.transform,ke=Q.style.map.terrain,We=ue==="map",Ze=fe==="map";for(const je of te){const lt=se.getTile(je),at=lt.getBucket(ie);if(!at||!at.text||!at.text.segments.get().length)continue;const qe=a.ag(at.textSizeData,De.zoom),bt=a.aw(lt,1,Q.transform.zoom),Ut=Re(We,Q.transform,bt),ni=ie.layout.get("icon-text-fit")!=="none"&&at.hasIconData();if(qe){const jt=Math.pow(2,De.zoom-lt.tileID.overscaledZ),ui=ke?(gi,xi)=>ke.getElevation(je,gi,xi):null;af(at,We,Ze,ge,De,Ut,jt,qe,ni,a.ax(De,lt,de,ve),je.toUnwrapped(),ui)}}}(R,w,I,P,I.layout.get("text-rotation-alignment"),I.layout.get("text-pitch-alignment"),I.paint.get("text-translate"),I.paint.get("text-translate-anchor"),O),I.paint.get("icon-opacity").constantOr(1)!==0&&_a(w,P,I,R,!1,I.paint.get("icon-translate"),I.paint.get("icon-translate-anchor"),I.layout.get("icon-rotation-alignment"),I.layout.get("icon-pitch-alignment"),I.layout.get("icon-keep-upright"),W,X,B),I.paint.get("text-opacity").constantOr(1)!==0&&_a(w,P,I,R,!0,I.paint.get("text-translate"),I.paint.get("text-translate-anchor"),I.layout.get("text-rotation-alignment"),I.layout.get("text-pitch-alignment"),I.layout.get("text-keep-upright"),W,X,B),P.map.showCollisionBoxes&&(ma(w,P,I,R,!0),ma(w,P,I,R,!1))}(n,l,p,g,this.style.placement.variableOffsets,x):a.c0(p)?function(w,P,I,R,O){if(w.renderPass!=="translucent")return;const{isRenderingToTexture:N}=O,B=I.paint.get("circle-opacity"),W=I.paint.get("circle-stroke-width"),X=I.paint.get("circle-stroke-opacity"),te=!I.layout.get("circle-sort-key").isConstant();if(B.constantOr(1)===0&&(W.constantOr(1)===0||X.constantOr(1)===0))return;const Q=w.context,ie=Q.gl,se=w.transform,ue=w.getDepthModeForSublayer(0,Vt.ReadOnly),fe=Yt.disabled,de=w.colorModeForRenderPass(),ve=[],ge=se.getCircleRadiusCorrection();for(let De=0;De<R.length;De++){const ke=R[De],We=P.getTile(ke),Ze=We.getBucket(I);if(!Ze)continue;const je=I.paint.get("circle-translate"),lt=I.paint.get("circle-translate-anchor"),at=a.ax(se,We,je,lt),qe=Ze.programConfigurations.get(I.id),bt=w.useProgram("circle",qe),Ut=Ze.layoutVertexBuffer,ni=Ze.indexBuffer,jt=w.style.map.terrain&&w.style.map.terrain.getTerrainData(ke),ui={programConfiguration:qe,program:bt,layoutVertexBuffer:Ut,indexBuffer:ni,uniformValues:jh(w,We,I,at,ge),terrainData:jt,projectionData:se.getProjectionData({overscaledTileID:ke,applyGlobeMatrix:!N,applyTerrainMatrix:!0})};if(te){const gi=Ze.segments.get();for(const xi of gi)ve.push({segments:new a.aG([xi]),sortKey:xi.sortKey,state:ui})}else ve.push({segments:Ze.segments,sortKey:0,state:ui})}te&&ve.sort((De,ke)=>De.sortKey-ke.sortKey);for(const De of ve){const{programConfiguration:ke,program:We,layoutVertexBuffer:Ze,indexBuffer:je,uniformValues:lt,terrainData:at,projectionData:qe}=De.state;We.draw(Q,ie.TRIANGLES,ue,fe,de,ti.backCCW,lt,at,qe,I.id,Ze,je,De.segments,I.paint,w.transform.zoom,ke)}}(n,l,p,g,x):a.c1(p)?function(w,P,I,R,O){if(I.paint.get("heatmap-opacity")===0)return;const N=w.context,{isRenderingToTexture:B,isRenderingGlobe:W}=O;if(w.style.map.terrain){for(const X of R){const te=P.getTile(X);P.hasRenderableParent(X)||(w.renderPass==="offscreen"?eg(w,te,I,X,W):w.renderPass==="translucent"&&Yc(w,I,X,B,W))}N.viewport.set([0,0,w.width,w.height])}else w.renderPass==="offscreen"?function(X,te,Q,ie){const se=X.context,ue=se.gl,fe=X.transform,de=Yt.disabled,ve=new _i([ue.ONE,ue.ONE],a.b7.transparent,[!0,!0,!0,!0]);(function(ge,De,ke){const We=ge.gl;ge.activeTexture.set(We.TEXTURE1),ge.viewport.set([0,0,De.width/4,De.height/4]);let Ze=ke.heatmapFbos.get(a.bS);Ze?(We.bindTexture(We.TEXTURE_2D,Ze.colorAttachment.get()),ge.bindFramebuffer.set(Ze.framebuffer)):(Ze=lf(ge,De.width/4,De.height/4),ke.heatmapFbos.set(a.bS,Ze))})(se,X,Q),se.clear({color:a.b7.transparent});for(let ge=0;ge<ie.length;ge++){const De=ie[ge];if(te.hasRenderableParent(De))continue;const ke=te.getTile(De),We=ke.getBucket(Q);if(!We)continue;const Ze=We.programConfigurations.get(Q.id),je=X.useProgram("heatmap",Ze),lt=fe.getProjectionData({overscaledTileID:De,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),at=fe.getCircleRadiusCorrection();je.draw(se,ue.TRIANGLES,Vt.disabled,de,ve,ti.backCCW,Fc(ke,fe.zoom,Q.paint.get("heatmap-intensity"),at),null,lt,Q.id,We.layoutVertexBuffer,We.indexBuffer,We.segments,Q.paint,fe.zoom,Ze)}se.viewport.set([0,0,X.width,X.height])}(w,P,I,R):w.renderPass==="translucent"&&function(X,te){const Q=X.context,ie=Q.gl;Q.setColorMode(X.colorModeForRenderPass());const se=te.heatmapFbos.get(a.bS);se&&(Q.activeTexture.set(ie.TEXTURE0),ie.bindTexture(ie.TEXTURE_2D,se.colorAttachment.get()),Q.activeTexture.set(ie.TEXTURE1),Kc(Q,te).bind(ie.LINEAR,ie.CLAMP_TO_EDGE),X.useProgram("heatmapTexture").draw(Q,ie.TRIANGLES,Vt.disabled,Yt.disabled,X.colorModeForRenderPass(),ti.disabled,Lc(X,te,0,1),null,null,te.id,X.viewportBuffer,X.quadTriangleIndexBuffer,X.viewportSegments,te.paint,X.transform.zoom))}(w,I)}(n,l,p,g,x):a.c2(p)?function(w,P,I,R,O){if(w.renderPass!=="translucent")return;const{isRenderingToTexture:N}=O,B=I.paint.get("line-opacity"),W=I.paint.get("line-width");if(B.constantOr(1)===0||W.constantOr(1)===0)return;const X=w.getDepthModeForSublayer(0,Vt.ReadOnly),te=w.colorModeForRenderPass(),Q=I.paint.get("line-dasharray"),ie=I.paint.get("line-pattern"),se=ie.constantOr(1),ue=I.paint.get("line-gradient"),fe=I.getCrossfadeParameters(),de=se?"linePattern":Q?"lineSDF":ue?"lineGradient":"line",ve=w.context,ge=ve.gl,De=w.transform;let ke=!0;for(const We of R){const Ze=P.getTile(We);if(se&&!Ze.patternsLoaded())continue;const je=Ze.getBucket(I);if(!je)continue;const lt=je.programConfigurations.get(I.id),at=w.context.program.get(),qe=w.useProgram(de,lt),bt=ke||qe.program!==at,Ut=w.style.map.terrain&&w.style.map.terrain.getTerrainData(We),ni=ie.constantOr(null);if(ni&&Ze.imageAtlas){const ci=Ze.imageAtlas,hi=ci.patternPositions[ni.to.toString()],Ui=ci.patternPositions[ni.from.toString()];hi&&Ui&&lt.setConstantPatternPositions(hi,Ui)}const jt=De.getProjectionData({overscaledTileID:We,applyGlobeMatrix:!N,applyTerrainMatrix:!0}),ui=De.getPixelScale(),gi=se?fa(w,Ze,I,ui,fe):Q?Hp(w,Ze,I,ui,Q,fe):ue?Zh(w,Ze,I,ui,je.lineClipsArray.length):ul(w,Ze,I,ui);if(se)ve.activeTexture.set(ge.TEXTURE0),Ze.imageAtlasTexture.bind(ge.LINEAR,ge.CLAMP_TO_EDGE),lt.updatePaintBuffers(fe);else if(Q&&(bt||w.lineAtlas.dirty))ve.activeTexture.set(ge.TEXTURE0),w.lineAtlas.bind(ve);else if(ue){const ci=je.gradients[I.id];let hi=ci.texture;if(I.gradientVersion!==ci.version){let Ui=256;if(I.stepInterpolant){const Ki=P.getSource().maxzoom,tr=We.canonical.z===Ki?Math.ceil(1<<w.transform.maxZoom-We.canonical.z):1;Ui=a.ae(a.bT(je.maxLineLength/a.Z*1024*tr),256,ve.maxTextureSize)}ci.gradient=a.bU({expression:I.gradientExpression(),evaluationKey:"lineProgress",resolution:Ui,image:ci.gradient||void 0,clips:je.lineClipsArray}),ci.texture?ci.texture.update(ci.gradient):ci.texture=new ft(ve,ci.gradient,ge.RGBA),ci.version=I.gradientVersion,hi=ci.texture}ve.activeTexture.set(ge.TEXTURE0),hi.bind(I.stepInterpolant?ge.NEAREST:ge.LINEAR,ge.CLAMP_TO_EDGE)}let xi;if(N){const[ci]=w.getStencilConfigForOverlapAndUpdateStencilID(R);xi=ci[We.overscaledZ]}else xi=w.stencilModeForClipping(We);qe.draw(ve,ge.TRIANGLES,X,xi,te,ti.disabled,gi,Ut,jt,I.id,je.layoutVertexBuffer,je.indexBuffer,je.segments,I.paint,w.transform.zoom,lt,je.layoutVertexBuffer2),ke=!1}}(n,l,p,g,x):a.c3(p)?function(w,P,I,R,O){const N=I.paint.get("fill-color"),B=I.paint.get("fill-opacity");if(B.constantOr(1)===0)return;const{isRenderingToTexture:W}=O,X=w.colorModeForRenderPass(),te=I.paint.get("fill-pattern"),Q=w.opaquePassEnabledForLayer()&&!te.constantOr(1)&&N.constantOr(a.b7.transparent).a===1&&B.constantOr(0)===1?"opaque":"translucent";if(w.renderPass===Q){const ie=w.getDepthModeForSublayer(1,w.renderPass==="opaque"?Vt.ReadWrite:Vt.ReadOnly);wl(w,P,I,R,ie,X,!1,W)}if(w.renderPass==="translucent"&&I.paint.get("fill-antialias")){const ie=w.getDepthModeForSublayer(I.getPaintProperty("fill-outline-color")?2:0,Vt.ReadOnly);wl(w,P,I,R,ie,X,!0,W)}}(n,l,p,g,x):a.c4(p)?function(w,P,I,R,O){const N=I.paint.get("fill-extrusion-opacity");if(N===0)return;const{isRenderingToTexture:B}=O;if(w.renderPass==="translucent"){const W=new Vt(w.context.gl.LEQUAL,Vt.ReadWrite,w.depthRangeFor3D);if(N!==1||I.paint.get("fill-extrusion-pattern").constantOr(1))Tl(w,P,I,R,W,Yt.disabled,_i.disabled,B),Tl(w,P,I,R,W,w.stencilModeFor3D(),w.colorModeForRenderPass(),B);else{const X=w.colorModeForRenderPass();Tl(w,P,I,R,W,Yt.disabled,X,B)}}}(n,l,p,g,x):a.c5(p)?function(w,P,I,R,O){if(w.renderPass!=="offscreen"&&w.renderPass!=="translucent")return;const{isRenderingToTexture:N}=O,B=w.context,W=w.style.projection.useSubdivision,X=w.getDepthModeForSublayer(0,Vt.ReadOnly),te=w.colorModeForRenderPass();if(w.renderPass==="offscreen")(function(Q,ie,se,ue,fe,de,ve){const ge=Q.context,De=ge.gl;for(const ke of se){const We=ie.getTile(ke),Ze=We.dem;if(!Ze||!Ze.data||!We.needsHillshadePrepare)continue;const je=Ze.dim,lt=Ze.stride,at=Ze.getPixels();if(ge.activeTexture.set(De.TEXTURE1),ge.pixelStoreUnpackPremultiplyAlpha.set(!1),We.demTexture=We.demTexture||Q.getTileTexture(lt),We.demTexture){const bt=We.demTexture;bt.update(at,{premultiply:!1}),bt.bind(De.NEAREST,De.CLAMP_TO_EDGE)}else We.demTexture=new ft(ge,at,De.RGBA,{premultiply:!1}),We.demTexture.bind(De.NEAREST,De.CLAMP_TO_EDGE);ge.activeTexture.set(De.TEXTURE0);let qe=We.fbo;if(!qe){const bt=new ft(ge,{width:je,height:je,data:null},De.RGBA);bt.bind(De.LINEAR,De.CLAMP_TO_EDGE),qe=We.fbo=ge.createFramebuffer(je,je,!0,!1),qe.colorAttachment.set(bt.texture)}ge.bindFramebuffer.set(qe.framebuffer),ge.viewport.set([0,0,je,je]),Q.useProgram("hillshadePrepare").draw(ge,De.TRIANGLES,fe,de,ve,ti.disabled,Hh(We.tileID,Ze),null,null,ue.id,Q.rasterBoundsBuffer,Q.quadTriangleIndexBuffer,Q.rasterBoundsSegments),We.needsHillshadePrepare=!1}})(w,P,R,I,X,Yt.disabled,te),B.viewport.set([0,0,w.width,w.height]);else if(w.renderPass==="translucent")if(W){const[Q,ie,se]=w.stencilConfigForOverlapTwoPass(R);Sl(w,P,I,se,Q,X,te,!1,N),Sl(w,P,I,se,ie,X,te,!0,N)}else{const[Q,ie]=w.getStencilConfigForOverlapAndUpdateStencilID(R);Sl(w,P,I,ie,Q,X,te,!1,N)}}(n,l,p,g,x):a.c6(p)?function(w,P,I,R,O){if(w.renderPass!=="translucent"||I.paint.get("raster-opacity")===0||!R.length)return;const{isRenderingToTexture:N}=O,B=P.getSource(),W=w.style.projection.useSubdivision;if(B instanceof Jr)Po(w,P,I,R,null,!1,!1,B.tileCoords,B.flippedWindingOrder,N);else if(W){const[X,te,Q]=w.stencilConfigForOverlapTwoPass(R);Po(w,P,I,Q,X,!1,!0,Ao,!1,N),Po(w,P,I,Q,te,!0,!0,Ao,!1,N)}else{const[X,te]=w.getStencilConfigForOverlapAndUpdateStencilID(R);Po(w,P,I,te,X,!1,!0,Ao,!1,N)}}(n,l,p,g,x):a.c7(p)?function(w,P,I,R,O){const N=I.paint.get("background-color"),B=I.paint.get("background-opacity");if(B===0)return;const{isRenderingToTexture:W}=O,X=w.context,te=X.gl,Q=w.style.projection,ie=w.transform,se=ie.tileSize,ue=I.paint.get("background-pattern");if(w.isPatternMissing(ue))return;const fe=!ue&&N.a===1&&B===1&&w.opaquePassEnabledForLayer()?"opaque":"translucent";if(w.renderPass!==fe)return;const de=Yt.disabled,ve=w.getDepthModeForSublayer(0,fe==="opaque"?Vt.ReadWrite:Vt.ReadOnly),ge=w.colorModeForRenderPass(),De=w.useProgram(ue?"backgroundPattern":"background"),ke=R||Pe(ie,{tileSize:se,terrain:w.style.map.terrain});ue&&(X.activeTexture.set(te.TEXTURE0),w.imageManager.bind(w.context));const We=I.getCrossfadeParameters();for(const Ze of ke){const je=ie.getProjectionData({overscaledTileID:Ze,applyGlobeMatrix:!W,applyTerrainMatrix:!0}),lt=ue?hl(B,w,ue,{tileID:Ze,tileSize:se},We):Gh(B,N),at=w.style.map.terrain&&w.style.map.terrain.getTerrainData(Ze),qe=Q.getMeshFromTileID(X,Ze.canonical,!1,!0,"raster");De.draw(X,te.TRIANGLES,ve,de,ge,ti.backCCW,lt,at,je,I.id,qe.vertexBuffer,qe.indexBuffer,qe.segments)}}(n,0,p,g,x):a.c8(p)&&function(w,P,I,R){const{isRenderingGlobe:O}=R,N=w.context,B=I.implementation,W=w.style.projection,X=w.transform,te=X.getProjectionDataForCustomLayer(O),Q={farZ:X.farZ,nearZ:X.nearZ,fov:X.fov*Math.PI/180,modelViewProjectionMatrix:X.modelViewProjectionMatrix,projectionMatrix:X.projectionMatrix,shaderData:{variantName:W.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${W.shaderPreludeCode.vertexSource}`,define:W.shaderDefine},defaultProjectionData:te},ie=B.renderingMode?B.renderingMode:"2d";if(w.renderPass==="offscreen"){const se=B.prerender;se&&(w.setCustomLayerDefaults(),N.setColorMode(w.colorModeForRenderPass()),se.call(B,N.gl,Q),N.setDirty(),w.setBaseState())}else if(w.renderPass==="translucent"){w.setCustomLayerDefaults(),N.setColorMode(w.colorModeForRenderPass()),N.setStencilMode(Yt.disabled);const se=ie==="3d"?w.getDepthModeFor3D():w.getDepthModeForSublayer(0,Vt.ReadOnly);N.setDepthMode(se),B.render(N.gl,Q),N.setDirty(),w.setBaseState(),N.bindFramebuffer.set(null)}}(n,0,p,x))}saveTileTexture(n){const l=this._tileTextures[n.size[0]];l?l.push(n):this._tileTextures[n.size[0]]=[n]}getTileTexture(n){const l=this._tileTextures[n];return l&&l.length>0?l.pop():null}isPatternMissing(n){if(!n)return!1;if(!n.from||!n.to)return!0;const l=this.imageManager.getPattern(n.from.toString()),p=this.imageManager.getPattern(n.to.toString());return!l||!p}useProgram(n,l,p=!1){this.cache=this.cache||{};const g=!!this.style.map.terrain,x=this.style.projection,w=n+(l?l.cacheKey:"")+`/${p?co:x.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(g?"/terrain":"");return this.cache[w]||(this.cache[w]=new ha(this.context,en[n],l,Uc[n],this._showOverdrawInspector,g,p?en.projectionMercator:x.shaderPreludeCode,p?Dn:x.shaderDefine)),this.cache[w]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const n=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(n.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new ft(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:n,drawingBufferHeight:l}=this.context.gl;return this.width!==n||this.height!==l}}function tu(_,n){let l,p=!1,g=null,x=null;const w=()=>{g=null,p&&(_.apply(x,l),g=setTimeout(w,n),p=!1)};return(...P)=>(p=!0,x=this,l=P,g||w(),g)}class iu{constructor(n){this._getCurrentHash=()=>{const l=window.location.hash.replace("#","");if(this._hashName){let p;return l.split("&").map(g=>g.split("=")).forEach(g=>{g[0]===this._hashName&&(p=g)}),(p&&p[1]||"").split("/")}return l.split("/")},this._onHashChange=()=>{const l=this._getCurrentHash();if(!this._isValidHash(l))return!1;const p=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(l[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+l[2],+l[1]],zoom:+l[0],bearing:p,pitch:+(l[4]||0)}),!0},this._updateHashUnthrottled=()=>{const l=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,l)},this._removeHash=()=>{const l=this._getCurrentHash();if(l.length===0)return;const p=l.join("/");let g=p;g.split("&").length>0&&(g=g.split("&")[0]),this._hashName&&(g=`${this._hashName}=${p}`);let x=window.location.hash.replace(g,"");x.startsWith("#&")?x=x.slice(0,1)+x.slice(2):x==="#"&&(x="");let w=window.location.href.replace(/(#.+)?$/,x);w=w.replace("&&","&"),window.history.replaceState(window.history.state,null,w)},this._updateHash=tu(this._updateHashUnthrottled,300),this._hashName=n&&encodeURIComponent(n)}addTo(n){return this._map=n,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(n){const l=this._map.getCenter(),p=Math.round(100*this._map.getZoom())/100,g=Math.ceil((p*Math.LN2+Math.log(512/360/.5))/Math.LN10),x=Math.pow(10,g),w=Math.round(l.lng*x)/x,P=Math.round(l.lat*x)/x,I=this._map.getBearing(),R=this._map.getPitch();let O="";if(O+=n?`/${w}/${P}/${p}`:`${p}/${P}/${w}`,(I||R)&&(O+="/"+Math.round(10*I)/10),R&&(O+=`/${Math.round(R)}`),this._hashName){const N=this._hashName;let B=!1;const W=window.location.hash.slice(1).split("&").map(X=>{const te=X.split("=")[0];return te===N?(B=!0,`${te}=${O}`):X}).filter(X=>X);return B||W.push(`${N}=${O}`),`#${W.join("&")}`}return`#${O}`}_isValidHash(n){if(n.length<3||n.some(isNaN))return!1;try{new a.Q(+n[2],+n[1])}catch{return!1}const l=+n[0],p=+(n[3]||0),g=+(n[4]||0);return l>=this._map.getMinZoom()&&l<=this._map.getMaxZoom()&&p>=-180&&p<=180&&g>=this._map.getMinPitch()&&g<=this._map.getMaxPitch()}}const Eo={linearity:.3,easing:a.c9(0,0,.3,1)},Bs=a.e({deceleration:2500,maxSpeed:1400},Eo),hf=a.e({deceleration:20,maxSpeed:1400},Eo),ff=a.e({deceleration:1e3,maxSpeed:360},Eo),df=a.e({deceleration:1e3,maxSpeed:90},Eo),pf=a.e({deceleration:1e3,maxSpeed:360},Eo);class gf{constructor(n){this._map=n,this.clear()}clear(){this._inertiaBuffer=[]}record(n){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:F.now(),settings:n})}_drainInertiaBuffer(){const n=this._inertiaBuffer,l=F.now();for(;n.length>0&&l-n[0].time>160;)n.shift()}_onMoveEnd(n){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const l={zoom:0,bearing:0,pitch:0,roll:0,pan:new a.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:x}of this._inertiaBuffer)l.zoom+=x.zoomDelta||0,l.bearing+=x.bearingDelta||0,l.pitch+=x.pitchDelta||0,l.roll+=x.rollDelta||0,x.panDelta&&l.pan._add(x.panDelta),x.around&&(l.around=x.around),x.pinchAround&&(l.pinchAround=x.pinchAround);const p=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(l.pan.mag()){const x=Co(l.pan.mag(),p,a.e({},Bs,n||{})),w=l.pan.mult(x.amount/l.pan.mag()),P=this._map.cameraHelper.handlePanInertia(w,this._map.transform);g.center=P.easingCenter,g.offset=P.easingOffset,Io(g,x)}if(l.zoom){const x=Co(l.zoom,p,hf);g.zoom=this._map.transform.zoom+x.amount,Io(g,x)}if(l.bearing){const x=Co(l.bearing,p,ff);g.bearing=this._map.transform.bearing+a.ae(x.amount,-179,179),Io(g,x)}if(l.pitch){const x=Co(l.pitch,p,df);g.pitch=this._map.transform.pitch+x.amount,Io(g,x)}if(l.roll){const x=Co(l.roll,p,pf);g.roll=this._map.transform.roll+a.ae(x.amount,-179,179),Io(g,x)}if(g.zoom||g.bearing){const x=l.pinchAround===void 0?l.around:l.pinchAround;g.around=x?this._map.unproject(x):this._map.getCenter()}return this.clear(),a.e(g,{noMoveStart:!0})}}function Io(_,n){(!_.duration||_.duration<n.duration)&&(_.duration=n.duration,_.easing=n.easing)}function Co(_,n,l){const{maxSpeed:p,linearity:g,deceleration:x}=l,w=a.ae(_*g/(n/1e3),-p,p),P=Math.abs(w)/(x*g);return{easing:l.easing,duration:1e3*P,amount:w*(P/2)}}class _r extends a.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,l,p,g={}){p=p instanceof MouseEvent?p:new MouseEvent(n,p);const x=L.mousePos(l.getCanvas(),p),w=l.unproject(x);super(n,a.e({point:x,lngLat:w,originalEvent:p},g)),this._defaultPrevented=!1,this.target=l}}class Mo extends a.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,l,p){const g=n==="touchend"?p.changedTouches:p.touches,x=L.touchPos(l.getCanvasContainer(),g),w=x.map(I=>l.unproject(I)),P=x.reduce((I,R,O,N)=>I.add(R.div(N.length)),new a.P(0,0));super(n,{points:x,point:P,lngLats:w,lngLat:l.unproject(P),originalEvent:p}),this._defaultPrevented=!1}}class Gr extends a.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,l,p){super(n,{originalEvent:p}),this._defaultPrevented=!1}}class _n{constructor(n,l){this._map=n,this._clickTolerance=l.clickTolerance}reset(){delete this._mousedownPos}wheel(n){return this._firePreventable(new Gr(n.type,this._map,n))}mousedown(n,l){return this._mousedownPos=l,this._firePreventable(new _r(n.type,this._map,n))}mouseup(n){this._map.fire(new _r(n.type,this._map,n))}click(n,l){this._mousedownPos&&this._mousedownPos.dist(l)>=this._clickTolerance||this._map.fire(new _r(n.type,this._map,n))}dblclick(n){return this._firePreventable(new _r(n.type,this._map,n))}mouseover(n){this._map.fire(new _r(n.type,this._map,n))}mouseout(n){this._map.fire(new _r(n.type,this._map,n))}touchstart(n){return this._firePreventable(new Mo(n.type,this._map,n))}touchmove(n){this._map.fire(new Mo(n.type,this._map,n))}touchend(n){this._map.fire(new Mo(n.type,this._map,n))}touchcancel(n){this._map.fire(new Mo(n.type,this._map,n))}_firePreventable(n){if(this._map.fire(n),n.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class mf{constructor(n){this._map=n}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(n){this._map.fire(new _r(n.type,this._map,n))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new _r("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(n){this._delayContextMenu?this._contextMenuEvent=n:this._ignoreContextMenu||this._map.fire(new _r(n.type,this._map,n)),this._map.listens("contextmenu")&&n.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Rr{constructor(n){this._map=n}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(n){return this.transform.screenPointToLocation(a.P.convert(n),this._map.terrain)}}class Ns{constructor(n,l){this._map=n,this._tr=new Rr(n),this._el=n.getCanvasContainer(),this._container=n.getContainer(),this._clickTolerance=l.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(n,l){this.isEnabled()&&n.shiftKey&&n.button===0&&(L.disableDrag(),this._startPos=this._lastPos=l,this._active=!0)}mousemoveWindow(n,l){if(!this._active)return;const p=l;if(this._lastPos.equals(p)||!this._box&&p.dist(this._startPos)<this._clickTolerance)return;const g=this._startPos;this._lastPos=p,this._box||(this._box=L.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",n));const x=Math.min(g.x,p.x),w=Math.max(g.x,p.x),P=Math.min(g.y,p.y),I=Math.max(g.y,p.y);L.setTransform(this._box,`translate(${x}px,${P}px)`),this._box.style.width=w-x+"px",this._box.style.height=I-P+"px"}mouseupWindow(n,l){if(!this._active||n.button!==0)return;const p=this._startPos,g=l;if(this.reset(),L.suppressClick(),p.x!==g.x||p.y!==g.y)return this._map.fire(new a.l("boxzoomend",{originalEvent:n})),{cameraAnimation:x=>x.fitScreenCoordinates(p,g,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",n)}keydown(n){this._active&&n.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",n))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(L.remove(this._box),this._box=null),L.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(n,l){return this._map.fire(new a.l(n,{originalEvent:l}))}}function ru(_,n){if(_.length!==n.length)throw new Error(`The number of touches and points are not equal - touches ${_.length}, points ${n.length}`);const l={};for(let p=0;p<_.length;p++)l[_[p].identifier]=n[p];return l}class ig{constructor(n){this.reset(),this.numTouches=n.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(n,l,p){(this.centroid||p.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=n.timeStamp),p.length===this.numTouches&&(this.centroid=function(g){const x=new a.P(0,0);for(const w of g)x._add(w);return x.div(g.length)}(l),this.touches=ru(p,l)))}touchmove(n,l,p){if(this.aborted||!this.centroid)return;const g=ru(p,l);for(const x in this.touches){const w=g[x];(!w||w.dist(this.touches[x])>30)&&(this.aborted=!0)}}touchend(n,l,p){if((!this.centroid||n.timeStamp-this.startTime>500)&&(this.aborted=!0),p.length===0){const g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class nu{constructor(n){this.singleTap=new ig(n),this.numTaps=n.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(n,l,p){this.singleTap.touchstart(n,l,p)}touchmove(n,l,p){this.singleTap.touchmove(n,l,p)}touchend(n,l,p){const g=this.singleTap.touchend(n,l,p);if(g){const x=n.timeStamp-this.lastTime<500,w=!this.lastTap||this.lastTap.dist(g)<30;if(x&&w||this.reset(),this.count++,this.lastTime=n.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class rg{constructor(n){this._tr=new Rr(n),this._zoomIn=new nu({numTouches:1,numTaps:2}),this._zoomOut=new nu({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(n,l,p){this._zoomIn.touchstart(n,l,p),this._zoomOut.touchstart(n,l,p)}touchmove(n,l,p){this._zoomIn.touchmove(n,l,p),this._zoomOut.touchmove(n,l,p)}touchend(n,l,p){const g=this._zoomIn.touchend(n,l,p),x=this._zoomOut.touchend(n,l,p),w=this._tr;return g?(this._active=!0,n.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:P=>P.easeTo({duration:300,zoom:w.zoom+1,around:w.unproject(g)},{originalEvent:n})}):x?(this._active=!0,n.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:P=>P.easeTo({duration:300,zoom:w.zoom-1,around:w.unproject(x)},{originalEvent:n})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ro{constructor(n){this._enabled=!!n.enable,this._moveStateManager=n.moveStateManager,this._clickTolerance=n.clickTolerance||1,this._moveFunction=n.move,this._activateOnStart=!!n.activateOnStart,n.assignEvents(this),this.reset()}reset(n){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(n)}_move(...n){const l=this._moveFunction(...n);if(l.bearingDelta||l.pitchDelta||l.rollDelta||l.around||l.panDelta)return this._active=!0,l}dragStart(n,l){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(n)&&(this._moveStateManager.startMove(n),this._lastPoint=Array.isArray(l)?l[0]:l,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(n,l){if(!this.isEnabled())return;const p=this._lastPoint;if(!p)return;if(n.preventDefault(),!this._moveStateManager.isValidMoveEvent(n))return void this.reset(n);const g=Array.isArray(l)?l[0]:l;return!this._moved&&g.dist(p)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=g,this._move(p,g))}dragEnd(n){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(n)&&(this._moved&&L.suppressClick(),this.reset(n))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const va={0:1,2:2};class zr{constructor(n){this._correctEvent=n.checkCorrectEvent}startMove(n){const l=L.mouseButton(n);this._eventButton=l}endMove(n){delete this._eventButton}isValidStartEvent(n){return this._correctEvent(n)}isValidMoveEvent(n){return!function(l,p){const g=va[p];return l.buttons===void 0||(l.buttons&g)!==g}(n,this._eventButton)}isValidEndEvent(n){return L.mouseButton(n)===this._eventButton}}class mt{constructor(){this._firstTouch=void 0}_isOneFingerTouch(n){return n.targetTouches.length===1}_isSameTouchEvent(n){return n.targetTouches[0].identifier===this._firstTouch}startMove(n){this._firstTouch=n.targetTouches[0].identifier}endMove(n){delete this._firstTouch}isValidStartEvent(n){return this._isOneFingerTouch(n)}isValidMoveEvent(n){return this._isOneFingerTouch(n)&&this._isSameTouchEvent(n)}isValidEndEvent(n){return this._isOneFingerTouch(n)&&this._isSameTouchEvent(n)}}class _f{constructor(n=new zr({checkCorrectEvent:()=>!0}),l=new mt){this.mouseMoveStateManager=n,this.oneFingerTouchMoveStateManager=l}_executeRelevantHandler(n,l,p){return n instanceof MouseEvent?l(n):typeof TouchEvent<"u"&&n instanceof TouchEvent?p(n):void 0}startMove(n){this._executeRelevantHandler(n,l=>this.mouseMoveStateManager.startMove(l),l=>this.oneFingerTouchMoveStateManager.startMove(l))}endMove(n){this._executeRelevantHandler(n,l=>this.mouseMoveStateManager.endMove(l),l=>this.oneFingerTouchMoveStateManager.endMove(l))}isValidStartEvent(n){return this._executeRelevantHandler(n,l=>this.mouseMoveStateManager.isValidStartEvent(l),l=>this.oneFingerTouchMoveStateManager.isValidStartEvent(l))}isValidMoveEvent(n){return this._executeRelevantHandler(n,l=>this.mouseMoveStateManager.isValidMoveEvent(l),l=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(l))}isValidEndEvent(n){return this._executeRelevantHandler(n,l=>this.mouseMoveStateManager.isValidEndEvent(l),l=>this.oneFingerTouchMoveStateManager.isValidEndEvent(l))}}const ko=_=>{_.mousedown=_.dragStart,_.mousemoveWindow=_.dragMove,_.mouseup=_.dragEnd,_.contextmenu=n=>{n.preventDefault()}};class yf{constructor(n,l){this._clickTolerance=n.clickTolerance||1,this._map=l,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new a.P(0,0)}_shouldBePrevented(n){return n<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(n,l,p){return this._calculateTransform(n,l,p)}touchmove(n,l,p){if(this._active){if(!this._shouldBePrevented(p.length))return n.preventDefault(),this._calculateTransform(n,l,p);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",n)}}touchend(n,l,p){this._calculateTransform(n,l,p),this._active&&this._shouldBePrevented(p.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(n,l,p){p.length>0&&(this._active=!0);const g=ru(p,l),x=new a.P(0,0),w=new a.P(0,0);let P=0;for(const R in g){const O=g[R],N=this._touches[R];N&&(x._add(O),w._add(O.sub(N)),P++,g[R]=O)}if(this._touches=g,this._shouldBePrevented(P)||!w.mag())return;const I=w.div(P);return this._sum._add(I),this._sum.mag()<this._clickTolerance?void 0:{around:x.div(P),panDelta:I}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class zs{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(n,l,p){this._firstTwoTouches||p.length<2||(this._firstTwoTouches=[p[0].identifier,p[1].identifier],this._start([l[0],l[1]]))}touchmove(n,l,p){if(!this._firstTwoTouches)return;n.preventDefault();const[g,x]=this._firstTwoTouches,w=as(p,l,g),P=as(p,l,x);if(!w||!P)return;const I=this._aroundCenter?null:w.add(P).div(2);return this._move([w,P],I,n)}touchend(n,l,p){if(!this._firstTwoTouches)return;const[g,x]=this._firstTwoTouches,w=as(p,l,g),P=as(p,l,x);w&&P||(this._active&&L.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(n){this._enabled=!0,this._aroundCenter=!!n&&n.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function as(_,n,l){for(let p=0;p<_.length;p++)if(_[p].identifier===l)return n[p]}function su(_,n){return Math.log(_/n)/Math.LN2}class Ht extends zs{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(n){this._startDistance=this._distance=n[0].dist(n[1])}_move(n,l){const p=this._distance;if(this._distance=n[0].dist(n[1]),this._active||!(Math.abs(su(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:su(this._distance,p),pinchAround:l}}}function El(_,n){return 180*_.angleWith(n)/Math.PI}class xf extends zs{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(n){this._startVector=this._vector=n[0].sub(n[1]),this._minDiameter=n[0].dist(n[1])}_move(n,l,p){const g=this._vector;if(this._vector=n[0].sub(n[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:El(this._vector,g),pinchAround:l}}_isBelowThreshold(n){this._minDiameter=Math.min(this._minDiameter,n.mag());const l=25/(Math.PI*this._minDiameter)*360,p=El(n,this._startVector);return Math.abs(p)<l}}function ba(_){return Math.abs(_.y)>Math.abs(_.x)}class vf extends zs{constructor(n){super(),this._currentTouchCount=0,this._map=n}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(n,l,p){super.touchstart(n,l,p),this._currentTouchCount=p.length}_start(n){this._lastPoints=n,ba(n[0].sub(n[1]))&&(this._valid=!1)}_move(n,l,p){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const g=n[0].sub(this._lastPoints[0]),x=n[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(g,x,p.timeStamp),this._valid?(this._lastPoints=n,this._active=!0,{pitchDelta:(g.y+x.y)/2*-.5}):void 0}gestureBeginsVertically(n,l,p){if(this._valid!==void 0)return this._valid;const g=n.mag()>=2,x=l.mag()>=2;if(!g&&!x)return;if(!g||!x)return this._firstMove===void 0&&(this._firstMove=p),p-this._firstMove<100&&void 0;const w=n.y>0==l.y>0;return ba(n)&&ba(l)&&w}}const ng={panStep:100,bearingStep:15,pitchStep:10};class ou{constructor(n){this._tr=new Rr(n);const l=ng;this._panStep=l.panStep,this._bearingStep=l.bearingStep,this._pitchStep=l.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(n){if(n.altKey||n.ctrlKey||n.metaKey)return;let l=0,p=0,g=0,x=0,w=0;switch(n.keyCode){case 61:case 107:case 171:case 187:l=1;break;case 189:case 109:case 173:l=-1;break;case 37:n.shiftKey?p=-1:(n.preventDefault(),x=-1);break;case 39:n.shiftKey?p=1:(n.preventDefault(),x=1);break;case 38:n.shiftKey?g=1:(n.preventDefault(),w=-1);break;case 40:n.shiftKey?g=-1:(n.preventDefault(),w=1);break;default:return}return this._rotationDisabled&&(p=0,g=0),{cameraAnimation:P=>{const I=this._tr;P.easeTo({duration:300,easeId:"keyboardHandler",easing:au,zoom:l?Math.round(I.zoom)+l*(n.shiftKey?2:1):I.zoom,bearing:I.bearing+p*this._bearingStep,pitch:I.pitch+g*this._pitchStep,offset:[-x*this._panStep,-w*this._panStep],center:I.center},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function au(_){return _*(2-_)}const lu=4.000244140625;class bf{constructor(n,l){this._onTimeout=p=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(p)},this._map=n,this._tr=new Rr(n),this._triggerRenderFrame=l,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(n){this._defaultZoomRate=n}setWheelZoomRate(n){this._wheelZoomRate=n}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(n){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!n&&n.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(n){return!!this._map.cooperativeGestures.isEnabled()&&!(n.ctrlKey||this._map.cooperativeGestures.isBypassed(n))}wheel(n){if(!this.isEnabled())return;if(this._shouldBePrevented(n))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",n);let l=n.deltaMode===WheelEvent.DOM_DELTA_LINE?40*n.deltaY:n.deltaY;const p=F.now(),g=p-(this._lastWheelEventTime||0);this._lastWheelEventTime=p,l!==0&&l%lu==0?this._type="wheel":l!==0&&Math.abs(l)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=l,this._timeout=setTimeout(this._onTimeout,40,n)):this._type||(this._type=Math.abs(g*l)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,l+=this._lastValue)),n.shiftKey&&l&&(l/=4),this._type&&(this._lastWheelEvent=n,this._delta-=l,this._active||this._start(n)),n.preventDefault()}_start(n){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const l=L.mousePos(this._map.getCanvas(),n),p=this._tr;this._aroundPoint=this._aroundCenter?p.transform.locationToScreenPoint(a.Q.convert(p.center)):l,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const n=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const P=n.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=P),typeof this._targetZoom=="number"&&(this._targetZoom+=P)}if(this._delta!==0){const P=this._type==="wheel"&&Math.abs(this._delta)>lu?this._wheelZoomRate:this._defaultZoomRate;let I=2/(1+Math.exp(-Math.abs(this._delta*P)));this._delta<0&&I!==0&&(I=1/I);const R=typeof this._targetZoom!="number"?n.scale:a.aI(this._targetZoom);this._targetZoom=Math.min(n.maxZoom,Math.max(n.minZoom,a.ab(R*I))),this._type==="wheel"&&(this._startZoom=n.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const l=typeof this._targetZoom!="number"?n.zoom:this._targetZoom,p=this._startZoom,g=this._easing;let x,w=!1;if(this._type==="wheel"&&p&&g){const P=F.now()-this._lastWheelEventTime,I=Math.min((P+5)/200,1),R=g(I);x=a.B.number(p,l,R),I<1?this._frameId||(this._frameId=!0):w=!0}else x=l,w=!0;return this._active=!0,w&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout},200)),this._lastExpectedZoom=x,{noInertia:!0,needsRenderFrame:!w,zoomDelta:x-n.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(n){let l=a.cb;if(this._prevEase){const p=this._prevEase,g=(F.now()-p.start)/p.duration,x=p.easing(g+.01)-p.easing(g),w=.27/Math.sqrt(x*x+1e-4)*.01,P=Math.sqrt(.0729-w*w);l=a.c9(w,P,.25,1)}return this._prevEase={start:F.now(),duration:n,easing:l},l}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class cu{constructor(n,l){this._clickZoom=n,this._tapZoom=l}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class sg{constructor(n){this._tr=new Rr(n),this.reset()}reset(){this._active=!1}dblclick(n,l){return n.preventDefault(),{cameraAnimation:p=>{p.easeTo({duration:300,zoom:this._tr.zoom+(n.shiftKey?-1:1),around:this._tr.unproject(l)},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class og{constructor(){this._tap=new nu({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(n,l,p){if(!this._swipePoint)if(this._tapTime){const g=l[0],x=n.timeStamp-this._tapTime<500,w=this._tapPoint.dist(g)<30;x&&w?p.length>0&&(this._swipePoint=g,this._swipeTouch=p[0].identifier):this.reset()}else this._tap.touchstart(n,l,p)}touchmove(n,l,p){if(this._tapTime){if(this._swipePoint){if(p[0].identifier!==this._swipeTouch)return;const g=l[0],x=g.y-this._swipePoint.y;return this._swipePoint=g,n.preventDefault(),this._active=!0,{zoomDelta:x/128}}}else this._tap.touchmove(n,l,p)}touchend(n,l,p){if(this._tapTime)this._swipePoint&&p.length===0&&this.reset();else{const g=this._tap.touchend(n,l,p);g&&(this._tapTime=n.timeStamp,this._tapPoint=g)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ln{constructor(n,l,p){this._el=n,this._mousePan=l,this._touchPan=p}enable(n){this._inertiaOptions=n||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class yi{constructor(n,l,p,g){this._pitchWithRotate=n.pitchWithRotate,this._rollEnabled=n.rollEnabled,this._mouseRotate=l,this._mousePitch=p,this._mouseRoll=g}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class wa{constructor(n,l,p,g){this._el=n,this._touchZoom=l,this._touchRotate=p,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(n){this._touchZoom.enable(n),this._rotationDisabled||this._touchRotate.enable(n),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class Il{constructor(n,l){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=n,this._options=l,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const n=this._map.getCanvasContainer();n.classList.add("maplibregl-cooperative-gestures"),this._container=L.create("div","maplibregl-cooperative-gesture-screen",n);let l=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(l=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const p=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),g=document.createElement("div");g.className="maplibregl-desktop-message",g.textContent=l,this._container.appendChild(g);const x=document.createElement("div");x.className="maplibregl-mobile-message",x.textContent=p,this._container.appendChild(x),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(L.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(n){return n[this._bypassKey]}notifyGestureBlocked(n,l){this._enabled&&(this._map.fire(new a.l("cooperativegestureprevented",{gestureType:n,originalEvent:l})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const Ta=_=>_.zoom||_.drag||_.roll||_.pitch||_.rotate;class wf extends a.l{}function Cl(_){return _.panDelta&&_.panDelta.mag()||_.zoomDelta||_.bearingDelta||_.pitchDelta||_.rollDelta}class ag{constructor(n,l){this.handleWindowEvent=g=>{this.handleEvent(g,`${g.type}Window`)},this.handleEvent=(g,x)=>{if(g.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const w=g.type==="renderFrame"?void 0:g,P={needsRenderFrame:!1},I={},R={};for(const{handlerName:B,handler:W,allowed:X}of this._handlers){if(!W.isEnabled())continue;let te;if(this._blockedByActive(R,X,B))W.reset();else if(W[x||g.type]){if(a.cc(g,x||g.type)){const Q=L.mousePos(this._map.getCanvas(),g);te=W[x||g.type](g,Q)}else if(a.cd(g,x||g.type)){const Q=this._getMapTouches(g.touches),ie=L.touchPos(this._map.getCanvas(),Q);te=W[x||g.type](g,ie,Q)}else a.ce(x||g.type)||(te=W[x||g.type](g));this.mergeHandlerResult(P,I,te,B,w),te&&te.needsRenderFrame&&this._triggerRenderFrame()}(te||W.isActive())&&(R[B]=W)}const O={};for(const B in this._previousActiveHandlers)R[B]||(O[B]=w);this._previousActiveHandlers=R,(Object.keys(O).length||Cl(P))&&(this._changes.push([P,I,O]),this._triggerRenderFrame()),(Object.keys(R).length||Cl(P))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:N}=P;N&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],N(this._map))},this._map=n,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new gf(n),this._bearingSnap=l.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(l);const p=this._el;this._listeners=[[p,"touchstart",{passive:!0}],[p,"touchmove",{passive:!1}],[p,"touchend",void 0],[p,"touchcancel",void 0],[p,"mousedown",void 0],[p,"mousemove",void 0],[p,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[p,"mouseover",void 0],[p,"mouseout",void 0],[p,"dblclick",void 0],[p,"click",void 0],[p,"keydown",{capture:!1}],[p,"keyup",void 0],[p,"wheel",{passive:!1}],[p,"contextmenu",void 0],[window,"blur",void 0]];for(const[g,x,w]of this._listeners)L.addEventListener(g,x,g===document?this.handleWindowEvent:this.handleEvent,w)}destroy(){for(const[n,l,p]of this._listeners)L.removeEventListener(n,l,n===document?this.handleWindowEvent:this.handleEvent,p)}_addDefaultHandlers(n){const l=this._map,p=l.getCanvasContainer();this._add("mapEvent",new _n(l,n));const g=l.boxZoom=new Ns(l,n);this._add("boxZoom",g),n.interactive&&n.boxZoom&&g.enable();const x=l.cooperativeGestures=new Il(l,n.cooperativeGestures);this._add("cooperativeGestures",x),n.cooperativeGestures&&x.enable();const w=new rg(l),P=new sg(l);l.doubleClickZoom=new cu(P,w),this._add("tapZoom",w),this._add("clickZoom",P),n.interactive&&n.doubleClickZoom&&l.doubleClickZoom.enable();const I=new og;this._add("tapDragZoom",I);const R=l.touchPitch=new vf(l);this._add("touchPitch",R),n.interactive&&n.touchPitch&&l.touchPitch.enable(n.touchPitch);const O=()=>l.project(l.getCenter()),N=function({enable:fe,clickTolerance:de,aroundCenter:ve=!0,minPixelCenterThreshold:ge=100,rotateDegreesPerPixelMoved:De=.8},ke){const We=new zr({checkCorrectEvent:Ze=>L.mouseButton(Ze)===0&&Ze.ctrlKey||L.mouseButton(Ze)===2&&!Ze.ctrlKey});return new Ro({clickTolerance:de,move:(Ze,je)=>{const lt=ke();if(ve&&Math.abs(lt.y-Ze.y)>ge)return{bearingDelta:a.ca(new a.P(Ze.x,je.y),je,lt)};let at=(je.x-Ze.x)*De;return ve&&je.y<lt.y&&(at=-at),{bearingDelta:at}},moveStateManager:We,enable:fe,assignEvents:ko})}(n,O),B=function({enable:fe,clickTolerance:de,pitchDegreesPerPixelMoved:ve=-.5}){const ge=new zr({checkCorrectEvent:De=>L.mouseButton(De)===0&&De.ctrlKey||L.mouseButton(De)===2});return new Ro({clickTolerance:de,move:(De,ke)=>({pitchDelta:(ke.y-De.y)*ve}),moveStateManager:ge,enable:fe,assignEvents:ko})}(n),W=function({enable:fe,clickTolerance:de,rollDegreesPerPixelMoved:ve=.3},ge){const De=new zr({checkCorrectEvent:ke=>L.mouseButton(ke)===2&&ke.ctrlKey});return new Ro({clickTolerance:de,move:(ke,We)=>{const Ze=ge();let je=(We.x-ke.x)*ve;return We.y<Ze.y&&(je=-je),{rollDelta:je}},moveStateManager:De,enable:fe,assignEvents:ko})}(n,O);l.dragRotate=new yi(n,N,B,W),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",B,["mouseRotate","mouseRoll"]),this._add("mouseRoll",W,["mousePitch"]),n.interactive&&n.dragRotate&&l.dragRotate.enable();const X=function({enable:fe,clickTolerance:de}){const ve=new zr({checkCorrectEvent:ge=>L.mouseButton(ge)===0&&!ge.ctrlKey});return new Ro({clickTolerance:de,move:(ge,De)=>({around:De,panDelta:De.sub(ge)}),activateOnStart:!0,moveStateManager:ve,enable:fe,assignEvents:ko})}(n),te=new yf(n,l);l.dragPan=new Ln(p,X,te),this._add("mousePan",X),this._add("touchPan",te,["touchZoom","touchRotate"]),n.interactive&&n.dragPan&&l.dragPan.enable(n.dragPan);const Q=new xf,ie=new Ht;l.touchZoomRotate=new wa(p,ie,Q,I),this._add("touchRotate",Q,["touchPan","touchZoom"]),this._add("touchZoom",ie,["touchPan","touchRotate"]),n.interactive&&n.touchZoomRotate&&l.touchZoomRotate.enable(n.touchZoomRotate);const se=l.scrollZoom=new bf(l,()=>this._triggerRenderFrame());this._add("scrollZoom",se,["mousePan"]),n.interactive&&n.scrollZoom&&l.scrollZoom.enable(n.scrollZoom);const ue=l.keyboard=new ou(l);this._add("keyboard",ue),n.interactive&&n.keyboard&&l.keyboard.enable(),this._add("blockableMapEvent",new mf(l))}_add(n,l,p){this._handlers.push({handlerName:n,handler:l,allowed:p}),this._handlersById[n]=l}stop(n){if(!this._updatingCamera){for(const{handler:l}of this._handlers)l.reset();this._inertia.clear(),this._fireEvents({},{},n),this._changes=[]}}isActive(){for(const{handler:n}of this._handlers)if(n.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Ta(this._eventsInProgress)||this.isZooming()}_blockedByActive(n,l,p){for(const g in n)if(g!==p&&(!l||l.indexOf(g)<0))return!0;return!1}_getMapTouches(n){const l=[];for(const p of n)this._el.contains(p.target)&&l.push(p);return l}mergeHandlerResult(n,l,p,g,x){if(!p)return;a.e(n,p);const w={handlerName:g,originalEvent:p.originalEvent||x};p.zoomDelta!==void 0&&(l.zoom=w),p.panDelta!==void 0&&(l.drag=w),p.rollDelta!==void 0&&(l.roll=w),p.pitchDelta!==void 0&&(l.pitch=w),p.bearingDelta!==void 0&&(l.rotate=w)}_applyChanges(){const n={},l={},p={};for(const[g,x,w]of this._changes)g.panDelta&&(n.panDelta=(n.panDelta||new a.P(0,0))._add(g.panDelta)),g.zoomDelta&&(n.zoomDelta=(n.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(n.bearingDelta=(n.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(n.pitchDelta=(n.pitchDelta||0)+g.pitchDelta),g.rollDelta&&(n.rollDelta=(n.rollDelta||0)+g.rollDelta),g.around!==void 0&&(n.around=g.around),g.pinchAround!==void 0&&(n.pinchAround=g.pinchAround),g.noInertia&&(n.noInertia=g.noInertia),a.e(l,x),a.e(p,w);this._updateMapTransform(n,l,p),this._changes=[]}_updateMapTransform(n,l,p){const g=this._map,x=g._getTransformForUpdate(),w=g.terrain;if(!(Cl(n)||w&&this._terrainMovement))return this._fireEvents(l,p,!0);g._stop(!0);let{panDelta:P,zoomDelta:I,bearingDelta:R,pitchDelta:O,rollDelta:N,around:B,pinchAround:W}=n;W!==void 0&&(B=W),B=B||g.transform.centerPoint,w&&!x.isPointOnMapSurface(B)&&(B=x.centerPoint);const X={panDelta:P,zoomDelta:I,rollDelta:N,pitchDelta:O,bearingDelta:R,around:B};this._map.cameraHelper.useGlobeControls&&!x.isPointOnMapSurface(B)&&(B=x.centerPoint);const te=B.distSqr(x.centerPoint)<.01?x.center:x.screenPointToLocation(P?B.sub(P):B);w?(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(X,x),this._terrainMovement||!l.drag&&!l.zoom?l.drag&&this._terrainMovement?x.setCenter(x.screenPointToLocation(x.centerPoint.sub(P))):this._map.cameraHelper.handleMapControlsPan(X,x,te):(this._terrainMovement=!0,this._map._elevationFreeze=!0,this._map.cameraHelper.handleMapControlsPan(X,x,te))):(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(X,x),this._map.cameraHelper.handleMapControlsPan(X,x,te)),g._applyUpdatedTransform(x),this._map._update(),n.noInertia||this._inertia.record(n),this._fireEvents(l,p,!0)}_fireEvents(n,l,p){const g=Ta(this._eventsInProgress),x=Ta(n),w={};for(const N in n){const{originalEvent:B}=n[N];this._eventsInProgress[N]||(w[`${N}start`]=B),this._eventsInProgress[N]=n[N]}!g&&x&&this._fireEvent("movestart",x.originalEvent);for(const N in w)this._fireEvent(N,w[N]);x&&this._fireEvent("move",x.originalEvent);for(const N in n){const{originalEvent:B}=n[N];this._fireEvent(N,B)}const P={};let I;for(const N in this._eventsInProgress){const{handlerName:B,originalEvent:W}=this._eventsInProgress[N];this._handlersById[B].isActive()||(delete this._eventsInProgress[N],I=l[B]||W,P[`${N}end`]=I)}for(const N in P)this._fireEvent(N,P[N]);const R=Ta(this._eventsInProgress),O=(g||x)&&!R;if(O&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const N=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&N.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(N)}if(p&&O){this._updatingCamera=!0;const N=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),B=W=>W!==0&&-this._bearingSnap<W&&W<this._bearingSnap;!N||!N.essential&&F.prefersReducedMotion?(this._map.fire(new a.l("moveend",{originalEvent:I})),B(this._map.getBearing())&&this._map.resetNorth()):(B(N.bearing||this._map.getBearing())&&(N.bearing=0),N.freezeElevation=!0,this._map.easeTo(N,{originalEvent:I})),this._updatingCamera=!1}}_fireEvent(n,l){this._map.fire(new a.l(n,l?{originalEvent:l}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(n=>{delete this._frameId,this.handleEvent(new wf("renderFrame",{timeStamp:n})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class yn extends a.E{constructor(n,l,p){super(),this._renderFrameCallback=()=>{const g=Math.min((F.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(g)),g<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=n,this._bearingSnap=p.bearingSnap,this.cameraHelper=l,this.on("moveend",()=>{delete this._requestedCameraState})}migrateProjection(n,l){n.apply(this.transform),this.transform=n,this.cameraHelper=l}getCenter(){return new a.Q(this.transform.center.lng,this.transform.center.lat)}setCenter(n,l){return this.jumpTo({center:n},l)}getCenterElevation(){return this.transform.elevation}setCenterElevation(n,l){return this.jumpTo({elevation:n},l),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(n){this._centerClampedToGround=n}panBy(n,l,p){return n=a.P.convert(n).mult(-1),this.panTo(this.transform.center,a.e({offset:n},l),p)}panTo(n,l,p){return this.easeTo(a.e({center:n},l),p)}getZoom(){return this.transform.zoom}setZoom(n,l){return this.jumpTo({zoom:n},l),this}zoomTo(n,l,p){return this.easeTo(a.e({zoom:n},l),p)}zoomIn(n,l){return this.zoomTo(this.getZoom()+1,n,l),this}zoomOut(n,l){return this.zoomTo(this.getZoom()-1,n,l),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(n,l){return n!=this.transform.fov&&(this.transform.setFov(n),this.fire(new a.l("movestart",l)).fire(new a.l("move",l)).fire(new a.l("moveend",l))),this}getBearing(){return this.transform.bearing}setBearing(n,l){return this.jumpTo({bearing:n},l),this}getPadding(){return this.transform.padding}setPadding(n,l){return this.jumpTo({padding:n},l),this}rotateTo(n,l,p){return this.easeTo(a.e({bearing:n},l),p)}resetNorth(n,l){return this.rotateTo(0,a.e({duration:1e3},n),l),this}resetNorthPitch(n,l){return this.easeTo(a.e({bearing:0,pitch:0,roll:0,duration:1e3},n),l),this}snapToNorth(n,l){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(n,l):this}getPitch(){return this.transform.pitch}setPitch(n,l){return this.jumpTo({pitch:n},l),this}getRoll(){return this.transform.roll}setRoll(n,l){return this.jumpTo({roll:n},l),this}cameraForBounds(n,l){n=Si.convert(n).adjustAntiMeridian();const p=l&&l.bearing||0;return this._cameraForBoxAndBearing(n.getNorthWest(),n.getSouthEast(),p,l)}_cameraForBoxAndBearing(n,l,p,g){const x={top:0,bottom:0,right:0,left:0};if(typeof(g=a.e({padding:x,offset:[0,0],maxZoom:this.transform.maxZoom},g)).padding=="number"){const R=g.padding;g.padding={top:R,bottom:R,right:R,left:R}}const w=a.e(x,g.padding);g.padding=w;const P=this.transform,I=new Si(n,l);return this.cameraHelper.cameraForBoxAndBearing(g,w,I,p,P)}fitBounds(n,l,p){return this._fitInternal(this.cameraForBounds(n,l),l,p)}fitScreenCoordinates(n,l,p,g,x){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(a.P.convert(n)),this.transform.screenPointToLocation(a.P.convert(l)),p,g),g,x)}_fitInternal(n,l,p){return n?(delete(l=a.e(n,l)).padding,l.linear?this.easeTo(l,p):this.flyTo(l,p)):this}jumpTo(n,l){this.stop();const p=this._getTransformForUpdate();let g=!1,x=!1,w=!1;const P=p.zoom;this.cameraHelper.handleJumpToCenterZoom(p,n);const I=p.zoom!==P;return"elevation"in n&&p.elevation!==+n.elevation&&p.setElevation(+n.elevation),"bearing"in n&&p.bearing!==+n.bearing&&(g=!0,p.setBearing(+n.bearing)),"pitch"in n&&p.pitch!==+n.pitch&&(x=!0,p.setPitch(+n.pitch)),"roll"in n&&p.roll!==+n.roll&&(w=!0,p.setRoll(+n.roll)),n.padding==null||p.isPaddingEqual(n.padding)||p.setPadding(n.padding),this._applyUpdatedTransform(p),this.fire(new a.l("movestart",l)).fire(new a.l("move",l)),I&&this.fire(new a.l("zoomstart",l)).fire(new a.l("zoom",l)).fire(new a.l("zoomend",l)),g&&this.fire(new a.l("rotatestart",l)).fire(new a.l("rotate",l)).fire(new a.l("rotateend",l)),x&&this.fire(new a.l("pitchstart",l)).fire(new a.l("pitch",l)).fire(new a.l("pitchend",l)),w&&this.fire(new a.l("rollstart",l)).fire(new a.l("roll",l)).fire(new a.l("rollend",l)),this.fire(new a.l("moveend",l))}calculateCameraOptionsFromTo(n,l,p,g=0){const x=a.$.fromLngLat(n,l),w=a.$.fromLngLat(p,g),P=w.x-x.x,I=w.y-x.y,R=w.z-x.z,O=Math.hypot(P,I,R);if(O===0)throw new Error("Can't calculate camera options with same From and To");const N=Math.hypot(P,I),B=a.ab(this.transform.cameraToCenterDistance/O/this.transform.tileSize),W=180*Math.atan2(P,-I)/Math.PI;let X=180*Math.acos(N/O)/Math.PI;return X=R<0?90-X:90+X,{center:w.toLngLat(),elevation:g,zoom:B,pitch:X,bearing:W}}calculateCameraOptionsFromCameraLngLatAltRotation(n,l,p,g,x){const w=this.transform.calculateCenterFromCameraLngLatAlt(n,l,p,g);return{center:w.center,elevation:w.elevation,zoom:w.zoom,bearing:p,pitch:g,roll:x}}easeTo(n,l){this._stop(!1,n.easeId),((n=a.e({offset:[0,0],duration:500,easing:a.cb},n)).animate===!1||!n.essential&&F.prefersReducedMotion)&&(n.duration=0);const p=this._getTransformForUpdate(),g=this.getBearing(),x=p.pitch,w=p.roll,P="bearing"in n?this._normalizeBearing(n.bearing,g):g,I="pitch"in n?+n.pitch:x,R="roll"in n?this._normalizeBearing(n.roll,w):w,O="padding"in n?n.padding:p.padding,N=a.P.convert(n.offset);let B,W;n.around&&(B=a.Q.convert(n.around),W=p.locationToScreenPoint(B));const X={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},te=this.cameraHelper.handleEaseTo(p,{bearing:P,pitch:I,roll:R,padding:O,around:B,aroundPoint:W,offsetAsPoint:N,offset:n.offset,zoom:n.zoom,center:n.center});return this._rotating=this._rotating||g!==P,this._pitching=this._pitching||I!==x,this._rolling=this._rolling||R!==w,this._padding=!p.isPaddingEqual(O),this._zooming=this._zooming||te.isZooming,this._easeId=n.easeId,this._prepareEase(l,n.noMoveStart,X),this.terrain&&this._prepareElevation(te.elevationCenter),this._ease(Q=>{te.easeFunc(Q),this.terrain&&!n.freezeElevation&&this._updateElevation(Q),this._applyUpdatedTransform(p),this._fireMoveEvents(l)},Q=>{this.terrain&&n.freezeElevation&&this._finalizeElevation(),this._afterEase(l,Q)},n),this}_prepareEase(n,l,p={}){this._moving=!0,l||p.moving||this.fire(new a.l("movestart",n)),this._zooming&&!p.zooming&&this.fire(new a.l("zoomstart",n)),this._rotating&&!p.rotating&&this.fire(new a.l("rotatestart",n)),this._pitching&&!p.pitching&&this.fire(new a.l("pitchstart",n)),this._rolling&&!p.rolling&&this.fire(new a.l("rollstart",n))}_prepareElevation(n){this._elevationCenter=n,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(n){this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const l=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(n<1&&l!==this._elevationTarget){const p=this._elevationTarget-this._elevationStart;this._elevationStart+=n*(p-(l-(p*n+this._elevationStart))/(1-n)),this._elevationTarget=l}this.transform.setElevation(a.B.number(this._elevationStart,this._elevationTarget,n))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(n){if(!this.terrain&&n.elevation>=0&&n.pitch<=90)return{};const l=n.getCameraLngLat(),p=n.getCameraAltitude(),g=this.terrain?this.terrain.getElevationForLngLatZoom(l,n.zoom):0;if(p<g){const x=this.calculateCameraOptionsFromTo(l,g,n.center,n.elevation);return{pitch:x.pitch,zoom:x.zoom}}return{}}_applyUpdatedTransform(n){const l=[];if(l.push(g=>this._elevateCameraIfInsideTerrain(g)),this.transformCameraUpdate&&l.push(g=>this.transformCameraUpdate(g)),!l.length)return;const p=n.clone();for(const g of l){const x=p.clone(),{center:w,zoom:P,roll:I,pitch:R,bearing:O,elevation:N}=g(x);w&&x.setCenter(w),N!==void 0&&x.setElevation(N),P!==void 0&&x.setZoom(P),I!==void 0&&x.setRoll(I),R!==void 0&&x.setPitch(R),O!==void 0&&x.setBearing(O),p.apply(x)}this.transform.apply(p)}_fireMoveEvents(n){this.fire(new a.l("move",n)),this._zooming&&this.fire(new a.l("zoom",n)),this._rotating&&this.fire(new a.l("rotate",n)),this._pitching&&this.fire(new a.l("pitch",n)),this._rolling&&this.fire(new a.l("roll",n))}_afterEase(n,l){if(this._easeId&&l&&this._easeId===l)return;delete this._easeId;const p=this._zooming,g=this._rotating,x=this._pitching,w=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,p&&this.fire(new a.l("zoomend",n)),g&&this.fire(new a.l("rotateend",n)),x&&this.fire(new a.l("pitchend",n)),w&&this.fire(new a.l("rollend",n)),this.fire(new a.l("moveend",n))}flyTo(n,l){if(!n.essential&&F.prefersReducedMotion){const je=a.O(n,["center","zoom","bearing","pitch","roll","elevation"]);return this.jumpTo(je,l)}this.stop(),n=a.e({offset:[0,0],speed:1.2,curve:1.42,easing:a.cb},n);const p=this._getTransformForUpdate(),g=p.bearing,x=p.pitch,w=p.roll,P=p.padding,I="bearing"in n?this._normalizeBearing(n.bearing,g):g,R="pitch"in n?+n.pitch:x,O="roll"in n?this._normalizeBearing(n.roll,w):w,N="padding"in n?n.padding:p.padding,B=a.P.convert(n.offset);let W=p.centerPoint.add(B);const X=p.screenPointToLocation(W),te=this.cameraHelper.handleFlyTo(p,{bearing:I,pitch:R,roll:O,padding:N,locationAtOffset:X,offsetAsPoint:B,center:n.center,minZoom:n.minZoom,zoom:n.zoom});let Q=n.curve;const ie=Math.max(p.width,p.height),se=ie/te.scaleOfZoom,ue=te.pixelPathLength;typeof te.scaleOfMinZoom=="number"&&(Q=Math.sqrt(ie/te.scaleOfMinZoom/ue*2));const fe=Q*Q;function de(je){const lt=(se*se-ie*ie+(je?-1:1)*fe*fe*ue*ue)/(2*(je?se:ie)*fe*ue);return Math.log(Math.sqrt(lt*lt+1)-lt)}function ve(je){return(Math.exp(je)-Math.exp(-je))/2}function ge(je){return(Math.exp(je)+Math.exp(-je))/2}const De=de(!1);let ke=function(je){return ge(De)/ge(De+Q*je)},We=function(je){return ie*((ge(De)*(ve(lt=De+Q*je)/ge(lt))-ve(De))/fe)/ue;var lt},Ze=(de(!0)-De)/Q;if(Math.abs(ue)<2e-6||!isFinite(Ze)){if(Math.abs(ie-se)<1e-6)return this.easeTo(n,l);const je=se<ie?-1:1;Ze=Math.abs(Math.log(se/ie))/Q,We=()=>0,ke=lt=>Math.exp(je*Q*lt)}return n.duration="duration"in n?+n.duration:1e3*Ze/("screenSpeed"in n?+n.screenSpeed/Q:+n.speed),n.maxDuration&&n.duration>n.maxDuration&&(n.duration=0),this._zooming=!0,this._rotating=g!==I,this._pitching=R!==x,this._rolling=O!==w,this._padding=!p.isPaddingEqual(N),this._prepareEase(l,!1),this.terrain&&this._prepareElevation(te.targetCenter),this._ease(je=>{const lt=je*Ze,at=1/ke(lt),qe=We(lt);this._rotating&&p.setBearing(a.B.number(g,I,je)),this._pitching&&p.setPitch(a.B.number(x,R,je)),this._rolling&&p.setRoll(a.B.number(w,O,je)),this._padding&&(p.interpolatePadding(P,N,je),W=p.centerPoint.add(B)),te.easeFunc(je,at,qe,W),this.terrain&&!n.freezeElevation&&this._updateElevation(je),this._applyUpdatedTransform(p),this._fireMoveEvents(l)},()=>{this.terrain&&n.freezeElevation&&this._finalizeElevation(),this._afterEase(l)},n),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(n,l){var p;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const g=this._onEaseEnd;delete this._onEaseEnd,g.call(this,l)}return n||(p=this.handlers)===null||p===void 0||p.stop(!1),this}_ease(n,l,p){p.animate===!1||p.duration===0?(n(1),l()):(this._easeStart=F.now(),this._easeOptions=p,this._onEaseFrame=n,this._onEaseEnd=l,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(n,l){n=a.aL(n,-180,180);const p=Math.abs(n-l);return Math.abs(n-360-l)<p&&(n-=360),Math.abs(n+360-l)<p&&(n+=360),n}queryTerrainElevation(n){return this.terrain?this.terrain.getElevationForLngLatZoom(a.Q.convert(n),this.transform.tileZoom):null}}const Sa={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class St{constructor(n=Sa){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=l=>{!l||l.sourceDataType!=="metadata"&&l.sourceDataType!=="visibility"&&l.dataType!=="style"&&l.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=n}getDefaultPosition(){return"bottom-right"}onAdd(n){return this._map=n,this._compact=this.options.compact,this._container=L.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=L.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=L.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){L.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(n,l){const p=this._map._getUIString(`AttributionControl.${l}`);n.title=p,n.setAttribute("aria-label",p)}_updateAttributions(){if(!this._map.style)return;let n=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?n=n.concat(this.options.customAttribution.map(g=>typeof g!="string"?"":g)):typeof this.options.customAttribution=="string"&&n.push(this.options.customAttribution)),this._map.style.stylesheet){const g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}const l=this._map.style.sourceCaches;for(const g in l){const x=l[g];if(x.used||x.usedForTerrain){const w=x.getSource();w.attribution&&n.indexOf(w.attribution)<0&&n.push(w.attribution)}}n=n.filter(g=>String(g).trim()),n.sort((g,x)=>g.length-x.length),n=n.filter((g,x)=>{for(let w=x+1;w<n.length;w++)if(n[w].indexOf(g)>=0)return!1;return!0});const p=n.join(" | ");p!==this._attribHTML&&(this._attribHTML=p,n.length?(this._innerContainer.innerHTML=L.sanitize(p),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Mt{constructor(n={}){this._updateCompact=()=>{const l=this._container.children;if(l.length){const p=l[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&p.classList.add("maplibregl-compact"):p.classList.remove("maplibregl-compact")}},this.options=n}getDefaultPosition(){return"bottom-left"}onAdd(n){this._map=n,this._compact=this.options&&this.options.compact,this._container=L.create("div","maplibregl-ctrl");const l=L.create("a","maplibregl-ctrl-logo");return l.target="_blank",l.rel="noopener nofollow",l.href="https://maplibre.org/",l.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),l.setAttribute("rel","noopener nofollow"),this._container.appendChild(l),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){L.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Ml{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(n){const l=++this._id;return this._queue.push({callback:n,id:l,cancelled:!1}),l}remove(n){const l=this._currentlyRunning,p=l?this._queue.concat(l):this._queue;for(const g of p)if(g.id===n)return void(g.cancelled=!0)}run(n=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const l=this._currentlyRunning=this._queue;this._queue=[];for(const p of l)if(!p.cancelled&&(p.callback(n),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var uu=a.aD([{name:"a_pos3d",type:"Int16",components:3}]);class hu extends a.E{constructor(n){super(),this._lastTilesetChange=F.now(),this.sourceCache=n,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=n._source.tileSize*2**this.deltaZoom,n.usedForTerrain=!0,n.tileSize=this.tileSize}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(n,l){this.sourceCache.update(n,l),this._renderableTilesKeys=[];const p={};for(const g of Pe(n,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:l,calculateTileZoom:this.sourceCache._source.calculateTileZoom}))p[g.key]=!0,this._renderableTilesKeys.push(g.key),this._tiles[g.key]||(g.terrainRttPosMatrix32f=new Float64Array(16),a.bO(g.terrainRttPosMatrix32f,0,a.Z,a.Z,0,0,1),this._tiles[g.key]=new dn(g,this.tileSize),this._lastTilesetChange=F.now());for(const g in this._tiles)p[g]||delete this._tiles[g]}freeRtt(n){for(const l in this._tiles){const p=this._tiles[l];(!n||p.tileID.equals(n)||p.tileID.isChildOf(n)||n.isChildOf(p.tileID))&&(p.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(n=>this.getTileByID(n))}getTileByID(n){return this._tiles[n]}getTerrainCoords(n,l){return l?this._getTerrainCoordsForTileRanges(n,l):this._getTerrainCoordsForRegularTile(n)}_getTerrainCoordsForRegularTile(n){const l={};for(const p of this._renderableTilesKeys){const g=this._tiles[p].tileID,x=n.clone(),w=a.b2();if(g.canonical.equals(n.canonical))a.bO(w,0,a.Z,a.Z,0,0,1);else if(g.canonical.isChildOf(n.canonical)){const P=g.canonical.z-n.canonical.z,I=g.canonical.x-(g.canonical.x>>P<<P),R=g.canonical.y-(g.canonical.y>>P<<P),O=a.Z>>P;a.bO(w,0,O,O,0,0,1),a.L(w,w,[-I*O,-R*O,0])}else{if(!n.canonical.isChildOf(g.canonical))continue;{const P=n.canonical.z-g.canonical.z,I=n.canonical.x-(n.canonical.x>>P<<P),R=n.canonical.y-(n.canonical.y>>P<<P),O=a.Z>>P;a.bO(w,0,a.Z,a.Z,0,0,1),a.L(w,w,[I*O,R*O,0]),a.M(w,w,[1/2**P,1/2**P,0])}}x.terrainRttPosMatrix32f=new Float32Array(w),l[p]=x}return l}_getTerrainCoordsForTileRanges(n,l){const p={};for(const g of this._renderableTilesKeys){const x=this._tiles[g].tileID;if(!this._isWithinTileRanges(x,l))continue;const w=n.clone(),P=a.b2();if(x.canonical.z===n.canonical.z){const I=n.canonical.x-x.canonical.x,R=n.canonical.y-x.canonical.y;a.bO(P,0,a.Z,a.Z,0,0,1),a.L(P,P,[I*a.Z,R*a.Z,0])}else if(x.canonical.z>n.canonical.z){const I=x.canonical.z-n.canonical.z,R=x.canonical.x-(x.canonical.x>>I<<I),O=x.canonical.y-(x.canonical.y>>I<<I),N=n.canonical.x-(x.canonical.x>>I),B=n.canonical.y-(x.canonical.y>>I),W=a.Z>>I;a.bO(P,0,W,W,0,0,1),a.L(P,P,[-R*W+N*a.Z,-O*W+B*a.Z,0])}else{const I=n.canonical.z-x.canonical.z,R=n.canonical.x-(n.canonical.x>>I<<I),O=n.canonical.y-(n.canonical.y>>I<<I),N=(n.canonical.x>>I)-x.canonical.x,B=(n.canonical.y>>I)-x.canonical.y,W=a.Z<<I;a.bO(P,0,W,W,0,0,1),a.L(P,P,[R*a.Z+N*W,O*a.Z+B*W,0])}w.terrainRttPosMatrix32f=new Float32Array(P),p[g]=w}return p}getSourceTile(n,l){const p=this.sourceCache._source;let g=n.overscaledZ-this.deltaZoom;if(g>p.maxzoom&&(g=p.maxzoom),g<p.minzoom)return null;this._sourceTileCache[n.key]||(this._sourceTileCache[n.key]=n.scaledTo(g).key);let x=this.sourceCache.getTileByID(this._sourceTileCache[n.key]);if((!x||!x.dem)&&l)for(;g>=p.minzoom&&(!x||!x.dem);)x=this.sourceCache.getTileByID(n.scaledTo(g--).key);return x}anyTilesAfterTime(n=Date.now()){return this._lastTilesetChange>=n}_isWithinTileRanges(n,l){return l[n.canonical.z]&&n.canonical.x>=l[n.canonical.z].minTileX&&n.canonical.x<=l[n.canonical.z].maxTileX&&n.canonical.y>=l[n.canonical.z].minTileY&&n.canonical.y<=l[n.canonical.z].maxTileY}}class kr{constructor(n,l,p){this._meshCache={},this.painter=n,this.sourceCache=new hu(l),this.options=p,this.exaggeration=typeof p.exaggeration=="number"?p.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(n,l,p,g=a.Z){var x;if(!(l>=0&&l<g&&p>=0&&p<g))return 0;const w=this.getTerrainData(n),P=(x=w.tile)===null||x===void 0?void 0:x.dem;if(!P)return 0;const I=a.cf([],[l/g*a.Z,p/g*a.Z],w.u_terrain_matrix),R=[I[0]*P.dim,I[1]*P.dim],O=Math.floor(R[0]),N=Math.floor(R[1]),B=R[0]-O,W=R[1]-N;return P.get(O,N)*(1-B)*(1-W)+P.get(O+1,N)*B*(1-W)+P.get(O,N+1)*(1-B)*W+P.get(O+1,N+1)*B*W}getElevationForLngLatZoom(n,l){if(!a.cg(l,n.wrap()))return 0;const{tileID:p,mercatorX:g,mercatorY:x}=this._getOverscaledTileIDFromLngLatZoom(n,l);return this.getElevation(p,g%a.Z,x%a.Z,a.Z)}getElevation(n,l,p,g=a.Z){return this.getDEMElevation(n,l,p,g)*this.exaggeration}getTerrainData(n){if(!this._emptyDemTexture){const g=this.painter.context,x=new a.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new ft(g,x,g.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new ft(g,new a.R({width:1,height:1}),g.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(g.gl.NEAREST,g.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=a.at([])}const l=this.sourceCache.getSourceTile(n,!0);if(l&&l.dem&&(!l.demTexture||l.needsTerrainPrepare)){const g=this.painter.context;l.demTexture=this.painter.getTileTexture(l.dem.stride),l.demTexture?l.demTexture.update(l.dem.getPixels(),{premultiply:!1}):l.demTexture=new ft(g,l.dem.getPixels(),g.gl.RGBA,{premultiply:!1}),l.demTexture.bind(g.gl.NEAREST,g.gl.CLAMP_TO_EDGE),l.needsTerrainPrepare=!1}const p=l&&l+l.tileID.key+n.key;if(p&&!this._demMatrixCache[p]){const g=this.sourceCache.sourceCache._source.maxzoom;let x=n.canonical.z-l.tileID.canonical.z;n.overscaledZ>n.canonical.z&&(n.canonical.z>=g?x=n.canonical.z-g:a.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const w=n.canonical.x-(n.canonical.x>>x<<x),P=n.canonical.y-(n.canonical.y>>x<<x),I=a.ch(new Float64Array(16),[1/(a.Z<<x),1/(a.Z<<x),0]);a.L(I,I,[w*a.Z,P*a.Z,0]),this._demMatrixCache[n.key]={matrix:I,coord:n}}return{u_depth:2,u_terrain:3,u_terrain_dim:l&&l.dem&&l.dem.dim||1,u_terrain_matrix:p?this._demMatrixCache[n.key].matrix:this._emptyDemMatrix,u_terrain_unpack:l&&l.dem&&l.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(l&&l.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:l}}getFramebuffer(n){const l=this.painter,p=l.width/devicePixelRatio,g=l.height/devicePixelRatio;return!this._fbo||this._fbo.width===p&&this._fbo.height===g||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new ft(l.context,{width:p,height:g,data:null},l.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(l.context.gl.NEAREST,l.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new ft(l.context,{width:p,height:g,data:null},l.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(l.context.gl.NEAREST,l.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=l.context.createFramebuffer(p,g,!0,!1),this._fbo.depthAttachment.set(l.context.createRenderbuffer(l.context.gl.DEPTH_COMPONENT16,p,g))),this._fbo.colorAttachment.set(n==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const n=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const l=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let x=0,w=0;x<this._coordsTextureSize;x++)for(let P=0;P<this._coordsTextureSize;P++,w+=4)l[w+0]=255&P,l[w+1]=255&x,l[w+2]=P>>8<<4|x>>8,l[w+3]=0;const p=new a.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(l.buffer)),g=new ft(n,p,n.gl.RGBA,{premultiply:!1});return g.bind(n.gl.NEAREST,n.gl.CLAMP_TO_EDGE),this._coordsTexture=g,g}pointCoordinate(n){this.painter.maybeDrawDepthAndCoords(!0);const l=new Uint8Array(4),p=this.painter.context,g=p.gl,x=Math.round(n.x*this.painter.pixelRatio/devicePixelRatio),w=Math.round(n.y*this.painter.pixelRatio/devicePixelRatio),P=Math.round(this.painter.height/devicePixelRatio);p.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),g.readPixels(x,P-w-1,1,1,g.RGBA,g.UNSIGNED_BYTE,l),p.bindFramebuffer.set(null);const I=l[0]+(l[2]>>4<<8),R=l[1]+((15&l[2])<<8),O=this.coordsIndex[255-l[3]],N=O&&this.sourceCache.getTileByID(O);if(!N)return null;const B=this._coordsTextureSize,W=(1<<N.tileID.canonical.z)*B;return new a.$((N.tileID.canonical.x*B+I)/W+N.tileID.wrap,(N.tileID.canonical.y*B+R)/W,this.getElevation(N.tileID,I,R,B))}depthAtPoint(n){const l=new Uint8Array(4),p=this.painter.context,g=p.gl;return p.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),g.readPixels(n.x,this.painter.height/devicePixelRatio-n.y-1,1,1,g.RGBA,g.UNSIGNED_BYTE,l),p.bindFramebuffer.set(null),(l[0]/16777216+l[1]/65536+l[2]/256+l[3])/256}getTerrainMesh(n){var l;const p=((l=this.painter.style.projection)===null||l===void 0?void 0:l.transitionState)>0,g=p&&n.canonical.y===0,x=p&&n.canonical.y===(1<<n.canonical.z)-1,w=`m_${g?"n":""}_${x?"s":""}`;if(this._meshCache[w])return this._meshCache[w];const P=this.painter.context,I=new a.ci,R=new a.aH,O=this.meshSize,N=a.Z/O,B=O*O;for(let ge=0;ge<=O;ge++)for(let De=0;De<=O;De++)I.emplaceBack(De*N,ge*N,0);for(let ge=0;ge<B;ge+=O+1)for(let De=0;De<O;De++)R.emplaceBack(De+ge,O+De+ge+1,O+De+ge+2),R.emplaceBack(De+ge,O+De+ge+2,De+ge+1);const W=I.length,X=W+(O+1),te=(O+1)*O,Q=g?a.b9:0,ie=g?0:1,se=x?a.ba:a.Z,ue=x?0:1;for(let ge=0;ge<=O;ge++)I.emplaceBack(ge*N,Q,ie);for(let ge=0;ge<=O;ge++)I.emplaceBack(ge*N,se,ue);for(let ge=0;ge<O;ge++)R.emplaceBack(te+ge,X+ge,X+ge+1),R.emplaceBack(te+ge,X+ge+1,te+ge+1),R.emplaceBack(0+ge,W+ge+1,W+ge),R.emplaceBack(0+ge,0+ge+1,W+ge+1);const fe=I.length,de=fe+2*(O+1);for(const ge of[0,1])for(let De=0;De<=O;De++)for(const ke of[0,1])I.emplaceBack(ge*a.Z,De*N,ke);for(let ge=0;ge<2*O;ge+=2)R.emplaceBack(fe+ge,fe+ge+1,fe+ge+3),R.emplaceBack(fe+ge,fe+ge+3,fe+ge+2),R.emplaceBack(de+ge,de+ge+3,de+ge+1),R.emplaceBack(de+ge,de+ge+2,de+ge+3);const ve=new Cs(P.createVertexBuffer(I,uu.members),P.createIndexBuffer(R),a.aG.simpleSegment(0,0,I.length,R.length));return this._meshCache[w]=ve,ve}getMeshFrameDelta(n){return 2*Math.PI*a.br/Math.pow(2,Math.max(n,0))/5}getMinTileElevationForLngLatZoom(n,l){var p;const{tileID:g}=this._getOverscaledTileIDFromLngLatZoom(n,l);return(p=this.getMinMaxElevation(g).minElevation)!==null&&p!==void 0?p:0}getMinMaxElevation(n){const l=this.getTerrainData(n).tile,p={minElevation:null,maxElevation:null};return l&&l.dem&&(p.minElevation=l.dem.min*this.exaggeration,p.maxElevation=l.dem.max*this.exaggeration),p}_getOverscaledTileIDFromLngLatZoom(n,l){const p=a.$.fromLngLat(n.wrap()),g=(1<<l)*a.Z,x=p.x*g,w=p.y*g,P=Math.floor(x/a.Z),I=Math.floor(w/a.Z);return{tileID:new a.Y(l,0,l,P,I),mercatorX:x,mercatorY:w}}}class Tf{constructor(n,l,p){this._context=n,this._size=l,this._tileSize=p,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const n of this._objects)n.texture.destroy(),n.fbo.destroy()}_createObject(n){const l=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),p=new ft(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return p.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),l.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),l.colorAttachment.set(p.texture),{id:n,fbo:l,texture:p,stamp:-1,inUse:!1}}getObjectForId(n){return this._objects[n]}useObject(n){n.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(l=>n.id!==l),this._recentlyUsed.push(n.id)}stampObject(n){n.stamp=++this._stamp}getOrCreateFreeObject(){for(const l of this._recentlyUsed)if(!this._objects[l].inUse)return this._objects[l];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const n=this._createObject(this._objects.length);return this._objects.push(n),n}freeObject(n){n.inUse=!1}freeAllObjects(){for(const n of this._objects)this.freeObject(n)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(n=>!n.inUse)===!1}}const Tr={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class lg{constructor(n,l){this.painter=n,this.terrain=l,this.pool=new Tf(n.context,30,l.sourceCache.tileSize*l.qualityFactor)}destruct(){this.pool.destruct()}getTexture(n){return this.pool.getObjectForId(n.rtt[this._stacks.length-1].id).texture}prepareForRender(n,l){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=n._order.filter(p=>!n._layers[p].isHidden(l)),this._coordsAscending={};for(const p in n.sourceCaches){this._coordsAscending[p]={};const g=n.sourceCaches[p].getVisibleCoordinates(),x=n.sourceCaches[p].getSource(),w=x instanceof Jr?x.terrainTileRanges:null;for(const P of g){const I=this.terrain.sourceCache.getTerrainCoords(P,w);for(const R in I)this._coordsAscending[p][R]||(this._coordsAscending[p][R]=[]),this._coordsAscending[p][R].push(I[R])}}this._coordsAscendingStr={};for(const p of n._order){const g=n._layers[p],x=g.source;if(Tr[g.type]&&!this._coordsAscendingStr[x]){this._coordsAscendingStr[x]={};for(const w in this._coordsAscending[x])this._coordsAscendingStr[x][w]=this._coordsAscending[x][w].map(P=>P.key).sort().join()}}for(const p of this._renderableTiles)for(const g in this._coordsAscendingStr){const x=this._coordsAscendingStr[g][p.tileID.key];x&&x!==p.rttCoords[g]&&(p.rtt=[])}}renderLayer(n,l){if(n.isHidden(this.painter.transform.zoom))return!1;const p=Object.assign(Object.assign({},l),{isRenderingToTexture:!0}),g=n.type,x=this.painter,w=this._renderableLayerIds[this._renderableLayerIds.length-1]===n.id;if(Tr[g]&&(this._prevType&&Tr[this._prevType]||this._stacks.push([]),this._prevType=g,this._stacks[this._stacks.length-1].push(n.id),!w))return!0;if(Tr[this._prevType]||Tr[g]&&w){this._prevType=g;const P=this._stacks.length-1,I=this._stacks[P]||[];for(const R of this._renderableTiles){if(this.pool.isFull()&&(Pl(this.painter,this.terrain,this._rttTiles,p),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(R),R.rtt[P]){const N=this.pool.getObjectForId(R.rtt[P].id);if(N.stamp===R.rtt[P].stamp){this.pool.useObject(N);continue}}const O=this.pool.getOrCreateFreeObject();this.pool.useObject(O),this.pool.stampObject(O),R.rtt[P]={id:O.id,stamp:O.stamp},x.context.bindFramebuffer.set(O.fbo.framebuffer),x.context.clear({color:a.b7.transparent,stencil:0}),x.currentStencilSource=void 0;for(let N=0;N<I.length;N++){const B=x.style._layers[I[N]],W=B.source?this._coordsAscending[B.source][R.tileID.key]:[R.tileID];x.context.viewport.set([0,0,O.fbo.width,O.fbo.height]),x._renderTileClippingMasks(B,W,!0),x.renderLayer(x,x.style.sourceCaches[B.source],B,W,p),B.source&&(R.rttCoords[B.source]=this._coordsAscendingStr[B.source][R.tileID.key])}}return Pl(this.painter,this.terrain,this._rttTiles,p),this._rttTiles=[],this.pool.freeAllObjects(),Tr[g]}return!1}}const Aa={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Ri=y,Ni={hash:!1,interactive:!0,bearingSnap:7,attributionControl:Sa,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:a.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0},Sf={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class Pa{constructor(n,l,p=!1){this.mousedown=x=>{this.startMove(x,L.mousePos(this.element,x)),L.addEventListener(window,"mousemove",this.mousemove),L.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=x=>{this.move(x,L.mousePos(this.element,x))},this.mouseup=x=>{this._rotatePitchHanlder.dragEnd(x),this.offTemp()},this.touchstart=x=>{x.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=L.touchPos(this.element,x.targetTouches)[0],this.startMove(x,this._startPos),L.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),L.addEventListener(window,"touchend",this.touchend))},this.touchmove=x=>{x.targetTouches.length!==1?this.reset():(this._lastPos=L.touchPos(this.element,x.targetTouches)[0],this.move(x,this._lastPos))},this.touchend=x=>{x.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHanlder.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=l;const g=new _f;this._rotatePitchHanlder=new Ro({clickTolerance:3,move:(x,w)=>{const P=l.getBoundingClientRect(),I=new a.P((P.bottom-P.top)/2,(P.right-P.left)/2);return{bearingDelta:a.ca(new a.P(x.x,w.y),w,I),pitchDelta:p?-.5*(w.y-x.y):void 0}},moveStateManager:g,enable:!0,assignEvents:()=>{}}),this.map=n,L.addEventListener(l,"mousedown",this.mousedown),L.addEventListener(l,"touchstart",this.touchstart,{passive:!1}),L.addEventListener(l,"touchcancel",this.reset)}startMove(n,l){this._rotatePitchHanlder.dragStart(n,l),L.disableDrag()}move(n,l){const p=this.map,{bearingDelta:g,pitchDelta:x}=this._rotatePitchHanlder.dragMove(n,l)||{};g&&p.setBearing(p.getBearing()+g),x&&p.setPitch(p.getPitch()+x)}off(){const n=this.element;L.removeEventListener(n,"mousedown",this.mousedown),L.removeEventListener(n,"touchstart",this.touchstart,{passive:!1}),L.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),L.removeEventListener(window,"touchend",this.touchend),L.removeEventListener(n,"touchcancel",this.reset),this.offTemp()}offTemp(){L.enableDrag(),L.removeEventListener(window,"mousemove",this.mousemove),L.removeEventListener(window,"mouseup",this.mouseup),L.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),L.removeEventListener(window,"touchend",this.touchend)}}let xn;function Rl(_,n,l){const p=new a.Q(_.lng,_.lat);if(_=new a.Q(_.lng,_.lat),n){const g=new a.Q(_.lng-360,_.lat),x=new a.Q(_.lng+360,_.lat),w=l.locationToScreenPoint(_).distSqr(n);l.locationToScreenPoint(g).distSqr(n)<w?_=g:l.locationToScreenPoint(x).distSqr(n)<w&&(_=x)}for(;Math.abs(_.lng-l.center.lng)>180;){const g=l.locationToScreenPoint(_);if(g.x>=0&&g.y>=0&&g.x<=l.width&&g.y<=l.height)break;_.lng>l.center.lng?_.lng-=360:_.lng+=360}return _.lng!==p.lng&&l.isPointOnMapSurface(l.locationToScreenPoint(_))?_:p}const Ea={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function kl(_,n,l){const p=_.classList;for(const g in Ea)p.remove(`maplibregl-${l}-anchor-${g}`);p.add(`maplibregl-${l}-anchor-${n}`)}class Us extends a.E{constructor(n){if(super(),this._onKeyPress=l=>{const p=l.code,g=l.charCode||l.keyCode;p!=="Space"&&p!=="Enter"&&g!==32&&g!==13||this.togglePopup()},this._onMapClick=l=>{const p=l.originalEvent.target,g=this._element;this._popup&&(p===g||g.contains(p))&&this.togglePopup()},this._update=l=>{var p;if(!this._map)return;const g=this._map.loaded()&&!this._map.isMoving();((l==null?void 0:l.type)==="terrain"||(l==null?void 0:l.type)==="render"&&!g)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Rl(this._lngLat,this._flatPos,this._map.transform):(p=this._lngLat)===null||p===void 0?void 0:p.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let x="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?x=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(x=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let w="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?w="rotateX(0deg)":this._pitchAlignment==="map"&&(w=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||l&&l.type!=="moveend"||(this._pos=this._pos.round()),L.setTransform(this._element,`${Ea[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${w} ${x}`),F.frameAsync(new AbortController).then(()=>{this._updateOpacity(l&&l.type==="moveend")}).catch(()=>{})},this._onMove=l=>{if(!this._isDragging){const p=this._clickTolerance||this._map._clickTolerance;this._isDragging=l.point.dist(this._pointerdownPos)>=p}this._isDragging&&(this._pos=l.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new a.l("dragstart"))),this.fire(new a.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new a.l("dragend")),this._state="inactive"},this._addDragHandler=l=>{this._element.contains(l.originalEvent.target)&&(l.preventDefault(),this._positionDelta=l.point.sub(this._pos).add(this._offset),this._pointerdownPos=l.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=n&&n.anchor||"center",this._color=n&&n.color||"#3FB1CE",this._scale=n&&n.scale||1,this._draggable=n&&n.draggable||!1,this._clickTolerance=n&&n.clickTolerance||0,this._subpixelPositioning=n&&n.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=n&&n.rotation||0,this._rotationAlignment=n&&n.rotationAlignment||"auto",this._pitchAlignment=n&&n.pitchAlignment&&n.pitchAlignment!=="auto"?n.pitchAlignment:this._rotationAlignment,this.setOpacity(n==null?void 0:n.opacity,n==null?void 0:n.opacityWhenCovered),n&&n.element)this._element=n.element,this._offset=a.P.convert(n&&n.offset||[0,0]);else{this._defaultMarker=!0,this._element=L.create("div");const l=L.createNS("http://www.w3.org/2000/svg","svg"),p=41,g=27;l.setAttributeNS(null,"display","block"),l.setAttributeNS(null,"height",`${p}px`),l.setAttributeNS(null,"width",`${g}px`),l.setAttributeNS(null,"viewBox",`0 0 ${g} ${p}`);const x=L.createNS("http://www.w3.org/2000/svg","g");x.setAttributeNS(null,"stroke","none"),x.setAttributeNS(null,"stroke-width","1"),x.setAttributeNS(null,"fill","none"),x.setAttributeNS(null,"fill-rule","evenodd");const w=L.createNS("http://www.w3.org/2000/svg","g");w.setAttributeNS(null,"fill-rule","nonzero");const P=L.createNS("http://www.w3.org/2000/svg","g");P.setAttributeNS(null,"transform","translate(3.0, 29.0)"),P.setAttributeNS(null,"fill","#000000");const I=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const ie of I){const se=L.createNS("http://www.w3.org/2000/svg","ellipse");se.setAttributeNS(null,"opacity","0.04"),se.setAttributeNS(null,"cx","10.5"),se.setAttributeNS(null,"cy","5.80029008"),se.setAttributeNS(null,"rx",ie.rx),se.setAttributeNS(null,"ry",ie.ry),P.appendChild(se)}const R=L.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"fill",this._color);const O=L.createNS("http://www.w3.org/2000/svg","path");O.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),R.appendChild(O);const N=L.createNS("http://www.w3.org/2000/svg","g");N.setAttributeNS(null,"opacity","0.25"),N.setAttributeNS(null,"fill","#000000");const B=L.createNS("http://www.w3.org/2000/svg","path");B.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),N.appendChild(B);const W=L.createNS("http://www.w3.org/2000/svg","g");W.setAttributeNS(null,"transform","translate(6.0, 7.0)"),W.setAttributeNS(null,"fill","#FFFFFF");const X=L.createNS("http://www.w3.org/2000/svg","g");X.setAttributeNS(null,"transform","translate(8.0, 8.0)");const te=L.createNS("http://www.w3.org/2000/svg","circle");te.setAttributeNS(null,"fill","#000000"),te.setAttributeNS(null,"opacity","0.25"),te.setAttributeNS(null,"cx","5.5"),te.setAttributeNS(null,"cy","5.5"),te.setAttributeNS(null,"r","5.4999962");const Q=L.createNS("http://www.w3.org/2000/svg","circle");Q.setAttributeNS(null,"fill","#FFFFFF"),Q.setAttributeNS(null,"cx","5.5"),Q.setAttributeNS(null,"cy","5.5"),Q.setAttributeNS(null,"r","5.4999962"),X.appendChild(te),X.appendChild(Q),w.appendChild(P),w.appendChild(R),w.appendChild(N),w.appendChild(W),w.appendChild(X),l.appendChild(w),l.setAttributeNS(null,"height",p*this._scale+"px"),l.setAttributeNS(null,"width",g*this._scale+"px"),this._element.appendChild(l),this._offset=a.P.convert(n&&n.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",l=>{l.preventDefault()}),this._element.addEventListener("mousedown",l=>{l.preventDefault()}),kl(this._element,this._anchor,"marker"),n&&n.className)for(const l of n.className.split(" "))this._element.classList.add(l);this._popup=null}addTo(n){return this.remove(),this._map=n,this._element.setAttribute("aria-label",n._getUIString("Marker.Title")),n.getCanvasContainer().appendChild(this._element),n.on("move",this._update),n.on("moveend",this._update),n.on("terrain",this._update),n.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),L.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(n){return this._lngLat=a.Q.convert(n),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(n){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),n){if(!("offset"in n.options)){const g=Math.abs(13.5)/Math.SQRT2;n.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=n,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(n){return this._subpixelPositioning=n,this}getPopup(){return this._popup}togglePopup(){const n=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:n?(n.isOpen()?n.remove():(n.setLngLat(this._lngLat),n.addTo(this._map)),this):this}_updateOpacity(n=!1){var l,p;if(!(!((l=this._map)===null||l===void 0)&&l.terrain)){const N=this._map.transform.isLocationOccluded(this._lngLat)?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==N&&(this._element.style.opacity=N))}if(n)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const g=this._map,x=g.terrain.depthAtPoint(this._pos),w=g.terrain.getElevationForLngLatZoom(this._lngLat,g.transform.tileZoom);if(g.transform.lngLatToCameraDepth(this._lngLat,w)-x<.006)return void(this._element.style.opacity=this._opacity);const P=-this._offset.y/g.transform.pixelsPerMeter,I=Math.sin(g.getPitch()*Math.PI/180)*P,R=g.terrain.depthAtPoint(new a.P(this._pos.x,this._pos.y-this._offset.y)),O=g.transform.lngLatToCameraDepth(this._lngLat,w+I)-R>.006;!((p=this._popup)===null||p===void 0)&&p.isOpen()&&O&&this._popup.remove(),this._element.style.opacity=O?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(n){return this._offset=a.P.convert(n),this._update(),this}addClassName(n){this._element.classList.add(n)}removeClassName(n){this._element.classList.remove(n)}toggleClassName(n){return this._element.classList.toggle(n)}setDraggable(n){return this._draggable=!!n,this._map&&(n?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(n){return this._rotation=n||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(n){return this._rotationAlignment=n||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(n){return this._pitchAlignment=n&&n!=="auto"?n:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(n,l){return(this._opacity===void 0||n===void 0&&l===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),n!==void 0&&(this._opacity=n),l!==void 0&&(this._opacityWhenCovered=l),this._map&&this._updateOpacity(!0),this}}const fu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Do=0,Vs=!1;const du={maxWidth:100,unit:"metric"};function Dl(_,n,l){const p=l&&l.maxWidth||100,g=_._container.clientHeight/2,x=_._container.clientWidth/2,w=_.unproject([x-p/2,g]),P=_.unproject([x+p/2,g]),I=Math.round(_.project(P).x-_.project(w).x),R=Math.min(p,I,_._container.clientWidth),O=w.distanceTo(P);if(l&&l.unit==="imperial"){const N=3.2808*O;N>5280?js(n,R,N/5280,_._getUIString("ScaleControl.Miles")):js(n,R,N,_._getUIString("ScaleControl.Feet"))}else l&&l.unit==="nautical"?js(n,R,O/1852,_._getUIString("ScaleControl.NauticalMiles")):O>=1e3?js(n,R,O/1e3,_._getUIString("ScaleControl.Kilometers")):js(n,R,O,_._getUIString("ScaleControl.Meters"))}function js(_,n,l,p){const g=function(x){const w=Math.pow(10,`${Math.floor(x)}`.length-1);let P=x/w;return P=P>=10?10:P>=5?5:P>=3?3:P>=2?2:P>=1?1:function(I){const R=Math.pow(10,Math.ceil(-Math.log(I)/Math.LN10));return Math.round(I*R)/R}(P),w*P}(l);_.style.width=n*(g/l)+"px",_.innerHTML=`${g}&nbsp;${p}`}const pu={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},gu=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Ia(_){if(_){if(typeof _=="number"){const n=Math.round(Math.abs(_)/Math.SQRT2);return{center:new a.P(0,0),top:new a.P(0,_),"top-left":new a.P(n,n),"top-right":new a.P(-n,n),bottom:new a.P(0,-_),"bottom-left":new a.P(n,-n),"bottom-right":new a.P(-n,-n),left:new a.P(_,0),right:new a.P(-_,0)}}if(_ instanceof a.P||Array.isArray(_)){const n=a.P.convert(_);return{center:n,top:n,"top-left":n,"top-right":n,bottom:n,"bottom-left":n,"bottom-right":n,left:n,right:n}}return{center:a.P.convert(_.center||[0,0]),top:a.P.convert(_.top||[0,0]),"top-left":a.P.convert(_["top-left"]||[0,0]),"top-right":a.P.convert(_["top-right"]||[0,0]),bottom:a.P.convert(_.bottom||[0,0]),"bottom-left":a.P.convert(_["bottom-left"]||[0,0]),"bottom-right":a.P.convert(_["bottom-right"]||[0,0]),left:a.P.convert(_.left||[0,0]),right:a.P.convert(_.right||[0,0])}}return Ia(new a.P(0,0))}const mu=y;f.AJAXError=a.cm,f.Event=a.l,f.Evented=a.E,f.LngLat=a.Q,f.MercatorCoordinate=a.$,f.Point=a.P,f.addProtocol=a.cn,f.config=a.a,f.removeProtocol=a.co,f.AttributionControl=St,f.BoxZoomHandler=Ns,f.CanvasSource=to,f.CooperativeGesturesHandler=Il,f.DoubleClickZoomHandler=cu,f.DragPanHandler=Ln,f.DragRotateHandler=yi,f.EdgeInsets=Ai,f.FullscreenControl=class extends a.E{constructor(_={}){super(),this._onFullscreenChange=()=>{var n;let l=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((n=l==null?void 0:l.shadowRoot)===null||n===void 0)&&n.fullscreenElement;)l=l.shadowRoot.fullscreenElement;l===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,_&&_.container&&(_.container instanceof HTMLElement?this._container=_.container:a.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(_){return this._map=_,this._container||(this._container=this._map.getContainer()),this._controlContainer=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){L.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const _=this._fullscreenButton=L.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);L.create("span","maplibregl-ctrl-icon",_).setAttribute("aria-hidden","true"),_.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const _=this._getTitle();this._fullscreenButton.setAttribute("aria-label",_),this._fullscreenButton.title=_}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new a.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new a.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},f.GeoJSONSource=es,f.GeolocateControl=class extends a.E{constructor(_){super(),this._onSuccess=n=>{if(this._map){if(this._isOutOfMapMaxBounds(n))return this._setErrorState(),this.fire(new a.l("outofmaxbounds",n)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=n,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(n),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(n),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new a.l("geolocate",n)),this._finish()}},this._updateCamera=n=>{const l=new a.Q(n.coords.longitude,n.coords.latitude),p=n.coords.accuracy,g=this._map.getBearing(),x=a.e({bearing:g},this.options.fitBoundsOptions),w=Si.fromLngLat(l,p);this._map.fitBounds(w,x,{geolocateSource:!0})},this._updateMarker=n=>{if(n){const l=new a.Q(n.coords.longitude,n.coords.latitude);this._accuracyCircleMarker.setLngLat(l).addTo(this._map),this._userLocationDotMarker.setLngLat(l).addTo(this._map),this._accuracy=n.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=n=>{if(this._map){if(this.options.trackUserLocation)if(n.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const l=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(n.code===3&&Vs)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new a.l("error",n)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",n=>n.preventDefault()),this._geolocateButton=L.create("button","maplibregl-ctrl-geolocate",this._container),L.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=n=>{if(this._map){if(n===!1){a.w("Geolocation support is not available so the GeolocateControl will be disabled.");const l=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l)}else{const l=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=L.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Us({element:this._dotElement}),this._circleElement=L.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Us({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",l=>{l.geolocateSource||this._watchState!=="ACTIVE_LOCK"||l.originalEvent&&l.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new a.l("trackuserlocationend")),this.fire(new a.l("userlocationlostfocus")))})}},this.options=a.e({},fu,_)}onAdd(_){return this._map=_,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return a._(this,arguments,void 0,function*(n=!1){if(xn!==void 0&&!n)return xn;if(window.navigator.permissions===void 0)return xn=!!window.navigator.geolocation,xn;try{xn=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{xn=!!window.navigator.geolocation}return xn})}().then(n=>this._finishSetupUI(n)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),L.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Do=0,Vs=!1}_isOutOfMapMaxBounds(_){const n=this._map.getMaxBounds(),l=_.coords;return n&&(l.longitude<n.getWest()||l.longitude>n.getEast()||l.latitude<n.getSouth()||l.latitude>n.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const _=this._map.getBounds(),n=_.getSouthEast(),l=_.getNorthEast(),p=n.distanceTo(l),g=Math.ceil(this._accuracy/(p/this._map._container.clientHeight)*2);this._circleElement.style.width=`${g}px`,this._circleElement.style.height=`${g}px`}trigger(){if(!this._setup)return a.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new a.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Do--,Vs=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new a.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new a.l("trackuserlocationstart")),this.fire(new a.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let _;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Do++,Do>1?(_={maximumAge:6e5,timeout:0},Vs=!0):(_=this.options.positionOptions,Vs=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,_)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},f.GlobeControl=class{constructor(){this._toggleProjection=()=>{var _;const n=(_=this._map.getProjection())===null||_===void 0?void 0:_.type;this._map.setProjection(n!=="mercator"&&n?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var _;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((_=this._map.getProjection())===null||_===void 0?void 0:_.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(_){return this._map=_,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=L.create("button","maplibregl-ctrl-globe",this._container),L.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){L.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},f.Hash=iu,f.ImageSource=Jr,f.KeyboardHandler=ou,f.LngLatBounds=Si,f.LogoControl=Mt,f.Map=class extends yn{constructor(_){var n,l;a.cj.mark(a.ck.create);const p=Object.assign(Object.assign(Object.assign({},Ni),_),{canvasContextAttributes:Object.assign(Object.assign({},Ni.canvasContextAttributes),_.canvasContextAttributes)});if(p.minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const g=new Pi,x=new Mr;if(p.minZoom!==void 0&&g.setMinZoom(p.minZoom),p.maxZoom!==void 0&&g.setMaxZoom(p.maxZoom),p.minPitch!==void 0&&g.setMinPitch(p.minPitch),p.maxPitch!==void 0&&g.setMaxPitch(p.maxPitch),p.renderWorldCopies!==void 0&&g.setRenderWorldCopies(p.renderWorldCopies),super(g,x,{bearingSnap:p.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Ml,this._controls=[],this._mapId=a.a4(),this._contextLost=P=>{P.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new a.l("webglcontextlost",{originalEvent:P}))},this._contextRestored=P=>{this._setupPainter(),this.resize(),this._update(),this.fire(new a.l("webglcontextrestored",{originalEvent:P}))},this._onMapScroll=P=>{if(P.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=p.interactive,this._maxTileCacheSize=p.maxTileCacheSize,this._maxTileCacheZoomLevels=p.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},p.canvasContextAttributes),this._trackResize=p.trackResize===!0,this._bearingSnap=p.bearingSnap,this._centerClampedToGround=p.centerClampedToGround,this._refreshExpiredTiles=p.refreshExpiredTiles===!0,this._fadeDuration=p.fadeDuration,this._crossSourceCollisions=p.crossSourceCollisions===!0,this._collectResourceTiming=p.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Aa),p.locale),this._clickTolerance=p.clickTolerance,this._overridePixelRatio=p.pixelRatio,this._maxCanvasSize=p.maxCanvasSize,this.transformCameraUpdate=p.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=p.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=Ce.addThrottleControl(()=>this.isMoving()),this._requestManager=new tt(p.transformRequest),typeof p.container=="string"){if(this._container=document.getElementById(p.container),!this._container)throw new Error(`Container '${p.container}' not found.`)}else{if(!(p.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(p.maxBounds&&this.setMaxBounds(p.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let P=!1;const I=tu(R=>{this._trackResize&&!this._removed&&(this.resize(R),this.redraw())},50);this._resizeObserver=new ResizeObserver(R=>{P?I(R):P=!0}),this._resizeObserver.observe(this._container)}this.handlers=new ag(this,p),this._hash=p.hash&&new iu(typeof p.hash=="string"&&p.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:p.center,elevation:p.elevation,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch,roll:p.roll}),p.bounds&&(this.resize(),this.fitBounds(p.bounds,a.e({},p.fitBoundsOptions,{duration:0}))));const w=typeof p.style=="string"||((l=(n=p.style)===null||n===void 0?void 0:n.projection)===null||l===void 0?void 0:l.type)!=="globe";this.resize(null,w),this._localIdeographFontFamily=p.localIdeographFontFamily,this._validateStyle=p.validateStyle,p.style&&this.setStyle(p.style,{localIdeographFontFamily:p.localIdeographFontFamily}),p.attributionControl&&this.addControl(new St(typeof p.attributionControl=="boolean"?void 0:p.attributionControl)),p.maplibreLogo&&this.addControl(new Mt,p.logoPosition),this.on("style.load",()=>{if(w||this._resizeTransform(),this.transform.unmodified){const P=a.O(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(P)}}),this.on("data",P=>{this._update(P.dataType==="style"),this.fire(new a.l(`${P.dataType}data`,P))}),this.on("dataloading",P=>{this.fire(new a.l(`${P.dataType}dataloading`,P))}),this.on("dataabort",P=>{this.fire(new a.l("sourcedataabort",P))})}_getMapId(){return this._mapId}addControl(_,n){if(n===void 0&&(n=_.getDefaultPosition?_.getDefaultPosition():"top-right"),!_||!_.onAdd)return this.fire(new a.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const l=_.onAdd(this);this._controls.push(_);const p=this._controlPositions[n];return n.indexOf("bottom")!==-1?p.insertBefore(l,p.firstChild):p.appendChild(l),this}removeControl(_){if(!_||!_.onRemove)return this.fire(new a.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const n=this._controls.indexOf(_);return n>-1&&this._controls.splice(n,1),_.onRemove(this),this}hasControl(_){return this._controls.indexOf(_)>-1}calculateCameraOptionsFromTo(_,n,l,p){return p==null&&this.terrain&&(p=this.terrain.getElevationForLngLatZoom(l,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(_,n,l,p)}resize(_,n=!0){const[l,p]=this._containerDimensions(),g=this._getClampedPixelRatio(l,p);if(this._resizeCanvas(l,p,g),this.painter.resize(l,p,g),this.painter.overLimit()){const w=this.painter.context.gl;this._maxCanvasSize=[w.drawingBufferWidth,w.drawingBufferHeight];const P=this._getClampedPixelRatio(l,p);this._resizeCanvas(l,p,P),this.painter.resize(l,p,P)}this._resizeTransform(n);const x=!this._moving;return x&&(this.stop(),this.fire(new a.l("movestart",_)).fire(new a.l("move",_))),this.fire(new a.l("resize",_)),x&&this.fire(new a.l("moveend",_)),this}_resizeTransform(_=!0){var n;const[l,p]=this._containerDimensions();this.transform.resize(l,p,_),(n=this._requestedCameraState)===null||n===void 0||n.resize(l,p,_)}_getClampedPixelRatio(_,n){const{0:l,1:p}=this._maxCanvasSize,g=this.getPixelRatio(),x=_*g,w=n*g;return Math.min(x>l?l/x:1,w>p?p/w:1)*g}getPixelRatio(){var _;return(_=this._overridePixelRatio)!==null&&_!==void 0?_:devicePixelRatio}setPixelRatio(_){this._overridePixelRatio=_,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(_){return this.transform.setMaxBounds(Si.convert(_)),this._update()}setMinZoom(_){if((_=_??-2)>=-2&&_<=this.transform.maxZoom)return this.transform.setMinZoom(_),this._update(),this.getZoom()<_&&this.setZoom(_),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(_){if((_=_??22)>=this.transform.minZoom)return this.transform.setMaxZoom(_),this._update(),this.getZoom()>_&&this.setZoom(_),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(_){if((_=_??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(_>=0&&_<=this.transform.maxPitch)return this.transform.setMinPitch(_),this._update(),this.getPitch()<_&&this.setPitch(_),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(_){if((_=_??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(_>=this.transform.minPitch)return this.transform.setMaxPitch(_),this._update(),this.getPitch()>_&&this.setPitch(_),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(_){return this.transform.setRenderWorldCopies(_),this._update()}project(_){return this.transform.locationToScreenPoint(a.Q.convert(_),this.style&&this.terrain)}unproject(_){return this.transform.screenPointToLocation(a.P.convert(_),this.terrain)}isMoving(){var _;return this._moving||((_=this.handlers)===null||_===void 0?void 0:_.isMoving())}isZooming(){var _;return this._zooming||((_=this.handlers)===null||_===void 0?void 0:_.isZooming())}isRotating(){var _;return this._rotating||((_=this.handlers)===null||_===void 0?void 0:_.isRotating())}_createDelegatedListener(_,n,l){if(_==="mouseenter"||_==="mouseover"){let p=!1;return{layers:n,listener:l,delegates:{mousemove:x=>{const w=n.filter(I=>this.getLayer(I)),P=w.length!==0?this.queryRenderedFeatures(x.point,{layers:w}):[];P.length?p||(p=!0,l.call(this,new _r(_,this,x.originalEvent,{features:P}))):p=!1},mouseout:()=>{p=!1}}}}if(_==="mouseleave"||_==="mouseout"){let p=!1;return{layers:n,listener:l,delegates:{mousemove:w=>{const P=n.filter(I=>this.getLayer(I));(P.length!==0?this.queryRenderedFeatures(w.point,{layers:P}):[]).length?p=!0:p&&(p=!1,l.call(this,new _r(_,this,w.originalEvent)))},mouseout:w=>{p&&(p=!1,l.call(this,new _r(_,this,w.originalEvent)))}}}}{const p=g=>{const x=n.filter(P=>this.getLayer(P)),w=x.length!==0?this.queryRenderedFeatures(g.point,{layers:x}):[];w.length&&(g.features=w,l.call(this,g),delete g.features)};return{layers:n,listener:l,delegates:{[_]:p}}}}_saveDelegatedListener(_,n){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[_]=this._delegatedListeners[_]||[],this._delegatedListeners[_].push(n)}_removeDelegatedListener(_,n,l){if(!this._delegatedListeners||!this._delegatedListeners[_])return;const p=this._delegatedListeners[_];for(let g=0;g<p.length;g++){const x=p[g];if(x.listener===l&&x.layers.length===n.length&&x.layers.every(w=>n.includes(w))){for(const w in x.delegates)this.off(w,x.delegates[w]);return void p.splice(g,1)}}}on(_,n,l){if(l===void 0)return super.on(_,n);const p=typeof n=="string"?[n]:n,g=this._createDelegatedListener(_,p,l);this._saveDelegatedListener(_,g);for(const x in g.delegates)this.on(x,g.delegates[x]);return{unsubscribe:()=>{this._removeDelegatedListener(_,p,l)}}}once(_,n,l){if(l===void 0)return super.once(_,n);const p=typeof n=="string"?[n]:n,g=this._createDelegatedListener(_,p,l);for(const x in g.delegates){const w=g.delegates[x];g.delegates[x]=(...P)=>{this._removeDelegatedListener(_,p,l),w(...P)}}this._saveDelegatedListener(_,g);for(const x in g.delegates)this.once(x,g.delegates[x]);return this}off(_,n,l){return l===void 0?super.off(_,n):(this._removeDelegatedListener(_,typeof n=="string"?[n]:n,l),this)}queryRenderedFeatures(_,n){if(!this.style)return[];let l;const p=_ instanceof a.P||Array.isArray(_),g=p?_:[[0,0],[this.transform.width,this.transform.height]];if(n=n||(p?{}:_)||{},g instanceof a.P||typeof g[0]=="number")l=[a.P.convert(g)];else{const x=a.P.convert(g[0]),w=a.P.convert(g[1]);l=[x,new a.P(w.x,x.y),w,new a.P(x.x,w.y),x]}return this.style.queryRenderedFeatures(l,n,this.transform)}querySourceFeatures(_,n){return this.style.querySourceFeatures(_,n)}setStyle(_,n){return(n=a.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},n)).diff!==!1&&n.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&_?(this._diffStyle(_,n),this):(this._localIdeographFontFamily=n.localIdeographFontFamily,this._updateStyle(_,n))}setTransformRequest(_){return this._requestManager.setTransformRequest(_),this}_getUIString(_){const n=this._locale[_];if(n==null)throw new Error(`Missing UI string '${_}'`);return n}_updateStyle(_,n){var l,p;if(n.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(_,n));const g=this.style&&n.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!_)),_?(this.style=new _o(this,n||{}),this.style.setEventedParent(this,{style:this.style}),typeof _=="string"?this.style.loadURL(_,n,g):this.style.loadJSON(_,n,g),this):((p=(l=this.style)===null||l===void 0?void 0:l.projection)===null||p===void 0||p.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new _o(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(_,n){if(typeof _=="string"){const l=this._requestManager.transformRequest(_,"Style");a.j(l,new AbortController).then(p=>{this._updateDiff(p.data,n)}).catch(p=>{p&&this.fire(new a.k(p))})}else typeof _=="object"&&this._updateDiff(_,n)}_updateDiff(_,n){try{this.style.setState(_,n)&&this._update(!0)}catch(l){a.w(`Unable to perform style diff: ${l.message||l.error||l}.  Rebuilding the style from scratch.`),this._updateStyle(_,n)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():a.w("There is no style added to the map.")}addSource(_,n){return this._lazyInitEmptyStyle(),this.style.addSource(_,n),this._update(!0)}isSourceLoaded(_){const n=this.style&&this.style.sourceCaches[_];if(n!==void 0)return n.loaded();this.fire(new a.k(new Error(`There is no source with ID '${_}'`)))}setTerrain(_){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),_){const n=this.style.sourceCaches[_.source];if(!n)throw new Error(`cannot load terrain, because there exists no source with ID: ${_.source}`);this.terrain===null&&n.reload();for(const l in this.style._layers){const p=this.style._layers[l];p.type==="hillshade"&&p.source===_.source&&a.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new kr(this.painter,n,_),this.painter.renderToTexture=new lg(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=l=>{var p;l.dataType==="style"?this.terrain.sourceCache.freeRtt():l.dataType==="source"&&l.tile&&(l.sourceId!==_.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((p=l.source)===null||p===void 0?void 0:p.type)==="image"?this.terrain.sourceCache.freeRtt():this.terrain.sourceCache.freeRtt(l.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new a.l("terrain",{terrain:_})),this}getTerrain(){var _,n;return(n=(_=this.terrain)===null||_===void 0?void 0:_.options)!==null&&n!==void 0?n:null}areTilesLoaded(){const _=this.style&&this.style.sourceCaches;for(const n in _){const l=_[n]._tiles;for(const p in l){const g=l[p];if(g.state!=="loaded"&&g.state!=="errored")return!1}}return!0}removeSource(_){return this.style.removeSource(_),this._update(!0)}getSource(_){return this.style.getSource(_)}addImage(_,n,l={}){const{pixelRatio:p=1,sdf:g=!1,stretchX:x,stretchY:w,content:P,textFitWidth:I,textFitHeight:R}=l;if(this._lazyInitEmptyStyle(),!(n instanceof HTMLImageElement||a.b(n))){if(n.width===void 0||n.height===void 0)return this.fire(new a.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:O,height:N,data:B}=n,W=n;return this.style.addImage(_,{data:new a.R({width:O,height:N},new Uint8Array(B)),pixelRatio:p,stretchX:x,stretchY:w,content:P,textFitWidth:I,textFitHeight:R,sdf:g,version:0,userImage:W}),W.onAdd&&W.onAdd(this,_),this}}{const{width:O,height:N,data:B}=F.getImageData(n);this.style.addImage(_,{data:new a.R({width:O,height:N},B),pixelRatio:p,stretchX:x,stretchY:w,content:P,textFitWidth:I,textFitHeight:R,sdf:g,version:0})}}updateImage(_,n){const l=this.style.getImage(_);if(!l)return this.fire(new a.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const p=n instanceof HTMLImageElement||a.b(n)?F.getImageData(n):n,{width:g,height:x,data:w}=p;if(g===void 0||x===void 0)return this.fire(new a.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(g!==l.data.width||x!==l.data.height)return this.fire(new a.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const P=!(n instanceof HTMLImageElement||a.b(n));return l.data.replace(w,P),this.style.updateImage(_,l),this}getImage(_){return this.style.getImage(_)}hasImage(_){return _?!!this.style.getImage(_):(this.fire(new a.k(new Error("Missing required image id"))),!1)}removeImage(_){this.style.removeImage(_)}loadImage(_){return Ce.getImage(this._requestManager.transformRequest(_,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(_,n){return this._lazyInitEmptyStyle(),this.style.addLayer(_,n),this._update(!0)}moveLayer(_,n){return this.style.moveLayer(_,n),this._update(!0)}removeLayer(_){return this.style.removeLayer(_),this._update(!0)}getLayer(_){return this.style.getLayer(_)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(_,n,l){return this.style.setLayerZoomRange(_,n,l),this._update(!0)}setFilter(_,n,l={}){return this.style.setFilter(_,n,l),this._update(!0)}getFilter(_){return this.style.getFilter(_)}setPaintProperty(_,n,l,p={}){return this.style.setPaintProperty(_,n,l,p),this._update(!0)}getPaintProperty(_,n){return this.style.getPaintProperty(_,n)}setLayoutProperty(_,n,l,p={}){return this.style.setLayoutProperty(_,n,l,p),this._update(!0)}getLayoutProperty(_,n){return this.style.getLayoutProperty(_,n)}setGlyphs(_,n={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(_,n),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(_,n,l={}){return this._lazyInitEmptyStyle(),this.style.addSprite(_,n,l,p=>{p||this._update(!0)}),this}removeSprite(_){return this._lazyInitEmptyStyle(),this.style.removeSprite(_),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(_,n={}){return this._lazyInitEmptyStyle(),this.style.setSprite(_,n,l=>{l||this._update(!0)}),this}setLight(_,n={}){return this._lazyInitEmptyStyle(),this.style.setLight(_,n),this._update(!0)}getLight(){return this.style.getLight()}setSky(_,n={}){return this._lazyInitEmptyStyle(),this.style.setSky(_,n),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(_,n){return this.style.setFeatureState(_,n),this._update()}removeFeatureState(_,n){return this.style.removeFeatureState(_,n),this._update()}getFeatureState(_){return this.style.getFeatureState(_)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let _=0,n=0;return this._container&&(_=this._container.clientWidth||400,n=this._container.clientHeight||300),[_,n]}_setupContainer(){const _=this._container;_.classList.add("maplibregl-map");const n=this._canvasContainer=L.create("div","maplibregl-canvas-container",_);this._interactive&&n.classList.add("maplibregl-interactive"),this._canvas=L.create("canvas","maplibregl-canvas",n),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const l=this._containerDimensions(),p=this._getClampedPixelRatio(l[0],l[1]);this._resizeCanvas(l[0],l[1],p);const g=this._controlContainer=L.create("div","maplibregl-control-container",_),x=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(w=>{x[w]=L.create("div",`maplibregl-ctrl-${w} `,g)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(_,n,l){this._canvas.width=Math.floor(l*_),this._canvas.height=Math.floor(l*n),this._canvas.style.width=`${_}px`,this._canvas.style.height=`${n}px`}_setupPainter(){const _=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let n=null;this._canvas.addEventListener("webglcontextcreationerror",p=>{n={requestedAttributes:_},p&&(n.statusMessage=p.statusMessage,n.type=p.type)},{once:!0});let l=null;if(l=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,_):this._canvas.getContext("webgl2",_)||this._canvas.getContext("webgl",_),!l){const p="Failed to initialize WebGL";throw n?(n.message=p,new Error(JSON.stringify(n))):new Error(p)}this.painter=new uf(l,this.transform),Y.testSupport(l)}migrateProjection(_,n){super.migrateProjection(_,n),this.painter.transform=_,this.fire(new a.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(_){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||_,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(_){return this._update(),this._renderTaskQueue.add(_)}_cancelRenderFrame(_){this._renderTaskQueue.remove(_)}_render(_){var n,l,p,g,x;const w=this._idleTriggered?this._fadeDuration:0,P=((n=this.style.projection)===null||n===void 0?void 0:n.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(_),this._removed)return;let I=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const N=this.transform.zoom,B=F.now();this.style.zoomHistory.update(N,B);const W=new a.C(N,{now:B,fadeDuration:w,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),X=W.crossFadingFactor();X===1&&X===this._crossFadingFactor||(I=!0,this._crossFadingFactor=X),this.style.update(W)}const R=((l=this.style.projection)===null||l===void 0?void 0:l.transitionState)>0!==P;(p=this.style.projection)===null||p===void 0||p.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((g=this.style.projection)===null||g===void 0?void 0:g.transitionState,(x=this.style.projection)===null||x===void 0?void 0:x.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||R)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,w,this._crossSourceCollisions,R),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:w,showPadding:this.showPadding}),this.fire(new a.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,a.cj.mark(a.ck.load),this.fire(new a.l("load"))),this.style&&(this.style.hasTransitions()||I)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const O=this._sourcesDirty||this._styleDirty||this._placementDirty;return O||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new a.l("idle")),!this._loaded||this._fullyLoaded||O||(this._fullyLoaded=!0,a.cj.mark(a.ck.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var _;this._hash&&this._hash.remove();for(const l of this._controls)l.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),Ce.removeThrottleControl(this._imageQueueHandle),(_=this._resizeObserver)===null||_===void 0||_.disconnect();const n=this.painter.context.gl.getExtension("WEBGL_lose_context");n!=null&&n.loseContext&&n.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),L.remove(this._canvasContainer),L.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),a.cj.clearMetrics(),this._removed=!0,this.fire(new a.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,F.frame(this._frameRequest,_=>{a.cj.frame(_),this._frameRequest=null;try{this._render(_)}catch(n){if(!a.cl(n)&&!function(l){return l.message===sf}(n))throw n}},()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(_){this._showTileBoundaries!==_&&(this._showTileBoundaries=_,this._update())}get showPadding(){return!!this._showPadding}set showPadding(_){this._showPadding!==_&&(this._showPadding=_,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(_){this._showCollisionBoxes!==_&&(this._showCollisionBoxes=_,_?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(_){this._showOverdrawInspector!==_&&(this._showOverdrawInspector=_,this._update())}get repaint(){return!!this._repaint}set repaint(_){this._repaint!==_&&(this._repaint=_,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(_){this._vertices=_,this._update()}get version(){return Ri}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(_){return this._lazyInitEmptyStyle(),this.style.setProjection(_),this._update(!0)}},f.MapMouseEvent=_r,f.MapTouchEvent=Mo,f.MapWheelEvent=Gr,f.Marker=Us,f.NavigationControl=class{constructor(_){this._updateZoomButtons=()=>{const n=this._map.getZoom(),l=n===this._map.getMaxZoom(),p=n===this._map.getMinZoom();this._zoomInButton.disabled=l,this._zoomOutButton.disabled=p,this._zoomInButton.setAttribute("aria-disabled",l.toString()),this._zoomOutButton.setAttribute("aria-disabled",p.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(n,l)=>{const p=this._map._getUIString(`NavigationControl.${l}`);n.title=p,n.setAttribute("aria-label",p)},this.options=a.e({},Sf,_),this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",n=>n.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",n=>this._map.zoomIn({},{originalEvent:n})),L.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",n=>this._map.zoomOut({},{originalEvent:n})),L.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",n=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:n}):this._map.resetNorth({},{originalEvent:n})}),this._compassIcon=L.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(_){return this._map=_,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Pa(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){L.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(_,n){const l=L.create("button",_,this._container);return l.type="button",l.addEventListener("click",n),l}},f.Popup=class extends a.E{constructor(_){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:void 0)},this.remove=()=>(this._content&&L.remove(this._content),this._container&&(L.remove(this._container),delete this._container),this._closeButton&&this._closeButton.removeEventListener("click",this._onClose),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new a.l("close"))),this),this._onMouseUp=n=>{this._update(n.point)},this._onMouseMove=n=>{this._update(n.point)},this._onDrag=n=>{this._update(n.point)},this._update=n=>{var l;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=L.create("div","maplibregl-popup",this._map.getContainer()),this._tip=L.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const P of this.options.className.split(" "))this._container.classList.add(P);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Rl(this._lngLat,this._flatPos,this._map.transform):(l=this._lngLat)===null||l===void 0?void 0:l.wrap(),this._trackPointer&&!n)return;const p=this._flatPos=this._pos=this._trackPointer&&n?n:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&n?n:this._map.transform.locationToScreenPoint(this._lngLat));let g=this.options.anchor;const x=Ia(this.options.offset);if(!g){const P=this._container.offsetWidth,I=this._container.offsetHeight;let R;R=p.y+x.bottom.y<I?["top"]:p.y>this._map.transform.height-I?["bottom"]:[],p.x<P/2?R.push("left"):p.x>this._map.transform.width-P/2&&R.push("right"),g=R.length===0?"bottom":R.join("-")}let w=p.add(x[g]);this.options.subpixelPositioning||(w=w.round()),L.setTransform(this._container,`${Ea[g]} translate(${w.x}px,${w.y}px)`),kl(this._container,g,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=a.e(Object.create(pu),_)}addTo(_){return this._map&&this.remove(),this._map=_,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new a.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(_){return this._lngLat=a.Q.convert(_),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(_){return this.setDOMContent(document.createTextNode(_))}setHTML(_){const n=document.createDocumentFragment(),l=document.createElement("body");let p;for(l.innerHTML=_;p=l.firstChild,p;)n.appendChild(p);return this.setDOMContent(n)}getMaxWidth(){var _;return(_=this._container)===null||_===void 0?void 0:_.style.maxWidth}setMaxWidth(_){return this.options.maxWidth=_,this._update(),this}setDOMContent(_){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=L.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(_),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(_){return this._container&&this._container.classList.add(_),this}removeClassName(_){return this._container&&this._container.classList.remove(_),this}setOffset(_){return this.options.offset=_,this._update(),this}toggleClassName(_){if(this._container)return this._container.classList.toggle(_)}setSubpixelPositioning(_){this.options.subpixelPositioning=_}_createCloseButton(){this.options.closeButton&&(this._closeButton=L.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const _=this._container.querySelector(gu);_&&_.focus()}},f.RasterDEMTileSource=Qn,f.RasterTileSource=Kr,f.ScaleControl=class{constructor(_){this._onMove=()=>{Dl(this._map,this._container,this.options)},this.setUnit=n=>{this.options.unit=n,Dl(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},du),_)}getDefaultPosition(){return"bottom-left"}onAdd(_){return this._map=_,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-scale",_.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){L.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},f.ScrollZoomHandler=bf,f.Style=_o,f.TerrainControl=class{constructor(_){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=_}onAdd(_){return this._map=_,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=L.create("button","maplibregl-ctrl-terrain",this._container),L.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){L.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},f.TwoFingersTouchPitchHandler=vf,f.TwoFingersTouchRotateHandler=xf,f.TwoFingersTouchZoomHandler=Ht,f.TwoFingersTouchZoomRotateHandler=wa,f.VectorTileSource=Gt,f.VideoSource=Qr,f.addSourceType=(_,n)=>a._(void 0,void 0,void 0,function*(){if(ta(_))throw new Error(`A source type called "${_}" already exists.`);((l,p)=>{io[l]=p})(_,n)}),f.clearPrewarmedResources=function(){const _=Ct;_&&(_.isPreloaded()&&_.numActive()===1?(_.release(st),Ct=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},f.createTileMesh=rl,f.getMaxParallelImageRequests=function(){return a.a.MAX_PARALLEL_IMAGE_REQUESTS},f.getRTLTextPluginStatus=function(){return Cn().getRTLTextPluginStatus()},f.getVersion=function(){return mu},f.getWorkerCount=function(){return rt.workerCount},f.getWorkerUrl=function(){return a.a.WORKER_URL},f.importScriptInWorkers=function(_){return Xt().broadcast("IS",_)},f.prewarm=function(){ai().acquire(st)},f.setMaxParallelImageRequests=function(_){a.a.MAX_PARALLEL_IMAGE_REQUESTS=_},f.setRTLTextPlugin=function(_,n){return Cn().setRTLTextPlugin(_,n)},f.setWorkerCount=function(_){rt.workerCount=_},f.setWorkerUrl=function(_){a.a.WORKER_URL=_}});var c=t;return c})}(Ed)),Ed.exports}F6();const Um=[[255,255,204],[199,233,180],[127,205,187],[65,182,196],[29,145,192],[34,94,168],[12,44,132]],aw=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[252,78,42],[227,26,28],[177,0,38]],L6=new py({container:"deck-container",mapStyle:"https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json",initialViewState:{longitude:-100,latitude:40.7,zoom:3,maxZoom:15,pitch:30,bearing:30},controller:!0,layers:[]});function B6(i,e){const{flows:t,centroid:r}=e.properties,o=Object.keys(t).map(f=>{const a=i.features[f];return{source:r,target:a.properties.centroid,value:t[f]}}),c=yT().domain(o.map(f=>Math.abs(f.value))).range(Um.map((f,a)=>a));return o.forEach(f=>{f.gain=Math.sign(f.value),f.quantile=c(Math.abs(f.value))}),new _y({id:"arc",data:o,getSourcePosition:f=>f.source,getTargetPosition:f=>f.target,getSourceColor:f=>(f.gain>0?Um:aw)[f.quantile],getTargetColor:f=>(f.gain>0?aw:Um)[f.quantile],strokeWidth:4})}function vT(i,e){e=e||i.features.find(o=>o.properties.name==="Los Angeles, CA");const t=B6(i,e),r=new Sy({id:"geojson",data:i,stroked:!1,filled:!0,autoHighlight:!0,pickable:!0,getFillColor:()=>[0,0,0,0],onClick:o=>vT(i,o.object)});L6.setProps({layers:[r,t]})}fetch("https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/arc/counties.json").then(i=>i.json()).then(i=>vT(i));
//# sourceMappingURL=index-D-QJHPqd.js.map
