{"version":3,"file":"deck.gl-leaflet.umd.min.js","sources":["../src/deck-utils.ts","../src/leaflet-layer.ts"],"sourcesContent":["import * as L from 'leaflet';\nimport { Deck } from '@deck.gl/core';\nimport type { DeckProps, ViewStateMap, MapView } from '@deck.gl/core';\n\nfunction getViewState(map: L.Map): ViewStateMap<MapView> {\n  return {\n    longitude: map.getCenter().lng,\n    latitude: map.getCenter().lat,\n    zoom: map.getZoom() - 1,\n    pitch: 0,\n    bearing: 0\n  };\n}\n\nexport function createDeckInstance(map: L.Map, container: HTMLDivElement, deck: Deck | undefined, props: DeckProps): Deck {\n  if (!deck) {\n    const viewState = getViewState(map);\n    deck = new Deck({\n      ...props,\n      parent: container,\n      controller: false,\n      style: { zIndex: 'auto' },\n      viewState,\n    });\n  }\n  return deck;\n}\n\nexport function updateDeckView(deck: Deck, map: L.Map): void {\n  const viewState = getViewState(map);\n  // console.log(viewState);\n\n  deck.setProps({ viewState });\n  deck.redraw();\n}\n","import * as L from 'leaflet';\nimport type { Deck, DeckProps } from '@deck.gl/core';\nimport { createDeckInstance, updateDeckView } from './deck-utils.js';\n\nexport class LeafletLayer extends L.Layer {  \n  props: DeckProps;\n  _container: HTMLDivElement | undefined = undefined;\n  _deck: Deck | undefined = undefined;\n  _animate: boolean | undefined = undefined;\n\n  constructor(props: DeckProps) {\n    super();\n\n    this.props = props;\n  }\n\n  onAdd(): this {\n    let pane = this.getPane();\n    if (!pane) {\n      return this;\n    }\n\n    this._container = L.DomUtil.create('div');\n    this._container.className = 'leaflet-layer';\n    if (this.#getZoomAnimated()) {\n      L.DomUtil.addClass(this._container, 'leaflet-zoom-animated');\n    }\n\n    pane.appendChild(this._container);\n    this._deck = createDeckInstance(this._map, this._container, this._deck, this.props);\n    this.#update();\n\n    return this;\n  }\n\n  onRemove(_map: L.Map): this {\n    if (!this._container || !this._deck) {\n      return this;\n    }\n\n    L.DomUtil.remove(this._container);\n    this._container = undefined;\n\n    this._deck.finalize();\n    this._deck = undefined;\n\n    return this;\n  }\n\n  getEvents(): { [name: string]: L.LeafletEventHandlerFn } {\n    return {\n      viewreset: this.#reset,\n      movestart: this.#onMoveStart,\n      moveend: this.#onMoveEnd,\n      zoomstart: this.#onZoomStart,\n      zoom: this.#onZoom,\n      zoomend: this.#onZoomEnd,\n      ...(this.#getZoomAnimated() ? { zoomanim: this.#onAnimZoom as L.LeafletEventHandlerFn } : {}),\n    };\n  }\n\n  setProps(props: DeckProps): void {\n    Object.assign(this.props, props);\n\n    if (this._deck) {\n      this._deck.setProps(props);\n    }\n  }\n\n  pickObject(opts: Parameters<Deck['pickObject']>[0]): ReturnType<Deck['pickObject']> {\n    if (!this._deck) {\n      return null;\n    }\n\n    return this._deck.pickObject(opts);\n  }\n\n  pickMultipleObjects(opts: Parameters<Deck['pickMultipleObjects']>[0]): ReturnType<Deck['pickMultipleObjects']> {\n    if (!this._deck) {\n      return [];\n    }\n\n    return this._deck.pickMultipleObjects(opts);\n  }\n\n  pickObjects(opts: Parameters<Deck['pickObjects']>[0]): ReturnType<Deck['pickObjects']> {\n    if (!this._deck) {\n      return [];\n    }\n\n    return this._deck.pickObjects(opts);\n  }\n\n  #getMap(): L.Map & { _animatingZoom: boolean, _getMapPanePos: () => L.Point } {\n    return (this as any)._map;\n  }\n\n  #getZoomAnimated(): boolean {\n    return (this as any)._zoomAnimated;\n  }\n\n  #update(): void {\n    if (!this._container || !this._deck) {\n      return;\n    }\n    if (this.#getMap()._animatingZoom) {\n      return;\n    }\n\n    const size = this.#getMap().getSize();\n    this._container.style.width = `${size.x}px`;\n    this._container.style.height = `${size.y}px`;\n\n    // invert map position\n    const offset = this.#getMap()._getMapPanePos().multiplyBy(-1);\n    L.DomUtil.setPosition(this._container, offset);\n\n    updateDeckView(this._deck, this._map);\n  }\n\n  #pauseAnimation(): void {\n    if (!this._deck) {\n      return;\n    }\n\n    if (this._deck.props._animate) {\n      this._animate = this._deck.props._animate;\n      this._deck.setProps({ _animate: false });\n    }\n  }\n\n  #unpauseAnimation(): void {\n    if (!this._deck) {\n      return;\n    }\n\n    if (this._animate) {\n      this._deck.setProps({ _animate: this._animate });\n      this._animate = undefined;\n    }\n  }\n\n  #reset(): void {\n\t\tthis.#updateTransform(this.#getMap().getCenter(), this.#getMap().getZoom());\n\t\tthis.#update();\n  }\n\n  #onMoveStart(): void {\n    this.#pauseAnimation();\n  }\n\n  #onMoveEnd(): void {\n    this.#update();\n    this.#unpauseAnimation();\n  }\n\n  #onZoomStart(): void {\n    this.#pauseAnimation();\n  }\n\n  #onAnimZoom(event: L.ZoomAnimEvent): void {\n    this.#updateTransform(event.center, event.zoom);\n  }\n\n  #onZoom(): void {\n    this.#updateTransform(this.#getMap().getCenter(), this.#getMap().getZoom());\n  }\n\n  #onZoomEnd(): void {\n    this.#unpauseAnimation();\n  }\n\n  /**\n   * see https://stackoverflow.com/a/67107000/1823988\n   * see L.Renderer._updateTransform https://github.com/Leaflet/Leaflet/blob/master/src/layer/vector/Renderer.js#L90-L105\n   */\n  #updateTransform(center: L.LatLng, zoom: number): void {\n    if (!this._container) {\n      return;\n    }\n\n    const scale = this.#getMap().getZoomScale(zoom, this.#getMap().getZoom());\n    const position = L.DomUtil.getPosition(this._container);\n    const viewHalf = this.#getMap().getSize().multiplyBy(0.5);\n    const currentCenterPoint = this.#getMap().project(this.#getMap().getCenter(), zoom);\n    const destCenterPoint = this.#getMap().project(center, zoom);\n    const centerOffset = destCenterPoint.subtract(currentCenterPoint);\n    const topLeftOffset = viewHalf.multiplyBy(-scale).add(position).add(viewHalf).subtract(centerOffset);\n\n    if (L.Browser.any3d) {\n      L.DomUtil.setTransform(this._container, topLeftOffset, scale);\n    } else {\n      L.DomUtil.setPosition(this._container, topLeftOffset);\n    }\n  }\n}\n"],"names":["getViewState","map","longitude","getCenter","lng","latitude","lat","zoom","getZoom","pitch","bearing","LeafletLayer","L","Layer","constructor","props","super","this","_container","undefined","_deck","_animate","onAdd","pane","getPane","DomUtil","create","className","__classPrivateFieldGet","_LeafletLayer_instances","_LeafletLayer_getZoomAnimated","addClass","appendChild","container","deck","viewState","Deck","parent","controller","style","zIndex","createDeckInstance","_map","_LeafletLayer_update","call","onRemove","remove","finalize","getEvents","viewreset","_LeafletLayer_reset","movestart","_LeafletLayer_onMoveStart","moveend","_LeafletLayer_onMoveEnd","zoomstart","_LeafletLayer_onZoomStart","_LeafletLayer_onZoom","zoomend","_LeafletLayer_onZoomEnd","zoomanim","_LeafletLayer_onAnimZoom","setProps","Object","assign","pickObject","opts","pickMultipleObjects","pickObjects","_zoomAnimated","_LeafletLayer_getMap","_animatingZoom","size","getSize","width","x","height","y","offset","_getMapPanePos","multiplyBy","setPosition","redraw","updateDeckView","_LeafletLayer_pauseAnimation","_LeafletLayer_unpauseAnimation","_LeafletLayer_updateTransform","event","center","scale","getZoomScale","position","getPosition","viewHalf","currentCenterPoint","project","centerOffset","subtract","topLeftOffset","add","Browser","any3d","setTransform"],"mappings":"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"}