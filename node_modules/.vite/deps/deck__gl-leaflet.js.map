{
  "version": 3,
  "sources": ["../../deck.gl-leaflet/src/deck-utils.ts", "../../deck.gl-leaflet/src/leaflet-layer.ts"],
  "sourcesContent": ["import * as L from 'leaflet';\nimport { Deck } from '@deck.gl/core';\nimport type { DeckProps, ViewStateMap, MapView } from '@deck.gl/core';\n\nfunction getViewState(map: L.Map): ViewStateMap<MapView> {\n  return {\n    longitude: map.getCenter().lng,\n    latitude: map.getCenter().lat,\n    zoom: map.getZoom() - 1,\n    pitch: 0,\n    bearing: 0\n  };\n}\n\nexport function createDeckInstance(map: L.Map, container: HTMLDivElement, deck: Deck | undefined, props: DeckProps): Deck {\n  if (!deck) {\n    const viewState = getViewState(map);\n    deck = new Deck({\n      ...props,\n      parent: container,\n      controller: false,\n      style: { zIndex: 'auto' },\n      viewState,\n    });\n  }\n  return deck;\n}\n\nexport function updateDeckView(deck: Deck, map: L.Map): void {\n  const viewState = getViewState(map);\n  // console.log(viewState);\n\n  deck.setProps({ viewState });\n  deck.redraw();\n}\n", "import * as L from 'leaflet';\nimport type { Deck, DeckProps } from '@deck.gl/core';\nimport { createDeckInstance, updateDeckView } from './deck-utils.js';\n\nexport class LeafletLayer extends L.Layer {  \n  props: DeckProps;\n  _container: HTMLDivElement | undefined = undefined;\n  _deck: Deck | undefined = undefined;\n  _animate: boolean | undefined = undefined;\n\n  constructor(props: DeckProps) {\n    super();\n\n    this.props = props;\n  }\n\n  onAdd(): this {\n    let pane = this.getPane();\n    if (!pane) {\n      return this;\n    }\n\n    this._container = L.DomUtil.create('div');\n    this._container.className = 'leaflet-layer';\n    if (this.#getZoomAnimated()) {\n      L.DomUtil.addClass(this._container, 'leaflet-zoom-animated');\n    }\n\n    pane.appendChild(this._container);\n    this._deck = createDeckInstance(this._map, this._container, this._deck, this.props);\n    this.#update();\n\n    return this;\n  }\n\n  onRemove(_map: L.Map): this {\n    if (!this._container || !this._deck) {\n      return this;\n    }\n\n    L.DomUtil.remove(this._container);\n    this._container = undefined;\n\n    this._deck.finalize();\n    this._deck = undefined;\n\n    return this;\n  }\n\n  getEvents(): { [name: string]: L.LeafletEventHandlerFn } {\n    return {\n      viewreset: this.#reset,\n      movestart: this.#onMoveStart,\n      moveend: this.#onMoveEnd,\n      zoomstart: this.#onZoomStart,\n      zoom: this.#onZoom,\n      zoomend: this.#onZoomEnd,\n      ...(this.#getZoomAnimated() ? { zoomanim: this.#onAnimZoom as L.LeafletEventHandlerFn } : {}),\n    };\n  }\n\n  setProps(props: DeckProps): void {\n    Object.assign(this.props, props);\n\n    if (this._deck) {\n      this._deck.setProps(props);\n    }\n  }\n\n  pickObject(opts: Parameters<Deck['pickObject']>[0]): ReturnType<Deck['pickObject']> {\n    if (!this._deck) {\n      return null;\n    }\n\n    return this._deck.pickObject(opts);\n  }\n\n  pickMultipleObjects(opts: Parameters<Deck['pickMultipleObjects']>[0]): ReturnType<Deck['pickMultipleObjects']> {\n    if (!this._deck) {\n      return [];\n    }\n\n    return this._deck.pickMultipleObjects(opts);\n  }\n\n  pickObjects(opts: Parameters<Deck['pickObjects']>[0]): ReturnType<Deck['pickObjects']> {\n    if (!this._deck) {\n      return [];\n    }\n\n    return this._deck.pickObjects(opts);\n  }\n\n  #getMap(): L.Map & { _animatingZoom: boolean, _getMapPanePos: () => L.Point } {\n    return (this as any)._map;\n  }\n\n  #getZoomAnimated(): boolean {\n    return (this as any)._zoomAnimated;\n  }\n\n  #update(): void {\n    if (!this._container || !this._deck) {\n      return;\n    }\n    if (this.#getMap()._animatingZoom) {\n      return;\n    }\n\n    const size = this.#getMap().getSize();\n    this._container.style.width = `${size.x}px`;\n    this._container.style.height = `${size.y}px`;\n\n    // invert map position\n    const offset = this.#getMap()._getMapPanePos().multiplyBy(-1);\n    L.DomUtil.setPosition(this._container, offset);\n\n    updateDeckView(this._deck, this._map);\n  }\n\n  #pauseAnimation(): void {\n    if (!this._deck) {\n      return;\n    }\n\n    if (this._deck.props._animate) {\n      this._animate = this._deck.props._animate;\n      this._deck.setProps({ _animate: false });\n    }\n  }\n\n  #unpauseAnimation(): void {\n    if (!this._deck) {\n      return;\n    }\n\n    if (this._animate) {\n      this._deck.setProps({ _animate: this._animate });\n      this._animate = undefined;\n    }\n  }\n\n  #reset(): void {\n\t\tthis.#updateTransform(this.#getMap().getCenter(), this.#getMap().getZoom());\n\t\tthis.#update();\n  }\n\n  #onMoveStart(): void {\n    this.#pauseAnimation();\n  }\n\n  #onMoveEnd(): void {\n    this.#update();\n    this.#unpauseAnimation();\n  }\n\n  #onZoomStart(): void {\n    this.#pauseAnimation();\n  }\n\n  #onAnimZoom(event: L.ZoomAnimEvent): void {\n    this.#updateTransform(event.center, event.zoom);\n  }\n\n  #onZoom(): void {\n    this.#updateTransform(this.#getMap().getCenter(), this.#getMap().getZoom());\n  }\n\n  #onZoomEnd(): void {\n    this.#unpauseAnimation();\n  }\n\n  /**\n   * see https://stackoverflow.com/a/67107000/1823988\n   * see L.Renderer._updateTransform https://github.com/Leaflet/Leaflet/blob/master/src/layer/vector/Renderer.js#L90-L105\n   */\n  #updateTransform(center: L.LatLng, zoom: number): void {\n    if (!this._container) {\n      return;\n    }\n\n    const scale = this.#getMap().getZoomScale(zoom, this.#getMap().getZoom());\n    const position = L.DomUtil.getPosition(this._container);\n    const viewHalf = this.#getMap().getSize().multiplyBy(0.5);\n    const currentCenterPoint = this.#getMap().project(this.#getMap().getCenter(), zoom);\n    const destCenterPoint = this.#getMap().project(center, zoom);\n    const centerOffset = destCenterPoint.subtract(currentCenterPoint);\n    const topLeftOffset = viewHalf.multiplyBy(-scale).add(position).add(viewHalf).subtract(centerOffset);\n\n    if (L.Browser.any3d) {\n      L.DomUtil.setTransform(this._container, topLeftOffset, scale);\n    } else {\n      L.DomUtil.setPosition(this._container, topLeftOffset);\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": ["_LeafletLayer_getZoomAnimated", "_LeafletLayer_update", "_LeafletLayer_pauseAnimation", "_LeafletLayer_unpauseAnimation", "_LeafletLayer_reset", "_LeafletLayer_onMoveStart", "_LeafletLayer_onMoveEnd", "_LeafletLayer_onZoomStart", "_LeafletLayer_onAnimZoom", "_LeafletLayer_onZoom", "_LeafletLayer_onZoomEnd", "_LeafletLayer_updateTransform"]
}
